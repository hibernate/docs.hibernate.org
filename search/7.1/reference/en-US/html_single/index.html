<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.20">
<title>Hibernate Search 7.1.2.Final: Reference Documentation</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/*! Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment the following line when using as a custom stylesheet */
/* @import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"; */
html{font-family:sans-serif;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
b,strong{font-weight:bold}
abbr{font-size:.9em}
abbr[title]{cursor:help;border-bottom:1px dotted #dddddf;text-decoration:none}
dfn{font-style:italic}
hr{height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type=checkbox],input[type=radio]{padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,::before,::after{box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;line-height:1;position:relative;cursor:auto;-moz-tab-size:4;-o-tab-size:4;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ul.square{list-style-type:square}
ul.circle ul:not([class]),ul.disc ul:not([class]),ul.square ul:not([class]){list-style:inherit}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:1px solid #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;border-radius:3px;box-shadow:0 1px 0 rgba(0,0,0,.2),inset 0 0 0 .1em #fff;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin:0 auto;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:flex;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border:1px solid #e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:hsla(0,0%,100%,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details{margin-left:1.25rem}
details>summary{cursor:pointer;display:block;position:relative;line-height:1.6;margin-bottom:.625rem;outline:none;-webkit-tap-highlight-color:transparent}
details>summary::-webkit-details-marker{display:none}
details>summary::before{content:"";border:solid transparent;border-left:solid;border-width:.3em 0 .3em .5em;position:absolute;top:.5em;left:-1.25rem;transform:translateX(15%)}
details[open]>summary::before{border:solid transparent;border-top:solid;border-width:.5em .3em 0;transform:translateY(15%)}
details>summary::after{content:"";width:1.25rem;height:1em;position:absolute;top:.3em;left:-1.25rem}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class=paragraph]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border:1px solid #e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;border-radius:4px}
.sidebarblock{border:1px solid #dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;border-radius:4px}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:first-child,.sidebarblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child,.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class=highlight],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos,pre.pygments .linenos{border-right:1px solid;opacity:.35;padding-right:.5em;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
pre.pygments span.linenos{display:inline-block;margin-right:.75em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans-serif;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;font-size:.85rem;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all>*>tr,table.stripes-odd>*>tr:nth-of-type(odd),table.stripes-even>*>tr:nth-of-type(even),table.stripes-hover>*>tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
li>p:empty:only-child::before{content:"";display:inline-block}
ul.checklist>li>p:first-child{margin-left:-1em}
ul.checklist>li>p:first-child>.fa-square-o:first-child,ul.checklist>li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist>li>p:first-child>input[type=checkbox]:first-child{margin-right:.25em}
ul.inline{display:flex;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:4px solid #fff;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt,summary{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,td.hdlist1,span.alt,summary{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]{border-bottom:1px dotted}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media amzn-kf8,print{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<link rel="stylesheet" href="css/font-awesome/css/font-awesome.min.css">
<style>
/*! Stylesheet for CodeRay to loosely match GitHub themes | MIT License */
pre.CodeRay{background:#f7f7f8}
.CodeRay .line-numbers{border-right:1px solid;opacity:.35;padding:0 .5em 0 0;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
.CodeRay span.line-numbers{display:inline-block;margin-right:.75em}
.CodeRay .line-numbers strong{color:#000}
table.CodeRay{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.CodeRay td{vertical-align:top;line-height:inherit}
table.CodeRay td.line-numbers{text-align:right}
table.CodeRay td.code{padding:0 0 0 .75em}
.CodeRay .debug{color:#fff!important;background:navy!important}
.CodeRay .annotation{color:#007}
.CodeRay .attribute-name{color:navy}
.CodeRay .attribute-value{color:#700}
.CodeRay .binary{color:#509}
.CodeRay .comment{color:#998;font-style:italic}
.CodeRay .char{color:#04d}
.CodeRay .char .content{color:#04d}
.CodeRay .char .delimiter{color:#039}
.CodeRay .class{color:#458;font-weight:bold}
.CodeRay .complex{color:#a08}
.CodeRay .constant,.CodeRay .predefined-constant{color:teal}
.CodeRay .color{color:#099}
.CodeRay .class-variable{color:#369}
.CodeRay .decorator{color:#b0b}
.CodeRay .definition{color:#099}
.CodeRay .delimiter{color:#000}
.CodeRay .doc{color:#970}
.CodeRay .doctype{color:#34b}
.CodeRay .doc-string{color:#d42}
.CodeRay .escape{color:#666}
.CodeRay .entity{color:#800}
.CodeRay .error{color:#808}
.CodeRay .exception{color:inherit}
.CodeRay .filename{color:#099}
.CodeRay .function{color:#900;font-weight:bold}
.CodeRay .global-variable{color:teal}
.CodeRay .hex{color:#058}
.CodeRay .integer,.CodeRay .float{color:#099}
.CodeRay .include{color:#555}
.CodeRay .inline{color:#000}
.CodeRay .inline .inline{background:#ccc}
.CodeRay .inline .inline .inline{background:#bbb}
.CodeRay .inline .inline-delimiter{color:#d14}
.CodeRay .inline-delimiter{color:#d14}
.CodeRay .important{color:#555;font-weight:bold}
.CodeRay .interpreted{color:#b2b}
.CodeRay .instance-variable{color:teal}
.CodeRay .label{color:#970}
.CodeRay .local-variable{color:#963}
.CodeRay .octal{color:#40e}
.CodeRay .predefined{color:#369}
.CodeRay .preprocessor{color:#579}
.CodeRay .pseudo-class{color:#555}
.CodeRay .directive{font-weight:bold}
.CodeRay .type{font-weight:bold}
.CodeRay .predefined-type{color:inherit}
.CodeRay .reserved,.CodeRay .keyword{color:#000;font-weight:bold}
.CodeRay .key{color:#808}
.CodeRay .key .delimiter{color:#606}
.CodeRay .key .char{color:#80f}
.CodeRay .value{color:#088}
.CodeRay .regexp .delimiter{color:#808}
.CodeRay .regexp .content{color:#808}
.CodeRay .regexp .modifier{color:#808}
.CodeRay .regexp .char{color:#d14}
.CodeRay .regexp .function{color:#404;font-weight:bold}
.CodeRay .string{color:#d20}
.CodeRay .string .string .string{background:#ffd0d0}
.CodeRay .string .content{color:#d14}
.CodeRay .string .char{color:#d14}
.CodeRay .string .delimiter{color:#d14}
.CodeRay .shell{color:#d14}
.CodeRay .shell .delimiter{color:#d14}
.CodeRay .symbol{color:#990073}
.CodeRay .symbol .content{color:#a60}
.CodeRay .symbol .delimiter{color:#630}
.CodeRay .tag{color:teal}
.CodeRay .tag-special{color:#d70}
.CodeRay .variable{color:#036}
.CodeRay .insert{background:#afa}
.CodeRay .delete{background:#faa}
.CodeRay .change{color:#aaf;background:#007}
.CodeRay .head{color:#f8f;background:#505}
.CodeRay .insert .insert{color:#080}
.CodeRay .delete .delete{color:#800}
.CodeRay .change .change{color:#66f}
.CodeRay .head .head{color:#f4f}
</style>
<!-- HibernateDoc.Meta -->
<meta name="description" content="Hibernate Search, full text search for your entities - Reference Documentation" />
<meta name="keywords" content="hibernate, search, hibernate search, full text, lucene, elasticsearch, opensearch" />
<link rel="canonical" href="https://docs.jboss.org/hibernate/stable/search/reference/en-US/html_single/" />
<!-- /HibernateDoc.Meta -->

<link rel="stylesheet" href="css/hibernate.css" type="text/css" />

<!-- Dynamic TOC -->
<!-- Source: https://github.com/asciidoctor/asciidoctor/issues/699#issuecomment-321066006 -->
<style>
  /* Tocbot dynamic TOC, works with tocbot 3.0.2 */
  #tocbot a.toc-link.node-name--H1{ font-style: italic }
  @media screen{
    #tocbot > ul.toc-list{ margin-bottom: 0.5em; margin-left: 0.125em }
    #tocbot ul.sectlevel0, #tocbot a.toc-link.node-name--H1 + ul{
      padding-left: 0 }
    #tocbot a.toc-link{ height:100% }
    .is-collapsible{ max-height:3000px; overflow:hidden; }
    .is-collapsed{ max-height:0 }
    .is-active-link{ font-weight:700 }
  }
  @media print{
    #tocbot a.toc-link.node-name--H4{ display:none }
    #tocbot a.toc-link.node-name--H5{ display:none }
    #tocbot a.toc-link.node-name--H6{ display:none }
  }
</style>
<!-- /Dynamic TOC -->
</head>
<body class="book toc2 toc-left">
<div id="header">
<h1>Hibernate Search 7.1.2.Final: Reference Documentation</h1>
<div class="details">
<span id="revdate">2024-08-30</span>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#preface">Preface</a></li>
<li><a href="#compatibility">1.  Compatibility</a>
<ul class="sectlevel2">
<li><a href="#compatibility-dependencies">1.1. Dependencies</a></li>
<li><a href="#compatibility-framework">1.2.  Framework support</a>
<ul class="sectlevel3">
<li><a href="#compatibility-framework-quarkus">1.2.1.   Quarkus</a></li>
<li><a href="#compatibility-framework-wildfly">1.2.2. WildFly</a></li>
<li><a href="#compatibility-framework-spring-boot">1.2.3.   Spring Boot</a>
<ul class="sectlevel4">
<li><a href="#compatibility-framework-spring-boot-configuration-properties">  Configuration properties</a></li>
<li><a href="#compatibility-framework-spring-boot-dependency-versions">  Dependency versions</a></li>
<li><a href="#compatibility-framework-spring-boot-application-hanging">  Application hanging on startup</a></li>
<li><a href="#compatibility-framework-spring-boot-elasticsearch-auto-configuration">Spring Boot&#8217;s Elasticsearch client and auto-configuration</a></li>
</ul>
</li>
<li><a href="#compatibility-framework-other">1.2.4.  Other</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#reference-getting-started">2.                                        Getting started with Hibernate Search</a></li>
<li><a href="#migrating">3.  Migrating</a></li>
<li><a href="#concepts">4.  Concepts</a>
<ul class="sectlevel2">
<li><a href="#concepts-full-text">4.1. Full-text search</a></li>
<li><a href="#concepts-entity">4.2. Entity types</a></li>
<li><a href="#concepts-mapping">4.3. Mapping</a></li>
<li><a href="#concepts-binding">4.4. Binding</a></li>
<li><a href="#concepts-analysis">4.5.  Analysis</a></li>
<li><a href="#concepts-commit-refresh">4.6. Commit and refresh</a></li>
<li><a href="#concepts-sharding-routing">4.7. Sharding and routing</a></li>
</ul>
</li>
<li><a href="#architecture">5.  Architecture</a>
<ul class="sectlevel2">
<li><a href="#architecture-hsearch-components">5.1.  Components of Hibernate Search</a></li>
<li><a href="#architecture-examples">5.2.  Examples of architectures</a>
<ul class="sectlevel3">
<li><a href="#architecture-examples-overview">5.2.1. Overview</a></li>
<li><a href="#architecture-examples-single-node-lucene">5.2.2.   Single-node application with the Lucene backend</a>
<ul class="sectlevel4">
<li><a href="#architecture-examples-single-node-lucene-description">Description</a></li>
<li><a href="#architecture-examples-single-node-lucene-pros-and-cons">Pros and cons</a></li>
<li><a href="#architecture-examples-single-node-lucene-getting-started">Getting started</a></li>
</ul>
</li>
<li><a href="#architecture-examples-no-coordination-elasticsearch">5.2.3.  Single-node or multi-node application, without coordination and with the Elasticsearch backend</a>
<ul class="sectlevel4">
<li><a href="#architecture-examples-no-coordination-elasticsearch-description">Description</a></li>
<li><a href="#architecture-examples-no-coordination-elasticsearch-pros-and-cons">Pros and cons</a></li>
<li><a href="#architecture-examples-no-coordination-elasticsearch-getting-started">Getting started</a></li>
</ul>
</li>
<li><a href="#architecture-examples-outbox-polling-elasticsearch">5.2.4.  Multi-node application with outbox polling and Elasticsearch backend</a>
<ul class="sectlevel4">
<li><a href="#architecture-examples-outbox-polling-elasticsearch-description"> Description</a></li>
<li><a href="#architecture-examples-outbox-polling-elasticsearch-pros-and-cons"> Pros and cons</a></li>
<li><a href="#architecture-examples-outbox-polling-elasticsearch-getting-started"> Getting started</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#mapper-orm">6.  Hibernate ORM integration</a>
<ul class="sectlevel2">
<li><a href="#mapper-orm-basics">6.1. Basics</a></li>
<li><a href="#mapper-orm-startup">6.2.   Startup</a></li>
<li><a href="#mapper-orm-shutdown">6.3. Shutdown</a></li>
<li><a href="#mapper-orm-mapping-dynamicmap">6.4.  Mapping <code>Map</code>-based models</a></li>
<li><a href="#mapper-orm-configuration-other">6.5.  Other configuration</a></li>
</ul>
</li>
<li><a href="#mapper-pojo-standalone">7. Standalone POJO Mapper</a>
<ul class="sectlevel2">
<li><a href="#mapper-pojo-standalone-basics">7.1. Basics</a></li>
<li><a href="#mapper-pojo-standalone-startup">7.2. Startup</a></li>
<li><a href="#mapper-pojo-standalone-shutdown">7.3. Shutdown</a></li>
<li><a href="#mapper-pojo-standalone-beanprovider">7.4. Bean provider</a></li>
<li><a href="#mapper-pojo-standalone-multi-tenancy">7.5. Multi-tenancy</a></li>
<li><a href="#mapper-pojo-standalone-mapping">7.6. Mapping</a></li>
<li><a href="#mapper-pojo-standalone-indexing">7.7. Indexing</a>
<ul class="sectlevel3">
<li><a href="#mapper-pojo-standalone-indexing-listener-triggered">7.7.1.  Listener-triggered indexing</a></li>
<li><a href="#mapper-pojo-standalone-indexing-plan">7.7.2. Explicitly indexing on entity change events</a></li>
<li><a href="#mapper-pojo-standalone-indexing-massindexer">7.7.3. Mass indexing</a></li>
<li><a href="#mapper-pojo-standalone-search-query-loading">7.7.4. Entity loading in search queries</a></li>
</ul>
</li>
<li><a href="#mapper-pojo-standalone-coordination">7.8. Coordination</a></li>
<li><a href="#mapper-pojo-standalone-configuration-from-property-file">7.9. Reading configuration properties from a file</a></li>
<li><a href="#mapper-pojo-standalone-configuration-other">7.10. Other configuration</a></li>
</ul>
</li>
<li><a href="#configuration">8.  Configuration</a>
<ul class="sectlevel2">
<li><a href="#configuration-sources">8.1.  Configuration sources</a>
<ul class="sectlevel3">
<li><a href="#configuration-sources-mapper-orm">8.1.1. Configuration sources when integrating into Hibernate ORM</a></li>
<li><a href="#configuration-sources-mapper-pojo-standalone">8.1.2. Configuration sources with the Standalone POJO mapper</a></li>
</ul>
</li>
<li><a href="#configuration-property">8.2. Configuration properties</a>
<ul class="sectlevel3">
<li><a href="#configuration-structure">8.2.1. Structure of configuration properties</a></li>
<li><a href="#configuration-builder">8.2.2. Building property keys programmatically</a></li>
<li><a href="#configuration-property-types">8.2.3. Type of configuration properties</a></li>
</ul>
</li>
<li><a href="#configuration-property-checking">8.3.  Configuration property checking</a></li>
<li><a href="#configuration-bean">8.4. Beans</a>
<ul class="sectlevel3">
<li><a href="#configuration-bean-frameworks">8.4.1. Supported frameworks</a>
<ul class="sectlevel4">
<li><a href="#configuration-bean-frameworks-mapper-orm">Supported frameworks when integrating into Hibernate ORM</a></li>
<li><a href="#configuration-bean-frameworks-mapper-pojo-standalone">Supported frameworks when using the Standalone POJO Mapper</a></li>
</ul>
</li>
<li><a href="#configuration-bean-reference">8.4.2. Bean references</a></li>
<li><a href="#configuration-bean-reference-parsing">8.4.3. Parsing of bean references</a></li>
<li><a href="#configuration-bean-resolution">8.4.4.  Bean resolution</a></li>
<li><a href="#configuration-bean-injection">8.4.5.  Bean injection</a></li>
<li><a href="#configuration-bean-lifecycle">8.4.6. Bean lifecycle</a></li>
</ul>
</li>
<li><a href="#configuration-global">8.5. Global configuration</a>
<ul class="sectlevel3">
<li><a href="#configuration-background-failure-handling">8.5.1.  Background failure handling</a></li>
<li><a href="#configuration-multi-tenancy">8.5.2. Multi-tenancy</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#entrypoints">9. Main API Entry Points</a>
<ul class="sectlevel2">
<li><a href="#entrypoints-search-mapping">9.1. <code>SearchMapping</code></a>
<ul class="sectlevel3">
<li><a href="#entrypoints-search-mapping-basics">9.1.1. Basics</a></li>
<li><a href="#entrypoints-search-mapping-mapper-orm">9.1.2. Retrieving the <code>SearchMapping</code> with the Hibernate ORM integration</a></li>
<li><a href="#entrypoints-search-mapping-mapper-pojo-standalone">9.1.3. Retrieving the <code>SearchMapping</code> with the Standalone POJO Mapper</a></li>
</ul>
</li>
<li><a href="#entrypoints-search-session">9.2. <code>SearchSession</code></a>
<ul class="sectlevel3">
<li><a href="#entrypoints-search-session-basics">9.2.1. Basics</a></li>
<li><a href="#entrypoints-search-session-mapper-orm">9.2.2. Retrieving the <code>SearchSession</code> with the Hibernate ORM integration</a></li>
<li><a href="#entrypoints-search-session-mapper-pojo-standalone">9.2.3. Retrieving the <code>SearchSession</code> with the Standalone POJO Mapper</a></li>
</ul>
</li>
<li><a href="#entrypoints-search-scope">9.3. <code>SearchScope</code></a></li>
</ul>
</li>
<li><a href="#mapping">10.   Mapping entities to indexes</a>
<ul class="sectlevel2">
<li><a href="#mapping-configuration">10.1.   Configuring the mapping</a>
<ul class="sectlevel3">
<li><a href="#mapping-annotations">10.1.1. Annotation-based mapping</a></li>
<li><a href="#mapping-classpath-scanning">10.1.2.  Classpath scanning</a>
<ul class="sectlevel4">
<li><a href="#mapping-classpath-scanning-basics"> Basics</a></li>
<li><a href="#mapping-classpath-scanning-dependencies"> Scanning dependencies of the application</a></li>
<li><a href="#mapping-classpath-scanning-faster"> Faster scanning</a></li>
</ul>
</li>
<li><a href="#mapping-programmatic">10.1.3.    Programmatic mapping</a></li>
<li><a href="#mapping-configurer">10.1.4. Mapping configurer</a>
<ul class="sectlevel4">
<li><a href="#mapper-orm-mapping-configurer">Hibernate ORM integration</a></li>
<li><a href="#mapper-pojo-standalone-mapping-configurer">Standalone POJO Mapper</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#mapping-entitydefinition">10.2. Entity definition</a>
<ul class="sectlevel3">
<li><a href="#mapping-entitydefinition-basics">10.2.1. Basics</a></li>
<li><a href="#mapping-entitydefinition-explicit">10.2.2. Explicit entity definition</a></li>
<li><a href="#mapping-entitydefinition-name">10.2.3. Entity name</a></li>
<li><a href="#mapping-entitydefinition-loading-mass">10.2.4. Mass loading strategy</a></li>
<li><a href="#mapping-entitydefinition-loading-selection">10.2.5. Selection loading strategy</a></li>
<li><a href="#mapping-entitydefinition-programmatic">10.2.6. Programmatic mapping</a></li>
</ul>
</li>
<li><a href="#mapping-entityindexmapping">10.3.  Entity/index mapping</a>
<ul class="sectlevel3">
<li><a href="#mapping-entityindexmapping-basics">10.3.1.  Basics</a></li>
<li><a href="#mapping-entityindexmapping-explicit">10.3.2.  Explicit index/backend</a></li>
<li><a href="#mapping-entityindexmapping-conditional-and-routing">10.3.3.   Conditional indexing and routing</a></li>
<li><a href="#mapping-entityindexmapping-programmatic">10.3.4.  Programmatic mapping</a></li>
</ul>
</li>
<li><a href="#mapping-identifiermapping">10.4.   Mapping the document identifier</a>
<ul class="sectlevel3">
<li><a href="#mapping-identifiermapping-basics">10.4.1.   Basics</a></li>
<li><a href="#mapping-identifiermapping-explicit">10.4.2.   Explicit identifier mapping</a></li>
<li><a href="#mapping-identifiermapping-supported-types">10.4.3.   Supported identifier property types</a></li>
<li><a href="#mapping-identifiermapping-programmatic">10.4.4.  Programmatic mapping</a></li>
</ul>
</li>
<li><a href="#mapping-directfieldmapping">10.5.  Mapping a property to an index field with <code>@GenericField</code>, <code>@FullTextField</code>, &#8230;&#8203;</a>
<ul class="sectlevel3">
<li><a href="#mapping-directfieldmapping-basics">10.5.1.  Basics</a></li>
<li><a href="#mapping-directfieldmapping-annotations">10.5.2.  Available field annotations</a></li>
<li><a href="#mapping-directfieldmapping-annotation-attributes">10.5.3.  Field annotation attributes</a></li>
<li><a href="#mapping-directfieldmapping-supported-types">10.5.4.   Supported property types</a></li>
<li><a href="#mapping-legacy-date-time-apis">10.5.5.  Support for legacy <code>java.util</code> date/time APIs</a></li>
<li><a href="#mapping-directfieldmapping-custom-types">10.5.6.  Mapping custom property types</a></li>
<li><a href="#mapping-directfieldmapping-programmatic">10.5.7.  Programmatic mapping</a></li>
</ul>
</li>
<li><a href="#mapping-indexedembedded">10.6.   Mapping associated elements with <code>@IndexedEmbedded</code></a>
<ul class="sectlevel3">
<li><a href="#mapping-indexedembedded-basics">10.6.1.  Basics</a></li>
<li><a href="#mapping-indexedembedded-null">10.6.2.   <code>@IndexedEmbedded</code> and <code>null</code> values</a></li>
<li><a href="#mapping-indexedembedded-multivalued">10.6.3.  <code>@IndexedEmbedded</code> on container types</a></li>
<li><a href="#mapping-indexedembedded-name">10.6.4.  Setting the object field name with <code>name</code></a></li>
<li><a href="#mapping-indexedembedded-prefix">10.6.5.  Setting the field name prefix with <code>prefix</code></a></li>
<li><a href="#mapping-indexedembedded-targetType">10.6.6.  Casting the target of <code>@IndexedEmbedded</code> with <code>targetType</code></a></li>
<li><a href="#mapping-indexedembedded-reindexing">10.6.7.   Reindexing when embedded elements change</a></li>
<li><a href="#mapping-indexedembedded-includeEmbeddedObjectId">10.6.8. Embedding the entity identifier</a></li>
<li><a href="#mapping-indexedembedded-filtering">10.6.9.   Filtering embedded fields and breaking <code>@IndexedEmbedded</code> cycles</a></li>
<li><a href="#mapping-indexedembedded-structure">10.6.10.   Structuring embedded elements as nested documents using <code>structure</code></a>
<ul class="sectlevel4">
<li><a href="#mapping-indexedembedded-structure-flattened">  <code>DEFAULT</code> or <code>FLATTENED</code> structure</a></li>
<li><a href="#mapping-indexedembedded-structure-nested">  <code>NESTED</code> structure</a></li>
</ul>
</li>
<li><a href="#mapping-indexedembedded-filtering-association">10.6.11. Filtering association elements</a></li>
<li><a href="#mapping-indexedembedded-programmatic">10.6.12.  Programmatic mapping</a></li>
</ul>
</li>
<li><a href="#mapping-containerextractor">10.7.  Mapping container types with container extractors</a>
<ul class="sectlevel3">
<li><a href="#mapping-containerextractor-basics">10.7.1.  Basics</a></li>
<li><a href="#mapping-containerextractor-explicit">10.7.2.   Explicit container extraction</a></li>
<li><a href="#mapping-containerextractor-disabling">10.7.3.   Disabling container extraction</a></li>
<li><a href="#mapping-containerextractor-programmatic">10.7.4.  Programmatic mapping</a></li>
</ul>
</li>
<li><a href="#mapping-geopoint">10.8.   Mapping geo-point types</a>
<ul class="sectlevel3">
<li><a href="#mapping-geopoint-basics">10.8.1.  Basics</a></li>
<li><a href="#mapping-geopoint-genericfield">10.8.2.   Using <code>@GenericField</code> and the <code>GeoPoint</code> interface</a></li>
<li><a href="#mapping-geopoint-geopointbinding">10.8.3.    Using <code>@GeoPointBinding</code>, <code>@Latitude</code> and <code>@Longitude</code></a></li>
<li><a href="#mapping-geopoint-programmatic">10.8.4.  Programmatic mapping</a></li>
</ul>
</li>
<li><a href="#mapping-alternatives">10.9.   Mapping multiple alternatives</a>
<ul class="sectlevel3">
<li><a href="#mapping-alternatives-basics">10.9.1.  Basics</a></li>
<li><a href="#mapping-alternatives-programmatic">10.9.2.  Programmatic mapping</a></li>
</ul>
</li>
<li><a href="#mapping-reindexing">10.10.  Tuning when to trigger reindexing</a>
<ul class="sectlevel3">
<li><a href="#mapping-reindexing-basics">10.10.1.  Basics</a></li>
<li><a href="#mapping-reindexing-associationinverseside">10.10.2.  Enriching the entity model with <code>@AssociationInverseSide</code></a></li>
<li><a href="#mapping-reindexing-derivedfrom">10.10.3.  Reindexing when a derived value changes with <code>@IndexingDependency</code></a></li>
<li><a href="#mapping-reindexing-reindexonupdate">10.10.4.  Limiting reindexing of containing entities with <code>@IndexingDependency</code></a>
<ul class="sectlevel4">
<li><a href="#mapping-reindexing-reindexonupdate-shallow"> <code>ReindexOnUpdate.SHALLOW</code>: limiting reindexing to same-entity updates only</a></li>
<li><a href="#mapping-reindexing-reindexonupdate-no"> <code>ReindexOnUpdate.NO</code>: disabling reindexing caused by updates of a particular property</a></li>
</ul>
</li>
<li><a href="#mapping-reindexing-programmatic">10.10.5.  Programmatic mapping</a></li>
</ul>
</li>
<li><a href="#mapping-changes">10.11.  Changing the mapping of an existing application</a></li>
<li><a href="#mapping-custom-annotations">10.12.  Custom mapping annotations</a>
<ul class="sectlevel3">
<li><a href="#mapping-custom-annotations-basics">10.12.1.  Basics</a></li>
<li><a href="#mapping-custom-annotations-root">10.12.2.  Custom root mapping annotations</a></li>
</ul>
</li>
<li><a href="#mapping-inspect">10.13.   Inspecting the mapping</a></li>
</ul>
</li>
<li><a href="#mapping-projection">11.  Mapping index content to custom types (projection constructors)</a>
<ul class="sectlevel2">
<li><a href="#mapping-projection-basics">11.1.  Basics</a></li>
<li><a href="#mapping-projection-type-detection">11.2.  Detection of mapped projection types</a></li>
<li><a href="#mapping-projection-inner-inference">11.3.  Implicit inner projection inference</a>
<ul class="sectlevel3">
<li><a href="#mapping-projection-inner-inference-basics">11.3.1.  Basics</a></li>
<li><a href="#mapping-projection-inner-inference-type">11.3.2.  Inner projection and type</a></li>
<li><a href="#mapping-projection-inner-inference-fieldpath">11.3.3.  Inner projection and field path</a></li>
</ul>
</li>
<li><a href="#mapping-projection-inner-explicit">11.4. Explicit inner projection</a></li>
<li><a href="#mapping-projection-multiple-constructors">11.5.  Mapping types with multiple constructors</a></li>
<li><a href="#mapping-projection-programmatic">11.6.  Programmatic mapping</a></li>
</ul>
</li>
<li><a href="#binding">12.   Binding and bridges</a>
<ul class="sectlevel2">
<li><a href="#binding-basics">12.1.   Basics</a></li>
<li><a href="#binding-valuebridge">12.2.   Value bridge</a>
<ul class="sectlevel3">
<li><a href="#binding-valuebridge-basics">12.2.1.  Basics</a></li>
<li><a href="#binding-valuebridge-type-resolution">12.2.2.  Type resolution</a></li>
<li><a href="#binding-valuebridge-annotation-compatibility">12.2.3.  Using value bridges in other <code>@*Field</code> annotations</a></li>
<li><a href="#binding-valuebridge-projection">12.2.4.   Supporting projections with <code>fromIndexedValue()</code></a></li>
<li><a href="#binding-valuebridge-indexnullas">12.2.5.  Supporting <code>indexNullAs</code> with <code>parse()</code></a></li>
<li><a href="#binding-valuebridge-iscompatiblewith">12.2.6.  Compatibility across indexes with <code>isCompatibleWith()</code></a></li>
<li><a href="#binding-valuebridge-valuebinder">12.2.7.  Configuring the bridge more finely with <code>ValueBinder</code></a></li>
<li><a href="#binding-valuebridge-parameters">12.2.8.  Passing parameters</a>
<ul class="sectlevel4">
<li><a href="#binding-valuebridge-parameters-string"> Simple, string parameters</a></li>
<li><a href="#binding-valuebridge-parameters-custom-annotation">  Parameters with custom annotations</a></li>
</ul>
</li>
<li><a href="#binding-valuebridge-access-orm">12.2.9.  Accessing the ORM session or session factory from the bridge</a></li>
<li><a href="#binding-valuebridge-injection">12.2.10.  Injecting beans into the value bridge or value binder</a></li>
<li><a href="#binding-valuebridge-programmatic">12.2.11.  Programmatic mapping</a></li>
<li><a href="#binding-valuebridge-incubating">12.2.12.  Incubating features</a></li>
</ul>
</li>
<li><a href="#binding-propertybridge">12.3.   Property bridge</a>
<ul class="sectlevel3">
<li><a href="#binding-propertybridge-basics">12.3.1.  Basics</a></li>
<li><a href="#binding-propertybridge-parameters">12.3.2.   Passing parameters</a>
<ul class="sectlevel4">
<li><a href="#binding-propertybridge-parameters-string"> Simple, string parameters</a></li>
<li><a href="#binding-propertybridge-parameters-custom-annotation"> Parameters with custom annotations</a></li>
</ul>
</li>
<li><a href="#binding-propertybridge-access-orm">12.3.3.  Accessing the ORM session from the bridge</a></li>
<li><a href="#binding-propertybridge-injecting-beans">12.3.4.  Injecting beans into the binder</a></li>
<li><a href="#binding-propertybridge-programmatic">12.3.5.  Programmatic mapping</a></li>
<li><a href="#binding-propertybridge-incubating">12.3.6.  Incubating features</a></li>
</ul>
</li>
<li><a href="#binding-typebridge">12.4.   Type bridge</a>
<ul class="sectlevel3">
<li><a href="#binding-typebridge-basics">12.4.1.  Basics</a></li>
<li><a href="#binding-typebridge-parameters">12.4.2.  Passing parameters</a>
<ul class="sectlevel4">
<li><a href="#binding-typebridge-parameters-string"> Simple, string parameters</a></li>
<li><a href="#binding-typebridge-parameters-custom-annotation"> Parameters with custom annotations</a></li>
</ul>
</li>
<li><a href="#binding-typebridge-access-orm">12.4.3.  Accessing the ORM session from the bridge</a></li>
<li><a href="#binding-typebridge-injecting-beans">12.4.4.  Injecting beans into the binder</a></li>
<li><a href="#binding-typebridge-programmatic">12.4.5.  Programmatic mapping</a></li>
<li><a href="#binding-typebridge-incubating">12.4.6.  Incubating features</a></li>
</ul>
</li>
<li><a href="#binding-identifierbridge">12.5.  Identifier bridge</a>
<ul class="sectlevel3">
<li><a href="#binding-identifierbridge-basics">12.5.1.  Basics</a></li>
<li><a href="#binding-identifierbridge-type-resolution">12.5.2.  Type resolution</a></li>
<li><a href="#binding-identifierbridge-iscompatiblewith">12.5.3.  Compatibility across indexes with <code>isCompatibleWith()</code></a></li>
<li><a href="#binding-identifierbridge-identifierbinder">12.5.4.  Configuring the bridge more finely with <code>IdentifierBinder</code></a></li>
<li><a href="#binding-identifierbridge-parameters">12.5.5.   Passing parameters</a>
<ul class="sectlevel4">
<li><a href="#binding-identifierbridge-parameters-string"> Simple, string parameters</a></li>
<li><a href="#binding-identifierbridge-parameters-custom-annotation"> Parameters with custom annotations</a></li>
</ul>
</li>
<li><a href="#binding-identifierbridge-access-orm">12.5.6.  Accessing the ORM session or session factory from the bridge</a></li>
<li><a href="#binding-identifierbridge-injecting-beans">12.5.7.   Injecting beans into the bridge or binder</a></li>
<li><a href="#binding-identifierbridge-programmatic">12.5.8.  Programmatic mapping</a></li>
<li><a href="#binding-identifierbridge-incubating">12.5.9.  Incubating features</a></li>
</ul>
</li>
<li><a href="#binding-routingbridge">12.6.   Routing bridge</a>
<ul class="sectlevel3">
<li><a href="#binding-routingbridge-basics">12.6.1.  Basics</a></li>
<li><a href="#binding-routingbridge-conditionalindexing">12.6.2.   Using a routing bridge for conditional indexing</a></li>
<li><a href="#binding-routingbridge-routingkey">12.6.3.  Using a routing bridge to control routing to index shards</a></li>
<li><a href="#binding-routingbridge-parameters">12.6.4.   Passing parameters</a></li>
<li><a href="#binding-routingbridge-access-orm">12.6.5.  Accessing the ORM session from the bridge</a></li>
<li><a href="#binding-routingbridge-injection">12.6.6.  Injecting beans into the binder</a></li>
<li><a href="#binding-routingbridge-programmatic">12.6.7.   Programmatic mapping</a></li>
<li><a href="#binding-routingbridge-incubating">12.6.8.  Incubating features</a></li>
</ul>
</li>
<li><a href="#binding-bridgedelement-dependencies">12.7.  Declaring dependencies to bridged elements</a>
<ul class="sectlevel3">
<li><a href="#binding-bridgedelement-dependencies-basics">12.7.1.  Basics</a></li>
<li><a href="#binding-bridgedelement-dependencies-containers">12.7.2.  Traversing non-default containers (map keys, &#8230;&#8203;)</a></li>
<li><a href="#binding-bridgedelement-dependencies-useRootOnly">12.7.3.  <code>useRootOnly()</code>: declaring no dependency at all</a></li>
<li><a href="#binding-bridgedelement-dependencies-fromOtherEntity">12.7.4.  <code>fromOtherEntity(&#8230;&#8203;)</code>: declaring dependencies using the inverse path</a></li>
</ul>
</li>
<li><a href="#binding-index-field-dsl">12.8.  Declaring and writing to index fields</a>
<ul class="sectlevel3">
<li><a href="#binding-index-field-dsl-basics">12.8.1.  Basics</a></li>
<li><a href="#binding-index-field-dsl-type-objects">12.8.2.   Type objects</a></li>
<li><a href="#binding-index-field-dsl-multi-valued-fields">12.8.3.   Multivalued fields</a></li>
<li><a href="#binding-index-field-dsl-object">12.8.4.  Object fields</a></li>
<li><a href="#binding-index-field-dsl-object-structure">12.8.5.   Object structure</a></li>
<li><a href="#binding-index-field-dsl-dynamic">12.8.6.  Dynamic fields with field templates</a></li>
</ul>
</li>
<li><a href="#binding-index-field-type-dsl">12.9.  Defining index field types</a>
<ul class="sectlevel3">
<li><a href="#binding-index-field-type-dsl-basics">12.9.1.  Basics</a></li>
<li><a href="#binding-index-field-type-dsl-data-types">12.9.2.   Available data types</a></li>
<li><a href="#binding-index-field-type-dsl-options">12.9.3.   Available type options</a></li>
<li><a href="#binding-index-field-type-dsl-converter">12.9.4.   DSL converter</a></li>
<li><a href="#binding-index-field-type-dsl-projection-converter">12.9.5.   Projection converter</a></li>
<li><a href="#binding-index-field-type-dsl-backend-specific-types">12.9.6.   Backend-specific types</a></li>
</ul>
</li>
<li><a href="#binding-named-predicate">12.10.  Defining named predicates</a></li>
<li><a href="#binding-bridge-resolver">12.11.   Assigning default bridges with the bridge resolver</a>
<ul class="sectlevel3">
<li><a href="#binding-bridge-resolver-basics">12.11.1.  Basics</a></li>
<li><a href="#binding-bridge-resolver-single-binder-multiple-types">12.11.2.   Assigning a single binder to multiple types</a></li>
</ul>
</li>
<li><a href="#binding-projection">12.12. Projection binder</a>
<ul class="sectlevel3">
<li><a href="#binding-projection-basics">12.12.1. Basics</a></li>
<li><a href="#binding-projection-multi">12.12.2. Multi-valued projections</a></li>
<li><a href="#binding-projection-composing">12.12.3. Composing projection constructors</a></li>
<li><a href="#binding-projection-parameters">12.12.4. Passing parameters</a>
<ul class="sectlevel4">
<li><a href="#binding-projection-parameters-string">Simple, string parameters</a></li>
<li><a href="#binding-projection-parameters-custom-annotation">Parameters with custom annotations</a></li>
</ul>
</li>
<li><a href="#binding-projection-injecting-beans">12.12.5. Injecting beans into the binder</a></li>
<li><a href="#binding-projection-programmatic">12.12.6. Programmatic mapping</a></li>
<li><a href="#binding-projection-parameters-incubating">12.12.7. Other incubating features</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#schema-management">13.  Managing the index schema</a>
<ul class="sectlevel2">
<li><a href="#schema-management-basics">13.1.  Basics</a></li>
<li><a href="#schema-management-strategy">13.2.  Automatic schema management on startup/shutdown</a></li>
<li><a href="#schema-management-manager">13.3.  Manual schema management</a></li>
<li><a href="#schema-management-concepts">13.4.  How schema management works</a></li>
<li><a href="#schema-management-export">13.5. Exporting the schema</a>
<ul class="sectlevel3">
<li><a href="#schema-management-export-filesystem">13.5.1. Exporting the schema to a set of files</a></li>
<li><a href="#schema-management-export-custom">13.5.2. Exporting to a custom collector</a></li>
<li><a href="#schema-management-export-offline">13.5.3. Exporting in offline mode</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#indexing">14.  Indexing entities</a>
<ul class="sectlevel2">
<li><a href="#indexing-basics">14.1. Basics</a></li>
<li><a href="#indexing-plan">14.2. Indexing plans</a>
<ul class="sectlevel3">
<li><a href="#indexing-plan-basics">14.2.1. Basics</a></li>
<li><a href="#indexing-plan-synchronization">14.2.2.   Synchronization with the indexes</a>
<ul class="sectlevel4">
<li><a href="#indexing-plan-synchronization-basics"> Basics</a></li>
<li><a href="#indexing-plan-synchronization-override-per-session">  Per-session override</a></li>
<li><a href="#indexing-plan-synchronization-custom">  Custom strategy</a></li>
</ul>
</li>
<li><a href="#indexing-plan-filter">14.2.3. Indexing plan filter</a></li>
</ul>
</li>
<li><a href="#listener-triggered-indexing">14.3.    Implicit, listener-triggered indexing</a>
<ul class="sectlevel3">
<li><a href="#listener-triggered-indexing-concepts">14.3.1.  Basics</a></li>
<li><a href="#indexing-automatic-configuration">14.3.2.  Configuration</a></li>
<li><a href="#indexing-automatic-concepts-changes-in-session">14.3.3.  In-session entity change detection and limitations</a></li>
<li><a href="#indexing-automatic-concepts-dirty-checking">14.3.4.  Dirty checking</a></li>
</ul>
</li>
<li><a href="#indexing-massindexer">14.4.   Indexing a large amount of data with the <code>MassIndexer</code></a>
<ul class="sectlevel3">
<li><a href="#indexing-massindexer-basics">14.4.1.  Basics</a></li>
<li><a href="#indexing-massindexer-selecting-types">14.4.2. Selecting types to be indexed</a></li>
<li><a href="#indexing-massindexer-multitenancy">14.4.3. Mass indexing multiple tenants</a></li>
<li><a href="#indexing-massindexer-asynchronous">14.4.4. Running the mass indexer asynchronously</a></li>
<li><a href="#indexing-massindexer-conditional">14.4.5.  Conditional reindexing</a></li>
<li><a href="#indexing-massindexer-parameters">14.4.6.   <code>MassIndexer</code> parameters</a></li>
<li><a href="#indexing-massindexer-tuning">14.4.7.  Tuning the <code>MassIndexer</code> for best performance</a>
<ul class="sectlevel4">
<li><a href="#indexing-massindexer-tuning-basics"> Basics</a></li>
<li><a href="#indexing-massindexer-tuning-threads">  Threads and connections</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#mapper-orm-indexing-jakarta-batch">14.5.   Indexing a large amount of data with the Jakarta Batch integration</a>
<ul class="sectlevel3">
<li><a href="#mapper-orm-indexing-jakarta-batch-basics">14.5.1. Basics</a></li>
<li><a href="#mapper-orm-indexing-jakarta-batch-parameters">14.5.2.  Job Parameters</a></li>
<li><a href="#mapper-orm-indexing-jakarta-batch-conditional">14.5.3.   Conditional indexing</a></li>
<li><a href="#mapper-orm-indexing-jakarta-batch-parallel-indexing">14.5.4.  Parallel indexing</a>
<ul class="sectlevel4">
<li><a href="#mapper-orm-indexing-jakarta-batch-parallel-indexing-threads"> Threads</a></li>
<li><a href="#mapper-orm-indexing-jakarta-batch-parallel-indexing-rows-per-partition"> Rows per partition</a></li>
</ul>
</li>
<li><a href="#mapper-orm-indexing-jakarta-batch-chunking">14.5.5.  Chunking and session clearing</a></li>
<li><a href="#mapper-orm-indexing-jakarta-batch-emf">14.5.6.  Selecting the persistence unit (EntityManagerFactory)</a>
<ul class="sectlevel4">
<li><a href="#mapper-orm-indexing-jakarta-batch-emf-jberet"> JBeret</a></li>
<li><a href="#mapper-orm-indexing-jakarta-batch-emf-other-implementation"> Other DI-enabled Jakarta Batch implementations</a></li>
<li><a href="#mapper-orm-indexing-jakarta-batch-no-dependency-injection"> Plain Java environment (no dependency injection at all)</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#indexing-explicit">14.6.   Explicit indexing</a>
<ul class="sectlevel3">
<li><a href="#indexing-explicit-basics">14.6.1.   Basics</a></li>
<li><a href="#listener-triggered-indexing-synchronization">14.6.2. Configuration</a></li>
<li><a href="#indexing-explicit-plan">14.6.3.    Using a <code>SearchIndexingPlan</code> manually</a></li>
<li><a href="#mapper-orm-indexing-manual-indexingplan-process-execute">14.6.4.  Hibernate ORM and the periodic "flush-clear" pattern with <code>SearchIndexingPlan</code></a></li>
</ul>
</li>
<li><a href="#indexing-workspace">14.7.  Explicitly altering a whole index</a></li>
</ul>
</li>
<li><a href="#search-dsl">15.  Searching</a>
<ul class="sectlevel2">
<li><a href="#search-dsl-query">15.1.  Query DSL</a>
<ul class="sectlevel3">
<li><a href="#search-dsl-query-generality">15.1.1.  Basics</a></li>
<li><a href="#search-dsl-query-targeting">15.1.2. Advanced entity types targeting</a>
<ul class="sectlevel4">
<li><a href="#search-dsl-query-targeting-multiple">Targeting multiple entity types</a></li>
<li><a href="#search-dsl-query-targeting-entityName">Targeting entity types by name</a></li>
</ul>
</li>
<li><a href="#search-dsl-query-fetching-results">15.1.3.  Fetching results</a>
<ul class="sectlevel4">
<li><a href="#search-dsl-query-fetching-results-basics"> Basics</a></li>
<li><a href="#search-dsl-query-fetching-results-all">Fetching all hits</a></li>
<li><a href="#search-dsl-query-fetching-results-total">Fetching the total (hit count, &#8230;&#8203;)</a></li>
<li><a href="#search-dsl-query-total-hits-threshold"><code>totalHitCountThreshold(&#8230;&#8203;)</code>: optimizing total hit count computation</a></li>
<li><a href="#search-dsl-query-fetching-results-pagination"> Pagination</a></li>
<li><a href="#search-dsl-query-fetching-results-scrolling"> Scrolling</a></li>
</ul>
</li>
<li><a href="#search-dsl-query-routing">15.1.4.  Routing</a></li>
<li><a href="#search-dsl-query-entity-loading-options">15.1.5. Entity loading options for Hibernate ORM</a>
<ul class="sectlevel4">
<li><a href="#search-dsl-query-cache-lookup-strategy"> Cache lookup strategy</a></li>
<li><a href="#search-dsl-query-fetch-size">Fetch size</a></li>
<li><a href="#search-dsl-query-entity-graph"> Entity graph</a></li>
</ul>
</li>
<li><a href="#search-dsl-query-timeout">15.1.6.  Timeout</a>
<ul class="sectlevel4">
<li><a href="#search-dsl-query-timeout-failafter"> <code>failAfter()</code>: Aborting the query after a given amount of time</a></li>
<li><a href="#limit_the_number_of_results_when_the_time_limit_is_reached"> <code>truncateAfter()</code>: Truncating the results after a given amount of time</a></li>
</ul>
</li>
<li><a href="#search-dsl-query-object">15.1.7. Obtaining a query object</a></li>
<li><a href="#search-dsl-query-explain">15.1.8. <code>explain(&#8230;&#8203;)</code>: Explaining scores</a></li>
<li><a href="#search-dsl-query-took-timedout">15.1.9.  <code>took</code> and <code>timedOut</code>: finding out how long the query took</a></li>
<li><a href="#search-dsl-query-elasticsearch-json">15.1.10. Elasticsearch: leveraging advanced features with JSON manipulation</a></li>
<li><a href="#search-dsl-query-lucene-low-level">15.1.11. Lucene: retrieving low-level components</a></li>
</ul>
</li>
<li><a href="#search-dsl-predicate">15.2.  Predicate DSL</a>
<ul class="sectlevel3">
<li><a href="#search-dsl-predicate-concepts">15.2.1. Basics</a></li>
<li><a href="#search-dsl-predicate-match-all">15.2.2. <code>matchAll</code>: match all documents</a>
<ul class="sectlevel4">
<li><a href="#search-dsl-predicate-match-all-except"><code>except(&#8230;&#8203;)</code>: exclude documents matching a given predicate</a></li>
<li><a href="#search-dsl-predicate-match-all-other">Other options</a></li>
</ul>
</li>
<li><a href="#search-dsl-predicate-match-none">15.2.3. <code>matchNone</code>: match no documents</a></li>
<li><a href="#search-dsl-predicate-id">15.2.4. <code>id</code>: match a document identifier</a>
<ul class="sectlevel4">
<li><a href="#search-dsl-predicate-id-argument-type">Expected type of arguments</a></li>
<li><a href="#search-dsl-predicate-id-other">Other options</a></li>
</ul>
</li>
<li><a href="#search-dsl-predicate-match">15.2.5.  <code>match</code>: match a value</a>
<ul class="sectlevel4">
<li><a href="#search-dsl-predicate-match-argument-type">Expected type of arguments</a></li>
<li><a href="#search-dsl-predicate-match-multiple-fields">Targeting multiple fields</a></li>
<li><a href="#search-dsl-predicate-match-analysis">Analysis</a></li>
<li><a href="#search-dsl-predicate-match-fuzzy"> <code>fuzzy</code>: match a text value approximately</a></li>
<li><a href="#search-dsl-predicate-match-other">Other options</a></li>
</ul>
</li>
<li><a href="#search-dsl-predicate-range">15.2.6.  <code>range</code>: match a range of values</a>
<ul class="sectlevel4">
<li><a href="#search-dsl-predicate-range-argument-type">Expected type of arguments</a></li>
<li><a href="#search-dsl-predicate-range-multiple-fields">Targeting multiple fields</a></li>
<li><a href="#search-dsl-predicate-range-other">Other options</a></li>
</ul>
</li>
<li><a href="#search-dsl-predicate-phrase">15.2.7.  <code>phrase</code>: match a sequence of words</a>
<ul class="sectlevel4">
<li><a href="#search-dsl-predicate-phrase-slop"><code>slop</code>: match a sequence of words approximately</a></li>
<li><a href="#search-dsl-predicate-phrase-multiple-fields">Targeting multiple fields</a></li>
<li><a href="#search-dsl-predicate-phrase-other">Other options</a></li>
</ul>
</li>
<li><a href="#search-dsl-predicate-exists">15.2.8. <code>exists</code>: match fields with content</a>
<ul class="sectlevel4">
<li><a href="#search-dsl-predicate-exists-object-field">Object fields</a></li>
<li><a href="#search-dsl-predicate-exists-other">Other options</a></li>
</ul>
</li>
<li><a href="#search-dsl-predicate-wildcard">15.2.9.  <code>wildcard</code>: match a simple pattern</a>
<ul class="sectlevel4">
<li><a href="#search-dsl-predicate-wildcard-multiple-fields">Targeting multiple fields</a></li>
<li><a href="#search-dsl-predicate-wildcard-other">Other options</a></li>
</ul>
</li>
<li><a href="#search-dsl-predicate-regexp">15.2.10. <code>regexp</code>: match a regular expression pattern</a>
<ul class="sectlevel4">
<li><a href="#search-dsl-predicate-regexp-analysis"> Regexp predicates and analysis</a></li>
<li><a href="#search-dsl-predicate-regexp-flags"><code>flags</code>: enabling only specific syntax constructs</a></li>
<li><a href="#search-dsl-predicate-regexp-multiple-fields">Targeting multiple fields</a></li>
<li><a href="#search-dsl-predicate-regexp-other">Other options</a></li>
</ul>
</li>
<li><a href="#search-dsl-predicate-terms">15.2.11. <code>terms</code>: match a set of terms</a>
<ul class="sectlevel4">
<li><a href="#search-dsl-predicate-terms-analysis"><code>terms</code> predicates and analysis</a></li>
<li><a href="#search-dsl-predicate-terms-argument-type"> Expected type of arguments</a></li>
<li><a href="#search-dsl-predicate-terms-multiple-fields">Targeting multiple fields</a></li>
<li><a href="#search-dsl-predicate-terms-other">Other options</a></li>
</ul>
</li>
<li><a href="#search-dsl-predicate-and">15.2.12. <code>and</code>: match all clauses</a>
<ul class="sectlevel4">
<li><a href="#search-dsl-predicate-and-lambda">Adding clauses dynamically with the lambda syntax</a></li>
<li><a href="#search-dsl-predicate-and-other">Options</a></li>
</ul>
</li>
<li><a href="#search-dsl-predicate-or">15.2.13. <code>or</code>: match any clause</a>
<ul class="sectlevel4">
<li><a href="#search-dsl-predicate-or-lambda">Adding clauses dynamically with the lambda syntax</a></li>
<li><a href="#search-dsl-predicate-or-other">Options</a></li>
</ul>
</li>
<li><a href="#search-dsl-predicate-not">15.2.14. <code>not</code>: negating another predicate</a>
<ul class="sectlevel4">
<li><a href="#search-dsl-predicate-not-other">Other options</a></li>
</ul>
</li>
<li><a href="#search-dsl-predicate-boolean">15.2.15.  <code>bool</code>: advanced combinations of predicates (or/and/&#8230;&#8203;)</a>
<ul class="sectlevel4">
<li><a href="#search-dsl-predicate-boolean-or">Emulating an <code>OR</code> operator</a></li>
<li><a href="#search-dsl-predicate-boolean-and">Emulating an <code>AND</code> operator</a></li>
<li><a href="#search-dsl-predicate-boolean-mustNot"><code>mustNot</code>: excluding documents that match a given predicate</a></li>
<li><a href="#search-dsl-predicate-boolean-filter"><code>filter</code>: matching documents that match a given predicate without affecting the score</a></li>
<li><a href="#search-dsl-predicate-boolean-should-scoring"><code>should</code> as a way to tune scoring</a></li>
<li><a href="#search-dsl-predicate-boolean-minimumshouldmatch"><code>minimumShouldMatch</code>: fine-tuning how many <code>should</code> clauses are required to match</a></li>
<li><a href="#search-dsl-predicate-boolean-lambda">Adding clauses dynamically with the lambda syntax</a></li>
<li><a href="#search-dsl-predicate-boolean-deprecated-variants">Deprecated variants</a></li>
<li><a href="#search-dsl-predicate-boolean-other">Other options</a></li>
</ul>
</li>
<li><a href="#search-dsl-predicate-simple-query-string">15.2.16.  <code>simpleQueryString</code>: match a user-provided query string</a>
<ul class="sectlevel4">
<li><a href="#search-dsl-predicate-simple-query-string-boolean-operators">Boolean operators</a></li>
<li><a href="#search-dsl-predicate-simple-query-string-boolean-operators-default">Default boolean operator</a></li>
<li><a href="#search-dsl-predicate-simple-query-string-prefix">Prefix</a></li>
<li><a href="#search-dsl-predicate-simple-query-string-fuzzy">Fuzzy</a></li>
<li><a href="#search-dsl-predicate-simple-query-string-phrase">Phrase</a></li>
<li><a href="#search-dsl-predicate-simple-query-string-flags"><code>flags</code>: enabling only specific syntax constructs</a></li>
<li><a href="#search-dsl-predicate-simple-query-string-minimumshouldmatch"><code>minimumShouldMatch</code>: fine-tuning how many <code>should</code> clauses are required to match</a></li>
<li><a href="#search-dsl-predicate-simpleQueryString-multiple-fields">Targeting multiple fields</a></li>
<li><a href="#search-dsl-predicate-simpleQueryString-other">Other options</a></li>
</ul>
</li>
<li><a href="#search-dsl-predicate-nested">15.2.17. <code>nested</code>: match nested documents</a>
<ul class="sectlevel4">
<li><a href="#search-dsl-predicate-nested-implicit"> Implicit nesting</a></li>
<li><a href="#search-dsl-predicate-nested-deprecated-variants">Deprecated variants</a></li>
</ul>
</li>
<li><a href="#search-dsl-predicate-spatial-within">15.2.18.  <code>within</code>: match points within a circle, box, polygon</a>
<ul class="sectlevel4">
<li><a href="#search-dsl-predicate-spatial-within-circle">Matching points within a circle (within a distance to a point)</a></li>
<li><a href="#search-dsl-predicate-spatial-within-bounding-box">Matching points within a bounding box</a></li>
<li><a href="#search-dsl-predicate-spatial-within-polygon">Matching points within a polygon</a></li>
<li><a href="#search-dsl-predicate-spatial-within-multiple-fields">Targeting multiple fields</a></li>
<li><a href="#search-dsl-predicate-spatial-within-other">Other options</a></li>
</ul>
</li>
<li><a href="#search-dsl-predicate-knn">15.2.19. <code>knn</code>: K-Nearest Neighbors a.k.a. vector search</a>
<ul class="sectlevel4">
<li><a href="#search-dsl-predicate-knn-argument-type">Expected type of arguments</a></li>
<li><a href="#search-dsl-predicate-knn-filter">Filtering the neighbors</a></li>
<li><a href="#search-dsl-predicate-knn-with-text-search">Combining <code>knn</code> with other predicates</a></li>
<li><a href="#search-dsl-predicate-knn-with-similarity">Filtering out irrelevant results with <code>knn</code> similarity</a></li>
<li><a href="#search-dsl-predicate-knn-limitations">Backend specifics and limitations</a></li>
<li><a href="#search-dsl-predicate-knn-other">Other options</a></li>
</ul>
</li>
<li><a href="#search-dsl-predicate-query-string">15.2.20. <code>queryString</code>: match a user-provided query string</a>
<ul class="sectlevel4">
<li><a href="#search-dsl-predicate-query-string-boolean-operators-default">Default boolean operator</a></li>
<li><a href="#search-dsl-predicate-query-string-phrase-slop">Phrase slop</a></li>
<li><a href="#search-dsl-predicate-query-string-allow-leading-wildcard">Allowing leading wildcards</a></li>
<li><a href="#search-dsl-predicate-query-string-enable-position-increments">Enabling position increments</a></li>
<li><a href="#search-dsl-predicate-query-string-rewrite-method">Rewrite method</a></li>
<li><a href="#search-dsl-predicate-query-string-minimumshouldmatch"><code>minimumShouldMatch</code>: fine-tuning how many <code>should</code> clauses are required to match</a></li>
<li><a href="#search-dsl-predicate-query-string-multiple-fields">Targeting multiple fields</a></li>
<li><a href="#search-dsl-predicate-query-string-other">Other options</a></li>
</ul>
</li>
<li><a href="#search-dsl-predicate-named">15.2.21.  <code>named</code>: call a predicate defined in the mapping</a></li>
<li><a href="#search-dsl-predicate-extensions">15.2.22. Backend-specific extensions</a>
<ul class="sectlevel4">
<li><a href="#search-dsl-predicate-extensions-lucene-from-lucene-query">Lucene: <code>fromLuceneQuery</code></a></li>
<li><a href="#search-dsl-predicate-extensions-elasticsearch-from-json">Elasticsearch: <code>fromJson</code></a></li>
</ul>
</li>
<li><a href="#search-dsl-predicate-common">15.2.23.  Options common to multiple predicate types</a>
<ul class="sectlevel4">
<li><a href="#search-dsl-predicate-common-multiple-fields">Targeting multiple fields in one predicate</a></li>
<li><a href="#search-dsl-predicate-common-score">Tuning the score</a></li>
<li><a href="#search-dsl-predicate-common-overriding-analysis">Overriding analysis</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#search-dsl-sort">15.3.  Sort DSL</a>
<ul class="sectlevel3">
<li><a href="#search-dsl-sort-concepts">15.3.1. Basics</a></li>
<li><a href="#search-dsl-sort-score">15.3.2. <code>score</code>: sort by matching score (relevance)</a>
<ul class="sectlevel4">
<li><a href="#search-dsl-sort-score-options">Options</a></li>
</ul>
</li>
<li><a href="#search-dsl-sort-index-order">15.3.3. <code>indexOrder</code>: sort according to the order of documents on storage</a></li>
<li><a href="#search-dsl-sort-field">15.3.4. <code>field</code>: sort by field values</a>
<ul class="sectlevel4">
<li><a href="#search-dsl-sort-field-syntax">Syntax</a></li>
<li><a href="#search-dsl-sort-field-options">Options</a></li>
</ul>
</li>
<li><a href="#search-dsl-sort-distance">15.3.5. <code>distance</code>: sort by distance to a point</a>
<ul class="sectlevel4">
<li><a href="#search-dsl-sort-distance-prerequisites">Prerequisites</a></li>
<li><a href="#search-dsl-sort-distance-syntax">Syntax</a></li>
<li><a href="#search-dsl-sort-distance-options">Options</a></li>
</ul>
</li>
<li><a href="#search-dsl-sort-composite">15.3.6. <code>composite</code>: combine sorts</a>
<ul class="sectlevel4">
<li><a href="#search-dsl-sort-composite-lambda">Adding sorts dynamically with the lambda syntax</a></li>
<li><a href="#search-dsl-sort-stabilize">Stabilizing a sort</a></li>
</ul>
</li>
<li><a href="#search-dsl-sort-extensions">15.3.7. Backend-specific extensions</a>
<ul class="sectlevel4">
<li><a href="#search-dsl-sort-extensions-lucene-from-lucene-sort">Lucene: <code>fromLuceneSort</code></a></li>
<li><a href="#search-dsl-sort-extensions-lucene-from-lucene-sort-field"> Lucene: <code>fromLuceneSortField</code></a></li>
<li><a href="#search-dsl-sort-extensions-elasticsearch-from-json">Elasticsearch: <code>fromJson</code></a></li>
</ul>
</li>
<li><a href="#search-dsl-sort-common">15.3.8. Options common to multiple sort types</a>
<ul class="sectlevel4">
<li><a href="#search-dsl-sort-common-order">Sort order</a></li>
<li><a href="#search-dsl-sort-common-missing"> Missing values</a></li>
<li><a href="#search-dsl-sort-common-multi-value-mode">Sort mode for multivalued fields</a></li>
<li><a href="#search-dsl-sort-common-filter">Filter for fields in nested objects</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#search-dsl-projection">15.4.  Projection DSL</a>
<ul class="sectlevel3">
<li><a href="#search-dsl-projection-concepts">15.4.1. Basics</a></li>
<li><a href="#search-dsl-projection-mapped">15.4.2. Projecting to a custom (annotated) type</a></li>
<li><a href="#search-dsl-projection-documentReference">15.4.3. <code>documentReference</code>: return references to matched documents</a>
<ul class="sectlevel4">
<li><a href="#search-dsl-projection-documentReference-syntax">Syntax</a></li>
<li><a href="#search-dsl-projection-documentReference-mapping"><code>@DocumentReferenceProjection</code> in projections to custom types</a></li>
</ul>
</li>
<li><a href="#search-dsl-projection-reference">15.4.4. <code>entityReference</code>: return references to matched entities</a>
<ul class="sectlevel4">
<li><a href="#search-dsl-projection-reference-syntax">Syntax</a></li>
<li><a href="#search-dsl-projection-reference-mapping"><code>@EntityReferenceProjection</code> in projections to custom types</a></li>
</ul>
</li>
<li><a href="#search-dsl-projection-id">15.4.5.  <code>id</code>: return identifiers of matched entities</a>
<ul class="sectlevel4">
<li><a href="#search-dsl-projection-id-syntax">Syntax</a></li>
<li><a href="#search-dsl-projection-id-mapping"><code>@IdProjection</code> in projections to custom types</a></li>
</ul>
</li>
<li><a href="#search-dsl-projection-entity">15.4.6. <code>entity</code>: return matched entities</a>
<ul class="sectlevel4">
<li><a href="#search-dsl-projection-entity-syntax">Syntax</a></li>
<li><a href="#search-dsl-projection-entity-requested-type">Requesting a specific entity type</a></li>
<li><a href="#search-dsl-projection-entity-mapping"><code>@EntityProjection</code> in projections to custom types</a></li>
</ul>
</li>
<li><a href="#search-dsl-projection-field">15.4.7. <code>field</code>: return field values from matched documents</a>
<ul class="sectlevel4">
<li><a href="#search-dsl-projection-field-syntax">Syntax</a></li>
<li><a href="#search-dsl-projection-field-multivalued">Multivalued fields</a></li>
<li><a href="#search-dsl-projection-field-skipping-conversion">Skipping conversion</a></li>
<li><a href="#search-dsl-projection-field-mapping"><code>@FieldProjection</code> in projections to custom types</a></li>
</ul>
</li>
<li><a href="#search-dsl-projection-score">15.4.8. <code>score</code>: return the score of matched documents</a>
<ul class="sectlevel4">
<li><a href="#search-dsl-projection-score-syntax">Syntax</a></li>
<li><a href="#search-dsl-projection-score-mapping"><code>@ScoreProjection</code> in projections to custom types</a></li>
</ul>
</li>
<li><a href="#search-dsl-projection-distance">15.4.9. <code>distance</code>: return the distance to a point</a>
<ul class="sectlevel4">
<li><a href="#search-dsl-projection-distance-syntax">Syntax</a></li>
<li><a href="#search-dsl-projection-distance-multivalued">Multivalued fields</a></li>
<li><a href="#search-dsl-projection-distance-mapping">In projections to custom types</a></li>
</ul>
</li>
<li><a href="#search-dsl-projection-composite">15.4.10. <code>composite</code>: combine projections</a>
<ul class="sectlevel4">
<li><a href="#search-dsl-projection-composite-basics">Basics</a></li>
<li><a href="#search-dsl-projection-composite-more-inners">Composing more than 3 inner projections</a></li>
<li><a href="#search-dsl-projection-composite-as-list">Projecting to a <code>List&lt;?&gt;</code> or <code>Object[]</code></a></li>
<li><a href="#search-dsl-projection-composite-as-mapped">Projecting to a custom (annotated) type</a></li>
<li><a href="#search-dsl-projection-composite-mapping"><code>@CompositeProjection</code> in projections to custom types</a></li>
<li><a href="#search-dsl-projection-composite-deprecated-variants">Deprecated variants</a></li>
</ul>
</li>
<li><a href="#search-dsl-projection-object">15.4.11. <code>object</code>: return one value per object in an object field</a>
<ul class="sectlevel4">
<li><a href="#search-dsl-projection-object-syntax">Syntax</a></li>
<li><a href="#search-dsl-projection-object-more-inners">Composing more than 3 inner projections</a></li>
<li><a href="#search-dsl-projection-object-as-list">Projecting to a <code>List&lt;?&gt;</code> or <code>Object[]</code></a></li>
<li><a href="#search-dsl-projection-object-as-mapped">Projecting to a custom (annotated) type</a></li>
<li><a href="#search-dsl-projection-object-mapping"><code>@ObjectProjection</code> in projections to custom types</a></li>
<li><a href="#search-dsl-projection-object-mapping-filters"><code>@ObjectProjection</code> filters to exclude nested projections and break <code>@ObjectProjection</code> cycles</a></li>
</ul>
</li>
<li><a href="#search-dsl-projection-constant">15.4.12. <code>constant</code>: return a provided constant</a>
<ul class="sectlevel4">
<li><a href="#search-dsl-projection-constant-syntax">Syntax</a></li>
<li><a href="#search-dsl-projection-constant-mapping">In projections to custom types</a></li>
</ul>
</li>
<li><a href="#search-dsl-projection-highlight">15.4.13. <code>highlight</code>: return highlighted field values from matched documents</a>
<ul class="sectlevel4">
<li><a href="#search-dsl-projection-highlight-syntax">Syntax</a></li>
<li><a href="#search-dsl-projection-highlight-multivalued">Multivalued fields</a></li>
<li><a href="#search-dsl-projection-highlight-options">Highlighting options</a></li>
<li><a href="#search-dsl-projection-highlight-mapping"><code>@HighlightProjection</code> in projections to custom types</a></li>
<li><a href="#search-dsl-projection-highlight-limitations">Highlight limitations</a></li>
</ul>
</li>
<li><a href="#search-dsl-projection-extensions">15.4.14. Backend-specific extensions</a>
<ul class="sectlevel4">
<li><a href="#search-dsl-projection-extensions-lucene-document">Lucene: <code>document</code></a></li>
<li><a href="#search-dsl-projection-extensions-lucene-explanation">Lucene: <code>explanation</code></a></li>
<li><a href="#search-dsl-projection-extensions-elasticsearch-source">Elasticsearch: <code>source</code></a></li>
<li><a href="#search-dsl-projection-extensions-elasticsearch-explanation">Elasticsearch: <code>explanation</code></a></li>
<li><a href="#search-dsl-projection-extensions-elasticsearch-jsonHit">Elasticsearch: <code>jsonHit</code></a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#search-dsl-highlighting">15.5. Highlight DSL</a>
<ul class="sectlevel3">
<li><a href="#search-dsl-highlighting-basics">15.5.1. Basics</a></li>
<li><a href="#search-dsl-highlighting-highlighter-type">15.5.2. Highlighter type</a></li>
<li><a href="#search-dsl-highlighting-highlighter-named-highlighters">15.5.3. Named highlighters</a></li>
<li><a href="#search-dsl-highlighting-highlighter-options">15.5.4.  Tags</a></li>
<li><a href="#search-dsl-highlighting-highlighter-options-encoder">15.5.5. Encoder</a></li>
<li><a href="#search-dsl-highlighting-highlighter-options-no-match-size">15.5.6. No match size</a></li>
<li><a href="#search-dsl-highlighting-highlighter-options-fragment-size">15.5.7. Fragment size and number of fragments</a></li>
<li><a href="#search-dsl-highlighting-highlighter-options-order">15.5.8. Order</a></li>
<li><a href="#search-dsl-highlighting-highlighter-options-fragmenter">15.5.9. Fragmenter</a></li>
<li><a href="#search-dsl-highlighting-highlighter-options-boundary-scanner">15.5.10. Boundary scanner</a></li>
<li><a href="#search-dsl-highlighting-highlighter-options-phrase-limit">15.5.11. Phrase limit</a></li>
</ul>
</li>
<li><a href="#search-dsl-aggregation">15.6.  Aggregation DSL</a>
<ul class="sectlevel3">
<li><a href="#search-dsl-aggregation-concepts">15.6.1. Basics</a></li>
<li><a href="#search-dsl-aggregation-terms">15.6.2.  <code>terms</code>: group by the value of a field</a>
<ul class="sectlevel4">
<li><a href="#search-dsl-aggregation-terms-skipping-conversion">Skipping conversion</a></li>
<li><a href="#search-dsl-aggregation-terms-maxtermcount"><code>maxTermCount</code>: limiting the number of returned entries</a></li>
<li><a href="#search-dsl-aggregation-terms-mindocumentcount"><code>minDocumentCount</code>: requiring at least N matching documents per term</a></li>
<li><a href="#search-dsl-aggregation-terms-order">Order of entries</a></li>
<li><a href="#search-dsl-aggregation-terms-other">Other options</a></li>
</ul>
</li>
<li><a href="#search-dsl-aggregation-range">15.6.3.  <code>range</code>: grouped by ranges of values for a field</a>
<ul class="sectlevel4">
<li><a href="#search-dsl-aggregation-range-range-argument"> Passing <code>Range</code> arguments</a></li>
<li><a href="#search-dsl-aggregation-range-skipping-conversion">Skipping conversion</a></li>
<li><a href="#search-dsl-aggregation-range-other">Other options</a></li>
</ul>
</li>
<li><a href="#search-dsl-aggregation-extensions">15.6.4. Backend-specific extensions</a>
<ul class="sectlevel4">
<li><a href="#search-dsl-aggregation-extensions-elasticsearch-from-json">Elasticsearch: <code>fromJson</code></a></li>
</ul>
</li>
<li><a href="#search-dsl-aggregation-common">15.6.5. Options common to multiple aggregation types</a>
<ul class="sectlevel4">
<li><a href="#search-dsl-aggregation-common-filter">Filter for fields in nested objects</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#search-dsl-type-compatibility">15.7. Field types and compatibility</a>
<ul class="sectlevel3">
<li><a href="#search-dsl-argument-type">15.7.1. Type of arguments passed to the DSL</a></li>
<li><a href="#search-dsl-projected-value-type">15.7.2. Type of projected values</a></li>
<li><a href="#search-dsl-multiple-fields">15.7.3. Targeting multiple fields</a>
<ul class="sectlevel4">
<li><a href="#search-dsl-multiple-fields-incompatible-codec"> Incompatible codec</a></li>
<li><a href="#search-dsl-multiple-fields-incompatible-dsl-converter"> Incompatible DSL converters</a></li>
<li><a href="#search-dsl-multiple-fields-incompatible-projection-converter"> Incompatible projection converters</a></li>
<li><a href="#search-dsl-multiple-fields-incompatible-analyzer"> Incompatible analyzer</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#search-dsl-paths">15.8. Field paths</a>
<ul class="sectlevel3">
<li><a href="#search-dsl-paths-absolute">15.8.1. Absolute field paths</a></li>
<li><a href="#search-dsl-paths-relative">15.8.2. Relative field paths</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#backend-lucene">16.  Lucene backend</a>
<ul class="sectlevel2">
<li><a href="#backend-lucene-configuration">16.1. Basic configuration</a></li>
<li><a href="#backend-lucene-configuration-directory">16.2.  Index storage (<code>Directory</code>)</a>
<ul class="sectlevel3">
<li><a href="#backend-lucene-configuration-directory-local-filesystem">16.2.1. Local filesystem storage</a>
<ul class="sectlevel4">
<li><a href="#backend-lucene-configuration-directory-local-filesystem-location">Index location</a></li>
<li><a href="#backend-lucene-configuration-directory-filesystem-access-strategy"> Filesystem access strategy</a></li>
<li><a href="#backend-lucene-configuration-directory-other">Other configuration options</a></li>
</ul>
</li>
<li><a href="#backend-lucene-configuration-directory-local-heap">16.2.2. Local heap storage</a></li>
<li><a href="#backend-lucene-configuration-directory-locking-strategy">16.2.3.  Locking strategy</a></li>
</ul>
</li>
<li><a href="#backend-lucene-configuration-sharding">16.3.  Sharding</a>
<ul class="sectlevel3">
<li><a href="#backend-lucene-configuration-sharding-basics">16.3.1. Basics</a></li>
<li><a href="#backend-lucene-configuration-sharding-configuration">16.3.2. Per-shard configuration</a></li>
</ul>
</li>
<li><a href="#backend-lucene-configuration-lucene-version">16.4.  Index format compatibility</a></li>
<li><a href="#backend-lucene-schema">16.5. Schema</a>
<ul class="sectlevel3">
<li><a href="#backend-lucene-field-types">16.5.1. Field types</a>
<ul class="sectlevel4">
<li><a href="#backend-lucene-field-types-available">Available field types</a></li>
<li><a href="#backend-lucene-field-types-extension">Index field type DSL extensions</a></li>
</ul>
</li>
<li><a href="#backend-lucene-multi-tenancy">16.5.2.  Multi-tenancy</a>
<ul class="sectlevel4">
<li><a href="#backend-lucene-multi-tenancy-none"><code>none</code>: single-tenancy</a></li>
<li><a href="#backend-lucene-multi-tenancy-discriminator"><code>discriminator</code>: type name mapping using the index name</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#backend-lucene-analysis">16.6. Analysis</a>
<ul class="sectlevel3">
<li><a href="#backend-lucene-analysis-basics">16.6.1. Basics</a></li>
<li><a href="#backend-lucene-analysis-builtin">16.6.2. Built-in analyzers</a></li>
<li><a href="#backend-lucene-analysis-builtin-normalizer">16.6.3. Built-in normalizers</a></li>
<li><a href="#backend-lucene-analysis-analyzers">16.6.4. Custom analyzers and normalizers</a>
<ul class="sectlevel4">
<li><a href="#backend-lucene-analysis-analyzers-component-by-factory-name">Referencing components by name</a></li>
<li><a href="#backend-lucene-analysis-analyzers-component-by-factory-class">Referencing components by factory class</a></li>
<li><a href="#backend-lucene-analysis-analyzers-instance">Assigning names to analyzer instances</a></li>
</ul>
</li>
<li><a href="#backend-lucene-analysis-analyzers-default">16.6.5. Overriding the default analyzer</a></li>
<li><a href="#backend-lucene-analysis-similarity">16.6.6.  Similarity</a></li>
</ul>
</li>
<li><a href="#backend-lucene-threads">16.7. Threads</a></li>
<li><a href="#backend-lucene-indexing-queues">16.8. Indexing queues</a></li>
<li><a href="#backend-lucene-io">16.9. Writing and reading</a>
<ul class="sectlevel3">
<li><a href="#backend-lucene-io-commit">16.9.1. Commit</a></li>
<li><a href="#backend-lucene-io-refresh">16.9.2. Refresh</a></li>
<li><a href="#backend-lucene-io-writer">16.9.3.  <code>IndexWriter</code> settings</a></li>
<li><a href="#backend-lucene-io-merge">16.9.4.  Merge settings</a></li>
</ul>
</li>
<li><a href="#backend-lucene-search">16.10. Searching</a>
<ul class="sectlevel3">
<li><a href="#backend-lucene-search-caching">16.10.1. Low-level hit caching</a></li>
</ul>
</li>
<li><a href="#backend-lucene-access-analyzers">16.11. Retrieving analyzers and normalizers</a></li>
<li><a href="#backend-lucene-access-size">16.12. Retrieving the index size</a></li>
<li><a href="#backend-lucene-access-index-reader">16.13.  Retrieving a Lucene <code>IndexReader</code></a></li>
</ul>
</li>
<li><a href="#backend-elasticsearch">17.  Elasticsearch backend</a>
<ul class="sectlevel2">
<li><a href="#backend-elasticsearch-compatibility">17.1. Compatibility</a>
<ul class="sectlevel3">
<li><a href="#backend-elasticsearch-compatibility-overview">17.1.1. Overview</a></li>
<li><a href="#backend-elasticsearch-compatibility-elasticsearch">17.1.2. Elasticsearch</a></li>
<li><a href="#backend-elasticsearch-compatibility-opensearch">17.1.3. OpenSearch</a></li>
<li><a href="#backend-elasticsearch-compatibility-amazon-opensearch-service">17.1.4. Amazon OpenSearch Service</a></li>
<li><a href="#backend-elasticsearch-compatibility-amazon-opensearch-serverless">17.1.5. Amazon OpenSearch Serverless (incubating)</a></li>
<li><a href="#backend-elasticsearch-upgrading">17.1.6.  Upgrading Elasticsearch</a></li>
</ul>
</li>
<li><a href="#backend-elasticsearch-configuration">17.2.  Basic configuration</a></li>
<li><a href="#backend-elasticsearch-configuration-elasticsearch-cluster">17.3.  Configuration of the Elasticsearch cluster</a></li>
<li><a href="#backend-elasticsearch-configuration-client">17.4. Client configuration</a>
<ul class="sectlevel3">
<li><a href="#backend-elasticsearch-configuration-hosts">17.4.1. Target hosts</a></li>
<li><a href="#backend-elasticsearch-configuration-path-prefix">17.4.2. Path prefix</a></li>
<li><a href="#backend-elasticsearch-configuration-discovery">17.4.3. Node discovery</a></li>
<li><a href="#backend-elasticsearch-authentication-http">17.4.4. HTTP authentication</a></li>
<li><a href="#backend-elasticsearch-configuration-aws">17.4.5.  Authentication on Amazon Web Services</a></li>
<li><a href="#backend-elasticsearch-configuration-connection-tuning">17.4.6.  Connection tuning</a></li>
<li><a href="#backend-elasticsearch-configuration-http-client">17.4.7.  Custom HTTP client configurations</a></li>
</ul>
</li>
<li><a href="#backend-elasticsearch-configuration-version">17.5.  Version compatibility</a>
<ul class="sectlevel3">
<li><a href="#backend-elasticsearch-configuration-version-check">17.5.1. Version assumed by Hibernate Search</a></li>
<li><a href="#backend-elasticsearch-configuration-version-check-disabling">17.5.2. Disabling the version check on startup</a></li>
</ul>
</li>
<li><a href="#backend-elasticsearch-configuration-logging">17.6.  Request logging</a></li>
<li><a href="#backend-elasticsearch-configuration-sharding">17.7. Sharding</a></li>
<li><a href="#backend-elasticsearch-schema-management">17.8.  Schema management</a></li>
<li><a href="#backend-elasticsearch-indexlayout">17.9. Index layout</a>
<ul class="sectlevel3">
<li><a href="#backend-elasticsearch-indexlayout-strategy-simple">17.9.1. <code>simple</code>: the default, future-proof strategy</a></li>
<li><a href="#backend-elasticsearch-indexlayout-strategy-no-alias">17.9.2. <code>no-alias</code>: a strategy without index aliases</a></li>
<li><a href="#backend-elasticsearch-indexlayout-strategy-custom">17.9.3. Custom strategy</a></li>
<li><a href="#backend-elasticsearch-indexlayout-metamodel">17.9.4. Retrieving index or alias names</a></li>
</ul>
</li>
<li><a href="#backend-elasticsearch-schema">17.10. Schema ("mapping")</a>
<ul class="sectlevel3">
<li><a href="#backend-elasticsearch-field-types">17.10.1. Field types</a>
<ul class="sectlevel4">
<li><a href="#backend-elasticsearch-field-types-available">Available field types</a></li>
<li><a href="#backend-elasticsearch-field-types-extension">Index field type DSL extension</a></li>
</ul>
</li>
<li><a href="#backend-elasticsearch-type-name">17.10.2. Entity type name mapping</a>
<ul class="sectlevel4">
<li><a href="#backend-elasticsearch-type-name-discriminator"><code>discriminator</code>: type name mapping using a discriminator field</a></li>
<li><a href="#backend-elasticsearch-type-name-index-name"><code>index-name</code>: type name mapping using the index name</a></li>
</ul>
</li>
<li><a href="#backend-elasticsearch-mapping-dynamic">17.10.3. Dynamic mapping</a></li>
<li><a href="#backend-elasticsearch-multi-tenancy">17.10.4. Multi-tenancy</a>
<ul class="sectlevel4">
<li><a href="#backend-elasticsearch-multi-tenancy-none"><code>none</code>: single-tenancy</a></li>
<li><a href="#backend-elasticsearch-multi-tenancy-discriminator"><code>discriminator</code>: type name mapping using the index name</a></li>
</ul>
</li>
<li><a href="#backend-elasticsearch-mapping-custom">17.10.5.  Custom index mapping</a>
<ul class="sectlevel4">
<li><a href="#backend-elasticsearch-mapping-custom-basics">Basics</a></li>
<li><a href="#backend-elasticsearch-mapping-custom-disabling-source"> Disabling <code>_source</code></a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#backend-elasticsearch-analysis">17.11.  Analysis</a>
<ul class="sectlevel3">
<li><a href="#backend-elasticsearch-analysis-basics">17.11.1. Basics</a></li>
<li><a href="#backend-elasticsearch-analysis-builtin">17.11.2. Built-in analyzers</a></li>
<li><a href="#backend-elasticsearch-analysis-builtin-normalizer">17.11.3. Built-in normalizers</a></li>
<li><a href="#backend-elasticsearch-analysis-analyzers">17.11.4. Custom analyzers and normalizers</a></li>
<li><a href="#backend-elasticsearch-analysis-analyzers-default">17.11.5. Overriding the default analyzer</a></li>
</ul>
</li>
<li><a href="#backend-elasticsearch-configuration-index-settings">17.12.  Custom index settings</a>
<ul class="sectlevel3">
<li><a href="#backend-elasticsearch-configuration-index-settings-max-result-window-size">17.12.1.  Max result window size</a></li>
</ul>
</li>
<li><a href="#backend-elasticsearch-threads">17.13. Threads</a></li>
<li><a href="#backend-elasticsearch-indexing-queues">17.14. Indexing queues</a></li>
<li><a href="#backend-elasticsearch-io">17.15. Writing and reading</a>
<ul class="sectlevel3">
<li><a href="#backend-elasticsearch-io-commit">17.15.1. Commit</a></li>
<li><a href="#backend-elasticsearch-io-refresh">17.15.2. Refresh</a></li>
</ul>
</li>
<li><a href="#backend-elasticsearch-search">17.16. Searching</a>
<ul class="sectlevel3">
<li><a href="#backend-elasticsearch-search-scroll-timeout">17.16.1. Scroll timeout</a></li>
<li><a href="#backend-elasticsearch-search-ignore-partial-shard-failure">17.16.2. Partial shard failure</a></li>
</ul>
</li>
<li><a href="#backend-elasticsearch-access-client">17.17.  Retrieving the REST client</a></li>
</ul>
</li>
<li><a href="#coordination">18. Coordination</a>
<ul class="sectlevel2">
<li><a href="#coordination-basics">18.1. Basics</a></li>
<li><a href="#coordination-none">18.2. No coordination</a>
<ul class="sectlevel3">
<li><a href="#coordination-none-basics">18.2.1. Basics</a></li>
<li><a href="#coordination-none-indexing">18.2.2. How indexing works without coordination</a></li>
</ul>
</li>
<li><a href="#coordination-outbox-polling">18.3.  <code>outbox-polling</code>: additional event tables and polling in background processors</a>
<ul class="sectlevel3">
<li><a href="#coordination-outbox-polling-basics">18.3.1.  Basics</a></li>
<li><a href="#coordination-outbox-polling-indexing">18.3.2.  How indexing works with <code>outbox-polling</code> coordination</a></li>
<li><a href="#coordination-outbox-polling-schema">18.3.3.  Impact on the database schema</a>
<ul class="sectlevel4">
<li><a href="#_basics">Basics</a></li>
<li><a href="#_custom_schematable_nameetc">Custom schema/table name/etc.</a></li>
</ul>
</li>
<li><a href="#coordination-outbox-polling-sharding">18.3.4.    Sharding and pulse</a></li>
<li><a href="#coordination-outbox-polling-event-processor">18.3.5.  Event processor</a>
<ul class="sectlevel4">
<li><a href="#coordination-outbox-polling-event-processor-basics">Basics</a></li>
<li><a href="#coordination-outbox-polling-event-processor-sharding">  Sharding</a></li>
<li><a href="#coordination-outbox-polling-event-processor-order">Processing order</a></li>
</ul>
</li>
<li><a href="#coordination-outbox-polling-mass-indexer">18.3.6. Mass indexer</a>
<ul class="sectlevel4">
<li><a href="#coordination-outbox-polling-mass-indexer-basics">Basics</a></li>
</ul>
</li>
<li><a href="#coordination-outbox-polling-multi-tenancy">18.3.7. Multi-tenancy</a></li>
<li><a href="#coordination-outbox-polling-aborted-events">18.3.8.  Aborted events</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#integrations">19. Standards and integrations</a>
<ul class="sectlevel2">
<li><a href="#other-integrations-jakarta">19.1. Jakarta EE</a></li>
<li><a href="#other-integrations-javaee">19.2. Java EE</a></li>
<li><a href="#other-integrations-orm6">19.3. Hibernate ORM 6</a></li>
<li><a href="#other-integrations-orm5">19.4. Hibernate ORM 5</a></li>
</ul>
</li>
<li><a href="#limitations">20.  Known issues and limitations</a>
<ul class="sectlevel2">
<li><a href="#limitations-parallel-embedded-update">20.1. Without coordination, in rare cases, indexing involving <code>@IndexedEmbedded</code> may lead to out-of sync indexes</a>
<ul class="sectlevel3">
<li><a href="#limitations-parallel-embedded-update-description">20.1.1. Description</a></li>
<li><a href="#limitations-parallel-embedded-update-solution">20.1.2. Solutions and workarounds</a></li>
<li><a href="#limitations-parallel-embedded-update-roadmap">20.1.3. Roadmap</a></li>
</ul>
</li>
<li><a href="#limitations-backend-indexing-error">20.2. Without coordination, backend errors during indexing may lead to out-of sync indexes</a>
<ul class="sectlevel3">
<li><a href="#limitations-backend-indexing-error-description">20.2.1. Description</a></li>
<li><a href="#limitations-backend-indexing-error-solution">20.2.2. Solutions and workarounds</a></li>
<li><a href="#limitations-backend-indexing-error-roadmap">20.2.3. Roadmap</a></li>
</ul>
</li>
<li><a href="#limitations-changes-in-session">20.3. Listener-triggered indexing only considers changes applied directly to entity instances in Hibernate ORM sessions</a>
<ul class="sectlevel3">
<li><a href="#limitations-changes-in-session-description">20.3.1. Description</a></li>
<li><a href="#limitations-changes-in-session-solution">20.3.2. Solutions and workarounds</a></li>
<li><a href="#limitations-changes-in-session-roadmap">20.3.3. Roadmap</a></li>
</ul>
</li>
<li><a href="#limitations-changes-asymmetric-association-updates">20.4.  Listener-triggered indexing ignores asymmetric association updates</a>
<ul class="sectlevel3">
<li><a href="#limitations-changes-asymmetric-association-updates-description">20.4.1. Description</a></li>
<li><a href="#limitations-changes-asymmetric-association-updates-solution">20.4.2. Solutions and workarounds</a></li>
<li><a href="#limitations-changes-asymmetric-association-updates-roadmap">20.4.3. Roadmap</a></li>
</ul>
</li>
<li><a href="#limitations-indexing-plan-serialization">20.5. Listener-triggered indexing is not compatible with <code>Session</code> serialization</a>
<ul class="sectlevel3">
<li><a href="#limitations-indexing-plan-serialization-description">20.5.1. Description</a></li>
<li><a href="#limitations-indexing-plan-serialization-solution">20.5.2. Solutions and workarounds</a></li>
<li><a href="#limitations-indexing-plan-serialization-roadmap">20.5.3. Roadmap</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#troubleshooting">21. Troubleshooting</a>
<ul class="sectlevel2">
<li><a href="#troubleshooting-under-the-hood">21.1. Finding out what is executed under the hood</a></li>
<li><a href="#troubleshooting-logging">21.2. Loggers</a></li>
<li><a href="#troubleshooting-faq">21.3. Frequently asked questions</a>
<ul class="sectlevel3">
<li><a href="#troubleshooting-faq-search-matches">21.3.1.  Unexpected or missing documents in search hits</a></li>
<li><a href="#troubleshooting-faq-search-score">21.3.2.  Unsatisfying order of search hits when sorting by score</a></li>
<li><a href="#troubleshooting-faq-search-time">21.3.3. Search query execution takes too long</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#further-reading">22.  Further reading</a>
<ul class="sectlevel2">
<li><a href="#further-reading-hibernate-search">22.1. Hibernate Search</a></li>
<li><a href="#further-reading-elasticsearch">22.2. Elasticsearch</a></li>
<li><a href="#further-reading-lucene">22.3. Lucene</a></li>
<li><a href="#further-reading-hibernate-orm">22.4.  Hibernate ORM</a></li>
<li><a href="#further-reading-other">22.5. Other</a></li>
</ul>
</li>
<li><a href="#credits">23. Credits</a></li>
<li><a href="#configuration-properties-aggregated">Appendix A: List of all available configuration properties</a>
<ul class="sectlevel2">
<li><a href="#configuration-properties-aggregated-hibernate-search-engine">A.1. Hibernate Search Engine</a></li>
<li><a href="#configuration-properties-aggregated-hibernate-search-backend-lucene">A.2. Hibernate Search Backend - Lucene</a></li>
<li><a href="#configuration-properties-aggregated-hibernate-search-backend-elasticsearch">A.3. Hibernate Search Backend - Elasticsearch</a></li>
<li><a href="#configuration-properties-aggregated-hibernate-search-backend-elasticsearch-aws">A.4. Hibernate Search Backend - Elasticsearch - AWS integration</a></li>
<li><a href="#configuration-properties-aggregated-hibernate-search-mapper-orm">A.5. Hibernate Search ORM Integration</a></li>
<li><a href="#configuration-properties-aggregated-hibernate-search-mapper-orm-outbox-polling">A.6. Hibernate Search ORM Integration - Coordination - Outbox Polling</a></li>
<li><a href="#configuration-properties-aggregated-hibernate-search-mapper-pojo-standalone">A.7. Hibernate Search Mapper - POJO Standalone</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="preface"><a class="anchor" href="#preface"></a>Preface</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Full text search engines like Apache Lucene are very powerful technologies to add efficient free
text search capabilities to applications. However, Lucene suffers several mismatches when dealing
with object domain models. Amongst other things indexes have to be kept up to date and mismatches
between index structure and domain model as well as query mismatches have to be avoided.</p>
</div>
<div class="paragraph">
<p>Hibernate Search addresses these shortcomings: it indexes your domain model with the help of a few
annotations, takes care of database/index synchronization and brings back regular managed objects
from free text queries.</p>
</div>
<div class="paragraph">
<p>To achieve this, Hibernate Search combines the power of
<a href="http://www.hibernate.org/orm">Hibernate ORM</a> and
<a href="https://lucene.apache.org">Apache Lucene</a>/<a href="https://www.elastic.co/elasticsearch">Elasticsearch</a>/<a href="https://www.opensearch.org">OpenSearch</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="compatibility"><a class="anchor" href="#compatibility"></a>1. <a id="getting-started-compatibility"></a> Compatibility</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="compatibility-dependencies"><a class="anchor" href="#compatibility-dependencies"></a>1.1. Dependencies</h3>
<table class="tableblock frame-all grid-all stripes-none stretch">
<caption class="title">Table 1. Compatible versions of dependencies</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<tbody>
<tr>
<th class="tableblock halign-left valign-top"></th>
<th class="tableblock halign-center valign-top"><p class="tableblock">Version</p></th>
<th class="tableblock halign-left valign-top"><p class="tableblock">Note</p></th>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">Java Runtime</p></th>
<td class="tableblock halign-center valign-top"><p class="tableblock">11, 17 or 21</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">Hibernate ORM (for the <a href="#mapper-orm">Hibernate ORM mapper</a></p></th>
<td class="tableblock halign-center valign-top"><p class="tableblock">6.4.10.Final/6.5.2.Final</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">Jakarta Persistence (for the <a href="#mapper-orm">Hibernate ORM mapper</a></p></th>
<td class="tableblock halign-center valign-top"><p class="tableblock">3.1</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">Apache Lucene (for the <a href="#backend-lucene">Lucene backend</a>)</p></th>
<td class="tableblock halign-center valign-top"><p class="tableblock">9.9.2</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">Elasticsearch server (for the <a href="#backend-elasticsearch">Elasticsearch backend</a>)</p></th>
<td class="tableblock halign-center valign-top"><p class="tableblock">7.10+ or 8.x</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Most of older minor versions (e.g. 7.11 or 8.0) are not given priority for bugfixes and new features.</p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">OpenSearch server (for the <a href="#backend-elasticsearch">Elasticsearch backend</a>)</p></th>
<td class="tableblock halign-center valign-top"><p class="tableblock">1.3 or 2.x</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Other minor versions may work
but are not given priority for bugfixes and new features.</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Find more information for all versions of Hibernate Search on our
<a href="https://hibernate.org/search/releases/#compatibility-matrix">compatibility matrix</a>.</p>
</div>
<div class="paragraph">
<p>The <a href="https://hibernate.org/community/compatibility-policy/">compatibility policy</a> may also be of interest.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you get Hibernate Search from Maven, it is recommended to import Hibernate Search BOM
as part of your dependency management to keep all its artifact versions aligned:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="XML"><span class="tag">&lt;dependencyManagement&gt;</span>
    <span class="tag">&lt;dependencies&gt;</span>
        <span class="comment">&lt;!--
            Import Hibernate Search BOM
            to get all of its artifact versions aligned:
        --&gt;</span>
        <span class="tag">&lt;dependency&gt;</span>
            <span class="tag">&lt;groupId&gt;</span>org.hibernate.search<span class="tag">&lt;/groupId&gt;</span>
            <span class="tag">&lt;artifactId&gt;</span>hibernate-search-bom<span class="tag">&lt;/artifactId&gt;</span>
            <span class="tag">&lt;version&gt;</span>7.1.2.Final<span class="tag">&lt;/version&gt;</span>
            <span class="tag">&lt;type&gt;</span>pom<span class="tag">&lt;/type&gt;</span>
            <span class="tag">&lt;scope&gt;</span>import<span class="tag">&lt;/scope&gt;</span>
        <span class="tag">&lt;/dependency&gt;</span>
        <span class="comment">&lt;!-- Any other dependency management entries --&gt;</span>
    <span class="tag">&lt;/dependencies&gt;</span>
<span class="tag">&lt;/dependencyManagement&gt;</span></code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Elasticsearch 7.11+ licensing</div>
<div class="paragraph">
<p>While Elasticsearch up to 7.10 was distributed under the Apache License 2.0,
be aware that Elasticsearch 7.11 and later are distributed under the Elastic License and the SSPL,
which are <a href="https://opensource.org/node/1099">not considered open-source by the Open Source Initiative</a>.</p>
</div>
<div class="paragraph">
<p>Only the low-level Java REST client, which Hibernate Search depends on, remains open-source.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">OpenSearch</div>
<div class="paragraph">
<p>While it historically targeted <a href="https://www.elastic.co/elasticsearch">Elastic&#8217;s Elasticsearch distribution</a>,
Hibernate Search is also compatible with <a href="https://www.opensearch.org">OpenSearch</a> and regularly tested against it;
see <a href="#backend-elasticsearch-compatibility">Compatibility</a> for more information.</p>
</div>
<div class="paragraph">
<p>Every section of this documentation referring to Elasticsearch
is also relevant for the OpenSearch distribution.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="compatibility-framework"><a class="anchor" href="#compatibility-framework"></a>1.2. <a id="gettingstarted-framework"></a> Framework support</h3>
<div class="sect3">
<h4 id="compatibility-framework-quarkus"><a class="anchor" href="#compatibility-framework-quarkus"></a>1.2.1. <a id="gettingstarted-framework-quarkus"></a> <a id="_quarkus"></a> Quarkus</h4>
<div class="paragraph">
<p><a href="https://quarkus.io/">Quarkus</a> has an official extension for <a href="#mapper-orm">Hibernate Search with Hibernate ORM</a>
using the <a href="#backend-elasticsearch">Elasticsearch backend</a>,
which is a tight integration with additional features, different dependencies, and different configuration properties.</p>
</div>
<div class="paragraph">
<p>As your first step to using Hibernate Search within Quarkus,
we recommend you follow Quarkus&#8217;s <a href="https://quarkus.io/guides/hibernate-search-orm-elasticsearch">Hibernate Search Guide</a>:
it is a great hands-on introduction to Hibernate Search,
<em>and</em> it covers the specifics of Quarkus.</p>
</div>
</div>
<div class="sect3">
<h4 id="compatibility-framework-wildfly"><a class="anchor" href="#compatibility-framework-wildfly"></a>1.2.2. WildFly</h4>
<div class="paragraph">
<p><a href="https://wildfly.org/">WildFly</a> includes modules for <a href="#mapper-orm">Hibernate Search with Hibernate ORM</a>
using either the <a href="#backend-lucene">Lucene backend</a> or the <a href="#backend-elasticsearch">Elasticsearch backend</a>.</p>
</div>
<div class="paragraph">
<p>To start using Hibernate Search within WildFly,
see the <a href="https://docs.wildfly.org/31/Developer_Guide.html#using-hibernate-search">Hibernate Search section in the WildFly Developer Guide</a>:
it covers all the specifics of WildFly.</p>
</div>
</div>
<div class="sect3">
<h4 id="compatibility-framework-spring-boot"><a class="anchor" href="#compatibility-framework-spring-boot"></a>1.2.3. <a id="gettingstarted-framework-spring-boot"></a> <a id="_spring_boot"></a> Spring Boot</h4>
<div class="paragraph">
<p>Hibernate Search can easily be integrated into a <a href="https://spring.io/projects/spring-boot">Spring Boot</a> application.
Just read about Spring Boot&#8217;s specifics below, then follow the <a href="../../../getting-started/orm/index/../en-US/html_single/index.html#mapper-orm-getting-started">getting started guide</a>.</p>
</div>
<div class="sect4">
<h5 id="compatibility-framework-spring-boot-configuration-properties"><a class="anchor" href="#compatibility-framework-spring-boot-configuration-properties"></a><a id="gettingstarted-framework-spring-boot-configuration-properties"></a> <a id="_configuration_properties"></a> Configuration properties</h5>
<div class="paragraph">
<p><code>application.properties</code>/<code>application.yaml</code> are Spring Boot configuration files,
not JPA or Hibernate Search configuration files.
Adding Hibernate Search properties starting with <code>hibernate.search.</code> directly in that file will not work.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">When <a href="#mapper-orm">integrating Hibernate Search with Hibernate ORM</a></dt>
<dd>
<p>Prefix your Hibernate Search properties with
<a href="https://docs.spring.io/spring-boot/docs/2.5.1/reference/html/application-properties.html#application-properties.data.spring.jpa.properties"><code>spring.jpa.properties.</code></a>,
so that Spring Boot passes along the properties to Hibernate ORM, which will pass them along to Hibernate Search.</p>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>spring.jpa.properties.hibernate.search.backend.hosts = elasticsearch.mycompany.com</code></pre>
</div>
</div>
</dd>
<dt class="hdlist1">When using the <a href="#mapper-pojo-standalone">Standalone POJO mapper</a></dt>
<dd>
<p>You can pass properties programmatically to <code>SearchMappingBuilder#property</code>.</p>
</dd>
</dl>
</div>
</div>
<div class="sect4">
<h5 id="compatibility-framework-spring-boot-dependency-versions"><a class="anchor" href="#compatibility-framework-spring-boot-dependency-versions"></a><a id="gettingstarted-framework-spring-boot-dependency-versions"></a> <a id="_dependency_versions"></a> Dependency versions</h5>
<div class="paragraph">
<p>Spring Boot automatically sets the version of dependencies without your knowledge.
While this is ordinarily a good thing, from time to time Spring Boot dependencies will be a little out of date.
Thus, it is recommended to override Spring Boot&#8217;s defaults at least for some key dependencies.</p>
</div>
<div class="paragraph">
<p>With Maven, there are a few ways to override these versions depending on how Spring is added to the application.
If your application&#8217;s POM file is using <code>spring-boot-starter-parent</code> as its parent POM
then simply adding version properties to your POM&#8217;s <code>&lt;properties&gt;</code> should help:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="XML"><span class="tag">&lt;properties&gt;</span>
    <span class="tag">&lt;hibernate.version&gt;</span>6.4.10.Final<span class="tag">&lt;/hibernate.version&gt;</span>
    <span class="tag">&lt;elasticsearch-client.version&gt;</span>8.12.2<span class="tag">&lt;/elasticsearch-client.version&gt;</span>
    <span class="comment">&lt;!-- ... plus any other properties of yours ... --&gt;</span>
<span class="tag">&lt;/properties&gt;</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If, after setting the properties above,
you still are getting the same version of the libraries,
check if property names in the Spring Boot&#8217;s BOM have changed, and if so use the new property name.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Alternatively, if either the <code>spring-boot-dependencies</code> or the <code>spring-boot-starter-parent</code> is imported into the dependency management (<code>&lt;dependencyManagement&gt;</code>)
then overriding the versions can be done either by importing a BOM listing the dependencies we want to override,
or by explicitly listing a dependency with its version that we want to be used:</p>
</div>
<div class="listingblock">
<div class="title">Override dependencies either with another BOM or explicitly</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="XML"><span class="tag">&lt;dependencyManagement&gt;</span>
    <span class="tag">&lt;dependencies&gt;</span>
        <span class="comment">&lt;!--
            Overriding Hibernate ORM version by importing the BOM.
            Alternatively, can be done by adding specific dependencies
            as shown below for Elasticsearch dependencies.
        --&gt;</span>
        <span class="tag">&lt;dependency&gt;</span>
            <span class="tag">&lt;groupId&gt;</span>org.hibernate.orm<span class="tag">&lt;/groupId&gt;</span>
            <span class="tag">&lt;artifactId&gt;</span>hibernate-platform<span class="tag">&lt;/artifactId&gt;</span>
            <span class="tag">&lt;version&gt;</span>${version.org.hibernate.orm}<span class="tag">&lt;/version&gt;</span>
            <span class="tag">&lt;type&gt;</span>pom<span class="tag">&lt;/type&gt;</span>
            <span class="tag">&lt;scope&gt;</span>import<span class="tag">&lt;/scope&gt;</span>
        <span class="tag">&lt;/dependency&gt;</span>
        <span class="tag">&lt;dependency&gt;</span>
            <span class="tag">&lt;groupId&gt;</span>org.springframework.boot<span class="tag">&lt;/groupId&gt;</span>
            <span class="tag">&lt;artifactId&gt;</span>spring-boot-dependencies<span class="tag">&lt;/artifactId&gt;</span>
            <span class="tag">&lt;version&gt;</span>3.3.0<span class="tag">&lt;/version&gt;</span>
            <span class="tag">&lt;type&gt;</span>pom<span class="tag">&lt;/type&gt;</span>
            <span class="tag">&lt;scope&gt;</span>import<span class="tag">&lt;/scope&gt;</span>
        <span class="tag">&lt;/dependency&gt;</span>
        <span class="comment">&lt;!--
            Since there is no BOM for the Elasticsearch REST client,
            these dependencies have to be listed explicitly:
        --&gt;</span>
        <span class="tag">&lt;dependency&gt;</span>
            <span class="tag">&lt;groupId&gt;</span>org.elasticsearch.client<span class="tag">&lt;/groupId&gt;</span>
            <span class="tag">&lt;artifactId&gt;</span>elasticsearch-rest-client<span class="tag">&lt;/artifactId&gt;</span>
            <span class="tag">&lt;version&gt;</span>8.12.2<span class="tag">&lt;/version&gt;</span>
        <span class="tag">&lt;/dependency&gt;</span>
        <span class="tag">&lt;dependency&gt;</span>
            <span class="tag">&lt;groupId&gt;</span>org.elasticsearch.client<span class="tag">&lt;/groupId&gt;</span>
            <span class="tag">&lt;artifactId&gt;</span>elasticsearch-rest-client-sniffer<span class="tag">&lt;/artifactId&gt;</span>
            <span class="tag">&lt;version&gt;</span>8.12.2<span class="tag">&lt;/version&gt;</span>
        <span class="tag">&lt;/dependency&gt;</span>
        <span class="comment">&lt;!-- Other dependency management entries --&gt;</span>
    <span class="tag">&lt;/dependencies&gt;</span>
<span class="tag">&lt;/dependencyManagement&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>For other build tools refer to their documentation for details.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Maven&#8217;s <code>dependency</code> plugin (or your build tool corresponding alternative)
can be used to verify that the version override was correctly applied, e.g.:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash"># Show the dependency tree filtering for Hibernate and Elasticsearch dependencies to reduce the output:
mvn dependency:tree &quot;-Dincludes=org.hibernate.*,org.elasticsearch.*&quot;</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If, after setting the properties above,
you still have problems (e.g. <code>NoClassDefFoundError</code>) with some of Hibernate Search&#8217;s dependencies,
look for the version of that dependency in
<a href="https://search.maven.org/artifact/org.springframework.boot/spring-boot-dependencies/3.3.0/pom">Spring Boot&#8217;s POM</a>
and <a href="https://search.maven.org/artifact/org.hibernate.search/hibernate-search-parent/7.1.2.Final/pom">Hibernate Search&#8217;s POM</a>:
there will probably be a mismatch,
and generally overriding Spring Boot&#8217;s version to match Hibernate Search&#8217;s version will work fine.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="compatibility-framework-spring-boot-application-hanging"><a class="anchor" href="#compatibility-framework-spring-boot-application-hanging"></a><a id="gettingstarted-framework-spring-boot-application-hanging"></a> <a id="_application_hanging_on_startup"></a> Application hanging on startup</h5>
<div class="paragraph">
<p>Spring Boot 2.3.x and above is affected by a bug that causes the application to hang on startup
when using Hibernate Search, particularly when using custom components (custom bridges, analysis configurers, &#8230;&#8203;).</p>
</div>
<div class="paragraph">
<p>The problem, which is not limited to just Hibernate Search,
<a href="https://github.com/spring-projects/spring-framework/issues/25111">has been reported</a>,
but hasn&#8217;t been fixed yet in Spring Boot 2.5.1.</p>
</div>
<div class="paragraph">
<p>As a workaround, you can set the property <code>spring.data.jpa.repositories.bootstrap-mode</code> to <code>deferred</code> or,
if that doesn&#8217;t work, <code>default</code>.
Interestingly, using <code>@EnableJpaRepositories(bootstrapMode = BootstrapMode.DEFERRED)</code> has been reported to work
even in situations where setting <code>spring.data.jpa.repositories.bootstrap-mode</code> to <code>deferred</code> didn&#8217;t work.</p>
</div>
<div class="paragraph">
<p>Alternatively, if you do not need dependency injection in your custom components,
you can refer to those components with the prefix <code>constructor:</code>
so that Hibernate Search doesn&#8217;t even try to use Spring to retrieve the components,
and thus avoids the deadlock in Spring.
See <a href="#configuration-bean-reference-parsing">this section</a> for more information.</p>
</div>
</div>
<div class="sect4">
<h5 id="compatibility-framework-spring-boot-elasticsearch-auto-configuration"><a class="anchor" href="#compatibility-framework-spring-boot-elasticsearch-auto-configuration"></a>Spring Boot&#8217;s Elasticsearch client and auto-configuration</h5>
<div class="paragraph">
<p>As you may know, Spring Boot includes "auto-configuration" that triggers as soon as a dependency is detected in the classpath.</p>
</div>
<div class="paragraph">
<p>This may lead to problems in some cases when dependencies are used by the application, but not through Spring Boot.</p>
</div>
<div class="paragraph">
<p>In particular, Hibernate Search transitively brings in a dependency to Elasticsearch&#8217;s low-level REST Client.
Spring Boot, through <a href="https://docs.spring.io/spring-boot/docs/3.3.0/api/org/springframework/boot/autoconfigure/elasticsearch/ElasticsearchRestClientAutoConfiguration.html"><code>ElasticsearchRestClientAutoConfiguration</code></a>,
will automatically set up an Elasticsearch REST client targeting (by default) <code><a href="http://localhost:9200" class="bare">http://localhost:9200</a></code>
as soon as it detects that dependency to the Elasticsearch REST Client JAR.</p>
</div>
<div class="paragraph">
<p>If your Elasticsearch cluster is not reachable at <code><a href="http://localhost:9200" class="bare">http://localhost:9200</a></code>,
this might lead to errors on startup.</p>
</div>
<div class="paragraph">
<p>To get rid of these errors, either
<a href="https://docs.spring.io/spring-boot/docs/3.3.0/reference/html/features.html#features.nosql.elasticsearch.connecting-using-rest">configure Spring&#8217;s Elasticsearch client manually</a>,
or <a href="https://www.baeldung.com/spring-data-disable-auto-config">disable this specific auto-configuration</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Spring Boot&#8217;s Elasticsearch client is completely separate from Hibernate Search:
the configuration of one won&#8217;t affect the other.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="compatibility-framework-other"><a class="anchor" href="#compatibility-framework-other"></a>1.2.4. <a id="gettingstarted-framework-other"></a> Other</h4>
<div class="paragraph">
<p>If your framework of choice is not mentioned in the previous sections, don&#8217;t worry:
Hibernate Search works just fine with plenty of other frameworks.</p>
</div>
<div class="paragraph">
<p>Just follow the <a href="../../../getting-started/orm/index/../en-US/html_single/index.html#mapper-orm-getting-started">getting started guide</a> to try it out.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="reference-getting-started"><a class="anchor" href="#reference-getting-started"></a>2. <a id="mapper-pojo-standalone-getting-started"></a> <a id="mapper-pojo-standalone-getting-started-assumptions"></a> <a id="mapper-pojo-standalone-getting-started-dependencies"></a> <a id="mapper-pojo-standalone-getting-started-configuration"></a> <a id="mapper-pojo-standalone-getting-started-mapping"></a> <a id="mapper-pojo-standalone-getting-started-initialization"></a> <a id="mapper-pojo-standalone-getting-started-initialization-schema-management"></a> <a id="mapper-pojo-standalone-getting-started-initialization-indexing"></a> <a id="mapper-pojo-standalone-getting-started-indexing"></a> <a id="mapper-pojo-standalone-getting-started-searching"></a> <a id="mapper-pojo-standalone-getting-started-analysis"></a> <a id="mapper-pojo-standalone-getting-started-whats-next"></a> <a id="mapper-orm-getting-started"></a> <a id="getting-started"></a> <a id="mapper-orm-getting-started-assumptions"></a> <a id="gettingstarted-architecture"></a> <a id="mapper-orm-getting-started-dependencies"></a> <a id="gettingstarted-dependencies"></a> <a id="mapper-orm-getting-started-configuration"></a> <a id="getting-started-configuration"></a> <a id="mapper-orm-getting-started-mapping"></a> <a id="getting-started-mapping"></a> <a id="mapper-orm-getting-started-initialization"></a> <a id="getting-started-initialization"></a> <a id="mapper-orm-getting-started-initialization-schema-management"></a> <a id="getting-started-initialization-schema-management"></a> <a id="_schema_management"></a> <a id="mapper-orm-getting-started-initialization-indexing"></a> <a id="getting-started-initialization-indexing"></a> <a id="_initial_indexing"></a> <a id="mapper-orm-getting-started-indexing"></a> <a id="getting-started-indexing"></a> <a id="mapper-orm-getting-started-searching"></a> <a id="getting-started-searching"></a> <a id="mapper-orm-getting-started-analysis"></a> <a id="getting-started-analysis"></a> <a id="mapper-orm-getting-started-whats-next"></a> <a id="getting-started-whats-next"></a> <a id="_whats_next"></a> Getting started with Hibernate Search</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To get started with Hibernate Search, check out the following guides:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If your entities <strong>are</strong> defined in Hibernate ORM,
see <a href="../../../getting-started/orm/index/../en-US/html_single/index.html#mapper-orm-getting-started">Getting started with Hibernate Search in Hibernate ORM</a>.</p>
</li>
<li>
<p>If your entities are <strong>not</strong> defined in Hibernate ORM,
see <a href="../../../getting-started/standalone/index/../en-US/html_single/index.html#mapper-pojo-standalone-getting-started">Getting started with Hibernate Search&#8217;s Standalone POJO Mapper</a> instead.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="migrating"><a class="anchor" href="#migrating"></a>3. <a id="getting-started-migrating"></a> Migrating</h2>
<div class="sectionbody">
<div class="paragraph">
<p>If you are upgrading an existing application from an earlier version of Hibernate Search to the latest release,
make sure to check out the <a href="http://hibernate.org/search/documentation/migrate/">migration guide</a>.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p><strong>To Hibernate Search 5 users</strong></p>
</div>
<div class="paragraph">
<p>If you pull our artifacts from a Maven repository, and you come from Hibernate Search 5,
be aware that just bumping the version number will not be enough.</p>
</div>
<div class="paragraph">
<p>In particular, the group IDs changed from <code>org.hibernate</code> to <code>org.hibernate.search</code>,
most of the artifact IDs changed to reflect the new mapper/backend design,
and the Lucene integration now requires an explicit dependency instead of being available by default.
Read <a href="../../../getting-started/orm/index/../en-US/html_single/index.html#mapper-orm-getting-started-dependencies">Dependencies</a> for more information.</p>
</div>
<div class="paragraph">
<p>Additionally, be aware that a lot of APIs have changed, some only because of a package change,
others because of more fundamental changes
(like moving away from using Lucene types in Hibernate Search APIs).
For that reason, you are encouraged to migrate first to Hibernate Search 6.0
using the <a href="https://docs.jboss.org/hibernate/search/6.0/migration/html_single/">6.0 migration guide</a>,
and only then to later versions (which will be significantly easier).</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="concepts"><a class="anchor" href="#concepts"></a>4. <a id="_concepts"></a> Concepts</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="concepts-full-text"><a class="anchor" href="#concepts-full-text"></a>4.1. Full-text search</h3>
<div class="paragraph">
<p>Full-text search is a set of techniques for searching,
in a corpus of text documents,
the documents that best match a given query.</p>
</div>
<div class="paragraph">
<p>The main difference with traditional search&#8201;&#8212;&#8201;for example in an SQL database&#8201;&#8212;&#8201;is that the stored text is not considered as a single block of text,
but as a collection of tokens (words).</p>
</div>
<div class="paragraph">
<p>Hibernate Search relies on either <a href="http://lucene.apache.org/">Apache Lucene</a>
or <a href="https://www.elastic.co/products/elasticsearch">Elasticsearch</a>
to implement full-text search.
Since Elasticsearch uses Lucene internally,
they share a lot of characteristics and their general approach to full-text search.</p>
</div>
<div class="paragraph">
<p>To simplify, these search engines are based on the concept of inverted indexes:
a dictionary where the key is a token (word) found in a document,
and the value is the list of identifiers of every document containing this token.</p>
</div>
<div class="paragraph">
<p>Still simplifying, once all documents are indexed,
searching for documents involves three steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>extracting tokens (words) from the query;</p>
</li>
<li>
<p>looking up these tokens in the index to find matching documents;</p>
</li>
<li>
<p>aggregating the results of the lookups to produce a list of matching documents.</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Lucene and Elasticsearch are not limited to just text search: numeric data is also supported,
enabling support for integers, doubles, longs, dates, etc.
These types are indexed and queried using a slightly different approach,
which obviously does not involve text processing.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="concepts-entity"><a class="anchor" href="#concepts-entity"></a>4.2. Entity types</h3>
<div class="paragraph">
<p>When it comes to the domain model of applications,
Hibernate Search distinguishes between types (Java classes) that are considered entities,
and those that are not.</p>
</div>
<div class="paragraph">
<p>The defining characteristic of entity types in Hibernate Search
is that their instances have a distinct lifecycle:
an entity instance may be saved into a datastore, or retrieved from it,
without requiring the saving or retrieval of an instance of another type.
For that purpose,
each entity instance is assumed to carry an immutable, unique identifier.</p>
</div>
<div class="paragraph">
<p>These characteristics allow Hibernate Search to <a href="#concepts-mapping">map</a>
entity types to indexes, but only entity types.
"Embeddable" types that are referenced from or contained within an entity,
but whose lifecycle is completely tied to that entity,
cannot be mapped to an index.</p>
</div>
<div class="paragraph">
<p>Multiple aspects of Hibernate Search involve the concept of entity types:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Each entity type has an <a href="#mapping-entitydefinition-name">entity name</a>, distinct from the type name.
E.g. for a class named <code>com.acme.Book</code>, the entity name could be <code>Book</code> (the default),
or any arbitrarily chosen string.</p>
</li>
<li>
<p>Properties pointing to an entity type (called <em>associations</em>) have specific mechanics;
in particular, in order to handle <a href="#mapping-reindexing-basics">reindexing</a>,
Hibernate Search needs to <a href="#mapping-reindexing-associationinverseside">know about the inverse side of associations</a>.</p>
</li>
<li>
<p>For the purposes of change tracking when <a href="#mapping-reindexing-basics">reindexing</a>,
(e.g. in <a href="#indexing-plan">indexing plans</a>),
entity types represent the smallest scope Hibernate Search considers.</p>
<div class="paragraph">
<p>This means the paths representing "changed properties" in Hibernate Search
always have an entity as their starting point,
and the components within these paths never reach into another entity
(but may point to one, when an <em>association</em> changes.</p>
</div>
</li>
<li>
<p>Hibernate Search may need additional configuration to enable loading of entity types from an external datastore,
be it to <a href="#mapping-entitydefinition-loading-selection">load entities matching a query from an external source</a>
or to <a href="#mapping-entitydefinition-loading-mass">load all entity instances from an external source for full reindexing</a>.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="concepts-mapping"><a class="anchor" href="#concepts-mapping"></a>4.3. Mapping</h3>
<div class="paragraph">
<p>Applications targeted by Hibernate search use an <a href="#concepts-entity">entity</a>-based model to represent data.
In this model, each entity is a single object with a few properties of atomic type
(<code>String</code>, <code>Integer</code>, <code>LocalDate</code>, &#8230;&#8203;).
Each entity can contain non-root aggregates ("embeddable" types),
and each can also have multiple associations to one or even many other entities.</p>
</div>
<div class="paragraph">
<p>By contrast, Lucene and Elasticsearch work with documents.
Each document is a collection of "fields",
each field being assigned a name&#8201;&#8212;&#8201;a unique string&#8201;&#8212;&#8201;and a value&#8201;&#8212;&#8201;which can be text, but also numeric data such as an integer or a date.
Fields also have a type, which not only determines the type of values (text/numeric),
but more importantly the way this value will be stored: indexed, stored, with doc values, etc.
Each document can contain nested aggregates ("objects"/"nested documents"),
but there cannot really be associations between top-level documents.</p>
</div>
<div class="paragraph">
<p>Thus:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Entities are organized as a graph,
where each node is an entity and each association is an edge.</p>
</li>
<li>
<p>Documents are organized, at best, as a collection of trees,
where each tree is a document, optionally with nested documents.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>There are multiple mismatches between the entity model and the document model:
simple property types vs. more complex field types,
associations vs. no associations,
graph vs. collection of trees.</p>
</div>
<div class="paragraph">
<p>The goal of <em>mapping</em>, in Hibernate search, is to resolve these mismatches
by defining how to transform one or more entities into a document,
and how to resolve a search hit back into the original entity.
This is the main added value of Hibernate Search,
the basis for everything else from <a href="#architecture-hsearch-indexing">indexing</a> to the various search DSLs.</p>
</div>
<div class="paragraph">
<p>Mapping is usually configured using annotations in the entity model,
but this can also be achieved using a programmatic API.
To learn more about how to configure mapping, see <a href="#mapping">  Mapping entities to indexes</a>.</p>
</div>
<div class="paragraph">
<p>To learn how to index the resulting documents, see <a href="#indexing"> Indexing entities</a>
(hint: for the <a href="#mapper-orm">Hibernate ORM integration</a>, it&#8217;s <a href="#listener-triggered-indexing">automatic</a>).</p>
</div>
<div class="paragraph">
<p>To learn how to search with an API
that takes advantage of the mapping to be closer to the entity model,
in particular by returning hits as entities instead of just document identifiers,
see <a href="#search-dsl"> Searching</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="concepts-binding"><a class="anchor" href="#concepts-binding"></a>4.4. Binding</h3>
<div class="paragraph">
<p>While the <a href="#concepts-mapping">mapping</a> definition is declarative,
these declarations need to be interpreted and actually applied to the domain model.</p>
</div>
<div class="paragraph">
<p>That&#8217;s what Hibernate Search calls "binding":
during startup, a given mapping instruction (e.g. <code>@GenericField</code>) will result in a "binder"
being instantiated and called, giving it an opportunity to inspect the part of the domain model it&#8217;s applied to
and to "bind" (assign) a component to that part of the model&#8201;&#8212;&#8201;for example a "bridge",
responsible for extracting data from an entity during indexing.</p>
</div>
<div class="paragraph">
<p>Hibernate Search comes with binders and bridges for many common use cases,
and also provides the ability to plug in custom binders and bridges.</p>
</div>
<div class="paragraph">
<p>For more information, in particular on how to plug in custom binders and bridges,
see <a href="#binding">  Binding and bridges</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="concepts-analysis"><a class="anchor" href="#concepts-analysis"></a>4.5. <a id="analyzer"></a> Analysis</h3>
<div class="paragraph">
<p>As mentioned in <a href="#concepts-full-text">Full-text search</a>,
the full-text engine works on tokens,
which means text has to be processed
both when indexing (document processing, to build the token &#8594; document index)
and when searching (query processing, to generate a list of tokens to look up).</p>
</div>
<div class="paragraph">
<p>However, the processing is not <strong>just</strong> about "tokenizing".
Index lookups are <strong>exact</strong> lookups,
which means that looking up <code>Great</code> (capitalized) will not return documents containing only <code>great</code> (all lowercase).
An extra step is performed when processing text to address this caveat:
token filtering, which normalizes tokens.
Thanks to that "normalization",
<code>Great</code> will be indexed as <code>great</code>,
so that an index lookup for the query <code>great</code> will match as expected.</p>
</div>
<div class="paragraph">
<p>In the Lucene world (Lucene, Elasticsearch, Solr, &#8230;&#8203;),
text processing during both the indexing and searching phases
is called "analysis" and is performed by an "analyzer".</p>
</div>
<div class="paragraph">
<p>The analyzer is made up of three types of components,
which will each process the text successively in the following order:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Character filter: transforms the input characters. Replaces, adds or removes characters.</p>
</li>
<li>
<p>Tokenizer: splits the text into several words, called "tokens".</p>
</li>
<li>
<p>Token filter: transforms the tokens. Replaces, add or removes characters in a token,
derives new tokens from the existing ones, removes tokens based on some condition, &#8230;&#8203;</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The tokenizer usually splits on whitespaces (though there are other options).
Token filters are usually where customization takes place.
They can remove accented characters,
remove meaningless suffixes (<code>-ing</code>, <code>-s</code>, &#8230;&#8203;)
or tokens (<code>a</code>, <code>the</code>, &#8230;&#8203;),
replace tokens with a chosen spelling (<code>wi-fi</code> &#8658; <code>wifi</code>),
etc.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Character filters, though useful, are rarely used,
because they have no knowledge of token boundaries.</p>
</div>
<div class="paragraph">
<p>Unless you know what you are doing,
you should generally favor token filters.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In some cases, it is necessary to index text in one block,
without any tokenization:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>For some types of text, such as SKUs or other business codes,
tokenization simply does not make sense: the text is a single "keyword".</p>
</li>
<li>
<p>For sorts by field value, tokenization is not necessary.
It is also forbidden in Hibernate Search due to performance issues;
only non-tokenized fields can be sorted on.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To address these use cases,
a special type of analyzer, called "normalizer", is available.
Normalizers are simply analyzers that are guaranteed not to use a tokenizer:
they can only use character filters and token filters.</p>
</div>
<div class="paragraph">
<p>In Hibernate Search, analyzers and normalizers are referenced by their name,
for example <a href="#mapping-directfieldmapping-analyzer">when defining a full-text field</a>.
Analyzers and normalizers have two separate namespaces.</p>
</div>
<div class="paragraph">
<p>Some names are already assigned to built-in analyzers (in Elasticsearch in particular),
but it is possible (and recommended) to assign names to custom analyzers and normalizers,
assembled using built-in components (tokenizers, filters) to address your specific needs.</p>
</div>
<div class="paragraph">
<p>Each backend exposes its own APIs to define analyzers and normalizers,
and generally to configure analysis.
See the documentation of each backend for more information:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#backend-lucene-analysis">Analysis for the Lucene backend</a></p>
</li>
<li>
<p><a href="#backend-elasticsearch-analysis">Analysis for the Elasticsearch backend</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="concepts-commit-refresh"><a class="anchor" href="#concepts-commit-refresh"></a>4.6. Commit and refresh</h3>
<div class="paragraph">
<p>In order to get the best throughput when indexing and when searching,
both Elasticsearch and Lucene rely on "buffers" when writing to and reading from the index:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>When writing, changes are not <em>directly</em> written to the index,
but to an "index writer" that buffers changes in-memory or in temporary files.</p>
<div class="paragraph">
<p>The changes are "pushed" to the actual index when the writer is <em>committed</em>.
Until the commit happens, uncommitted changes are in an "unsafe" state:
if the application crashes or if the server suffers from a power loss,
uncommitted changes will be lost.</p>
</div>
</li>
<li>
<p>When reading, e.g. when executing a search query,
data is not read <em>directly</em> from the index,
but from an "index reader" that exposes a view of the index as it was at some point in the past.</p>
<div class="paragraph">
<p>The view is updated when the reader is <em>refreshed</em>.
Until the refresh happens, results of search queries might be slightly out of date:
documents added since the last refresh will be missing,
documents delete since the last refresh will still be there, etc.</p>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Unsafe changes and out-of-sync indexes are obviously undesirable,
but they are a trade-off that improves performance.</p>
</div>
<div class="paragraph">
<p>Different factors influence when refreshes and commit happen:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#listener-triggered-indexing">Listener-triggered indexing</a> and <a href="#indexing-plan">explicit indexing</a> will, by default,
require that a commit of the index writer is performed after each set of changes,
meaning the changes are safe after the Hibernate ORM transaction commit returns (for the <a href="#mapper-orm">Hibernate ORM integration</a>)
or the <code>SearchSession</code>'s <code>close()</code> method returns (for the <a href="#mapper-pojo-standalone">Standalone POJO Mapper</a>).
However, no refresh is requested by default, meaning the changes may only be visible at a later time,
when the backend decides to refresh the index reader.
This behavior can be customized by setting a different <a href="#indexing-plan-synchronization">synchronization strategy</a>.</p>
</li>
<li>
<p>The <a href="#indexing-massindexer">mass indexer</a>
will not require any commit or refresh until the very end of mass indexing,
to maximize indexing throughput.</p>
</li>
<li>
<p>Whenever there are no particular commit or refresh requirements,
backend defaults will apply:</p>
<div class="ulist">
<ul>
<li>
<p>See <a href="#backend-elasticsearch-io">here for Elasticsearch</a>.</p>
</li>
<li>
<p>See <a href="#backend-lucene-io">here for Lucene</a>.</p>
</li>
</ul>
</div>
</li>
<li>
<p>A commit may be forced explicitly through the <a href="#indexing-workspace-flush"><code>flush()</code> API</a>.</p>
</li>
<li>
<p>A refresh may be forced explicitly though the <a href="#indexing-workspace-flush"><code>refresh()</code> API</a>.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Even though we use the word "commit",
this is not the same concept as a commit in relational database transactions:
there is no transaction and no "rollback" is possible.</p>
</div>
<div class="paragraph">
<p>There is no concept of isolation, either.
After a refresh, <strong>all</strong> changes to the index are taken into account:
those committed to the index, but also those that are still buffered in the index writer.</p>
</div>
<div class="paragraph">
<p>For this reason, commits and refreshes can be treated as completely orthogonal concepts:
certain setups will occasionally lead to committed changes not being visible in search queries,
while others will allow even uncommitted changes to be visible in search queries.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="concepts-sharding-routing"><a class="anchor" href="#concepts-sharding-routing"></a>4.7. Sharding and routing</h3>
<div class="paragraph">
<p>Sharding consists in splitting index data into multiple "smaller indexes", called shards,
in order to improve performance when dealing with large amounts of data.</p>
</div>
<div class="paragraph">
<p>In Hibernate Search, similarly to Elasticsearch,
another concept is closely related to sharding: routing.
Routing consists in resolving a document identifier,
or generally any string called a "routing key",
into the corresponding shard.</p>
</div>
<div class="paragraph">
<p>When indexing:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A document identifier and optionally a routing key
are generated from the indexed entity.</p>
</li>
<li>
<p>The document, along with its identifier and optionally its routing key,
is passed to the backend.</p>
</li>
<li>
<p>The backend "routes" the document to the correct shard,
and adds the routing key (if any) to a special field in the document (so that it&#8217;s indexed).</p>
</li>
<li>
<p>The document is indexed in that shard.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>When searching:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The search query can optionally be passed one or more routing keys.</p>
</li>
<li>
<p>If no routing key is passed,
the query will be executed on all shards.</p>
</li>
<li>
<p>If one or more routing keys are passed:</p>
<div class="ulist">
<ul>
<li>
<p>The backend resolves these routing keys into a set of shards,
and the query will only be executed on all shards,
ignoring the other shards.</p>
</li>
<li>
<p>A filter is added to the query so that only documents indexed with
one of the given routing keys are matched.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Sharding, then, can be leveraged to boost performance in two ways:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>When indexing: a sharded index can spread the "stress" onto multiple shards,
which can be located on different disks (Lucene)
or different servers (Elasticsearch).</p>
</li>
<li>
<p>When searching: if one property, let&#8217;s call it <code>category</code>,
is often used to select a subset of documents,
this property can be <a href="#binding-routingbridge-routingkey">defined as a routing key in the mapping</a>,
so that it&#8217;s used to route documents instead of the document ID.
As a result, documents with the same value for <code>category</code> will be indexed in the same shard.
Then when searching, if a query already filters documents so that it is known that the hits
will all have the same value for <code>category</code>,
the query can be manually <a href="#search-dsl-query-routing">routed to the shards containing documents with this value</a>,
<strong>and the other shards can be ignored</strong>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To enable sharding, some configuration is required:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The backends require explicit configuration:
see <a href="#backend-lucene-configuration-sharding">here for Lucene</a>
and <a href="#backend-elasticsearch-configuration-sharding">here for Elasticsearch</a>.</p>
</li>
<li>
<p>In most cases, document IDs are used to route documents to shards by default.
This does not allow taking advantage of routing when searching,
which requires multiple documents to share the same routing key.
Applying routing to a search query in that case will return at most one result.
To explicitly define the routing key to assign to each document,
assign <a href="#binding-routingbridge-routingkey">routing bridges</a> to your entities.</p>
</li>
</ul>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Sharding is static by nature: each index is expected to have the same shards, with the same identifiers,
from one boot to the other.
Changing the number of shards or their identifiers will require full reindexing.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="architecture"><a class="anchor" href="#architecture"></a>5. <a id="search-architecture"></a> Architecture</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="architecture-hsearch-components"><a class="anchor" href="#architecture-hsearch-components"></a>5.1. <a id="_overview"></a> Components of Hibernate Search</h3>
<div class="paragraph">
<p>From the user&#8217;s perspective, Hibernate Search consists of two components:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><a id="architecture-hsearch-components-mapper"></a>Mapper</dt>
<dd>
<p>The mapper "maps" the user model to an index model,
and provide APIs consistent with the user model to perform indexing and searching.</p>
<div class="paragraph">
<p>Most applications rely on the <a href="#mapper-orm">Hibernate ORM mapper</a>,
which offers the ability to index properties of Hibernate ORM entities,
but there is also a <a href="#mapper-pojo-standalone">Standalone POJO mapper</a>
that can be used without Hibernate ORM.</p>
</div>
<div class="paragraph">
<p>The mapper is configured partly through annotations on the domain model,
and partly through configuration properties.</p>
</div>
</dd>
<dt class="hdlist1"><a id="architecture-hsearch-components-backend"></a>Backend</dt>
<dd>
<p>The backend is the abstraction over the full-text engines, where "things get done".
It implements generic indexing and searching interfaces for use by the mapper
through "index managers", each providing access to one index.</p>
<div class="paragraph">
<p>For instance the <a href="#backend-lucene">Lucene backend</a> delegates to the Lucene library,
and the <a href="#backend-elasticsearch">Elasticsearch backend</a> delegates to a remote Elasticsearch cluster.</p>
</div>
<div class="paragraph">
<p>The backend is configured partly by the mapper,
which tells the backend which indexes must exist and what fields they must have,
and partly through configuration properties.</p>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>The mapper and the backend work together to provide three main features:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Mass indexing</dt>
<dd>
<p>This is how Hibernate Search rebuilds indexes from zero based on the content of a database.</p>
<div class="paragraph">
<p>The mapper queries the database to retrieve the identifier of every entity,
then processes these identifiers in batches,
loading the entities then processing them to generate documents that are sent to the backend for indexing.
The backend puts the document in an internal queue, and will index documents in batches, in background processes,
notifying the mapper when it&#8217;s done.</p>
</div>
<div class="paragraph">
<p>See <a href="#indexing-massindexer">  Indexing a large amount of data with the <code>MassIndexer</code></a> for details.</p>
</div>
</dd>
<dt class="hdlist1"><a id="architecture-hsearch-indexing"></a>Explicit and listener-triggered indexing</dt>
<dd>
<p>Explicit and listener-triggered indexing rely on indexing plans (<code>SearchIndexingPlan</code>)
to index specific entities as a result of limited changes.</p>
<div class="paragraph">
<p>With <a href="#manual-index-changes">explicit indexing</a>,
the caller explicitly passes information about changes on entities to an <a href="#indexing-plan">indexing plan</a>;
with <a href="#listener-triggered-indexing">listener-triggered indexing</a>,
entity changes are detected transparently by <a href="#mapper-orm">the Hibernate ORM integration</a>
(with <a href="#listener-triggered-indexing-possible-limitations">a few exceptions</a>)
and added to the indexing plan automatically.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Listener-triggered indexing only makes sense in the context of <a href="#mapper-orm">the Hibernate ORM integration</a>;
there is <a href="#mapper-pojo-standalone-indexing-listener-triggered">no such feature available for the Standalone POJO Mapper</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In both cases, the <a href="#indexing-plan">indexing plan</a> will deduce from those changes
whether entities need to be reindexed, be it the changed entity itself
or <a href="#mapping-indexedembedded">other entities that embed the changed entity in their index</a>.</p>
</div>
<div class="paragraph">
<p>Upon transaction commit, changes in the indexing plan are processed (either in the same thread or in a background process,
depending on the <a href="#coordination">coordination strategy</a>),
and documents are generated, then sent to the backend for indexing.
The backend puts the documents in an internal queue, and will index documents in batches, in background processes,
notifying the mapper when it&#8217;s done.</p>
</div>
<div class="paragraph">
<p>See <a href="#listener-triggered-indexing">   Implicit, listener-triggered indexing</a> for details.</p>
</div>
</dd>
<dt class="hdlist1">Searching</dt>
<dd>
<p>This is how Hibernate Search provides ways to query an index.</p>
<div class="paragraph">
<p>The mapper exposes entry points to the search DSL, allowing selection of entity types to query.
When one or more entity types are selected,
the mapper delegates to the corresponding index managers to provide a Search DSL
and ultimately create the search query.
Upon query execution, the backend submits a list of entity references to the mapper,
which loads the corresponding entities.
The entities are then returned by the query.</p>
</div>
<div class="paragraph">
<p>See <a href="#search-dsl"> Searching</a> for details.</p>
</div>
</dd>
</dl>
</div>
</div>
<div class="sect2">
<h3 id="architecture-examples"><a class="anchor" href="#architecture-examples"></a>5.2. <a id="_backend"></a> Examples of architectures</h3>
<div class="sect3">
<h4 id="architecture-examples-overview"><a class="anchor" href="#architecture-examples-overview"></a>5.2.1. Overview</h4>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 2. Comparison of architectures</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Architecture</th>
<th class="tableblock halign-center valign-top"><a href="#architecture-examples-single-node-lucene">Single-node with Lucene</a></th>
<th class="tableblock halign-center valign-top"><a href="#architecture-examples-no-coordination-elasticsearch">No coordination with Elasticsearch</a></th>
<th class="tableblock halign-center valign-top"><a href="#architecture-examples-outbox-polling-elasticsearch">Outbox polling with Elasticsearch</a></th>
</tr>
</thead>
<tbody>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">Compatible <a href="#architecture-hsearch-components-mapper">mappers</a></p></th>
<td class="tableblock halign-center valign-top" colspan="2"><p class="tableblock">Both <a href="#mapper-orm">Hibernate ORM integration</a> and <a href="#mapper-pojo-standalone">Standalone POJO Mapper</a></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><a href="#mapper-orm">Hibernate ORM integration</a> only</p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">Application topology</p></th>
<td class="tableblock halign-center valign-top"><p class="tableblock">Single-node</p></td>
<td class="tableblock halign-center valign-top" colspan="2"><p class="tableblock">Single-node or multi-node</p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">Extra bits to maintain</p></th>
<td class="tableblock halign-center valign-top"><p class="tableblock">Indexes on filesystem</p></td>
<td class="tableblock halign-center valign-top" colspan="2"><p class="tableblock">Elasticsearch cluster</p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">Guarantee of index updates</p></th>
<td class="tableblock halign-center valign-top" colspan="2"><p class="tableblock"><a href="#coordination-none-indexing-guarantee">Non-transactional, after the database transaction / <code>SearchSession.close()</code> returns</a></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><a href="#coordination-outbox-polling-indexing-guarantee">Transactional, on database transaction commit</a></p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">Visibility of index updates</p></th>
<td class="tableblock halign-center valign-top"><p class="tableblock"><a href="#coordination-none-indexing-visibility">Configurable: immediate or eventual</a></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><a href="#coordination-none-indexing-visibility">Configurable: immediate (poor performance) or eventual</a></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><a href="#coordination-outbox-polling-indexing-visibility">Eventual</a></p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">Native features</p></th>
<td class="tableblock halign-center valign-top"><p class="tableblock">Mostly for experts</p></td>
<td class="tableblock halign-center valign-top" colspan="2"><p class="tableblock">For anyone</p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">Overhead for application threads</p></th>
<td class="tableblock halign-center valign-top" colspan="2"><p class="tableblock"><a href="#coordination-none-indexing-on-flush">Low to medium</a></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><a href="#coordination-outbox-polling-indexing-background">Very low</a></p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">Overhead for the database</p></th>
<td class="tableblock halign-center valign-top" colspan="2"><p class="tableblock"><a href="#coordination-none-indexing-lazy-loading">Low</a></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><a href="#coordination-outbox-polling-indexing-full-loading">Low to medium</a></p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">Impact on database schema</p></th>
<td class="tableblock halign-center valign-top" colspan="2"><p class="tableblock">None</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><a href="#coordination-outbox-polling-schema">Extra tables</a></p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top" rowspan="2"><p class="tableblock"><a id="listener-triggered-indexing-possible-limitations"></a>Limitations</p></th>
<td class="tableblock halign-center valign-top" colspan="3"><p class="tableblock">Listener-triggered indexing ignores: <a href="#limitations-changes-in-session">JPQL/SQL queries</a>, <a href="#limitations-changes-asymmetric-association-updates">asymmetric association updates</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" colspan="2"><p class="tableblock">Out-of-sync indexes in rare situations: <a href="#limitations-parallel-embedded-update">concurrent <code>@IndexedEmbedded</code></a>, <a href="#limitations-backend-indexing-error">backend I/O errors</a></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">No other known limitation</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="architecture-examples-single-node-lucene"><a class="anchor" href="#architecture-examples-single-node-lucene"></a>5.2.2. <a id="architecture-examples-lucene"></a> <a id="_lucene"></a> Single-node application with the Lucene backend</h4>
<div class="sect4">
<h5 id="architecture-examples-single-node-lucene-description"><a class="anchor" href="#architecture-examples-single-node-lucene-description"></a>Description</h5>
<div class="paragraph">
<p>With the <a href="#backend-lucene">Lucene backend</a>, indexes are local to a given application node (JVM).
They are accessed through direct calls to the Lucene library,
without going through the network.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="images/architecture-single-node-lucene.png" alt="Simple architecture with Lucene backend">
</div>
</div>
<div class="paragraph">
<p>This mode is only relevant to single-node applications.</p>
</div>
</div>
<div class="sect4">
<h5 id="architecture-examples-single-node-lucene-pros-and-cons"><a class="anchor" href="#architecture-examples-single-node-lucene-pros-and-cons"></a>Pros and cons</h5>
<div class="paragraph">
<p>Pros:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Simplicity: no external services are required, everything lives on the same server.</p>
</li>
<li>
<p><a href="#backend-lucene-io-refresh">Immediate visibility</a> (~milliseconds) of index updates.
While other architectures can perform comparably well for most use cases,
a single-node, Lucene backend is the best way to implement indexing
if you need changes to be visible immediately after the database changes.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Cons:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#limitations-backend-indexing-error">Without coordination, backend errors during indexing may lead to out-of sync indexes</a>.</p>
</li>
<li>
<p><a href="#limitations-parallel-embedded-update">Without coordination, in rare cases, indexing involving <code>@IndexedEmbedded</code> may lead to out-of sync indexes</a>.</p>
</li>
<li>
<p>Not so easy to extend: experienced developers can access a lot of Lucene features,
even those that are not exposed by Hibernate Search, by providing native Lucene objects;
however, Lucene APIs are not very easy to figure out for developers unfamiliar with Lucene.
If you&#8217;re interested, see for example <a href="#search-dsl-predicate-extensions-lucene-from-lucene-query"><code>Query</code>-based predicates</a>.</p>
</li>
<li>
<p>Overhead for application threads: reindexing is done directly in application threads,
and it may require additional time to load data that must be indexed from the database.
Depending on the amount of data to load,
this may increase the application&#8217;s latency and/or decrease its throughput.</p>
</li>
<li>
<p>No horizontal scalability: there can only be one application node,
and all indexes need to live on the same server.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="architecture-examples-single-node-lucene-getting-started"><a class="anchor" href="#architecture-examples-single-node-lucene-getting-started"></a>Getting started</h5>
<div class="paragraph">
<p>To implement this architecture, use the following Maven dependencies:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">When <a href="#mapper-orm">integrating with Hibernate ORM</a></dt>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="XML"><span class="tag">&lt;dependency&gt;</span>
   <span class="tag">&lt;groupId&gt;</span>org.hibernate.search<span class="tag">&lt;/groupId&gt;</span>
   <span class="tag">&lt;artifactId&gt;</span>hibernate-search-mapper-orm<span class="tag">&lt;/artifactId&gt;</span>
   <span class="tag">&lt;version&gt;</span>7.1.2.Final<span class="tag">&lt;/version&gt;</span>
<span class="tag">&lt;/dependency&gt;</span>
<span class="tag">&lt;dependency&gt;</span>
   <span class="tag">&lt;groupId&gt;</span>org.hibernate.search<span class="tag">&lt;/groupId&gt;</span>
   <span class="tag">&lt;artifactId&gt;</span>hibernate-search-backend-lucene<span class="tag">&lt;/artifactId&gt;</span>
   <span class="tag">&lt;version&gt;</span>7.1.2.Final<span class="tag">&lt;/version&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">With the <a href="#mapper-pojo-standalone">Standalone POJO Mapper</a> (no Hibernate ORM)</dt>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="XML"><span class="tag">&lt;dependency&gt;</span>
   <span class="tag">&lt;groupId&gt;</span>org.hibernate.search<span class="tag">&lt;/groupId&gt;</span>
   <span class="tag">&lt;artifactId&gt;</span>hibernate-search-mapper-pojo-standalone<span class="tag">&lt;/artifactId&gt;</span>
   <span class="tag">&lt;version&gt;</span>7.1.2.Final<span class="tag">&lt;/version&gt;</span>
<span class="tag">&lt;/dependency&gt;</span>
<span class="tag">&lt;dependency&gt;</span>
   <span class="tag">&lt;groupId&gt;</span>org.hibernate.search<span class="tag">&lt;/groupId&gt;</span>
   <span class="tag">&lt;artifactId&gt;</span>hibernate-search-backend-lucene<span class="tag">&lt;/artifactId&gt;</span>
   <span class="tag">&lt;version&gt;</span>7.1.2.Final<span class="tag">&lt;/version&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="architecture-examples-no-coordination-elasticsearch"><a class="anchor" href="#architecture-examples-no-coordination-elasticsearch"></a>5.2.3. <a id="architecture-examples-elasticsearch"></a> Single-node or multi-node application, without coordination and with the Elasticsearch backend</h4>
<div class="sect4">
<h5 id="architecture-examples-no-coordination-elasticsearch-description"><a class="anchor" href="#architecture-examples-no-coordination-elasticsearch-description"></a>Description</h5>
<div class="paragraph">
<p>With the <a href="#backend-elasticsearch">Elasticsearch backend</a>, indexes are not tied to the application node.
They are managed by a separate cluster of Elasticsearch nodes,
and accessed through calls to REST APIs.</p>
</div>
<div class="paragraph">
<p>Thus, it is possible to set up multiple application nodes in such a way
that they all perform index updates and search queries independently,
without coordinating with each other.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="images/architecture-no-coordination-elasticsearch.png" alt="Simple architecture with Elasticsearch backend">
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The Elasticsearch cluster may be a single node living on the same server as the application.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="architecture-examples-no-coordination-elasticsearch-pros-and-cons"><a class="anchor" href="#architecture-examples-no-coordination-elasticsearch-pros-and-cons"></a>Pros and cons</h5>
<div class="paragraph">
<p>Pros:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Easy to extend: you can easily access most Elasticsearch features,
even those that are not exposed by Hibernate Search, by providing your own JSON.
See for example <a href="#search-dsl-predicate-extensions-elasticsearch-from-json">JSON-defined predicates</a>,
or <a href="#search-dsl-aggregation-extensions-elasticsearch-from-json">JSON-defined aggregations</a>,
or <a href="#search-dsl-query-elasticsearch-json">leveraging advanced features with JSON manipulation</a>.</p>
</li>
<li>
<p>Horizontal scalability of the indexes: you can size the Elasticsearch cluster according to your needs.
See <a href="https://www.elastic.co/guide/en/elasticsearch/reference/8.13/scalability.html">"Scalability and resilience" in the Elasticsearch documentation</a>.</p>
</li>
<li>
<p>Horizontal scalability of the application: you can have as many instances of the application as you need
(though high concurrency increases the likeliness of some problems with this architecture, see "Cons" below).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Cons:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#limitations-backend-indexing-error">Without coordination, backend errors during indexing may lead to out-of sync indexes</a>.</p>
</li>
<li>
<p><a href="#limitations-parallel-embedded-update">Without coordination, in rare cases, indexing involving <code>@IndexedEmbedded</code> may lead to out-of sync indexes</a>.</p>
</li>
<li>
<p>Need to manage an additional service: the Elasticsearch cluster.</p>
</li>
<li>
<p>Overhead for application threads: reindexing is done directly in application threads,
and it may require additional time to load data that must be indexed from the database.
Depending on the amount of data to load,
this may increase the application&#8217;s latency and/or decrease its throughput.</p>
</li>
<li>
<p><a href="#backend-elasticsearch-io-refresh">Delayed visibility</a> (~1 second) of index updates (near-real-time).
While changes can be made visible as soon as possible after the database changes,
Elasticsearch is <a href="https://www.elastic.co/guide/en/elasticsearch/reference/8.13/getting-started-concepts.html#_near_realtime_nrt">near-real-time</a> by nature,
and won&#8217;t perform very well if you need changes to be visible immediately after the database changes.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="architecture-examples-no-coordination-elasticsearch-getting-started"><a class="anchor" href="#architecture-examples-no-coordination-elasticsearch-getting-started"></a>Getting started</h5>
<div class="paragraph">
<p>To implement this architecture, use the following Maven dependencies:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">When <a href="#mapper-orm">integrating with Hibernate ORM</a></dt>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="XML"><span class="tag">&lt;dependency&gt;</span>
   <span class="tag">&lt;groupId&gt;</span>org.hibernate.search<span class="tag">&lt;/groupId&gt;</span>
   <span class="tag">&lt;artifactId&gt;</span>hibernate-search-mapper-orm<span class="tag">&lt;/artifactId&gt;</span>
   <span class="tag">&lt;version&gt;</span>7.1.2.Final<span class="tag">&lt;/version&gt;</span>
<span class="tag">&lt;/dependency&gt;</span>
<span class="tag">&lt;dependency&gt;</span>
   <span class="tag">&lt;groupId&gt;</span>org.hibernate.search<span class="tag">&lt;/groupId&gt;</span>
   <span class="tag">&lt;artifactId&gt;</span>hibernate-search-backend-elasticsearch<span class="tag">&lt;/artifactId&gt;</span>
   <span class="tag">&lt;version&gt;</span>7.1.2.Final<span class="tag">&lt;/version&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">With the <a href="#mapper-pojo-standalone">Standalone POJO Mapper</a> (no Hibernate ORM)</dt>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="XML"><span class="tag">&lt;dependency&gt;</span>
   <span class="tag">&lt;groupId&gt;</span>org.hibernate.search<span class="tag">&lt;/groupId&gt;</span>
   <span class="tag">&lt;artifactId&gt;</span>hibernate-search-mapper-pojo-standalone<span class="tag">&lt;/artifactId&gt;</span>
   <span class="tag">&lt;version&gt;</span>7.1.2.Final<span class="tag">&lt;/version&gt;</span>
<span class="tag">&lt;/dependency&gt;</span>
<span class="tag">&lt;dependency&gt;</span>
   <span class="tag">&lt;groupId&gt;</span>org.hibernate.search<span class="tag">&lt;/groupId&gt;</span>
   <span class="tag">&lt;artifactId&gt;</span>hibernate-search-backend-elasticsearch<span class="tag">&lt;/artifactId&gt;</span>
   <span class="tag">&lt;version&gt;</span>7.1.2.Final<span class="tag">&lt;/version&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="architecture-examples-outbox-polling-elasticsearch"><a class="anchor" href="#architecture-examples-outbox-polling-elasticsearch"></a>5.2.4. <a id="_elasticsearch"></a> Multi-node application with outbox polling and Elasticsearch backend</h4>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Features detailed below are <em>incubating</em>: they are still under active development.</p>
</div>
<div class="paragraph">
<p>The usual <a href="https://hibernate.org/community/compatibility-policy/">compatibility policy</a> does not apply:
the contract of incubating elements (e.g. types, methods, configuration properties, etc.)
may be altered in a backward-incompatible way&#8201;&#8212;&#8201;or even removed&#8201;&#8212;&#8201;in subsequent releases.</p>
</div>
<div class="paragraph">
<p>You are encouraged to use incubating features so the development team can get feedback and improve them,
but you should be prepared to update code which relies on them as needed.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="architecture-examples-outbox-polling-elasticsearch-description"><a class="anchor" href="#architecture-examples-outbox-polling-elasticsearch-description"></a><a id="architecture-examples-database-polling-elasticsearch-description"></a> Description</h5>
<div class="paragraph">
<p>With Hibernate Search&#8217;s <a href="#coordination-outbox-polling"><code>outbox-polling</code> coordination strategy</a>,
entity change events are not processed immediately in the ORM session where they arise,
but are pushed to an outbox table in the database.</p>
</div>
<div class="paragraph">
<p>A background process polls that outbox table for new events,
and processes them asynchronously,
updating the indexes as necessary.
Since that queue <a href="#coordination-outbox-polling-sharding">can be sharded</a>,
multiple application nodes can share the workload of indexing.</p>
</div>
<div class="paragraph">
<p>This requires the <a href="#backend-elasticsearch">Elasticsearch backend</a>
so that indexes are not tied to a single application node
and can be updated or queried from multiple application nodes.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="images/architecture-outbox-polling-elasticsearch.png" alt="Clustered architecture with outbox polling and Elasticsearch backend">
</div>
</div>
</div>
<div class="sect4">
<h5 id="architecture-examples-outbox-polling-elasticsearch-pros-and-cons"><a class="anchor" href="#architecture-examples-outbox-polling-elasticsearch-pros-and-cons"></a><a id="architecture-examples-database-polling-elasticsearch-pros-and-cons"></a> Pros and cons</h5>
<div class="paragraph">
<p>Pros:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Safest:</p>
<div class="ulist">
<ul>
<li>
<p>the possibility of out-of-sync indexes caused by <a href="#limitations-backend-indexing-error">indexing errors in the backend</a>
that affects other architectures is eliminated here,
because entity change events <a href="#coordination-outbox-polling-indexing-guarantee">are persisted in the same transaction as the entity changes</a>
allowing retries for as long as necessary.</p>
</li>
<li>
<p>the possibility of out-of-sync indexes caused by <a href="#limitations-parallel-embedded-update">concurrent updates</a>
that affects other architectures is eliminated here,
because <a href="#coordination-outbox-polling-indexing-full-loading">each entity instance is reloaded from the database within a new transaction</a>
before being re-indexed.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Easy to extend: you can easily access most Elasticsearch features,
even those that are not exposed by Hibernate Search, by providing your own JSON.
See for example <a href="#search-dsl-predicate-extensions-elasticsearch-from-json">JSON-defined predicates</a>,
or <a href="#search-dsl-aggregation-extensions-elasticsearch-from-json">JSON-defined aggregations</a>,
or <a href="#search-dsl-query-elasticsearch-json">leveraging advanced features with JSON manipulation</a>.</p>
</li>
<li>
<p>Minimal overhead for application threads:
application threads <a href="#coordination-outbox-polling-indexing-background">only need to append events to the queue</a>,
they don&#8217;t perform reindexing themselves.</p>
</li>
<li>
<p>Horizontal scalability of the indexes: you can size the Elasticsearch cluster according to your needs.
See <a href="https://www.elastic.co/guide/en/elasticsearch/reference/8.13/scalability.html">"Scalability and resilience" in the Elasticsearch documentation</a>.</p>
</li>
<li>
<p>Horizontal scalability of the application: you can have as many instances of the application as you need.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Cons:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Need to manage an additional service: the Elasticsearch cluster.</p>
</li>
<li>
<p>Delayed visibility (~1 second or more, depending on load and hardware) of index updates.
First because Elasticsearch is <a href="https://www.elastic.co/guide/en/elasticsearch/reference/8.13/getting-started-concepts.html#_near_realtime_nrt">near-real-time</a> by nature,
but also because <a href="#coordination-outbox-polling-indexing-visibility">the event queue introduces additional delays</a>.</p>
</li>
<li>
<p>Impact on the database schema: <a href="#coordination-outbox-polling-schema">additional tables must be created in the database</a>
to hold the data necessary for coordination.</p>
</li>
<li>
<p>Overhead for the database: the background process that reads entity changes and performs reindexing
<a href="#coordination-outbox-polling-indexing-full-loading">needs to read changed entities from the database</a>.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="architecture-examples-outbox-polling-elasticsearch-getting-started"><a class="anchor" href="#architecture-examples-outbox-polling-elasticsearch-getting-started"></a><a id="architecture-examples-database-polling-elasticsearch-getting-started"></a> Getting started</h5>
<div class="paragraph">
<p>The <code>outbox-polling</code> coordination strategy requires an extra dependency.
To implement this architecture, use the following Maven dependencies:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">When <a href="#mapper-orm">integrating with Hibernate ORM</a></dt>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="XML"><span class="tag">&lt;dependency&gt;</span>
   <span class="tag">&lt;groupId&gt;</span>org.hibernate.search<span class="tag">&lt;/groupId&gt;</span>
   <span class="tag">&lt;artifactId&gt;</span>hibernate-search-mapper-orm<span class="tag">&lt;/artifactId&gt;</span>
   <span class="tag">&lt;version&gt;</span>7.1.2.Final<span class="tag">&lt;/version&gt;</span>
<span class="tag">&lt;/dependency&gt;</span>
<span class="tag">&lt;dependency&gt;</span>
   <span class="tag">&lt;groupId&gt;</span>org.hibernate.search<span class="tag">&lt;/groupId&gt;</span>
   <span class="tag">&lt;artifactId&gt;</span>hibernate-search-mapper-orm-outbox-polling<span class="tag">&lt;/artifactId&gt;</span>
   <span class="tag">&lt;version&gt;</span>7.1.2.Final<span class="tag">&lt;/version&gt;</span>
<span class="tag">&lt;/dependency&gt;</span>
<span class="tag">&lt;dependency&gt;</span>
   <span class="tag">&lt;groupId&gt;</span>org.hibernate.search<span class="tag">&lt;/groupId&gt;</span>
   <span class="tag">&lt;artifactId&gt;</span>hibernate-search-backend-elasticsearch<span class="tag">&lt;/artifactId&gt;</span>
   <span class="tag">&lt;version&gt;</span>7.1.2.Final<span class="tag">&lt;/version&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">With the <a href="#mapper-pojo-standalone">Standalone POJO Mapper</a> (no Hibernate ORM)</dt>
<dd>
<p>This architecture cannot be implemented with the Standalone POJO Mapper at the moment,
because this mapper <a href="#mapper-pojo-standalone-coordination">does not support coordination</a>.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Also, configure coordination as explained in <a href="#coordination-outbox-polling"> <code>outbox-polling</code>: additional event tables and polling in background processors</a>.</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="mapper-orm"><a class="anchor" href="#mapper-orm"></a>6. <a id="mapper-orm-mapping-configuration"></a> Hibernate ORM integration</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="mapper-orm-basics"><a class="anchor" href="#mapper-orm-basics"></a>6.1. Basics</h3>
<div class="paragraph">
<p>The Hibernate ORM <a href="#architecture-hsearch-components-mapper">"mapper"</a> is an integration of Hibernate Search into Hibernate ORM.</p>
</div>
<div class="paragraph">
<p>Its key features include:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#listener-triggered-indexing">Listener-triggered indexing</a> of Hibernate ORM entities
as they are modified in the Hibernate ORM <code>EntityManager</code>/<code>Session</code>.</p>
</li>
<li>
<p><a href="#search-dsl-query-entity-loading-options">Loading of managed entities</a>
as hits in the result of a <a href="#search-dsl-query">search query</a>.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="mapper-orm-startup"><a class="anchor" href="#mapper-orm-startup"></a>6.2. <a id="mapper-orm-mapping-configuration-enabling-disabling"></a> <a id="search-configuration-event"></a> Startup</h3>
<div class="paragraph">
<p>The Hibernate Search integration into Hibernate ORM will start automatically,
at the same time as Hibernate ORM, as soon as it is present in the classpath.</p>
</div>
<div class="paragraph">
<p>If for some reason you need to prevent Hibernate Search from starting,
set the <a href="#configuration-property-types">boolean property</a> <code>hibernate.search.enabled</code> to <code>false</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="mapper-orm-shutdown"><a class="anchor" href="#mapper-orm-shutdown"></a>6.3. Shutdown</h3>
<div class="paragraph">
<p>The Hibernate Search integration into Hibernate ORM will stop automatically,
at the same time as Hibernate ORM.</p>
</div>
<div class="paragraph">
<p>On shutdown, Hibernate Search will stop accepting new indexing requests:
new indexing attempts will throw exceptions.
The Hibernate ORM shutdown will block until all ongoing indexing operations complete.</p>
</div>
</div>
<div class="sect2">
<h3 id="mapper-orm-mapping-dynamicmap"><a class="anchor" href="#mapper-orm-mapping-dynamicmap"></a>6.4. <a id="mapper-orm-programmatic-mapping-dynamicmap"></a> Mapping <code>Map</code>-based models</h3>
<div class="paragraph">
<p><a href="https://docs.jboss.org/hibernate/orm/6.4/userguide/html_single/Hibernate_User_Guide.html#dynamic-model">"Dynamic-map" entity models</a>,
i.e. models based on <code>java.util.Map</code> instead of custom classes,
cannot be mapped using annotations.
However, they can be mapped using the <a href="#mapping-programmatic">programmatic mapping API</a>.
You just need to refer to the types by their name using <code>context.programmaticMapping().type("thename")</code>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Pass the entity name for dynamic entity types.</p>
</li>
<li>
<p>Pass the "role" for dynamic embedded/component types,
i.e. the name of the owning entity, followed by a dot ("."),
followed by the dot-separated path to the component in that entity.
For example <code>MyEntity.myEmbedded</code> or <code>MyEntity.myEmbedded.myNestedEmbedded</code>.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="mapper-orm-configuration-other"><a class="anchor" href="#mapper-orm-configuration-other"></a>6.5. <a id="mapper-orm-mapping-configuration-other"></a> Other configuration</h3>
<div class="paragraph">
<p>Other configuration properties are mentioned in the relevant parts of this documentation.
You can find a full reference of available properties in
<a href="#configuration-properties-aggregated-hibernate-search-mapper-orm">the ORM integration configuration properties appendix</a>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="mapper-pojo-standalone"><a class="anchor" href="#mapper-pojo-standalone"></a>7. Standalone POJO Mapper</h2>
<div class="sectionbody">
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Features detailed below are <em>incubating</em>: they are still under active development.</p>
</div>
<div class="paragraph">
<p>The usual <a href="https://hibernate.org/community/compatibility-policy/">compatibility policy</a> does not apply:
the contract of incubating elements (e.g. types, methods, configuration properties, etc.)
may be altered in a backward-incompatible way&#8201;&#8212;&#8201;or even removed&#8201;&#8212;&#8201;in subsequent releases.</p>
</div>
<div class="paragraph">
<p>You are encouraged to use incubating features so the development team can get feedback and improve them,
but you should be prepared to update code which relies on them as needed.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="mapper-pojo-standalone-basics"><a class="anchor" href="#mapper-pojo-standalone-basics"></a>7.1. Basics</h3>
<div class="paragraph">
<p>The Standalone POJO <a href="#architecture-hsearch-components-mapper">Mapper</a> enables mapping arbitrary POJOs to indexes.</p>
</div>
<div class="paragraph">
<p>Its key feature compared to the <a href="#mapper-orm">Hibernate ORM integration</a>
is its ability to run without Hibernate ORM or a relational database.</p>
</div>
<div class="paragraph">
<p>It can be used to index entities coming from an arbitrary datastore
or even (though that&#8217;s not recommended in general)
to use Lucene or Elasticsearch as a primary datastore.</p>
</div>
<div class="paragraph">
<p>Because the Standalone POJO Mapper does not assume anything about the entities being mapped,
beyond the fact they are represented as POJOs,
it can be more complex to use than the <a href="#mapper-orm">Hibernate ORM integration</a>.
In particular:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>This mapper <a href="#mapper-pojo-standalone-indexing-listener-triggered">cannot detect entity changes on its own</a>:
all indexing <a href="#mapper-pojo-standalone-indexing-plan">must be explicit</a>.</p>
</li>
<li>
<p>Loading of entities as hits in the result of a <a href="#search-dsl-query">search query</a>
must be <a href="#mapper-pojo-standalone-search-query-loading">implemented in the application</a>.</p>
</li>
<li>
<p>Loading of identifiers and entities for <a href="#indexing-massindexer">mass indexing</a>
must be <a href="#mapper-pojo-standalone-indexing-massindexer">implemented in the application</a>.</p>
</li>
<li>
<p>This mapper <a href="#mapper-pojo-standalone-coordination">does not provide coordination between nodes</a>
at the moment.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="mapper-pojo-standalone-startup"><a class="anchor" href="#mapper-pojo-standalone-startup"></a>7.2. Startup</h3>
<div class="paragraph">
<p>Starting up Hibernate Search with the Standalone POJO Mapper is explicit and involves a builder:</p>
</div>
<div class="exampleblock">
<div class="title">Example 1. Starting up Hibernate Search with the Standalone POJO Mapper</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre>        CloseableSearchMapping searchMapping =
                SearchMapping.builder( AnnotatedTypeSource.fromClasses( <i class="conum" data-value="1"></i><b>(1)</b>
                        Book.class, Associate.class, Manager.class
                ) )
                        .property(
                                "hibernate.search.backend.hosts", <i class="conum" data-value="2"></i><b>(2)</b>
                                "elasticsearch.mycompany.com"
                        )
                        .build(); <i class="conum" data-value="3"></i><b>(3)</b></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Create a builder, passing an <code>AnnotatedTypeSource</code> to let Hibernate Search know where to look for annotations.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Set additional configuration properties (see also <a href="#configuration"> Configuration</a>).</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Build the <code>SearchMapping</code>.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Thanks to <a href="#mapping-classpath-scanning">classpath scanning</a>,
your <code>AnnotatedTypeSource</code> only needs to include one class
from each JAR containing annotated types.
Other types should be automatically discovered.</p>
</div>
<div class="paragraph">
<p>See also <a href="#mapping-classpath-scanning-faster">this section</a>
to troubleshoot or improve performance of classpath scanning.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="mapper-pojo-standalone-shutdown"><a class="anchor" href="#mapper-pojo-standalone-shutdown"></a>7.3. Shutdown</h3>
<div class="paragraph">
<p>You can shut down Hibernate Search with the Standalone POJO Mapper by calling the <code>close()</code> method on the mapping:</p>
</div>
<div class="exampleblock">
<div class="title">Example 2. Shutting down Hibernate Search with the Standalone POJO Mapper</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">CloseableSearchMapping searchMapping = <span class="comment">/* ... */</span> <i class="conum" data-value="1"></i><b>(1)</b>
searchMapping.close(); <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Retrieve the <code>SearchMapping</code> that was returned when <a href="#mapper-pojo-standalone-startup">Hibernate Search started</a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Call <code>close()</code> to shut down Hibernate Search.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>On shutdown, Hibernate Search will stop accepting new indexing requests:
new indexing attempts will throw exceptions.
The <code>close()</code> method will only return once all ongoing indexing operations complete.</p>
</div>
</div>
<div class="sect2">
<h3 id="mapper-pojo-standalone-beanprovider"><a class="anchor" href="#mapper-pojo-standalone-beanprovider"></a>7.4. Bean provider</h3>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Features detailed below are <em>incubating</em>: they are still under active development.</p>
</div>
<div class="paragraph">
<p>The usual <a href="https://hibernate.org/community/compatibility-policy/">compatibility policy</a> does not apply:
the contract of incubating elements (e.g. types, methods, configuration properties, etc.)
may be altered in a backward-incompatible way&#8201;&#8212;&#8201;or even removed&#8201;&#8212;&#8201;in subsequent releases.</p>
</div>
<div class="paragraph">
<p>You are encouraged to use incubating features so the development team can get feedback and improve them,
but you should be prepared to update code which relies on them as needed.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The Standalone POJO Mapper can <a href="#configuration-bean">retrieve beans from CDI/Spring</a>,
but that support needs to be implemented explicitly through a bean provider.</p>
</div>
<div class="paragraph">
<p>You can plug in your own bean provider in two steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Define a class that implements the <code>org.hibernate.search.engine.environment.bean.spi.BeanProvider</code> interface.</p>
</li>
<li>
<p>Configure Hibernate Search to use that implementation by setting the configuration property
<code>hibernate.search.bean_provider</code>
to a <a href="#configuration-bean-reference-parsing">bean reference</a> pointing to the implementation,
for example <code>class:com.mycompany.MyMappingConfigurer</code>.
Obviously, the reference to the bean provider cannot be resolved using the bean provider.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="mapper-pojo-standalone-multi-tenancy"><a class="anchor" href="#mapper-pojo-standalone-multi-tenancy"></a>7.5. Multi-tenancy</h3>
<div class="paragraph">
<p>Multi-tenancy needs to be enabled explicitly when starting the Standalone POJO Mapper:</p>
</div>
<div class="exampleblock">
<div class="title">Example 3. Enabling multi-tenancy with the Standalone POJO Mapper</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">CloseableSearchMapping searchMapping = SearchMapping.builder( AnnotatedTypeSource.fromClasses( <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="predefined-type">Book</span>.class
) )
        <span class="comment">// ...</span>
        .property( <span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.search.mapping.multi_tenancy.enabled</span><span class="delimiter">&quot;</span></span>, <span class="predefined-constant">true</span> ) <i class="conum" data-value="2"></i><b>(2)</b>
        .build(); <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Create a builder.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Enable multi-tenancy.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Build the <code>SearchMapping</code>.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>Once multi-tenancy is enabled, a tenant ID will have to be provided when creating a <code>SearchSession</code> and in some other cases
(creating a <a href="#indexing-massindexer">mass indexer</a>, a <a href="#indexing-workspace">workspace</a>, &#8230;&#8203;).</p>
</div>
<div class="exampleblock">
<div class="title">Example 4. Creating the <code>SearchSession</code> with a tenant identifier</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">SearchMapping searchMapping = <span class="comment">/* ... */</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="keyword">try</span> ( SearchSession searchSession = searchMapping.createSessionWithOptions() <i class="conum" data-value="2"></i><b>(2)</b>
        .tenantId( <span class="string"><span class="delimiter">&quot;</span><span class="content">myTenantId</span><span class="delimiter">&quot;</span></span> ) <i class="conum" data-value="3"></i><b>(3)</b>
        .build() ) { <i class="conum" data-value="4"></i><b>(4)</b>
    <span class="comment">// ...</span>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><a href="#entrypoints-search-mapping-mapper-pojo-standalone">Retrieve the <code>SearchMapping</code></a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Start creating a new session.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Set the tenant identifier for the new session.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Build the new session.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="mapper-pojo-standalone-mapping"><a class="anchor" href="#mapper-pojo-standalone-mapping"></a>7.6. Mapping</h3>
<div class="paragraph">
<p>While the <a href="#mapper-orm">Hibernate ORM integration</a> can infer parts of the mapping from the Hibernate ORM mapping,
the Standalone POJO Mapper cannot.
As a result, the Standalone POJO Mapper needs more explicit configuration
for its mapping:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#concepts-entity">Entity types</a> must be <a href="#mapping-entitydefinition-explicit">defined explicitly</a>.</p>
</li>
<li>
<p>Document identifiers must be <a href="#mapping-identifiermapping-explicit">mapped explicitly</a>.</p>
</li>
<li>
<p>The inverse side of associations must be <a href="#mapping-reindexing-associationinverseside">mapped explicitly</a>.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="mapper-pojo-standalone-indexing"><a class="anchor" href="#mapper-pojo-standalone-indexing"></a>7.7. Indexing</h3>
<div class="sect3">
<h4 id="mapper-pojo-standalone-indexing-listener-triggered"><a class="anchor" href="#mapper-pojo-standalone-indexing-listener-triggered"></a>7.7.1. <a id="mapper-pojo-standalone-indexing-automatic"></a> Listener-triggered indexing</h4>
<div class="paragraph">
<p>The Standalone POJO Mapper does not provide "implicit" indexing
similar to the <a href="#listener-triggered-indexing">listener-triggered indexing</a> in the <a href="#mapper-orm">Hibernate ORM integration</a>.</p>
</div>
<div class="paragraph">
<p>Instead, you must index explicitly with an <a href="#mapper-pojo-standalone-indexing-plan">indexing plan</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="mapper-pojo-standalone-indexing-plan"><a class="anchor" href="#mapper-pojo-standalone-indexing-plan"></a>7.7.2. Explicitly indexing on entity change events</h4>
<div class="paragraph">
<p>The Standalone POJO Mapper can process entity change events (add, update, delete)
and perform indexing accordingly,
though events must necessarily be passed to Hibernate Search explicitly.
See <a href="#indexing-plan">Indexing plans</a> for more information about the API.</p>
</div>
<div class="paragraph">
<p>One major difference with the <a href="#mapper-orm">Hibernate ORM integration</a>
is that transactions (JTA or otherwise are not supported),
so indexing is executed on <a href="#entrypoints-search-session-mapper-pojo-standalone">session closing</a>
rather than on transaction commit.</p>
</div>
</div>
<div class="sect3">
<h4 id="mapper-pojo-standalone-indexing-massindexer"><a class="anchor" href="#mapper-pojo-standalone-indexing-massindexer"></a>7.7.3. Mass indexing</h4>
<div class="paragraph">
<p>Because by default, the Standalone POJO Mapper does not know anything about where the entity data comes from,
<a href="#indexing-massindexer">mass indexing</a> requires plugging in a way to load entities <em>en masse</em> from the other datastore:
a mass loading strategy.</p>
</div>
<div class="paragraph">
<p>Mass loading strategies are assigned to <a href="#concepts-entity">entity types</a>
as part of the <a href="#mapping-entitydefinition">entity definition</a>:
see <a href="#mapping-entitydefinition-loading-mass">Mass loading strategy</a> for more information.</p>
</div>
</div>
<div class="sect3">
<h4 id="mapper-pojo-standalone-search-query-loading"><a class="anchor" href="#mapper-pojo-standalone-search-query-loading"></a>7.7.4. Entity loading in search queries</h4>
<div class="paragraph">
<p>Because by default, the Standalone POJO Mapper does not know anything about where the entity data comes from,
<a href="#search-dsl-query-generality">entity loading in search queries</a>
requires plugging in a way to load a selection of entities from the other datastore:
a selection loading strategy.</p>
</div>
<div class="paragraph">
<p>Selection loading strategies are assigned to <a href="#concepts-entity">entity types</a>
as part of the <a href="#mapping-entitydefinition">entity definition</a>:
see <a href="#mapping-entitydefinition-loading-selection">Selection loading strategy</a> for more information.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>With the Standalone POJO Mapper, if you want entities to be loaded from the index,
instead of an external datasource,
add a <a href="#mapping-projection">projection constructor</a> to your entity type.</p>
</div>
<div class="paragraph">
<p>This will automatically result in your entity being loaded from the index
when the configuration described in this section is missing and loading is required
(for example when not using <code>select()</code> in a search query).</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="mapper-pojo-standalone-coordination"><a class="anchor" href="#mapper-pojo-standalone-coordination"></a>7.8. Coordination</h3>
<div class="paragraph">
<p>The Standalone POJO Mapper does not provide any way
to coordinate between nodes at the moment,
so its behavior is roughly similar to that described in <a href="#coordination-none">No coordination</a>,
except entity data extracting happens on session closing instead of happening on Hibernate ORM session flushes,
and indexing happens immediately after that instead of happening on transaction commit.</p>
</div>
</div>
<div class="sect2">
<h3 id="mapper-pojo-standalone-configuration-from-property-file"><a class="anchor" href="#mapper-pojo-standalone-configuration-from-property-file"></a>7.9. Reading configuration properties from a file</h3>
<div class="paragraph">
<p>The Standalone POJO Mapper <code>SearchMappingBuilder</code> can also take properties from a <code>Reader</code> compatible with <code>java.util.Properties#load(Reader)</code>:</p>
</div>
<div class="exampleblock">
<div class="title">Example 5. Loading configuration properties from a file using a <code>Reader</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="keyword">try</span> (
        <span class="predefined-type">Reader</span> propertyFileReader = <span class="comment">/* ... */</span> <i class="conum" data-value="1"></i><b>(1)</b>
) {
    CloseableSearchMapping searchMapping = SearchMapping.builder( AnnotatedTypeSource.empty() ) <i class="conum" data-value="2"></i><b>(2)</b>
            .properties( propertyFileReader ) <i class="conum" data-value="3"></i><b>(3)</b>
            .build();
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Get a reader representing a property file with configuration properties.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Start configuring the Standalone POJO Mapper.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Pass the property file reader to the builder.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="mapper-pojo-standalone-configuration-other"><a class="anchor" href="#mapper-pojo-standalone-configuration-other"></a>7.10. Other configuration</h3>
<div class="paragraph">
<p>Other configuration properties are mentioned in the relevant parts of this documentation.
You can find a full reference of available properties in
<a href="#configuration-properties-aggregated-hibernate-search-mapper-pojo-standalone">the Standalone POJO Mapper configuration properties appendix</a>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="configuration"><a class="anchor" href="#configuration"></a>8. <a id="search-configuration"></a> Configuration</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="configuration-sources"><a class="anchor" href="#configuration-sources"></a>8.1. <a id="_configuration_sources"></a> Configuration sources</h3>
<div class="sect3">
<h4 id="configuration-sources-mapper-orm"><a class="anchor" href="#configuration-sources-mapper-orm"></a>8.1.1. Configuration sources when integrating into Hibernate ORM</h4>
<div class="paragraph">
<p>When using Hibernate Search within Hibernate ORM,
configuration properties are retrieved from Hibernate ORM.</p>
</div>
<div class="paragraph">
<p>This means that wherever you set Hibernate ORM properties,
you can set Hibernate Search properties:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>In a <code>hibernate.properties</code> file at the root of your classpath.</p>
</li>
<li>
<p>In <code>persistence.xml</code>, if you bootstrap Hibernate ORM with the JPA APIs</p>
</li>
<li>
<p>In JVM system properties (<code>-DmyProperty=myValue</code> passed to the <code>java</code> command)</p>
</li>
<li>
<p>In the configuration file of your framework,
for example <code>application.yaml</code>/<code>application.properties</code>.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>When setting properties through the configuration file of your framework,
the keys of configuration properties will likely be different from
the keys mentioned in this documentation.</p>
</div>
<div class="paragraph">
<p>For example <code>hibernate.search.backend.hosts</code> will become
<code>quarkus.hibernate-search-orm.elasticsearch.hosts</code> in Quarkus
or <code>spring.jpa.properties.hibernate.search.backend.hosts</code> in Spring Boot.</p>
</div>
<div class="paragraph">
<p>See <a href="#compatibility-framework"> Framework support</a> for more information.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="configuration-sources-mapper-pojo-standalone"><a class="anchor" href="#configuration-sources-mapper-pojo-standalone"></a>8.1.2. Configuration sources with the Standalone POJO mapper</h4>
<div class="paragraph">
<p>When using Hibernate Search in the <a href="#mapper-pojo-standalone">Standalone POJO Mapper</a> (without Hibernate ORM),
configuration properties must be set programmatically as you build the mapping.</p>
</div>
<div class="paragraph">
<p>See <a href="#mapper-pojo-standalone-basics">this section</a> for more information.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="configuration-property"><a class="anchor" href="#configuration-property"></a>8.2. Configuration properties</h3>
<div class="sect3">
<h4 id="configuration-structure"><a class="anchor" href="#configuration-structure"></a>8.2.1. Structure of configuration properties</h4>
<div class="paragraph">
<p>Configuration properties are all grouped under a common root.
In the ORM integration, this root is <code>hibernate.search</code>,
but other integrations (Infinispan, &#8230;&#8203;) may use a different one.
This documentation will use <code>hibernate.search</code> in all examples.</p>
</div>
<div class="paragraph">
<p>Under that root, we can distinguish between three categories of properties.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Global properties</dt>
<dd>
<p>These properties potentially affect all Hibernate Search.
They are generally located just under the <code>hibernate.search</code> root.</p>
<div class="paragraph">
<p>Global properties are explained in the relevant parts of this documentation:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#mapper-orm">Hibernate ORM integration</a></p>
</li>
<li>
<p><a href="#mapper-pojo-standalone">Standalone POJO Mapper</a></p>
</li>
<li>
<p><a href="#mapping-configuration">Mapping configuration</a></p>
</li>
<li>
<p>And many more.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Backend properties</dt>
<dd>
<p>These properties affect a single backend.
They are grouped under a common root:</p>
<div class="ulist">
<ul>
<li>
<p><code>hibernate.search.backend</code> for the default backend (most common usage).</p>
</li>
<li>
<p><code>hibernate.search.backends.&lt;backend-name&gt;</code> for a named backend (advanced usage).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Backend properties are explained in the relevant parts of this documentation:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#backend-lucene-configuration">Lucene backend</a></p>
</li>
<li>
<p><a href="#backend-elasticsearch-configuration">Elasticsearch backend</a></p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Index properties</dt>
<dd>
<p>These properties affect either one or multiple indexes, depending on the root.</p>
<div class="paragraph">
<p>With the root <code>hibernate.search.backend</code>,
they set defaults for all indexes of the backend.</p>
</div>
<div class="paragraph">
<p>With the root <code>hibernate.search.backend.indexes.&lt;index-name&gt;</code>,
they set the value for a specific index, overriding the defaults (if any).
The backend and index names must match the names defined in the mapping.
For Hibernate ORM entities, the default index name is the name of the indexed class, without the package:
<code>org.mycompany.Book</code> will have <code>Book</code> as its default index name.
Index names can be customized in the mapping.</p>
</div>
<div class="paragraph">
<p>Alternatively, the backend can also be referenced by name,
i.e. the roots above can also be <code>hibernate.search.backends.&lt;backend-name&gt;</code>
or <code>hibernate.search.backends.&lt;backend-name&gt;.indexes.&lt;index-name&gt;</code>.</p>
</div>
<div class="paragraph">
<p>Examples:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>hibernate.search.backend.io.commit_interval = 500</code>
sets the <code>io.commit_interval</code> property for all indexes of the default backend.</p>
</li>
<li>
<p><code>hibernate.search.backend.indexes.Product.io.commit_interval = 2000</code>
sets the <code>io.commit_interval</code> property for the <code>Product</code> index of the default backend.</p>
</li>
<li>
<p><code>hibernate.search.backends.myBackend.io.commit_interval = 500</code>
sets the <code>io.commit_interval</code> property for all indexes of backend <code>myBackend</code>.</p>
</li>
<li>
<p><code>hibernate.search.backends.myBackend.indexes.Product.io.commit_interval = 2000</code>
sets the <code>io.commit_interval</code> property for the <code>Product</code> index of backend <code>myBackend</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Other index properties are explained in the relevant parts of this documentation:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#backend-lucene-configuration">Lucene backend</a></p>
</li>
<li>
<p><a href="#backend-elasticsearch-configuration">Elasticsearch backend</a></p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="configuration-builder"><a class="anchor" href="#configuration-builder"></a>8.2.2. Building property keys programmatically</h4>
<div class="paragraph">
<p>Both <code>BackendSettings</code> and <code>IndexSettings</code> provide tools to help build the configuration property keys.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">BackendSettings</dt>
<dd>
<div class="paragraph">
<p><code>BackendSettings.backendKey(ElasticsearchBackendSettings.HOSTS)</code>
is equivalent to <code>hibernate.search.backend.hosts</code>.</p>
</div>
<div class="paragraph">
<p><code>BackendSettings.backendKey("myBackend", ElasticsearchBackendSettings.HOSTS)</code>
is equivalent to <code>hibernate.search.backends.myBackend.hosts</code>.</p>
</div>
<div class="paragraph">
<p>For a list of available property keys,
see <a href="#configuration-properties-aggregated-hibernate-search-backend-elasticsearch">the Elasticsearch backend configuration properties appendix</a>
or <a href="#configuration-properties-aggregated-hibernate-search-backend-lucene">the Lucene backend configuration properties appendix</a>.</p>
</div>
</dd>
<dt class="hdlist1">IndexSettings</dt>
<dd>
<div class="paragraph">
<p><code>IndexSettings.indexKey("myIndex", ElasticsearchIndexSettings.INDEXING_QUEUE_SIZE)</code>
is equivalent to <code>hibernate.search.backend.indexes.myIndex.indexing.queue_size</code>.</p>
</div>
<div class="paragraph">
<p><code>IndexSettings.indexKey("myBackend", "myIndex", ElasticsearchIndexSettings.INDEXING_QUEUE_SIZE)</code>
is equivalent to <code>hibernate.search.backends.myBackend.indexes.myIndex.indexing.queue_size</code>.</p>
</div>
<div class="paragraph">
<p>For a list of available property keys,
see <a href="#configuration-properties-aggregated-hibernate-search-backend-elasticsearch">the Elasticsearch backend configuration properties appendix</a>
or <a href="#configuration-properties-aggregated-hibernate-search-backend-lucene">the Lucene backend configuration properties appendix</a>.
Look for properties having a variant starting with a <code>hibernate.search.backend.indexes</code>.</p>
</div>
</dd>
</dl>
</div>
<div class="exampleblock">
<div class="title">Example 6. Using the helper to build hibernate configuration</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="directive">private</span> <span class="predefined-type">Properties</span> buildHibernateConfiguration() {
    <span class="predefined-type">Properties</span> config = <span class="keyword">new</span> <span class="predefined-type">Properties</span>();
    <span class="comment">// backend configuration</span>
    config.put( BackendSettings.backendKey( ElasticsearchBackendSettings.HOSTS ), <span class="string"><span class="delimiter">&quot;</span><span class="content">127.0.0.1:9200</span><span class="delimiter">&quot;</span></span> );
    config.put( BackendSettings.backendKey( ElasticsearchBackendSettings.PROTOCOL ), <span class="string"><span class="delimiter">&quot;</span><span class="content">http</span><span class="delimiter">&quot;</span></span> );
    <span class="comment">// index configuration</span>
    config.put(
            IndexSettings.indexKey( <span class="string"><span class="delimiter">&quot;</span><span class="content">myIndex</span><span class="delimiter">&quot;</span></span>, ElasticsearchIndexSettings.INDEXING_MAX_BULK_SIZE ),
            <span class="integer">20</span>
    );
    <span class="comment">// orm configuration</span>
    config.put(
            HibernateOrmMapperSettings.INDEXING_PLAN_SYNCHRONIZATION_STRATEGY,
            IndexingPlanSynchronizationStrategyNames.ASYNC
    );
    <span class="comment">// engine configuration</span>
    config.put( EngineSettings.BACKGROUND_FAILURE_HANDLER, <span class="string"><span class="delimiter">&quot;</span><span class="content">myFailureHandler</span><span class="delimiter">&quot;</span></span> );
    <span class="keyword">return</span> config;
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="configuration-property-types"><a class="anchor" href="#configuration-property-types"></a>8.2.3. Type of configuration properties</h4>
<div class="paragraph">
<p>Property values can be set programmatically as Java objects,
or through a configuration file as a string that will have to be parsed.</p>
</div>
<div class="paragraph">
<p>Each configuration property in Hibernate Search has an assigned type,
and this type defines the accepted values in both cases.</p>
</div>
<div class="paragraph">
<p>Here are the definitions of all property types.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Designation</th>
<th class="tableblock halign-left valign-top">Accepted Java objects</th>
<th class="tableblock halign-left valign-top">Accepted String format</th>
</tr>
</thead>
<tbody>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">String</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.lang.String</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Any string</p>
</div></div></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">Boolean</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.lang.Boolean</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>true</code> or <code>false</code> (case-insensitive)</p>
</div></div></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">Integer</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.lang.Number</code> (will call .intValue())</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Any string that can be parsed by <code>Integer.parseInt</code></p>
</div></div></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">Long</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.lang.Number</code> (will call .longValue())</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Any string that can be parsed by <code>Long.parseLong</code></p>
</div></div></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">Bean reference of type T</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">An instance of <code>T</code> or <code>BeanReference</code>
or a reference by type as a <code>java.lang.Class</code>
(see <a href="#configuration-bean-reference">Bean references</a>)</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>See <a href="#configuration-bean-reference-parsing">Parsing of bean references</a></p>
</div></div></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>When a configuration property of any type above is documented as multivalued,
that property accepts either:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A <code>java.util.Collection</code> containing any Java object that would be accepted for a single-valued property of the same type (see above);</p>
</li>
<li>
<p>or a comma-separated string containing strings that would be accepted for a single-valued property of the same type (see above);</p>
</li>
<li>
<p>or a single Java object that would be accepted for a single-valued property of the same type (see above).</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="configuration-property-checking"><a class="anchor" href="#configuration-property-checking"></a>8.3. <a id="configuration-property-tracking"></a> Configuration property checking</h3>
<div class="paragraph">
<p>Hibernate Search will track the parts of the provided configuration that are actually used
and will log a warning if any configuration property starting with "hibernate.search." is never used,
because that might indicate a configuration issue.</p>
</div>
<div class="paragraph">
<p>To disable this warning, set the <code>hibernate.search.configuration_property_checking.strategy</code>
property to <code>ignore</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="configuration-bean"><a class="anchor" href="#configuration-bean"></a>8.4. Beans</h3>
<div class="paragraph">
<p>Hibernate Search allows plugging in references to custom beans in various places:
configuration properties, mapping annotations, arguments to APIs, &#8230;&#8203;</p>
</div>
<div class="paragraph">
<p>This section describes <a href="#configuration-bean-frameworks">the supported frameworks</a>,
<a href="#configuration-bean-reference">how to reference beans</a>,
<a href="#configuration-bean-resolution">how the beans are resolved</a>
and <a href="#configuration-bean-injection">how the beans can get injected with other beans</a>.</p>
</div>
<div class="sect3">
<h4 id="configuration-bean-frameworks"><a class="anchor" href="#configuration-bean-frameworks"></a>8.4.1. Supported frameworks</h4>
<div class="sect4">
<h5 id="configuration-bean-frameworks-mapper-orm"><a class="anchor" href="#configuration-bean-frameworks-mapper-orm"></a>Supported frameworks when integrating into Hibernate ORM</h5>
<div class="paragraph">
<p>When using the Hibernate Search integration into Hibernate ORM,
all dependency injection frameworks integrated into Hibernate ORM are automatically integrated into Hibernate Search.</p>
</div>
<div class="paragraph">
<p>This includes, but may not be limited to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>all CDI-compliant frameworks, including <a href="https://wildfly.org/">WildFly</a> and <a href="https://quarkus.io/">Quarkus</a>;</p>
</li>
<li>
<p>the <a href="https://spring.io/">Spring</a> framework.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>When not using a dependency injection framework, or when it is not integrated into Hibernate ORM,
beans can only be retrieved using reflection by calling the public, no-arg constructor of the referenced type;
see <a href="#configuration-bean-resolution"> Bean resolution</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="configuration-bean-frameworks-mapper-pojo-standalone"><a class="anchor" href="#configuration-bean-frameworks-mapper-pojo-standalone"></a>Supported frameworks when using the Standalone POJO Mapper</h5>
<div class="paragraph">
<p>When using the <a href="#mapper-pojo-standalone">Standalone POJO Mapper</a>
dependency injection support must be <a href="#mapper-pojo-standalone-beanprovider">plugged in manually</a>.</p>
</div>
<div class="paragraph">
<p>Failing that,
beans can only be retrieved using reflection by calling the public, no-arg constructor of the referenced type;
see <a href="#configuration-bean-resolution"> Bean resolution</a>.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="configuration-bean-reference"><a class="anchor" href="#configuration-bean-reference"></a>8.4.2. Bean references</h4>
<div class="paragraph">
<p>Bean references are composed of two parts:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The type, i.e. a <code>java.lang.Class</code>.</p>
</li>
<li>
<p>Optionally, the name, as a <code>String</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>When referencing beans using a string value in configuration properties,
the type is implicitly set to whatever interface Hibernate Search expects for that configuration property.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>For experienced users, Hibernate Search also provides the <code>org.hibernate.search.engine.environment.bean.BeanReference</code> type,
which is accepted in configuration properties and APIs.
This interface allows plugging in custom instantiation and cleanup code.
See the javadoc of this interface for details.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="configuration-bean-reference-parsing"><a class="anchor" href="#configuration-bean-reference-parsing"></a>8.4.3. Parsing of bean references</h4>
<div class="paragraph">
<p>When referencing beans using a string value in configuration properties, that string is parsed.</p>
</div>
<div class="paragraph">
<p>Here are the most common formats:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>bean:</code> followed by the name of a Spring or CDI bean.
For example <code>bean:myBean</code>.</p>
</li>
<li>
<p><code>class:</code> followed by the fully-qualified name of a class, to be instantiated through Spring/CDI if available,
or through its public, no-argument constructor otherwise.
For example <code>class:com.mycompany.MyClass</code>.</p>
</li>
<li>
<p>An arbitrary string that doesn&#8217;t contain a colon:
it will be interpreted as explained in <a href="#configuration-bean-resolution"> Bean resolution</a>. In short:</p>
<div class="ulist">
<ul>
<li>
<p>first, look for a built-in bean with the given name;</p>
</li>
<li>
<p>then try to retrieve a bean with the given name from Spring/CDI (if available);</p>
</li>
<li>
<p>then try to interpret the string as a fully-qualified class name
and to retrieve the corresponding bean from Spring/CDI (if available);</p>
</li>
<li>
<p>then try to interpret the string as a fully-qualified class name
and to instantiate it through its public, no-argument constructor.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>The following formats are also accepted, but are only useful for advanced use cases:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>any:</code> followed by an arbitrary string.
Equivalent to leaving out the prefix in most cases. Only useful if the arbitrary string contains a colon.</p>
</li>
<li>
<p><code>builtin:</code> followed by the name of a built-in bean,
e.g. <code>simple</code> for the <a href="#backend-elasticsearch-indexlayout">Elasticsearch index layout strategies</a>.
This will not fall back to Spring/CDI or a direct constructor call.</p>
</li>
<li>
<p><code>constructor:</code> followed by the fully-qualified name of a class,
to be instantiated through its public, no-argument constructor.
This will ignore built-in beans and will not try to instantiate the class through Spring/CDI.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="configuration-bean-resolution"><a class="anchor" href="#configuration-bean-resolution"></a>8.4.4. <a id="section-services"></a> Bean resolution</h4>
<div class="paragraph">
<p>Bean resolution (i.e. the process of turning this reference into an object instance)
happens as follows by default:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If the given reference matches a built-in bean, that bean is used.</p>
<div class="paragraph">
<p>Example: the name <code>simple</code>,
when used as the value of the property <code>hibernate.search.backend.layout.strategy</code>
to configure the <a href="#backend-elasticsearch-indexlayout">Elasticsearch index layout strategy</a>,
resolves to the built-in <code>simple</code> strategy.</p>
</div>
</li>
<li>
<p>Otherwise, if a <a href="#configuration-bean-frameworks">supported Dependency Injection (DI) framework</a> is available,
the reference is resolved using the DI framework.</p>
<div class="ulist">
<ul>
<li>
<p>If a managed bean with the given type (and if provided, name) exists, that bean is used.</p>
<div class="paragraph">
<p>Example: the name <code>myLayoutStrategy</code>,
when used as the value of the property <code>hibernate.search.backend.layout.strategy</code>
to configure the <a href="#backend-elasticsearch-indexlayout">Elasticsearch index layout strategy</a>,
resolves to any bean known from CDI/Spring of type <code>IndexLayoutStrategy</code> and annotated with <code>@Named("myLayoutStrategy")</code>.</p>
</div>
</li>
<li>
<p>Otherwise, if a name is given, and that name is a fully-qualified class name,
and a managed bean of that type exists, that bean is used.</p>
<div class="paragraph">
<p>Example: the name <code>com.mycompany.MyLayoutStrategy</code>,
when used as the value of the property <code>hibernate.search.backend.layout.strategy</code>
to configure the <a href="#backend-elasticsearch-indexlayout">Elasticsearch index layout strategy</a>,
resolves to any bean known from CDI/Spring and extending <code>com.mycompany.MyLayoutStrategy</code>.</p>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Otherwise, reflection is used to resolve the bean.</p>
<div class="ulist">
<ul>
<li>
<p>If a name is given, and that name is a fully-qualified class name,
and that class extends the type reference,
an instance is created by invoking the public, no-argument constructor of that class.</p>
<div class="paragraph">
<p>Example: the name <code>com.mycompany.MyLayoutStrategy</code>,
when used as the value of the property <code>hibernate.search.backend.layout.strategy</code>
to configure the <a href="#backend-elasticsearch-indexlayout">Elasticsearch index layout strategy</a>,
resolves to an instance of <code>com.mycompany.MyLayoutStrategy</code>.</p>
</div>
</li>
<li>
<p>If no name is given,
an instance is created by invoking the public, no-argument constructor of the referenced type.</p>
<div class="paragraph">
<p>Example: the class <code>com.mycompany.MyLayoutStrategy.class</code> (a <code>java.lang.Class</code>, not a <code>String</code>),
when used as the value of the property <code>hibernate.search.backend.layout.strategy</code>
to configure the <a href="#backend-elasticsearch-indexlayout">Elasticsearch index layout strategy</a>,
resolves to an instance of <code>com.mycompany.MyLayoutStrategy</code>.</p>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>It is possible to control bean retrieval more finely by selecting a <code>BeanRetrieval</code>;
see the javadoc of <code>org.hibernate.search.engine.environment.bean.BeanRetrieval</code> for more information.
See also <a href="#configuration-bean-reference-parsing">Parsing of bean references</a> for the prefixes that allow to specify the bean retrieval
when referencing a bean from configuration properties.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="configuration-bean-injection"><a class="anchor" href="#configuration-bean-injection"></a>8.4.5. <a id="section-bridge-dependency-injection"></a> Bean injection</h4>
<div class="paragraph">
<p>All beans <a href="#configuration-bean-resolution">resolved by Hibernate Search</a>
using a <a href="#configuration-bean-frameworks">supported framework</a>
can take advantage of injection features of this framework.</p>
</div>
<div class="paragraph">
<p>For example a bean can be injected with another bean
by annotating one of its fields in the bridge with <code>@Inject</code>.</p>
</div>
<div class="paragraph">
<p>Lifecycle annotations such as <code>@PostConstruct</code> should also work as expected.</p>
</div>
<div class="paragraph">
<p>Even when not using any framework,
it is still possible to take advantage of the <code>BeanResolver</code>.
This component, passed to several methods during bootstrap,
exposes several methods to <a href="#configuration-bean-resolution">resolve</a>
a reference into a bean,
exposing programmatically what would usually be achieved with an <code>@Inject</code> annotation.
See the javadoc of <code>BeanResolver</code> for more information.</p>
</div>
</div>
<div class="sect3">
<h4 id="configuration-bean-lifecycle"><a class="anchor" href="#configuration-bean-lifecycle"></a>8.4.6. Bean lifecycle</h4>
<div class="paragraph">
<p>As soon as beans are no longer needed,
Hibernate Search will release them and let the dependency injection framework
call the appropriate methods (<code>@PreDestroy</code>, &#8230;&#8203;).</p>
</div>
<div class="paragraph">
<p>Some beans are only necessary during bootstrap,
such as <code>ElasticsearchAnalysisConfigurer</code>s,
so they will be released just after bootstrap.</p>
</div>
<div class="paragraph">
<p>Other beans are necessary at runtime, such as <code>ValueBridge</code>s,
so they will be released on shutdown.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Be careful to define the scope of your beans as appropriate.</p>
</div>
<div class="paragraph">
<p>Immutable beans or beans used only once such as <code>ElasticsearchAnalysisConfigurer</code>
may be safely assigned any scope.</p>
</div>
<div class="paragraph">
<p>However, some beans are expected to be mutable and instantiated multiple times,
such as for example <code>PropertyBinder</code>.
For these beans, it is recommended to use the "dependent" scope (CDI terminology)
or the "prototype" scope (Spring terminology).
When in doubt, this is also generally the safest choice
for beans injected into Hibernate Search.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Beans <a href="#configuration-bean-resolution">resolved by Hibernate Search</a>
using a <a href="#configuration-bean-frameworks">supported framework</a>
can take advantage of injection features of this framework.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="configuration-global"><a class="anchor" href="#configuration-global"></a>8.5. Global configuration</h3>
<div class="paragraph">
<p>This section presents global configuration, common to all <a href="#architecture-hsearch-components-mapper">mappers</a>
and <a href="#architecture-hsearch-components-backend">backends</a>.</p>
</div>
<div class="sect3">
<h4 id="configuration-background-failure-handling"><a class="anchor" href="#configuration-background-failure-handling"></a>8.5.1. <a id="exception-handling"></a> Background failure handling</h4>
<div class="paragraph">
<p>Hibernate Search generally propagates exceptions occurring in background threads to the user thread,
but in some cases, such as Lucene segment merging failures,
or <a href="#indexing-plan-synchronization-failures">some indexing plan synchronization failures</a>,
the exception in background threads cannot be propagated.
By default, when that happens, the failure is logged at the <code>ERROR</code> level.</p>
</div>
<div class="paragraph">
<p>To customize background failure handling, you will need to:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Define a class that implements the <code>org.hibernate.search.engine.reporting.FailureHandler</code> interface.</p>
</li>
<li>
<p>Configure the backend to use that implementation by setting the configuration property
<code>hibernate.search.background_failure_handler</code>
to a <a href="#configuration-bean-reference-parsing">bean reference</a> pointing to the implementation,
for example <code>class:com.mycompany.MyFailureHandler</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Hibernate Search will call the <code>handle</code> methods whenever a failure occurs.</p>
</div>
<div class="exampleblock">
<div class="title">Example 7. Implementing and using a <code>FailureHandler</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="keyword">package</span> <span class="namespace">org.hibernate.search.documentation.reporting.failurehandler</span>;

<span class="keyword">import</span> <span class="include">org.hibernate.search.engine.common.EntityReference</span>;
<span class="keyword">import</span> <span class="include">org.hibernate.search.engine.reporting.EntityIndexingFailureContext</span>;
<span class="keyword">import</span> <span class="include">org.hibernate.search.engine.reporting.FailureContext</span>;
<span class="keyword">import</span> <span class="include">org.hibernate.search.engine.reporting.FailureHandler</span>;
<span class="keyword">import</span> <span class="include">org.hibernate.search.util.impl.test.extension.StaticCounters</span>;

<span class="directive">public</span> <span class="type">class</span> <span class="class">MyFailureHandler</span> <span class="directive">implements</span> FailureHandler {

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> handle(FailureContext context) { <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="predefined-type">String</span> failingOperationDescription = context.failingOperation().toString(); <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="predefined-type">Throwable</span> throwable = context.throwable(); <i class="conum" data-value="3"></i><b>(3)</b>

        <span class="comment">// ... report the failure ... </span><i class="conum" data-value="4"></i><b>(4)</b>
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> handle(EntityIndexingFailureContext context) { <i class="conum" data-value="5"></i><b>(5)</b>
        <span class="predefined-type">String</span> failingOperationDescription = context.failingOperation().toString();
        <span class="predefined-type">Throwable</span> throwable = context.throwable();
        <span class="keyword">for</span> ( EntityReference entityReference : context.failingEntityReferences() ) { <i class="conum" data-value="6"></i><b>(6)</b>
            <span class="predefined-type">Class</span>&lt;?&gt; entityType = entityReference.type(); <i class="conum" data-value="7"></i><b>(7)</b>
            <span class="predefined-type">String</span> entityName = entityReference.name(); <i class="conum" data-value="7"></i><b>(7)</b>
            <span class="predefined-type">Object</span> entityId = entityReference.id(); <i class="conum" data-value="7"></i><b>(7)</b>
            <span class="predefined-type">String</span> entityReferenceAsString = entityReference.toString(); <i class="conum" data-value="8"></i><b>(8)</b>

            <span class="comment">// ... process the entity reference ... </span><i class="conum" data-value="9"></i><b>(9)</b>
        }
    }

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>handle(FailureContext)</code> is called for generic failures that do not fit any other specialized <code>handle</code> method.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Get a description of the failing operation from the context.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Get the throwable thrown when the operation failed from the context.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Use the context-provided information to report the failure in any relevant way.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td><code>handle(EntityIndexingFailureContext)</code> is called for failures occurring when indexing entities.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>On top of the failing operation and throwable,
the context also lists references to entities that could not be indexed correctly because of the failure.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Entity references expose the entity type, name and identifier.</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>Entity references may be converted to a human-readable string using <code>toString()</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="9"></i><b>9</b></td>
<td>Use the context-provided information to report the failure in any relevant way.</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="XML">hibernate.search.background_failure_handler = class:org.hibernate.search.documentation.reporting.failurehandler.MyFailureHandler</code></pre>
</div>
</div>
<div class="paragraph">
<p>Assign the background failure handler using a Hibernate Search configuration property.</p>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>When a failure handler&#8217;s <code>handle</code> method throws an error or exception,
Hibernate Search will catch it and log it at the ERROR level.
It will not be propagated.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="configuration-multi-tenancy"><a class="anchor" href="#configuration-multi-tenancy"></a>8.5.2. Multi-tenancy</h4>
<div class="paragraph">
<p>If your application uses Hibernate ORM&#8217;s <a href="https://docs.jboss.org/hibernate/orm/6.4/userguide/html_single/Hibernate_User_Guide.html#multitenacy">multi-tenancy support</a>,
or if you <a href="#mapper-pojo-standalone-multi-tenancy">configured multi-tenancy explicitly in the Standalone POJO Mapper</a>,
Hibernate Search should detect that and configure your backends transparently.
For details, see:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#backend-lucene-multi-tenancy">here for Lucene</a></p>
</li>
<li>
<p><a href="#backend-elasticsearch-multi-tenancy">here for Elasticsearch</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In some cases, in particular when <a href="#coordination-outbox-polling-multi-tenancy">using the <code>outbox-polling</code> coordination strategy</a>
or when expecting the <a href="#indexing-massindexer-multitenancy">mass indexer to implicitly target all tenants</a>,
you will need to list explicitly all tenant identifiers that your application might use.
This information is used by Hibernate Search when spawning background processes
that should apply an operation to every tenant.</p>
</div>
<div class="paragraph">
<p>The list of identifiers is defined through the following configuration property:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>hibernate.search.multi_tenancy.tenant_ids = mytenant1,mytenant2,mytenant3</code></pre>
</div>
</div>
<div class="paragraph">
<p>This property may be set to a String containing multiple tenant identifiers separated by commas,
or a <code>Collection&lt;String&gt;</code> containing tenant identifiers.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="entrypoints"><a class="anchor" href="#entrypoints"></a>9. Main API Entry Points</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This section details the main entry points to Hibernate Search APIs at runtime,
i.e. APIs to index, search, look up metadata, &#8230;&#8203;</p>
</div>
<div class="sect2">
<h3 id="entrypoints-search-mapping"><a class="anchor" href="#entrypoints-search-mapping"></a>9.1. <code>SearchMapping</code></h3>
<div class="sect3">
<h4 id="entrypoints-search-mapping-basics"><a class="anchor" href="#entrypoints-search-mapping-basics"></a>9.1.1. Basics</h4>
<div class="paragraph">
<p>The <code>SearchMapping</code> is the top-most entrypoint to Hibernate Search APIs:
it represents the whole mapping from entities to indexes.</p>
</div>
<div class="paragraph">
<p>The <code>SearchMapping</code> is thread-safe: it can safely be used concurrently from multiple threads.
However, that does not mean the objects it returns (<code>SearchWorkspace</code>, &#8230;&#8203;) are themselves thread-safe.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The <code>SearchMapping</code> in Hibernate Search is the equivalent of
the <code>EntityManagerFactory</code>/<code>SessionFactory</code> in JPA/Hibernate ORM.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Some frameworks, such as <a href="https://quarkus.io/">Quarkus</a>,
allow you to simply <a href="https://quarkus.io/guides/hibernate-search-orm-elasticsearch#multiple-persistence-units-attaching-cdi"><code>@Inject</code> the <code>SearchMapping</code></a>
into your CDI beans.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="entrypoints-search-mapping-mapper-orm"><a class="anchor" href="#entrypoints-search-mapping-mapper-orm"></a>9.1.2. Retrieving the <code>SearchMapping</code> with the Hibernate ORM integration</h4>
<div class="paragraph">
<p>With the <a href="#mapper-orm">Hibernate ORM integration</a>,
the <code>SearchMapping</code> is <a href="#mapper-orm-startup">created automatically when Hibernate ORM starts</a>.</p>
</div>
<div class="paragraph">
<p>To retrieve the <code>SearchMapping</code>,
call <code>Search.mapping(&#8230;&#8203;)</code> and pass the <code>EntityManagerFactory</code>/<code>SessionFactory</code>:</p>
</div>
<div class="exampleblock">
<div class="title">Example 8. Retrieving the <code>SearchMapping</code> from a Hibernate ORM <code>SessionFactory</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">SessionFactory sessionFactory = <span class="comment">/* ... */</span> <i class="conum" data-value="1"></i><b>(1)</b>
SearchMapping searchMapping = Search.mapping( sessionFactory ); <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Retrieve the <code>SessionFactory</code>.
Details depend on <a href="#compatibility-framework">your framework</a>, but this is generally achieved by injecting it into your own class,
e.g. by annotating a field of that type with <code>@Inject</code> or <code>@PersistenceUnit</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Call <code>Search.mapping(&#8230;&#8203;)</code>, passing the <code>SessionFactory</code> as an argument.
This will return the <code>SearchMapping</code>.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>Still with the <a href="#mapper-orm">Hibernate ORM integration</a>, the same can be done from a JPA <code>EntityManagerFactory</code>:</p>
</div>
<div class="exampleblock">
<div class="title">Example 9. Retrieving the <code>SearchMapping</code> from a JPA <code>EntityManagerFactory</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">EntityManagerFactory entityManagerFactory = <span class="comment">/* ... */</span> <i class="conum" data-value="1"></i><b>(1)</b>
SearchMapping searchMapping = Search.mapping( entityManagerFactory ); <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Retrieve the <code>EntityManagerFactory</code>.
Details depend on <a href="#compatibility-framework">your framework</a>, but this is generally achieved by injecting it into your own class,
e.g. by annotating a field of that type with <code>@Inject</code> or <code>@PersistenceUnit</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Call <code>Search.mapping(&#8230;&#8203;)</code>, passing the <code>EntityManagerFactory</code> as an argument.
This will return the <code>SearchMapping</code>.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="entrypoints-search-mapping-mapper-pojo-standalone"><a class="anchor" href="#entrypoints-search-mapping-mapper-pojo-standalone"></a>9.1.3. Retrieving the <code>SearchMapping</code> with the Standalone POJO Mapper</h4>
<div class="paragraph">
<p>With the <a href="#mapper-pojo-standalone">Standalone POJO Mapper</a>,
the <code>SearchMapping</code> is the result of starting Hibernate Search.</p>
</div>
<div class="paragraph">
<p>See <a href="#mapper-pojo-standalone-startup">this section</a> for more information
about starting Hibernate Search with the Standalone POJO Mapper.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="entrypoints-search-session"><a class="anchor" href="#entrypoints-search-session"></a>9.2. <code>SearchSession</code></h3>
<div class="sect3">
<h4 id="entrypoints-search-session-basics"><a class="anchor" href="#entrypoints-search-session-basics"></a>9.2.1. Basics</h4>
<div class="paragraph">
<p>The <code>SearchSession</code> represents the context in which a sequence of related operations are executed.
It should generally be used for a very short time, for example to process a single web request.</p>
</div>
<div class="paragraph">
<p>The <code>SearchSession</code> is <strong>not</strong> thread-safe: it must not be used concurrently from multiple threads.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The <code>SearchSession</code> in Hibernate Search is the equivalent of
the <code>EntityManager</code>/<code>Session</code> in JPA/Hibernate ORM.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Some frameworks, such as <a href="https://quarkus.io/">Quarkus</a>,
allow you to simply <a href="https://quarkus.io/guides/hibernate-search-orm-elasticsearch#multiple-persistence-units-attaching-cdi"><code>@Inject</code> the <code>SearchSession</code></a>
into your CDI beans.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="entrypoints-search-session-mapper-orm"><a class="anchor" href="#entrypoints-search-session-mapper-orm"></a>9.2.2. Retrieving the <code>SearchSession</code> with the Hibernate ORM integration</h4>
<div class="paragraph">
<p>To retrieve the <code>SearchSession</code> with the <a href="#mapper-orm">Hibernate ORM integration</a>,
call <code>Search.session(&#8230;&#8203;)</code> and pass the <code>EntityManager</code>/<code>Session</code>:</p>
</div>
<div class="exampleblock">
<div class="title">Example 10. Retrieving the <code>SearchSession</code> from a Hibernate ORM <code>Session</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">Session session = <span class="comment">/* ... */</span> <i class="conum" data-value="1"></i><b>(1)</b>
SearchSession searchSession = Search.session( session ); <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Retrieve the <code>Session</code>.
Details depend on <a href="#compatibility-framework">your framework</a>, but this is generally achieved by injecting it into your own class,
e.g. by annotating a field of that type with <code>@Inject</code> or <code>@PersistenceContext</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Call <code>Search.session(&#8230;&#8203;)</code>, passing the <code>Session</code> as an argument.
This will return the <code>SearchSession</code>.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>Still with the <a href="#mapper-orm">Hibernate ORM integration</a>, the same can be done from a JPA <code>EntityManager</code>:</p>
</div>
<div class="exampleblock">
<div class="title">Example 11. Retrieving the <code>SearchSession</code> from a JPA <code>EntityManager</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">EntityManager entityManager = <span class="comment">/* ... */</span> <i class="conum" data-value="1"></i><b>(1)</b>
SearchSession searchSession = Search.session( entityManager ); <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Retrieve the <code>EntityManager</code>.
Details depend on <a href="#compatibility-framework">your framework</a>, but this is generally achieved by injecting it into your own class,
e.g. by annotating a field of that type with <code>@Inject</code> or <code>@PersistenceContext</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Call <code>Search.mapping(&#8230;&#8203;)</code>, passing the <code>EntityManager</code> as an argument.
This will return the <code>SearchSession</code>.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="entrypoints-search-session-mapper-pojo-standalone"><a class="anchor" href="#entrypoints-search-session-mapper-pojo-standalone"></a>9.2.3. Retrieving the <code>SearchSession</code> with the Standalone POJO Mapper</h4>
<div class="paragraph">
<p>With the <a href="#mapper-pojo-standalone">Standalone POJO Mapper</a>,
the <code>SearchSession</code> should be created and closed explicitly:</p>
</div>
<div class="exampleblock">
<div class="title">Example 12. Creating the <code>SearchSession</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">SearchMapping searchMapping = <span class="comment">/* ... */</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="keyword">try</span> ( SearchSession searchSession = searchMapping.createSession() ) { <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="comment">// ...</span>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><a href="#entrypoints-search-mapping-mapper-pojo-standalone">Retrieve the <code>SearchMapping</code></a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Create a new session.
Note we&#8217;re using a try-with-resources block,
so that the session will automatically be closed when we&#8217;re done with it,
which will in particular trigger the execution of the <a href="#indexing-plan">indexing plan</a>.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Forgetting to close the <code>SearchSession</code> will lead to indexing not being executed,
and may even cause memory leaks.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <code>SearchSession</code> can also be configured with a few options:</p>
</div>
<div class="exampleblock">
<div class="title">Example 13. Creating the <code>SearchSession</code> with options</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">SearchMapping searchMapping = <span class="comment">/* ... */</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="keyword">try</span> ( SearchSession searchSession = searchMapping.createSessionWithOptions() <i class="conum" data-value="2"></i><b>(2)</b>
        .indexingPlanSynchronizationStrategy( IndexingPlanSynchronizationStrategy.sync() )<i class="conum" data-value="3"></i><b>(3)</b>
        .tenantId( <span class="string"><span class="delimiter">&quot;</span><span class="content">myTenant</span><span class="delimiter">&quot;</span></span> )
        .build() ) { <i class="conum" data-value="4"></i><b>(4)</b>
    <span class="comment">// ...</span>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><a href="#entrypoints-search-mapping-mapper-pojo-standalone">Retrieve the <code>SearchMapping</code></a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Start creating a new session.
Note we&#8217;re using a try-with-resources block,
so that the session will automatically be closed when we&#8217;re done with it,
which will in particular trigger the execution of the <a href="#indexing-plan">indexing plan</a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Pass options to the new session.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Build the new session.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="entrypoints-search-scope"><a class="anchor" href="#entrypoints-search-scope"></a>9.3. <code>SearchScope</code></h3>
<div class="paragraph">
<p>The <code>SearchScope</code> represents a set of indexed entities and their indexes.</p>
</div>
<div class="paragraph">
<p>The <code>SearchScope</code> is thread-safe: it can safely be used concurrently from multiple threads.
However, that does not mean the objects it returns (<code>SearchWorkspace</code>, &#8230;&#8203;) are themselves thread-safe.</p>
</div>
<div class="paragraph">
<p>A <code>SearchScope</code> can be retrieved from a <a href="#entrypoints-search-mapping"><code>SearchMapping</code></a> as well as from a <a href="#entrypoints-search-session"><code>SearchSession</code></a>.</p>
</div>
<div class="exampleblock">
<div class="title">Example 14. Retrieving a <code>SearchScope</code> from a <code>SearchMapping</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">SearchMapping searchMapping = <span class="comment">/* ... */</span> <i class="conum" data-value="1"></i><b>(1)</b>
SearchScope&lt;<span class="predefined-type">Book</span>&gt; bookScope = searchMapping.scope( <span class="predefined-type">Book</span>.class ); <i class="conum" data-value="2"></i><b>(2)</b>
SearchScope&lt;Person&gt; associateAndManagerScope = searchMapping.scope( <span class="predefined-type">Arrays</span>.asList( Associate.class, Manager.class ) ); <i class="conum" data-value="3"></i><b>(3)</b>
SearchScope&lt;Person&gt; personScope = searchMapping.scope( Person.class ); <i class="conum" data-value="4"></i><b>(4)</b>
SearchScope&lt;Person&gt; personSubTypesScope = searchMapping.scope( Person.class,
        <span class="predefined-type">Arrays</span>.asList( <span class="string"><span class="delimiter">&quot;</span><span class="content">Manager</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Associate</span><span class="delimiter">&quot;</span></span> ) ); <i class="conum" data-value="5"></i><b>(5)</b>
SearchScope&lt;<span class="predefined-type">Object</span>&gt; allScope = searchMapping.scope( <span class="predefined-type">Object</span>.class ); <i class="conum" data-value="6"></i><b>(6)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><a href="#entrypoints-search-mapping">Retrieve the <code>SearchMapping</code></a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Create a <code>SearchScope</code> targeting the <code>Book</code> entity type only.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Create a <code>SearchScope</code> targeting both the <code>Associate</code> entity type and the <code>Manager</code> entity type.
The scope&#8217;s generic type parameter can be any common supertype of those entity types.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>A scope will always target all subtypes of the given classes, and the given classes do not need to be indexed entity types themselves.
This creates a <code>SearchScope</code> targeting all (indexed entity) subtypes of the <code>Person</code> interface;
in our case this will target both the <code>Associate</code> entity type and the <code>Manager</code> entity type.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>For advanced use cases,
it is possible to target entity types by their name.
For <a href="#mapper-orm">Hibernate ORM</a> this would be the JPA entity name,
and for the <a href="#mapper-pojo-standalone">Standalone POJO Mapper</a>
this would be the name assigned to the entity type upon <a href="#mapping-entitydefinition">entity definition</a>.
In both cases, the entity name is the simple name of the Java class by default.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Passing <code>Object.class</code> will create a scope targeting every single indexed entity types.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 15. Retrieving a <code>SearchScope</code> from a <code>SearchSession</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">SearchSession searchSession = <span class="comment">/* ... */</span> <i class="conum" data-value="1"></i><b>(1)</b>
SearchScope&lt;<span class="predefined-type">Book</span>&gt; bookScope = searchSession.scope( <span class="predefined-type">Book</span>.class ); <i class="conum" data-value="2"></i><b>(2)</b>
SearchScope&lt;Person&gt; associateAndManagerScope =
        searchSession.scope( <span class="predefined-type">Arrays</span>.asList( Associate.class, Manager.class ) ); <i class="conum" data-value="3"></i><b>(3)</b>
SearchScope&lt;Person&gt; personScope = searchSession.scope( Person.class ); <i class="conum" data-value="4"></i><b>(4)</b>
SearchScope&lt;Person&gt; personSubTypesScope = searchSession.scope( Person.class,
        <span class="predefined-type">Arrays</span>.asList( <span class="string"><span class="delimiter">&quot;</span><span class="content">Manager</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Associate</span><span class="delimiter">&quot;</span></span> ) ); <i class="conum" data-value="5"></i><b>(5)</b>
SearchScope&lt;<span class="predefined-type">Object</span>&gt; allScope = searchSession.scope( <span class="predefined-type">Object</span>.class ); <i class="conum" data-value="6"></i><b>(6)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><a href="#entrypoints-search-session">Retrieve the <code>SearchSession</code></a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Create a <code>SearchScope</code> targeting the <code>Book</code> entity type only.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Create a <code>SearchScope</code> targeting both the <code>Associate</code> entity type and the <code>Manager</code> entity type.
The scope&#8217;s generic type parameter can be any common supertype of those entity types.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>A scope will always target all subtypes of the given classes, and the given classes do not need to be indexed entity types themselves.
This creates a <code>SearchScope</code> targeting all (indexed entity) subtypes of the <code>Person</code> interface;
in our case this will target both the <code>Associate</code> entity type and the <code>Manager</code> entity type.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>For advanced use cases,
it is possible to target entity types by their name.
For <a href="#mapper-orm">Hibernate ORM</a> this would be the JPA entity name,
and for the <a href="#mapper-pojo-standalone">Standalone POJO Mapper</a>
this would be the name assigned to the entity type upon <a href="#mapping-entitydefinition">entity definition</a>.
In both cases, the entity name is the simple name of the Java class by default.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Passing <code>Object.class</code> will create a scope targeting every single indexed entity types.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="mapping"><a class="anchor" href="#mapping"></a>10. <a id="mapper-orm-mapping"></a> <a id="search-mapping"></a> Mapping entities to indexes</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="mapping-configuration"><a class="anchor" href="#mapping-configuration"></a>10.1. <a id="mapper-orm-mapping-configuration-mapping"></a> <a id="_configuring_the_mapping"></a> Configuring the mapping</h3>
<div class="sect3">
<h4 id="mapping-annotations"><a class="anchor" href="#mapping-annotations"></a>10.1.1. Annotation-based mapping</h4>
<div class="paragraph">
<p>The main way to map entities to indexes is through annotations,
as explained in <a href="#mapping-entitydefinition">Entity definition</a>, <a href="#mapping-entityindexmapping"> Entity/index mapping</a> and the following sections.</p>
</div>
<div class="paragraph">
<p>By default, Hibernate Search will automatically process mapping annotations for entity types,
as well as nested types in those entity types, for instance embedded types.</p>
</div>
<div class="paragraph">
<p>Annotation-based mapping can be disabled by setting <code>hibernate.search.mapping.process_annotations</code> to <code>false</code>
for the <a href="#mapper-orm">Hibernate ORM integration</a>,
or through <code>AnnotationMappingConfigurationContext</code> for any mapper:
see <a href="#mapping-configurer">Mapping configurer</a> to access that context,
and see the javadoc of <code>AnnotationMappingConfigurationContext</code> for available options.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you disable annotation-based mapping, you will probably need to configure the mapping programmatically:
see <a href="#mapping-programmatic">   Programmatic mapping</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Hibernate Search will also try to find some annotated types through <a href="#mapping-classpath-scanning">classpath scanning</a>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>See <a href="#mapping-entitydefinition">Entity definition</a>, <a href="#mapping-entityindexmapping"> Entity/index mapping</a> and <a href="#mapping-directfieldmapping"> Mapping a property to an index field with <code>@GenericField</code>, <code>@FullTextField</code>, &#8230;&#8203;</a>
to get started with annotation-based mapping.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="mapping-classpath-scanning"><a class="anchor" href="#mapping-classpath-scanning"></a>10.1.2. <a id="mapper-orm-mapping-configuration-scanning"></a> Classpath scanning</h4>
<div class="sect4">
<h5 id="mapping-classpath-scanning-basics"><a class="anchor" href="#mapping-classpath-scanning-basics"></a><a id="mapper-orm-mapping-configuration-scanning-basics"></a> Basics</h5>
<div class="paragraph">
<p>Hibernate Search will automatically scan the JARs of entity types on startup,
looking for types annotated with "root mapping annotations"
so that it can automatically add those types to the list of types whose annotations should be processed.</p>
</div>
<div class="paragraph">
<p>Root mapping annotations are mapping annotations that serve as the entrypoint to a mapping,
for example <a href="#mapping-projection"><code>@ProjectionConstructor</code></a>
or <a href="#mapping-custom-annotations-root">custom root mapping annotations</a>.
Without this scanning, Hibernate Search would learn about e.g. projection constructors too late
(when the projection is actually executed) and would fail due to a lack of metadata.</p>
</div>
<div class="paragraph">
<p>The scanning is backed by <a href="https://smallrye.io/jandex/">Jandex</a>, a library that indexes the content of JARs.</p>
</div>
</div>
<div class="sect4">
<h5 id="mapping-classpath-scanning-dependencies"><a class="anchor" href="#mapping-classpath-scanning-dependencies"></a><a id="mapper-orm-mapping-configuration-scanning-dependencies"></a> Scanning dependencies of the application</h5>
<div class="paragraph">
<p>By default, Hibernate Search will only scan the JARs containing your Hibernate ORM entities.</p>
</div>
<div class="paragraph">
<p>If you want Hibernate Search to detect types annotated
with <a href="#mapping-classpath-scanning-basics">root mapping annotations</a> in other JARs,
you will first need to <a href="#mapping-configurer">access an <code>AnnotationMappingConfigurationContext</code></a>.</p>
</div>
<div class="paragraph">
<p>From that context, either:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>call <code>annotationMappingContext.add( MyType.class )</code> to explicitly tell Hibernate Search
to process annotation on <code>MyType</code>, and to discover other types annotated with
<a href="#mapping-classpath-scanning-basics">root mapping annotations</a> in the JAR containing <code>MyType</code>.</p>
</li>
<li>
<p>OR (advanced usage, incubating) call <code>annotationMappingContext.addJandexIndex( &lt;an IndexView instance&gt; )</code> to explicitly tell Hibernate Search
to look for types annotated with
<a href="#mapping-classpath-scanning-basics">root mapping annotations</a> in the given Jandex index.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="mapping-classpath-scanning-faster"><a class="anchor" href="#mapping-classpath-scanning-faster"></a><a id="mapper-orm-mapping-configuration-scanning-faster"></a> Faster scanning</h5>
<div class="paragraph">
<p>Hibernate Search&#8217;s scanning may trigger the indexing of JARs through Jandex on application startup.
This indexing should be reasonably short, but if it causes performance issues, you can:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Migrate your application to the <a href="#compatibility-framework-quarkus">Quarkus</a> framework,
which among other things executes this part of Hibernate Search&#8217;s startup at build time.</p>
</li>
<li>
<p>OR migrate your application to the <a href="#compatibility-framework-wildfly">WildFly</a> application server,
which among other things executes this part of Hibernate Search&#8217;s startup in a more optimized way.</p>
</li>
<li>
<p>OR execute the <a href="https://smallrye.io/jandex/">Jandex</a> Maven Plugin
during the build of your application, so that indexes are already built when the application starts.</p>
</li>
<li>
<p>OR instruct Hibernate Search to never build Jandex indexes on startup,
by setting the configuration property
<code>hibernate.search.mapping.build_missing_discovered_jandex_indexes</code> to <code>false</code>.
<strong>This is not recommended as it may lead to bootstrap failures or ignored mapping annotations</strong>
because Hibernate Search will no longer be able to automatically discover types annotated with
<a href="#mapping-classpath-scanning-basics">root annotations</a>
in JARs that do not have an embedded Jandex index.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="mapping-programmatic"><a class="anchor" href="#mapping-programmatic"></a>10.1.3. <a id="mapper-orm-programmatic-mapping"></a> <a id="mapper-orm-programmatic-mapping-basics"></a> <a id="hsearch-mapping-programmaticapi"></a> Programmatic mapping</h4>
<div class="paragraph">
<p>Most examples in this documentation use annotation-based mapping,
which is generally enough for most applications.
However, some applications have needs that go beyond what annotations can offer:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>a single entity type must be mapped differently for different deployments&#8201;&#8212;&#8201;e.g. for different customers.</p>
</li>
<li>
<p>many entity types must be mapped similarly, without code duplication.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To address those needs, you can use <em>programmatic</em> mapping:
define the mapping through code that will get executed on startup.</p>
</div>
<div class="paragraph">
<p>Programmatic mapping is configured through <code>ProgrammaticMappingConfigurationContext</code>:
see <a href="#mapping-configurer">Mapping configurer</a> to access that context.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>By default, programmatic mapping will be merged with annotation mapping (if any).</p>
</div>
<div class="paragraph">
<p>To disable annotation mapping, see <a href="#mapping-annotations">Annotation-based mapping</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Programmatic mapping is declarative and exposes the exact same features as annotation-based mapping.</p>
</div>
<div class="paragraph">
<p>In order to implement more complex, "imperative" mapping,
for example to combine two entity properties into a single index field,
use <a href="#binding">custom bridges</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Alternatively, if you only need to repeat the same mapping for several types or properties,
you can apply a custom annotation on those types or properties,
and have Hibernate Search execute some programmatic mapping code when it encounters that annotation.
This solution doesn&#8217;t require mapper-specific configuration.</p>
</div>
<div class="paragraph">
<p>See <a href="#mapping-custom-annotations"> Custom mapping annotations</a> for more information.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="mapping-configurer"><a class="anchor" href="#mapping-configurer"></a>10.1.4. Mapping configurer</h4>
<div class="sect4">
<h5 id="mapper-orm-mapping-configurer"><a class="anchor" href="#mapper-orm-mapping-configurer"></a>Hibernate ORM integration</h5>
<div class="paragraph">
<p>With the Hibernate ORM integration, a custom <code>HibernateOrmSearchMappingConfigurer</code> can be plugged into Hibernate Search in order to configure
annotation mapping (<code>AnnotationMappingConfigurationContext</code>),
programmatic mapping (<code>ProgrammaticMappingConfigurationContext</code>), and more.</p>
</div>
<div class="paragraph">
<p>Plugging in a custom configurer requires two steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Define a class that implements the <code>org.hibernate.search.mapper.orm.mapping.HibernateOrmSearchMappingConfigurer</code> interface.</p>
</li>
<li>
<p>Configure Hibernate Search to use that implementation by setting the configuration property
<code>hibernate.search.mapping.configurer</code>
to a <a href="#configuration-bean-reference-parsing">bean reference</a> pointing to the implementation,
for example <code>class:com.mycompany.MyMappingConfigurer</code>.</p>
</li>
</ol>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
You can pass multiple bean references separated by commas. See <a href="#configuration-property-types">Type of configuration properties</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Hibernate Search will call the <code>configure</code> method of this implementation on startup,
and the configurer will be able to take advantage of a DSL to
configure annotation mapping or
define the programmatic mapping, for example:</p>
</div>
<div class="exampleblock">
<div class="title">Example 16. Implementing a mapping configurer with the Hibernate ORM integration</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="directive">public</span> <span class="type">class</span> <span class="class">MySearchMappingConfigurer</span> <span class="directive">implements</span> HibernateOrmSearchMappingConfigurer {
    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> configure(HibernateOrmMappingConfigurationContext context) {
        ProgrammaticMappingConfigurationContext mapping = context.programmaticMapping(); <i class="conum" data-value="1"></i><b>(1)</b>
        TypeMappingStep bookMapping = mapping.type( <span class="predefined-type">Book</span>.class ); <i class="conum" data-value="2"></i><b>(2)</b>
        bookMapping.indexed(); <i class="conum" data-value="3"></i><b>(3)</b>
        bookMapping.property( <span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span> ) <i class="conum" data-value="4"></i><b>(4)</b>
                .fullTextField().analyzer( <span class="string"><span class="delimiter">&quot;</span><span class="content">english</span><span class="delimiter">&quot;</span></span> ); <i class="conum" data-value="5"></i><b>(5)</b>
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Access the programmatic mapping.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Access the programmatic mapping of type <code>Book</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Define <code>Book</code> as <a href="#mapping-entityindexmapping-programmatic">indexed</a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Access the programmatic mapping of property <code>title</code> of type <code>Book</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Define an <a href="#mapping-directfieldmapping-programmatic">index field</a> based on property <code>title</code> of type <code>Book</code>.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="mapper-pojo-standalone-mapping-configurer"><a class="anchor" href="#mapper-pojo-standalone-mapping-configurer"></a>Standalone POJO Mapper</h5>
<div class="paragraph">
<p>The Standalone POJO Mapper does not offer a "mapping configurer" at the moment
(<a href="https://hibernate.atlassian.net/browse/HSEARCH-4615">HSEARCH-4615</a>).
However, <code>AnnotationMappingConfigurationContext</code>
and <code>ProgrammaticMappingConfigurationContext</code>
can be accessed when building the <code>SearchMapping</code>:</p>
</div>
<div class="paragraph">
<p>With the Hibernate ORM integration, a custom <code>StandalonePojoMappingConfigurer</code>
can be plugged into Hibernate Search in order to configure
annotation mapping (<code>AnnotationMappingConfigurationContext</code>),
programmatic mapping (<code>ProgrammaticMappingConfigurationContext</code>), and more.</p>
</div>
<div class="paragraph">
<p>Plugging in a custom configurer requires two steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Define a class that implements the <code>org.hibernate.search.mapper.pojo.standalone.mapping.StandalonePojoMappingConfigurer</code> interface.</p>
</li>
<li>
<p>Configure Hibernate Search to use that implementation by setting the configuration property
<code>hibernate.search.mapping.configurer</code>
to a <a href="#configuration-bean-reference-parsing">bean reference</a> pointing to the implementation,
for example <code>class:com.mycompany.MyMappingConfigurer</code>.</p>
</li>
</ol>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
You can pass multiple bean references separated by commas. See <a href="#configuration-property-types">Type of configuration properties</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Hibernate Search will call the <code>configure</code> method of this implementation on startup,
and the configurer will be able to take advantage of a DSL to
configure annotation mapping or
define the programmatic mapping, for example:</p>
</div>
<div class="exampleblock">
<div class="title">Example 17. Implementing a mapping configurer with the Standalone POJO Mapper</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="directive">public</span> <span class="type">class</span> <span class="class">MySearchMappingConfigurer</span> <span class="directive">implements</span> StandalonePojoMappingConfigurer {
    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> configure(StandalonePojoMappingConfigurationContext context) {
        context.annotationMapping() <i class="conum" data-value="1"></i><b>(1)</b>
                .discoverAnnotationsFromReferencedTypes( <span class="predefined-constant">false</span> )
                .discoverAnnotatedTypesFromRootMappingAnnotations( <span class="predefined-constant">false</span> );

        ProgrammaticMappingConfigurationContext mappingContext = context.programmaticMapping(); <i class="conum" data-value="2"></i><b>(2)</b>
        TypeMappingStep bookMapping = mappingContext.type( <span class="predefined-type">Book</span>.class ); <i class="conum" data-value="3"></i><b>(3)</b>
        bookMapping.searchEntity(); <i class="conum" data-value="4"></i><b>(4)</b>
        bookMapping.indexed(); <i class="conum" data-value="5"></i><b>(5)</b>
        bookMapping.property( <span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span> ) <i class="conum" data-value="6"></i><b>(6)</b>
                .documentId(); <i class="conum" data-value="7"></i><b>(7)</b>
        bookMapping.property( <span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span> ) <i class="conum" data-value="8"></i><b>(8)</b>
                .fullTextField().analyzer( <span class="string"><span class="delimiter">&quot;</span><span class="content">english</span><span class="delimiter">&quot;</span></span> ); <i class="conum" data-value="9"></i><b>(9)</b>
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Access the annotation mapping context to configure annotation mapping.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Access the programmatic mapping context to configure programmatic mapping.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Access the programmatic mapping of type <code>Book</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Define <code>Book</code> as <a href="#mapping-entitydefinition-explicit">an entity type</a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Define <code>Book</code> as <a href="#mapping-entityindexmapping-programmatic">indexed</a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Access the programmatic mapping of property <code>id</code> of type <code>Book</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td><a href="#mapping-identifiermapping-explicit">Define the identifier</a> of type <code>Book</code> as its property <code>id</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>Access the programmatic mapping of property <code>title</code> of type <code>Book</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="9"></i><b>9</b></td>
<td>Define an <a href="#mapping-directfieldmapping-programmatic">index field</a> based on property <code>title</code> of type <code>Book</code>.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="mapping-entitydefinition"><a class="anchor" href="#mapping-entitydefinition"></a>10.2. Entity definition</h3>
<div class="sect3">
<h4 id="mapping-entitydefinition-basics"><a class="anchor" href="#mapping-entitydefinition-basics"></a>10.2.1. Basics</h4>
<div class="paragraph">
<p>Before a type can be <a href="#mapping-entityindexmapping">mapped to indexes</a>,
Hibernate Search needs to be aware of which types
in the application domain model are <a href="#concepts-entity">entity types</a>.</p>
</div>
<div class="paragraph">
<p>When <a href="#mapper-orm">indexing Hibernate ORM entities</a>,
the entity types are fully defined by Hibernate ORM (generally through Jakarta&#8217;s <code>@Entity</code> annotation),
and no explicit definition is necessary: <strong>you can safely skip this entire section</strong>.</p>
</div>
<div class="paragraph">
<p>When using the <a href="#mapper-pojo-standalone">Standalone POJO Mapper</a>,
entity types need to be <a href="#mapping-entitydefinition-explicit">defined explicitly</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="mapping-entitydefinition-explicit"><a class="anchor" href="#mapping-entitydefinition-explicit"></a>10.2.2. Explicit entity definition</h4>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Features detailed below are <em>incubating</em>: they are still under active development.</p>
</div>
<div class="paragraph">
<p>The usual <a href="https://hibernate.org/community/compatibility-policy/">compatibility policy</a> does not apply:
the contract of incubating elements (e.g. types, methods, configuration properties, etc.)
may be altered in a backward-incompatible way&#8201;&#8212;&#8201;or even removed&#8201;&#8212;&#8201;in subsequent releases.</p>
</div>
<div class="paragraph">
<p>You are encouraged to use incubating features so the development team can get feedback and improve them,
but you should be prepared to update code which relies on them as needed.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p><code>@SearchEntity</code> and its corresponding programmatic mapping <code>.searchEntity()</code>
are unnecessary for Hibernate ORM entities,
and in fact unsupported when using the <a href="#mapper-orm">Hibernate ORM integration</a>.</p>
</div>
<div class="paragraph">
<p>See <a href="https://hibernate.atlassian.net/browse/HSEARCH-5076">HSEARCH-5076</a>
to track progress on allowing the use of <code>@SearchEntity</code> in the Hibernate ORM integration
to map non-ORM entities.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>With the <a href="#mapper-pojo-standalone">Standalone POJO Mapper</a>,
<a href="#concepts-entity">entity types</a> must be marked explicitly with the <code>@SearchEntity</code> annotation.</p>
</div>
<div class="exampleblock">
<div class="title">Example 18. Marking a class as an entity with <code>@SearchEntity</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="annotation">@SearchEntity</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="annotation">@Indexed</span> <i class="conum" data-value="2"></i><b>(2)</b>
<span class="directive">public</span> <span class="type">class</span> <span class="class">Book</span> {</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Annotate the type with <code>@SearchEntity</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>@Indexed</code> is optional: it is only necessary if you intend to <a href="#mapping-entityindexmapping">map this type to an index</a>.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Not all types are entity types, even if they have a composite structure.</p>
</div>
<div class="paragraph">
<p>Incorrectly marking types as entity types may force you to add unnecessary complexity to your domain model,
such as <a href="#mapping-identifiermapping-explicit">defining identifiers</a>
or <a href="#mapping-reindexing-associationinverseside">an inverse side for "associations" to such types</a>
that won&#8217;t get used.</p>
</div>
<div class="paragraph">
<p>Make sure to read <a href="#concepts-entity">this section</a> for more information on
what entity types are and why they are necessary.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Subclasses do <strong>not</strong> inherit the <code>@SearchEntity</code> annotation.</p>
</div>
<div class="paragraph">
<p>Each subclass must be annotated with <code>@SearchEntity</code> as well,
or it will not be considered as an entity by Hibernate Search.</p>
</div>
<div class="paragraph">
<p>However, for subclasses that are also annotated with <code>@SearchEntity</code>,
some entity-related configuration can be inherited;
see the relevant sections for details.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>By default, with the <a href="#mapper-pojo-standalone">Standalone POJO Mapper</a>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The <a href="#mapping-entitydefinition-name">entity name</a>
will be equal to the class' simple name (<code>java.lang.Class#getSimpleName</code>).</p>
</li>
<li>
<p>The entity will not be configured for loading,
be it to <a href="#mapping-entitydefinition-loading-selection">return entities as hits in search queries</a>
or for <a href="#mapping-entitydefinition-loading-mass">mass indexing</a>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>See the following sections to override these defaults.</p>
</div>
</div>
<div class="sect3">
<h4 id="mapping-entitydefinition-name"><a class="anchor" href="#mapping-entitydefinition-name"></a>10.2.3. Entity name</h4>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Features detailed below are <em>incubating</em>: they are still under active development.</p>
</div>
<div class="paragraph">
<p>The usual <a href="https://hibernate.org/community/compatibility-policy/">compatibility policy</a> does not apply:
the contract of incubating elements (e.g. types, methods, configuration properties, etc.)
may be altered in a backward-incompatible way&#8201;&#8212;&#8201;or even removed&#8201;&#8212;&#8201;in subsequent releases.</p>
</div>
<div class="paragraph">
<p>You are encouraged to use incubating features so the development team can get feedback and improve them,
but you should be prepared to update code which relies on them as needed.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <a href="#concepts-entity">entity</a> name,
distinct from the name of the corresponding class,
is involved in various places, including but not limited to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>as the default index name for <a href="#mapping-entityindexmapping"><code>@Indexed</code></a>;</p>
</li>
<li>
<p>for <a href="#backend-elasticsearch-type-name">entity type name mapping in Elasticsearch</a>;</p>
</li>
<li>
<p>to <a href="#search-dsl-query-targeting-entityName">target entity types using a String</a>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The entity name defaults to the class' simple name (<code>java.lang.Class#getSimpleName</code>).</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Changing the entity name of an <a href="#mapping-entityindexmapping">indexed</a> entity
may require <a href="#indexing-massindexer">full reindexing</a>,
in particular when using the <a href="#backend-elasticsearch">Elasticsearch/OpenSearch backend</a>.</p>
</div>
<div class="paragraph">
<p>See <a href="#backend-elasticsearch-type-name-discriminator">this section</a> for more information.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>With the <a href="#mapper-orm">Hibernate ORM integration</a>,
this name may be overridden through various means,
but usually is through Jakarta Persistence&#8217;s <code>@Entity</code> annotation,
i.e. with <code>@Entity(name = &#8230;&#8203;)</code>.</p>
</div>
<div class="paragraph">
<p>With the <a href="#mapper-pojo-standalone">Standalone POJO Mapper</a>,
entity types are <a href="#mapping-entitydefinition-explicit">defined with <code>@SearchEntity</code></a>,
and the entity name may be overridden with <code>@SearchEntity(name = &#8230;&#8203;)</code>.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p><code>@SearchEntity</code> and its corresponding programmatic mapping <code>.searchEntity()</code>
are unnecessary for Hibernate ORM entities,
and in fact unsupported when using the <a href="#mapper-orm">Hibernate ORM integration</a>.</p>
</div>
<div class="paragraph">
<p>See <a href="https://hibernate.atlassian.net/browse/HSEARCH-5076">HSEARCH-5076</a>
to track progress on allowing the use of <code>@SearchEntity</code> in the Hibernate ORM integration
to map non-ORM entities.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="exampleblock">
<div class="title">Example 19. Setting a custom entity name with <code>@SearchEntity(name = &#8230;&#8203;)</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="annotation">@SearchEntity</span>(name = <span class="string"><span class="delimiter">&quot;</span><span class="content">MyAuthorName</span><span class="delimiter">&quot;</span></span>)
<span class="annotation">@Indexed</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">Author</span> {</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="mapping-entitydefinition-loading-mass"><a class="anchor" href="#mapping-entitydefinition-loading-mass"></a>10.2.4. Mass loading strategy</h4>
<div class="paragraph">
<p>A "mass loading strategy" gives Hibernate Search
the ability to load entities of a given type
for <a href="#indexing-massindexer">mass indexing</a>.</p>
</div>
<div class="paragraph">
<p>With the <a href="#mapper-orm">Hibernate ORM integration</a>,
a mass loading strategy gets configured automatically for every single Hibernate ORM entity,
and no further configuration is required.</p>
</div>
<div class="paragraph">
<p>With the <a href="#mapper-pojo-standalone">Standalone POJO Mapper</a>,
entity types are <a href="#mapping-entitydefinition-explicit">defined with <code>@SearchEntity</code></a>,
and, in order to take advantage of mass indexing,
a mass loading strategy must be applied explicitly
with <code>@SearchEntity(loadingBinder = &#8230;&#8203;)</code>.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Features detailed below are <em>incubating</em>: they are still under active development.</p>
</div>
<div class="paragraph">
<p>The usual <a href="https://hibernate.org/community/compatibility-policy/">compatibility policy</a> does not apply:
the contract of incubating elements (e.g. types, methods, configuration properties, etc.)
may be altered in a backward-incompatible way&#8201;&#8212;&#8201;or even removed&#8201;&#8212;&#8201;in subsequent releases.</p>
</div>
<div class="paragraph">
<p>You are encouraged to use incubating features so the development team can get feedback and improve them,
but you should be prepared to update code which relies on them as needed.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p><code>@SearchEntity</code> and its corresponding programmatic mapping <code>.searchEntity()</code>
are unnecessary for Hibernate ORM entities,
and in fact unsupported when using the <a href="#mapper-orm">Hibernate ORM integration</a>.</p>
</div>
<div class="paragraph">
<p>See <a href="https://hibernate.atlassian.net/browse/HSEARCH-5076">HSEARCH-5076</a>
to track progress on allowing the use of <code>@SearchEntity</code> in the Hibernate ORM integration
to map non-ORM entities.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="exampleblock">
<div class="title">Example 20. Assigning a mass loading strategy with the Standalone POJO Mapper</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="annotation">@SearchEntity</span>(loadingBinder = <span class="annotation">@EntityLoadingBinderRef</span>(type = MyLoadingBinder.class)) <i class="conum" data-value="1"></i><b>(1)</b>
<span class="annotation">@Indexed</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">Book</span> {</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Assign a loading binder to the entity.</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Subclasses inherit the loading binder of their parent class,
unless they override it with a loading binder of their own.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="annotation">@Singleton</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">MyLoadingBinder</span> <span class="directive">implements</span> EntityLoadingBinder { <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="directive">private</span> <span class="directive">final</span> MyDatastore datastore;

    <span class="annotation">@Inject</span> <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="directive">public</span> MyLoadingBinder(MyDatastore datastore) {
        <span class="local-variable">this</span>.datastore = datastore;
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> bind(EntityLoadingBindingContext context) { <i class="conum" data-value="3"></i><b>(3)</b>
        context.massLoadingStrategy( <i class="conum" data-value="4"></i><b>(4)</b>
                <span class="predefined-type">Book</span>.class, <i class="conum" data-value="5"></i><b>(5)</b>
                <span class="keyword">new</span> MyMassLoadingStrategy&lt;&gt;( datastore, <span class="predefined-type">Book</span>.class ) <i class="conum" data-value="6"></i><b>(6)</b>
        );
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The binder must implement the <code>EntityLoadingBinder</code> interface.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Inject the implementation-specific datastore into the loading binder,
for example here using CDI (or <code>@Autowired</code> on Spring, or &#8230;&#8203;).</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Implement the <code>bind</code> method.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Call <code>context.massLoadingStrategy(&#8230;&#8203;)</code> to define the loading strategy to use.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Pass the expected supertype of loaded entities.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Pass the loading strategy.</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Using injection in the loading binder
with the <a href="#mapper-pojo-standalone">Standalone POJO Mapper</a>
requires <a href="#mapper-pojo-standalone-beanprovider">providing a <code>BeanProvider</code> through additional configuration</a>.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>Below is an example of <code>MassLoadingStrategy</code> implementation for an imaginary datastore.</p>
</div>
<div class="exampleblock">
<div class="title">Example 21. Implementing <code>MassLoadingStrategy</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="directive">public</span> <span class="type">class</span> <span class="class">MyMassLoadingStrategy</span>&lt;E&gt;
        <span class="directive">implements</span> MassLoadingStrategy&lt;E, <span class="predefined-type">String</span>&gt; {

    <span class="directive">private</span> <span class="directive">final</span> MyDatastore datastore; <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="directive">private</span> <span class="directive">final</span> <span class="predefined-type">Class</span>&lt;E&gt; rootEntityType;

    <span class="directive">public</span> MyMassLoadingStrategy(MyDatastore datastore, <span class="predefined-type">Class</span>&lt;E&gt; rootEntityType) {
        <span class="local-variable">this</span>.datastore = datastore;
        <span class="local-variable">this</span>.rootEntityType = rootEntityType;
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> MassIdentifierLoader createIdentifierLoader(
            LoadingTypeGroup&lt;E&gt; includedTypes, <i class="conum" data-value="2"></i><b>(2)</b>
            MassIdentifierSink&lt;<span class="predefined-type">String</span>&gt; sink, MassLoadingOptions options) {
        <span class="type">int</span> batchSize = options.batchSize(); <i class="conum" data-value="3"></i><b>(3)</b>
        <span class="predefined-type">Collection</span>&lt;<span class="predefined-type">Class</span>&lt;? <span class="directive">extends</span> E&gt;&gt; typeFilter =
                includedTypes.includedTypesMap().values(); <i class="conum" data-value="4"></i><b>(4)</b>
        <span class="keyword">return</span> <span class="keyword">new</span> MassIdentifierLoader() {
            <span class="directive">private</span> <span class="directive">final</span> MyDatastoreConnection connection =
                    datastore.connect(); <i class="conum" data-value="5"></i><b>(5)</b>
            <span class="directive">private</span> <span class="directive">final</span> MyDatastoreCursor&lt;<span class="predefined-type">String</span>&gt; identifierCursor =
                    connection.scrollIdentifiers( typeFilter );

            <span class="annotation">@Override</span>
            <span class="directive">public</span> <span class="type">void</span> close() {
                connection.close(); <i class="conum" data-value="5"></i><b>(5)</b>
            }

            <span class="annotation">@Override</span>
            <span class="directive">public</span> <span class="type">long</span> totalCount() { <i class="conum" data-value="6"></i><b>(6)</b>
                <span class="keyword">return</span> connection.countEntities( typeFilter );
            }

            <span class="annotation">@Override</span>
            <span class="directive">public</span> <span class="type">void</span> loadNext() <span class="directive">throws</span> <span class="exception">InterruptedException</span> {
                <span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt; batch = identifierCursor.next( batchSize );
                <span class="keyword">if</span> ( batch != <span class="predefined-constant">null</span> ) {
                    sink.accept( batch ); <i class="conum" data-value="7"></i><b>(7)</b>
                }
                <span class="keyword">else</span> {
                    sink.complete(); <i class="conum" data-value="8"></i><b>(8)</b>
                }
            }
        };
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> MassEntityLoader&lt;<span class="predefined-type">String</span>&gt; createEntityLoader(
            LoadingTypeGroup&lt;E&gt; includedTypes, <i class="conum" data-value="9"></i><b>(9)</b>
            MassEntitySink&lt;E&gt; sink, MassLoadingOptions options) {
        <span class="keyword">return</span> <span class="keyword">new</span> MassEntityLoader&lt;<span class="predefined-type">String</span>&gt;() {
            <span class="directive">private</span> <span class="directive">final</span> MyDatastoreConnection connection =
                    datastore.connect(); <i class="conum" data-value="10"></i><b>(10)</b>

            <span class="annotation">@Override</span>
            <span class="directive">public</span> <span class="type">void</span> close() { <i class="conum" data-value="8"></i><b>(8)</b>
                connection.close();
            }

            <span class="annotation">@Override</span>
            <span class="directive">public</span> <span class="type">void</span> load(<span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt; identifiers)
                    <span class="directive">throws</span> <span class="exception">InterruptedException</span> {
                sink.accept( <i class="conum" data-value="11"></i><b>(11)</b>
                        connection.loadEntitiesById( rootEntityType, identifiers )
                );
            }
        };
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The strategy must have access to the datastore to be able to open connections,
but it should not generally have any open connection.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Implement an identifier loader to retrieve the identifiers of all entities that will have to be indexed.
Hibernate Search will only call this method once per mass indexing.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Retrieve the <a href="#indexing-massindexer-parameters-batchsizetoloadobjects">batch size</a> configured on the <code>MassIndexer</code>.
This defines how many IDs (at most) must be returned in each <code>List</code> passed to the sink.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Retrieve the list of entity types to be loaded:
Hibernate Search may request loading of multiple types from a single loader
if those types share similar mass loading strategies (see tips/warnings below).</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>The identifier loader owns a connection exclusively: it should create one when it&#8217;s created, and close it when it&#8217;s closed.
Related: the identifier loader always executes in the same thread.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Count the number of entities to index.
This is just an estimate: it can be off to some extent,
but that will lead to incorrect reporting in the <a href="#indexing-massindexer-parameters-monitor">monitor</a> (by default, the logs).</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Retrieve identifiers in successive batches, one per call to <code>loadNext()</code>, and pass them to the sink.</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>When there are no more identifiers to load, let the sink know by calling <code>complete()</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="9"></i><b>9</b></td>
<td>Implement an entity loader to actually load entities from the identifiers retrieved above.
Hibernate Search will call this method multiple times for a single mass indexing,
to create <a href="#indexing-massindexer-parameters-threadstoloadobjects">multiple loaders</a> that execute in parallel.</td>
</tr>
<tr>
<td><i class="conum" data-value="10"></i><b>10</b></td>
<td>Each entity loader owns a connection exclusively: it should create one when it&#8217;s created, and close it when it&#8217;s closed.
Related: each entity loader always executes in the same thread.</td>
</tr>
<tr>
<td><i class="conum" data-value="11"></i><b>11</b></td>
<td>Load the entities corresponding to the identifiers passed in argument and pass them to the sink.
Entities passed to the sink do not need to be in the same order as the identifiers passed in argument.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Hibernate Search will optimize loading by grouping together
types that have the same <code>MassLoadingStrategy</code>,
or different strategies that are equal according to <code>equals()</code>/<code>hashCode()</code>.</p>
</div>
<div class="paragraph">
<p>When grouping types together, only one of the strategies will be called,
and it will get passed a "type group" that includes all types that should be loaded.</p>
</div>
<div class="paragraph">
<p>This happens in particular when configuring the loading binder from a "parent" entity type
is inherited by subtypes, and sets the same strategy on subtypes.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Be careful of non-abstract (instantiable) parent classes in inheritance trees:
when the "type group" passed to the <code>createIdentifierLoader</code> method
contains a parent type (say, <code>Animal</code>) and none of the subtypes (neither <code>Lion</code> nor <code>Zebra</code>),
then the loader really should only load identifiers of instances of the parent type,
not of its subtypes
(it should load identifiers of entities whose type is exactly <code>Animal</code>, not <code>Lion</code> nor <code>Zebra</code>).</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Once all types to reindex have their mass loading strategy implemented and assigned,
they can be reindexed using the <a href="#indexing-massindexer">mass indexer</a>:</p>
</div>
<div class="exampleblock">
<div class="title">Example 22. Mass indexing with the Standalone POJO Mapper</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">SearchMapping searchMapping = <span class="comment">/* ... */</span> <i class="conum" data-value="1"></i><b>(1)</b>
searchMapping.scope( <span class="predefined-type">Object</span>.class ).massIndexer() <i class="conum" data-value="2"></i><b>(2)</b>
        .startAndWait(); <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><a href="#entrypoints-search-mapping-mapper-pojo-standalone">Retrieve the <code>SearchMapping</code></a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Create a <code>MassIndexer</code> targeting every indexed entity type.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Start the mass indexing process and return when it is over.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="mapping-entitydefinition-loading-selection"><a class="anchor" href="#mapping-entitydefinition-loading-selection"></a>10.2.5. Selection loading strategy</h4>
<div class="paragraph">
<p>A "selection loading strategy" gives Hibernate Search
the ability to load entities of a given type
to <a href="#search-dsl-query-generality">return entities loaded from an external source as hits in search queries</a>.</p>
</div>
<div class="paragraph">
<p>With the <a href="#mapper-orm">Hibernate ORM integration</a>,
a selection loading strategy gets configured automatically for every single Hibernate ORM entity,
and no further configuration is required.</p>
</div>
<div class="paragraph">
<p>With the <a href="#mapper-pojo-standalone">Standalone POJO Mapper</a>,
entity types are <a href="#mapping-entitydefinition-explicit">defined with <code>@SearchEntity</code></a>,
and, in order to return entities loaded from an external source in search queries,
a selection loading strategy must be applied explicitly
with <code>@SearchEntity(loadingBinder = &#8230;&#8203;)</code>.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Features detailed below are <em>incubating</em>: they are still under active development.</p>
</div>
<div class="paragraph">
<p>The usual <a href="https://hibernate.org/community/compatibility-policy/">compatibility policy</a> does not apply:
the contract of incubating elements (e.g. types, methods, configuration properties, etc.)
may be altered in a backward-incompatible way&#8201;&#8212;&#8201;or even removed&#8201;&#8212;&#8201;in subsequent releases.</p>
</div>
<div class="paragraph">
<p>You are encouraged to use incubating features so the development team can get feedback and improve them,
but you should be prepared to update code which relies on them as needed.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p><code>@SearchEntity</code> and its corresponding programmatic mapping <code>.searchEntity()</code>
are unnecessary for Hibernate ORM entities,
and in fact unsupported when using the <a href="#mapper-orm">Hibernate ORM integration</a>.</p>
</div>
<div class="paragraph">
<p>See <a href="https://hibernate.atlassian.net/browse/HSEARCH-5076">HSEARCH-5076</a>
to track progress on allowing the use of <code>@SearchEntity</code> in the Hibernate ORM integration
to map non-ORM entities.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="exampleblock">
<div class="title">Example 23. Assigning a selection loading strategy with the Standalone POJO Mapper</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="annotation">@SearchEntity</span>(loadingBinder = <span class="annotation">@EntityLoadingBinderRef</span>(type = MyLoadingBinder.class)) <i class="conum" data-value="1"></i><b>(1)</b>
<span class="annotation">@Indexed</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">Book</span> {</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Assign a loading binder to the entity.</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Subclasses inherit the loading binder of their parent class,
unless they override it with a loading binder of their own.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="annotation">@Singleton</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">MyLoadingBinder</span> <span class="directive">implements</span> EntityLoadingBinder { <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> bind(EntityLoadingBindingContext context) { <i class="conum" data-value="2"></i><b>(2)</b>
        context.selectionLoadingStrategy( <i class="conum" data-value="3"></i><b>(3)</b>
                <span class="predefined-type">Book</span>.class, <i class="conum" data-value="4"></i><b>(4)</b>
                <span class="keyword">new</span> MySelectionLoadingStrategy&lt;&gt;( <span class="predefined-type">Book</span>.class ) <i class="conum" data-value="5"></i><b>(5)</b>
        );
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The binder must implement the <code>EntityLoadingBinder</code> interface.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Implement the <code>bind</code> method.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Call <code>context.selectionLoadingStrategy(&#8230;&#8203;)</code> to define the loading strategy to use.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Pass the expected supertype of loaded entities.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Pass the loading strategy.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>Below is an example of <code>SelectionLoadingStrategy</code> implementation for an imaginary datastore.</p>
</div>
<div class="exampleblock">
<div class="title">Example 24. Implementing <code>SelectionLoadingStrategy</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="directive">public</span> <span class="type">class</span> <span class="class">MySelectionLoadingStrategy</span>&lt;E&gt;
        <span class="directive">implements</span> SelectionLoadingStrategy&lt;E&gt; {
    <span class="directive">private</span> <span class="directive">final</span> <span class="predefined-type">Class</span>&lt;E&gt; rootEntityType;

    <span class="directive">public</span> MySelectionLoadingStrategy(<span class="predefined-type">Class</span>&lt;E&gt; rootEntityType) {
        <span class="local-variable">this</span>.rootEntityType = rootEntityType;
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> SelectionEntityLoader&lt;E&gt; createEntityLoader(
            LoadingTypeGroup&lt;E&gt; includedTypes, <i class="conum" data-value="1"></i><b>(1)</b>
            SelectionLoadingOptions options) {
        MyDatastoreConnection connection =
                options.context( MyDatastoreConnection.class ); <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="keyword">return</span> <span class="keyword">new</span> SelectionEntityLoader&lt;E&gt;() {
            <span class="annotation">@Override</span>
            <span class="directive">public</span> <span class="predefined-type">List</span>&lt;E&gt; load(<span class="predefined-type">List</span>&lt;?&gt; identifiers, Deadline deadline) {
                <span class="keyword">return</span> connection.loadEntitiesByIdInSameOrder( <i class="conum" data-value="3"></i><b>(3)</b>
                        rootEntityType, identifiers );
            }
        };
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Implement an entity loader to actually load entities from the identifiers returned by Lucene/Elasticsearch.
Hibernate Search will call this method multiple times for a single mass indexing,</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The entity loader does not own a connection, but retrieves it from the context passed to the <code>SearchSession</code> (see next example).</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Load the entities corresponding to the identifiers passed in argument and return them.
Returned entities <strong>must</strong> be in the same order as the identifiers passed in argument.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Hibernate Search will optimize loading by grouping together
types that have the same <code>SelectionLoadingStrategy</code>,
or different strategies that are equal according to <code>equals()</code>/<code>hashCode()</code>.</p>
</div>
<div class="paragraph">
<p>When grouping types together, only one of the strategies will be called,
and it will get passed a "type group" that includes all types that should be loaded.</p>
</div>
<div class="paragraph">
<p>This happens in particular when configuring the loading binder from a "parent" entity type
is inherited by subtypes, and sets the same strategy on subtypes.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Once all types to search for have their selection loading strategy implemented and assigned,
they can be loaded as hits when <a href="#search-dsl-query">querying</a>:</p>
</div>
<div class="exampleblock">
<div class="title">Example 25. Loading entities as search query hits with the Standalone POJO Mapper</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">MyDatastore datastore = <span class="comment">/* ... */</span> <i class="conum" data-value="1"></i><b>(1)</b>
SearchMapping searchMapping = <span class="comment">/* ... */</span> <i class="conum" data-value="2"></i><b>(2)</b>
<span class="keyword">try</span> ( MyDatastoreConnection connection = datastore.connect(); <i class="conum" data-value="3"></i><b>(3)</b>
        SearchSession searchSession = searchMapping.createSessionWithOptions() <i class="conum" data-value="4"></i><b>(4)</b>
                .loading( o -&gt; o.context( MyDatastoreConnection.class, connection ) ) <i class="conum" data-value="5"></i><b>(5)</b>
                .build() ) { <i class="conum" data-value="6"></i><b>(6)</b>
    <span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class ) <i class="conum" data-value="7"></i><b>(7)</b>
            .where( f -&gt; f.matchAll() )
            .fetchHits( <span class="integer">20</span> ); <i class="conum" data-value="8"></i><b>(8)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Retrieve a reference to an implementation-specific datastore.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><a href="#entrypoints-search-mapping-mapper-pojo-standalone">Retrieve the <code>SearchMapping</code></a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Open a connection to the datastore (this is just an imaginary API, for the purpose of this example).
Note we&#8217;re using a try-with-resources block,
so that the connection will automatically be closed when we&#8217;re done with it.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Start creating a new session.
Note we&#8217;re using a try-with-resources block,
so that the session will automatically be closed when we&#8217;re done with it.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Pass the connection to the new session.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Build the new session.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Create a <a href="#search-dsl-query">search query</a>: since we don&#8217;t use <code>select()</code>,
hits will have their default representations: entities loaded from the datastore.</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>Retrieve the search hits as entities loaded from the datastore.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="mapping-entitydefinition-programmatic"><a class="anchor" href="#mapping-entitydefinition-programmatic"></a>10.2.6. Programmatic mapping</h4>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Features detailed below are <em>incubating</em>: they are still under active development.</p>
</div>
<div class="paragraph">
<p>The usual <a href="https://hibernate.org/community/compatibility-policy/">compatibility policy</a> does not apply:
the contract of incubating elements (e.g. types, methods, configuration properties, etc.)
may be altered in a backward-incompatible way&#8201;&#8212;&#8201;or even removed&#8201;&#8212;&#8201;in subsequent releases.</p>
</div>
<div class="paragraph">
<p>You are encouraged to use incubating features so the development team can get feedback and improve them,
but you should be prepared to update code which relies on them as needed.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p><code>@SearchEntity</code> and its corresponding programmatic mapping <code>.searchEntity()</code>
are unnecessary for Hibernate ORM entities,
and in fact unsupported when using the <a href="#mapper-orm">Hibernate ORM integration</a>.</p>
</div>
<div class="paragraph">
<p>See <a href="https://hibernate.atlassian.net/browse/HSEARCH-5076">HSEARCH-5076</a>
to track progress on allowing the use of <code>@SearchEntity</code> in the Hibernate ORM integration
to map non-ORM entities.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can mark a type as an entity type through the <a href="#mapping-programmatic">programmatic mapping</a> too.
Behavior and options are identical to annotation-based mapping.</p>
</div>
<div class="exampleblock">
<div class="title">Example 26. Marking a type as an entity type with <code>.searchEntity()</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">TypeMappingStep bookMapping = mapping.type( <span class="predefined-type">Book</span>.class );
bookMapping.searchEntity();
TypeMappingStep authorMapping = mapping.type( Author.class );
authorMapping.searchEntity().name( <span class="string"><span class="delimiter">&quot;</span><span class="content">MyAuthorName</span><span class="delimiter">&quot;</span></span> );</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="mapping-entityindexmapping"><a class="anchor" href="#mapping-entityindexmapping"></a>10.3. <a id="mapper-orm-entityindexmapping"></a> Entity/index mapping</h3>
<div class="sect3">
<h4 id="mapping-entityindexmapping-basics"><a class="anchor" href="#mapping-entityindexmapping-basics"></a>10.3.1. <a id="mapper-orm-entityindexmapping-basics"></a> Basics</h4>
<div class="paragraph">
<p>In order to index an entity, it must be annotated with <code>@Indexed</code>.</p>
</div>
<div class="exampleblock">
<div class="title">Example 27. Marking a class for indexing with <code>@Indexed</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="annotation">@Entity</span>
<span class="annotation">@Indexed</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">Book</span> {</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Subclasses inherit the <code>@Indexed</code> annotation and will also be indexed by default.
Each indexed subclass will have its own index,
though this will be transparent when searching
(<a href="#search-dsl-query-targeting-multiple">all targeted indexes will be queried simultaneously</a>).</p>
</div>
<div class="paragraph">
<p>If the fact that <code>@Indexed</code> is inherited is a problem for your application,
you can annotate subclasses with <code>@Indexed(enabled = false)</code>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>By default:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The index name will be equal to the entity name,
which in Hibernate ORM is set using the <code>@Entity</code> annotation
and defaults to the simple class name.</p>
</li>
<li>
<p>With the <a href="#mapper-orm">Hibernate ORM integration</a>, the identifier of indexed documents
will be <a href="#mapping-identifiermapping-basics">generated from the entity identifier</a>.
Most types commonly used for entity identifiers are supported out of the box,
but for more exotic types you may need specific configuration.</p>
<div class="paragraph">
<p>With the <a href="#mapper-pojo-standalone">Standalone POJO Mapper</a>,
the identifier of indexed documents needs to be
<a href="#mapping-identifiermapping-explicit">mapped explicitly</a>.</p>
</div>
<div class="paragraph">
<p>See <a href="#mapping-identifiermapping">  Mapping the document identifier</a> for details.</p>
</div>
</li>
<li>
<p>The index won&#8217;t have any field.
Fields must be mapped to properties explicitly.
See <a href="#mapping-directfieldmapping"> Mapping a property to an index field with <code>@GenericField</code>, <code>@FullTextField</code>, &#8230;&#8203;</a> for details.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="mapping-entityindexmapping-explicit"><a class="anchor" href="#mapping-entityindexmapping-explicit"></a>10.3.2. <a id="mapper-orm-entityindexmapping-explicit"></a> Explicit index/backend</h4>
<div class="paragraph">
<p>You can change the name of the index by setting <code>@Indexed(index = &#8230;&#8203;)</code>.
Note that index names must be unique in a given application.</p>
</div>
<div class="exampleblock">
<div class="title">Example 28. Explicit index name with <code>@Indexed.index</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="annotation">@Entity</span>
<span class="annotation">@Indexed</span>(index = <span class="string"><span class="delimiter">&quot;</span><span class="content">AuthorIndex</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">Author</span> {</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>If you <a href="#configuration-structure">defined named backends</a>, you can map entities to another backend than the default one.
By setting <code>@Indexed(backend = "backend2")</code> you inform Hibernate Search that the index
for your entity must be created in the backend named "backend2".
This may be useful if your model has clearly defined sub-parts with very different indexing requirements.</p>
</div>
<div class="exampleblock">
<div class="title">Example 29. Explicit backend with <code>@Indexed.backend</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="annotation">@Entity</span>
<span class="annotation">@Table</span>(name = <span class="string"><span class="delimiter">&quot;</span><span class="char">\&quot;</span><span class="content">user</span><span class="char">\&quot;</span><span class="delimiter">&quot;</span></span>)
<span class="annotation">@Indexed</span>(backend = <span class="string"><span class="delimiter">&quot;</span><span class="content">backend2</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">User</span> {</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Entities indexed in different backends cannot be targeted by the same query.
For example, with the mappings defined above,
the following code will throw an exception
because <code>Author</code> and <code>User</code> are indexed in different backends:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="comment">// This will fail because Author and User are indexed in different backends</span>
searchSession.search( <span class="predefined-type">Arrays</span>.asList( Author.class, User.class ) )
        .where( f -&gt; f.matchAll() )
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="mapping-entityindexmapping-conditional-and-routing"><a class="anchor" href="#mapping-entityindexmapping-conditional-and-routing"></a>10.3.3. <a id="mapper-orm-entityindexmapping-conditional-and-routing"></a> <a id="search-mapping-indexinginterceptor"></a> Conditional indexing and routing</h4>
<div class="paragraph">
<p>The mapping of an entity to an index is not always as straightforward as "this entity type goes to this index".
For many reasons, but mainly for performance reasons,
you may want to customize when and where a given entity is indexed:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>You may not want to index all entities of a given type: for example,
prevent indexing of entities when their <code>status</code> property is set to <code>DRAFT</code> or <code>ARCHIVED</code>,
because users are not supposed to search for those entities.</p>
</li>
<li>
<p>You may want to <a href="#concepts-sharding-routing">route entities to a specific shard of the index</a>: for example,
route entities based on their <code>language</code> property,
because each user has a specific language and only searches for entities in their language.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>These behaviors can be implemented in Hibernate Search by assigning a routing bridge
to the indexed entity type through <code>@Indexed(routingBinder = &#8230;&#8203;)</code>.</p>
</div>
<div class="paragraph">
<p>For more information about routing bridges, see <a href="#binding-routingbridge">  Routing bridge</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="mapping-entityindexmapping-programmatic"><a class="anchor" href="#mapping-entityindexmapping-programmatic"></a>10.3.4. <a id="mapper-orm-entityindexmapping-programmatic"></a> Programmatic mapping</h4>
<div class="paragraph">
<p>You can mark an entity as indexed through the <a href="#mapping-programmatic">programmatic mapping</a> too.
Behavior and options are identical to annotation-based mapping.</p>
</div>
<div class="exampleblock">
<div class="title">Example 30. Marking a class for indexing with <code>.indexed()</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">TypeMappingStep bookMapping = mapping.type( <span class="predefined-type">Book</span>.class );
bookMapping.indexed();
TypeMappingStep authorMapping = mapping.type( Author.class );
authorMapping.indexed().index( <span class="string"><span class="delimiter">&quot;</span><span class="content">AuthorIndex</span><span class="delimiter">&quot;</span></span> );
TypeMappingStep userMapping = mapping.type( User.class );
userMapping.indexed().backend( <span class="string"><span class="delimiter">&quot;</span><span class="content">backend2</span><span class="delimiter">&quot;</span></span> );</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="mapping-identifiermapping"><a class="anchor" href="#mapping-identifiermapping"></a>10.4. <a id="mapper-orm-identifiermapping"></a> <a id="id-annotation"></a> Mapping the document identifier</h3>
<div class="sect3">
<h4 id="mapping-identifiermapping-basics"><a class="anchor" href="#mapping-identifiermapping-basics"></a>10.4.1. <a id="mapper-orm-identifiermapping-basics"></a> <a id="example-document-id-default-orm"></a> Basics</h4>
<div class="paragraph">
<p>Index documents, much like entities, need to be assigned an identifier
so that Hibernate Search can handle updates and deletion.</p>
</div>
<div class="paragraph">
<p>When <a href="#mapper-orm">indexing Hibernate ORM entities</a>,
the entity identifier is used as a document identifier by default.
Provided the entity identifier has a <a href="#mapping-identifiermapping-supported-types">supported type</a>,
identifier mapping will work out of the box and no explicit mapping is necessary.</p>
</div>
<div class="paragraph">
<p>When using the <a href="#mapper-pojo-standalone">Standalone POJO Mapper</a>,
document identifiers need to be <a href="#mapping-identifiermapping-explicit">mapped explicitly</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="mapping-identifiermapping-explicit"><a class="anchor" href="#mapping-identifiermapping-explicit"></a>10.4.2. <a id="mapper-orm-identifiermapping-explicit"></a> <a id="_explicit_identifier_mapping"></a> Explicit identifier mapping</h4>
<div class="paragraph">
<p>Explicit identifier mapping is required in the following cases:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Hibernate Search doesn&#8217;t know about the entity identifier
(e.g. when using the <a href="#mapper-pojo-standalone">Standalone POJO Mapper</a>).</p>
</li>
<li>
<p>OR the document identifier is not the entity identifier.</p>
</li>
<li>
<p>OR the entity identifier has a type that is not supported by default.
This is the case of composite identifiers (Hibernate ORM&#8217;s <code>@EmbeddedId</code>, <code>@IdClass</code>), in particular.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To select a property to map to the document identifier,
just apply the <code>@DocumentId</code> annotation to that property:</p>
</div>
<div id="example-document-id-explicit" class="exampleblock">
<div class="title">Example 31. Mapping a property to the document identifier explicitly with <code>@DocumentId</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="annotation">@Entity</span>
<span class="annotation">@Indexed</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">Book</span> {

    <span class="annotation">@Id</span>
    <span class="annotation">@GeneratedValue</span>
    <span class="directive">private</span> <span class="predefined-type">Integer</span> id;

    <span class="annotation">@NaturalId</span>
    <span class="annotation">@DocumentId</span>
    <span class="directive">private</span> <span class="predefined-type">String</span> isbn;

    <span class="directive">public</span> <span class="predefined-type">Book</span>() {
    }

    <span class="comment">// Getters and setters</span>
    <span class="comment">// ...</span>

}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>When the property type is not supported,
it is also necessary to <a href="#binding-identifierbridge">implement a custom identifier bridge</a>,
then refer to it in the <code>@DocumentId</code> annotation:</p>
</div>
<div class="exampleblock">
<div class="title">Example 32. Mapping a property with unsupported type to the document identifier with <code>@DocumentId</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="annotation">@Entity</span>
<span class="annotation">@Indexed</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">Book</span> {

    <span class="annotation">@Id</span>
    <span class="annotation">@Convert</span>(converter = ISBNAttributeConverter.class)
    <span class="annotation">@DocumentId</span>(identifierBridge = <span class="annotation">@IdentifierBridgeRef</span>(type = ISBNIdentifierBridge.class))
    <span class="directive">private</span> ISBN isbn;

    <span class="directive">public</span> <span class="predefined-type">Book</span>() {
    }

    <span class="comment">// Getters and setters</span>
    <span class="comment">// ...</span>

}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="mapping-identifiermapping-supported-types"><a class="anchor" href="#mapping-identifiermapping-supported-types"></a>10.4.3. <a id="mapper-orm-identifiermapping-supported-types"></a> <a id="_supported_identifier_types"></a> Supported identifier property types</h4>
<div class="paragraph">
<p>Below is a table listing all types with built-in identifier bridges,
i.e. property types that are supported out of the box
when mapping a property to a document identifier.</p>
</div>
<div class="paragraph">
<p>The table also explains the value assigned to the document identifier,
i.e. the value passed to the underlying backend.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 3. Property types with built-in identifier bridges</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property type</th>
<th class="tableblock halign-left valign-top">Value of document identifiers</th>
<th class="tableblock halign-left valign-top">Limitations</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>All enum types</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>name()</code> as a <code>java.lang.String</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.lang.String</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Unchanged</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.lang.Character, char</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A single-character <code>java.lang.String</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.lang.Byte, byte</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>toString()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.lang.Short, short</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>toString()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.lang.Integer, int</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>toString()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.lang.Long, long</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>toString()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.lang.Double, double</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>toString()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.lang.Float, float</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>toString()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.lang.Boolean, boolean</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>toString()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.math.BigDecimal</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>toString()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.math.BigInteger</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>toString()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.net.URI</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>toString()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.net.URL</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>toExternalForm()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.time.Instant</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Formatted according to <code>DateTimeFormatter.ISO_INSTANT</code>.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.time.LocalDate</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Formatted according to <code>DateTimeFormatter.ISO_LOCAL_DATE</code>.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.time.LocalTime</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Formatted according to <code>DateTimeFormatter.ISO_LOCAL_TIME</code>.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.time.LocalDateTime</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Formatted according to <code>DateTimeFormatter.ISO_LOCAL_DATE_TIME</code>.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.time.OffsetDateTime</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Formatted according to <code>DateTimeFormatter.ISO_OFFSET_DATE_TIME</code>.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.time.OffsetTime</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Formatted according to <code>DateTimeFormatter.ISO_OFFSET_TIME</code>.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.time.ZonedDateTime</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Formatted according to <code>DateTimeFormatter.ISO_ZONED_DATE_TIME</code>.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.time.ZoneId</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>getId()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.time.ZoneOffset</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>getId()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.time.Period</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Formatted according to the <a href="https://en.wikipedia.org/wiki/ISO_8601#Durations">ISO 8601 format for a duration</a>
(e.g. <code>P1900Y12M21D</code>).</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.time.Duration</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Formatted according to the <a href="https://en.wikipedia.org/wiki/ISO_8601#Durations">ISO 8601 format for a duration</a>,
using seconds and nanoseconds only (e.g. <code>PT1.000000123S</code>).</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.time.Year</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Formatted according to the <a href="https://en.wikipedia.org/wiki/ISO_8601#Years">ISO 8601 format for a Year</a>
(e.g. <code>2017</code> for 2017 AD, <code>0000</code> for 1 BC, <code>-10000</code> for 10,001 BC, etc.).</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.time.YearMonth</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Formatted according to the <a href="https://en.wikipedia.org/wiki/ISO_8601#Calendar_dates">ISO 8601 format for a Year-Month</a>
(e.g. <code>2017-11</code> for November 2017).</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.time.MonthDay</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Formatted according to the <a href="https://en.wikipedia.org/wiki/ISO_8601#Calendar_dates">ISO 8601 format for a Month-Day</a>
(e.g. <code>--11-06</code> for November 6th).</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.util.UUID</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>toString()</code> as a <code>java.lang.String</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.util.Calendar</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A <code>java.time.ZonedDateTime</code> representing the same date/time and timezone,
formatted according to <code>DateTimeFormatter.ISO_ZONED_DATE_TIME</code>.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">See <a href="#mapping-legacy-date-time-apis"> Support for legacy <code>java.util</code> date/time APIs</a>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.util.Date</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Instant.ofEpochMilli(long)</code> as a <code>java.time.Instant</code>
formatted according to <code>DateTimeFormatter.ISO_INSTANT</code>.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">See <a href="#mapping-legacy-date-time-apis"> Support for legacy <code>java.util</code> date/time APIs</a>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.sql.Timestamp</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Instant.ofEpochMilli(long)</code> as a <code>java.time.Instant</code>
formatted according to <code>DateTimeFormatter.ISO_INSTANT</code>.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">See <a href="#mapping-legacy-date-time-apis"> Support for legacy <code>java.util</code> date/time APIs</a>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.sql.Date</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Instant.ofEpochMilli(long)</code> as a <code>java.time.Instant</code>
formatted according to <code>DateTimeFormatter.ISO_INSTANT</code>.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">See <a href="#mapping-legacy-date-time-apis"> Support for legacy <code>java.util</code> date/time APIs</a>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.sql.Time</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Instant.ofEpochMilli(long)</code> as a <code>java.time.Instant</code>,
formatted according to <code>DateTimeFormatter.ISO_INSTANT</code>.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">See <a href="#mapping-legacy-date-time-apis"> Support for legacy <code>java.util</code> date/time APIs</a>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><a href="#mapping-geopoint-basics">GeoPoint</a> and subtypes</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Latitude as double and longitude as double, separated by a comma
(e.g. <code>41.8919, 12.51133</code>).</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="mapping-identifiermapping-programmatic"><a class="anchor" href="#mapping-identifiermapping-programmatic"></a>10.4.4. <a id="mapper-orm-identifiermapping-programmatic"></a> Programmatic mapping</h4>
<div class="paragraph">
<p>You can map the document identifier through the <a href="#mapping-programmatic">programmatic mapping</a> too.
Behavior and options are identical to annotation-based mapping.</p>
</div>
<div class="exampleblock">
<div class="title">Example 33. Mapping a property to the document identifier explicitly with <code>.documentId()</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">TypeMappingStep bookMapping = mapping.type( <span class="predefined-type">Book</span>.class );
bookMapping.indexed();
bookMapping.property( <span class="string"><span class="delimiter">&quot;</span><span class="content">isbn</span><span class="delimiter">&quot;</span></span> ).documentId();</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="mapping-directfieldmapping"><a class="anchor" href="#mapping-directfieldmapping"></a>10.5. <a id="mapper-orm-directfieldmapping"></a> Mapping a property to an index field with <code>@GenericField</code>, <code>@FullTextField</code>, &#8230;&#8203;</h3>
<div class="sect3">
<h4 id="mapping-directfieldmapping-basics"><a class="anchor" href="#mapping-directfieldmapping-basics"></a>10.5.1. <a id="mapper-orm-directfieldmapping-basics"></a> Basics</h4>
<div class="paragraph">
<p>Properties of an entity can be mapped to an index field directly:
you just need to add an annotation, configure the field through the annotation attributes,
and Hibernate Search will take care of extracting the property value and populating the index field when necessary.</p>
</div>
<div class="paragraph">
<p>Mapping a property to an index field looks like this:</p>
</div>
<div class="exampleblock">
<div class="title">Example 34. Mapping properties to fields directly</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="annotation">@FullTextField</span>(analyzer = <span class="string"><span class="delimiter">&quot;</span><span class="content">english</span><span class="delimiter">&quot;</span></span>, projectable = Projectable.YES) <i class="conum" data-value="1"></i><b>(1)</b>
<span class="annotation">@KeywordField</span>(name = <span class="string"><span class="delimiter">&quot;</span><span class="content">title_sort</span><span class="delimiter">&quot;</span></span>, normalizer = <span class="string"><span class="delimiter">&quot;</span><span class="content">english</span><span class="delimiter">&quot;</span></span>, sortable = Sortable.YES) <i class="conum" data-value="2"></i><b>(2)</b>
<span class="directive">private</span> <span class="predefined-type">String</span> title;

<span class="annotation">@GenericField</span>(projectable = Projectable.YES, sortable = Sortable.YES) <i class="conum" data-value="3"></i><b>(3)</b>
<span class="directive">private</span> <span class="predefined-type">Integer</span> pageCount;</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Map the <code>title</code> property to a full-text field with the same name.
Some options can be set to customize the fields' behavior, in this case the analyzer (for full-text indexing)
and the fact that this field is projectable (its value can be retrieved from the index).</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Map the <code>title</code> property to <strong>another</strong> field, configured differently:
it is not analyzed, but simply normalized (i.e. it&#8217;s not split into multiple tokens),
and it is stored in such a way that it can be used in sorts.
<div class="paragraph">
<p>Mapping a single property to multiple fields is particularly useful when doing full-text search:
at query time, you can use a different field depending on what you need.
You can map a property to as many fields as you want, but each must have a unique name.</p>
</div></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Map another property to its own field.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>Before you map a property, you must consider two things:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">The <code>@*Field</code> annotation</dt>
<dd>
<p>In its simplest form, property/field mapping is achieved by applying the <code>@GenericField</code> annotation to a property.
This annotation will work for every supported property type, but is rather limited:
it does not allow full-text search in particular.
To go further, you will need to rely on different, more specific annotations,
which offer specific attributes.
The available annotations are described in details in <a href="#mapping-directfieldmapping-annotations"> Available field annotations</a>.</p>
</dd>
<dt class="hdlist1">The type of the property</dt>
<dd>
<p>In order for the <code>@*Field</code> annotation to work correctly, the type of the mapped property must be supported by Hibernate Search.
See <a href="#mapping-directfieldmapping-supported-types">  Supported property types</a> for a list of all types that are supported out of the box,
and <a href="#mapping-directfieldmapping-custom-types"> Mapping custom property types</a> for indications on how to handle more complex types,
be it simply containers (<code>List&lt;String&gt;</code>, <code>Map&lt;String, Integer&gt;</code>, &#8230;&#8203;)
or custom types.</p>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="mapping-directfieldmapping-annotations"><a class="anchor" href="#mapping-directfieldmapping-annotations"></a>10.5.2. <a id="mapper-orm-directfieldmapping-annotations"></a> Available field annotations</h4>
<div class="paragraph">
<p>Various field annotations exist,
each offering its own set of attributes.</p>
</div>
<div class="paragraph">
<p>This section lists the different annotations and their use.
For more details about available attributes,
see <a href="#mapping-directfieldmapping-annotation-attributes"> Field annotation attributes</a>.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>@GenericField</code></dt>
<dd>
<p>A good default choice that will work for every property type with built-in support.</p>
<div class="paragraph">
<p>Fields mapped using this annotation do not provide any advanced features such as full-text search:
matches on a generic field are exact matches.</p>
</div>
</dd>
<dt class="hdlist1"><a id="mapping-directfieldmapping-annotations-fulltextfield"></a> <a id="mapper-orm-directfieldmapping-annotations-fulltextfield"></a> <code>@FullTextField</code></dt>
<dd>
<p>A text field whose value is considered as multiple words.
Only works for <code>String</code> fields.</p>
<div class="paragraph">
<p>Matches on a full-text field can be <a href="#search-dsl-predicate-match-analysis">more subtle than exact matches</a>:
match fields which contains a given word,
match fields regardless of case,
match fields ignoring diacritics,
&#8230;&#8203;</p>
</div>
<div class="paragraph">
<p>Full-text fields also allow <a href="#mapping-directfieldmapping-highlightable">highlighting</a>.</p>
</div>
<div class="paragraph">
<p>Full-text fields should be assigned an <a href="#mapping-directfieldmapping-analyzer">analyzer</a>, referenced by its name.
By default, the analyzer named <code>default</code> will be used.
See <a href="#concepts-analysis"> Analysis</a> for more details about analyzers and full-text analysis.
For instructions on how to change the default analyzer,
see the dedicated section in the documentation of your backend:
<a href="#backend-lucene-analysis-analyzers-default">Lucene</a> or <a href="#backend-elasticsearch-analysis-analyzers-default">Elasticsearch</a></p>
</div>
<div class="paragraph">
<p>Note you can also define <a href="#mapping-directfieldmapping-search-analyzer">a search analyzer</a>
to analyze searched terms differently.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Full-text fields cannot be sorted on nor aggregated.
If you need to sort on, or aggregate on, the value of a property,
it is recommended to use <code>@KeywordField</code>, with a normalizer if necessary (see below).
Note that multiple fields can be added to the same property,
so you can use both <code>@FullTextField</code> and <code>@KeywordField</code> if you need both
full-text search and sorting:
you will just need to use a distinct <a href="#mapping-directfieldmapping-name">name</a> for each of those two fields.
</td>
</tr>
</table>
</div>
</dd>
<dt class="hdlist1"><a id="mapping-directfieldmapping-annotations-keywordfield"></a> <a id="mapper-orm-directfieldmapping-annotations-keywordfield"></a> <code>@KeywordField</code></dt>
<dd>
<p>A text field whose value is considered as a single keyword.
Only works for <code>String</code> fields.</p>
<div class="paragraph">
<p>Keyword fields allow <a href="#search-dsl-predicate-match-analysis">more subtle matches</a>, similarly to full-text fields,
with the limitation that keyword fields only contain one token.
On the other hand, this limitation allows keyword fields to be <a href="#mapping-directfieldmapping-sortable">sorted on</a>
and <a href="#mapping-directfieldmapping-aggregable">aggregated</a>.</p>
</div>
<div class="paragraph">
<p>Keyword fields may be assigned a <a href="#mapping-directfieldmapping-normalizer">normalizer</a>, referenced by its name.
See <a href="#concepts-analysis"> Analysis</a> for more details about normalizers and full-text analysis.</p>
</div>
</dd>
<dt class="hdlist1"><a id="mapping-directfieldmapping-annotations-scalednumberfield"></a> <a id="mapper-orm-directfieldmapping-annotations-scalednumberfield"></a> <code>@ScaledNumberField</code></dt>
<dd>
<p>A numeric field for integer or floating-point values
that require a higher precision than doubles
but always have roughly the same scale.
Only works for either <code>java.math.BigDecimal</code> or <code>java.math.BigInteger</code> fields.</p>
<div class="paragraph">
<p>Scaled numbers are indexed as integers, typically a long (64 bits),
with a fixed scale that is consistent for all values of the field across all documents.
Because scaled numbers are indexed with a fixed precision, they cannot represent all <code>BigDecimal</code> or <code>BigInteger</code> values.
Values that are too large to be indexed  will trigger a runtime exception.
Values that have trailing decimal digits will be rounded to the nearest integer.</p>
</div>
<div class="paragraph">
<p>This annotation allows to set <a href="#mapping-directfieldmapping-decimalscale">the decimalScale attribute</a>.</p>
</div>
</dd>
<dt class="hdlist1"><code>@NonStandardField</code></dt>
<dd>
<p>An annotation for advanced use cases
where a <a href="#binding-valuebridge-valuebinder">value binder</a> is used
and that binder is expected to define an index field type that does not support
any of the standard options: <code>searchable</code>, <code>sortable</code>, &#8230;&#8203;</p>
<div class="paragraph">
<p>This annotation is very useful for cases when a field type native to the backend is necessary:
<a href="#backend-elasticsearch-field-types-extension">defining the mapping directly as JSON</a> for Elasticsearch,
or <a href="#backend-lucene-field-types-extension">manipulating <code>IndexableField</code> directly</a> for Lucene.</p>
</div>
<div class="paragraph">
<p>Fields mapped using this annotation have very limited configuration options from the annotation
(no <code>searchable</code>/<code>sortable</code>/etc.),
but the value binder will be able to pick a non-standard field type,
which generally gives much more flexibility.</p>
</div>
</dd>
<dt class="hdlist1"><a id="mapping-directfieldmapping-annotations-vectorfield"></a>  <code>@VectorField</code></dt>
<dd>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Features detailed below are <em>incubating</em>: they are still under active development.</p>
</div>
<div class="paragraph">
<p>The usual <a href="https://hibernate.org/community/compatibility-policy/">compatibility policy</a> does not apply:
the contract of incubating elements (e.g. types, methods, configuration properties, etc.)
may be altered in a backward-incompatible way&#8201;&#8212;&#8201;or even removed&#8201;&#8212;&#8201;in subsequent releases.</p>
</div>
<div class="paragraph">
<p>You are encouraged to use incubating features so the development team can get feedback and improve them,
but you should be prepared to update code which relies on them as needed.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Specific field type for vector fields to be used in a <a href="#search-dsl-predicate-knn">vector search</a>.</p>
</div>
<div class="paragraph">
<p>Vector fields accept values of type <code>float[]</code> or <code>byte[]</code> and <strong>require</strong> that
the <a href="#mapping-directfieldmapping-dimension">dimension</a> of stored vectors is specified upfront and that the indexed vectors
size match this dimension.</p>
</div>
<div class="paragraph">
<p>Besides that, vector fields allow optionally configuring
the <a href="#mapping-directfieldmapping-vectorSimilarity">similarity function</a> used during search,
<a href="#mapping-directfieldmapping-efConstruction"><code>efConstruction</code></a>
and <a href="#mapping-directfieldmapping-m"><code>m</code></a> used during indexing.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Vector fields, on the contrary to the other field types, disable the container extraction by default
Manually setting the <a href="#mapping-directfieldmapping-extraction">extraction</a> to <code>DEFAULT</code> will result in an exception.
Only explicitly <a href="#mapping-containerextractor-explicit">configured extractors</a> are allowed for vector fields.
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
It is not allowed to index multiple vectors within the same field, i.e. vector fields cannot be <a href="#binding-index-field-dsl-multi-valued-fields">multivalued</a>.
</td>
</tr>
</table>
</div>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="mapping-directfieldmapping-annotation-attributes"><a class="anchor" href="#mapping-directfieldmapping-annotation-attributes"></a>10.5.3. <a id="mapper-orm-directfieldmapping-annotation-attributes"></a> Field annotation attributes</h4>
<div class="paragraph">
<p>Various field mapping annotations exist,
each offering its own set of attributes.</p>
</div>
<div class="paragraph">
<p>This section lists the different annotation attributes and their use.
For more details about available annotations,
see <a href="#mapping-directfieldmapping-annotations"> Available field annotations</a>.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><a id="mapping-directfieldmapping-name"></a> <a id="mapper-orm-directfieldmapping-name"></a> <code>name</code></dt>
<dd>
<p>The name of the index field. By default, it is the same as the property name.
You may want to change it in particular when mapping a single property to multiple fields.</p>
<div class="paragraph">
<p>Value: <code>String</code>. The name must not contain the dot character (<code>.</code>).
Defaults to the name of the property.</p>
</div>
</dd>
<dt class="hdlist1"><a id="mapping-directfieldmapping-sortable"></a> <a id="mapper-orm-directfieldmapping-sortable"></a> <code>sortable</code></dt>
<dd>
<p>Whether the field can be <a href="#search-dsl-sort">sorted on</a>,
i.e. whether a specific data structure is added to the index to allow efficient sorts when querying.</p>
<div class="paragraph">
<p>Value: <code>Sortable.YES</code>, <code>Sortable.NO</code>, <code>Sortable.DEFAULT</code>.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This option is not available for <code>@FullTextField</code>.
See <a href="#mapping-directfieldmapping-annotations-fulltextfield">here</a> for an explanation and some solutions.</p>
</div>
</td>
</tr>
</table>
</div>
</dd>
<dt class="hdlist1"><a id="mapping-directfieldmapping-projectable"></a> <a id="mapper-orm-directfieldmapping-projectable"></a> <code>projectable</code></dt>
<dd>
<p>Whether the field can be <a href="#search-dsl-projection">projected on</a>,
i.e. whether the field value is stored in the index to allow retrieval later when querying.</p>
<div class="paragraph">
<p>Value: <code>Projectable.YES</code>, <code>Projectable.NO</code>, <code>Projectable.DEFAULT</code>.</p>
</div>
<div class="paragraph">
<p>The defaults are different for the <a href="#backend-lucene">Lucene</a> and <a href="#backend-elasticsearch">Elasticsearch</a> backends:
with Lucene, the default is <code>Projectable.NO</code>, while with Elasticsearch it&#8217;s <code>Projectable.YES</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>For <a href="#backend-elasticsearch">Elasticsearch</a> if any of <code>projectable</code> or <code>sortable</code> properties are resolved to <code>YES</code>
on a <code>GeoPoint</code> field then this field automatically becomes both <code>projectable</code> and <code>sortable</code> even if one of them was explicitly set to <code>NO</code>.</p>
</div>
</td>
</tr>
</table>
</div>
</dd>
<dt class="hdlist1"><a id="mapping-directfieldmapping-aggregable"></a> <a id="mapper-orm-directfieldmapping-aggregable"></a> <code>aggregable</code></dt>
<dd>
<p>Whether the field can be <a href="#search-dsl-aggregation">aggregated</a>,
i.e. whether the field value is stored in a specific data structure in the index
to allow aggregations later when querying.</p>
<div class="paragraph">
<p>Value: <code>Aggregable.YES</code>, <code>Aggregable.NO</code>, <code>Aggregable.DEFAULT</code>.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This option is not available for <code>@FullTextField</code>.
See <a href="#mapping-directfieldmapping-annotations-fulltextfield">here</a> for an explanation and some solutions.</p>
</div>
</td>
</tr>
</table>
</div>
</dd>
<dt class="hdlist1"><code>searchable</code></dt>
<dd>
<p>Whether the field can be searched on.
i.e. whether the field is indexed in order to allow applying predicates later when querying.</p>
<div class="paragraph">
<p>Value: <code>Searchable.YES</code>, <code>Searchable.NO</code>, <code>Searchable.DEFAULT</code>.</p>
</div>
</dd>
<dt class="hdlist1"><a id="mapping-directfieldmapping-indexnullas"></a> <a id="mapper-orm-directfieldmapping-indexnullas"></a> <code>indexNullAs</code></dt>
<dd>
<p>The value to use as a replacement anytime the property value is null.</p>
<div class="paragraph">
<p>Disabled by default.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The replacement is defined as a String. Thus, its value has to be parsed.
Look up the column <em>Parsing method for 'indexNullAs'</em> in <a href="#mapping-directfieldmapping-supported-types">  Supported property types</a> to find out the format used when parsing.</p>
</div>
</td>
</tr>
</table>
</div>
</dd>
<dt class="hdlist1"><a id="mapping-directfieldmapping-extraction"></a>  <code>extraction</code></dt>
<dd>
<p>How elements to index should be extracted from the property in the case of container types
(<code>List</code>, <code>Optional</code>, <code>Map</code>, &#8230;&#8203;).</p>
<div class="paragraph">
<p>By default, for properties that have a container type,
the innermost elements will be indexed.
For example for a property of type <code>List&lt;String&gt;</code>, elements of type <code>String</code> will be indexed.</p>
</div>
<div class="paragraph">
<p>Vector fields disable the extraction by default.</p>
</div>
<div class="paragraph">
<p>This default behavior and ways to override it are described
in the section <a href="#mapping-containerextractor"> Mapping container types with container extractors</a>.</p>
</div>
</dd>
<dt class="hdlist1"><a id="mapping-directfieldmapping-analyzer"></a> <a id="mapper-orm-directfieldmapping-analyzer"></a> <code>analyzer</code></dt>
<dd>
<p>The analyzer to apply to field values when indexing and querying.
Only available on <code>@FullTextField</code>.</p>
<div class="paragraph">
<p>By default, the analyzer named <code>default</code> will be used.</p>
</div>
<div class="paragraph">
<p>See <a href="#concepts-analysis"> Analysis</a> for more details about analyzers and full-text analysis.</p>
</div>
</dd>
<dt class="hdlist1"><a id="mapping-directfieldmapping-search-analyzer"></a> <a id="mapper-orm-directfieldmapping-search-analyzer"></a> <code>searchAnalyzer</code></dt>
<dd>
<p>An optional different analyzer, overriding the one defined with the <code>analyzer</code> attribute,
to use only when analyzing searched terms.</p>
<div class="paragraph">
<p>If not defined, the analyzer assigned to <code>analyzer</code> will be used.</p>
</div>
<div class="paragraph">
<p>See <a href="#concepts-analysis"> Analysis</a> for more details about analyzers and full-text analysis.</p>
</div>
</dd>
<dt class="hdlist1"><a id="mapping-directfieldmapping-normalizer"></a> <a id="mapper-orm-directfieldmapping-normalizer"></a> <code>normalizer</code></dt>
<dd>
<p>The normalizer to apply to field values when indexing and querying.
Only available on <code>@KeywordField</code>.</p>
<div class="paragraph">
<p>See <a href="#concepts-analysis"> Analysis</a> for more details about normalizers and full-text analysis.</p>
</div>
</dd>
<dt class="hdlist1"><code>norms</code></dt>
<dd>
<p>Whether index-time scoring information for the field should be stored or not.
Only available on <code>@KeywordField</code> and <code>@FullTextField</code>.</p>
<div class="paragraph">
<p>Enabling norms will improve the quality of scoring.
Disabling norms will reduce the disk space used by the index.</p>
</div>
<div class="paragraph">
<p>Value: <code>Norms.YES</code>, <code>Norms.NO</code>, <code>Norms.DEFAULT</code>.</p>
</div>
</dd>
<dt class="hdlist1"><a id="mapping-directfieldmapping-term-vector"></a><code>termVector</code></dt>
<dd>
<p>The term vector storing strategy.
Only available on <code>@FullTextField</code>.</p>
<div class="paragraph">
<p>The different values of this attribute are:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Value</th>
<th class="tableblock halign-left valign-top">Definition</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>TermVector.YES</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Store the term vectors of each document.
	This produces two synchronized arrays, one contains document terms and the other contains the term&#8217;s frequency.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>TermVector.NO</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Do not store term vectors.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>TermVector.WITH_POSITIONS</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Store the term vector and token position information.
	This is the same as <code>TermVector.YES</code> plus it contains the ordinal positions of each occurrence of a term in a document.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>TermVector.WITH_OFFSETS</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Store the term vector and token offset information.
	This is the same as <code>TermVector.YES</code> plus it contains the starting and ending offset position information for the terms.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>TermVector.WITH_POSITION_OFFSETS</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Store the term vector, token position and offset information.
	This is a combination of the <code>YES</code>, <code>WITH_OFFSETS</code> and <code>WITH_POSITIONS</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>TermVector.WITH_POSITIONS_PAYLOADS</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Store the term vector, token position and token payloads.
	This is the same as <code>TermVector.WITH_POSITIONS</code> plus it contains the payload of each occurrence of a term in a document.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>TermVector.WITH_POSITIONS_OFFSETS_PAYLOADS</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Store the term vector, token position, offset information and token payloads.
	This is the same as <code>TermVector.WITH_POSITION_OFFSETS</code> plus it contains the payload of each occurrence of a term in a document.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Note that <a href="#mapping-directfieldmapping-highlightable">highlighter types requested</a> by the full-text field might affect the finally resolved term vector storing strategy.
Since the fast vector highlighter type has <a href="#mapping-directfieldmapping-highlightable-fast-vector">specific requirements</a> regarding the term vector storing strategy,
if it is requested explicitly or implicitly through the usage of <code>Highlightable.ANY</code>,
it will set the strategy to <code>TermVector.WITH_POSITIONS_OFFSETS</code> unless a strategy was already specified.
An exception will be thrown if a non-default strategy that is not compatible with the fast vector highlighter is used.</p>
</div>
</dd>
<dt class="hdlist1"><a id="mapping-directfieldmapping-decimalscale"></a> <a id="mapper-orm-directfieldmapping-decimalscale"></a> <code>decimalScale</code></dt>
<dd>
<p>How the scale of a large number (<code>BigInteger</code> or <code>BigDecimal</code>) should be adjusted before it is indexed as a fixed-precision integer.
Only available on <code>@ScaledNumberField</code>.</p>
<div class="paragraph">
<p>To index numbers that have significant digits after the decimal point, set the <code>decimalScale</code> to the number of digits you need indexed.
The decimal point will be shifted that many times to the right before indexing, preserving that many digits from the decimal part.
To index very large numbers that cannot fit in a long, set the decimal point to a negative value.
The decimal point will be shifted that many times to the left before indexing, dropping all digits from the decimal part.</p>
</div>
<div class="paragraph">
<p><code>decimalScale</code> with strictly positive values is allowed only for <code>BigDecimal</code>, since <code>BigInteger</code> values have no decimal digits.</p>
</div>
<div class="paragraph">
<p>Note that shifting of the decimal points is completely transparent and will not affect how you use the search DSL:
you be expected to provide "normal" <code>BigDecimal</code> or <code>BigInteger</code> values,
and Hibernate Search will apply the <code>decimalScale</code> and rounding transparently.</p>
</div>
<div class="paragraph">
<p>As a result of the rounding, search predicates and sorts will only be as precise as what the <code>decimalScale</code> allows.</p>
</div>
<div class="paragraph">
<p>Note that rounding does not affect projections, which will return the original value without any loss of precision.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
A typical use case is monetary amounts, with a decimal scale of 2
because only two digits are generally needed beyond the decimal point.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
With the <a href="#mapper-orm">Hibernate ORM integration</a>,
a default <code>decimalScale</code> is taken automatically from the underlying <code>scale</code> value of the relative SQL <code>@Column</code>,
using the Hibernate ORM metadata. The value could be overridden explicitly using the <code>decimalScale</code> attribute.
</td>
</tr>
</table>
</div>
</dd>
<dt class="hdlist1"><a id="mapping-directfieldmapping-highlightable"></a> <code>highlightable</code></dt>
<dd>
<p>Whether the field can be <a href="#search-dsl-highlighting">highlighted</a> and if so which highlighter types can be applied to it.
I.e. whether the field value is indexed/stored in a specific format to allow highlighting later when querying.
Only available on <code>@FullTextField</code>.</p>
<div class="paragraph">
<p>While for most cases picking one highlighter type should be enough, this attribute can accept multiple, non contradicting values.
Please refer to <a href="#search-dsl-highlighting-highlighter-type">highlighter types section</a> to see which highlighter to select.
Available values are:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Value</th>
<th class="tableblock halign-left valign-top">Definition</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Highlightable.NO</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Do not allow highlighting on the field.
<a id="mapping-directfieldmapping-highlightable-any"></a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Highlightable.ANY</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Allow any highlighter type be applied for highlighting the field.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Highlightable.PLAIN</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Allow the plain highlighter type be applied for highlighting the field.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Highlightable.UNIFIED</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Allow the unified highlighter type be applied for highlighting the field.
<a id="mapping-directfieldmapping-highlightable-fast-vector"></a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Highlightable.FAST_VECTOR</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Allow the fast vector highlighter type be applied for highlighting the field.
This highlighter type requires a <a href="#mapping-directfieldmapping-term-vector">term vector storage strategy</a> to be set to <code>WITH_POSITIONS_OFFSETS</code>
or <code>WITH_POSITIONS_OFFSETS_PAYLOADS</code>.
<a id="mapping-directfieldmapping-highlightable-default"></a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Highlightable.DEFAULT</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Use the backend-specific default that is dependent on an overall field configuration.
<a href="#backend-elasticsearch">Elasticsearch&#8217;s</a> default value is <code>[Highlightable.PLAIN, Highlightable.UNIFIED]</code>.
<a href="#backend-lucene">Lucene&#8217;s</a> default value is dependent on the <a href="#mapping-directfieldmapping-projectable">projectable value</a> configured for the field.
If the field is projectable then <code>[PLAIN, UNIFIED]</code> highlighters are supported.
Otherwise, highlighting is not supported (<code>Highlightable.NO</code>).
Additionally, if the <a href="#mapping-directfieldmapping-term-vector">term vector storing strategy</a> is set to <code>WITH_POSITIONS_OFFSETS</code>
or <code>WITH_POSITIONS_OFFSETS_PAYLOADS</code>, both backends would support the <code>FAST_VECTOR</code>
highlighter, if they already support the other two (<code>[PLAIN, UNIFIED]</code>).</p></td>
</tr>
</tbody>
</table>
</dd>
<dt class="hdlist1"><a id="mapping-directfieldmapping-dimension"></a> <code>dimension</code></dt>
<dd>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Features detailed below are <em>incubating</em>: they are still under active development.</p>
</div>
<div class="paragraph">
<p>The usual <a href="https://hibernate.org/community/compatibility-policy/">compatibility policy</a> does not apply:
the contract of incubating elements (e.g. types, methods, configuration properties, etc.)
may be altered in a backward-incompatible way&#8201;&#8212;&#8201;or even removed&#8201;&#8212;&#8201;in subsequent releases.</p>
</div>
<div class="paragraph">
<p>You are encouraged to use incubating features so the development team can get feedback and improve them,
but you should be prepared to update code which relies on them as needed.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The size of the stored vectors. This is a required field. This size should match the vector size of the vectors produced by
the model used to convert the data into vector representation.
It is expected to be a positive integer value. Maximum accepted value is backend-specific.
For the <a href="#backend-lucene">Lucene backend</a> the dimension must be in <code>[1, 4096]</code> range.
As for the <a href="#backend-elasticsearch">Elasticsearch backend</a> the range depends on the distribution.
See the <a href="https://www.elastic.co/guide/en/elasticsearch/reference/8.13/dense-vector.html#dense-vector-params">Elasticsearch</a>/<a href="https://opensearch.org/docs/2.13/search-plugins/knn/approximate-knn/#get-started-with-approximate-k-nn">OpenSearch</a>
specific documentation to learn about the vector types of these distributions.</p>
</div>
<div class="paragraph">
<p>Only available on <code>@VectorField</code>.</p>
</div>
</dd>
<dt class="hdlist1"><a id="mapping-directfieldmapping-vectorSimilarity"></a> <code>vectorSimilarity</code></dt>
<dd>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Features detailed below are <em>incubating</em>: they are still under active development.</p>
</div>
<div class="paragraph">
<p>The usual <a href="https://hibernate.org/community/compatibility-policy/">compatibility policy</a> does not apply:
the contract of incubating elements (e.g. types, methods, configuration properties, etc.)
may be altered in a backward-incompatible way&#8201;&#8212;&#8201;or even removed&#8201;&#8212;&#8201;in subsequent releases.</p>
</div>
<div class="paragraph">
<p>You are encouraged to use incubating features so the development team can get feedback and improve them,
but you should be prepared to update code which relies on them as needed.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Defines how vector similarity is calculated during a <a href="#search-dsl-predicate-knn">vector search</a>.</p>
</div>
<div class="paragraph">
<p>Only available on <code>@VectorField</code>.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Value</th>
<th class="tableblock halign-left valign-top">Definition</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>VectorSimilarity.L2</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>An L2 (Euclidean) norm, that is a sensible default for most scenarios.
Distance between vectors <code>x</code> and <code>y</code> is calculated as
\(d(x,y) = \sqrt{\sum_{i=1}^{n} (x_i - y_i)^2 } \)
and the score function is
\(s = \frac{1}{1+d^2}\)</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>VectorSimilarity.DOT_PRODUCT</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Inner product (dot product in particular).
Distance between vectors <code>x</code> and <code>y</code> is calculated as
\(d(x,y) = \sum_{i=1}^{n} x_i \cdot y_i \)
and the score function is
\(s = \frac{1}{1+d}\)</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>To use this similarity efficiently, both index and search vectors <strong>must</strong> be normalized;
otherwise search may produce poor results.
Floating point vectors must be <a href="https://en.wikipedia.org/wiki/Unit_vector">normalized to be of unit length</a>,
while byte vectors should simply all have the same norm.</p>
</div>
</td>
</tr>
</table>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>VectorSimilarity.COSINE</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Cosine similarity.
Distance between vectors <code>x</code> and <code>y</code> is calculated as
\(d(x,y) = \frac{1 - \sum_{i=1} ^{n} x_i \cdot y_i }{ \sqrt{ \sum_{i=1} ^{n} x_i^2 } \sqrt{ \sum_{i=1} ^{n} y_i^2 }} \)
and the score function is
\(s = \frac{1}{1+d}\)</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>VectorSimilarity.MAX_INNER_PRODUCT</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Similar to a dot product similarity, but does not require vector normalization.
Distance between vectors <code>x</code> and <code>y</code> is calculated as
\(d(x,y) = \sum_{i=1}^{n} x_i \cdot y_i \)
and the score function is
\(s = \begin{cases}
\frac{1}{1-d} &amp; \text{if d &lt; 0}\\
d+1 &amp; \text{otherwise}
\end{cases} \)</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>VectorSimilarity.DEFAULT</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Use the backend-specific default. For the <a href="#backend-lucene">Lucene backend</a> an <code>L2</code> similarity is used.</p>
</div></div></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 4. How the vector similarity matches to a backend-specific value</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Hibernate Search Value</th>
<th class="tableblock halign-left valign-top">Lucene Backend</th>
<th class="tableblock halign-left valign-top">Elasticsearch Backend</th>
<th class="tableblock halign-left valign-top">Elasticsearch Backend (OpenSearch distribution)</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>DEFAULT</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>EUCLIDEAN</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Elasticsearch default</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">OpenSearch default.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>L2</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>EUCLIDEAN</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>l2_norm</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>l2</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>DOT_PRODUCT</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>DOT_PRODUCT</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>dot_product</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">currently <strong>not supported</strong> by OpenSearch and will result in an exception.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>COSINE</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>COSINE</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>cosine</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>cosinesimil</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>MAX_INNER_PRODUCT</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>MAXIMUM_INNER_PRODUCT</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>max_inner_product</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">currently <strong>not supported</strong> by OpenSearch and will result in an exception.</p></td>
</tr>
</tbody>
</table>
</dd>
<dt class="hdlist1"><a id="mapping-directfieldmapping-efConstruction"></a> <code>efConstruction</code></dt>
<dd>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Features detailed below are <em>incubating</em>: they are still under active development.</p>
</div>
<div class="paragraph">
<p>The usual <a href="https://hibernate.org/community/compatibility-policy/">compatibility policy</a> does not apply:
the contract of incubating elements (e.g. types, methods, configuration properties, etc.)
may be altered in a backward-incompatible way&#8201;&#8212;&#8201;or even removed&#8201;&#8212;&#8201;in subsequent releases.</p>
</div>
<div class="paragraph">
<p>You are encouraged to use incubating features so the development team can get feedback and improve them,
but you should be prepared to update code which relies on them as needed.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><code>efConstruction</code> is the size of the dynamic list used during k-NN graph creation. It affects how vectors are stored.
Higher values lead to a more accurate graph but slower indexing speed.</p>
</div>
<div class="paragraph">
<p>Default value is backend-specific.</p>
</div>
<div class="paragraph">
<p>Only available on <code>@VectorField</code>.</p>
</div>
</dd>
<dt class="hdlist1"><a id="mapping-directfieldmapping-m"></a> <code>m</code></dt>
<dd>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Features detailed below are <em>incubating</em>: they are still under active development.</p>
</div>
<div class="paragraph">
<p>The usual <a href="https://hibernate.org/community/compatibility-policy/">compatibility policy</a> does not apply:
the contract of incubating elements (e.g. types, methods, configuration properties, etc.)
may be altered in a backward-incompatible way&#8201;&#8212;&#8201;or even removed&#8201;&#8212;&#8201;in subsequent releases.</p>
</div>
<div class="paragraph">
<p>You are encouraged to use incubating features so the development team can get feedback and improve them,
but you should be prepared to update code which relies on them as needed.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The number of neighbors each node will be connected to in the <a href="https://en.wikipedia.org/wiki/Nearest_neighbor_search#cite_note-:0-10">HNSW (Hierarchical Navigable Small World graphs) graph</a>.
Modifying this value will have an impact on memory consumption.
It is recommended to keep this value between 2 and 100.</p>
</div>
<div class="paragraph">
<p>Default value is backend-specific.</p>
</div>
<div class="paragraph">
<p>Only available on <code>@VectorField</code>.</p>
</div>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="mapping-directfieldmapping-supported-types"><a class="anchor" href="#mapping-directfieldmapping-supported-types"></a>10.5.4. <a id="mapper-orm-directfieldmapping-supported-types"></a> <a id="section-built-in-bridges"></a> Supported property types</h4>
<div class="paragraph">
<p>Below is a table listing all types with built-in value bridges,
i.e. property types that are supported out of the box
when mapping a property to an index field.</p>
</div>
<div class="paragraph">
<p>The table also explains the value assigned to the index field,
i.e. the value passed to the underlying backend for indexing.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>For information about the underlying indexing and storage used by the backend,
see <a href="#backend-lucene-field-types">Lucene field types</a>
or <a href="#backend-elasticsearch-field-types">Elasticsearch field types</a> depending on your backend.</p>
</div>
</td>
</tr>
</table>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 5. Property types with built-in value bridges</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property type</th>
<th class="tableblock halign-left valign-top">Value of index field (if different)</th>
<th class="tableblock halign-left valign-top">Limitations</th>
<th class="tableblock halign-left valign-top">Parsing method for 'indexNullAs'</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>All enum types</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>name()</code> as a <code>java.lang.String</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Enum.valueOf(String)</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.lang.String</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.lang.Character, char</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A single-character <code>java.lang.String</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Accepts any single-character <code>java.lang.String</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.lang.Byte, byte</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Byte.parseByte(String)</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.lang.Short, short</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Short.parseShort(String)</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.lang.Integer, int</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Integer.parseInt(String)</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.lang.Long, long</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Long.parseLong(String)</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.lang.Double, double</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Double.parseDouble(String)</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.lang.Float, float</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Float.parseFloat(String)</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.lang.Boolean, boolean</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Accepts the strings <code>true</code> or <code>false</code>, ignoring case</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.math.BigDecimal</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>new BigDecimal(String)</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.math.BigInteger</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>new BigInteger(String)</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.net.URI</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>toString()</code> as a <code>java.lang.String</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>new URI(String)</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.net.URL</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>toExternalForm()</code> as a <code>java.lang.String</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>new URL(String)</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.time.Instant</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#mapping-directfieldmapping-supported-types-date-time">Possibly lower range/resolution</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Instant.parse(String)</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.time.LocalDate</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#mapping-directfieldmapping-supported-types-date-time">Possibly lower range/resolution</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>LocalDate.parse(String)</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.time.LocalTime</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#mapping-directfieldmapping-supported-types-date-time">Possibly lower range/resolution</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>LocalTime.parse(String)</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.time.LocalDateTime</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#mapping-directfieldmapping-supported-types-date-time">Possibly lower range/resolution</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>LocalDateTime.parse(String)</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.time.OffsetDateTime</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#mapping-directfieldmapping-supported-types-date-time">Possibly lower range/resolution</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>OffsetDateTime.parse(String)</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.time.OffsetTime</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#mapping-directfieldmapping-supported-types-date-time">Possibly lower range/resolution</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>OffsetTime.parse(String)</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.time.ZonedDateTime</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#mapping-directfieldmapping-supported-types-date-time">Possibly lower range/resolution</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ZonedDateTime.parse(String)</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.time.ZoneId</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>getId()</code> as a <code>java.lang.String</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ZoneId.of(String)</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.time.ZoneOffset</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>getTotalSeconds()</code> as a <code>java.lang.Integer</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ZoneOffset.of(String)</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.time.Period</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A formatted <code>java.lang.String</code>: <code>&lt;years on 11 characters&gt;&lt;months on 11 characters&gt;&lt;days on 11 characters&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Period.parse(String)</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.time.Duration</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>toNanos()</code> as a <code>java.lang.Long</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#mapping-directfieldmapping-supported-types-date-time">Possibly lower range/resolution</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Duration.parse(String)</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.time.Year</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#mapping-directfieldmapping-supported-types-date-time">Possibly lower range/resolution</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Year.parse(String)</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.time.YearMonth</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#mapping-directfieldmapping-supported-types-date-time">Possibly lower range/resolution</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>YearMonth.parse(String)</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.time.MonthDay</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>MonthDay.parse(String)</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.util.UUID</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>toString()</code> as a <code>java.lang.String</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>UUID.fromString(String)</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.util.Calendar</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A <code>java.time.ZonedDateTime</code> representing the same date/time and timezone.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">See <a href="#mapping-legacy-date-time-apis"> Support for legacy <code>java.util</code> date/time APIs</a>.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ZonedDateTime.parse(String)</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.util.Date</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Instant.ofEpochMilli(long)</code> as a <code>java.time.Instant</code>.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">See <a href="#mapping-legacy-date-time-apis"> Support for legacy <code>java.util</code> date/time APIs</a>.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Instant.parse(String)</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.sql.Timestamp</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Instant.ofEpochMilli(long)</code> as a <code>java.time.Instant</code>.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">See <a href="#mapping-legacy-date-time-apis"> Support for legacy <code>java.util</code> date/time APIs</a>.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Instant.parse(String)</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.sql.Date</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Instant.ofEpochMilli(long)</code> as a <code>java.time.Instant</code>.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">See <a href="#mapping-legacy-date-time-apis"> Support for legacy <code>java.util</code> date/time APIs</a>.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Instant.parse(String)</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.sql.Time</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Instant.ofEpochMilli(long)</code> as a <code>java.time.Instant</code>.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">See <a href="#mapping-legacy-date-time-apis"> Support for legacy <code>java.util</code> date/time APIs</a>.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Instant.parse(String)</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><a href="#mapping-geopoint-basics">GeoPoint</a> and subtypes</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Latitude as double and longitude as double, separated by a comma. Ex: <code>41.8919, 12.51133</code>.</p></td>
</tr>
</tbody>
</table>
<div id="mapping-directfieldmapping-supported-types-date-time" class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Range and resolution of date/time fields</div>
<div class="paragraph">
<p>With a few exceptions, most date and time values are passed as-is to the backend;
e.g. a <code>LocalDateTime</code> property would be passed as a <code>LocalDateTime</code> to the backend.</p>
</div>
<div class="paragraph">
<p>Internally, however, the Lucene and Elasticsearch backend use a different representation of date/time types.
As a result, date and time fields stored in the index may have a smaller range and resolution
than the corresponding Java type.</p>
</div>
<div class="paragraph">
<p>The documentation of each backend provides more information:
see <a href="#backend-lucene-field-types-date-time">here for Lucene</a>
and <a href="#backend-elasticsearch-field-types-date-time">here for Elasticsearch</a>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="mapping-legacy-date-time-apis"><a class="anchor" href="#mapping-legacy-date-time-apis"></a>10.5.5. <a id="mapper-orm-legacy-date-time-apis"></a> Support for legacy <code>java.util</code> date/time APIs</h4>
<div class="paragraph">
<p>Using legacy date/time types such as <code>java.util.Calendar</code>, <code>java.util.Date</code>, <code>java.sql.Timestamp</code>, <code>java.sql.Date</code>, <code>java.sql.Time</code>
is not recommended,
due to their numerous quirks and shortcomings.
The <a href="https://docs.oracle.com/javase/8/docs/api/java/time/package-summary.html"><code>java.time</code></a> package introduced
in Java 8 should generally be preferred.</p>
</div>
<div class="paragraph">
<p>That being said, integration constraints may force you to rely on the legacy date/time APIs,
which is why Hibernate Search still attempts to support them on a best effort basis.</p>
</div>
<div class="paragraph">
<p>Since Hibernate Search uses the <code>java.time</code> APIs to represent date/time internally,
the legacy date/time types need to be converted before they can be indexed.
Hibernate Search keeps things simple:
<code>java.util.Date</code>, <code>java.util.Calendar</code>, etc. will be converted using their time-value (number of milliseconds since the epoch),
which will be assumed to represent the same date/time in Java 8 APIs.
In the case of <code>java.util.Calendar</code>, timezone information will be preserved for projections.</p>
</div>
<div class="paragraph">
<p>For all dates after 1900, this will work exactly as expected.</p>
</div>
<div class="paragraph">
<p>Before 1900, indexing and searching through Hibernate Search APIs will also work as expected,
but <strong>if you need to access the index natively</strong>, for example through direct HTTP calls to an Elasticsearch server,
you will notice that the indexed values are slightly "off".
This is caused by differences in the implementation of <code>java.time</code> and legacy date/time APIs
which lead to slight differences in the interpretation of time-values (number of milliseconds since the epoch).</p>
</div>
<div class="paragraph">
<p>The "drifts" are consistent: they will also happen when building a predicate,
and they will happen in the opposite direction when projecting.
As a result, the differences will not be visible from an application relying on the Hibernate Search APIs exclusively.
They will, however, be visible when accessing indexes natively.</p>
</div>
<div class="paragraph">
<p>For the large majority of use cases, this will not be a problem.
If this behavior is not acceptable for your application,
you should look into implementing custom <a href="#binding-valuebridge">value bridges</a>
and instructing Hibernate Search to use them by default for <code>java.util.Date</code>, <code>java.util.Calendar</code>, etc.:
see <a href="#binding-bridge-resolver">  Assigning default bridges with the bridge resolver</a>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Technically, conversions are difficult because the <code>java.time</code> APIs
and the legacy date/time APIs do not have the same internal calendar.</p>
</div>
<div class="paragraph">
<p>In particular:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>java.time</code> assumes a "Local Mean Time" before 1900, while legacy date/time APIs do not support it
(<a href="https://bugs.openjdk.java.net/browse/JDK-6281408">JDK-6281408</a>),
As a result, time values (number of milliseconds since the epoch) reported by the two APIs
will be different for dates before 1900.</p>
</li>
<li>
<p><code>java.time</code> uses a proleptic Gregorian calendar before October 15, 1582,
meaning it acts as if the Gregorian calendar, along with its system of leap years, had always existed.
Legacy date/time APIs, on the other hand, use the Julian calendar before that date (by default),
meaning the leap years are not exactly the same ones.
As a result, some dates that are deemed valid by one API will be deemed invalid by the other,
for example February 29, 1500.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Those are the two main problems, but there may be others.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="mapping-directfieldmapping-custom-types"><a class="anchor" href="#mapping-directfieldmapping-custom-types"></a>10.5.6. <a id="mapper-orm-directfieldmapping-custom-types"></a> Mapping custom property types</h4>
<div class="paragraph">
<p>Even types that are not <a href="#mapping-directfieldmapping-supported-types">supported out of the box</a> can be mapped.
There are various solutions, some simple and some more powerful,
but they all come down to extracting data from the unsupported type and converting it to types that are
supported by the backend.</p>
</div>
<div class="paragraph">
<p>There are two cases to distinguish between:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>If the unsupported type is simply a container (<code>List&lt;String&gt;</code>)
or multiple nested containers (<code>Map&lt;Integer, List&lt;String&gt;&gt;</code>)
whose elements have a supported type,
then what you need is a container extractor.
See <a href="#mapping-containerextractor"> Mapping container types with container extractors</a> for more information.</p>
</li>
<li>
<p>Otherwise, you will have to rely on a custom component, called a bridge, to extract data from your type.
See <a href="#binding">  Binding and bridges</a> for more information on custom bridges.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="mapping-directfieldmapping-programmatic"><a class="anchor" href="#mapping-directfieldmapping-programmatic"></a>10.5.7. <a id="mapper-orm-directfieldmapping-programmatic"></a> Programmatic mapping</h4>
<div class="paragraph">
<p>You can map properties of an entity to an index field directly
through the <a href="#mapping-programmatic">programmatic mapping</a> too.
Behavior and options are identical to annotation-based mapping.</p>
</div>
<div class="exampleblock">
<div class="title">Example 35. Mapping properties to fields directly with <code>.genericField()</code>, <code>.fullTextField()</code>, &#8230;&#8203;</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">TypeMappingStep bookMapping = mapping.type( <span class="predefined-type">Book</span>.class );
bookMapping.indexed();
bookMapping.property( <span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span> )
        .fullTextField()
                .analyzer( <span class="string"><span class="delimiter">&quot;</span><span class="content">english</span><span class="delimiter">&quot;</span></span> ).projectable( Projectable.YES )
        .keywordField( <span class="string"><span class="delimiter">&quot;</span><span class="content">title_sort</span><span class="delimiter">&quot;</span></span> )
                .normalizer( <span class="string"><span class="delimiter">&quot;</span><span class="content">english</span><span class="delimiter">&quot;</span></span> ).sortable( Sortable.YES );
bookMapping.property( <span class="string"><span class="delimiter">&quot;</span><span class="content">pageCount</span><span class="delimiter">&quot;</span></span> )
        .genericField().projectable( Projectable.YES ).sortable( Sortable.YES );</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="mapping-indexedembedded"><a class="anchor" href="#mapping-indexedembedded"></a>10.6. <a id="mapper-orm-indexedembedded"></a> <a id="search-mapping-associated"></a> Mapping associated elements with <code>@IndexedEmbedded</code></h3>
<div class="sect3">
<h4 id="mapping-indexedembedded-basics"><a class="anchor" href="#mapping-indexedembedded-basics"></a>10.6.1. <a id="mapper-orm-indexedembedded-basics"></a> Basics</h4>
<div class="paragraph">
<p>Using only <code>@Indexed</code> combined with <code>@*Field</code> annotations allows indexing an entity and its direct properties,
which is nice but simplistic.
A real-world model will include multiple object types holding references to one another,
like the <code>authors</code> association in the example below.</p>
</div>
<div class="exampleblock">
<div class="title">Example 36. A multi-entity model with associations</div>
<div class="content">
<div class="paragraph">
<p>This mapping will declare the following fields in the <code>Book</code> index:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>title</code></p>
</li>
<li>
<p>&#8230;&#8203; and nothing else.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="annotation">@Entity</span>
<span class="annotation">@Indexed</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="directive">public</span> <span class="type">class</span> <span class="class">Book</span> {

    <span class="annotation">@Id</span>
    <span class="directive">private</span> <span class="predefined-type">Integer</span> id;

    <span class="annotation">@FullTextField</span>(analyzer = <span class="string"><span class="delimiter">&quot;</span><span class="content">english</span><span class="delimiter">&quot;</span></span>) <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="directive">private</span> <span class="predefined-type">String</span> title;

    <span class="annotation">@ManyToMany</span>
    <span class="directive">private</span> <span class="predefined-type">List</span>&lt;Author&gt; authors = <span class="keyword">new</span> <span class="predefined-type">ArrayList</span>&lt;&gt;(); <i class="conum" data-value="3"></i><b>(3)</b>

    <span class="directive">public</span> <span class="predefined-type">Book</span>() {
    }

    <span class="comment">// Getters and setters</span>
    <span class="comment">// ...</span>

}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="annotation">@Entity</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">Author</span> {

    <span class="annotation">@Id</span>
    <span class="directive">private</span> <span class="predefined-type">Integer</span> id;

    <span class="directive">private</span> <span class="predefined-type">String</span> name;

    <span class="annotation">@ManyToMany</span>(mappedBy = <span class="string"><span class="delimiter">&quot;</span><span class="content">authors</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">private</span> <span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; books = <span class="keyword">new</span> <span class="predefined-type">ArrayList</span>&lt;&gt;();

    <span class="directive">public</span> Author() {
    }

    <span class="comment">// Getters and setters</span>
    <span class="comment">// ...</span>

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>Book</code> entity is indexed.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The <code>title</code> of the book is mapped to an index field.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>But how to index the <code>Author</code> name into the <code>Book</code> index?</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>When searching for a book, users will likely need to search by author name.
In the world of high-performance indexes, cross-index joins are costly and usually not an option.
The best way to address such use cases is generally to copy data:
when indexing a <code>Book</code>, just copy the name of all its authors into the <code>Book</code> document.</p>
</div>
<div class="paragraph">
<p>That&#8217;s what <code>@IndexedEmbedded</code> does:
it instructs Hibernate Search to <em>embed</em> the fields of an associated object into the main object.
In the example below, it will instruct Hibernate Search to embed the <code>name</code> field
defined in <code>Author</code> into <code>Book</code>, creating the field <code>authors.name</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p><code>@IndexedEmbedded</code> can be used on Hibernate ORM&#8217;s <code>@Embedded</code> properties
as well as associations (<code>@OneToOne</code>, <code>@OneToMany</code>, <code>@ManyToMany</code>, &#8230;&#8203;).</p>
</div>
</td>
</tr>
</table>
</div>
<div id="example-indexing-associations" class="exampleblock">
<div class="title">Example 37. Using <code>@IndexedEmbedded</code> to index associated elements</div>
<div class="content">
<div class="paragraph">
<p>This mapping will declare the following fields in the <code>Book</code> index:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>title</code></p>
</li>
<li>
<p><code>authors.name</code></p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="annotation">@Entity</span>
<span class="annotation">@Indexed</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">Book</span> {

    <span class="annotation">@Id</span>
    <span class="directive">private</span> <span class="predefined-type">Integer</span> id;

    <span class="annotation">@FullTextField</span>(analyzer = <span class="string"><span class="delimiter">&quot;</span><span class="content">english</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">private</span> <span class="predefined-type">String</span> title;

    <span class="annotation">@ManyToMany</span>
    <span class="annotation">@IndexedEmbedded</span> <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="directive">private</span> <span class="predefined-type">List</span>&lt;Author&gt; authors = <span class="keyword">new</span> <span class="predefined-type">ArrayList</span>&lt;&gt;();

    <span class="directive">public</span> <span class="predefined-type">Book</span>() {
    }

    <span class="comment">// Getters and setters</span>
    <span class="comment">// ...</span>

}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="annotation">@Entity</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">Author</span> {

    <span class="annotation">@Id</span>
    <span class="directive">private</span> <span class="predefined-type">Integer</span> id;

    <span class="annotation">@FullTextField</span>(analyzer = <span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>) <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="directive">private</span> <span class="predefined-type">String</span> name;

    <span class="annotation">@ManyToMany</span>(mappedBy = <span class="string"><span class="delimiter">&quot;</span><span class="content">authors</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">private</span> <span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; books = <span class="keyword">new</span> <span class="predefined-type">ArrayList</span>&lt;&gt;();

    <span class="directive">public</span> Author() {
    }

    <span class="comment">// Getters and setters</span>
    <span class="comment">// ...</span>

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Add an <code>@IndexedEmbedded</code> to the <code>authors</code> property.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Map <code>Author.name</code> to an index field, even though <code>Author</code> is not directly mapped to an index (no <code>@Indexed</code>).</td>
</tr>
</table>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p><a href="#mapping-identifiermapping">Document identifiers</a> are not index fields.
Consequently, they will be ignored by <code>@IndexedEmbedded</code>.</p>
</div>
<div class="paragraph">
<p>To embed another entity&#8217;s identifier with <code>@IndexedEmbedded</code>,
map that identifier to a field explicitly using <code>@GenericField</code> or another <code>@*Field</code> annotation.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>When <code>@IndexedEmbedded</code> is applied to an association,
i.e. to a property that refers to entities (like the example above),
<strong>the association must be bidirectional</strong>.
Otherwise, Hibernate Search will throw an exception on startup.</p>
</div>
<div class="paragraph">
<p>See <a href="#mapping-indexedembedded-reindexing">  Reindexing when embedded elements change</a> for the reasons behind this restriction
and ways to circumvent it.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Index-embedding can be nested on multiple levels;
for example you can decide to index-embed the place of birth of authors,
to be able to search for books written by Russian authors exclusively:</p>
</div>
<div id="example-nested-index-embedded" class="exampleblock">
<div class="title">Example 38. Nesting multiple <code>@IndexedEmbedded</code></div>
<div class="content">
<div class="paragraph">
<p>This mapping will declare the following fields in the <code>Book</code> index:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>title</code></p>
</li>
<li>
<p><code>authors.name</code></p>
</li>
<li>
<p><code>authors.placeOfBirth.country</code></p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="annotation">@Entity</span>
<span class="annotation">@Indexed</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">Book</span> {

    <span class="annotation">@Id</span>
    <span class="directive">private</span> <span class="predefined-type">Integer</span> id;

    <span class="annotation">@FullTextField</span>(analyzer = <span class="string"><span class="delimiter">&quot;</span><span class="content">english</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">private</span> <span class="predefined-type">String</span> title;

    <span class="annotation">@ManyToMany</span>
    <span class="annotation">@IndexedEmbedded</span> <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="directive">private</span> <span class="predefined-type">List</span>&lt;Author&gt; authors = <span class="keyword">new</span> <span class="predefined-type">ArrayList</span>&lt;&gt;();

    <span class="directive">public</span> <span class="predefined-type">Book</span>() {
    }

    <span class="comment">// Getters and setters</span>
    <span class="comment">// ...</span>

}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="annotation">@Entity</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">Author</span> {

    <span class="annotation">@Id</span>
    <span class="directive">private</span> <span class="predefined-type">Integer</span> id;

    <span class="annotation">@FullTextField</span>(analyzer = <span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>) <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="directive">private</span> <span class="predefined-type">String</span> name;

    <span class="annotation">@Embedded</span>
    <span class="annotation">@IndexedEmbedded</span> <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="directive">private</span> Address placeOfBirth;

    <span class="annotation">@ManyToMany</span>(mappedBy = <span class="string"><span class="delimiter">&quot;</span><span class="content">authors</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">private</span> <span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; books = <span class="keyword">new</span> <span class="predefined-type">ArrayList</span>&lt;&gt;();

    <span class="directive">public</span> Author() {
    }

    <span class="comment">// Getters and setters</span>
    <span class="comment">// ...</span>

}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="annotation">@Embeddable</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">Address</span> {

    <span class="annotation">@FullTextField</span>(analyzer = <span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>) <i class="conum" data-value="4"></i><b>(4)</b>
    <span class="directive">private</span> <span class="predefined-type">String</span> country;

    <span class="directive">private</span> <span class="predefined-type">String</span> city;

    <span class="directive">private</span> <span class="predefined-type">String</span> street;

    <span class="directive">public</span> Address() {
    }

    <span class="comment">// Getters and setters</span>
    <span class="comment">// ...</span>

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Add an <code>@IndexedEmbedded</code> to the <code>authors</code> property.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Map <code>Author.name</code> to an index field, even though <code>Author</code> is not directly mapped to an index (no <code>@Indexed</code>).</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Add an <code>@IndexedEmbedded</code> to the <code>placeOfBirth</code> property.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Map <code>Address.country</code> to an index field, even though <code>Address</code> is not directly mapped to an index (no <code>@Indexed</code>).</td>
</tr>
</table>
</div>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>By default, <code>@IndexedEmbedded</code> will nest other <code>@IndexedEmbedded</code>
encountered in the indexed-embedded type recursively,
without any sort of limit, which can cause infinite recursion.</p>
</div>
<div class="paragraph">
<p>To address this, see <a href="#mapping-indexedembedded-filtering">  Filtering embedded fields and breaking <code>@IndexedEmbedded</code> cycles</a>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="mapping-indexedembedded-null"><a class="anchor" href="#mapping-indexedembedded-null"></a>10.6.2. <a id="mapper-orm-indexedembedded-null"></a> <a id="_indexing_null_embeddeds"></a> <code>@IndexedEmbedded</code> and <code>null</code> values</h4>
<div class="paragraph">
<p>When properties targeted by an <code>@IndexedEmbedded</code> contain <code>null</code> elements,
these elements are simply not indexed.</p>
</div>
<div class="paragraph">
<p>On contrary to <a href="#mapping-directfieldmapping"> Mapping a property to an index field with <code>@GenericField</code>, <code>@FullTextField</code>, &#8230;&#8203;</a>,
there is no <code>indexNullAs</code> feature to index a specific value for <code>null</code> objects,
but you can take advantage of the <a href="#search-dsl-predicate-exists"><code>exists</code></a> predicate
in search queries to look for documents where a given <code>@IndexedEmbedded</code>
has or doesn&#8217;t have a value:
simply pass the name of the object field to the <code>exists</code> predicate,
for example <code>authors</code> in the example above.</p>
</div>
</div>
<div class="sect3">
<h4 id="mapping-indexedembedded-multivalued"><a class="anchor" href="#mapping-indexedembedded-multivalued"></a>10.6.3. <a id="mapper-orm-indexedembedded-multivalued"></a> <code>@IndexedEmbedded</code> on container types</h4>
<div class="paragraph">
<p>When properties targeted by an <code>@IndexedEmbedded</code> have a container type
(<code>List</code>, <code>Optional</code>, <code>Map</code>, &#8230;&#8203;),
the innermost elements will be embedded.
For example for a property of type <code>List&lt;MyEntity&gt;</code>, elements of type <code>MyEntity</code> will be embedded.</p>
</div>
<div class="paragraph">
<p>This default behavior and ways to override it are described
in the section <a href="#mapping-containerextractor"> Mapping container types with container extractors</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="mapping-indexedembedded-name"><a class="anchor" href="#mapping-indexedembedded-name"></a>10.6.4. <a id="mapper-orm-indexedembedded-name"></a> Setting the object field name with <code>name</code></h4>
<div class="paragraph">
<p>By default, <code>@IndexedEmbedded</code> will create an object field with the same name as the annotated property,
and will add embedded fields to that object field.
So if <code>@IndexedEmbedded</code> is applied to a property named <code>authors</code> in a <code>Book</code> entity,
the index field <code>name</code> of the authors will be copied to the index field <code>authors.name</code> when <code>Book</code> is indexed.</p>
</div>
<div class="paragraph">
<p>It is possible to change the name of the object field by setting the <code>name</code> attribute;
for example using <code>@IndexedEmbedded(name = "allAuthors")</code> in the example above will result
in the name of authors being copied to the index field <code>allAuthors.name</code>
instead of <code>authors.name</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The name must not contain the dot character (<code>.</code>).</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="mapping-indexedembedded-prefix"><a class="anchor" href="#mapping-indexedembedded-prefix"></a>10.6.5. <a id="mapper-orm-indexedembedded-prefix"></a> Setting the field name prefix with <code>prefix</code></h4>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The <code>prefix</code> attribute in <code>@IndexedEmbedded</code> is deprecated and will ultimately be removed.
Use <a href="#mapping-indexedembedded-name"><code>name</code></a> instead.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>By default, <code>@IndexedEmbedded</code> will prepend the name of embedded fields
with the name of the property it is applied to followed by a dot.
So if <code>@IndexedEmbedded</code> is applied to a property named <code>authors</code> in a <code>Book</code> entity,
the <code>name</code> field of the authors will be copied to the <code>authors.name</code> field when <code>Book</code> is indexed.</p>
</div>
<div class="paragraph">
<p>It is possible to change this prefix by setting the <code>prefix</code> attribute,
for example <code>@IndexedEmbedded(prefix = "author.")</code> (do not forget the trailing dot!).</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The prefix should generally be a sequence of non-dots ending with a single dot, for example <code>my_Property.</code>.</p>
</div>
<div class="paragraph">
<p>Changing the prefix to a string that does not include any dot at the end (<code>my_Property</code>),
or that includes a dot anywhere but at the very end (<code>my.Property.</code>),
will lead to complex, undocumented, legacy behavior.
Do this at your own risk.</p>
</div>
<div class="paragraph">
<p>In particular, a prefix that does not end with a dot will lead to incorrect behavior
in <a href="#binding-index-field-dsl">some APIs exposed to custom bridges</a>:
the <code>addValue</code>/<code>addObject</code> methods that accept a field name.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="mapping-indexedembedded-targetType"><a class="anchor" href="#mapping-indexedembedded-targetType"></a>10.6.6. <a id="mapper-orm-indexedembedded-targetType"></a> Casting the target of <code>@IndexedEmbedded</code> with <code>targetType</code></h4>
<div class="paragraph">
<p>By default, the type of indexed-embedded values is detected automatically using reflection,
taking into account <a href="#mapping-containerextractor">container extraction</a> if relevant;
for example <code>@IndexedEmbedded List&lt;MyEntity&gt;</code> will be detected as having values of type <code>MyEntity</code>.
Fields to be embedded will be inferred from the mapping of the value type and its supertypes;
in the example, <code>@GenericField</code> annotations present on <code>MyEntity</code> and its superclasses will be taken into account,
but annotations defined in its subclasses will be ignored.</p>
</div>
<div class="paragraph">
<p>If for some reason a schema does not expose the correct type for a property
(e.g. a raw <code>List</code>, or <code>List&lt;MyEntityInterface&gt;</code> instead of <code>List&lt;MyEntityImpl&gt;</code>)
it is possible to define the expected type of values
by setting the <code>targetType</code> attribute in <code>@IndexedEmbedded</code>.
On bootstrap, Hibernate Search will then resolve fields to be embedded based on the given target type,
and at runtime it will cast values to the given target type.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Failures to cast indexed-embedded values to the designated type will be propagated
and lead to indexing failure.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="mapping-indexedembedded-reindexing"><a class="anchor" href="#mapping-indexedembedded-reindexing"></a>10.6.7. <a id="mapper-orm-indexedembedded-reindexing"></a> <a id="_associated_objects_building_a_dependency_graph_with_containedin"></a> Reindexing when embedded elements change</h4>
<div class="paragraph">
<p>When the "embedded" entity changes,
Hibernate Search will handle reindexing of the "embedding" entity.</p>
</div>
<div class="paragraph">
<p>This will work transparently most of the time,
as long as the association <code>@IndexedEmbedded</code> is applied to is bidirectional
(uses Hibernate ORM&#8217;s <code>mappedBy</code>).</p>
</div>
<div class="paragraph">
<p>When Hibernate Search is unable to handle an association,
it will throw an exception on bootstrap.
If this happens, refer to <a href="#mapping-reindexing-basics"> Basics</a> to know more.</p>
</div>
</div>
<div class="sect3">
<h4 id="mapping-indexedembedded-includeEmbeddedObjectId"><a class="anchor" href="#mapping-indexedembedded-includeEmbeddedObjectId"></a>10.6.8. Embedding the entity identifier</h4>
<div class="paragraph">
<p>Mapping a property as an <a href="#mapping-identifiermapping">identifier</a> in the indexed-embedded type
will not automatically result into it being embedded when using <code>@IndexedEmbedded</code> on that type,
because document identifiers are not fields.</p>
</div>
<div class="paragraph">
<p>To embed the data of such a property, you can use <code>@IndexedEmbedded(includeEmbeddedObjectId = true)</code>,
which will have Hibernate Search automatically insert a field in the resulting embedded object
for the indexed-embedded type&#8217;s <a href="#mapping-identifiermapping-basics">identifier property</a>.</p>
</div>
<div class="paragraph">
<p>The index field will be defined as if the following <a href="#mapping-directfieldmapping">field annotation</a>
was put on the identifier property of the embedded type:
<code>@GenericField(searchable = Searchable.YES, projectable = Projectable.YES)</code>.
The name of the index field will be the name of the identifier property.
Its bridge will be the identifier bridge referenced by the embedded type&#8217;s
<a href="#mapping-identifiermapping-explicit"><code>@DocumentId</code> annotation</a>, if any,
or the default value bridge for the identifier property type&#8217;s, by default.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you need more advanced mapping (custom name, custom bridge, sortable, &#8230;&#8203;),
do not use <code>includeEmbeddedObjectId</code>.</p>
</div>
<div class="paragraph">
<p>Instead, define the field explicitly in the indexed-embedded type
by annotating the identifier property with <a href="#mapping-directfieldmapping"><code>@GenericField</code> or a similar field annotation</a>,
and make sure the field is included by <code>@IndexedEmbedded</code>
by <a href="#mapper-orm-indexedembedded-filtering">configuring filters as necessary</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Below is an example of using <code>includeEmbeddedObjectId</code>:</p>
</div>
<div class="exampleblock">
<div class="title">Example 39. Including indexed-embedded IDs with <code>includeEmbeddedObjectId</code></div>
<div class="content">
<div class="paragraph">
<p>This mapping will declare the following fields in the <code>Employee</code> index:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>name</code></p>
</li>
<li>
<p><code>department.name</code>: implicitly included by <code>@IndexedEmbedded</code>.</p>
</li>
<li>
<p><code>department.id</code>: explicitly inserted by `includeEmbeddedObjectId = true.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="annotation">@Entity</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">Department</span> {

    <span class="annotation">@Id</span>
    <span class="directive">private</span> <span class="predefined-type">Integer</span> id; <i class="conum" data-value="1"></i><b>(1)</b>

    <span class="annotation">@FullTextField</span>
    <span class="directive">private</span> <span class="predefined-type">String</span> name;

    <span class="annotation">@OneToMany</span>(mappedBy = <span class="string"><span class="delimiter">&quot;</span><span class="content">department</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">private</span> <span class="predefined-type">List</span>&lt;Employee&gt; employees = <span class="keyword">new</span> <span class="predefined-type">ArrayList</span>&lt;&gt;();

    <span class="comment">// Getters and setters</span>
    <span class="comment">// ...</span>

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>Department</code> identifier is not mapped to an index field (not <a href="#mapping-directfieldmapping"><code>@*Field</code> annotation</a>).</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="annotation">@Entity</span>
<span class="annotation">@Indexed</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">Employee</span> {

    <span class="annotation">@Id</span>
    <span class="directive">private</span> <span class="predefined-type">Integer</span> id;

    <span class="annotation">@FullTextField</span>
    <span class="directive">private</span> <span class="predefined-type">String</span> name;

    <span class="annotation">@ManyToOne</span>
    <span class="annotation">@IndexedEmbedded</span>(includeEmbeddedObjectId = <span class="predefined-constant">true</span>) <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="directive">private</span> Department department;

    <span class="comment">// Getters and setters</span>
    <span class="comment">// ...</span>

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>@IndexedEmbedded</code> will insert a <code>department.id</code> field into the <code>Employee</code> index for the <code>Department</code> identifier,
even though in <code>Department</code> the identifier property is not mapped to an index field.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="mapping-indexedembedded-filtering"><a class="anchor" href="#mapping-indexedembedded-filtering"></a>10.6.9. <a id="mapper-orm-indexedembedded-filtering"></a> <a id="search-mapping-associated-viapaths"></a> Filtering embedded fields and breaking <code>@IndexedEmbedded</code> cycles</h4>
<div class="paragraph">
<p>By default, <code>@IndexedEmbedded</code> will "embed" everything:
every field encountered in the indexed-embedded element,
and every <code>@IndexedEmbedded</code> encountered in the indexed-embedded element,
recursively.</p>
</div>
<div class="paragraph">
<p>This will work just fine for simpler use cases, but may lead to problems for more complex models:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If the indexed-embedded element declares many index fields (Hibernate Search fields),
only some of which are actually useful to the "index-embedding" type,
the extra fields will decrease indexing performance needlessly.</p>
</li>
<li>
<p>If there is a cycle of <code>@IndexedEmbedded</code>
(e.g. <code>A</code> index-embeds <code>b</code> of type <code>B</code>, which index-embeds <code>a</code> of type <code>A</code>)
the index-embedding type will end up with an infinite amount of fields
(<code>a.b.someField</code>, <code>a.b.a.b.someField</code>, <code>a.b.a.b.a.b.someField</code>, &#8230;&#8203;),
which Hibernate Search will detect and reject with an exception.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To address these problems, it is possible to filter the fields to embed,
to only include those that are actually useful.
Available filtering attributes on <code>@IndexedEmbedded</code> are:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>includePaths</code></dt>
<dd>
<p>The paths of index fields from the indexed-embedded element that should be embedded.</p>
<div class="paragraph">
<p>Provided paths must be relative to the indexed-embedded element,
i.e. they must not include its <a href="#mapping-indexedembedded-name">name</a>
or <a href="#mapping-indexedembedded-prefix">prefix</a>.</p>
</div>
<div class="paragraph">
<p>This takes precedence over <code>includeDepth</code> (see below).</p>
</div>
<div class="paragraph">
<p>Cannot be used in combination with <code>excludePaths</code> in the same <code>@IndexedEmbedded</code>.</p>
</div>
</dd>
<dt class="hdlist1"><code>excludePaths</code></dt>
<dd>
<p>The paths of index fields from the indexed-embedded element that must <strong>not</strong> be embedded.</p>
<div class="paragraph">
<p>Provided paths must be relative to the indexed-embedded element,
i.e. they must not include its <a href="#mapping-indexedembedded-name">name</a>
or <a href="#mapping-indexedembedded-prefix">prefix</a>.</p>
</div>
<div class="paragraph">
<p>This takes precedence over <code>includeDepth</code> (see below).</p>
</div>
<div class="paragraph">
<p>Cannot be used in combination with <code>includePaths</code> in the same <code>@IndexedEmbedded</code>.</p>
</div>
</dd>
<dt class="hdlist1"><code>includeDepth</code></dt>
<dd>
<p>The number of levels of indexed-embedded that will have all their fields included by default.</p>
<div class="paragraph">
<p><code>includeDepth</code> is the number of <code>@IndexedEmbedded</code> that will be traversed
and for which all fields of the indexed-embedded element will be included,
even if these fields are not included explicitly through <code>includePaths</code>,
unless these fields are excluded explicitly through <code>excludePaths</code>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>includeDepth=0</code> means that fields of this indexed-embedded element are <strong>not</strong> included,
nor is any field of nested indexed-embedded elements,
unless these fields are included explicitly through <code>includePaths</code>.</p>
</li>
<li>
<p><code>includeDepth=1</code> means that fields of this indexed-embedded element <strong>are</strong> included,
unless these fields are excluded explicitly through <code>excludePaths</code>,
but <strong>not</strong> fields of nested indexed-embedded elements (<code>@IndexedEmbedded</code> within this <code>@IndexedEmbedded</code>),
unless these fields are included explicitly through <code>includePaths</code>.</p>
</li>
<li>
<p><code>includeDepth=2</code> means that fields of this indexed-embedded element
and fields of the immediately nested indexed-embedded (<code>@IndexedEmbedded</code> within this <code>@IndexedEmbedded</code>) elements <strong>are</strong> included,
unless these fields are explicitly excluded through <code>excludePaths</code>,
but <strong>not</strong> fields of nested indexed-embedded elements beyond that
(<code>@IndexedEmbedded</code> within an <code>@IndexedEmbedded</code> within this <code>@IndexedEmbedded</code>),
unless these fields are included explicitly through <code>includePaths</code>.</p>
</li>
<li>
<p>And so on.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The default value depends on the value of the <code>includePaths</code> attribute:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>if <code>includePaths</code> is empty, the default is <code>Integer.MAX_VALUE</code> (include all fields at every level)</p>
</li>
<li>
<p>if <code>includePaths</code> is <strong>not</strong> empty, the default is <code>0</code>
(only include fields included explicitly).</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Dynamic fields and filtering</div>
<div class="paragraph">
<p><a href="#binding-index-field-dsl-dynamic">Dynamic fields</a> are not directly affected by filtering rules:
a dynamic field will be included if and only if its parent is included.</p>
</div>
<div class="paragraph">
<p>This means in particular that <code>includeDepth</code> and <code>includePaths</code>
constraints only need to match the nearest static parent of a dynamic field
in order for that field to be included.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Mixing <code>includePaths</code> and <code>excludePaths</code> at different nesting levels</div>
<div class="paragraph">
<p>In general, it is possible to use <code>includePaths</code> and <code>excludePaths</code> at different levels of nested <code>@IndexedEmbedded</code>.
When doing so, keep in mind that the filter at each level can only reference reachable paths,
i.e. a filter cannot reference a path that was excluded by a nested <code>@IndexedEmbedded</code> (implicitly or explicitly).</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Below are three examples: one leveraging <code>includePaths</code> only,
one leveraging <code>excludePaths</code>, and one leveraging <code>includePaths</code> and <code>includeDepth</code>.</p>
</div>
<div id="indexedembedded-includePath" class="exampleblock">
<div class="title">Example 40. Filtering indexed-embedded fields with <code>includePaths</code></div>
<div class="content">
<div class="paragraph">
<p>This mapping will declare the following fields in the <code>Human</code> index:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>name</code></p>
</li>
<li>
<p><code>nickname</code></p>
</li>
<li>
<p><code>parents.name</code>: explicitly included because <code>includePaths</code> on <code>parents</code> includes <code>name</code>.</p>
</li>
<li>
<p><code>parents.nickname</code>: explicitly included because <code>includePaths</code> on <code>parents</code> includes <code>nickname</code>.</p>
</li>
<li>
<p><code>parents.parents.name</code>: explicitly included because <code>includePaths</code> on <code>parents</code> includes <code>parents.name</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The following fields in particular are excluded:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>parents.parents.nickname</code>: <strong>not</strong> implicitly included because <code>includeDepth</code> is not set and defaults to <code>0</code>,
and <strong>not</strong> explicitly included either because <code>includePaths</code> on <code>parents</code> does not include <code>parents.nickname</code>.</p>
</li>
<li>
<p><code>parents.parents.parents.name</code>: <strong>not</strong> implicitly included because <code>includeDepth</code> is not set and defaults to <code>0</code>,
and <strong>not</strong> explicitly included either because <code>includePaths</code> on <code>parents</code> does not include <code>parents.parents.name</code>.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="annotation">@Entity</span>
<span class="annotation">@Indexed</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">Human</span> {

    <span class="annotation">@Id</span>
    <span class="directive">private</span> <span class="predefined-type">Integer</span> id;

    <span class="annotation">@FullTextField</span>(analyzer = <span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">private</span> <span class="predefined-type">String</span> name;

    <span class="annotation">@FullTextField</span>(analyzer = <span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">private</span> <span class="predefined-type">String</span> nickname;

    <span class="annotation">@ManyToMany</span>
    <span class="annotation">@IndexedEmbedded</span>(includePaths = { <span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">nickname</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">parents.name</span><span class="delimiter">&quot;</span></span> })
    <span class="directive">private</span> <span class="predefined-type">List</span>&lt;Human&gt; parents = <span class="keyword">new</span> <span class="predefined-type">ArrayList</span>&lt;&gt;();

    <span class="annotation">@ManyToMany</span>(mappedBy = <span class="string"><span class="delimiter">&quot;</span><span class="content">parents</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">private</span> <span class="predefined-type">List</span>&lt;Human&gt; children = <span class="keyword">new</span> <span class="predefined-type">ArrayList</span>&lt;&gt;();

    <span class="directive">public</span> Human() {
    }

    <span class="comment">// Getters and setters</span>
    <span class="comment">// ...</span>

}</code></pre>
</div>
</div>
</div>
</div>
<div id="indexedembedded-excludePath" class="exampleblock">
<div class="title">Example 41. Filtering indexed-embedded fields with <code>excludePaths</code></div>
<div class="content">
<div class="paragraph">
<p>This mapping will result in the same schema as in the <a href="#indexedembedded-includePath">Filtering indexed-embedded fields with <code>includePaths</code></a> example, but through using the <code>excludePaths</code> instead.
Following fields in the <code>Human</code> index will be declared:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>name</code></p>
</li>
<li>
<p><code>nickname</code></p>
</li>
<li>
<p><code>parents.name</code>: implicitly included because <code>includeDepth</code> on <code>parents</code> defaults to <code>Integer.MAX_VALUE</code>.</p>
</li>
<li>
<p><code>parents.nickname</code>: implicitly included because <code>includeDepth</code> on <code>parents</code> defaults to <code>Integer.MAX_VALUE</code>.</p>
</li>
<li>
<p><code>parents.parents.name</code>: implicitly included because <code>includeDepth</code> on <code>parents</code> defaults to <code>Integer.MAX_VALUE</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The following fields in particular are excluded:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>parents.parents.nickname</code>: <strong>not</strong> included because <code>excludePaths</code> explicitly excludes <code>parents.nickname</code>.</p>
</li>
<li>
<p><code>parents.parents.parents</code>/<code>parents.parents.parents.&lt;any-field&gt;</code>: <strong>not</strong> included because <code>excludePaths</code> explicitly excludes <code>parents.parents</code> stopping any further traversing.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="annotation">@Entity</span>
<span class="annotation">@Indexed</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">Human</span> {

    <span class="annotation">@Id</span>
    <span class="directive">private</span> <span class="predefined-type">Integer</span> id;

    <span class="annotation">@FullTextField</span>(analyzer = <span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">private</span> <span class="predefined-type">String</span> name;

    <span class="annotation">@FullTextField</span>(analyzer = <span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">private</span> <span class="predefined-type">String</span> nickname;

    <span class="annotation">@ManyToMany</span>
    <span class="annotation">@IndexedEmbedded</span>(excludePaths = { <span class="string"><span class="delimiter">&quot;</span><span class="content">parents.nickname</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">parents.parents</span><span class="delimiter">&quot;</span></span> })
    <span class="directive">private</span> <span class="predefined-type">List</span>&lt;Human&gt; parents = <span class="keyword">new</span> <span class="predefined-type">ArrayList</span>&lt;&gt;();

    <span class="annotation">@ManyToMany</span>(mappedBy = <span class="string"><span class="delimiter">&quot;</span><span class="content">parents</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">private</span> <span class="predefined-type">List</span>&lt;Human&gt; children = <span class="keyword">new</span> <span class="predefined-type">ArrayList</span>&lt;&gt;();

    <span class="directive">public</span> Human() {
    }

    <span class="comment">// Getters and setters</span>
    <span class="comment">// ...</span>

}</code></pre>
</div>
</div>
</div>
</div>
<div id="indexedembedded-includePathsAndDepth" class="exampleblock">
<div class="title">Example 42. Filtering indexed-embedded fields with <code>includePaths</code> and <code>includeDepth</code></div>
<div class="content">
<div class="paragraph">
<p>This mapping will declare the following fields in the <code>Human</code> index:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>name</code></p>
</li>
<li>
<p><code>surname</code></p>
</li>
<li>
<p><code>parents.name</code>: implicitly at depth <code>0</code> because <code>includeDepth &gt; 0</code>
(so <code>parents.*</code> is included implicitly).</p>
</li>
<li>
<p><code>parents.nickname</code>: implicitly included at depth <code>0</code> because <code>includeDepth &gt; 0</code>
(so <code>parents.*</code> is included implicitly).</p>
</li>
<li>
<p><code>parents.parents.name</code>: implicitly included at depth <code>1</code> because <code>includeDepth &gt; 1</code>
(so <code>parents.parents.*</code> is included implicitly).</p>
</li>
<li>
<p><code>parents.parents.nickname</code>: implicitly included at depth <code>1</code> because <code>includeDepth &gt; 1</code>
(so <code>parents.parents.*</code> is included implicitly).</p>
</li>
<li>
<p><code>parents.parents.parents.name</code>: <strong>not</strong> implicitly included at depth <code>2</code> because <code>includeDepth = 2</code>
(so <code>parents.parents.parents</code> is included implicitly,
but subfields can only be included explicitly)
but explicitly included because <code>includePaths</code> on <code>parents</code> includes <code>parents.parents.name</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The following fields in particular are excluded:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>parents.parents.parents.nickname</code>: <strong>not</strong> implicitly included at depth <code>2</code> because <code>includeDepth = 2</code>
(so <code>parents.parents.parents</code> is included implicitly, but subfields must be included explicitly)
and <strong>not</strong> explicitly included either because <code>includePaths</code> on <code>parents</code> does not include <code>parents.parents.nickname</code>.</p>
</li>
<li>
<p><code>parents.parents.parents.parents.name</code>: <strong>not</strong> implicitly included at depth <code>3</code> because <code>includeDepth = 2</code>
(so <code>parents.parents.parents</code> is included implicitly,
but <code>parents.parents.parents.parents</code> and subfields can only be included explicitly)
and <strong>not</strong> explicitly included either because <code>includePaths</code> on <code>parents</code> does not include <code>parents.parents.parents.name</code>.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="annotation">@Entity</span>
<span class="annotation">@Indexed</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">Human</span> {

    <span class="annotation">@Id</span>
    <span class="directive">private</span> <span class="predefined-type">Integer</span> id;

    <span class="annotation">@FullTextField</span>(analyzer = <span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">private</span> <span class="predefined-type">String</span> name;

    <span class="annotation">@FullTextField</span>(analyzer = <span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">private</span> <span class="predefined-type">String</span> nickname;

    <span class="annotation">@ManyToMany</span>
    <span class="annotation">@IndexedEmbedded</span>(includeDepth = <span class="integer">2</span>, includePaths = { <span class="string"><span class="delimiter">&quot;</span><span class="content">parents.parents.name</span><span class="delimiter">&quot;</span></span> })
    <span class="directive">private</span> <span class="predefined-type">List</span>&lt;Human&gt; parents = <span class="keyword">new</span> <span class="predefined-type">ArrayList</span>&lt;&gt;();

    <span class="annotation">@ManyToMany</span>(mappedBy = <span class="string"><span class="delimiter">&quot;</span><span class="content">parents</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">private</span> <span class="predefined-type">List</span>&lt;Human&gt; children = <span class="keyword">new</span> <span class="predefined-type">ArrayList</span>&lt;&gt;();

    <span class="directive">public</span> Human() {
    }

    <span class="comment">// Getters and setters</span>
    <span class="comment">// ...</span>

}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="mapping-indexedembedded-structure"><a class="anchor" href="#mapping-indexedembedded-structure"></a>10.6.10. <a id="mapper-orm-indexedembedded-structure"></a> <a id="mapper-orm-indexedembedded-storage"></a> Structuring embedded elements as nested documents using <code>structure</code></h4>
<div class="paragraph">
<p>Indexed-embedded fields can be structured in one of two ways,
configured through the <code>structure</code> attribute of the <code>@IndexedEmbedded</code> annotation.
To illustrate structure options, let&#8217;s assume the class <code>Book</code> is annotated with <code>@Indexed</code>
and its <code>authors</code> property is annotated with  <code>@IndexedEmbedded</code>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Book instance</p>
<div class="ulist">
<ul>
<li>
<p>title = Leviathan Wakes</p>
</li>
<li>
<p>authors =</p>
<div class="ulist">
<ul>
<li>
<p>Author instance</p>
<div class="ulist">
<ul>
<li>
<p>firstName = Daniel</p>
</li>
<li>
<p>lastName = Abraham</p>
</li>
</ul>
</div>
</li>
<li>
<p>Author instance</p>
<div class="ulist">
<ul>
<li>
<p>firstName = Ty</p>
</li>
<li>
<p>lastName = Frank</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="mapping-indexedembedded-structure-flattened"><a class="anchor" href="#mapping-indexedembedded-structure-flattened"></a><a id="mapper-orm-indexedembedded-structure-flattened"></a> <a id="mapper-orm-indexedembedded-storage-flattened"></a> <code>DEFAULT</code> or <code>FLATTENED</code> structure</h5>
<div class="paragraph">
<p>By default, or when using <code>@IndexedEmbedded(structure = FLATTENED)</code> as shown below,
indexed-embedded fields are "flattened",
meaning that the tree structure is not preserved.</p>
</div>
<div class="exampleblock">
<div class="title">Example 43. <code>@IndexedEmbedded</code> with a flattened structure</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="annotation">@Entity</span>
<span class="annotation">@Indexed</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">Book</span> {

    <span class="annotation">@Id</span>
    <span class="directive">private</span> <span class="predefined-type">Integer</span> id;

    <span class="annotation">@FullTextField</span>(analyzer = <span class="string"><span class="delimiter">&quot;</span><span class="content">english</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">private</span> <span class="predefined-type">String</span> title;

    <span class="annotation">@ManyToMany</span>
    <span class="annotation">@IndexedEmbedded</span>(structure = ObjectStructure.FLATTENED) <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="directive">private</span> <span class="predefined-type">List</span>&lt;Author&gt; authors = <span class="keyword">new</span> <span class="predefined-type">ArrayList</span>&lt;&gt;();

    <span class="directive">public</span> <span class="predefined-type">Book</span>() {
    }

    <span class="comment">// Getters and setters</span>
    <span class="comment">// ...</span>

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Explicitly set the structure of indexed-embedded to <code>FLATTENED</code>.
This is not strictly necessary, since <code>FLATTENED</code> is the default.</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="annotation">@Entity</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">Author</span> {

    <span class="annotation">@Id</span>
    <span class="directive">private</span> <span class="predefined-type">Integer</span> id;

    <span class="annotation">@FullTextField</span>(analyzer = <span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">private</span> <span class="predefined-type">String</span> firstName;

    <span class="annotation">@FullTextField</span>(analyzer = <span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">private</span> <span class="predefined-type">String</span> lastName;

    <span class="annotation">@ManyToMany</span>(mappedBy = <span class="string"><span class="delimiter">&quot;</span><span class="content">authors</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">private</span> <span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; books = <span class="keyword">new</span> <span class="predefined-type">ArrayList</span>&lt;&gt;();

    <span class="directive">public</span> Author() {
    }

    <span class="comment">// Getters and setters</span>
    <span class="comment">// ...</span>

}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The book instance mentioned earlier would be indexed with a structure roughly similar to this:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Book document</p>
<div class="ulist">
<ul>
<li>
<p>title = Leviathan Wakes</p>
</li>
<li>
<p>authors.firstName = [Daniel, Ty]</p>
</li>
<li>
<p>authors.lastName = [Abraham, Frank]</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>The <code>authors.firstName</code> and <code>authors.lastName</code> fields were "flattened"
and now each has two values;
the knowledge of which last name corresponds to which first name has been lost.</p>
</div>
<div class="paragraph">
<p>This is more efficient for indexing and querying,
but can cause unexpected behavior when querying the index
on both the author&#8217;s first name and the author&#8217;s last name.</p>
</div>
<div class="paragraph">
<p>For example, the book instance described above
<strong>would</strong> show up as a match to a query such as <code>authors.firstname:Ty AND authors.lastname:Abraham</code>,
even though "Ty Abraham" is not one of this book&#8217;s authors:</p>
</div>
<div class="exampleblock">
<div class="title">Example 44. Searching with a flattened structure</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .where( f -&gt; f.and(
                f.match().field( <span class="string"><span class="delimiter">&quot;</span><span class="content">authors.firstName</span><span class="delimiter">&quot;</span></span> ).matching( <span class="string"><span class="delimiter">&quot;</span><span class="content">Ty</span><span class="delimiter">&quot;</span></span> ), <i class="conum" data-value="1"></i><b>(1)</b>
                f.match().field( <span class="string"><span class="delimiter">&quot;</span><span class="content">authors.lastName</span><span class="delimiter">&quot;</span></span> ).matching( <span class="string"><span class="delimiter">&quot;</span><span class="content">Abraham</span><span class="delimiter">&quot;</span></span> ) <i class="conum" data-value="1"></i><b>(1)</b>
        ) )
        .fetchHits( <span class="integer">20</span> );

assertThat( hits ).isNotEmpty(); <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Require that hits have an author with the first name <code>Ty</code> and an author with the last name <code>Abraham</code>&#8230;&#8203;
but not necessarily the same author!</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The hits will include a book whose authors are "Ty Daniel" and "Frank Abraham".</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="mapping-indexedembedded-structure-nested"><a class="anchor" href="#mapping-indexedembedded-structure-nested"></a><a id="mapper-orm-indexedembedded-structure-nested"></a> <a id="mapper-orm-indexedembedded-storage-nested"></a> <code>NESTED</code> structure</h5>
<div class="paragraph">
<p>When indexed-embedded elements are "nested", i.e. when using <code>@IndexedEmbedded(structure = NESTED)</code> as shown below,
the tree structure is preserved by transparently creating one separate "nested" document
for each indexed-embedded element.</p>
</div>
<div class="exampleblock">
<div class="title">Example 45. <code>@IndexedEmbedded</code> with a nested structure</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="annotation">@Entity</span>
<span class="annotation">@Indexed</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">Book</span> {

    <span class="annotation">@Id</span>
    <span class="directive">private</span> <span class="predefined-type">Integer</span> id;

    <span class="annotation">@FullTextField</span>(analyzer = <span class="string"><span class="delimiter">&quot;</span><span class="content">english</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">private</span> <span class="predefined-type">String</span> title;

    <span class="annotation">@ManyToMany</span>
    <span class="annotation">@IndexedEmbedded</span>(structure = ObjectStructure.NESTED) <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="directive">private</span> <span class="predefined-type">List</span>&lt;Author&gt; authors = <span class="keyword">new</span> <span class="predefined-type">ArrayList</span>&lt;&gt;();

    <span class="directive">public</span> <span class="predefined-type">Book</span>() {
    }

    <span class="comment">// Getters and setters</span>
    <span class="comment">// ...</span>

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Explicitly set the structure of indexed-embedded objects to <code>NESTED</code>.</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="annotation">@Entity</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">Author</span> {

    <span class="annotation">@Id</span>
    <span class="directive">private</span> <span class="predefined-type">Integer</span> id;

    <span class="annotation">@FullTextField</span>(analyzer = <span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">private</span> <span class="predefined-type">String</span> firstName;

    <span class="annotation">@FullTextField</span>(analyzer = <span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">private</span> <span class="predefined-type">String</span> lastName;

    <span class="annotation">@ManyToMany</span>(mappedBy = <span class="string"><span class="delimiter">&quot;</span><span class="content">authors</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">private</span> <span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; books = <span class="keyword">new</span> <span class="predefined-type">ArrayList</span>&lt;&gt;();

    <span class="directive">public</span> Author() {
    }

    <span class="comment">// Getters and setters</span>
    <span class="comment">// ...</span>

}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The book instance mentioned earlier would be indexed with a structure roughly similar to this:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Book document</p>
<div class="ulist">
<ul>
<li>
<p>title = Leviathan Wakes</p>
</li>
<li>
<p>Nested documents</p>
<div class="ulist">
<ul>
<li>
<p>Nested document #1 for "authors"</p>
<div class="ulist">
<ul>
<li>
<p>authors.firstName = Daniel</p>
</li>
<li>
<p>authors.lastName = Abraham</p>
</li>
</ul>
</div>
</li>
<li>
<p>Nested document #2 for "authors"</p>
<div class="ulist">
<ul>
<li>
<p>authors.firstName = Ty</p>
</li>
<li>
<p>authors.lastName = Frank</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>The book is effectively indexed as three documents:
the root document for the book, and two internal, "nested" documents for the authors,
preserving the knowledge of which last name corresponds to which first name
at the cost of degraded performance when indexing and querying.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The nested documents are "hidden" and won&#8217;t directly show up in search results.
No need to worry about nested documents being "mixed up" with root documents.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If special care is taken when building predicates on fields within nested documents,
using a <a href="#search-dsl-predicate-nested"><code>nested</code> predicate</a>,
queries containing predicates on both the author&#8217;s first name and the author&#8217;s last name
will behave as one would (intuitively) expect.</p>
</div>
<div class="paragraph">
<p>For example, the book instance described above
would <strong>not</strong> show up as a match to a query such as <code>authors.firstname:Ty AND authors.lastname:Abraham</code>,
thanks to the <code>nested</code> predicate (which can only be used when indexing with the <code>NESTED</code> structure):</p>
</div>
<div class="exampleblock">
<div class="title">Example 46. Searching with a nested structure</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .where( f -&gt; f.nested( <span class="string"><span class="delimiter">&quot;</span><span class="content">authors</span><span class="delimiter">&quot;</span></span> ) <i class="conum" data-value="1"></i><b>(1)</b>
                .add( f.match().field( <span class="string"><span class="delimiter">&quot;</span><span class="content">authors.firstName</span><span class="delimiter">&quot;</span></span> ).matching( <span class="string"><span class="delimiter">&quot;</span><span class="content">Ty</span><span class="delimiter">&quot;</span></span> ) ) <i class="conum" data-value="2"></i><b>(2)</b>
                .add( f.match().field( <span class="string"><span class="delimiter">&quot;</span><span class="content">authors.lastName</span><span class="delimiter">&quot;</span></span> ).matching( <span class="string"><span class="delimiter">&quot;</span><span class="content">Abraham</span><span class="delimiter">&quot;</span></span> ) ) ) <i class="conum" data-value="2"></i><b>(2)</b>
        .fetchHits( <span class="integer">20</span> );

assertThat( hits ).isEmpty(); <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Require that the two constraints (first name and last name) apply to the <strong>same</strong> author.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Require that hits have an author with the first name <code>Ty</code> and an author with the last name <code>Abraham</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The hits will <strong>not</strong> include a book whose authors are "Ty Daniel" and "Frank Abraham".</td>
</tr>
</table>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
With the <a href="#backend-lucene">Lucene backend</a>, the nested structure is also necessary if
you want to perform <a href="#search-dsl-projection-object"><code>object</code> projections</a>.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="mapping-indexedembedded-filtering-association"><a class="anchor" href="#mapping-indexedembedded-filtering-association"></a>10.6.11. Filtering association elements</h4>
<div class="paragraph">
<p>Sometimes, only some elements of an association should be included in an <code>@IndexedEmbedded</code>.</p>
</div>
<div class="paragraph">
<p>For example a <code>Book</code> entity might index-embed <code>BookEdition</code> instances,
but some editions might be retired and thus need to be filtered out before indexing.</p>
</div>
<div class="paragraph">
<p>Such filtering can be achieved by applying <code>@IndexedEmbedded</code> to a transient getter representing the filtered association,
and configuring reindexing with <a href="#mapping-reindexing-associationinverseside"><code>@AssociationInverseSide</code></a>
and <a href="#mapping-reindexing-derivedfrom"><code>@IndexingDependency.derivedFrom</code></a>.</p>
</div>
<div class="exampleblock">
<div class="title">Example 47. Filtered an <code>@IndexedEmbedded</code> association with a transient getter, <code>@AssociationInverseSide</code> and <code>@IndexingDependency.derivedFrom</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="annotation">@Entity</span>
<span class="annotation">@Indexed</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">Book</span> {

    <span class="annotation">@Id</span>
    <span class="directive">private</span> <span class="predefined-type">Integer</span> id;

    <span class="annotation">@FullTextField</span>(analyzer = <span class="string"><span class="delimiter">&quot;</span><span class="content">english</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">private</span> <span class="predefined-type">String</span> title;

    <span class="annotation">@OneToMany</span>(mappedBy = <span class="string"><span class="delimiter">&quot;</span><span class="content">book</span><span class="delimiter">&quot;</span></span>)
    <span class="annotation">@OrderBy</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">id asc</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">private</span> <span class="predefined-type">List</span>&lt;BookEdition&gt; editions = <span class="keyword">new</span> <span class="predefined-type">ArrayList</span>&lt;&gt;(); <i class="conum" data-value="1"></i><b>(1)</b>

    <span class="directive">public</span> <span class="predefined-type">Book</span>() {
    }

    <span class="comment">// Getters and setters</span>
    <span class="comment">// ...</span>


    <span class="annotation">@Transient</span> <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="annotation">@IndexedEmbedded</span> <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="annotation">@AssociationInverseSide</span>(inversePath = <span class="annotation">@ObjectPath</span>({ <i class="conum" data-value="4"></i><b>(4)</b>
            <span class="annotation">@PropertyValue</span>(propertyName = <span class="string"><span class="delimiter">&quot;</span><span class="content">book</span><span class="delimiter">&quot;</span></span>)
    }))
    <span class="annotation">@IndexingDependency</span>(derivedFrom = <span class="annotation">@ObjectPath</span>({ <i class="conum" data-value="5"></i><b>(5)</b>
            <span class="annotation">@PropertyValue</span>(propertyName = <span class="string"><span class="delimiter">&quot;</span><span class="content">editions</span><span class="delimiter">&quot;</span></span>),
            <span class="annotation">@PropertyValue</span>(propertyName = <span class="string"><span class="delimiter">&quot;</span><span class="content">status</span><span class="delimiter">&quot;</span></span>)
    }))
    <span class="directive">public</span> <span class="predefined-type">List</span>&lt;BookEdition&gt; getEditionsNotRetired() {
        <span class="keyword">return</span> editions.stream()
                .filter( e -&gt; e.getStatus() != BookEdition.Status.RETIRED )
                .collect( Collectors.toList() );
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="annotation">@Entity</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">BookEdition</span> {

    <span class="directive">public</span> <span class="type">enum</span> Status {
        PUBLISHING,
        RETIRED
    }

    <span class="annotation">@Id</span>
    <span class="directive">private</span> <span class="predefined-type">Integer</span> id;

    <span class="annotation">@ManyToOne</span>
    <span class="directive">private</span> <span class="predefined-type">Book</span> book;

    <span class="annotation">@FullTextField</span>(analyzer = <span class="string"><span class="delimiter">&quot;</span><span class="content">english</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">private</span> <span class="predefined-type">String</span> label;

    <span class="directive">private</span> Status status; <i class="conum" data-value="6"></i><b>(6)</b>

    <span class="directive">public</span> BookEdition() {
    }

    <span class="comment">// Getters and setters</span>
    <span class="comment">// ...</span>

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The association between <code>Book</code> and <code>BookEdition</code> is mapped in Hibernate ORM, but not Hibernate Search.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The transient <code>editionsNotRetired</code> property dynamically returns the editions that are not retired.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td><code>@IndexedEmbedded</code> is applied to <code>editionsNotRetired</code> instead of <code>editions</code>.
If we wanted to, we could use <a href="#mapping-indexedembedded-name">`@IndexedEmbedded(name = "editions")</a>
to make this transparent when searching.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Hibernate ORM does not know about <code>editionsNotRetired</code>, so Hibernate Search cannot infer the inverse side of this "filtered" association.
Thus, we use <code>@AssociationInverseSide</code> to tell Hibernate Search that.
Should the label of a <code>BookEdition</code> be modified, Hibernate Search
will use this information to retrieve the corresponding <code>Book</code> to reindex.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>We use <code>@IndexingDependency.derivedFrom</code> to tell Hibernate Search
that whenever the status of an edition changes,
the result of <code>getEditionsNotRetired()</code> may have changed as well,
requiring reindexing.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>While <code>BookEdition#status</code> is not annotated, Hibernate Search will still
track its changes because of the <code>@IndexingDependency</code> annotation in <code>Book</code>.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="mapping-indexedembedded-programmatic"><a class="anchor" href="#mapping-indexedembedded-programmatic"></a>10.6.12. <a id="mapper-orm-indexedembedded-programmatic"></a> Programmatic mapping</h4>
<div class="paragraph">
<p>You can embed the fields of an associated object into the main object
through the <a href="#mapping-programmatic">programmatic mapping</a> too.
Behavior and options are identical to annotation-based mapping.</p>
</div>
<div class="exampleblock">
<div class="title">Example 48. Using <code>.indexedEmbedded()</code> to index associated elements</div>
<div class="content">
<div class="paragraph">
<p>This mapping will declare the following fields in the <code>Book</code> index:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>title</code></p>
</li>
<li>
<p><code>authors.name</code></p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">TypeMappingStep bookMapping = mapping.type( <span class="predefined-type">Book</span>.class );
bookMapping.indexed();
bookMapping.property( <span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span> )
        .fullTextField().analyzer( <span class="string"><span class="delimiter">&quot;</span><span class="content">english</span><span class="delimiter">&quot;</span></span> );
bookMapping.property( <span class="string"><span class="delimiter">&quot;</span><span class="content">authors</span><span class="delimiter">&quot;</span></span> )
        .indexedEmbedded();
TypeMappingStep authorMapping = mapping.type( Author.class );
authorMapping.property( <span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span> )
        .fullTextField().analyzer( <span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span> );</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="mapping-containerextractor"><a class="anchor" href="#mapping-containerextractor"></a>10.7. <a id="mapper-orm-containerextractor"></a> Mapping container types with container extractors</h3>
<div class="sect3">
<h4 id="mapping-containerextractor-basics"><a class="anchor" href="#mapping-containerextractor-basics"></a>10.7.1. <a id="mapper-orm-containerextractor-basics"></a> Basics</h4>
<div class="paragraph">
<p>Most built-in annotations applied to properties will work transparently when applied to container types:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>@GenericField</code> applied to a property of type <code>String</code> will index the property value directly.</p>
</li>
<li>
<p><code>@GenericField</code> applied to a property of type <code>OptionalInt</code> will index the optional&#8217;s value (an integer).</p>
</li>
<li>
<p><code>@GenericField</code> applied to a property of type <code>List&lt;String&gt;</code> will index the list elements (strings).</p>
</li>
<li>
<p><code>@GenericField</code> applied to a property of type <code>Map&lt;Integer, String&gt;</code> will index the map values (strings).</p>
</li>
<li>
<p><code>@GenericField</code> applied to a property of type <code>Map&lt;Integer, List&lt;String&gt;&gt;</code> will index the list elements in the map values (strings).</p>
</li>
<li>
<p>Etc.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Same goes for other field annotations such as <code>@FullTextField</code>,
as well as <code>@IndexedEmbedded</code> in particular.
With <code>@VectorField</code> being an exception to this behaviour,
requiring <a href="#mapping-containerextractor-explicit">explicit instructions</a> to extract values from a container.</p>
</div>
<div class="paragraph">
<p>What happens behind the scenes is that Hibernate Search will inspect the property type
and attempt to apply "container extractors", picking the first that works.</p>
</div>
</div>
<div class="sect3">
<h4 id="mapping-containerextractor-explicit"><a class="anchor" href="#mapping-containerextractor-explicit"></a>10.7.2. <a id="mapper-orm-containerextractor-explicit"></a> <a id="_explicit_container_extraction"></a> Explicit container extraction</h4>
<div class="paragraph">
<p>In some cases, you will want to pick the container extractors to use explicitly.
This is the case when a map&#8217;s keys must be indexed, instead of the values.
Relevant annotations offer an <code>extraction</code> attribute to configure this,
as shown in the example below.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
All built-in extractor names are available as constants
in <code>org.hibernate.search.mapper.pojo.extractor.builtin.BuiltinContainerExtractors</code>.
</td>
</tr>
</table>
</div>
<div class="exampleblock">
<div class="title">Example 49. Mapping <code>Map</code> keys to an index field using explicit container extractor definition</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="annotation">@ElementCollection</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="annotation">@JoinTable</span>(name = <span class="string"><span class="delimiter">&quot;</span><span class="content">book_pricebyformat</span><span class="delimiter">&quot;</span></span>)
<span class="annotation">@MapKeyColumn</span>(name = <span class="string"><span class="delimiter">&quot;</span><span class="content">format</span><span class="delimiter">&quot;</span></span>)
<span class="annotation">@Column</span>(name = <span class="string"><span class="delimiter">&quot;</span><span class="content">price</span><span class="delimiter">&quot;</span></span>)
<span class="annotation">@OrderBy</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">format asc</span><span class="delimiter">&quot;</span></span>)
<span class="annotation">@GenericField</span>( <i class="conum" data-value="2"></i><b>(2)</b>
        name = <span class="string"><span class="delimiter">&quot;</span><span class="content">availableFormats</span><span class="delimiter">&quot;</span></span>,
        extraction = <span class="annotation">@ContainerExtraction</span>(BuiltinContainerExtractors.MAP_KEY) <i class="conum" data-value="3"></i><b>(3)</b>
)
<span class="directive">private</span> <span class="predefined-type">Map</span>&lt;BookFormat, <span class="predefined-type">BigDecimal</span>&gt; priceByFormat = <span class="keyword">new</span> <span class="predefined-type">LinkedHashMap</span>&lt;&gt;();</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This annotation&#8201;&#8212;&#8201;and those below&#8201;&#8212;&#8201;are just Hibernate ORM configuration.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Declare an index field based on the <code>priceByFormat</code> property.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>By default, Hibernate Search would index the map values (the book prices).
This uses the <code>extraction</code> attribute to specify that map keys (the book formats)
must be indexed instead.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
When multiple levels of extractions are necessary,
multiple extractors can be configured:
<code>extraction = @ContainerExtraction(BuiltinContainerExtractors.MAP_KEY, BuiltinContainerExtractors.OPTIONAL)</code>.
However, such complex mappings are unlikely since they are generally not supported by Hibernate ORM.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>It is possible to implement and use custom container extractors,
but at the moment Hibernate Search will not detect that the changes to the data inside such container
must trigger the reindexing of a containing element.
Hence, the corresponding property must <a href="#mapping-reindexing-reindexonupdate">disable reindexing on change</a>.</p>
</div>
<div class="paragraph">
<p>See <a href="https://hibernate.atlassian.net/browse/HSEARCH-3688">HSEARCH-3688</a> for more information.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="mapping-containerextractor-disabling"><a class="anchor" href="#mapping-containerextractor-disabling"></a>10.7.3. <a id="mapper-orm-containerextractor-disabling"></a> <a id="_disabling_container_extraction"></a> Disabling container extraction</h4>
<div class="paragraph">
<p>In some rare cases, container extraction is not wanted,
and the <code>@GenericField</code>/<code>@IndexedEmbedded</code> is meant to be applied to the <code>List</code>/<code>Optional</code>/etc. directly.
To ignore the default container extractors,
most annotations offer an <code>extraction</code> attribute.
Set it as below to disable extraction altogether:</p>
</div>
<div class="exampleblock">
<div class="title">Example 50. Disabling container extraction</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="annotation">@ManyToMany</span>
<span class="annotation">@GenericField</span>( <i class="conum" data-value="1"></i><b>(1)</b>
        name = <span class="string"><span class="delimiter">&quot;</span><span class="content">authorCount</span><span class="delimiter">&quot;</span></span>,
        valueBridge = <span class="annotation">@ValueBridgeRef</span>(type = MyCollectionSizeBridge.class), <i class="conum" data-value="2"></i><b>(2)</b>
        extraction = <span class="annotation">@ContainerExtraction</span>(extract = ContainerExtract.NO) <i class="conum" data-value="3"></i><b>(3)</b>
)
<span class="directive">private</span> <span class="predefined-type">List</span>&lt;Author&gt; authors = <span class="keyword">new</span> <span class="predefined-type">ArrayList</span>&lt;&gt;();</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Declare an index field based on the <code>authors</code> property.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Instruct Hibernate Search to use the given bridge,
which will extract the collection size (the number of authors).</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Because the bridge is applied to the collection as a whole,
and not to each author,
the <code>extraction</code> attribute is used to disable container extraction.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="mapping-containerextractor-programmatic"><a class="anchor" href="#mapping-containerextractor-programmatic"></a>10.7.4. <a id="mapper-orm-containerextractor-programmatic"></a> Programmatic mapping</h4>
<div class="paragraph">
<p>You can pick the container extractors to use explicitly
when defining <a href="#mapping-directfieldmapping-programmatic">fields</a>
or <a href="#mapping-indexedembedded-programmatic">indexed-embeddeds</a>
through the <a href="#mapping-programmatic">programmatic mapping</a> too.
Behavior and options are identical to annotation-based mapping.</p>
</div>
<div class="exampleblock">
<div class="title">Example 51. Mapping <code>Map</code> keys to an index field using <code>.extractor(&#8230;&#8203;)</code>/<code>.extactors(&#8230;&#8203;)</code> for explicit container extractor definition</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">bookMapping.property( <span class="string"><span class="delimiter">&quot;</span><span class="content">priceByFormat</span><span class="delimiter">&quot;</span></span> )
        .genericField( <span class="string"><span class="delimiter">&quot;</span><span class="content">availableFormats</span><span class="delimiter">&quot;</span></span> )
                .extractor( BuiltinContainerExtractors.MAP_KEY );</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Similarly, you can disable container extraction.</p>
</div>
<div class="exampleblock">
<div class="title">Example 52. Disabling container extraction with <code>.noExtractors()</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">bookMapping.property( <span class="string"><span class="delimiter">&quot;</span><span class="content">authors</span><span class="delimiter">&quot;</span></span> )
        .genericField( <span class="string"><span class="delimiter">&quot;</span><span class="content">authorCount</span><span class="delimiter">&quot;</span></span> )
                .valueBridge( <span class="keyword">new</span> MyCollectionSizeBridge() )
                .noExtractors();</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="mapping-geopoint"><a class="anchor" href="#mapping-geopoint"></a>10.8. <a id="mapper-orm-geopoint"></a> <a id="spatial"></a> Mapping geo-point types</h3>
<div class="sect3">
<h4 id="mapping-geopoint-basics"><a class="anchor" href="#mapping-geopoint-basics"></a>10.8.1. <a id="mapper-orm-geopoint-basics"></a> Basics</h4>
<div class="paragraph">
<p>Hibernate Search provides a variety of spatial features
such as <a href="#search-dsl-predicate-spatial-within">a distance predicate</a>
and <a href="#search-dsl-sort-distance">a distance sort</a>.
These features require that spatial coordinates are indexed.
More precisely, it requires that a <strong>geo-point</strong>,
i.e. a latitude and longitude in the geographic coordinate system, are indexed.</p>
</div>
<div class="paragraph">
<p>Geo-points are a bit of an exception,
because there isn&#8217;t any type in the standard Java library to represent them.
For that reason, Hibernate Search defines its own interface,
<code>org.hibernate.search.engine.spatial.GeoPoint</code>.
Since your model probably uses a different type to represent geo-points,
mapping geo-points requires some extra steps.</p>
</div>
<div class="paragraph">
<p>Two options are available:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If your geo-points are represented by a dedicated, immutable type,
simply use <code>@GenericField</code> and the <code>GeoPoint</code> interface,
as explained <a href="#mapping-geopoint-genericfield">here</a>.</p>
</li>
<li>
<p>For every other case, use the more complex (but more powerful) <code>@GeoPointBinding</code>,
as explained <a href="#mapping-geopoint-geopointbinding">here</a>.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="mapping-geopoint-genericfield"><a class="anchor" href="#mapping-geopoint-genericfield"></a>10.8.2. <a id="mapper-orm-geopoint-genericfield"></a> <a id="spatial-coordinatesinterface"></a> Using <code>@GenericField</code> and the <code>GeoPoint</code> interface</h4>
<div class="paragraph">
<p>When geo-points are represented in your entity model by a dedicated, <strong>immutable</strong> type,
you can simply make that type implement the <code>GeoPoint</code> interface,
and use simple <a href="#mapping-directfieldmapping">property/field mapping</a> with <code>@GenericField</code>:</p>
</div>
<div class="exampleblock">
<div class="title">Example 53. Mapping spatial coordinates by implementing <code>GeoPoint</code> and using <code>@GenericField</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="annotation">@Embeddable</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">MyCoordinates</span> <span class="directive">implements</span> GeoPoint { <i class="conum" data-value="1"></i><b>(1)</b>

    <span class="annotation">@Basic</span>
    <span class="directive">private</span> <span class="predefined-type">Double</span> latitude;

    <span class="annotation">@Basic</span>
    <span class="directive">private</span> <span class="predefined-type">Double</span> longitude;

    <span class="directive">protected</span> MyCoordinates() {
        <span class="comment">// For Hibernate ORM</span>
    }

    <span class="directive">public</span> MyCoordinates(<span class="type">double</span> latitude, <span class="type">double</span> longitude) {
        <span class="local-variable">this</span>.latitude = latitude;
        <span class="local-variable">this</span>.longitude = longitude;
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">double</span> latitude() { <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="keyword">return</span> latitude;
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">double</span> longitude() {
        <span class="keyword">return</span> longitude;
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="annotation">@Entity</span>
<span class="annotation">@Indexed</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">Author</span> {

    <span class="annotation">@Id</span>
    <span class="annotation">@GeneratedValue</span>
    <span class="directive">private</span> <span class="predefined-type">Integer</span> id;

    <span class="directive">private</span> <span class="predefined-type">String</span> name;

    <span class="annotation">@Embedded</span>
    <span class="annotation">@GenericField</span> <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="directive">private</span> MyCoordinates placeOfBirth;

    <span class="directive">public</span> Author() {
    }

    <span class="comment">// Getters and setters</span>
    <span class="comment">// ...</span>

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Model the geo-point as an embeddable implementing <code>GeoPoint</code>.
A custom type with a corresponding Hibernate ORM <code>UserType</code> would work as well.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The geo-point type <strong>must be immutable</strong>: it does not declare any setter.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Apply the <code>@GenericField</code> annotation to the <code>placeOfBirth</code> property holding the coordinates.
An index field named <code>placeOfBirth</code> will be added to the index.
Options generally used on <code>@GenericField</code> can be used here as well.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The geo-point type <strong>must be immutable</strong>,
i.e. the latitude and longitude of a given instance may never change.</p>
</div>
<div class="paragraph">
<p>This is a core assumption of <code>@GenericField</code> and generally all <code>@*Field</code> annotations:
changes to the coordinates will be ignored and will not trigger reindexing as one would expect.</p>
</div>
<div class="paragraph">
<p>If the type holding your coordinates is mutable,
do not use <code>@GenericField</code>
and refer to <a href="#mapping-geopoint-geopointbinding">   Using <code>@GeoPointBinding</code>, <code>@Latitude</code> and <code>@Longitude</code></a> instead.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If your geo-point type is immutable, but extending the <code>GeoPoint</code> interface is not an option,
you can also use a custom <a href="#binding-valuebridge">value bridge</a>
converting between the custom geo-point type and <code>GeoPoint</code>.
<code>GeoPoint</code> offers static methods to quickly build a <code>GeoPoint</code> instance.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="mapping-geopoint-geopointbinding"><a class="anchor" href="#mapping-geopoint-geopointbinding"></a>10.8.3. <a id="mapper-orm-geopoint-geopointbinding"></a> <a id="spatial-indexing-range"></a> <a id="spatial-indexing-spatialHash"></a> Using <code>@GeoPointBinding</code>, <code>@Latitude</code> and <code>@Longitude</code></h4>
<div class="paragraph">
<p>For cases where coordinates are stored in a mutable object,
the solution is the <code>@GeoPointBinding</code> annotation.
Combined with the <code>@Latitude</code> and <code>@Longitude</code> annotation,
it can map the coordinates of any type that declares a latitude and longitude of type <code>double</code>:</p>
</div>
<div class="exampleblock">
<div class="title">Example 54. Mapping spatial coordinates using <code>@GeoPointBinding</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="annotation">@Entity</span>
<span class="annotation">@Indexed</span>
<span class="annotation">@GeoPointBinding</span>(fieldName = <span class="string"><span class="delimiter">&quot;</span><span class="content">placeOfBirth</span><span class="delimiter">&quot;</span></span>) <i class="conum" data-value="1"></i><b>(1)</b>
<span class="directive">public</span> <span class="type">class</span> <span class="class">Author</span> {

    <span class="annotation">@Id</span>
    <span class="annotation">@GeneratedValue</span>
    <span class="directive">private</span> <span class="predefined-type">Integer</span> id;

    <span class="directive">private</span> <span class="predefined-type">String</span> name;

    <span class="annotation">@Latitude</span> <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="directive">private</span> <span class="predefined-type">Double</span> placeOfBirthLatitude;

    <span class="annotation">@Longitude</span> <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="directive">private</span> <span class="predefined-type">Double</span> placeOfBirthLongitude;

    <span class="directive">public</span> Author() {
    }

    <span class="comment">// Getters and setters</span>
    <span class="comment">// ...</span>

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Apply the <code>@GeoPointBinding</code> annotation to the type,
setting <code>fieldName</code> to the name of the index field.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Apply <code>@Latitude</code> to the property holding the latitude. It must be of <code>double</code> or <code>Double</code> type.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Apply <code>@Longitude</code> to the property holding the longitude. It must be of <code>double</code> or <code>Double</code> type.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>The <code>@GeoPointBinding</code> annotation may also be applied to a property,
in which case the <code>@Latitude</code> and <code>@Longitude</code> must be applied to properties of the property&#8217;s type:</p>
</div>
<div class="exampleblock">
<div class="title">Example 55. Mapping spatial coordinates using <code>@GeoPointBinding</code> on a property</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="annotation">@Embeddable</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">MyCoordinates</span> { <i class="conum" data-value="1"></i><b>(1)</b>

    <span class="annotation">@Basic</span>
    <span class="annotation">@Latitude</span> <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="directive">private</span> <span class="predefined-type">Double</span> latitude;

    <span class="annotation">@Basic</span>
    <span class="annotation">@Longitude</span> <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="directive">private</span> <span class="predefined-type">Double</span> longitude;

    <span class="directive">protected</span> MyCoordinates() {
        <span class="comment">// For Hibernate ORM</span>
    }

    <span class="directive">public</span> MyCoordinates(<span class="type">double</span> latitude, <span class="type">double</span> longitude) {
        <span class="local-variable">this</span>.latitude = latitude;
        <span class="local-variable">this</span>.longitude = longitude;
    }

    <span class="directive">public</span> <span class="type">double</span> getLatitude() {
        <span class="keyword">return</span> latitude;
    }

    <span class="directive">public</span> <span class="type">void</span> setLatitude(<span class="predefined-type">Double</span> latitude) { <i class="conum" data-value="4"></i><b>(4)</b>
        <span class="local-variable">this</span>.latitude = latitude;
    }

    <span class="directive">public</span> <span class="type">double</span> getLongitude() {
        <span class="keyword">return</span> longitude;
    }

    <span class="directive">public</span> <span class="type">void</span> setLongitude(<span class="predefined-type">Double</span> longitude) {
        <span class="local-variable">this</span>.longitude = longitude;
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="annotation">@Entity</span>
<span class="annotation">@Indexed</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">Author</span> {

    <span class="annotation">@Id</span>
    <span class="annotation">@GeneratedValue</span>
    <span class="directive">private</span> <span class="predefined-type">Integer</span> id;

    <span class="annotation">@FullTextField</span>(analyzer = <span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">private</span> <span class="predefined-type">String</span> name;

    <span class="annotation">@Embedded</span>
    <span class="annotation">@GeoPointBinding</span> <i class="conum" data-value="5"></i><b>(5)</b>
    <span class="directive">private</span> MyCoordinates placeOfBirth;

    <span class="directive">public</span> Author() {
    }

    <span class="comment">// Getters and setters</span>
    <span class="comment">// ...</span>

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Model the geo-point as embeddable.
An entity would work as well.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>In the geo-point type, apply <code>@Latitude</code> to the property holding the latitude.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>In the geo-point type, apply <code>@Longitude</code> to the property holding the longitude.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The geo-point type may safely declare setters (it can be mutable).</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Apply the <code>@GeoPointBinding</code> annotation to the property.
Setting <code>fieldName</code> to the name of the index field is possible, but optional:
the property name will be used by default.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>It is possible to handle multiple sets of coordinates by applying the annotations multiple times
and setting the <code>markerSet</code> attribute to a unique value:</p>
</div>
<div id="spatial-multiplecoordinates" class="exampleblock">
<div class="title">Example 56. Mapping multiple sets of spatial coordinates using <code>@GeoPointBinding</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="annotation">@Entity</span>
<span class="annotation">@Indexed</span>
<span class="annotation">@GeoPointBinding</span>(fieldName = <span class="string"><span class="delimiter">&quot;</span><span class="content">placeOfBirth</span><span class="delimiter">&quot;</span></span>, markerSet = <span class="string"><span class="delimiter">&quot;</span><span class="content">birth</span><span class="delimiter">&quot;</span></span>) <i class="conum" data-value="1"></i><b>(1)</b>
<span class="annotation">@GeoPointBinding</span>(fieldName = <span class="string"><span class="delimiter">&quot;</span><span class="content">placeOfDeath</span><span class="delimiter">&quot;</span></span>, markerSet = <span class="string"><span class="delimiter">&quot;</span><span class="content">death</span><span class="delimiter">&quot;</span></span>) <i class="conum" data-value="2"></i><b>(2)</b>
<span class="directive">public</span> <span class="type">class</span> <span class="class">Author</span> {

    <span class="annotation">@Id</span>
    <span class="annotation">@GeneratedValue</span>
    <span class="directive">private</span> <span class="predefined-type">Integer</span> id;

    <span class="annotation">@FullTextField</span>(analyzer = <span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">private</span> <span class="predefined-type">String</span> name;

    <span class="annotation">@Latitude</span>(markerSet = <span class="string"><span class="delimiter">&quot;</span><span class="content">birth</span><span class="delimiter">&quot;</span></span>) <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="directive">private</span> <span class="predefined-type">Double</span> placeOfBirthLatitude;

    <span class="annotation">@Longitude</span>(markerSet = <span class="string"><span class="delimiter">&quot;</span><span class="content">birth</span><span class="delimiter">&quot;</span></span>) <i class="conum" data-value="4"></i><b>(4)</b>
    <span class="directive">private</span> <span class="predefined-type">Double</span> placeOfBirthLongitude;

    <span class="annotation">@Latitude</span>(markerSet = <span class="string"><span class="delimiter">&quot;</span><span class="content">death</span><span class="delimiter">&quot;</span></span>) <i class="conum" data-value="5"></i><b>(5)</b>
    <span class="directive">private</span> <span class="predefined-type">Double</span> placeOfDeathLatitude;

    <span class="annotation">@Longitude</span>(markerSet = <span class="string"><span class="delimiter">&quot;</span><span class="content">death</span><span class="delimiter">&quot;</span></span>) <i class="conum" data-value="6"></i><b>(6)</b>
    <span class="directive">private</span> <span class="predefined-type">Double</span> placeOfDeathLongitude;

    <span class="directive">public</span> Author() {
    }

    <span class="comment">// Getters and setters</span>
    <span class="comment">// ...</span>

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Apply the <code>@GeoPointBinding</code> annotation to the type,
setting <code>fieldName</code> to the name of the index field, and <code>markerSet</code> to a unique value.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Apply the <code>@GeoPointBinding</code> annotation to the type a second time,
setting <code>fieldName</code> to the name of the index field (different from the first one),
and <code>markerSet</code> to a unique value (different from the first one).</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Apply <code>@Latitude</code> to the property holding the latitude for the first geo-point field.
Set the <code>markerSet</code> attribute to the same value as the corresponding <code>@GeoPointBinding</code> annotation.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Apply <code>@Longitude</code> to the property holding the longitude for the first geo-point field.
Set the <code>markerSet</code> attribute to the same value as the corresponding <code>@GeoPointBinding</code> annotation.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Apply <code>@Latitude</code> to the property holding the latitude for the second geo-point field.
Set the <code>markerSet</code> attribute to the same value as the corresponding <code>@GeoPointBinding</code> annotation.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Apply <code>@Longitude</code> to the property holding the longitude for the second geo-point field.
Set the <code>markerSet</code> attribute to the same value as the corresponding <code>@GeoPointBinding</code> annotation.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="mapping-geopoint-programmatic"><a class="anchor" href="#mapping-geopoint-programmatic"></a>10.8.4. <a id="mapper-orm-geopoint-programmatic"></a> Programmatic mapping</h4>
<div class="paragraph">
<p>You can map geo-point fields document identifier through the <a href="#mapping-programmatic">programmatic mapping</a> too.
Behavior and options are identical to annotation-based mapping.</p>
</div>
<div class="exampleblock">
<div class="title">Example 57. Mapping spatial coordinates by implementing <code>GeoPoint</code> and using <code>.genericField()</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">TypeMappingStep authorMapping = mapping.type( Author.class );
authorMapping.indexed();
authorMapping.property( <span class="string"><span class="delimiter">&quot;</span><span class="content">placeOfBirth</span><span class="delimiter">&quot;</span></span> )
        .genericField();</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 58. Mapping spatial coordinates using <code>GeoPointBinder</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">TypeMappingStep authorMapping = mapping.type( Author.class );
authorMapping.indexed();
authorMapping.binder( GeoPointBinder.create().fieldName( <span class="string"><span class="delimiter">&quot;</span><span class="content">placeOfBirth</span><span class="delimiter">&quot;</span></span> ) );
authorMapping.property( <span class="string"><span class="delimiter">&quot;</span><span class="content">placeOfBirthLatitude</span><span class="delimiter">&quot;</span></span> )
        .marker( GeoPointBinder.latitude() );
authorMapping.property( <span class="string"><span class="delimiter">&quot;</span><span class="content">placeOfBirthLongitude</span><span class="delimiter">&quot;</span></span> )
        .marker( GeoPointBinder.longitude() );</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="mapping-alternatives"><a class="anchor" href="#mapping-alternatives"></a>10.9. <a id="mapper-orm-alternatives"></a> <a id="_dynamic_analyzer_selection"></a> Mapping multiple alternatives</h3>
<div class="sect3">
<h4 id="mapping-alternatives-basics"><a class="anchor" href="#mapping-alternatives-basics"></a>10.9.1. <a id="mapper-orm-alternatives-basics"></a> Basics</h4>
<div class="paragraph">
<p>In some situations, it is necessary for a particular property to be indexed differently
depending on the value of another property.</p>
</div>
<div class="paragraph">
<p>For example there may be an entity that has text properties whose content
is in a different language depending on the value of another property, say <code>language</code>.
In that case, you probably want to analyze the text differently depending on the language.</p>
</div>
<div class="paragraph">
<p>While this could definitely be solved with a custom <a href="#binding-typebridge">type bridge</a>,
a convenient solution to that problem is to use the <code>AlternativeBinder</code>.
This binder solves the problem this way:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>at bootstrap, declare one index field per language, assigning a different analyzer to each field;</p>
</li>
<li>
<p>at runtime, put the content of the text property in a different field based on the language.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In order to use this binder, you will need to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>annotate a property with <code>@AlternativeDiscriminator</code> (e.g. the <code>language</code> property);</p>
</li>
<li>
<p>implement an <code>AlternativeBinderDelegate</code> that will declare the index fields
(e.g. one field per language) and create an <code>AlternativeValueBridge</code>.
This bridge is responsible for passing the property value to the relevant field at runtime.</p>
</li>
<li>
<p>apply the <code>AlternativeBinder</code> to the type hosting the properties
(e.g. the type declaring the <code>language</code> property and the multi-language text properties).
Generally you will want to create your own annotation for that.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Below is an example of how to use the binder.</p>
</div>
<div id="example-analyzer-discriminator" class="exampleblock">
<div class="title">Example 59. Mapping a property to a different index field based on a <code>language</code> property using <code>AlternativeBinder</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="directive">public</span> <span class="type">enum</span> Language { <i class="conum" data-value="1"></i><b>(1)</b>

    ENGLISH( <span class="string"><span class="delimiter">&quot;</span><span class="content">en</span><span class="delimiter">&quot;</span></span> ),
    FRENCH( <span class="string"><span class="delimiter">&quot;</span><span class="content">fr</span><span class="delimiter">&quot;</span></span> ),
    GERMAN( <span class="string"><span class="delimiter">&quot;</span><span class="content">de</span><span class="delimiter">&quot;</span></span> );

    <span class="directive">public</span> <span class="directive">final</span> <span class="predefined-type">String</span> code;

    Language(<span class="predefined-type">String</span> code) {
        <span class="local-variable">this</span>.code = code;
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>A <code>Language</code> enum defines supported languages.</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="annotation">@Entity</span>
<span class="annotation">@Indexed</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">BlogEntry</span> {

    <span class="annotation">@Id</span>
    <span class="directive">private</span> <span class="predefined-type">Integer</span> id;

    <span class="annotation">@AlternativeDiscriminator</span> <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="annotation">@Enumerated</span>(EnumType.STRING)
    <span class="directive">private</span> Language language;

    <span class="annotation">@MultiLanguageField</span> <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="directive">private</span> <span class="predefined-type">String</span> text;

    <span class="comment">// Getters and setters</span>
    <span class="comment">// ...</span>

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Mark the <code>language</code> property as the discriminator which will be used to determine the language.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Map the <code>text</code> property to multiple fields using a custom annotation.</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="annotation">@Retention</span>(<span class="predefined-type">RetentionPolicy</span>.RUNTIME) <i class="conum" data-value="1"></i><b>(1)</b>
<span class="annotation">@Target</span>({ <span class="predefined-type">ElementType</span>.METHOD, <span class="predefined-type">ElementType</span>.FIELD }) <i class="conum" data-value="2"></i><b>(2)</b>
<span class="annotation">@PropertyMapping</span>(processor = <span class="annotation">@PropertyMappingAnnotationProcessorRef</span>( <i class="conum" data-value="3"></i><b>(3)</b>
        type = MultiLanguageField.Processor.class
))
<span class="annotation">@Documented</span> <i class="conum" data-value="4"></i><b>(4)</b>
<span class="directive">public</span> <span class="annotation">@interface</span> MultiLanguageField {

    <span class="predefined-type">String</span> name() <span class="keyword">default</span> <span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>; <i class="conum" data-value="5"></i><b>(5)</b>

    <span class="type">class</span> <span class="class">Processor</span> <i class="conum" data-value="6"></i><b>(6)</b>
            <span class="directive">implements</span> PropertyMappingAnnotationProcessor&lt;MultiLanguageField&gt; { <i class="conum" data-value="7"></i><b>(7)</b>
        <span class="annotation">@Override</span>
        <span class="directive">public</span> <span class="type">void</span> process(PropertyMappingStep mapping, MultiLanguageField annotation,
                PropertyMappingAnnotationProcessorContext context) {
            LanguageAlternativeBinderDelegate delegate = <span class="keyword">new</span> LanguageAlternativeBinderDelegate( <i class="conum" data-value="8"></i><b>(8)</b>
                    annotation.name().isEmpty() ? <span class="predefined-constant">null</span> : annotation.name()
            );
            mapping.hostingType() <i class="conum" data-value="9"></i><b>(9)</b>
                    .binder( AlternativeBinder.create( <i class="conum" data-value="10"></i><b>(10)</b>
                            Language.class, <i class="conum" data-value="11"></i><b>(11)</b>
                            context.annotatedElement().name(), <i class="conum" data-value="12"></i><b>(12)</b>
                            <span class="predefined-type">String</span>.class, <i class="conum" data-value="13"></i><b>(13)</b>
                            BeanReference.ofInstance( delegate ) <i class="conum" data-value="14"></i><b>(14)</b>
                    ) );
        }
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Define an annotation with <code>RUNTIME</code> retention.
<strong>Any other retention policy will cause the annotation to be ignored by Hibernate Search</strong>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Allow the annotation to target either methods (getters) or fields.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Mark this annotation as a property mapping,
and instruct Hibernate Search to apply the given processor whenever it finds this annotation.
It is also possible to reference the processor by its CDI/Spring bean name.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Optionally, mark the annotation as documented,
so that it is included in the javadoc of your entities.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Optionally, define parameters. Here we allow to customize the field name
(which will default to the property name, see further down).</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Here the processor class is nested in the annotation class,
because it is more convenient,
but you are obviously free to implement it in a separate Java file.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>The processor must implement the <code>PropertyMappingAnnotationProcessor</code> interface,
setting its generic type argument to the type of the corresponding annotation.</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>In the annotation processor, instantiate a custom binder delegate
(see below for the implementation).</td>
</tr>
<tr>
<td><i class="conum" data-value="9"></i><b>9</b></td>
<td>Access the mapping of the type hosting the property (in this example, <code>BlogEntry</code>).</td>
</tr>
<tr>
<td><i class="conum" data-value="10"></i><b>10</b></td>
<td>Apply the <code>AlternativeBinder</code> to the type hosting the property (in this example, <code>BlogEntry</code>).</td>
</tr>
<tr>
<td><i class="conum" data-value="11"></i><b>11</b></td>
<td>Pass to <code>AlternativeBinder</code> the expected type of discriminator values.</td>
</tr>
<tr>
<td><i class="conum" data-value="12"></i><b>12</b></td>
<td>Pass to <code>AlternativeBinder</code> the name of the property from which field values should be extracted
(in this example, <code>text</code>).</td>
</tr>
<tr>
<td><i class="conum" data-value="13"></i><b>13</b></td>
<td>Pass to <code>AlternativeBinder</code> the expected type of the property from which index field values are extracted.</td>
</tr>
<tr>
<td><i class="conum" data-value="14"></i><b>14</b></td>
<td>Pass to <code>AlternativeBinder</code> the binder delegate.</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="directive">public</span> <span class="type">class</span> <span class="class">LanguageAlternativeBinderDelegate</span> <span class="directive">implements</span> AlternativeBinderDelegate&lt;Language, <span class="predefined-type">String</span>&gt; { <i class="conum" data-value="1"></i><b>(1)</b>

    <span class="directive">private</span> <span class="directive">final</span> <span class="predefined-type">String</span> name;

    <span class="directive">public</span> LanguageAlternativeBinderDelegate(<span class="predefined-type">String</span> name) { <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="local-variable">this</span>.name = name;
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> AlternativeValueBridge&lt;Language, <span class="predefined-type">String</span>&gt; bind(IndexSchemaElement indexSchemaElement, <i class="conum" data-value="3"></i><b>(3)</b>
            PojoModelProperty fieldValueSource) {
        <span class="predefined-type">EnumMap</span>&lt;Language, IndexFieldReference&lt;<span class="predefined-type">String</span>&gt;&gt; fields = <span class="keyword">new</span> <span class="predefined-type">EnumMap</span>&lt;&gt;( Language.class );
        <span class="predefined-type">String</span> fieldNamePrefix = ( name != <span class="predefined-constant">null</span> ? name : fieldValueSource.name() ) + <span class="string"><span class="delimiter">&quot;</span><span class="content">_</span><span class="delimiter">&quot;</span></span>;

        <span class="keyword">for</span> ( Language language : Language.values() ) { <i class="conum" data-value="4"></i><b>(4)</b>
            <span class="predefined-type">String</span> languageCode = language.code;
            IndexFieldReference&lt;<span class="predefined-type">String</span>&gt; field = indexSchemaElement.field(
                    fieldNamePrefix + languageCode, <i class="conum" data-value="5"></i><b>(5)</b>
                    f -&gt; f.asString().analyzer( <span class="string"><span class="delimiter">&quot;</span><span class="content">text_</span><span class="delimiter">&quot;</span></span> + languageCode ) <i class="conum" data-value="6"></i><b>(6)</b>
            )
                    .toReference();
            fields.put( language, field );
        }

        <span class="keyword">return</span> <span class="keyword">new</span> Bridge( fields ); <i class="conum" data-value="7"></i><b>(7)</b>
    }

    <span class="directive">private</span> <span class="directive">static</span> <span class="type">class</span> <span class="class">Bridge</span> <i class="conum" data-value="8"></i><b>(8)</b>
            <span class="directive">implements</span> AlternativeValueBridge&lt;Language, <span class="predefined-type">String</span>&gt; { <i class="conum" data-value="9"></i><b>(9)</b>
        <span class="directive">private</span> <span class="directive">final</span> <span class="predefined-type">EnumMap</span>&lt;Language, IndexFieldReference&lt;<span class="predefined-type">String</span>&gt;&gt; fields;

        <span class="directive">private</span> Bridge(<span class="predefined-type">EnumMap</span>&lt;Language, IndexFieldReference&lt;<span class="predefined-type">String</span>&gt;&gt; fields) {
            <span class="local-variable">this</span>.fields = fields;
        }

        <span class="annotation">@Override</span>
        <span class="directive">public</span> <span class="type">void</span> write(DocumentElement target, Language discriminator, <span class="predefined-type">String</span> bridgedElement) {
            target.addValue( fields.get( discriminator ), bridgedElement ); <i class="conum" data-value="10"></i><b>(10)</b>
        }
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The binder delegate must implement <code>AlternativeBinderDelegate</code>.
The first type parameter is the expected type of discriminator values (in this example, <code>Language</code>);
the second type parameter is the expected type of the property from which field values are extracted
(in this example, <code>String</code>).</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Any (custom) parameter can be passed through the constructor.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Implement <code>bind</code>, to bind a property to index fields.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Define one field per language.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Make sure to give a different name to each field.
Here we&#8217;re using the language code as a suffix, i.e. <code>text_en</code>, <code>text_fr</code>, <code>text_de</code>, &#8230;&#8203;</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Assign a different analyzer to each field.
The analyzers <code>text_en</code>, <code>text_fr</code>, <code>text_de</code> must have been defined in the backend;
see <a href="#concepts-analysis"> Analysis</a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Return a bridge.</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>Here the bridge class is nested in the binder class,
because it is more convenient,
but you are obviously free to implement it as you wish:
as a lambda expression, in a separate Java file&#8230;&#8203;</td>
</tr>
<tr>
<td><i class="conum" data-value="9"></i><b>9</b></td>
<td>The bridge must implement the <code>AlternativeValueBridge</code> interface.</td>
</tr>
<tr>
<td><i class="conum" data-value="10"></i><b>10</b></td>
<td>The bridge is called when indexing; it selects the field to write to based on the discriminator value,
then writes the value to index to that field.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="mapping-alternatives-programmatic"><a class="anchor" href="#mapping-alternatives-programmatic"></a>10.9.2. <a id="mapper-orm-alternatives-programmatic"></a> Programmatic mapping</h4>
<div class="paragraph">
<p>You can apply <code>AlternativeBinder</code> through the <a href="#mapping-programmatic">programmatic mapping</a> too.
Behavior and options are identical to annotation-based mapping.</p>
</div>
<div class="exampleblock">
<div class="title">Example 60. Applying an <code>AlternativeBinder</code> with <code>.binder(&#8230;&#8203;)</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">TypeMappingStep blogEntryMapping = mapping.type( BlogEntry.class );
blogEntryMapping.indexed();
blogEntryMapping.property( <span class="string"><span class="delimiter">&quot;</span><span class="content">language</span><span class="delimiter">&quot;</span></span> )
        .marker( AlternativeBinder.alternativeDiscriminator() );
LanguageAlternativeBinderDelegate delegate = <span class="keyword">new</span> LanguageAlternativeBinderDelegate( <span class="predefined-constant">null</span> );
blogEntryMapping.binder( AlternativeBinder.create( Language.class,
        <span class="string"><span class="delimiter">&quot;</span><span class="content">text</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">String</span>.class, BeanReference.ofInstance( delegate ) ) );</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="mapping-reindexing"><a class="anchor" href="#mapping-reindexing"></a>10.10. <a id="mapper-orm-reindexing"></a> Tuning when to trigger reindexing</h3>
<div class="sect3">
<h4 id="mapping-reindexing-basics"><a class="anchor" href="#mapping-reindexing-basics"></a>10.10.1. <a id="mapper-orm-reindexing-basics"></a> Basics</h4>
<div class="paragraph">
<p>When an entity property is mapped to the index,
be it through <code>@GenericField</code>, <code>@IndexedEmbedded</code>,
or a <a href="#binding">custom bridge</a>,
this mapping introduces a dependency:
the document will need to be updated when the property changes.</p>
</div>
<div class="paragraph">
<p>For simpler, single-entity mappings,
this only means that Hibernate Search will need to detect when an entity changes
and reindex the entity.
This will be handled transparently.</p>
</div>
<div class="paragraph">
<p>If the mapping includes a "derived" property,
i.e. a property that is not persisted directly,
but instead is dynamically computed in a getter that uses other properties as input,
Hibernate Search will be unable to guess which part of the persistent state
these properties are based on.
In this case, some explicit configuration will be required;
see <a href="#mapping-reindexing-derivedfrom"> Reindexing when a derived value changes with <code>@IndexingDependency</code></a> for more information.</p>
</div>
<div class="paragraph">
<p>When the mapping crosses the entity boundaries,
things get more complicated.
Let&#8217;s consider a mapping where a <code>Book</code> entity is mapped to a document,
and that document must include the <code>name</code> property of the <code>Author</code> entity
(for example using <a href="#mapping-indexedembedded"><code>@IndexedEmbedded</code></a>).
Whenever an author&#8217;s name changes,
Hibernate Search will need to <em>retrieve all the books of that author</em>,
to reindex them.</p>
</div>
<div class="paragraph">
<p>In practice, this means that whenever an entity mapping relies on an association to another entity,
this association must be bidirectional:
if <code>Book.authors</code> is <code>@IndexedEmbedded</code>,
Hibernate Search must be aware of an inverse association <code>Author.books</code>.
An exception will be thrown on startup if the inverse association cannot be resolved.</p>
</div>
<div class="paragraph">
<p>Most of the time, when the <a href="#mapper-orm"> Hibernate ORM integration</a> is used, Hibernate Search is able to take advantage of Hibernate ORM metadata
(the <code>mappedBy</code> attribute of <code>@OneToOne</code> and <code>@OneToMany</code>)
to resolve the inverse side of an association,
so this is all handled transparently.</p>
</div>
<div class="paragraph">
<p>In some rare cases, with the more complex mappings,
it is possible that even Hibernate ORM is not aware that an association is bidirectional,
because <code>mappedBy</code> cannot be used, or because the <a href="#mapper-pojo-standalone">Standalone POJO Mapper</a> is being used.
A few solutions exist:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The association can simply be ignored.
This means the index will be out of date whenever associated entities change,
but this can be an acceptable solution if the index
is rebuilt periodically.
See <a href="#mapping-reindexing-reindexonupdate"> Limiting reindexing of containing entities with <code>@IndexingDependency</code></a> for more information.</p>
</li>
<li>
<p>If the association is actually bidirectional,
its inverse side can be specified to Hibernate Search
explicitly using <code>@AssociationInverseSide</code>.
See <a href="#mapping-reindexing-associationinverseside"> Enriching the entity model with <code>@AssociationInverseSide</code></a> for more information.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="mapping-reindexing-associationinverseside"><a class="anchor" href="#mapping-reindexing-associationinverseside"></a>10.10.2. <a id="mapper-orm-reindexing-associationinverseside"></a> Enriching the entity model with <code>@AssociationInverseSide</code></h4>
<div class="paragraph">
<p>Given an association from an entity type <code>A</code> to entity type <code>B</code>,
<code>@AssociationInverseSide</code> defines the inverse side of an association,
i.e. the path from <code>B</code> to <code>A</code>.</p>
</div>
<div class="paragraph">
<p>This is mostly useful when using the <a href="#mapper-pojo-standalone">Standalone POJO Mapper</a>
or when using the <a href="#mapper-orm">Hibernate ORM integration</a> and a bidirectional association
is not mapped as such in Hibernate ORM (no <code>mappedBy</code>).</p>
</div>
<div class="exampleblock">
<div class="title">Example 61. Mapping the inverse side of an association with <code>@AssociationInverseSide</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="annotation">@Entity</span>
<span class="annotation">@Indexed</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">Book</span> {

    <span class="annotation">@Id</span>
    <span class="annotation">@GeneratedValue</span>
    <span class="directive">private</span> <span class="predefined-type">Integer</span> id;

    <span class="directive">private</span> <span class="predefined-type">String</span> title;

    <span class="annotation">@ElementCollection</span> <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="annotation">@JoinTable</span>(
            name = <span class="string"><span class="delimiter">&quot;</span><span class="content">book_editionbyprice</span><span class="delimiter">&quot;</span></span>,
            joinColumns = <span class="annotation">@JoinColumn</span>(name = <span class="string"><span class="delimiter">&quot;</span><span class="content">book_id</span><span class="delimiter">&quot;</span></span>)
    )
    <span class="annotation">@MapKeyJoinColumn</span>(name = <span class="string"><span class="delimiter">&quot;</span><span class="content">edition_id</span><span class="delimiter">&quot;</span></span>)
    <span class="annotation">@Column</span>(name = <span class="string"><span class="delimiter">&quot;</span><span class="content">price</span><span class="delimiter">&quot;</span></span>)
    <span class="annotation">@OrderBy</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">edition_id asc</span><span class="delimiter">&quot;</span></span>)
    <span class="annotation">@IndexedEmbedded</span>( <i class="conum" data-value="2"></i><b>(2)</b>
            name = <span class="string"><span class="delimiter">&quot;</span><span class="content">editionsForSale</span><span class="delimiter">&quot;</span></span>,
            extraction = <span class="annotation">@ContainerExtraction</span>(BuiltinContainerExtractors.MAP_KEY)
    )
    <span class="annotation">@AssociationInverseSide</span>( <i class="conum" data-value="3"></i><b>(3)</b>
            extraction = <span class="annotation">@ContainerExtraction</span>(BuiltinContainerExtractors.MAP_KEY),
            inversePath = <span class="annotation">@ObjectPath</span>(<span class="annotation">@PropertyValue</span>(propertyName = <span class="string"><span class="delimiter">&quot;</span><span class="content">book</span><span class="delimiter">&quot;</span></span>))
    )
    <span class="directive">private</span> <span class="predefined-type">Map</span>&lt;BookEdition, <span class="predefined-type">BigDecimal</span>&gt; priceByEdition = <span class="keyword">new</span> <span class="predefined-type">LinkedHashMap</span>&lt;&gt;();

    <span class="directive">public</span> <span class="predefined-type">Book</span>() {
    }

    <span class="comment">// Getters and setters</span>
    <span class="comment">// ...</span>

}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="annotation">@Entity</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">BookEdition</span> {

    <span class="annotation">@Id</span>
    <span class="annotation">@GeneratedValue</span>
    <span class="directive">private</span> <span class="predefined-type">Integer</span> id;

    <span class="annotation">@ManyToOne</span> <i class="conum" data-value="4"></i><b>(4)</b>
    <span class="directive">private</span> <span class="predefined-type">Book</span> book;

    <span class="annotation">@FullTextField</span>(analyzer = <span class="string"><span class="delimiter">&quot;</span><span class="content">english</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">private</span> <span class="predefined-type">String</span> label;

    <span class="directive">public</span> BookEdition() {
    }

    <span class="comment">// Getters and setters</span>
    <span class="comment">// ...</span>

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This annotation and the following ones are the Hibernate ORM mapping for a <code>Map&lt;BookEdition, BigDecimal&gt;</code>
where the keys are <code>BookEdition</code> entities and the values are the price of that edition.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Index-embed the editions that are actually for sale.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>In Hibernate ORM, it is not possible to use <code>mappedBy</code> for an association modeled by a <code>Map</code> key.
Thus, we use <code>@AssociationInverseSide</code> to tell Hibernate Search what the inverse side
of this association is.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>We could have applied the <code>@AssociationInverseSide</code> annotation here instead:
either side will do.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="mapping-reindexing-derivedfrom"><a class="anchor" href="#mapping-reindexing-derivedfrom"></a>10.10.3. <a id="mapper-orm-reindexing-derivedfrom"></a> Reindexing when a derived value changes with <code>@IndexingDependency</code></h4>
<div class="paragraph">
<p>When a property is not persisted directly,
but instead is dynamically computed in a getter that uses other properties as input,
Hibernate Search will be unable to guess which part of the persistent state
these properties are based on,
and thus will be unable to <a href="#architecture-hsearch-indexing">trigger reindexing</a> when the relevant persistent state changes.
By default, Hibernate Search will detect such cases on bootstrap and throw an exception.</p>
</div>
<div class="paragraph">
<p>Annotating the property with <code>@IndexingDependency(derivedFrom = &#8230;&#8203;)</code>
will give Hibernate Search the information it needs and allow <a href="#architecture-hsearch-indexing">triggering reindexing</a>.</p>
</div>
<div class="exampleblock">
<div class="title">Example 62. Mapping a derived value with <code>@IndexingDependency.derivedFrom</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="annotation">@Entity</span>
<span class="annotation">@Indexed</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">Book</span> {

    <span class="annotation">@Id</span>
    <span class="annotation">@GeneratedValue</span>
    <span class="directive">private</span> <span class="predefined-type">Integer</span> id;

    <span class="directive">private</span> <span class="predefined-type">String</span> title;

    <span class="annotation">@ElementCollection</span>
    <span class="directive">private</span> <span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt; authors = <span class="keyword">new</span> <span class="predefined-type">ArrayList</span>&lt;&gt;(); <i class="conum" data-value="1"></i><b>(1)</b>

    <span class="directive">public</span> <span class="predefined-type">Book</span>() {
    }

    <span class="comment">// Getters and setters</span>
    <span class="comment">// ...</span>

    <span class="annotation">@Transient</span> <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="annotation">@FullTextField</span>(analyzer = <span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>) <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="annotation">@IndexingDependency</span>(derivedFrom = <span class="annotation">@ObjectPath</span>({ <i class="conum" data-value="4"></i><b>(4)</b>
            <span class="annotation">@PropertyValue</span>(propertyName = <span class="string"><span class="delimiter">&quot;</span><span class="content">authors</span><span class="delimiter">&quot;</span></span>)
    }))
    <span class="directive">public</span> <span class="predefined-type">String</span> getMainAuthor() {
        <span class="keyword">return</span> authors.isEmpty() ? <span class="predefined-constant">null</span> : authors.get( <span class="integer">0</span> );
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Authors are modeled as a list of string containing the author names.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The transient <code>mainAuthor</code> property dynamically returns the main author (the first one).</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>We use <code>@FullTextField</code> on the <code>getMainAuthor()</code> getter to index the name of the main author.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>We use <code>@IndexingDependency.derivedFrom</code> to tell Hibernate Search
that whenever the list of authors changes, the result of <code>getMainAuthor()</code> may have changed.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="mapping-reindexing-reindexonupdate"><a class="anchor" href="#mapping-reindexing-reindexonupdate"></a>10.10.4. <a id="mapper-orm-reindexing-reindexonupdate"></a> Limiting reindexing of containing entities with <code>@IndexingDependency</code></h4>
<div class="paragraph">
<p>In some cases, <a href="#architecture-hsearch-indexing">triggering reindexing</a> of entities every time a given property changes is not realistically achievable:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>When an association is massive,
for example a single entity instance is <a href="#mapping-indexedembedded">indexed-embedded</a>
in thousands of other entities.</p>
</li>
<li>
<p>When a property mapped to the index is updated very frequently,
leading to a very frequent reindexing and unacceptable usage of disks or database.</p>
</li>
<li>
<p>Etc.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>When that happens, it is possible to tell Hibernate Search to ignore updates
to a particular property (and, in the case of <code>@IndexedEmbedded</code>, anything beyond that property).</p>
</div>
<div class="paragraph">
<p>Several options are available to control exactly how updates to a given property affect reindexing.
See the sections below for an explanation of each option.</p>
</div>
<div class="sect4">
<h5 id="mapping-reindexing-reindexonupdate-shallow"><a class="anchor" href="#mapping-reindexing-reindexonupdate-shallow"></a><a id="mapper-orm-reindexing-reindexonupdate-shallow"></a> <code>ReindexOnUpdate.SHALLOW</code>: limiting reindexing to same-entity updates only</h5>
<div class="paragraph">
<p><code>ReindexOnUpdate.SHALLOW</code> is most useful when an association is highly asymmetric and therefore unidirectional.
Think associations to "reference" data such as categories, types, cities, countries, &#8230;&#8203;</p>
</div>
<div class="paragraph">
<p>It essentially tells Hibernate Search that changing an association&#8201;&#8212;&#8201;adding or removing associated elements, i.e. "shallow" updates&#8201;&#8212;&#8201;should trigger reindexing of the object on which the change happened,
but changing properties of associated entities&#8201;&#8212;&#8201;"deep" updates&#8201;&#8212;&#8201;should not.</p>
</div>
<div class="paragraph">
<p>For example, let&#8217;s consider the (incorrect) mapping below:</p>
</div>
<div class="exampleblock">
<div class="title">Example 63. A highly-asymmetric, unidirectional association</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="annotation">@Entity</span>
<span class="annotation">@Indexed</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">Book</span> {

    <span class="annotation">@Id</span>
    <span class="directive">private</span> <span class="predefined-type">Integer</span> id;

    <span class="directive">private</span> <span class="predefined-type">String</span> title;

    <span class="annotation">@ManyToOne</span> <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="annotation">@IndexedEmbedded</span> <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="directive">private</span> BookCategory category;

    <span class="directive">public</span> <span class="predefined-type">Book</span>() {
    }

    <span class="comment">// Getters and setters</span>
    <span class="comment">// ...</span>

}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="annotation">@Entity</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">BookCategory</span> {

    <span class="annotation">@Id</span>
    <span class="directive">private</span> <span class="predefined-type">Integer</span> id;

    <span class="annotation">@FullTextField</span>(analyzer = <span class="string"><span class="delimiter">&quot;</span><span class="content">english</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">private</span> <span class="predefined-type">String</span> name;

    <i class="conum" data-value="3"></i><b>(3)</b>

    <span class="comment">// Getters and setters</span>
    <span class="comment">// ...</span>

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Each book has an association to a <code>BookCategory</code> entity.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We want to <a href="#mapping-indexedembedded">index-embed</a> the <code>BookCategory</code> into the <code>Book</code> &#8230;&#8203;</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>&#8230;&#8203; but we really don&#8217;t want to model the (huge) inverse association from <code>BookCategory</code> to <code>Book</code>:
There are potentially thousands of books for each category, so calling a <code>getBooks()</code> method
would lead to loading thousands of entities into the Hibernate ORM session at once,
and would perform badly.
Thus, there isn&#8217;t any <code>getBooks()</code> method to list all books in a category.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>With this mapping, Hibernate Search will not be able to reindex all books when the category name changes:
the getter that would list all books for that category simply doesn&#8217;t exist.
Since Hibernate Search tries to be safe by default,
it will reject this mapping and throw an exception at bootstrap,
saying it needs an inverse side to the <code>Book</code> &#8594; <code>BookCategory</code> association.</p>
</div>
<div class="paragraph">
<p>However, in this case, we don&#8217;t expect the name of a <code>BookCategory</code> to change.
That&#8217;s really "reference" data, which changes so rarely that we can conceivably plan ahead such change
and <a href="#indexing-massindexer">reindex all books</a> whenever that happens.
So we would really not mind if Hibernate Search just ignored changes to <code>BookCategory</code>&#8230;&#8203;</p>
</div>
<div class="paragraph">
<p>That&#8217;s what <code>@IndexingDependency(reindexOnUpdate = ReindexOnUpdate.SHALLOW)</code> is for:
it tells Hibernate Search to ignore the impact of updates to an associated entity.
See the modified mapping below:</p>
</div>
<div class="exampleblock">
<div class="title">Example 64. Limiting reindexing to same-entity updates with <code>ReindexOnUpdate.SHALLOW</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="annotation">@Entity</span>
<span class="annotation">@Indexed</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">Book</span> {

    <span class="annotation">@Id</span>
    <span class="directive">private</span> <span class="predefined-type">Integer</span> id;

    <span class="directive">private</span> <span class="predefined-type">String</span> title;

    <span class="annotation">@ManyToOne</span>
    <span class="annotation">@IndexedEmbedded</span>
    <span class="annotation">@IndexingDependency</span>(reindexOnUpdate = ReindexOnUpdate.SHALLOW) <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="directive">private</span> BookCategory category;

    <span class="directive">public</span> <span class="predefined-type">Book</span>() {
    }

    <span class="comment">// Getters and setters</span>
    <span class="comment">// ...</span>

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We use <code>ReindexOnUpdate.SHALLOW</code> to tell Hibernate Search that <code>Book</code>
should be re-indexed when it&#8217;s assigned a new category (<code>book.setCategory( newCategory )</code>),
but not when properties of its category change (<code>category.setName( newName )</code>).</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>Hibernate Search will accept the mapping above and boot successfully,
since the inverse side of the association from <code>Book</code> to <code>BookCategory</code> is no longer deemed necessary.</p>
</div>
<div class="paragraph">
<p>Only <em>shallow</em> changes to a book&#8217;s category will trigger reindexing of that book:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>When a book is assigned a new category (<code>book.setCategory( newCategory )</code>),
Hibernate Search will consider it a "shallow" change, since it only affects the <code>Book</code> entity.
Thus, Hibernate Search will reindex the book.</p>
</li>
<li>
<p>When a category itself changes (<code>category.setName( newName )</code>),
Hibernate Search will consider it a "deep" change, since it occurs beyond the boundaries of the <code>Book</code> entity.
Thus, Hibernate Search will <strong>not</strong> reindex books of that category by itself.
The index will become slightly out-of-sync,
but this can be solved by <a href="#indexing-massindexer">reindexing</a> <code>Book</code> entities,
for example every night.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="mapping-reindexing-reindexonupdate-no"><a class="anchor" href="#mapping-reindexing-reindexonupdate-no"></a><a id="mapper-orm-reindexing-reindexonupdate-no"></a> <code>ReindexOnUpdate.NO</code>: disabling reindexing caused by updates of a particular property</h5>
<div class="paragraph">
<p><code>ReindexOnUpdate.NO</code> is most useful for properties that change very frequently
and don&#8217;t need to be up-to-date in the index.</p>
</div>
<div class="paragraph">
<p>It essentially tells Hibernate Search that changes to that property should not <a href="#architecture-hsearch-indexing">trigger reindexing</a>,</p>
</div>
<div class="paragraph">
<p>For example, let&#8217;s consider the mapping below:</p>
</div>
<div class="exampleblock">
<div class="title">Example 65. A frequently-changing property</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="annotation">@Entity</span>
<span class="annotation">@Indexed</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">Sensor</span> {

    <span class="annotation">@Id</span>
    <span class="directive">private</span> <span class="predefined-type">Integer</span> id;

    <span class="annotation">@FullTextField</span>
    <span class="directive">private</span> <span class="predefined-type">String</span> name; <i class="conum" data-value="1"></i><b>(1)</b>

    <span class="annotation">@KeywordField</span>
    <span class="directive">private</span> SensorStatus status; <i class="conum" data-value="1"></i><b>(1)</b>

    <span class="annotation">@Column</span>(name = <span class="string"><span class="delimiter">&quot;</span><span class="char">\&quot;</span><span class="content">value</span><span class="char">\&quot;</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">private</span> <span class="type">double</span> value; <i class="conum" data-value="2"></i><b>(2)</b>

    <span class="annotation">@GenericField</span>
    <span class="directive">private</span> <span class="type">double</span> rollingAverage; <i class="conum" data-value="3"></i><b>(3)</b>

    <span class="directive">public</span> Sensor() {
    }

    <span class="comment">// Getters and setters</span>
    <span class="comment">// ...</span>

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The sensor name and status get updated very rarely.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The sensor value gets updated every few milliseconds</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>When the sensor value gets updated, we also update the rolling average over the last few seconds
(based on data not shown here).</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>Updates to the name and status, which are rarely updated, can perfectly well trigger reindexing.
But considering there are thousands of sensors,
updates to the sensor value cannot reasonably trigger reindexing:
reindexing thousands of sensors every few milliseconds probably won&#8217;t perform well.</p>
</div>
<div class="paragraph">
<p>In this scenario, however, search on sensor value is not considered critical and indexes don&#8217;t need to be as fresh.
We can accept indexes to lag behind a few minutes when it comes to a sensor value.
We can consider setting up a batch process that runs every few seconds
to reindex all sensors, either through a <a href="#indexing-massindexer">mass indexer</a>,
using the <a href="#mapper-orm-indexing-jakarta-batch">Jakarta Batch mass indexing job</a>,
or <a href="#indexing-explicit">explicitly</a>.
So we would really not mind if Hibernate Search just ignored changes to sensor values&#8230;&#8203;</p>
</div>
<div class="paragraph">
<p>That&#8217;s what <code>@IndexingDependency(reindexOnUpdate = ReindexOnUpdate.NO)</code> is for:
it tells Hibernate Search to ignore the impact of updates to the <code>rollingAverage</code> property.
See the modified mapping below:</p>
</div>
<div class="exampleblock">
<div class="title">Example 66. Disabling listener-triggered reindexing for a particular property with <code>ReindexOnUpdate.NO</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="annotation">@Entity</span>
<span class="annotation">@Indexed</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">Sensor</span> {

    <span class="annotation">@Id</span>
    <span class="directive">private</span> <span class="predefined-type">Integer</span> id;

    <span class="annotation">@FullTextField</span>
    <span class="directive">private</span> <span class="predefined-type">String</span> name;

    <span class="annotation">@KeywordField</span>
    <span class="directive">private</span> SensorStatus status;

    <span class="annotation">@Column</span>(name = <span class="string"><span class="delimiter">&quot;</span><span class="char">\&quot;</span><span class="content">value</span><span class="char">\&quot;</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">private</span> <span class="type">double</span> value;

    <span class="annotation">@GenericField</span>
    <span class="annotation">@IndexingDependency</span>(reindexOnUpdate = ReindexOnUpdate.NO) <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="directive">private</span> <span class="type">double</span> rollingAverage;

    <span class="directive">public</span> Sensor() {
    }

    <span class="comment">// Getters and setters</span>
    <span class="comment">// ...</span>

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We use <code>ReindexOnUpdate.NO</code> to tell Hibernate Search that updates to <code>rollingAverage</code>
should not <a href="#architecture-hsearch-indexing">trigger reindexing</a>.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>With this mapping:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>When a sensor is assigned a new name (<code>sensor.setName( newName )</code>) or status (<code>sensor.setStatus( newStatus )</code>),
Hibernate Search will <a href="#architecture-hsearch-indexing">trigger reindexing</a> of the sensor.</p>
</li>
<li>
<p>When a sensor is assigned a new rolling average (<code>sensor.setRollingAverage( newName )</code>),
Hibernate Search will <strong>not</strong> <a href="#architecture-hsearch-indexing">trigger reindexing</a> of the sensor.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="mapping-reindexing-programmatic"><a class="anchor" href="#mapping-reindexing-programmatic"></a>10.10.5. <a id="mapper-orm-reindexing-programmatic"></a> Programmatic mapping</h4>
<div class="paragraph">
<p>You can control reindexing through the <a href="#mapping-programmatic">programmatic mapping</a> too.
Behavior and options are identical to annotation-based mapping.</p>
</div>
<div class="exampleblock">
<div class="title">Example 67. Mapping the inverse side of an association with <code>.associationInverseSide(&#8230;&#8203;)</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">TypeMappingStep bookMapping = mapping.type( <span class="predefined-type">Book</span>.class );
bookMapping.indexed();
bookMapping.property( <span class="string"><span class="delimiter">&quot;</span><span class="content">priceByEdition</span><span class="delimiter">&quot;</span></span> )
        .indexedEmbedded( <span class="string"><span class="delimiter">&quot;</span><span class="content">editionsForSale</span><span class="delimiter">&quot;</span></span> )
                .extractor( BuiltinContainerExtractors.MAP_KEY )
        .associationInverseSide( PojoModelPath.parse( <span class="string"><span class="delimiter">&quot;</span><span class="content">book</span><span class="delimiter">&quot;</span></span> ) )
                .extractor( BuiltinContainerExtractors.MAP_KEY );
TypeMappingStep bookEditionMapping = mapping.type( BookEdition.class );
bookEditionMapping.property( <span class="string"><span class="delimiter">&quot;</span><span class="content">label</span><span class="delimiter">&quot;</span></span> )
        .fullTextField().analyzer( <span class="string"><span class="delimiter">&quot;</span><span class="content">english</span><span class="delimiter">&quot;</span></span> );</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 68. Mapping a derived value with <code>.indexingDependency().derivedFrom(&#8230;&#8203;)</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">TypeMappingStep bookMapping = mapping.type( <span class="predefined-type">Book</span>.class );
bookMapping.indexed();
bookMapping.property( <span class="string"><span class="delimiter">&quot;</span><span class="content">mainAuthor</span><span class="delimiter">&quot;</span></span> )
        .fullTextField().analyzer( <span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span> )
        .indexingDependency().derivedFrom( PojoModelPath.parse( <span class="string"><span class="delimiter">&quot;</span><span class="content">authors</span><span class="delimiter">&quot;</span></span> ) );</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 69. Limiting <a href="#architecture-hsearch-indexing">triggering reindexing</a> with <code>.indexingDependency().reindexOnUpdate(&#8230;&#8203;)</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">TypeMappingStep bookMapping = mapping.type( <span class="predefined-type">Book</span>.class );
bookMapping.indexed();
bookMapping.property( <span class="string"><span class="delimiter">&quot;</span><span class="content">category</span><span class="delimiter">&quot;</span></span> )
        .indexedEmbedded()
        .indexingDependency().reindexOnUpdate( ReindexOnUpdate.SHALLOW );
TypeMappingStep bookCategoryMapping = mapping.type( BookCategory.class );
bookCategoryMapping.property( <span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span> )
        .fullTextField().analyzer( <span class="string"><span class="delimiter">&quot;</span><span class="content">english</span><span class="delimiter">&quot;</span></span> );</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="mapping-changes"><a class="anchor" href="#mapping-changes"></a>10.11. <a id="mapper-orm-mapping-changes"></a> Changing the mapping of an existing application</h3>
<div class="paragraph">
<p>Over the lifetime of an application,
it will happen that the mapping of a particular indexed entity type has to change.
When this happens, the mapping changes are likely to require changes to the structure of the index,
i.e. its <em>schema</em>.
Hibernate Search does <strong>not</strong> handle this structure change automatically,
so manual intervention is required.</p>
</div>
<div class="paragraph">
<p>The simplest solution when the index structure needs to change is to:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Drop and re-create the index and its schema,
either manually by deleting the filesystem directory for Lucene
or using the REST API to delete the index for Elasticsearch,
or using Hibernate Search&#8217;s <a href="#schema-management">schema management features</a>.</p>
</li>
<li>
<p>Re-populate the index, for example using the <a href="#indexing-massindexer">mass indexer</a>.</p>
</li>
</ol>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Technically, dropping the index and reindexing is not <em>strictly</em> required if the mapping changes include <em>only</em>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>adding</strong> new indexed entities that will not have any persisted instance,
e.g. adding an <code>@Indexed</code> annotation on an entity which has no rows in database.</p>
</li>
<li>
<p><strong>adding</strong> new fields that will be empty for all currently persisted entities,
e.g. adding a new property on an entity type and mapping it to a field,
but with the guarantee that this property will initially be null for every instance of this entity;</p>
</li>
<li>
<p>and/or <strong>removing</strong> data from existing indexes/fields,
e.g. removing an index field, or removing the need for a field to be stored.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>However, you will still need to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>create missing indexes: this can generally be done automatically
by starting up the application with the <a href="#schema-management-strategy-create"><code>create</code></a>,
<a href="#schema-management-strategy-create-or-validate"><code>create-or-validate</code></a>,
or <a href="#schema-management-strategy-create-or-update"><code>create-or-update</code></a>
schema management strategy.</p>
</li>
<li>
<p>(Elasticsearch only:) update the schema of existing indexes to declare the new fields.
This will be more complex: either do it manually using Elasticsearch&#8217;s REST API,
or start up the application with the <a href="#schema-management-strategy-create-or-update"><code>create-or-update</code> strategy</a>,
but be warned that it <a href="#schema-management-concepts-update-failure">may fail</a>.</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="mapping-custom-annotations"><a class="anchor" href="#mapping-custom-annotations"></a>10.12. <a id="mapper-orm-custom-annotations"></a> Custom mapping annotations</h3>
<div class="sect3">
<h4 id="mapping-custom-annotations-basics"><a class="anchor" href="#mapping-custom-annotations-basics"></a>10.12.1. <a id="mapper-orm-custom-annotations-basics"></a> Basics</h4>
<div class="paragraph">
<p>By default, Hibernate Search only recognizes built-in mapping annotations
such as <code>@Indexed</code>, <code>@GenericField</code> or <code>@IndexedEmbedded</code>.</p>
</div>
<div class="paragraph">
<p>To use custom annotations in a Hibernate Search mapping,
two steps are required:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Implementing a processor for that annotation:
<code>TypeMappingAnnotationProcessor</code> for type annotations,
<code>PropertyMappingAnnotationProcessor</code> for method/field annotations,
<code>ConstructorMappingAnnotationProcessor</code> for constructor annotations,
or <code>MethodParameterMappingAnnotationProcessor</code> for constructor parameter annotations.</p>
</li>
<li>
<p>Annotating the custom annotation with either <code>@TypeMapping</code>, <code>@PropertyMapping</code>, <code>@ConstructorMapping</code>,
or <code>@MethodParameterMapping</code>,
passing as an argument the reference to the annotation processor.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Once this is done, Hibernate Search will be able to detect custom annotations in <strong>indexed classes</strong>
(though not necessarily in custom projection types, see <a href="#mapping-custom-annotations-root"> Custom root mapping annotations</a>).
Whenever a custom annotation is encountered,
Hibernate Search will instantiate the annotation processor
and call its <code>process</code> method, passing the following as arguments:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A <code>mapping</code> parameter allowing to define the mapping for the type, property, constructor, or constructor parameter
using the <a href="#mapping-programmatic">programmatic mapping API</a>.</p>
</li>
<li>
<p>An <code>annotation</code> parameter representing the annotation instance.</p>
</li>
<li>
<p>A <code>context</code> object with various helpers.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Custom annotations are most frequently used to apply custom, parameterized binders or bridges.
You can find examples in these sections in particular:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#binding-valuebridge-parameters-custom-annotation">Passing parameters to a value binder/bridge through a custom annotation</a></p>
</li>
<li>
<p><a href="#binding-propertybridge-parameters-custom-annotation">Passing parameters to a property binder/bridge through a custom annotation</a></p>
</li>
<li>
<p><a href="#binding-typebridge-parameters-custom-annotation">Passing parameters to a type binder/bridge through a custom annotation</a></p>
</li>
<li>
<p><a href="#binding-identifierbridge-parameters-custom-annotation">Passing parameters to an identifier binder/bridge through a custom annotation</a></p>
</li>
<li>
<p><a href="#binding-projection-parameters-custom-annotation">Passing parameters to a projection binder through a custom annotation</a></p>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>It is completely possible to use custom annotations for parameter-less binders or bridges,
or even for more complex features such as indexed-embedded:
every feature available in the <a href="#mapping-programmatic">programmatic mapping API</a>
can be triggered by a custom annotation.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="mapping-custom-annotations-root"><a class="anchor" href="#mapping-custom-annotations-root"></a>10.12.2. <a id="mapper-orm-custom-annotations-root"></a> Custom root mapping annotations</h4>
<div class="paragraph">
<p>To have Hibernate Search consider a custom annotation as a <a href="#mapping-classpath-scanning-basics">root mapping annotation</a>,
add the <code>@RootMapping</code> meta-annotation to the custom annotation.</p>
</div>
<div class="paragraph">
<p>This will ensure Hibernate Search processes annotations on types annotated with the custom annotation
even if those types are not referenced in the index mapping,
which is mainly useful for custom annotations related to <a href="#mapping-projection">projection mapping</a>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="mapping-inspect"><a class="anchor" href="#mapping-inspect"></a>10.13. <a id="mapper-orm-mapping-inspect"></a> <a id="_metadata_api"></a> Inspecting the mapping</h3>
<div class="paragraph">
<p>After Hibernate Search has successfully booted, the <code>SearchMapping</code> can be used
to get a list of indexed entities and get more direct access to the corresponding indexes,
as shown in the example below.</p>
</div>
<div class="exampleblock">
<div class="title">Example 70. Accessing indexed entities</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">SearchMapping mapping = <span class="comment">/* ... */</span> <i class="conum" data-value="1"></i><b>(1)</b>
SearchIndexedEntity&lt;<span class="predefined-type">Book</span>&gt; bookEntity = mapping.indexedEntity( <span class="predefined-type">Book</span>.class ); <i class="conum" data-value="2"></i><b>(2)</b>
<span class="predefined-type">String</span> jpaName = bookEntity.jpaName(); <i class="conum" data-value="3"></i><b>(3)</b>
IndexManager indexManager = bookEntity.indexManager(); <i class="conum" data-value="4"></i><b>(4)</b>
Backend backend = indexManager.backend(); <i class="conum" data-value="5"></i><b>(5)</b>

SearchIndexedEntity&lt;?&gt; bookEntity2 = mapping.indexedEntity( <span class="string"><span class="delimiter">&quot;</span><span class="content">Book</span><span class="delimiter">&quot;</span></span> ); <i class="conum" data-value="6"></i><b>(6)</b>
<span class="predefined-type">Class</span>&lt;?&gt; javaClass = bookEntity2.javaClass();

<span class="keyword">for</span> ( SearchIndexedEntity&lt;?&gt; entity : mapping.allIndexedEntities() ) { <i class="conum" data-value="7"></i><b>(7)</b>
    <span class="comment">// ...</span>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><a href="#entrypoints-search-mapping">Retrieve the <code>SearchMapping</code></a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Retrieve the <code>SearchIndexedEntity</code> by its entity class.
<code>SearchIndexedEntity</code> gives access to information pertaining to that entity and its index.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>(With the <a href="#mapper-orm">Hibernate ORM integration</a> only) Get the JPA name of that entity.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Get the index manager for that entity.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Get the backend for that index manager.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Retrieve the <code>SearchIndexedEntity</code> by its entity name.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Retrieve all indexed entities.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>From an <code>IndexManager</code>, you can then access the index metamodel,
to inspect available fields and their main characteristics,
as shown below.</p>
</div>
<div class="exampleblock">
<div class="title">Example 71. Accessing the index metamodel</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">SearchIndexedEntity&lt;<span class="predefined-type">Book</span>&gt; bookEntity = mapping.indexedEntity( <span class="predefined-type">Book</span>.class ); <i class="conum" data-value="1"></i><b>(1)</b>
IndexManager indexManager = bookEntity.indexManager(); <i class="conum" data-value="2"></i><b>(2)</b>
IndexDescriptor indexDescriptor = indexManager.descriptor(); <i class="conum" data-value="3"></i><b>(3)</b>

indexDescriptor.field( <span class="string"><span class="delimiter">&quot;</span><span class="content">releaseDate</span><span class="delimiter">&quot;</span></span> ).ifPresent( field -&gt; { <i class="conum" data-value="4"></i><b>(4)</b>
    <span class="predefined-type">String</span> path = field.absolutePath(); <i class="conum" data-value="5"></i><b>(5)</b>
    <span class="predefined-type">String</span> relativeName = field.relativeName();
    <span class="comment">// Etc.</span>

    <span class="keyword">if</span> ( field.isValueField() ) { <i class="conum" data-value="6"></i><b>(6)</b>
        IndexValueFieldDescriptor valueField = field.toValueField(); <i class="conum" data-value="7"></i><b>(7)</b>

        IndexValueFieldTypeDescriptor type = valueField.type(); <i class="conum" data-value="8"></i><b>(8)</b>
        <span class="type">boolean</span> projectable = type.projectable();
        <span class="predefined-type">Class</span>&lt;?&gt; dslArgumentClass = type.dslArgumentClass();
        <span class="predefined-type">Class</span>&lt;?&gt; projectedValueClass = type.projectedValueClass();
        Optional&lt;<span class="predefined-type">String</span>&gt; analyzerName = type.analyzerName();
        Optional&lt;<span class="predefined-type">String</span>&gt; searchAnalyzerName = type.searchAnalyzerName();
        Optional&lt;<span class="predefined-type">String</span>&gt; normalizerName = type.normalizerName();
        <span class="comment">// Etc.</span>
        <span class="predefined-type">Set</span>&lt;<span class="predefined-type">String</span>&gt; traits = type.traits(); <i class="conum" data-value="9"></i><b>(9)</b>
        <span class="keyword">if</span> ( traits.contains( IndexFieldTraits.Aggregations.RANGE ) ) {
            <span class="comment">// ...</span>
        }
    }
    <span class="keyword">else</span> <span class="keyword">if</span> ( field.isObjectField() ) { <i class="conum" data-value="10"></i><b>(10)</b>
        IndexObjectFieldDescriptor objectField = field.toObjectField();

        IndexObjectFieldTypeDescriptor type = objectField.type();
        <span class="type">boolean</span> nested = type.nested();
        <span class="comment">// Etc.</span>
    }
} );</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Retrieve a <code>SearchIndexedEntity</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Get the index manager for that entity.
<code>IndexManager</code> gives access to information pertaining to the index.
This includes the metamodel, but not only (see below).</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Get the descriptor for that index.
The descriptor exposes the index metamodel.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Retrieve a field by name. The method returns an <code>Optional</code>, which is empty if the field does not exist.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>The field descriptor exposes information about the field structure: path, name, parent, &#8230;&#8203;</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Check that the field is a value field, holding a value (integer, text, &#8230;&#8203;),
as opposed to object fields, holding other fields.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Narrow down the field descriptor to a value field descriptor.</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>Get the descriptor for the field type.
The type descriptor exposes information about the field&#8217;s capabilities:
is it searchable, sortable, projectable,
what is the expected java class for arguments to the <a href="#search-dsl">Search DSL</a>,
what are the analyzers/normalizer set on this field,
&#8230;&#8203;</td>
</tr>
<tr>
<td><i class="conum" data-value="9"></i><b>9</b></td>
<td>Inspect the "traits" of a field type:
each trait represents a predicate/sort/projection/aggregation
that can be used on fields of that type.</td>
</tr>
<tr>
<td><i class="conum" data-value="10"></i><b>10</b></td>
<td>Object fields can also be inspected.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The <code>Backend</code> and <code>IndexManager</code> can also be used to
<a href="#backend-elasticsearch-access-client">retrieve the Elasticsearch REST client</a>
or <a href="#backend-lucene-access-analyzers">retrieve Lucene analyzers</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <code>SearchMapping</code> also exposes methods to retrieve an <code>IndexManager</code> by name,
or even a whole <code>Backend</code> by name.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="mapping-projection"><a class="anchor" href="#mapping-projection"></a>11. <a id="mapper-orm-mapping-projection"></a> Mapping index content to custom types (projection constructors)</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="mapping-projection-basics"><a class="anchor" href="#mapping-projection-basics"></a>11.1. <a id="mapper-orm-mapping-projection-basics"></a> Basics</h3>
<div class="paragraph">
<p><a href="#search-dsl-projection">Projections</a> allow retrieving data directly from matched documents
as the result of a search query.
As the structure of documents and projections becomes more complex,
so do <a href="#search-dsl-projection-concepts">programmatic calls to the Projection DSL</a>,
which can lead to overwhelming projection definitions.</p>
</div>
<div class="paragraph">
<p>To address this, Hibernate Search offers the ability to define projections through the mapping of custom types
(typically records), by applying the <code>@ProjectionConstructor</code> annotation to those types or their constructor.
Executing such a projection then becomes as easy as <a href="#search-dsl-projection-mapped">referencing the custom type</a>.</p>
</div>
<div class="paragraph">
<p>Such projections are <a href="#search-dsl-projection-composite">composite</a>,
their inner projections (components) being
<a href="#mapping-projection-inner-inference">inferred from the name and type of the projection constructors' parameters</a>.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>There are a few constraints to keep in mind when annotating a custom projection type:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The custom projection type must be in the same JAR as entity types,
or Hibernate Search will <a href="#mapping-projection-type-detection">require additional configuration</a>.</p>
</li>
<li>
<p>When projecting on value fields or object fields, the path to the projected field
is inferred from the constructor parameter name by default,
but <a href="#mapping-projection-inner-inference-fieldpath">inference will fail if constructor parameter names are not included in the Java bytecode</a>.
Alternatively the path can be provided explicitly
through <a href="#search-dsl-projection-field-mapping"><code>@FieldProjection(path = &#8230;&#8203;)</code></a>/<a href="#search-dsl-projection-object-mapping"><code>@ObjectProjection(path = &#8230;&#8203;)</code></a>,
in which case Hibernate Search won&#8217;t rely on constructor parameter names.</p>
</li>
<li>
<p>When projecting on value fields, the constraints of the <a href="#search-dsl-projection-field"><code>field</code></a> projection still apply.
In particular, with the <a href="#backend-lucene">Lucene backend</a>, value fields involved in the projection
must be configured as <a href="#mapping-directfieldmapping-projectable">projectable</a>.</p>
</li>
<li>
<p>When projecting on object fields, the constraints of the <a href="#search-dsl-projection-object"><code>object</code></a> projection still apply.
In particular, with the <a href="#backend-lucene">Lucene backend</a>, multi-valued object fields involved in the projection
must be configured as <a href="#mapping-indexedembedded-structure-nested">nested</a>.</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="exampleblock">
<div class="title">Example 72. Using a custom record type to project data from the index</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="annotation">@ProjectionConstructor</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="directive">public</span> record MyBookProjection(
        <span class="annotation">@IdProjection</span> <span class="predefined-type">Integer</span> id, <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="predefined-type">String</span> title, <i class="conum" data-value="3"></i><b>(3)</b>
        <span class="predefined-type">List</span>&lt;Author&gt; authors) { <i class="conum" data-value="4"></i><b>(4)</b>
    <span class="annotation">@ProjectionConstructor</span> <i class="conum" data-value="5"></i><b>(5)</b>
    <span class="directive">public</span> record Author(<span class="predefined-type">String</span> firstName, <span class="predefined-type">String</span> lastName) {
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Annotate the record type with <code>@ProjectionConstructor</code>,
either at the type level (if there&#8217;s only one constructor)
or at the constructor level (if there are <a href="#mapping-projection-multiple-constructors">multiple constructors</a>).</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>To project on the entity identifier, annotate the relevant constructor parameter with <a href="#search-dsl-projection-id-mapping"><code>@IdProjection</code></a>.
<div class="paragraph">
<p>Most projections have a corresponding annotation that can be used on constructor parameters.</p>
</div></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>To project on a value field, add a constructor parameter named after that field and with the same type as that field.
See <a href="#mapping-projection-inner-inference"> Implicit inner projection inference</a> for more information on how constructor parameters should be defined.
<div class="paragraph">
<p>Alternatively, the field projection can be configured explicitly with <a href="#search-dsl-projection-field-mapping"><code>@FieldProjection</code></a>.</p>
</div></td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>To project on an object field, add a constructor parameter named after that field and with its own custom projection type.
Multivalued projections <a href="#mapping-projection-inner-inference-type">must be modeled as a <code>List&lt;&#8230;&#8203;&gt;</code></a> or supertype.
<div class="paragraph">
<p>Alternatively, the object projection can be configured explicitly with <a href="#search-dsl-projection-object-mapping"><code>@ObjectProjection</code></a>.</p>
</div></td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Annotate any custom projection type used for object fields with <code>@ProjectionConstructor</code> as well.</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;MyBookProjection&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .select( MyBookProjection.class ) <i class="conum" data-value="1"></i><b>(1)</b>
        .where( f -&gt; f.matchAll() )
        .fetchHits( <span class="integer">20</span> ); <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Pass the custom projection type to <code>.select(&#8230;&#8203;)</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Each hit will be an instance of the custom projection type,
populated with data retrieved from the index.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Custom, non-record classes can also be annotated with <code>@ProjectionConstructor</code>,
which can be useful if you cannot use records for some reason
(for example because you&#8217;re still using Java 13 or below).</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The example above executes a projection equivalent to the following code:</p>
</div>
<div class="exampleblock">
<div class="title">Example 73. Programmatic projection definition equivalent to the previous example</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;MyBookProjection&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .select( f -&gt; f.composite()
                .from(
                        f.id( <span class="predefined-type">Integer</span>.class ),
                        f.field( <span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">String</span>.class ),
                        f.object( <span class="string"><span class="delimiter">&quot;</span><span class="content">authors</span><span class="delimiter">&quot;</span></span> )
                                .from(
                                        f.field( <span class="string"><span class="delimiter">&quot;</span><span class="content">authors.firstName</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">String</span>.class ),
                                        f.field( <span class="string"><span class="delimiter">&quot;</span><span class="content">authors.lastName</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">String</span>.class )
                                )
                                .as( MyBookProjection.Author::<span class="keyword">new</span> )
                                .multi()
                )
                .as( MyBookProjection::<span class="keyword">new</span> ) )
        .where( f -&gt; f.matchAll() )
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="mapping-projection-type-detection"><a class="anchor" href="#mapping-projection-type-detection"></a>11.2. <a id="mapper-orm-mapping-projection-type-detection"></a> Detection of mapped projection types</h3>
<div class="paragraph">
<p>Hibernate Search must know of projection types on startup,
which it generally does as soon as they are annotated with <code>@ProjectionConstructor</code>,
thanks to classpath scanning.</p>
</div>
<div class="paragraph">
<p>For more information about classpath scanning and how to tune it
(for example to scan dependencies instead of just the application JAR),
see <a href="#mapping-classpath-scanning"> Classpath scanning</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="mapping-projection-inner-inference"><a class="anchor" href="#mapping-projection-inner-inference"></a>11.3. <a id="mapper-orm-mapping-projection-inner-inference"></a> Implicit inner projection inference</h3>
<div class="sect3">
<h4 id="mapping-projection-inner-inference-basics"><a class="anchor" href="#mapping-projection-inner-inference-basics"></a>11.3.1. <a id="mapper-orm-mapping-projection-inner-inference-basics"></a> Basics</h4>
<div class="paragraph">
<p>When constructor parameters are not annotated with <a href="#mapping-projection-inner-explicit">explicit projection annotations</a>,
Hibernate Search applies some basic inference rules based on the name and type of those parameters
in order to select (inner) projections.</p>
</div>
<div class="paragraph">
<p>The following sections explain how to define the name and type of constructor parameters
to get the desired projection.</p>
</div>
</div>
<div class="sect3">
<h4 id="mapping-projection-inner-inference-type"><a class="anchor" href="#mapping-projection-inner-inference-type"></a>11.3.2. <a id="mapper-orm-mapping-projection-inner-inference-type"></a> Inner projection and type</h4>
<div class="paragraph">
<p>When a constructor parameter is not annotated with an <a href="#mapping-projection-inner-explicit">explicit projection annotation</a>,
Hibernate Search infers the type of the inner projection from the type of the corresponding constructor parameter.</p>
</div>
<div class="paragraph">
<p>You should set the type of a constructor parameter according to the following rules:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>For a single-valued projection:</p>
<div class="ulist">
<ul>
<li>
<p>For a <a href="#search-dsl-projection-field">projection on a value field</a>
(generally mapped using <a href="#mapping-directfieldmapping-annotations-fulltextfield"><code>@FullTextField</code></a>/<a href="#mapping-geopoint-genericfield"><code>@GenericField</code></a>/etc.),
set the parameter type to the <a href="#search-dsl-projected-value-type">type of projected values</a>
for the target field, which in general is the type of the property annotated with <code>@FullTextField</code>/<code>@GenericField</code>/etc.</p>
</li>
<li>
<p>For a <a href="#search-dsl-projection-object">projection on an object field</a>
(generally mapped using <a href="#mapping-indexedembedded"><code>@IndexedEmbedded</code></a>),
set the parameter type to another custom type annotated with <code>@ProjectionConstructor</code>,
whose constructor will define which fields to extract from that object field.</p>
</li>
</ul>
</div>
</li>
<li>
<p>For a multivalued projection, follow the rules above then wrap the type with <code>Iterable</code>, <code>Collection</code> or <code>List</code>,
e.g. <code>Iterable&lt;SomeType&gt;</code>, <code>Collection&lt;SomeType&gt;</code> or <code>List&lt;SomeType&gt;</code>.</p>
</li>
</ul>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Constructor parameters meant to represent a multivalued projection
can <strong>only</strong> have the type <code>Iterable&lt;&#8230;&#8203;&gt;</code>, <code>Collection&lt;&#8230;&#8203;&gt;</code> or <code>List&lt;&#8230;&#8203;&gt;</code>.</p>
</div>
<div class="paragraph">
<p>Other container types such as <code>Map</code> or <code>Optional</code> are not supported
<a href="https://hibernate.atlassian.net/browse/HSEARCH-4577">at the moment</a>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="mapping-projection-inner-inference-fieldpath"><a class="anchor" href="#mapping-projection-inner-inference-fieldpath"></a>11.3.3. <a id="mapper-orm-mapping-projection-inner-inference-fieldpath"></a> Inner projection and field path</h4>
<div class="paragraph">
<p>When a constructor parameter is not annotated with an <a href="#mapping-projection-inner-explicit">explicit projection annotation</a>
or when it is but that annotation does not provide an explicit path,
Hibernate Search infers the path of the field to project on from the name of the corresponding constructor parameter.</p>
</div>
<div class="paragraph">
<p>In that case, you should set the name of a constructor parameter (in the Java code) to the name of the field to project on.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Hibernate Search can only retrieve the name of the constructor parameter:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>For the canonical constructor of record types, regardless of compiler flags.</p>
</li>
<li>
<p>For constructors of non-record types or non-canonical constructors of record types
if and only if the type was compiled with the <code>-parameters</code> compiler flag.</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="mapping-projection-inner-explicit"><a class="anchor" href="#mapping-projection-inner-explicit"></a>11.4. Explicit inner projection</h3>
<div class="paragraph">
<p>Constructor parameters can be annotated with explicit projection annotations such as <code>@IdProjection</code> or <code>@FieldProjection</code>.</p>
</div>
<div class="paragraph">
<p>For projections that would normally be <a href="#mapping-projection-inner-inference">inferred automatically</a>,
this allows further customization, for example in a <a href="#search-dsl-projection-field-mapping">field projection</a>
to set the target field path explicitly or to disable value conversion.
Alternatively, in an <a href="#search-dsl-projection-object-mapping">object projection</a>,
this also allows <a href="#search-dsl-projection-object-mapping-filters">breaking cycles of nested object projections</a>.</p>
</div>
<div class="paragraph">
<p>For other projections such as <a href="#search-dsl-projection-id-mapping">identifier projection</a>,
this is actually the only way to use them in a projection constructor,
because they would never be inferred automatically.</p>
</div>
<div class="paragraph">
<p>See the <a href="#search-dsl-projection">documentation of each projection</a>
for more information about the corresponding built-in annotation
to be applied to projection constructor parameters.</p>
</div>
</div>
<div class="sect2">
<h3 id="mapping-projection-multiple-constructors"><a class="anchor" href="#mapping-projection-multiple-constructors"></a>11.5. <a id="mapper-orm-mapping-projection-multiple-constructors"></a> Mapping types with multiple constructors</h3>
<div class="paragraph">
<p>If the projection type (record or class) has multiple constructors,
the <code>@ProjectionConstructor</code> annotation cannot be applied at the type level
and must be applied to the constructor you wish to use for projections.</p>
</div>
<div class="exampleblock">
<div class="title">Example 74. Annotating a specific constructor with <code>@ProjectionConstructor</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="directive">public</span> <span class="type">class</span> <span class="class">MyAuthorProjectionClassMultiConstructor</span> {
    <span class="directive">public</span> <span class="directive">final</span> <span class="predefined-type">String</span> firstName;
    <span class="directive">public</span> <span class="directive">final</span> <span class="predefined-type">String</span> lastName;

    <span class="annotation">@ProjectionConstructor</span> <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="directive">public</span> MyAuthorProjectionClassMultiConstructor(<span class="predefined-type">String</span> firstName, <span class="predefined-type">String</span> lastName) {
        <span class="local-variable">this</span>.firstName = firstName;
        <span class="local-variable">this</span>.lastName = lastName;
    }

    <span class="directive">public</span> MyAuthorProjectionClassMultiConstructor(<span class="predefined-type">String</span> fullName) { <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="local-variable">this</span>( fullName.split( <span class="string"><span class="delimiter">&quot;</span><span class="content"> </span><span class="delimiter">&quot;</span></span> )[<span class="integer">0</span>], fullName.split( <span class="string"><span class="delimiter">&quot;</span><span class="content"> </span><span class="delimiter">&quot;</span></span> )[<span class="integer">1</span>] );
    }

    <span class="comment">// ... Equals and hashcode ...</span>

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Annotate the constructor to use for projections with <code>@ProjectionConstructor</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Other constructors can be used for other purposes than projections,
but they <strong>must not</strong> be annotated with <code>@ProjectionConstructor</code> (only one such constructor is allowed).</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>In the case of records, the (implicit) canonical constructor can also be annotated,
but it requires representing that constructor in the code with a specific syntax:</p>
</div>
<div class="exampleblock">
<div class="title">Example 75. Annotating the canonical constructor with <code>@ProjectionConstructor</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="directive">public</span> record MyAuthorProjectionRecordMultiConstructor(<span class="predefined-type">String</span> firstName, <span class="predefined-type">String</span> lastName) {
    <span class="annotation">@ProjectionConstructor</span> <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="directive">public</span> MyAuthorProjectionRecordMultiConstructor { <i class="conum" data-value="2"></i><b>(2)</b>
    }

    <span class="directive">public</span> MyAuthorProjectionRecordMultiConstructor(<span class="predefined-type">String</span> fullName) { <i class="conum" data-value="3"></i><b>(3)</b>
        <span class="local-variable">this</span>( fullName.split( <span class="string"><span class="delimiter">&quot;</span><span class="content"> </span><span class="delimiter">&quot;</span></span> )[<span class="integer">0</span>], fullName.split( <span class="string"><span class="delimiter">&quot;</span><span class="content"> </span><span class="delimiter">&quot;</span></span> )[<span class="integer">1</span>] );
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Annotate the constructor to use for projections with <code>@ProjectionConstructor</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The (implicit) canonical constructor uses a specific syntax, without parentheses or parameters.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Other constructors can be used for other purposes than projections,
but they <strong>must not</strong> be annotated with <code>@ProjectionConstructor</code> (only one such constructor is allowed).</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="mapping-projection-programmatic"><a class="anchor" href="#mapping-projection-programmatic"></a>11.6. <a id="mapper-orm-mapping-projection-programmatic"></a> Programmatic mapping</h3>
<div class="paragraph">
<p>You can map projection constructors through the <a href="#mapping-programmatic">programmatic mapping</a> too.
Behavior and options are identical to annotation-based mapping.</p>
</div>
<div class="exampleblock">
<div class="title">Example 76. Mapping the main projection constructor with <code>.projectionConstructor()</code> and <code>.projection(&lt;binder&gt;)</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">TypeMappingStep myBookProjectionMapping = mapping.type( MyBookProjection.class );
myBookProjectionMapping.mainConstructor()
        .projectionConstructor(); <i class="conum" data-value="1"></i><b>(1)</b>
myBookProjectionMapping.mainConstructor().parameter( <span class="integer">0</span> )
        .projection( IdProjectionBinder.create() ); <i class="conum" data-value="2"></i><b>(2)</b>
TypeMappingStep myAuthorProjectionMapping = mapping.type( MyBookProjection.Author.class );
myAuthorProjectionMapping.mainConstructor()
        .projectionConstructor();</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Mark the constructor as a projection constructor.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The equivalent to <a href="#mapping-projection-inner-explicit">explicit projection annotations</a>
is to pass <a href="#binding-projection">projection binder</a> instances:
there is a built-in projection binder for every built-in projection annotation.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>If the projection type (record or class) has multiple constructors,
you will need to use <code>.constructor(&#8230;&#8203;)</code> instead of <code>.mainConstructor()</code>,
passing the (raw) type of the constructor parameters as arguments.</p>
</div>
<div class="exampleblock">
<div class="title">Example 77. Mapping a specific projection constructor with <code>.projectionConstructor()</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">mapping.type( MyAuthorProjectionClassMultiConstructor.class )
        .constructor( <span class="predefined-type">String</span>.class, <span class="predefined-type">String</span>.class )
        .projectionConstructor();</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="binding"><a class="anchor" href="#binding"></a>12. <a id="mapper-orm-bridge"></a> <a id="search-mapping-bridge"></a> Binding and bridges</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="binding-basics"><a class="anchor" href="#binding-basics"></a>12.1. <a id="mapper-orm-bridge-basics"></a> <a id="section-custom-bridges"></a> Basics</h3>
<div class="paragraph">
<p>In Hibernate Search, <a href="#concepts-binding">binding</a> is the process of assigning custom components to the domain model.</p>
</div>
<div class="paragraph">
<p>The most intuitive components that can be bound are bridges,
responsible for converting pieces of data from the entity model to the document model.</p>
</div>
<div class="paragraph">
<p>For example, when <code>@GenericField</code> is applied to a property of a custom enum type,
a built-in bridge will be used to convert this enum to a string when indexing,
and to convert the string back to an enum when projecting.</p>
</div>
<div class="paragraph">
<p>Similarly, when an entity identifier of type <code>Long</code> is mapped to a document identifier,
a built-in bridge will be used to convert the <code>Long</code> to a <code>String</code>
(since all document identifiers are strings)
when indexing,
and back from a <code>String</code> to a <code>Long</code> when loading search results.</p>
</div>
<div class="paragraph">
<p>Bridges are not limited to one-to-one mapping:
for example, the <a href="#mapping-geopoint-geopointbinding"><code>@GeoPointBinding</code></a> annotation,
which maps two properties annotated with <code>@Latitude</code> and <code>@Longitude</code>
to a single field, is backed by another built-in bridge.</p>
</div>
<div class="paragraph">
<p>While built-in bridges are provided for a wide range of standard types,
they may not be enough for complex models.
This is why bridges are really useful:
it is possible to implement custom bridges and to refer to them in the Hibernate Search mapping.
Using custom bridges, custom types can be mapped,
even complex types that require user code to execute at indexing time.</p>
</div>
<div class="paragraph">
<p>There are multiple types of bridges,
detailed in the next sections.
If you need to implement a custom bridge, but don&#8217;t quite know which type of bridge you need,
the following table may help:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 6. Comparison of available bridge types</caption>
<colgroup>
<col style="width: 16.6666%;">
<col style="width: 16.6666%;">
<col style="width: 16.6666%;">
<col style="width: 16.6666%;">
<col style="width: 16.6666%;">
<col style="width: 16.667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Bridge type</th>
<th class="tableblock halign-left valign-top"><a href="#binding-valuebridge"><code>ValueBridge</code></a></th>
<th class="tableblock halign-left valign-top"><a href="#binding-propertybridge"><code>PropertyBridge</code></a></th>
<th class="tableblock halign-left valign-top"><a href="#binding-typebridge"><code>TypeBridge</code></a></th>
<th class="tableblock halign-left valign-top"><a href="#binding-identifierbridge"><code>IdentifierBridge</code></a></th>
<th class="tableblock halign-left valign-top"><a href="#binding-routingbridge"><code>RoutingBridge</code></a></th>
</tr>
</thead>
<tbody>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">Applied to&#8230;&#8203;</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">Class field or getter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Class field or getter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Class</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Class field or getter (usually entity ID)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Class</p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">Maps to&#8230;&#8203;</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">One index field.
Value field only: integer, text, geopoint, etc.
No <a href="#binding-index-field-dsl-object">object field</a> (composite).</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">One index field or more.
Value fields as well as <a href="#binding-index-field-dsl-object">object fields</a> (composite).</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">One index field or more.
Value fields as well as <a href="#binding-index-field-dsl-object">object fields</a> (composite).</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Document identifier</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Route (conditional indexing, <a href="#concepts-sharding-routing">routing key</a>)</p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">Built-in annotation(s)</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#mapping-directfieldmapping"><code>@GenericField</code>, <code>@FullTextField</code>, &#8230;&#8203;</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@PropertyBinding</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@TypeBinding</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#mapping-identifiermapping"><code>@DocumentId</code></a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@Indexed( routingBinder = &#8230;&#8203; )</code></p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">Supports <a href="#mapping-containerextractor">container extractors</a></p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">Supports mutable types</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong class="red">No</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong class="red">No</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Not all binders are about indexing, however.
The constructor parameters involved in <a href="#mapping-projection">projection constructors</a>
can be bound as well; you will find more information about that in <a href="#binding-projection">this section</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="binding-valuebridge"><a class="anchor" href="#binding-valuebridge"></a>12.2. <a id="mapper-orm-bridge-valuebridge"></a> <a id="_stringbridge"></a> Value bridge</h3>
<div class="sect3">
<h4 id="binding-valuebridge-basics"><a class="anchor" href="#binding-valuebridge-basics"></a>12.2.1. <a id="mapper-orm-bridge-valuebridge-basics"></a> Basics</h4>
<div class="paragraph">
<p>A value bridge is a pluggable component that implements
the mapping of a property to an index field.
It is applied to a property with a <a href="#mapping-directfieldmapping-annotations"><code>@*Field</code> annotation</a>
(<code>@GenericField</code>, <code>@FullTextField</code>, &#8230;&#8203;)
or with a <a href="#mapping-custom-annotations">custom annotation</a>.</p>
</div>
<div class="paragraph">
<p>A value bridge is relatively straightforward to implement:
in its simplest form,
it boils down to converting a value from the property type
to the index field type.
Thanks to the integration to the <code>@*Field</code> annotations,
several features come for free:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The type of the index field can be customized directly in the <code>@*Field</code> annotation:
it can be defined as <a href="#mapping-directfieldmapping-sortable">sortable</a>,
<a href="#mapping-directfieldmapping-projectable">projectable</a>,
it can be assigned an <a href="#mapping-directfieldmapping-analyzer">analyzer</a>,
&#8230;&#8203;</p>
</li>
<li>
<p>The bridge can be transparently applied to elements of a container.
For example, you can implement a <code>ValueBridge&lt;ISBN, String&gt;</code>
and transparently use it on a property of type <code>List&lt;ISBN&gt;</code>:
the bridge will simply be applied once per list element
and populate the index field with as many values.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>However, due to these features,
several limitations are imposed on a value bridge
which are not present in a <a href="#binding-propertybridge">property bridge</a> for example:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A value bridge only allows one-to-one mapping: one property to one index field.
A single value bridge cannot populate more than one index field.</p>
</li>
<li>
<p>A value bridge <strong>will not work correctly when applied to a mutable type</strong>.
A value bridge is expected to be applied to "atomic" data, such as a <code>LocalDate</code>;
if it is applied to an entity, for example, extracting data from its properties,
Hibernate Search will not be aware of which properties are used
and will not be able to <a href="#listener-triggered-indexing">detect that reindexing is required</a> when these properties change.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Below is an example of a custom value bridge that converts
a custom <code>ISBN</code> type to its string representation to index it:</p>
</div>
<div id="example-custom-string-bridge" class="exampleblock">
<div class="title">Example 78. Implementing and using a <code>ValueBridge</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="directive">public</span> <span class="type">class</span> <span class="class">ISBNValueBridge</span> <span class="directive">implements</span> ValueBridge&lt;ISBN, <span class="predefined-type">String</span>&gt; { <i class="conum" data-value="1"></i><b>(1)</b>

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="predefined-type">String</span> toIndexedValue(ISBN value, ValueBridgeToIndexedValueContext context) { <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="keyword">return</span> value == <span class="predefined-constant">null</span> ? <span class="predefined-constant">null</span> : value.getStringValue();
    }

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The bridge must implement the <code>ValueBridge</code> interface.
Two generic type arguments must be provided:
the first one is the type of property values (values in the entity model),
and the second one is the type of index fields (values in the document model).</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The <code>toIndexedValue</code> method is the only one that must be implemented: all other methods are optional.
It takes the property value and a context object as parameters,
and is expected to return the corresponding index field value.
It is called when indexing,
but also when parameters to the search DSL <a href="#search-dsl-argument-type">must be transformed</a>.</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="annotation">@Entity</span>
<span class="annotation">@Indexed</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">Book</span> {

    <span class="annotation">@Id</span>
    <span class="annotation">@GeneratedValue</span>
    <span class="directive">private</span> <span class="predefined-type">Integer</span> id;

    <span class="annotation">@Convert</span>(converter = ISBNAttributeConverter.class) <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="annotation">@KeywordField</span>( <i class="conum" data-value="2"></i><b>(2)</b>
            valueBridge = <span class="annotation">@ValueBridgeRef</span>(type = ISBNValueBridge.class), <i class="conum" data-value="3"></i><b>(3)</b>
            normalizer = <span class="string"><span class="delimiter">&quot;</span><span class="content">isbn</span><span class="delimiter">&quot;</span></span> <i class="conum" data-value="4"></i><b>(4)</b>
    )
    <span class="directive">private</span> ISBN isbn;

    <span class="comment">// Getters and setters</span>
    <span class="comment">// ...</span>

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This is unrelated to the value bridge,
but necessary in order for Hibernate ORM to store the data correctly in the database.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Map the property to an index field.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Instruct Hibernate Search to use our custom value bridge.
It is also possible to reference the bridge by its name, in the case of a CDI/Spring bean.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Customize the field as usual.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Here is an example of what an indexed document would look like, with the Elasticsearch backend:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JSON">{
  <span class="key"><span class="delimiter">&quot;</span><span class="content">isbn</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">978-0-58-600835-5</span><span class="delimiter">&quot;</span></span>
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The example above is just a minimal implementations.
A custom value bridge can do more:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>it can <a href="#binding-valuebridge-projection">convert the result of projections back to the property type</a>;</p>
</li>
<li>
<p>it can <a href="#binding-valuebridge-indexnullas">parse the value passed to <code>indexNullAs</code></a>;</p>
</li>
<li>
<p>&#8230;&#8203;</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>See the next sections for more information.</p>
</div>
</div>
<div class="sect3">
<h4 id="binding-valuebridge-type-resolution"><a class="anchor" href="#binding-valuebridge-type-resolution"></a>12.2.2. <a id="mapper-orm-bridge-valuebridge-type-resolution"></a> Type resolution</h4>
<div class="paragraph">
<p>By default, the value bridge&#8217;s property type and index field type are determined automatically,
using reflection to extract the generic type arguments of the <code>ValueBridge</code> interface:
the first argument is the property type while the second argument is the index field type.</p>
</div>
<div class="paragraph">
<p>For example, in <code>public class MyBridge implements ValueBridge&lt;ISBN, String&gt;</code>,
the property type is resolved to <code>ISBN</code> and the index field type is resolved to <code>String</code>:
the bridge will be applied to properties of type <code>ISBN</code>
and will populate an index field of type <code>String</code>.</p>
</div>
<div class="paragraph">
<p>The fact that types are resolved automatically using reflection brings a few limitations.
In particular, it means the generic type arguments cannot be just anything;
as a general rule, you should stick to literal types (<code>MyBridge implements ValueBridge&lt;ISBN, String&gt;</code>)
and avoid generic type parameters and wildcards (<code>MyBridge&lt;T&gt; implements ValueBridge&lt;List&lt;T&gt;, T&gt;</code>).</p>
</div>
<div class="paragraph">
<p>If you need more complex types,
you can bypass the automatic resolution and specify types explicitly
using a <a href="#binding-valuebridge-valuebinder"><code>ValueBinder</code></a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="binding-valuebridge-annotation-compatibility"><a class="anchor" href="#binding-valuebridge-annotation-compatibility"></a>12.2.3. <a id="mapper-orm-bridge-valuebridge-annotation-compatibility"></a> Using value bridges in other <code>@*Field</code> annotations</h4>
<div class="paragraph">
<p>In order to use a custom value bridge with specialized annotations such as <code>@FullTextField</code>,
the bridge must declare a compatible index field type.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>@FullTextField</code> and <code>@KeywordField</code> require an index field type of type <code>String</code> (<code>ValueBridge&lt;Whatever, String&gt;</code>);</p>
</li>
<li>
<p><code>@ScaledNumberField</code> requires an index field type of type <code>BigDecimal</code> (<code>ValueBridge&lt;Whatever, BigDecimal&gt;</code>)
or <code>BigInteger</code> (<code>ValueBridge&lt;Whatever, BigInteger&gt;</code>).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Refer to <a href="#mapping-directfieldmapping-annotations"> Available field annotations</a>
for the specific constraints of each annotation.</p>
</div>
<div class="paragraph">
<p>Attempts to use a bridge that declares an incompatible type will trigger exceptions at bootstrap.</p>
</div>
</div>
<div class="sect3">
<h4 id="binding-valuebridge-projection"><a class="anchor" href="#binding-valuebridge-projection"></a>12.2.4. <a id="mapper-orm-bridge-valuebridge-projection"></a> <a id="section-two-way-bridge"></a> Supporting projections with <code>fromIndexedValue()</code></h4>
<div class="paragraph">
<p>By default, any attempt to project on a field using a custom bridge will result in an exception,
because Hibernate Search doesn&#8217;t know how to convert
the projected values obtained from the index back to the property type.</p>
</div>
<div class="paragraph">
<p>It is possible to <a href="#search-dsl-projected-value-type">disable conversion explicitly</a> to get the raw value from the index,
but another way of solving the problem is to simply implement <code>fromIndexedValue</code> in the custom bridge.
This method will be called whenever a projected value needs to be converted.</p>
</div>
<div class="exampleblock">
<div class="title">Example 79. Implementing <code>fromIndexedValue</code> to convert projected values</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="directive">public</span> <span class="type">class</span> <span class="class">ISBNValueBridge</span> <span class="directive">implements</span> ValueBridge&lt;ISBN, <span class="predefined-type">String</span>&gt; {

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="predefined-type">String</span> toIndexedValue(ISBN value, ValueBridgeToIndexedValueContext context) {
        <span class="keyword">return</span> value == <span class="predefined-constant">null</span> ? <span class="predefined-constant">null</span> : value.getStringValue();
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> ISBN fromIndexedValue(<span class="predefined-type">String</span> value, ValueBridgeFromIndexedValueContext context) {
        <span class="keyword">return</span> value == <span class="predefined-constant">null</span> ? <span class="predefined-constant">null</span> : ISBN.parse( value ); <i class="conum" data-value="1"></i><b>(1)</b>
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Implement <code>fromIndexedValue</code> as necessary.</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="annotation">@Entity</span>
<span class="annotation">@Indexed</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">Book</span> {

    <span class="annotation">@Id</span>
    <span class="annotation">@GeneratedValue</span>
    <span class="directive">private</span> <span class="predefined-type">Integer</span> id;

    <span class="annotation">@Convert</span>(converter = ISBNAttributeConverter.class) <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="annotation">@KeywordField</span>( <i class="conum" data-value="2"></i><b>(2)</b>
            valueBridge = <span class="annotation">@ValueBridgeRef</span>(type = ISBNValueBridge.class), <i class="conum" data-value="3"></i><b>(3)</b>
            normalizer = <span class="string"><span class="delimiter">&quot;</span><span class="content">isbn</span><span class="delimiter">&quot;</span></span>,
            projectable = Projectable.YES <i class="conum" data-value="4"></i><b>(4)</b>
    )
    <span class="directive">private</span> ISBN isbn;

    <span class="comment">// Getters and setters</span>
    <span class="comment">// ...</span>

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This is unrelated to the value bridge,
but necessary in order for Hibernate ORM to store the data correctly in the database.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Map the property to an index field.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Instruct Hibernate Search to use our custom value bridge.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Do not forget to configure the field as projectable.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="binding-valuebridge-indexnullas"><a class="anchor" href="#binding-valuebridge-indexnullas"></a>12.2.5. <a id="mapper-orm-bridge-valuebridge-indexnullas"></a> Supporting <code>indexNullAs</code> with <code>parse()</code></h4>
<div class="paragraph">
<p>By default, the <code>indexNullAs</code> attribute of <code>@*Field</code> annotations cannot be used together with a custom bridge.</p>
</div>
<div class="paragraph">
<p>In order to make it work, the bridge needs to implement the <code>parse</code> method
so that Hibernate Search can convert the string assigned to <code>indexNullAs</code>
to a value of the correct type for the index field.</p>
</div>
<div class="exampleblock">
<div class="title">Example 80. Implementing <code>parse</code> to support <code>indexNullAs</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="directive">public</span> <span class="type">class</span> <span class="class">ISBNValueBridge</span> <span class="directive">implements</span> ValueBridge&lt;ISBN, <span class="predefined-type">String</span>&gt; {

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="predefined-type">String</span> toIndexedValue(ISBN value, ValueBridgeToIndexedValueContext context) {
        <span class="keyword">return</span> value == <span class="predefined-constant">null</span> ? <span class="predefined-constant">null</span> : value.getStringValue();
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="predefined-type">String</span> parse(<span class="predefined-type">String</span> value) {
        <span class="comment">// Just check the string format and return the string</span>
        <span class="keyword">return</span> ISBN.parse( value ).getStringValue(); <i class="conum" data-value="1"></i><b>(1)</b>
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Implement <code>parse</code> as necessary.
The bridge may throw exceptions for invalid strings.</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="annotation">@Entity</span>
<span class="annotation">@Indexed</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">Book</span> {

    <span class="annotation">@Id</span>
    <span class="annotation">@GeneratedValue</span>
    <span class="directive">private</span> <span class="predefined-type">Integer</span> id;

    <span class="annotation">@Convert</span>(converter = ISBNAttributeConverter.class) <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="annotation">@KeywordField</span>( <i class="conum" data-value="2"></i><b>(2)</b>
            valueBridge = <span class="annotation">@ValueBridgeRef</span>(type = ISBNValueBridge.class), <i class="conum" data-value="3"></i><b>(3)</b>
            normalizer = <span class="string"><span class="delimiter">&quot;</span><span class="content">isbn</span><span class="delimiter">&quot;</span></span>,
            indexNullAs = <span class="string"><span class="delimiter">&quot;</span><span class="content">000-0-00-000000-0</span><span class="delimiter">&quot;</span></span> <i class="conum" data-value="4"></i><b>(4)</b>
    )
    <span class="directive">private</span> ISBN isbn;

    <span class="comment">// Getters and setters</span>
    <span class="comment">// ...</span>

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This is unrelated to the value bridge,
but necessary in order for Hibernate ORM to store the data correctly in the database.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Map the property to an index field.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Instruct Hibernate Search to use our custom value bridge.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Set <code>indexNullAs</code> to a valid value.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="binding-valuebridge-iscompatiblewith"><a class="anchor" href="#binding-valuebridge-iscompatiblewith"></a>12.2.6. <a id="mapper-orm-bridge-valuebridge-iscompatiblewith"></a> Compatibility across indexes with <code>isCompatibleWith()</code></h4>
<div class="paragraph">
<p>A value bridges is involved in indexing,
but also in the various search DSLs,
to convert values passed to the DSL to an index field value that the backend will understand.</p>
</div>
<div class="paragraph">
<p>When creating a predicate targeting a single field across multiple indexes,
Hibernate Search will have multiple bridges to choose from: one per index.
Since only one predicate with a single value can be created,
Hibernate Search needs to pick a single bridge.
By default, when a custom bridge is assigned to the field,
Hibernate Search will throw an exception because it cannot decide which bridge to pick.</p>
</div>
<div class="paragraph">
<p>If the bridges assigned to the field in all indexes produce the same result,
it is possible to indicate to Hibernate Search that any bridge will do
by implementing <code>isCompatibleWith</code>.</p>
</div>
<div class="paragraph">
<p>This method accepts another bridge in parameter,
and returns <code>true</code> if that bridge can be expected to always behave the same as <code>this</code>.</p>
</div>
<div class="exampleblock">
<div class="title">Example 81. Implementing <code>isCompatibleWith</code> to support multi-index search</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="directive">public</span> <span class="type">class</span> <span class="class">ISBNValueBridge</span> <span class="directive">implements</span> ValueBridge&lt;ISBN, <span class="predefined-type">String</span>&gt; {

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="predefined-type">String</span> toIndexedValue(ISBN value, ValueBridgeToIndexedValueContext context) {
        <span class="keyword">return</span> value == <span class="predefined-constant">null</span> ? <span class="predefined-constant">null</span> : value.getStringValue();
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">boolean</span> isCompatibleWith(ValueBridge&lt;?, ?&gt; other) { <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="keyword">return</span> getClass().equals( other.getClass() );
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Implement <code>isCompatibleWith</code> as necessary.
Here we just deem any instance of the same class to be compatible.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="binding-valuebridge-valuebinder"><a class="anchor" href="#binding-valuebridge-valuebinder"></a>12.2.7. <a id="mapper-orm-bridge-valuebridge-valuebinder"></a> Configuring the bridge more finely with <code>ValueBinder</code></h4>
<div class="paragraph">
<p>To configure a bridge more finely,
it is possible to implement a value binder that will be executed at bootstrap.
This binder will be able in particular to define a custom index field type.</p>
</div>
<div class="exampleblock">
<div class="title">Example 82. Implementing a <code>ValueBinder</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="directive">public</span> <span class="type">class</span> <span class="class">ISBNValueBinder</span> <span class="directive">implements</span> ValueBinder { <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> bind(ValueBindingContext&lt;?&gt; context) { <i class="conum" data-value="2"></i><b>(2)</b>
        context.bridge( <i class="conum" data-value="3"></i><b>(3)</b>
                ISBN.class, <i class="conum" data-value="4"></i><b>(4)</b>
                <span class="keyword">new</span> ISBNValueBridge(), <i class="conum" data-value="5"></i><b>(5)</b>
                context.typeFactory() <i class="conum" data-value="6"></i><b>(6)</b>
                        .asString() <i class="conum" data-value="7"></i><b>(7)</b>
                        .normalizer( <span class="string"><span class="delimiter">&quot;</span><span class="content">isbn</span><span class="delimiter">&quot;</span></span> ) <i class="conum" data-value="8"></i><b>(8)</b>
        );
    }

    <span class="directive">private</span> <span class="directive">static</span> <span class="type">class</span> <span class="class">ISBNValueBridge</span> <span class="directive">implements</span> ValueBridge&lt;ISBN, <span class="predefined-type">String</span>&gt; {
        <span class="annotation">@Override</span>
        <span class="directive">public</span> <span class="predefined-type">String</span> toIndexedValue(ISBN value, ValueBridgeToIndexedValueContext context) {
            <span class="keyword">return</span> value == <span class="predefined-constant">null</span> ? <span class="predefined-constant">null</span> : value.getStringValue(); <i class="conum" data-value="9"></i><b>(9)</b>
        }
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The binder must implement the <code>ValueBinder</code> interface.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Implement the <code>bind</code> method.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Call <code>context.bridge(&#8230;&#8203;)</code> to define the value bridge to use.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Pass the expected type of property values.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Pass the value bridge instance.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Use the context&#8217;s type factory to create an index field type.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Pick a base type for the index field using an <code>as*()</code> method.</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>Configure the type as necessary.
This configuration will set defaults that are applied for any type using this bridge,
but they can be overridden.
Type configuration is similar to the attributes found in the various <code>@*Field</code> annotations.
See <a href="#binding-index-field-type-dsl"> Defining index field types</a> for more information.</td>
</tr>
<tr>
<td><i class="conum" data-value="9"></i><b>9</b></td>
<td>The value bridge must still be implemented.
<div class="paragraph">
<p>Here the bridge class is nested in the binder class,
because it is more convenient,
but you are obviously free to implement it as you wish:
as a lambda expression, in a separate Java file&#8230;&#8203;</p>
</div></td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="annotation">@Entity</span>
<span class="annotation">@Indexed</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">Book</span> {

    <span class="annotation">@Id</span>
    <span class="annotation">@GeneratedValue</span>
    <span class="directive">private</span> <span class="predefined-type">Integer</span> id;

    <span class="annotation">@Convert</span>(converter = ISBNAttributeConverter.class) <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="annotation">@KeywordField</span>( <i class="conum" data-value="2"></i><b>(2)</b>
            valueBinder = <span class="annotation">@ValueBinderRef</span>(type = ISBNValueBinder.class), <i class="conum" data-value="3"></i><b>(3)</b>
            sortable = Sortable.YES <i class="conum" data-value="4"></i><b>(4)</b>
    )
    <span class="directive">private</span> ISBN isbn;

    <span class="comment">// Getters and setters</span>
    <span class="comment">// ...</span>

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This is unrelated to the value bridge,
but necessary in order for Hibernate ORM to store the data correctly in the database.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Map the property to an index field.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Instruct Hibernate Search to use our custom value binder.
Note the use of <code>valueBinder</code> instead of <code>valueBridge</code>.
It is also possible to reference the binder by its name, in the case of a CDI/Spring bean.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Customize the field as usual.
Configuration set using annotation attributes take precedence
over the index field type configuration set by the value binder.
For example, in this case, the field with be sortable
even if the binder didn&#8217;t define the field as sortable.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>When using a value binder with a specialized <code>@*Field</code> annotation,
the index field type must be compatible with the annotation.</p>
</div>
<div class="paragraph">
<p>For example, <code>@FullTextField</code> will only work if the index field type was created using <code>asString()</code>.</p>
</div>
<div class="paragraph">
<p>These restrictions are similar to those when
assigning a value bridge directly;
see <a href="#binding-valuebridge-annotation-compatibility"> Using value bridges in other <code>@*Field</code> annotations</a>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="binding-valuebridge-parameters"><a class="anchor" href="#binding-valuebridge-parameters"></a>12.2.8. <a id="mapper-orm-bridge-valuebridge-parameters"></a> Passing parameters</h4>
<div class="paragraph">
<p>The value bridges are usually applied with built-in <a href="#mapping-directfieldmapping-annotations"><code>@*Field</code> annotation</a>,
which already accept parameters to configure the field name,
whether the field is sortable, etc.</p>
</div>
<div class="paragraph">
<p>However, these parameters are not passed to the value bridge or value binder.
There are two ways to pass parameters to value bridges:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>One is (mostly) limited to string parameters, but is trivial to implement.</p>
</li>
<li>
<p>The other can allow any type of parameters, but requires you to declare your own annotations.</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="binding-valuebridge-parameters-string"><a class="anchor" href="#binding-valuebridge-parameters-string"></a><a id="mapper-orm-bridge-valuebridge-parameters-string"></a> Simple, string parameters</h5>
<div class="paragraph">
<p>You can define string parameters to the <code>@ValueBinderRef</code> annotation and then use them later in the binder:</p>
</div>
<div class="exampleblock">
<div class="title">Example 83. Passing parameters to a <code>ValueBridge</code> using the <code>@ValueBinderRef</code> annotation</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="directive">public</span> <span class="type">class</span> <span class="class">BooleanAsStringBridge</span> <span class="directive">implements</span> ValueBridge&lt;<span class="predefined-type">Boolean</span>, <span class="predefined-type">String</span>&gt; { <i class="conum" data-value="1"></i><b>(1)</b>

    <span class="directive">private</span> <span class="directive">final</span> <span class="predefined-type">String</span> trueAsString;
    <span class="directive">private</span> <span class="directive">final</span> <span class="predefined-type">String</span> falseAsString;

    <span class="directive">public</span> BooleanAsStringBridge(<span class="predefined-type">String</span> trueAsString, <span class="predefined-type">String</span> falseAsString) { <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="local-variable">this</span>.trueAsString = trueAsString;
        <span class="local-variable">this</span>.falseAsString = falseAsString;
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="predefined-type">String</span> toIndexedValue(<span class="predefined-type">Boolean</span> value, ValueBridgeToIndexedValueContext context) {
        <span class="keyword">if</span> ( value == <span class="predefined-constant">null</span> ) {
            <span class="keyword">return</span> <span class="predefined-constant">null</span>;
        }
        <span class="keyword">return</span> value ? trueAsString : falseAsString;
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Implement a bridge that does not index booleans directly,
but indexes them as strings instead.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The bridge accepts two parameters in its constructors:
the string representing <code>true</code> and the string representing <code>false</code>.</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="directive">public</span> <span class="type">class</span> <span class="class">BooleanAsStringBinder</span> <span class="directive">implements</span> ValueBinder {

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> bind(ValueBindingContext&lt;?&gt; context) {
        <span class="predefined-type">String</span> trueAsString = context.param( <span class="string"><span class="delimiter">&quot;</span><span class="content">trueAsString</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">String</span>.class ); <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="predefined-type">String</span> falseAsString = context.param( <span class="string"><span class="delimiter">&quot;</span><span class="content">falseAsString</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">String</span>.class );

        context.bridge( <span class="predefined-type">Boolean</span>.class, <i class="conum" data-value="2"></i><b>(2)</b>
                <span class="keyword">new</span> BooleanAsStringBridge( trueAsString, falseAsString ) );
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Use the binding context to get the parameter values.
<div class="paragraph">
<p>The <code>param</code> method will throw an exception if the parameter has not been defined.
Alternatively, use <code>paramOptional</code> to get an <code>java.util.Optional</code> that will be empty if the parameter has not been defined.</p>
</div></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Pass them as arguments to the bridge constructor.</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="annotation">@Entity</span>
<span class="annotation">@Indexed</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">Book</span> {

    <span class="annotation">@Id</span>
    <span class="annotation">@GeneratedValue</span>
    <span class="directive">private</span> <span class="predefined-type">Integer</span> id;

    <span class="directive">private</span> <span class="predefined-type">String</span> title;

    <span class="annotation">@GenericField</span>(valueBinder = <span class="annotation">@ValueBinderRef</span>(type = BooleanAsStringBinder.class, <i class="conum" data-value="1"></i><b>(1)</b>
            params = {
                    <span class="annotation">@Param</span>(name = <span class="string"><span class="delimiter">&quot;</span><span class="content">trueAsString</span><span class="delimiter">&quot;</span></span>, value = <span class="string"><span class="delimiter">&quot;</span><span class="content">yes</span><span class="delimiter">&quot;</span></span>),
                    <span class="annotation">@Param</span>(name = <span class="string"><span class="delimiter">&quot;</span><span class="content">falseAsString</span><span class="delimiter">&quot;</span></span>, value = <span class="string"><span class="delimiter">&quot;</span><span class="content">no</span><span class="delimiter">&quot;</span></span>)
            }))
    <span class="directive">private</span> <span class="type">boolean</span> published;

    <span class="annotation">@ElementCollection</span>
    <span class="annotation">@GenericField</span>(valueBinder = <span class="annotation">@ValueBinderRef</span>(type = BooleanAsStringBinder.class, <i class="conum" data-value="2"></i><b>(2)</b>
            params = {
                    <span class="annotation">@Param</span>(name = <span class="string"><span class="delimiter">&quot;</span><span class="content">trueAsString</span><span class="delimiter">&quot;</span></span>, value = <span class="string"><span class="delimiter">&quot;</span><span class="content">passed</span><span class="delimiter">&quot;</span></span>),
                    <span class="annotation">@Param</span>(name = <span class="string"><span class="delimiter">&quot;</span><span class="content">falseAsString</span><span class="delimiter">&quot;</span></span>, value = <span class="string"><span class="delimiter">&quot;</span><span class="content">failed</span><span class="delimiter">&quot;</span></span>)
            }), name = <span class="string"><span class="delimiter">&quot;</span><span class="content">censorshipAssessments_allYears</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">private</span> <span class="predefined-type">Map</span>&lt;Year, <span class="predefined-type">Boolean</span>&gt; censorshipAssessments = <span class="keyword">new</span> <span class="predefined-type">HashMap</span>&lt;&gt;();

    <span class="comment">// Getters and setters</span>
    <span class="comment">// ...</span>

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Define the binder to use on the property,
setting the <code>fieldName</code> parameter.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Because we use a value bridge,
the annotation can be transparently applied to containers.
Here, the bridge will be applied successively to each value in the map.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="binding-valuebridge-parameters-custom-annotation"><a class="anchor" href="#binding-valuebridge-parameters-custom-annotation"></a><a id="mapper-orm-bridge-valuebridge-parameters-custom-annotation"></a> <a id="_parameters_with_custom_annotations"></a> Parameters with custom annotations</h5>
<div class="paragraph">
<p>You can pass parameters of any type to the bridge by defining
a <a href="#mapping-custom-annotations">custom annotation</a> with attributes:</p>
</div>
<div class="exampleblock">
<div class="title">Example 84. Passing parameters to a <code>ValueBridge</code> using a custom annotation</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="directive">public</span> <span class="type">class</span> <span class="class">BooleanAsStringBridge</span> <span class="directive">implements</span> ValueBridge&lt;<span class="predefined-type">Boolean</span>, <span class="predefined-type">String</span>&gt; { <i class="conum" data-value="1"></i><b>(1)</b>

    <span class="directive">private</span> <span class="directive">final</span> <span class="predefined-type">String</span> trueAsString;
    <span class="directive">private</span> <span class="directive">final</span> <span class="predefined-type">String</span> falseAsString;

    <span class="directive">public</span> BooleanAsStringBridge(<span class="predefined-type">String</span> trueAsString, <span class="predefined-type">String</span> falseAsString) { <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="local-variable">this</span>.trueAsString = trueAsString;
        <span class="local-variable">this</span>.falseAsString = falseAsString;
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="predefined-type">String</span> toIndexedValue(<span class="predefined-type">Boolean</span> value, ValueBridgeToIndexedValueContext context) {
        <span class="keyword">if</span> ( value == <span class="predefined-constant">null</span> ) {
            <span class="keyword">return</span> <span class="predefined-constant">null</span>;
        }
        <span class="keyword">return</span> value ? trueAsString : falseAsString;
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Implement a bridge that does not index booleans directly,
but indexes them as strings instead.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The bridge accepts two parameters in its constructors:
the string representing <code>true</code> and the string representing <code>false</code>.</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="annotation">@Retention</span>(<span class="predefined-type">RetentionPolicy</span>.RUNTIME) <i class="conum" data-value="1"></i><b>(1)</b>
<span class="annotation">@Target</span>({ <span class="predefined-type">ElementType</span>.METHOD, <span class="predefined-type">ElementType</span>.FIELD }) <i class="conum" data-value="2"></i><b>(2)</b>
<span class="annotation">@PropertyMapping</span>(processor = <span class="annotation">@PropertyMappingAnnotationProcessorRef</span>( <i class="conum" data-value="3"></i><b>(3)</b>
        type = BooleanAsStringField.Processor.class
))
<span class="annotation">@Documented</span> <i class="conum" data-value="4"></i><b>(4)</b>
<span class="annotation">@Repeatable</span>(BooleanAsStringField.List.class) <i class="conum" data-value="5"></i><b>(5)</b>
<span class="directive">public</span> <span class="annotation">@interface</span> BooleanAsStringField {

    <span class="predefined-type">String</span> trueAsString() <span class="keyword">default</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span>; <i class="conum" data-value="6"></i><b>(6)</b>

    <span class="predefined-type">String</span> falseAsString() <span class="keyword">default</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span>;

    <span class="predefined-type">String</span> name() <span class="keyword">default</span> <span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>; <i class="conum" data-value="7"></i><b>(7)</b>

    ContainerExtraction extraction() <span class="keyword">default</span> <span class="annotation">@ContainerExtraction</span>(); <i class="conum" data-value="7"></i><b>(7)</b>

    <span class="annotation">@Documented</span>
    <span class="annotation">@Target</span>({ <span class="predefined-type">ElementType</span>.METHOD, <span class="predefined-type">ElementType</span>.FIELD })
    <span class="annotation">@Retention</span>(<span class="predefined-type">RetentionPolicy</span>.RUNTIME)
    <span class="annotation">@interface</span> <span class="predefined-type">List</span> {
        BooleanAsStringField<span class="type">[]</span> value();
    }

    <span class="type">class</span> <span class="class">Processor</span> <i class="conum" data-value="8"></i><b>(8)</b>
            <span class="directive">implements</span> PropertyMappingAnnotationProcessor&lt;BooleanAsStringField&gt; { <i class="conum" data-value="9"></i><b>(9)</b>
        <span class="annotation">@Override</span>
        <span class="directive">public</span> <span class="type">void</span> process(PropertyMappingStep mapping, BooleanAsStringField annotation,
                PropertyMappingAnnotationProcessorContext context) {
            BooleanAsStringBridge bridge = <span class="keyword">new</span> BooleanAsStringBridge( <i class="conum" data-value="10"></i><b>(10)</b>
                    annotation.trueAsString(), annotation.falseAsString()
            );
            mapping.genericField( <i class="conum" data-value="11"></i><b>(11)</b>
                        annotation.name().isEmpty() ? <span class="predefined-constant">null</span> : annotation.name()
                    )
                    .valueBridge( bridge ) <i class="conum" data-value="12"></i><b>(12)</b>
                    .extractors( <i class="conum" data-value="13"></i><b>(13)</b>
                            context.toContainerExtractorPath( annotation.extraction() )
                    );
        }
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Define an annotation with <code>RUNTIME</code> retention.
<strong>Any other retention policy will cause the annotation to be ignored by Hibernate Search</strong>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Since we&#8217;re defining a value bridge, allow the annotation
to target either methods (getters) or fields.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Mark this annotation as a property mapping,
and instruct Hibernate Search to apply the given processor whenever it finds this annotation.
It is also possible to reference the processor by its CDI/Spring bean name.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Optionally, mark the annotation as documented,
so that it is included in the javadoc of your entities.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Optionally, mark the annotation as repeatable,
in order to be able to declare multiple fields on the same property.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Define custom attributes to configure the value bridge.
Here we define two strings that the bridge should use to represent the boolean values <code>true</code> and <code>false</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Since we will be using a custom annotation,
and not the built-in <a href="#mapping-directfieldmapping-annotations"><code>@*Field</code> annotation</a>,
the standard parameters that make sense for this bridge need to be declared here, too.</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>Here the processor class is nested in the annotation class,
because it is more convenient,
but you are obviously free to implement it in a separate Java file.</td>
</tr>
<tr>
<td><i class="conum" data-value="9"></i><b>9</b></td>
<td>The processor must implement the <code>PropertyMappingAnnotationProcessor</code> interface,
setting its generic type argument to the type of the corresponding annotation.</td>
</tr>
<tr>
<td><i class="conum" data-value="10"></i><b>10</b></td>
<td>In the <code>process</code> method, instantiate the bridge
and pass the annotation attributes as constructor arguments.</td>
</tr>
<tr>
<td><i class="conum" data-value="11"></i><b>11</b></td>
<td>Declare the field with the configured name (if provided).</td>
</tr>
<tr>
<td><i class="conum" data-value="12"></i><b>12</b></td>
<td>Assign our bridge to the field.
Alternatively, we could assign a value binder instead,
using the <code>valueBinder()</code> method.</td>
</tr>
<tr>
<td><i class="conum" data-value="13"></i><b>13</b></td>
<td>Configure the remaining standard parameters.
Note that the <code>context</code> object passed to the <code>process</code> method
exposes utility methods to convert standard Hibernate Search annotations
to something that can be passed to the mapping
(here, <code>@ContainerExtraction</code> is converted to a container extractor path).</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="annotation">@Entity</span>
<span class="annotation">@Indexed</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">Book</span> {

    <span class="annotation">@Id</span>
    <span class="annotation">@GeneratedValue</span>
    <span class="directive">private</span> <span class="predefined-type">Integer</span> id;

    <span class="directive">private</span> <span class="predefined-type">String</span> title;

    <span class="annotation">@BooleanAsStringField</span>(trueAsString = <span class="string"><span class="delimiter">&quot;</span><span class="content">yes</span><span class="delimiter">&quot;</span></span>, falseAsString = <span class="string"><span class="delimiter">&quot;</span><span class="content">no</span><span class="delimiter">&quot;</span></span>) <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="directive">private</span> <span class="type">boolean</span> published;

    <span class="annotation">@ElementCollection</span>
    <span class="annotation">@BooleanAsStringField</span>( <i class="conum" data-value="2"></i><b>(2)</b>
            name = <span class="string"><span class="delimiter">&quot;</span><span class="content">censorshipAssessments_allYears</span><span class="delimiter">&quot;</span></span>,
            trueAsString = <span class="string"><span class="delimiter">&quot;</span><span class="content">passed</span><span class="delimiter">&quot;</span></span>, falseAsString = <span class="string"><span class="delimiter">&quot;</span><span class="content">failed</span><span class="delimiter">&quot;</span></span>
    )
    <span class="directive">private</span> <span class="predefined-type">Map</span>&lt;Year, <span class="predefined-type">Boolean</span>&gt; censorshipAssessments = <span class="keyword">new</span> <span class="predefined-type">HashMap</span>&lt;&gt;();

    <span class="comment">// Getters and setters</span>
    <span class="comment">// ...</span>

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Apply the bridge using its custom annotation,
setting the parameters.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Because we use a value bridge,
the annotation can be transparently applied to containers.
Here, the bridge will be applied successively to each value in the map.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="binding-valuebridge-access-orm"><a class="anchor" href="#binding-valuebridge-access-orm"></a>12.2.9. <a id="mapper-orm-bridge-valuebridge-access-orm"></a> Accessing the ORM session or session factory from the bridge</h4>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This feature is only available with the <a href="#mapper-orm">Hibernate ORM integration</a>.</p>
</div>
<div class="paragraph">
<p>It <strong>cannot</strong> be used with the <a href="#mapper-pojo-standalone">Standalone POJO Mapper</a> in particular.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Contexts passed to the bridge methods can be used to retrieve the Hibernate ORM session or session factory.</p>
</div>
<div class="exampleblock">
<div class="title">Example 85. Retrieving the ORM session or session factory from a <code>ValueBridge</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="directive">public</span> <span class="type">class</span> <span class="class">MyDataValueBridge</span> <span class="directive">implements</span> ValueBridge&lt;MyData, <span class="predefined-type">String</span>&gt; {

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="predefined-type">String</span> toIndexedValue(MyData value, ValueBridgeToIndexedValueContext context) {
        SessionFactory sessionFactory = context.extension( HibernateOrmExtension.get() ) <i class="conum" data-value="1"></i><b>(1)</b>
                .sessionFactory(); <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="comment">// ... do something with the factory ...</span>
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> MyData fromIndexedValue(<span class="predefined-type">String</span> value, ValueBridgeFromIndexedValueContext context) {
        Session session = context.extension( HibernateOrmExtension.get() ) <i class="conum" data-value="3"></i><b>(3)</b>
                .session(); <i class="conum" data-value="4"></i><b>(4)</b>
        <span class="comment">// ... do something with the session ...</span>
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Apply an extension to the context to access content specific to Hibernate ORM.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Retrieve the <code>SessionFactory</code> from the extended context.
The <code>Session</code> is not available here.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Apply an extension to the context to access content specific to Hibernate ORM.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Retrieve the <code>Session</code> from the extended context.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="binding-valuebridge-injection"><a class="anchor" href="#binding-valuebridge-injection"></a>12.2.10. <a id="mapper-orm-bridge-valuebridge-injection"></a> Injecting beans into the value bridge or value binder</h4>
<div class="paragraph">
<p>With <a href="#configuration-bean-frameworks">compatible frameworks</a>,
Hibernate Search supports injecting beans into both the <code>ValueBridge</code> and the <code>ValueBinder</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This only applies to beans instantiated
through Hibernate Search&#8217;s <a href="#configuration-bean-resolution">bean resolution</a>.
As a rule of thumb, if you need to call <code>new MyBridge()</code> explicitly at some point,
the bridge won&#8217;t get auto-magically injected.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The context passed to the value binder&#8217;s <code>bind</code> method
also exposes a <code>beanResolver()</code> method to access the bean resolver and instantiate beans explicitly.</p>
</div>
<div class="paragraph">
<p>See <a href="#configuration-bean-injection"> Bean injection</a> for more details.</p>
</div>
</div>
<div class="sect3">
<h4 id="binding-valuebridge-programmatic"><a class="anchor" href="#binding-valuebridge-programmatic"></a>12.2.11. <a id="mapper-orm-bridge-valuebridge-programmatic"></a> Programmatic mapping</h4>
<div class="paragraph">
<p>You can apply a value bridge through the <a href="#mapping-programmatic">programmatic mapping</a> too.
Just pass an instance of the bridge.</p>
</div>
<div class="exampleblock">
<div class="title">Example 86. Applying a <code>ValueBridge</code> with <code>.valueBridge(&#8230;&#8203;)</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">TypeMappingStep bookMapping = mapping.type( <span class="predefined-type">Book</span>.class );
bookMapping.indexed();
bookMapping.property( <span class="string"><span class="delimiter">&quot;</span><span class="content">isbn</span><span class="delimiter">&quot;</span></span> )
        .keywordField().valueBridge( <span class="keyword">new</span> ISBNValueBridge() );</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Similarly, you can pass a binder instance.
You can pass arguments either through the binder&#8217;s constructor or through setters.</p>
</div>
<div class="exampleblock">
<div class="title">Example 87. Applying a <code>ValueBinder</code> with <code>.valueBinder(&#8230;&#8203;)</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">TypeMappingStep bookMapping = mapping.type( <span class="predefined-type">Book</span>.class );
bookMapping.indexed();
bookMapping.property( <span class="string"><span class="delimiter">&quot;</span><span class="content">isbn</span><span class="delimiter">&quot;</span></span> )
        .genericField()
                .valueBinder( <span class="keyword">new</span> ISBNValueBinder() )
                .sortable( Sortable.YES );</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="binding-valuebridge-incubating"><a class="anchor" href="#binding-valuebridge-incubating"></a>12.2.12. <a id="mapper-orm-bridge-valuebridge-incubating"></a> Incubating features</h4>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Features detailed below are <em>incubating</em>: they are still under active development.</p>
</div>
<div class="paragraph">
<p>The usual <a href="https://hibernate.org/community/compatibility-policy/">compatibility policy</a> does not apply:
the contract of incubating elements (e.g. types, methods, configuration properties, etc.)
may be altered in a backward-incompatible way&#8201;&#8212;&#8201;or even removed&#8201;&#8212;&#8201;in subsequent releases.</p>
</div>
<div class="paragraph">
<p>You are encouraged to use incubating features so the development team can get feedback and improve them,
but you should be prepared to update code which relies on them as needed.</p>
</div>
</td>
</tr>
</table>
</div>
<div id="_type_aware_bridge" class="paragraph">
<p>The context passed to the value binder&#8217;s <code>bind</code> method
exposes a <code>bridgedElement()</code> method that gives access to metadata about the value being bound,
in particular its type.</p>
</div>
<div class="paragraph">
<p>See the javadoc for more information.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="binding-propertybridge"><a class="anchor" href="#binding-propertybridge"></a>12.3. <a id="mapper-orm-bridge-propertybridge"></a> <a id="section-field-bridge"></a> Property bridge</h3>
<div class="sect3">
<h4 id="binding-propertybridge-basics"><a class="anchor" href="#binding-propertybridge-basics"></a>12.3.1. <a id="mapper-orm-bridge-propertybridge-basics"></a> Basics</h4>
<div class="paragraph">
<p>A property bridge, like a <a href="#binding-valuebridge">value bridge</a>,
is a pluggable component that implements
the mapping of a property to one or more index fields.
It is applied to a property with the <code>@PropertyBinding</code> annotation
or with a <a href="#mapping-custom-annotations">custom annotation</a>.</p>
</div>
<div class="paragraph">
<p>Compared to the value bridge, the property bridge is more complex to implement,
but covers a broader range of use cases:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A property bridge can map a single property to more than one index field.</p>
</li>
<li>
<p>A property bridge can work correctly when applied to a mutable type,
provided it is implemented correctly.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>However, due to its rather flexible nature,
the property bridge does not transparently provide all the features
that come for free with a value bridge.
They can be supported, but have to be implemented manually.
This includes in particular container extractors,
which cannot be combined with a property bridge:
the property bridge must extract container values explicitly.</p>
</div>
<div class="paragraph">
<p>Implementing a property bridge requires two components:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>A custom implementation of <code>PropertyBinder</code>, to bind the bridge to a property at bootstrap.
This involves declaring the parts of the property that will be used,
declaring the index fields that will be populated along with their type,
and instantiating the property bridge.</p>
</li>
<li>
<p>A custom implementation of <code>PropertyBridge</code>, to perform the conversion at runtime.
This involves extracting data from the property, transforming it if necessary,
and pushing it to index fields.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Below is an example of a custom property bridge that maps
a list of invoice line items
to several fields summarizing the invoice.</p>
</div>
<div id="example-field-bridge" class="exampleblock">
<div class="title">Example 88. Implementing and using a <code>PropertyBridge</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="directive">public</span> <span class="type">class</span> <span class="class">InvoiceLineItemsSummaryBinder</span> <span class="directive">implements</span> PropertyBinder { <i class="conum" data-value="1"></i><b>(1)</b>

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> bind(PropertyBindingContext context) { <i class="conum" data-value="2"></i><b>(2)</b>
        context.dependencies() <i class="conum" data-value="3"></i><b>(3)</b>
                .use( <span class="string"><span class="delimiter">&quot;</span><span class="content">category</span><span class="delimiter">&quot;</span></span> )
                .use( <span class="string"><span class="delimiter">&quot;</span><span class="content">amount</span><span class="delimiter">&quot;</span></span> );

        IndexSchemaObjectField summaryField = context.indexSchemaElement() <i class="conum" data-value="4"></i><b>(4)</b>
                .objectField( <span class="string"><span class="delimiter">&quot;</span><span class="content">summary</span><span class="delimiter">&quot;</span></span> );

        IndexFieldType&lt;<span class="predefined-type">BigDecimal</span>&gt; amountFieldType = context.typeFactory() <i class="conum" data-value="5"></i><b>(5)</b>
                .asBigDecimal().decimalScale( <span class="integer">2</span> ).toIndexFieldType();

        context.bridge( <i class="conum" data-value="6"></i><b>(6)</b>
                <span class="predefined-type">List</span>.class, <i class="conum" data-value="7"></i><b>(7)</b>
                <span class="keyword">new</span> Bridge( <i class="conum" data-value="8"></i><b>(8)</b>
                        summaryField.toReference(), <i class="conum" data-value="9"></i><b>(9)</b>
                        summaryField.field( <span class="string"><span class="delimiter">&quot;</span><span class="content">total</span><span class="delimiter">&quot;</span></span>, amountFieldType ).toReference(), <i class="conum" data-value="10"></i><b>(10)</b>
                        summaryField.field( <span class="string"><span class="delimiter">&quot;</span><span class="content">books</span><span class="delimiter">&quot;</span></span>, amountFieldType ).toReference(), <i class="conum" data-value="10"></i><b>(10)</b>
                        summaryField.field( <span class="string"><span class="delimiter">&quot;</span><span class="content">shipping</span><span class="delimiter">&quot;</span></span>, amountFieldType ).toReference() <i class="conum" data-value="10"></i><b>(10)</b>
                )
        );
    }

    <span class="comment">// ... class continues below</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The binder must implement the <code>PropertyBinder</code> interface.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Implement the <code>bind</code> method in the binder.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Declare the dependencies of the bridge,
i.e. the parts of the property value that the bridge will actually use.
This is <strong>absolutely necessary</strong> in order for Hibernate Search to correctly trigger reindexing
when these parts are modified.
See <a href="#binding-bridgedelement-dependencies"> Declaring dependencies to bridged elements</a>
for more information about declaring dependencies.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Declare the fields that are populated by this bridge.
In this case we&#8217;re creating a <code>summary</code> object field,
which will have multiple subfields (see below).
See <a href="#binding-index-field-dsl"> Declaring and writing to index fields</a>
for more information about declaring index fields.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Declare the type of the subfields.
We&#8217;re going to index monetary amounts,
so we will use a <code>BigDecimal</code> type with two digits after the decimal point.
See <a href="#binding-index-field-type-dsl"> Defining index field types</a>
for more information about declaring index field types.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Call <code>context.bridge(&#8230;&#8203;)</code> to define the property bridge to use.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Pass the expected type of property.</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>Pass the property bridge instance.</td>
</tr>
<tr>
<td><i class="conum" data-value="9"></i><b>9</b></td>
<td>Pass a reference to the <code>summary</code> object field to the bridge.</td>
</tr>
<tr>
<td><i class="conum" data-value="10"></i><b>10</b></td>
<td>Create a subfield for the <code>total</code> amount of the invoice,
a subfield for the subtotal for <code>books</code>,
and a subfield for the subtotal for <code>shipping</code>.
Pass references to these fields to the bridge.</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">    <span class="comment">// ... class InvoiceLineItemsSummaryBinder (continued)</span>

    <span class="annotation">@SuppressWarnings</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">rawtypes</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">private</span> <span class="directive">static</span> <span class="type">class</span> <span class="class">Bridge</span> <i class="conum" data-value="1"></i><b>(1)</b>
            <span class="directive">implements</span> PropertyBridge&lt;<span class="predefined-type">List</span>&gt; { <i class="conum" data-value="2"></i><b>(2)</b>

        <span class="directive">private</span> <span class="directive">final</span> IndexObjectFieldReference summaryField;
        <span class="directive">private</span> <span class="directive">final</span> IndexFieldReference&lt;<span class="predefined-type">BigDecimal</span>&gt; totalField;
        <span class="directive">private</span> <span class="directive">final</span> IndexFieldReference&lt;<span class="predefined-type">BigDecimal</span>&gt; booksField;
        <span class="directive">private</span> <span class="directive">final</span> IndexFieldReference&lt;<span class="predefined-type">BigDecimal</span>&gt; shippingField;

        <span class="directive">private</span> Bridge(IndexObjectFieldReference summaryField, <i class="conum" data-value="3"></i><b>(3)</b>
                IndexFieldReference&lt;<span class="predefined-type">BigDecimal</span>&gt; totalField,
                IndexFieldReference&lt;<span class="predefined-type">BigDecimal</span>&gt; booksField,
                IndexFieldReference&lt;<span class="predefined-type">BigDecimal</span>&gt; shippingField) {
            <span class="local-variable">this</span>.summaryField = summaryField;
            <span class="local-variable">this</span>.totalField = totalField;
            <span class="local-variable">this</span>.booksField = booksField;
            <span class="local-variable">this</span>.shippingField = shippingField;
        }

        <span class="annotation">@Override</span>
        <span class="directive">public</span> <span class="type">void</span> write(DocumentElement target, <span class="predefined-type">List</span> bridgedElement, PropertyBridgeWriteContext context) { <i class="conum" data-value="4"></i><b>(4)</b>
            <span class="annotation">@SuppressWarnings</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">unchecked</span><span class="delimiter">&quot;</span></span>)
            <span class="predefined-type">List</span>&lt;InvoiceLineItem&gt; lineItems = (<span class="predefined-type">List</span>&lt;InvoiceLineItem&gt;) bridgedElement;

            <span class="predefined-type">BigDecimal</span> total = <span class="predefined-type">BigDecimal</span>.ZERO;
            <span class="predefined-type">BigDecimal</span> books = <span class="predefined-type">BigDecimal</span>.ZERO;
            <span class="predefined-type">BigDecimal</span> shipping = <span class="predefined-type">BigDecimal</span>.ZERO;
            <span class="keyword">for</span> ( InvoiceLineItem lineItem : lineItems ) { <i class="conum" data-value="5"></i><b>(5)</b>
                <span class="predefined-type">BigDecimal</span> amount = lineItem.getAmount();
                total = total.add( amount );
                <span class="keyword">switch</span> ( lineItem.getCategory() ) {
                    <span class="keyword">case</span> BOOK:
                        books = books.add( amount );
                        <span class="keyword">break</span>;
                    <span class="keyword">case</span> SHIPPING:
                        shipping = shipping.add( amount );
                        <span class="keyword">break</span>;
                }
            }

            DocumentElement summary = target.addObject( <span class="local-variable">this</span>.summaryField ); <i class="conum" data-value="6"></i><b>(6)</b>
            summary.addValue( <span class="local-variable">this</span>.totalField, total ); <i class="conum" data-value="7"></i><b>(7)</b>
            summary.addValue( <span class="local-variable">this</span>.booksField, books ); <i class="conum" data-value="7"></i><b>(7)</b>
            summary.addValue( <span class="local-variable">this</span>.shippingField, shipping ); <i class="conum" data-value="7"></i><b>(7)</b>
        }
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Here the bridge class is nested in the binder class,
because it is more convenient,
but you are obviously free to implement it as you wish:
as a lambda expression, in a separate Java file&#8230;&#8203;</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The bridge must implement the <code>PropertyBridge</code> interface.
One generic type argument must be provided: the type of the property,
i.e. the type of the "bridged element".</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The bridge stores references to the fields&#8201;&#8212;&#8201;it will need them when indexing.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Implement the <code>write</code> method in the bridge.
This method is called on indexing.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Extract data from the bridged element,
and optionally transform it.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Add an object to the <code>summary</code> object field.
Note the <code>summary</code> field was declared at the root,
so we call <code>addObject</code> directly on the <code>target</code> argument.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Add a value to each of the <code>summary.total</code>, <code>summary.books</code>
and <code>summary.shipping</code> fields.
Note the fields were declared as subfields of <code>summary</code>,
so we call <code>addValue</code> on <code>summaryValue</code> instead of <code>target</code>.</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="annotation">@Entity</span>
<span class="annotation">@Indexed</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">Invoice</span> {

    <span class="annotation">@Id</span>
    <span class="annotation">@GeneratedValue</span>
    <span class="directive">private</span> <span class="predefined-type">Integer</span> id;

    <span class="annotation">@ElementCollection</span>
    <span class="annotation">@OrderColumn</span>
    <span class="annotation">@PropertyBinding</span>(binder = <span class="annotation">@PropertyBinderRef</span>(type = InvoiceLineItemsSummaryBinder.class)) <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="directive">private</span> <span class="predefined-type">List</span>&lt;InvoiceLineItem&gt; lineItems = <span class="keyword">new</span> <span class="predefined-type">ArrayList</span>&lt;&gt;();

    <span class="comment">// Getters and setters</span>
    <span class="comment">// ...</span>

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Apply the bridge using the <code>@PropertyBinding</code> annotation.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Here is an example of what an indexed document would look like, with the Elasticsearch backend:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JSON">{
  <span class="key"><span class="delimiter">&quot;</span><span class="content">summary</span><span class="delimiter">&quot;</span></span>: {
    <span class="key"><span class="delimiter">&quot;</span><span class="content">total</span><span class="delimiter">&quot;</span></span>: <span class="float">38.96</span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">books</span><span class="delimiter">&quot;</span></span>: <span class="float">30.97</span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">shipping</span><span class="delimiter">&quot;</span></span>: <span class="float">7.99</span>
  }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="binding-propertybridge-parameters"><a class="anchor" href="#binding-propertybridge-parameters"></a>12.3.2. <a id="mapper-orm-bridge-propertybridge-parameters"></a> <a id="_parameterized_bridge"></a> Passing parameters</h4>
<div class="paragraph">
<p>There are two ways to pass parameters to property bridges:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>One is (mostly) limited to string parameters, but is trivial to implement.</p>
</li>
<li>
<p>The other can allow any type of parameters, but requires you to declare your own annotations.</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="binding-propertybridge-parameters-string"><a class="anchor" href="#binding-propertybridge-parameters-string"></a><a id="mapper-orm-bridge-propertybridge-parameters-string"></a> Simple, string parameters</h5>
<div class="paragraph">
<p>You can pass string parameters to the <code>@PropertyBinderRef</code> annotation and then use them later in the binder:</p>
</div>
<div id="example-passing-bridge-parameters" class="exampleblock">
<div class="title">Example 89. Passing parameters to a <code>PropertyBinder</code> using the <code>@PropertyBinderRef</code> annotation</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="directive">public</span> <span class="type">class</span> <span class="class">InvoiceLineItemsSummaryBinder</span> <span class="directive">implements</span> PropertyBinder {

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> bind(PropertyBindingContext context) {
        context.dependencies()
                .use( <span class="string"><span class="delimiter">&quot;</span><span class="content">category</span><span class="delimiter">&quot;</span></span> )
                .use( <span class="string"><span class="delimiter">&quot;</span><span class="content">amount</span><span class="delimiter">&quot;</span></span> );

        <span class="predefined-type">String</span> fieldName = context.param( <span class="string"><span class="delimiter">&quot;</span><span class="content">fieldName</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">String</span>.class ); <i class="conum" data-value="1"></i><b>(1)</b>
        IndexSchemaObjectField summaryField = context.indexSchemaElement()
                .objectField( fieldName ); <i class="conum" data-value="2"></i><b>(2)</b>

        IndexFieldType&lt;<span class="predefined-type">BigDecimal</span>&gt; amountFieldType = context.typeFactory()
                .asBigDecimal().decimalScale( <span class="integer">2</span> ).toIndexFieldType();

        context.bridge( <span class="predefined-type">List</span>.class, <span class="keyword">new</span> Bridge(
                summaryField.toReference(),
                summaryField.field( <span class="string"><span class="delimiter">&quot;</span><span class="content">total</span><span class="delimiter">&quot;</span></span>, amountFieldType ).toReference(),
                summaryField.field( <span class="string"><span class="delimiter">&quot;</span><span class="content">books</span><span class="delimiter">&quot;</span></span>, amountFieldType ).toReference(),
                summaryField.field( <span class="string"><span class="delimiter">&quot;</span><span class="content">shipping</span><span class="delimiter">&quot;</span></span>, amountFieldType ).toReference()
        ) );
    }

    <span class="annotation">@SuppressWarnings</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">rawtypes</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">private</span> <span class="directive">static</span> <span class="type">class</span> <span class="class">Bridge</span> <span class="directive">implements</span> PropertyBridge&lt;<span class="predefined-type">List</span>&gt; {

        <span class="comment">/* ... same implementation as before ... */</span>

    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Use the binding context to get the parameter value.
<div class="paragraph">
<p>The <code>param</code> method will throw an exception if the parameter has not been defined.
Alternatively, use <code>paramOptional</code> to get an <code>java.util.Optional</code> that will be empty if the parameter has not been defined.</p>
</div></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>In the <code>bind</code> method, use the value of parameters.
Here use the <code>fieldName</code> parameter to set the field name,
but we could pass parameters for any purpose:
defining the field as sortable,
defining a normalizer,
&#8230;&#8203;</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="annotation">@Entity</span>
<span class="annotation">@Indexed</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">Invoice</span> {

    <span class="annotation">@Id</span>
    <span class="annotation">@GeneratedValue</span>
    <span class="directive">private</span> <span class="predefined-type">Integer</span> id;

    <span class="annotation">@ElementCollection</span>
    <span class="annotation">@OrderColumn</span>
    <span class="annotation">@PropertyBinding</span>(binder = <span class="annotation">@PropertyBinderRef</span>( <i class="conum" data-value="1"></i><b>(1)</b>
            type = InvoiceLineItemsSummaryBinder.class,
            params = <span class="annotation">@Param</span>(name = <span class="string"><span class="delimiter">&quot;</span><span class="content">fieldName</span><span class="delimiter">&quot;</span></span>, value = <span class="string"><span class="delimiter">&quot;</span><span class="content">itemSummary</span><span class="delimiter">&quot;</span></span>)))
    <span class="directive">private</span> <span class="predefined-type">List</span>&lt;InvoiceLineItem&gt; lineItems = <span class="keyword">new</span> <span class="predefined-type">ArrayList</span>&lt;&gt;();

    <span class="comment">// Getters and setters</span>
    <span class="comment">// ...</span>

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Define the binder to use on the property,
setting the <code>fieldName</code> parameter.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="binding-propertybridge-parameters-custom-annotation"><a class="anchor" href="#binding-propertybridge-parameters-custom-annotation"></a><a id="mapper-orm-bridge-propertybridge-parameters-custom-annotation"></a> Parameters with custom annotations</h5>
<div class="paragraph">
<p>You can pass parameters of any type to the bridge by defining
a <a href="#mapping-custom-annotations">custom annotation</a> with attributes:</p>
</div>
<div class="exampleblock">
<div class="title">Example 90. Passing parameters to a <code>PropertyBinder</code> using a custom annotation</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="annotation">@Retention</span>(<span class="predefined-type">RetentionPolicy</span>.RUNTIME) <i class="conum" data-value="1"></i><b>(1)</b>
<span class="annotation">@Target</span>({ <span class="predefined-type">ElementType</span>.METHOD, <span class="predefined-type">ElementType</span>.FIELD }) <i class="conum" data-value="2"></i><b>(2)</b>
<span class="annotation">@PropertyMapping</span>(processor = <span class="annotation">@PropertyMappingAnnotationProcessorRef</span>( <i class="conum" data-value="3"></i><b>(3)</b>
        type = InvoiceLineItemsSummaryBinding.Processor.class
))
<span class="annotation">@Documented</span> <i class="conum" data-value="4"></i><b>(4)</b>
<span class="directive">public</span> <span class="annotation">@interface</span> InvoiceLineItemsSummaryBinding {

    <span class="predefined-type">String</span> fieldName() <span class="keyword">default</span> <span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>; <i class="conum" data-value="5"></i><b>(5)</b>

    <span class="type">class</span> <span class="class">Processor</span> <i class="conum" data-value="6"></i><b>(6)</b>
            <span class="directive">implements</span> PropertyMappingAnnotationProcessor&lt;InvoiceLineItemsSummaryBinding&gt; { <i class="conum" data-value="7"></i><b>(7)</b>
        <span class="annotation">@Override</span>
        <span class="directive">public</span> <span class="type">void</span> process(PropertyMappingStep mapping,
                InvoiceLineItemsSummaryBinding annotation,
                PropertyMappingAnnotationProcessorContext context) {
            InvoiceLineItemsSummaryBinder binder = <span class="keyword">new</span> InvoiceLineItemsSummaryBinder(); <i class="conum" data-value="8"></i><b>(8)</b>
            <span class="keyword">if</span> ( !annotation.fieldName().isEmpty() ) { <i class="conum" data-value="9"></i><b>(9)</b>
                binder.fieldName( annotation.fieldName() );
            }
            mapping.binder( binder ); <i class="conum" data-value="10"></i><b>(10)</b>
        }
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Define an annotation with <code>RUNTIME</code> retention.
<strong>Any other retention policy will cause the annotation to be ignored by Hibernate Search</strong>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Since we&#8217;re defining a property bridge, allow the annotation
to target either methods (getters) or fields.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Mark this annotation as a property mapping,
and instruct Hibernate Search to apply the given processor whenever it finds this annotation.
It is also possible to reference the processor by its CDI/Spring bean name.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Optionally, mark the annotation as documented,
so that it is included in the javadoc of your entities.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Define an attribute of type <code>String</code> to specify the field name.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Here the processor class is nested in the annotation class,
because it is more convenient,
but you are obviously free to implement it in a separate Java file.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>The processor must implement the <code>PropertyMappingAnnotationProcessor</code> interface,
setting its generic type argument to the type of the corresponding annotation.</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>In the annotation processor, instantiate the binder.</td>
</tr>
<tr>
<td><i class="conum" data-value="9"></i><b>9</b></td>
<td>Process the annotation attributes and pass the data to the binder.
<div class="paragraph">
<p>Here we&#8217;re using a setter, but passing the data through the constructor would work, too.</p>
</div></td>
</tr>
<tr>
<td><i class="conum" data-value="10"></i><b>10</b></td>
<td>Apply the binder to the property.</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="directive">public</span> <span class="type">class</span> <span class="class">InvoiceLineItemsSummaryBinder</span> <span class="directive">implements</span> PropertyBinder {

    <span class="directive">private</span> <span class="predefined-type">String</span> fieldName = <span class="string"><span class="delimiter">&quot;</span><span class="content">summary</span><span class="delimiter">&quot;</span></span>;

    <span class="directive">public</span> InvoiceLineItemsSummaryBinder fieldName(<span class="predefined-type">String</span> fieldName) { <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="local-variable">this</span>.fieldName = fieldName;
        <span class="keyword">return</span> <span class="local-variable">this</span>;
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> bind(PropertyBindingContext context) {
        context.dependencies()
                .use( <span class="string"><span class="delimiter">&quot;</span><span class="content">category</span><span class="delimiter">&quot;</span></span> )
                .use( <span class="string"><span class="delimiter">&quot;</span><span class="content">amount</span><span class="delimiter">&quot;</span></span> );

        IndexSchemaObjectField summaryField = context.indexSchemaElement()
                .objectField( <span class="local-variable">this</span>.fieldName ); <i class="conum" data-value="2"></i><b>(2)</b>

        IndexFieldType&lt;<span class="predefined-type">BigDecimal</span>&gt; amountFieldType = context.typeFactory()
                .asBigDecimal().decimalScale( <span class="integer">2</span> ).toIndexFieldType();

        context.bridge( <span class="predefined-type">List</span>.class, <span class="keyword">new</span> Bridge(
                summaryField.toReference(),
                summaryField.field( <span class="string"><span class="delimiter">&quot;</span><span class="content">total</span><span class="delimiter">&quot;</span></span>, amountFieldType ).toReference(),
                summaryField.field( <span class="string"><span class="delimiter">&quot;</span><span class="content">books</span><span class="delimiter">&quot;</span></span>, amountFieldType ).toReference(),
                summaryField.field( <span class="string"><span class="delimiter">&quot;</span><span class="content">shipping</span><span class="delimiter">&quot;</span></span>, amountFieldType ).toReference()
        ) );
    }

    <span class="annotation">@SuppressWarnings</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">rawtypes</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">private</span> <span class="directive">static</span> <span class="type">class</span> <span class="class">Bridge</span> <span class="directive">implements</span> PropertyBridge&lt;<span class="predefined-type">List</span>&gt; {

        <span class="comment">/* ... same implementation as before ... */</span>

    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Implement setters in the binder.
Alternatively, we could expose a parameterized constructor.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>In the <code>bind</code> method, use the value of parameters.
Here use the <code>fieldName</code> parameter to set the field name,
but we could pass parameters for any purpose:
defining the field as sortable,
defining a normalizer,
&#8230;&#8203;</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="annotation">@Entity</span>
<span class="annotation">@Indexed</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">Invoice</span> {

    <span class="annotation">@Id</span>
    <span class="annotation">@GeneratedValue</span>
    <span class="directive">private</span> <span class="predefined-type">Integer</span> id;

    <span class="annotation">@ElementCollection</span>
    <span class="annotation">@OrderColumn</span>
    <span class="annotation">@InvoiceLineItemsSummaryBinding</span>( <i class="conum" data-value="1"></i><b>(1)</b>
            fieldName = <span class="string"><span class="delimiter">&quot;</span><span class="content">itemSummary</span><span class="delimiter">&quot;</span></span>
    )
    <span class="directive">private</span> <span class="predefined-type">List</span>&lt;InvoiceLineItem&gt; lineItems = <span class="keyword">new</span> <span class="predefined-type">ArrayList</span>&lt;&gt;();

    <span class="comment">// Getters and setters</span>
    <span class="comment">// ...</span>

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Apply the bridge using its custom annotation,
setting the <code>fieldName</code> parameter.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="binding-propertybridge-access-orm"><a class="anchor" href="#binding-propertybridge-access-orm"></a>12.3.3. <a id="mapper-orm-bridge-propertybridge-parameters-access-orm"></a> Accessing the ORM session from the bridge</h4>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This feature is only available with the <a href="#mapper-orm">Hibernate ORM integration</a>.</p>
</div>
<div class="paragraph">
<p>It <strong>cannot</strong> be used with the <a href="#mapper-pojo-standalone">Standalone POJO Mapper</a> in particular.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Contexts passed to the bridge methods can be used to retrieve the Hibernate ORM session.</p>
</div>
<div class="exampleblock">
<div class="title">Example 91. Retrieving the ORM session from a <code>PropertyBridge</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="directive">private</span> <span class="directive">static</span> <span class="type">class</span> <span class="class">Bridge</span> <span class="directive">implements</span> PropertyBridge&lt;<span class="predefined-type">Object</span>&gt; {

    <span class="directive">private</span> <span class="directive">final</span> IndexFieldReference&lt;<span class="predefined-type">String</span>&gt; field;

    <span class="directive">private</span> Bridge(IndexFieldReference&lt;<span class="predefined-type">String</span>&gt; field) {
        <span class="local-variable">this</span>.field = field;
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> write(DocumentElement target, <span class="predefined-type">Object</span> bridgedElement, PropertyBridgeWriteContext context) {
        Session session = context.extension( HibernateOrmExtension.get() ) <i class="conum" data-value="1"></i><b>(1)</b>
                .session(); <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="comment">// ... do something with the session ...</span>
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Apply an extension to the context to access content specific to Hibernate ORM.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Retrieve the <code>Session</code> from the extended context.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="binding-propertybridge-injecting-beans"><a class="anchor" href="#binding-propertybridge-injecting-beans"></a>12.3.4. <a id="mapper-orm-bridge-propertybridge-parameters-injecting-beans"></a> Injecting beans into the binder</h4>
<div class="paragraph">
<p>With <a href="#configuration-bean-frameworks">compatible frameworks</a>,
Hibernate Search supports injecting beans into:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the <code>PropertyMappingAnnotationProcessor</code> if you use <a href="#binding-propertybridge-parameters-custom-annotation">custom annotations</a>.</p>
</li>
<li>
<p>the <code>PropertyBinder</code> if you use the <a href="#binding-propertybridge-basics"><code>@PropertyBinding</code> annotation</a>.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This only applies to beans instantiated
through Hibernate Search&#8217;s <a href="#configuration-bean-resolution">bean resolution</a>.
As a rule of thumb, if you need to call <code>new MyBinder()</code> explicitly at some point,
the binder won&#8217;t get auto-magically injected.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The context passed to the property binder&#8217;s <code>bind</code> method
also exposes a <code>beanResolver()</code> method to access the bean resolver and instantiate beans explicitly.</p>
</div>
<div class="paragraph">
<p>See <a href="#configuration-bean-injection"> Bean injection</a> for more details.</p>
</div>
</div>
<div class="sect3">
<h4 id="binding-propertybridge-programmatic"><a class="anchor" href="#binding-propertybridge-programmatic"></a>12.3.5. <a id="mapper-orm-bridge-propertybridge-programmatic"></a> Programmatic mapping</h4>
<div class="paragraph">
<p>You can apply a property bridge through the <a href="#mapping-programmatic">programmatic mapping</a> too.
Just pass an instance of the binder. You can pass arguments either through the binder&#8217;s constructor, or through setters.</p>
</div>
<div class="exampleblock">
<div class="title">Example 92. Applying an <code>PropertyBinder</code> with <code>.binder(&#8230;&#8203;)</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">TypeMappingStep invoiceMapping = mapping.type( Invoice.class );
invoiceMapping.indexed();
invoiceMapping.property( <span class="string"><span class="delimiter">&quot;</span><span class="content">lineItems</span><span class="delimiter">&quot;</span></span> )
        .binder( <span class="keyword">new</span> InvoiceLineItemsSummaryBinder().fieldName( <span class="string"><span class="delimiter">&quot;</span><span class="content">itemSummary</span><span class="delimiter">&quot;</span></span> ) );</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="binding-propertybridge-incubating"><a class="anchor" href="#binding-propertybridge-incubating"></a>12.3.6. <a id="mapper-orm-bridge-propertybridge-parameters-incubating"></a> Incubating features</h4>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Features detailed below are <em>incubating</em>: they are still under active development.</p>
</div>
<div class="paragraph">
<p>The usual <a href="https://hibernate.org/community/compatibility-policy/">compatibility policy</a> does not apply:
the contract of incubating elements (e.g. types, methods, configuration properties, etc.)
may be altered in a backward-incompatible way&#8201;&#8212;&#8201;or even removed&#8201;&#8212;&#8201;in subsequent releases.</p>
</div>
<div class="paragraph">
<p>You are encouraged to use incubating features so the development team can get feedback and improve them,
but you should be prepared to update code which relies on them as needed.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The context passed to the property binder&#8217;s <code>bind</code> method
exposes a <code>bridgedElement()</code> method that gives access to metadata about the property being bound.</p>
</div>
<div class="paragraph">
<p>The metadata can be used to inspect the property in details:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Getting the name of the property.</p>
</li>
<li>
<p>Checking the type of the property.</p>
</li>
<li>
<p>Getting accessors to properties.</p>
</li>
<li>
<p>Detecting properties with markers.
Markers are applied by specific annotations carrying a <code>@MarkerBinding</code> meta-annotation.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>See the javadoc for more information.</p>
</div>
<div class="paragraph">
<p>Below is an example of the simplest use of this metadata,
getting the property name and using it as a field name.</p>
</div>
<div class="exampleblock">
<div class="title">Example 93. Naming a field after the property being bound in a <code>PropertyBinder</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="directive">public</span> <span class="type">class</span> <span class="class">InvoiceLineItemsSummaryBinder</span> <span class="directive">implements</span> PropertyBinder {

    <span class="annotation">@Override</span>
    <span class="annotation">@SuppressWarnings</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">uncheked</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">public</span> <span class="type">void</span> bind(PropertyBindingContext context) {
        context.dependencies()
                .use( <span class="string"><span class="delimiter">&quot;</span><span class="content">category</span><span class="delimiter">&quot;</span></span> )
                .use( <span class="string"><span class="delimiter">&quot;</span><span class="content">amount</span><span class="delimiter">&quot;</span></span> );

        PojoModelProperty bridgedElement = context.bridgedElement(); <i class="conum" data-value="1"></i><b>(1)</b>
        IndexSchemaObjectField summaryField = context.indexSchemaElement()
                .objectField( bridgedElement.name() ); <i class="conum" data-value="2"></i><b>(2)</b>

        IndexFieldType&lt;<span class="predefined-type">BigDecimal</span>&gt; amountFieldType = context.typeFactory()
                .asBigDecimal().decimalScale( <span class="integer">2</span> ).toIndexFieldType();

        context.bridge( <span class="predefined-type">List</span>.class, <span class="keyword">new</span> Bridge(
                summaryField.toReference(),
                summaryField.field( <span class="string"><span class="delimiter">&quot;</span><span class="content">total</span><span class="delimiter">&quot;</span></span>, amountFieldType ).toReference(),
                summaryField.field( <span class="string"><span class="delimiter">&quot;</span><span class="content">books</span><span class="delimiter">&quot;</span></span>, amountFieldType ).toReference(),
                summaryField.field( <span class="string"><span class="delimiter">&quot;</span><span class="content">shipping</span><span class="delimiter">&quot;</span></span>, amountFieldType ).toReference()
        ) );
    }

    <span class="annotation">@SuppressWarnings</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">rawtypes</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">private</span> <span class="directive">static</span> <span class="type">class</span> <span class="class">Bridge</span> <span class="directive">implements</span> PropertyBridge&lt;<span class="predefined-type">List</span>&gt; {

        <span class="comment">/* ... same implementation as before ... */</span>

    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Use the binding context to get the bridged element.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Use the name of the property as the name of a newly declared index field.</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="annotation">@Entity</span>
<span class="annotation">@Indexed</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">Invoice</span> {

    <span class="annotation">@Id</span>
    <span class="annotation">@GeneratedValue</span>
    <span class="directive">private</span> <span class="predefined-type">Integer</span> id;

    <span class="annotation">@ElementCollection</span>
    <span class="annotation">@OrderColumn</span>
    <span class="annotation">@PropertyBinding</span>(binder = <span class="annotation">@PropertyBinderRef</span>( <i class="conum" data-value="1"></i><b>(1)</b>
            type = InvoiceLineItemsSummaryBinder.class
    ))
    <span class="directive">private</span> <span class="predefined-type">List</span>&lt;InvoiceLineItem&gt; lineItems = <span class="keyword">new</span> <span class="predefined-type">ArrayList</span>&lt;&gt;();

    <span class="comment">// Getters and setters</span>
    <span class="comment">// ...</span>

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Apply the bridge using the <code>@PropertyBinding</code> annotation.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Here is an example of what an indexed document would look like, with the Elasticsearch backend:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JSON">{
  <span class="key"><span class="delimiter">&quot;</span><span class="content">lineItems</span><span class="delimiter">&quot;</span></span>: {
    <span class="key"><span class="delimiter">&quot;</span><span class="content">total</span><span class="delimiter">&quot;</span></span>: <span class="float">38.96</span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">books</span><span class="delimiter">&quot;</span></span>: <span class="float">30.97</span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">shipping</span><span class="delimiter">&quot;</span></span>: <span class="float">7.99</span>
  }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="binding-typebridge"><a class="anchor" href="#binding-typebridge"></a>12.4. <a id="mapper-orm-bridge-typebridge"></a> <a id="_classbridge"></a> Type bridge</h3>
<div class="sect3">
<h4 id="binding-typebridge-basics"><a class="anchor" href="#binding-typebridge-basics"></a>12.4.1. <a id="mapper-orm-bridge-typebridge-basics"></a> Basics</h4>
<div class="paragraph">
<p>A type bridge is a pluggable component that implements
the mapping of a whole type to one or more index fields.
It is applied to a type with the <code>@TypeBinding</code> annotation
or with a <a href="#mapping-custom-annotations">custom annotation</a>.</p>
</div>
<div class="paragraph">
<p>The type bridge is very similar to the property bridge in its core principles and in how it is implemented.
The only (obvious) difference is that the property bridge is applied to properties (fields or getters),
while the type bridge is applied to the type (class or interface).
This entails some slight differences in the APIs exposed to the type bridge.</p>
</div>
<div class="paragraph">
<p>Implementing a type bridge requires two components:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>A custom implementation of <code>TypeBinder</code>, to bind the bridge to a type at bootstrap.
This involves declaring the properties of the type that will be used,
declaring the index fields that will be populated along with their type,
and instantiating the type bridge.</p>
</li>
<li>
<p>A custom implementation of <code>TypeBridge</code>, to perform the conversion at runtime.
This involves extracting data from an instance of the type, transforming the data if necessary,
and pushing it to index fields.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Below is an example of a custom type bridge that maps
two properties of the <code>Author</code> class, the <code>firstName</code> and <code>lastName</code>,
to a single <code>fullName</code> field.</p>
</div>
<div id="example-class-bridge" class="exampleblock">
<div class="title">Example 94. Implementing and using a <code>TypeBridge</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="directive">public</span> <span class="type">class</span> <span class="class">FullNameBinder</span> <span class="directive">implements</span> TypeBinder { <i class="conum" data-value="1"></i><b>(1)</b>

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> bind(TypeBindingContext context) { <i class="conum" data-value="2"></i><b>(2)</b>
        context.dependencies() <i class="conum" data-value="3"></i><b>(3)</b>
                .use( <span class="string"><span class="delimiter">&quot;</span><span class="content">firstName</span><span class="delimiter">&quot;</span></span> )
                .use( <span class="string"><span class="delimiter">&quot;</span><span class="content">lastName</span><span class="delimiter">&quot;</span></span> );

        IndexFieldReference&lt;<span class="predefined-type">String</span>&gt; fullNameField = context.indexSchemaElement() <i class="conum" data-value="4"></i><b>(4)</b>
                .field( <span class="string"><span class="delimiter">&quot;</span><span class="content">fullName</span><span class="delimiter">&quot;</span></span>, f -&gt; f.asString().analyzer( <span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span> ) ) <i class="conum" data-value="5"></i><b>(5)</b>
                .toReference();

        context.bridge( <i class="conum" data-value="6"></i><b>(6)</b>
                Author.class, <i class="conum" data-value="7"></i><b>(7)</b>
                <span class="keyword">new</span> Bridge( <i class="conum" data-value="8"></i><b>(8)</b>
                        fullNameField <i class="conum" data-value="9"></i><b>(9)</b>
                )
        );
    }

    <span class="comment">// ... class continues below</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The binder must implement the <code>TypeBinder</code> interface.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Implement the <code>bind</code> method in the binder.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Declare the dependencies of the bridge,
i.e. the parts of the type instances that the bridge will actually use.
This is <strong>absolutely necessary</strong> in order for Hibernate Search to correctly trigger reindexing
when these parts are modified.
See <a href="#binding-bridgedelement-dependencies"> Declaring dependencies to bridged elements</a>
for more information about declaring dependencies.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Declare the field that will be populated by this bridge.
In this case we&#8217;re creating a single <code>fullName</code> String field.
Multiple index fields can be declared.
See <a href="#binding-index-field-dsl"> Declaring and writing to index fields</a>
for more information about declaring index fields.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Declare the type of the field.
Since we&#8217;re indexing a full name,
we will use a <code>String</code> type with a <code>name</code> analyzer (defined separately, see <a href="#concepts-analysis"> Analysis</a>).
See <a href="#binding-index-field-type-dsl"> Defining index field types</a>
for more information about declaring index field types.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Call <code>context.bridge(&#8230;&#8203;)</code> to define the type bridge to use.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Pass the expected type of the entity.</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>Pass the type bridge instance.</td>
</tr>
<tr>
<td><i class="conum" data-value="9"></i><b>9</b></td>
<td>Pass a reference to the <code>fullName</code> field to the bridge.</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">    <span class="comment">// ... class FullNameBinder (continued)</span>

    <span class="directive">private</span> <span class="directive">static</span> <span class="type">class</span> <span class="class">Bridge</span> <i class="conum" data-value="1"></i><b>(1)</b>
            <span class="directive">implements</span> TypeBridge&lt;Author&gt; { <i class="conum" data-value="2"></i><b>(2)</b>

        <span class="directive">private</span> <span class="directive">final</span> IndexFieldReference&lt;<span class="predefined-type">String</span>&gt; fullNameField;

        <span class="directive">private</span> Bridge(IndexFieldReference&lt;<span class="predefined-type">String</span>&gt; fullNameField) { <i class="conum" data-value="3"></i><b>(3)</b>
            <span class="local-variable">this</span>.fullNameField = fullNameField;
        }

        <span class="annotation">@Override</span>
        <span class="directive">public</span> <span class="type">void</span> write(
                DocumentElement target,
                Author author,
                TypeBridgeWriteContext context) { <i class="conum" data-value="4"></i><b>(4)</b>
            <span class="predefined-type">String</span> fullName = author.getLastName() + <span class="string"><span class="delimiter">&quot;</span><span class="content"> </span><span class="delimiter">&quot;</span></span> + author.getFirstName(); <i class="conum" data-value="5"></i><b>(5)</b>
            target.addValue( <span class="local-variable">this</span>.fullNameField, fullName ); <i class="conum" data-value="6"></i><b>(6)</b>
        }
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Here the bridge class is nested in the binder class,
because it is more convenient,
but you are obviously free to implement it as you wish:
as a lambda expression, in a separate Java file&#8230;&#8203;</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The bridge must implement the <code>TypeBridge</code> interface.
One generic type argument must be provided: the type of the "bridged element".</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The bridge stores references to the fields&#8201;&#8212;&#8201;it will need them when indexing.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Implement the <code>write</code> method in the bridge.
This method is called on indexing.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Extract data from the bridged element,
and optionally transform it.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Set the value of the <code>fullName</code> field.
Note the <code>fullName</code> field was declared at the root,
so we call <code>addValue</code> directly on the <code>target</code> argument.</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="annotation">@Entity</span>
<span class="annotation">@Indexed</span>
<span class="annotation">@TypeBinding</span>(binder = <span class="annotation">@TypeBinderRef</span>(type = FullNameBinder.class)) <i class="conum" data-value="1"></i><b>(1)</b>
<span class="directive">public</span> <span class="type">class</span> <span class="class">Author</span> {

    <span class="annotation">@Id</span>
    <span class="annotation">@GeneratedValue</span>
    <span class="directive">private</span> <span class="predefined-type">Integer</span> id;

    <span class="directive">private</span> <span class="predefined-type">String</span> firstName;

    <span class="directive">private</span> <span class="predefined-type">String</span> lastName;

    <span class="annotation">@GenericField</span> <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="directive">private</span> LocalDate birthDate;

    <span class="comment">// Getters and setters</span>
    <span class="comment">// ...</span>

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Apply the bridge using the <code>@TypeBinding</code> annotation.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>It is still possible to map properties directly using other annotations,
as long as index field names are distinct from the names used in the type binder.
But no annotation is necessary on the <code>firstName</code> and <code>lastName</code> properties:
these are already handled by the bridge.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Here is an example of what an indexed document would look like, with the Elasticsearch backend:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JSON">{
  <span class="key"><span class="delimiter">&quot;</span><span class="content">fullName</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Asimov Isaac</span><span class="delimiter">&quot;</span></span>
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="binding-typebridge-parameters"><a class="anchor" href="#binding-typebridge-parameters"></a>12.4.2. <a id="mapper-orm-bridge-typebridge-parameters"></a> Passing parameters</h4>
<div class="paragraph">
<p>There are two ways to pass parameters to type bridges:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>One is (mostly) limited to string parameters, but is trivial to implement.</p>
</li>
<li>
<p>The other can allow any type of parameters, but requires you to declare your own annotations.</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="binding-typebridge-parameters-string"><a class="anchor" href="#binding-typebridge-parameters-string"></a><a id="mapper-orm-bridge-typebridge-parameters-string"></a> Simple, string parameters</h5>
<div class="paragraph">
<p>You can pass string parameters to the <code>@TypeBinderRef</code> annotation and then use them later in the binder:</p>
</div>
<div class="exampleblock">
<div class="title">Example 95. Passing parameters to a <code>TypeBinder</code> using the <code>@TypeBinderRef</code> annotation</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="directive">public</span> <span class="type">class</span> <span class="class">FullNameBinder</span> <span class="directive">implements</span> TypeBinder {

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> bind(TypeBindingContext context) {
        context.dependencies()
                .use( <span class="string"><span class="delimiter">&quot;</span><span class="content">firstName</span><span class="delimiter">&quot;</span></span> )
                .use( <span class="string"><span class="delimiter">&quot;</span><span class="content">lastName</span><span class="delimiter">&quot;</span></span> );

        IndexFieldReference&lt;<span class="predefined-type">String</span>&gt; fullNameField = context.indexSchemaElement()
                .field( <span class="string"><span class="delimiter">&quot;</span><span class="content">fullName</span><span class="delimiter">&quot;</span></span>, f -&gt; f.asString().analyzer( <span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span> ) )
                .toReference();

        IndexFieldReference&lt;<span class="predefined-type">String</span>&gt; fullNameSortField = <span class="predefined-constant">null</span>;
        <span class="predefined-type">String</span> sortField = context.param( <span class="string"><span class="delimiter">&quot;</span><span class="content">sortField</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">String</span>.class ); <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="keyword">if</span> ( <span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span>.equalsIgnoreCase( sortField ) ) { <i class="conum" data-value="2"></i><b>(2)</b>
            fullNameSortField = context.indexSchemaElement()
                    .field(
                            <span class="string"><span class="delimiter">&quot;</span><span class="content">fullName_sort</span><span class="delimiter">&quot;</span></span>,
                            f -&gt; f.asString().normalizer( <span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span> ).sortable( Sortable.YES )
                    )
                    .toReference();
        }

        context.bridge( Author.class, <span class="keyword">new</span> Bridge(
                fullNameField,
                fullNameSortField
        ) );
    }

    <span class="directive">private</span> <span class="directive">static</span> <span class="type">class</span> <span class="class">Bridge</span> <span class="directive">implements</span> TypeBridge&lt;Author&gt; {

        <span class="directive">private</span> <span class="directive">final</span> IndexFieldReference&lt;<span class="predefined-type">String</span>&gt; fullNameField;
        <span class="directive">private</span> <span class="directive">final</span> IndexFieldReference&lt;<span class="predefined-type">String</span>&gt; fullNameSortField;

        <span class="directive">private</span> Bridge(IndexFieldReference&lt;<span class="predefined-type">String</span>&gt; fullNameField,
                IndexFieldReference&lt;<span class="predefined-type">String</span>&gt; fullNameSortField) { <i class="conum" data-value="2"></i><b>(2)</b>
            <span class="local-variable">this</span>.fullNameField = fullNameField;
            <span class="local-variable">this</span>.fullNameSortField = fullNameSortField;
        }

        <span class="annotation">@Override</span>
        <span class="directive">public</span> <span class="type">void</span> write(
                DocumentElement target,
                Author author,
                TypeBridgeWriteContext context) {
            <span class="predefined-type">String</span> fullName = author.getLastName() + <span class="string"><span class="delimiter">&quot;</span><span class="content"> </span><span class="delimiter">&quot;</span></span> + author.getFirstName();

            target.addValue( <span class="local-variable">this</span>.fullNameField, fullName );
            <span class="keyword">if</span> ( <span class="local-variable">this</span>.fullNameSortField != <span class="predefined-constant">null</span> ) {
                target.addValue( <span class="local-variable">this</span>.fullNameSortField, fullName );
            }
        }
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Use the binding context to get the parameter value.
<div class="paragraph">
<p>The <code>param</code> method will throw an exception if the parameter has not been defined.
Alternatively, use <code>paramOptional</code> to get an <code>java.util.Optional</code> that will be empty if the parameter has not been defined.</p>
</div></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>In the <code>bind</code> method, use the value of parameters.
Here use the <code>sortField</code> parameter to decide whether to add another, sortable field,
but we could pass parameters for any purpose:
defining the field name,
defining a normalizer,custom annotation
&#8230;&#8203;</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="annotation">@Entity</span>
<span class="annotation">@Indexed</span>
<span class="annotation">@TypeBinding</span>(binder = <span class="annotation">@TypeBinderRef</span>(type = FullNameBinder.class, <i class="conum" data-value="1"></i><b>(1)</b>
        params = <span class="annotation">@Param</span>(name = <span class="string"><span class="delimiter">&quot;</span><span class="content">sortField</span><span class="delimiter">&quot;</span></span>, value = <span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span>)))
<span class="directive">public</span> <span class="type">class</span> <span class="class">Author</span> {

    <span class="annotation">@Id</span>
    <span class="annotation">@GeneratedValue</span>
    <span class="directive">private</span> <span class="predefined-type">Integer</span> id;

    <span class="directive">private</span> <span class="predefined-type">String</span> firstName;

    <span class="directive">private</span> <span class="predefined-type">String</span> lastName;

    <span class="comment">// Getters and setters</span>
    <span class="comment">// ...</span>

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Define the binder to use on the type,
setting the <code>sortField</code> parameter.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="binding-typebridge-parameters-custom-annotation"><a class="anchor" href="#binding-typebridge-parameters-custom-annotation"></a><a id="mapper-orm-bridge-typebridge-parameters-custom-annotation"></a> Parameters with custom annotations</h5>
<div class="paragraph">
<p>You can pass parameters of any type to the bridge by defining
a <a href="#mapping-custom-annotations">custom annotation</a> with attributes:</p>
</div>
<div class="exampleblock">
<div class="title">Example 96. Passing parameters to a <code>TypeBinder</code> using a custom annotation</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="annotation">@Retention</span>(<span class="predefined-type">RetentionPolicy</span>.RUNTIME) <i class="conum" data-value="1"></i><b>(1)</b>
<span class="annotation">@Target</span>({ <span class="predefined-type">ElementType</span>.TYPE }) <i class="conum" data-value="2"></i><b>(2)</b>
<span class="annotation">@TypeMapping</span>(processor = <span class="annotation">@TypeMappingAnnotationProcessorRef</span>(type = FullNameBinding.Processor.class)) <i class="conum" data-value="3"></i><b>(3)</b>
<span class="annotation">@Documented</span> <i class="conum" data-value="4"></i><b>(4)</b>
<span class="directive">public</span> <span class="annotation">@interface</span> FullNameBinding {

    <span class="type">boolean</span> sortField() <span class="keyword">default</span> <span class="predefined-constant">false</span>; <i class="conum" data-value="5"></i><b>(5)</b>

    <span class="type">class</span> <span class="class">Processor</span> <i class="conum" data-value="6"></i><b>(6)</b>
            <span class="directive">implements</span> TypeMappingAnnotationProcessor&lt;FullNameBinding&gt; { <i class="conum" data-value="7"></i><b>(7)</b>
        <span class="annotation">@Override</span>
        <span class="directive">public</span> <span class="type">void</span> process(TypeMappingStep mapping, FullNameBinding annotation,
                TypeMappingAnnotationProcessorContext context) {
            FullNameBinder binder = <span class="keyword">new</span> FullNameBinder() <i class="conum" data-value="8"></i><b>(8)</b>
                    .sortField( annotation.sortField() ); <i class="conum" data-value="9"></i><b>(9)</b>
            mapping.binder( binder ); <i class="conum" data-value="10"></i><b>(10)</b>
        }
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Define an annotation with <code>RUNTIME</code> retention.
<strong>Any other retention policy will cause the annotation to be ignored by Hibernate Search</strong>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Since we&#8217;re defining a type bridge, allow the annotation to target types.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Mark this annotation as a type mapping,
and instruct Hibernate Search to apply the given binder whenever it finds this annotation.
It is also possible to reference the binder by its name, in the case of a CDI/Spring bean.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Optionally, mark the annotation as documented,
so that it is included in the javadoc of your entities.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Define an attribute of type <code>boolean</code> to specify whether a sort field should be added.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Here the processor class is nested in the annotation class,
because it is more convenient,
but you are obviously free to implement it in a separate Java file.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>The processor must implement the <code>TypeMappingAnnotationProcessor</code> interface,
setting its generic type argument to the type of the corresponding annotation.</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>In the annotation processor, instantiate the binder.</td>
</tr>
<tr>
<td><i class="conum" data-value="9"></i><b>9</b></td>
<td>Process the annotation attributes and pass the data to the binder.
<div class="paragraph">
<p>Here we&#8217;re using a setter, but passing the data through the constructor would work, too.</p>
</div></td>
</tr>
<tr>
<td><i class="conum" data-value="10"></i><b>10</b></td>
<td>Apply the binder to the type.</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="directive">public</span> <span class="type">class</span> <span class="class">FullNameBinder</span> <span class="directive">implements</span> TypeBinder {

    <span class="directive">private</span> <span class="type">boolean</span> sortField;

    <span class="directive">public</span> FullNameBinder sortField(<span class="type">boolean</span> sortField) { <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="local-variable">this</span>.sortField = sortField;
        <span class="keyword">return</span> <span class="local-variable">this</span>;
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> bind(TypeBindingContext context) {
        context.dependencies()
                .use( <span class="string"><span class="delimiter">&quot;</span><span class="content">firstName</span><span class="delimiter">&quot;</span></span> )
                .use( <span class="string"><span class="delimiter">&quot;</span><span class="content">lastName</span><span class="delimiter">&quot;</span></span> );

        IndexFieldReference&lt;<span class="predefined-type">String</span>&gt; fullNameField = context.indexSchemaElement()
                .field( <span class="string"><span class="delimiter">&quot;</span><span class="content">fullName</span><span class="delimiter">&quot;</span></span>, f -&gt; f.asString().analyzer( <span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span> ) )
                .toReference();

        IndexFieldReference&lt;<span class="predefined-type">String</span>&gt; fullNameSortField = <span class="predefined-constant">null</span>;
        <span class="keyword">if</span> ( <span class="local-variable">this</span>.sortField ) { <i class="conum" data-value="2"></i><b>(2)</b>
            fullNameSortField = context.indexSchemaElement()
                    .field(
                            <span class="string"><span class="delimiter">&quot;</span><span class="content">fullName_sort</span><span class="delimiter">&quot;</span></span>,
                            f -&gt; f.asString().normalizer( <span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span> ).sortable( Sortable.YES )
                    )
                    .toReference();
        }

        context.bridge( Author.class, <span class="keyword">new</span> Bridge(
                fullNameField,
                fullNameSortField
        ) );
    }

    <span class="directive">private</span> <span class="directive">static</span> <span class="type">class</span> <span class="class">Bridge</span> <span class="directive">implements</span> TypeBridge&lt;Author&gt; {

        <span class="directive">private</span> <span class="directive">final</span> IndexFieldReference&lt;<span class="predefined-type">String</span>&gt; fullNameField;
        <span class="directive">private</span> <span class="directive">final</span> IndexFieldReference&lt;<span class="predefined-type">String</span>&gt; fullNameSortField;

        <span class="directive">private</span> Bridge(IndexFieldReference&lt;<span class="predefined-type">String</span>&gt; fullNameField,
                IndexFieldReference&lt;<span class="predefined-type">String</span>&gt; fullNameSortField) { <i class="conum" data-value="2"></i><b>(2)</b>
            <span class="local-variable">this</span>.fullNameField = fullNameField;
            <span class="local-variable">this</span>.fullNameSortField = fullNameSortField;
        }

        <span class="annotation">@Override</span>
        <span class="directive">public</span> <span class="type">void</span> write(
                DocumentElement target,
                Author author,
                TypeBridgeWriteContext context) {
            <span class="predefined-type">String</span> fullName = author.getLastName() + <span class="string"><span class="delimiter">&quot;</span><span class="content"> </span><span class="delimiter">&quot;</span></span> + author.getFirstName();

            target.addValue( <span class="local-variable">this</span>.fullNameField, fullName );
            <span class="keyword">if</span> ( <span class="local-variable">this</span>.fullNameSortField != <span class="predefined-constant">null</span> ) {
                target.addValue( <span class="local-variable">this</span>.fullNameSortField, fullName );
            }
        }
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Implement setters in the binder.
Alternatively, we could expose a parameterized constructor.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>In the <code>bind</code> method, use the value of parameters.
Here use the <code>sortField</code> parameter to decide whether to add another, sortable field,
but we could pass parameters for any purpose:
defining the field name,
defining a normalizer,custom annotation
&#8230;&#8203;</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="annotation">@Entity</span>
<span class="annotation">@Indexed</span>
<span class="annotation">@FullNameBinding</span>(sortField = <span class="predefined-constant">true</span>) <i class="conum" data-value="1"></i><b>(1)</b>
<span class="directive">public</span> <span class="type">class</span> <span class="class">Author</span> {

    <span class="annotation">@Id</span>
    <span class="annotation">@GeneratedValue</span>
    <span class="directive">private</span> <span class="predefined-type">Integer</span> id;

    <span class="directive">private</span> <span class="predefined-type">String</span> firstName;

    <span class="directive">private</span> <span class="predefined-type">String</span> lastName;

    <span class="comment">// Getters and setters</span>
    <span class="comment">// ...</span>

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Apply the bridge using its custom annotation,
setting the <code>sortField</code> parameter.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="binding-typebridge-access-orm"><a class="anchor" href="#binding-typebridge-access-orm"></a>12.4.3. <a id="mapper-orm-bridge-typebridge-access-orm"></a> Accessing the ORM session from the bridge</h4>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This feature is only available with the <a href="#mapper-orm">Hibernate ORM integration</a>.</p>
</div>
<div class="paragraph">
<p>It <strong>cannot</strong> be used with the <a href="#mapper-pojo-standalone">Standalone POJO Mapper</a> in particular.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Contexts passed to the bridge methods can be used to retrieve the Hibernate ORM session.</p>
</div>
<div class="exampleblock">
<div class="title">Example 97. Retrieving the ORM session from a <code>TypeBridge</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="directive">private</span> <span class="directive">static</span> <span class="type">class</span> <span class="class">Bridge</span> <span class="directive">implements</span> TypeBridge&lt;<span class="predefined-type">Object</span>&gt; {

    <span class="directive">private</span> <span class="directive">final</span> IndexFieldReference&lt;<span class="predefined-type">String</span>&gt; field;

    <span class="directive">private</span> Bridge(IndexFieldReference&lt;<span class="predefined-type">String</span>&gt; field) {
        <span class="local-variable">this</span>.field = field;
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> write(DocumentElement target, <span class="predefined-type">Object</span> bridgedElement, TypeBridgeWriteContext context) {
        Session session = context.extension( HibernateOrmExtension.get() ) <i class="conum" data-value="1"></i><b>(1)</b>
                .session(); <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="comment">// ... do something with the session ...</span>
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Apply an extension to the context to access content specific to Hibernate ORM.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Retrieve the <code>Session</code> from the extended context.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="binding-typebridge-injecting-beans"><a class="anchor" href="#binding-typebridge-injecting-beans"></a>12.4.4. <a id="mapper-orm-bridge-typebridge-injecting-beans"></a> Injecting beans into the binder</h4>
<div class="paragraph">
<p>With <a href="#configuration-bean-frameworks">compatible frameworks</a>,
Hibernate Search supports injecting beans into:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the <code>TypeMappingAnnotationProcessor</code> if you use <a href="#binding-typebridge-parameters-custom-annotation">custom annotations</a>.</p>
</li>
<li>
<p>the <code>TypeBinder</code> if you use the <a href="#binding-typebridge-basics"><code>@TypeBinding</code> annotation</a>.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This only applies to beans instantiated
through Hibernate Search&#8217;s <a href="#configuration-bean-resolution">bean resolution</a>.
As a rule of thumb, if you need to call <code>new MyBinder()</code> explicitly at some point,
the binder won&#8217;t get auto-magically injected.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The context passed to the routing key binder&#8217;s <code>bind</code> method
also exposes a <code>beanResolver()</code> method to access the bean resolver and instantiate beans explicitly.</p>
</div>
<div class="paragraph">
<p>See <a href="#configuration-bean-injection"> Bean injection</a> for more details.</p>
</div>
</div>
<div class="sect3">
<h4 id="binding-typebridge-programmatic"><a class="anchor" href="#binding-typebridge-programmatic"></a>12.4.5. <a id="mapper-orm-bridge-typebridge-programmatic"></a> Programmatic mapping</h4>
<div class="paragraph">
<p>You can apply a type bridge through the <a href="#mapping-programmatic">programmatic mapping</a> too.
Just pass an instance of the binder. You can pass arguments either through the binder&#8217;s constructor, or through setters.</p>
</div>
<div class="exampleblock">
<div class="title">Example 98. Applying a <code>TypeBinder</code> with <code>.binder(&#8230;&#8203;)</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">TypeMappingStep authorMapping = mapping.type( Author.class );
authorMapping.indexed();
authorMapping.binder( <span class="keyword">new</span> FullNameBinder().sortField( <span class="predefined-constant">true</span> ) );</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="binding-typebridge-incubating"><a class="anchor" href="#binding-typebridge-incubating"></a>12.4.6. <a id="mapper-orm-bridge-typebridge-incubating"></a> Incubating features</h4>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Features detailed below are <em>incubating</em>: they are still under active development.</p>
</div>
<div class="paragraph">
<p>The usual <a href="https://hibernate.org/community/compatibility-policy/">compatibility policy</a> does not apply:
the contract of incubating elements (e.g. types, methods, configuration properties, etc.)
may be altered in a backward-incompatible way&#8201;&#8212;&#8201;or even removed&#8201;&#8212;&#8201;in subsequent releases.</p>
</div>
<div class="paragraph">
<p>You are encouraged to use incubating features so the development team can get feedback and improve them,
but you should be prepared to update code which relies on them as needed.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The context passed to the type binder&#8217;s <code>bind</code> method
exposes a <code>bridgedElement()</code> method that gives access to metadata about the type being bound.</p>
</div>
<div class="paragraph">
<p>The metadata can in particular be used to inspect the type in details:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Getting accessors to properties.</p>
</li>
<li>
<p>Detecting properties with markers.
Markers are applied by specific annotations carrying a <code>@MarkerBinding</code> meta-annotation.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>See the javadoc for more information.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="binding-identifierbridge"><a class="anchor" href="#binding-identifierbridge"></a>12.5. <a id="mapper-orm-bridge-identifierbridge"></a> Identifier bridge</h3>
<div class="sect3">
<h4 id="binding-identifierbridge-basics"><a class="anchor" href="#binding-identifierbridge-basics"></a>12.5.1. <a id="mapper-orm-bridge-identifierbridge-basics"></a> Basics</h4>
<div class="paragraph">
<p>An identifier bridge is a pluggable component that implements
the mapping of an entity property to a document identifier.
It is applied to a property with the <code>@DocumentId</code> annotation
or with a <a href="#mapping-custom-annotations">custom annotation</a>.</p>
</div>
<div class="paragraph">
<p>Implementing an identifier bridge boils down to implementing two methods:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>one method to convert the property value (any type) to the document identifier (a string);</p>
</li>
<li>
<p>one method to convert the document identifier back to the original property value.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Below is an example of a custom identifier bridge that converts
a custom <code>BookId</code> type to its string representation and back:</p>
</div>
<div class="exampleblock">
<div class="title">Example 99. Implementing and using an <code>IdentifierBridge</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="directive">public</span> <span class="type">class</span> <span class="class">BookIdBridge</span> <span class="directive">implements</span> IdentifierBridge&lt;BookId&gt; { <i class="conum" data-value="1"></i><b>(1)</b>

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="predefined-type">String</span> toDocumentIdentifier(BookId value,
            IdentifierBridgeToDocumentIdentifierContext context) { <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="keyword">return</span> value.getPublisherId() + <span class="string"><span class="delimiter">&quot;</span><span class="content">/</span><span class="delimiter">&quot;</span></span> + value.getPublisherSpecificBookId();
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> BookId fromDocumentIdentifier(<span class="predefined-type">String</span> documentIdentifier,
            IdentifierBridgeFromDocumentIdentifierContext context) { <i class="conum" data-value="3"></i><b>(3)</b>
        <span class="predefined-type">String</span><span class="type">[]</span> split = documentIdentifier.split( <span class="string"><span class="delimiter">&quot;</span><span class="content">/</span><span class="delimiter">&quot;</span></span> );
        <span class="keyword">return</span> <span class="keyword">new</span> BookId( <span class="predefined-type">Long</span>.parseLong( split[<span class="integer">0</span>] ), <span class="predefined-type">Long</span>.parseLong( split[<span class="integer">1</span>] ) );
    }

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The bridge must implement the <code>IdentifierBridge</code> interface.
One generic parameters must be provided:
the type of property values (values in the entity model).</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The <code>toDocumentIdentifier</code> method takes the property value and a context object as parameters,
and is expected to return the corresponding document identifier.
It is called when indexing,
but also when parameters to the search DSL
<a href="#search-dsl-argument-type">must be transformed</a>,
in particular for the <a href="#search-dsl-predicate-id">ID predicate</a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The <code>fromDocumentIdentifier</code> methods takes the document identifier and a context object as parameters,
and is expected to return the original property value.
It is called when mapping search hits to the corresponding entity.</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="annotation">@Entity</span>
<span class="annotation">@Indexed</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">Book</span> {

    <span class="annotation">@EmbeddedId</span>
    <span class="annotation">@DocumentId</span>( <i class="conum" data-value="1"></i><b>(1)</b>
            identifierBridge = <span class="annotation">@IdentifierBridgeRef</span>(type = BookIdBridge.class) <i class="conum" data-value="2"></i><b>(2)</b>
    )
    <span class="directive">private</span> BookId id = <span class="keyword">new</span> BookId();

    <span class="directive">private</span> <span class="predefined-type">String</span> title;

    <span class="comment">// Getters and setters</span>
    <span class="comment">// ...</span>

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Map the property to the document identifier.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Instruct Hibernate Search to use our custom identifier bridge.
It is also possible to reference the bridge by its name, in the case of a CDI/Spring bean.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="binding-identifierbridge-type-resolution"><a class="anchor" href="#binding-identifierbridge-type-resolution"></a>12.5.2. <a id="mapper-orm-bridge-identifierbridge-type-resolution"></a> Type resolution</h4>
<div class="paragraph">
<p>By default, the identifier bridge&#8217;s property type is determined automatically,
using reflection to extract the generic type argument of the <code>IdentifierBridge</code> interface.</p>
</div>
<div class="paragraph">
<p>For example, in <code>public class MyBridge implements IdentifierBridge&lt;BookId&gt;</code>,
the property type is resolved to <code>BookId</code>:
the bridge will be applied to properties of type <code>BookId</code>.</p>
</div>
<div class="paragraph">
<p>The fact that the type is resolved automatically using reflection brings a few limitations.
In particular, it means the generic type argument cannot be just anything;
as a general rule, you should stick to literal types (<code>MyBridge implements IdentifierBridge&lt;BookId&gt;</code>)
and avoid generic type parameters and wildcards
(<code>MyBridge&lt;T extends Number&gt; implements IdentifierBridge&lt;T&gt;</code>,
`MyBridge implements IdentifierBridge&lt;List&lt;? extends Number&gt;&gt;).</p>
</div>
<div class="paragraph">
<p>If you need more complex types,
you can bypass the automatic resolution and specify types explicitly
using an <a href="#binding-identifierbridge-identifierbinder"><code>IdentifierBinder</code></a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="binding-identifierbridge-iscompatiblewith"><a class="anchor" href="#binding-identifierbridge-iscompatiblewith"></a>12.5.3. <a id="mapper-orm-bridge-identifierbridge-iscompatiblewith"></a> Compatibility across indexes with <code>isCompatibleWith()</code></h4>
<div class="paragraph">
<p>An identifier bridge is involved in indexing,
but also in the search DSLs,
to convert values passed to the <a href="#search-dsl-predicate-id"><code>id</code> predicate</a>
to a document identifier that the backend will understand.</p>
</div>
<div class="paragraph">
<p>When creating an <code>id</code> predicate targeting multiple entity types (and their indexes),
Hibernate Search will have multiple bridges to choose from: one per entity type.
Since only one predicate with a single value can be created,
Hibernate Search needs to pick a single bridge.</p>
</div>
<div class="paragraph">
<p>By default, when a custom bridge is assigned to the field,
Hibernate Search will throw an exception because it cannot decide which bridge to pick.</p>
</div>
<div class="paragraph">
<p>If the bridges assigned to the field in all indexes produce the same result,
it is possible to indicate to Hibernate Search that any bridge will do
by implementing <code>isCompatibleWith</code>.</p>
</div>
<div class="paragraph">
<p>This method accepts another bridge in parameter,
and returns <code>true</code> if that bridge can be expected to always behave the same as <code>this</code>.</p>
</div>
<div class="exampleblock">
<div class="title">Example 100. Implementing <code>isCompatibleWith</code> to support multi-index search</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="directive">public</span> <span class="type">class</span> <span class="class">BookOrMagazineIdBridge</span> <span class="directive">implements</span> IdentifierBridge&lt;BookOrMagazineId&gt; {

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="predefined-type">String</span> toDocumentIdentifier(BookOrMagazineId value,
            IdentifierBridgeToDocumentIdentifierContext context) {
        <span class="keyword">return</span> value.getPublisherId() + <span class="string"><span class="delimiter">&quot;</span><span class="content">/</span><span class="delimiter">&quot;</span></span> + value.getPublisherSpecificBookId();
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> BookOrMagazineId fromDocumentIdentifier(<span class="predefined-type">String</span> documentIdentifier,
            IdentifierBridgeFromDocumentIdentifierContext context) {
        <span class="predefined-type">String</span><span class="type">[]</span> split = documentIdentifier.split( <span class="string"><span class="delimiter">&quot;</span><span class="content">/</span><span class="delimiter">&quot;</span></span> );
        <span class="keyword">return</span> <span class="keyword">new</span> BookOrMagazineId( <span class="predefined-type">Long</span>.parseLong( split[<span class="integer">0</span>] ), <span class="predefined-type">Long</span>.parseLong( split[<span class="integer">1</span>] ) );
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">boolean</span> isCompatibleWith(IdentifierBridge&lt;?&gt; other) {
        <span class="keyword">return</span> getClass().equals( other.getClass() ); <i class="conum" data-value="1"></i><b>(1)</b>
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Implement <code>isCompatibleWith</code> as necessary.
Here we just deem any instance of the same class to be compatible.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="binding-identifierbridge-identifierbinder"><a class="anchor" href="#binding-identifierbridge-identifierbinder"></a>12.5.4. <a id="mapper-orm-bridge-identifierbridge-identifierbinder"></a> Configuring the bridge more finely with <code>IdentifierBinder</code></h4>
<div class="paragraph">
<p>To configure a bridge more finely,
it is possible to implement a value binder that will be executed at bootstrap.
This binder will be able in particular to inspect the type of the property.</p>
</div>
<div class="exampleblock">
<div class="title">Example 101. Implementing an <code>IdentifierBinder</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="directive">public</span> <span class="type">class</span> <span class="class">BookIdBinder</span> <span class="directive">implements</span> IdentifierBinder { <i class="conum" data-value="1"></i><b>(1)</b>

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> bind(IdentifierBindingContext&lt;?&gt; context) { <i class="conum" data-value="2"></i><b>(2)</b>
        context.bridge( <i class="conum" data-value="3"></i><b>(3)</b>
                BookId.class, <i class="conum" data-value="4"></i><b>(4)</b>
                <span class="keyword">new</span> Bridge() <i class="conum" data-value="5"></i><b>(5)</b>
        );
    }

    <span class="directive">private</span> <span class="directive">static</span> <span class="type">class</span> <span class="class">Bridge</span> <span class="directive">implements</span> IdentifierBridge&lt;BookId&gt; { <i class="conum" data-value="6"></i><b>(6)</b>
        <span class="annotation">@Override</span>
        <span class="directive">public</span> <span class="predefined-type">String</span> toDocumentIdentifier(BookId value,
                IdentifierBridgeToDocumentIdentifierContext context) {
            <span class="keyword">return</span> value.getPublisherId() + <span class="string"><span class="delimiter">&quot;</span><span class="content">/</span><span class="delimiter">&quot;</span></span> + value.getPublisherSpecificBookId();
        }

        <span class="annotation">@Override</span>
        <span class="directive">public</span> BookId fromDocumentIdentifier(<span class="predefined-type">String</span> documentIdentifier,
                IdentifierBridgeFromDocumentIdentifierContext context) {
            <span class="predefined-type">String</span><span class="type">[]</span> split = documentIdentifier.split( <span class="string"><span class="delimiter">&quot;</span><span class="content">/</span><span class="delimiter">&quot;</span></span> );
            <span class="keyword">return</span> <span class="keyword">new</span> BookId( <span class="predefined-type">Long</span>.parseLong( split[<span class="integer">0</span>] ), <span class="predefined-type">Long</span>.parseLong( split[<span class="integer">1</span>] ) );
        }
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The binder must implement the <code>IdentifierBinder</code> interface.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Implement the <code>bind</code> method.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Call <code>context.bridge(&#8230;&#8203;)</code> to define the identifier bridge to use.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Pass the expected type of property values.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Pass the identifier bridge instance.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>The identifier bridge must still be implemented.
<div class="paragraph">
<p>Here the bridge class is nested in the binder class,
because it is more convenient,
but you are obviously free to implement it as you wish:
as a lambda expression, in a separate Java file&#8230;&#8203;</p>
</div></td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="annotation">@Entity</span>
<span class="annotation">@Indexed</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">Book</span> {

    <span class="annotation">@EmbeddedId</span>
    <span class="annotation">@DocumentId</span>( <i class="conum" data-value="1"></i><b>(1)</b>
            identifierBinder = <span class="annotation">@IdentifierBinderRef</span>(type = BookIdBinder.class) <i class="conum" data-value="2"></i><b>(2)</b>
    )
    <span class="directive">private</span> BookId id = <span class="keyword">new</span> BookId();

    <span class="annotation">@FullTextField</span>(analyzer = <span class="string"><span class="delimiter">&quot;</span><span class="content">english</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">private</span> <span class="predefined-type">String</span> title;

    <span class="comment">// Getters and setters</span>
    <span class="comment">// ...</span>

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Map the property to the document identifier.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Instruct Hibernate Search to use our custom identifier binder.
Note the use of <code>identifierBinder</code> instead of <code>identifierBridge</code>.
It is also possible to reference the binder by its name, in the case of a CDI/Spring bean.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="binding-identifierbridge-parameters"><a class="anchor" href="#binding-identifierbridge-parameters"></a>12.5.5. <a id="mapper-orm-bridge-identifierbridge-parameters"></a> <a id="_passing_parameters"></a> Passing parameters</h4>
<div class="paragraph">
<p>There are two ways to pass parameters to identifier bridges:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>One is (mostly) limited to string parameters, but is trivial to implement.</p>
</li>
<li>
<p>The other can allow any type of parameters, but requires you to declare your own annotations.</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="binding-identifierbridge-parameters-string"><a class="anchor" href="#binding-identifierbridge-parameters-string"></a><a id="mapper-orm-bridge-identifierbridge-parameters-string"></a> Simple, string parameters</h5>
<div class="paragraph">
<p>You can pass string parameters to the <code>@IdentifierBinderRef</code> annotation and then use them later in the binder:</p>
</div>
<div class="exampleblock">
<div class="title">Example 102. Passing parameters to an <code>IdentifierBridge</code> using the <code>@IdentifierBinderRef</code> annotation</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="directive">public</span> <span class="type">class</span> <span class="class">OffsetIdentifierBridge</span> <span class="directive">implements</span> IdentifierBridge&lt;<span class="predefined-type">Integer</span>&gt; { <i class="conum" data-value="1"></i><b>(1)</b>

    <span class="directive">private</span> <span class="directive">final</span> <span class="type">int</span> offset;

    <span class="directive">public</span> OffsetIdentifierBridge(<span class="type">int</span> offset) { <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="local-variable">this</span>.offset = offset;
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="predefined-type">String</span> toDocumentIdentifier(<span class="predefined-type">Integer</span> propertyValue, IdentifierBridgeToDocumentIdentifierContext context) {
        <span class="keyword">return</span> <span class="predefined-type">String</span>.valueOf( propertyValue + offset );
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="predefined-type">Integer</span> fromDocumentIdentifier(<span class="predefined-type">String</span> documentIdentifier,
            IdentifierBridgeFromDocumentIdentifierContext context) {
        <span class="keyword">return</span> <span class="predefined-type">Integer</span>.parseInt( documentIdentifier ) - offset;
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Implement a bridge that indexes the identifier as is,
but adds a configurable offset,
For example, with an offset of 1 and database identifiers starting at 0, index identifiers will start at 1.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The bridge accepts one parameter in its constructors:
the offset to apply to identifiers.</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="directive">public</span> <span class="type">class</span> <span class="class">OffsetIdentifierBinder</span> <span class="directive">implements</span> IdentifierBinder {

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> bind(IdentifierBindingContext&lt;?&gt; context) {
        <span class="predefined-type">String</span> offset = context.param( <span class="string"><span class="delimiter">&quot;</span><span class="content">offset</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">String</span>.class ); <i class="conum" data-value="1"></i><b>(1)</b>
        context.bridge(
                <span class="predefined-type">Integer</span>.class,
                <span class="keyword">new</span> OffsetIdentifierBridge( <span class="predefined-type">Integer</span>.parseInt( offset ) ) <i class="conum" data-value="2"></i><b>(2)</b>
        );
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Use the binding context to get the parameter value.
<div class="paragraph">
<p>The <code>param</code> method will throw an exception if the parameter has not been defined.
Alternatively, use <code>paramOptional</code> to get an <code>java.util.Optional</code> that will be empty if the parameter has not been defined.</p>
</div></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Pass the parameter value as an argument to the bridge constructor.</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="annotation">@Entity</span>
<span class="annotation">@Indexed</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">Book</span> {

    <span class="annotation">@Id</span>
    <span class="comment">// DB identifiers start at 0, but index identifiers start at 1</span>
    <span class="annotation">@DocumentId</span>(identifierBinder = <span class="annotation">@IdentifierBinderRef</span>( <i class="conum" data-value="1"></i><b>(1)</b>
            type = OffsetIdentifierBinder.class,
            params = <span class="annotation">@Param</span>(name = <span class="string"><span class="delimiter">&quot;</span><span class="content">offset</span><span class="delimiter">&quot;</span></span>, value = <span class="string"><span class="delimiter">&quot;</span><span class="content">1</span><span class="delimiter">&quot;</span></span>)))
    <span class="directive">private</span> <span class="predefined-type">Integer</span> id;

    <span class="directive">private</span> <span class="predefined-type">String</span> title;

    <span class="comment">// Getters and setters</span>
    <span class="comment">// ...</span>

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Define the binder to use on the identifier,
setting the parameter.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="binding-identifierbridge-parameters-custom-annotation"><a class="anchor" href="#binding-identifierbridge-parameters-custom-annotation"></a><a id="mapper-orm-bridge-identifierbridge-parameters-custom-annotation"></a> Parameters with custom annotations</h5>
<div class="paragraph">
<p>You can pass parameters of any type to the bridge by defining
a <a href="#mapping-custom-annotations">custom annotation</a> with attributes:</p>
</div>
<div class="exampleblock">
<div class="title">Example 103. Passing parameters to an <code>IdentifierBridge</code> using a custom annotation</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="directive">public</span> <span class="type">class</span> <span class="class">OffsetIdentifierBridge</span> <span class="directive">implements</span> IdentifierBridge&lt;<span class="predefined-type">Integer</span>&gt; { <i class="conum" data-value="1"></i><b>(1)</b>

    <span class="directive">private</span> <span class="directive">final</span> <span class="type">int</span> offset;

    <span class="directive">public</span> OffsetIdentifierBridge(<span class="type">int</span> offset) { <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="local-variable">this</span>.offset = offset;
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="predefined-type">String</span> toDocumentIdentifier(<span class="predefined-type">Integer</span> propertyValue, IdentifierBridgeToDocumentIdentifierContext context) {
        <span class="keyword">return</span> <span class="predefined-type">String</span>.valueOf( propertyValue + offset );
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="predefined-type">Integer</span> fromDocumentIdentifier(<span class="predefined-type">String</span> documentIdentifier,
            IdentifierBridgeFromDocumentIdentifierContext context) {
        <span class="keyword">return</span> <span class="predefined-type">Integer</span>.parseInt( documentIdentifier ) - offset;
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Implement a bridge that index the identifier as is,
but adds a configurable offset,
For example, with an offset of 1 and database identifiers starting at 0, index identifiers will start at 1.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The bridge accepts one parameter in its constructors:
the offset to apply to identifiers.</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="annotation">@Retention</span>(<span class="predefined-type">RetentionPolicy</span>.RUNTIME) <i class="conum" data-value="1"></i><b>(1)</b>
<span class="annotation">@Target</span>({ <span class="predefined-type">ElementType</span>.METHOD, <span class="predefined-type">ElementType</span>.FIELD }) <i class="conum" data-value="2"></i><b>(2)</b>
<span class="annotation">@PropertyMapping</span>(processor = <span class="annotation">@PropertyMappingAnnotationProcessorRef</span>( <i class="conum" data-value="3"></i><b>(3)</b>
        type = OffsetDocumentId.Processor.class
))
<span class="annotation">@Documented</span> <i class="conum" data-value="4"></i><b>(4)</b>
<span class="directive">public</span> <span class="annotation">@interface</span> OffsetDocumentId {

    <span class="type">int</span> offset(); <i class="conum" data-value="5"></i><b>(5)</b>

    <span class="type">class</span> <span class="class">Processor</span> <i class="conum" data-value="6"></i><b>(6)</b>
            <span class="directive">implements</span> PropertyMappingAnnotationProcessor&lt;OffsetDocumentId&gt; { <i class="conum" data-value="7"></i><b>(7)</b>
        <span class="annotation">@Override</span>
        <span class="directive">public</span> <span class="type">void</span> process(PropertyMappingStep mapping, OffsetDocumentId annotation,
                PropertyMappingAnnotationProcessorContext context) {
            OffsetIdentifierBridge bridge = <span class="keyword">new</span> OffsetIdentifierBridge( <i class="conum" data-value="8"></i><b>(8)</b>
                    annotation.offset()
            );
            mapping.documentId() <i class="conum" data-value="9"></i><b>(9)</b>
                    .identifierBridge( bridge ); <i class="conum" data-value="10"></i><b>(10)</b>
        }
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Define an annotation with <code>RUNTIME</code> retention.
<strong>Any other retention policy will cause the annotation to be ignored by Hibernate Search</strong>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Since we&#8217;re defining an identifier bridge, allow the annotation
to target either methods (getters) or fields.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Mark this annotation as a property mapping,
and instruct Hibernate Search to apply the given processor whenever it finds this annotation.
It is also possible to reference the processor by its CDI/Spring bean name.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Optionally, mark the annotation as documented,
so that it is included in the javadoc of your entities.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Define custom attributes to configure the value bridge.
Here we define an offset that the bridge should add to entity identifiers.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Here the processor class is nested in the annotation class,
because it is more convenient,
but you are obviously free to implement it in a separate Java file.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>The processor must implement the <code>PropertyMappingAnnotationProcessor</code> interface,
setting its generic type argument to the type of the corresponding annotation.</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>In the <code>process</code> method, instantiate the bridge
and pass the annotation attribute as constructor argument.</td>
</tr>
<tr>
<td><i class="conum" data-value="9"></i><b>9</b></td>
<td>Declare that this property is to be used to generate the document identifier.</td>
</tr>
<tr>
<td><i class="conum" data-value="10"></i><b>10</b></td>
<td>Instruct Hibernate Search to use our bridge to convert between the property and the document identifiers.
Alternatively, we could pass an identifier binder instead,
using the <code>identifierBinder()</code> method.</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="annotation">@Entity</span>
<span class="annotation">@Indexed</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">Book</span> {

    <span class="annotation">@Id</span>
    <span class="comment">// DB identifiers start at 0, but index identifiers start at 1</span>
    <span class="annotation">@OffsetDocumentId</span>(offset = <span class="integer">1</span>) <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="directive">private</span> <span class="predefined-type">Integer</span> id;

    <span class="directive">private</span> <span class="predefined-type">String</span> title;

    <span class="comment">// Getters and setters</span>
    <span class="comment">// ...</span>

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Apply the bridge using its custom annotation,
setting the parameter.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="binding-identifierbridge-access-orm"><a class="anchor" href="#binding-identifierbridge-access-orm"></a>12.5.6. <a id="mapper-orm-bridge-identifierbridge-access-orm"></a> Accessing the ORM session or session factory from the bridge</h4>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This feature is only available with the <a href="#mapper-orm">Hibernate ORM integration</a>.</p>
</div>
<div class="paragraph">
<p>It <strong>cannot</strong> be used with the <a href="#mapper-pojo-standalone">Standalone POJO Mapper</a> in particular.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Contexts passed to the bridge methods can be used to retrieve the Hibernate ORM session or session factory.</p>
</div>
<div class="exampleblock">
<div class="title">Example 104. Retrieving the ORM session or session factory from an <code>IdentifierBridge</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="directive">public</span> <span class="type">class</span> <span class="class">MyDataIdentifierBridge</span> <span class="directive">implements</span> IdentifierBridge&lt;MyData&gt; {

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="predefined-type">String</span> toDocumentIdentifier(MyData propertyValue, IdentifierBridgeToDocumentIdentifierContext context) {
        SessionFactory sessionFactory = context.extension( HibernateOrmExtension.get() ) <i class="conum" data-value="1"></i><b>(1)</b>
                .sessionFactory(); <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="comment">// ... do something with the factory ...</span>
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> MyData fromDocumentIdentifier(<span class="predefined-type">String</span> documentIdentifier,
            IdentifierBridgeFromDocumentIdentifierContext context) {
        Session session = context.extension( HibernateOrmExtension.get() ) <i class="conum" data-value="3"></i><b>(3)</b>
                .session(); <i class="conum" data-value="4"></i><b>(4)</b>
        <span class="comment">// ... do something with the session ...</span>
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Apply an extension to the context to access content specific to Hibernate ORM.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Retrieve the <code>SessionFactory</code> from the extended context.
The <code>Session</code> is not available here.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Apply an extension to the context to access content specific to Hibernate ORM.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Retrieve the <code>Session</code> from the extended context.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="binding-identifierbridge-injecting-beans"><a class="anchor" href="#binding-identifierbridge-injecting-beans"></a>12.5.7. <a id="mapper-orm-bridge-identifierbridge-injecting-beans"></a> <a id="_injecting_beans_into_the_bridge_or_binder"></a> Injecting beans into the bridge or binder</h4>
<div class="paragraph">
<p>With <a href="#configuration-bean-frameworks">compatible frameworks</a>,
Hibernate Search supports injection of beans into both the <code>IdentifierBridge</code> and the <code>IdentifierBinder</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This only applies to beans instantiated
through Hibernate Search&#8217;s <a href="#configuration-bean-resolution">bean resolution</a>.
As a rule of thumb, if you need to call <code>new MyBridge()</code> explicitly at some point,
the bridge won&#8217;t get auto-magically injected.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The context passed to the identifier binder&#8217;s <code>bind</code> method
also exposes a <code>beanResolver()</code> method to access the bean resolver and instantiate beans explicitly.</p>
</div>
<div class="paragraph">
<p>See <a href="#configuration-bean-injection"> Bean injection</a> for more details.</p>
</div>
</div>
<div class="sect3">
<h4 id="binding-identifierbridge-programmatic"><a class="anchor" href="#binding-identifierbridge-programmatic"></a>12.5.8. <a id="mapper-orm-bridge-identifierbridge-programmatic"></a> Programmatic mapping</h4>
<div class="paragraph">
<p>You can apply an identifier bridge through the <a href="#mapping-programmatic">programmatic mapping</a> too.
Just pass an instance of the bridge.</p>
</div>
<div class="exampleblock">
<div class="title">Example 105. Applying an <code>IdentifierBridge</code> with <code>.identifierBridge(&#8230;&#8203;)</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">TypeMappingStep bookMapping = mapping.type( <span class="predefined-type">Book</span>.class );
bookMapping.indexed();
bookMapping.property( <span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span> )
        .documentId().identifierBridge( <span class="keyword">new</span> BookIdBridge() );</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Similarly, you can pass a binder instance:</p>
</div>
<div class="exampleblock">
<div class="title">Example 106. Applying an <code>IdentifierBinder</code> with <code>.identifierBinder(&#8230;&#8203;)</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">TypeMappingStep bookMapping = mapping.type( <span class="predefined-type">Book</span>.class );
bookMapping.indexed();
bookMapping.property( <span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span> )
        .documentId().identifierBinder( <span class="keyword">new</span> BookIdBinder() );</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="binding-identifierbridge-incubating"><a class="anchor" href="#binding-identifierbridge-incubating"></a>12.5.9. <a id="mapper-orm-bridge-identifierbridge-incubating"></a> Incubating features</h4>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Features detailed below are <em>incubating</em>: they are still under active development.</p>
</div>
<div class="paragraph">
<p>The usual <a href="https://hibernate.org/community/compatibility-policy/">compatibility policy</a> does not apply:
the contract of incubating elements (e.g. types, methods, configuration properties, etc.)
may be altered in a backward-incompatible way&#8201;&#8212;&#8201;or even removed&#8201;&#8212;&#8201;in subsequent releases.</p>
</div>
<div class="paragraph">
<p>You are encouraged to use incubating features so the development team can get feedback and improve them,
but you should be prepared to update code which relies on them as needed.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The context passed to the identifier binder&#8217;s <code>bind</code> method
exposes a <code>bridgedElement()</code> method that gives access to metadata about the value being bound,
in particular its type.</p>
</div>
<div class="paragraph">
<p>See the javadoc for more information.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="binding-routingbridge"><a class="anchor" href="#binding-routingbridge"></a>12.6. <a id="mapper-orm-bridge-routingbridge"></a> <a id="mapper-orm-bridge-routingkeybridge"></a> Routing bridge</h3>
<div class="sect3">
<h4 id="binding-routingbridge-basics"><a class="anchor" href="#binding-routingbridge-basics"></a>12.6.1. <a id="mapper-orm-bridge-routingbridge-basics"></a> Basics</h4>
<div class="paragraph">
<p>A routing bridge is a pluggable component that defines, at runtime,
whether an entity should be indexed and <a href="#concepts-sharding-routing">to which shard the corresponding indexed document should be routed</a>.
It is applied to an indexed entity type with the <code>@Indexed</code> annotation,
using its <code>routingBinder</code> attribute (<code>@Indexed(routingBinder = &#8230;&#8203;)</code>).</p>
</div>
<div class="paragraph">
<p>Implementing a routing bridge requires two components:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>A custom implementation of <code>RoutingBinder</code>, to bind the bridge to an indexed entity type at bootstrap.
This involves declaring the properties of the indexed entity type that will be used by the routing bridge
and instantiating the routing bridge.</p>
</li>
<li>
<p>A custom implementation of <code>RoutingBridge</code>, to route entities to the index at runtime.
This involves extracting data from an instance of the type, transforming the data if necessary,
and defining the current route (or marking the entity as "not indexed").</p>
<div class="paragraph">
<p>If routing can change during the lifetime of an entity instance,
you will also need to define the potential previous routes,
so that Hibernate Search can find and delete previous documents indexed for this entity instance.</p>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>In the sections below, you will find examples for the main use cases:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#binding-routingbridge-conditionalindexing">  Using a routing bridge for conditional indexing</a></p>
</li>
<li>
<p><a href="#binding-routingbridge-routingkey"> Using a routing bridge to control routing to index shards</a></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="binding-routingbridge-conditionalindexing"><a class="anchor" href="#binding-routingbridge-conditionalindexing"></a>12.6.2. <a id="mapper-orm-bridge-routingbridge-conditionalindexing"></a> <a id="example-search-mapping-indexinginterceptor-blog"></a> Using a routing bridge for conditional indexing</h4>
<div class="paragraph">
<p>Below is a first example of a custom routing bridge that
disables indexing for instances of the <code>Book</code> class if their status is <code>ARCHIVED</code>.</p>
</div>
<div class="exampleblock">
<div class="title">Example 107. Implementing and using a <code>RoutingBridge</code> for conditional indexing</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="directive">public</span> <span class="type">class</span> <span class="class">BookStatusRoutingBinder</span> <span class="directive">implements</span> RoutingBinder { <i class="conum" data-value="1"></i><b>(1)</b>

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> bind(RoutingBindingContext context) { <i class="conum" data-value="2"></i><b>(2)</b>
        context.dependencies() <i class="conum" data-value="3"></i><b>(3)</b>
                .use( <span class="string"><span class="delimiter">&quot;</span><span class="content">status</span><span class="delimiter">&quot;</span></span> );

        context.bridge( <i class="conum" data-value="4"></i><b>(4)</b>
                <span class="predefined-type">Book</span>.class, <i class="conum" data-value="5"></i><b>(5)</b>
                <span class="keyword">new</span> Bridge() <i class="conum" data-value="6"></i><b>(6)</b>
        );
    }

    <span class="comment">// ... class continues below</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The binder must implement the <code>RoutingBinder</code> interface.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Implement the <code>bind</code> method in the binder.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Declare the dependencies of the bridge,
i.e. the parts of the entity instances that the bridge will actually use.
See <a href="#binding-bridgedelement-dependencies"> Declaring dependencies to bridged elements</a>
for more information about declaring dependencies.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Call <code>context.bridge(&#8230;&#8203;)</code> to define the routing bridge to use.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Pass the expected type of indexed entities.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Pass the routing bridge instance.</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">    <span class="comment">// ... class BookStatusRoutingBinder (continued)</span>

    <span class="directive">public</span> <span class="directive">static</span> <span class="type">class</span> <span class="class">Bridge</span> <i class="conum" data-value="1"></i><b>(1)</b>
            <span class="directive">implements</span> RoutingBridge&lt;<span class="predefined-type">Book</span>&gt; { <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="annotation">@Override</span>
        <span class="directive">public</span> <span class="type">void</span> route(DocumentRoutes routes, <span class="predefined-type">Object</span> entityIdentifier, <i class="conum" data-value="3"></i><b>(3)</b>
                <span class="predefined-type">Book</span> indexedEntity, RoutingBridgeRouteContext context) {
            <span class="keyword">switch</span> ( indexedEntity.getStatus() ) { <i class="conum" data-value="4"></i><b>(4)</b>
                <span class="keyword">case</span> PUBLISHED:
                    routes.addRoute(); <i class="conum" data-value="5"></i><b>(5)</b>
                    <span class="keyword">break</span>;
                <span class="keyword">case</span> ARCHIVED:
                    routes.notIndexed(); <i class="conum" data-value="6"></i><b>(6)</b>
                    <span class="keyword">break</span>;
            }
        }

        <span class="annotation">@Override</span>
        <span class="directive">public</span> <span class="type">void</span> previousRoutes(DocumentRoutes routes, <span class="predefined-type">Object</span> entityIdentifier, <i class="conum" data-value="7"></i><b>(7)</b>
                <span class="predefined-type">Book</span> indexedEntity, RoutingBridgeRouteContext context) {
            routes.addRoute(); <i class="conum" data-value="8"></i><b>(8)</b>
        }
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Here the bridge class is nested in the binder class,
because it is more convenient,
but you are obviously free to implement it as you wish:
as a lambda expression, in a separate Java file&#8230;&#8203;</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The bridge must implement the <code>RoutingBridge</code> interface.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Implement the <code>route(&#8230;&#8203;)</code> method in the bridge.
This method is called on indexing.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Extract data from the bridged element and inspect it.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>If the <code>Book</code> status is <code>PUBLISHED</code>, then we want to proceed with indexing:
add a route so that Hibernate Search indexes the entity as usual.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>If the <code>Book</code> status is <code>ARCHIVED</code>, then we don&#8217;t want to index it:
call <code>notIndexed()</code> so that Hibernate Search knows it should <strong>not</strong> index the entity.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>When a book gets archived, there might be a previously indexed document that needs to be deleted.
The <code>previousRoutes(&#8230;&#8203;)</code> method allows you to tell Hibernate Search where this document can possibly be.
When necessary, Hibernate Search will follow each given route, look for documents corresponding to this entity,
and delete them.</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>In this case, routing is very simple: there is only one possible previous route, so we only register that route.</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="annotation">@Entity</span>
<span class="annotation">@Indexed</span>(routingBinder = <span class="annotation">@RoutingBinderRef</span>(type = BookStatusRoutingBinder.class)) <i class="conum" data-value="1"></i><b>(1)</b>
<span class="directive">public</span> <span class="type">class</span> <span class="class">Book</span> {

    <span class="annotation">@Id</span>
    <span class="directive">private</span> <span class="predefined-type">Integer</span> id;

    <span class="directive">private</span> <span class="predefined-type">String</span> title;

    <span class="annotation">@Basic</span>(optional = <span class="predefined-constant">false</span>)
    <span class="annotation">@KeywordField</span> <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="directive">private</span> Status status;

    <span class="comment">// Getters and setters</span>
    <span class="comment">// ...</span>

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Apply the bridge using the <code>@Indexed</code> annotation.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Properties used in the bridge can still be mapped as index fields, but they don&#8217;t have to be.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="binding-routingbridge-routingkey"><a class="anchor" href="#binding-routingbridge-routingkey"></a>12.6.3. <a id="mapper-orm-bridge-routingbridge-routingkey"></a> Using a routing bridge to control routing to index shards</h4>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>For a preliminary introduction to sharding,
including how it works in Hibernate Search and what its limitations are,
see <a href="#concepts-sharding-routing">Sharding and routing</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Routing bridges can also be used to control <a href="#concepts-sharding-routing">routing to index shards</a>.</p>
</div>
<div class="paragraph">
<p>Below is an example of a custom routing bridge that
uses the <code>genre</code> property of the <code>Book</code> class as a routing key.
See <a href="#search-dsl-query-routing"> Routing</a> for an example of how to use routing in search queries,
with the same mapping as the example below.</p>
</div>
<div class="exampleblock">
<div class="title">Example 108. Implementing and using a <code>RoutingBridge</code> to control routing to index shards</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="directive">public</span> <span class="type">class</span> <span class="class">BookGenreRoutingBinder</span> <span class="directive">implements</span> RoutingBinder { <i class="conum" data-value="1"></i><b>(1)</b>

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> bind(RoutingBindingContext context) { <i class="conum" data-value="2"></i><b>(2)</b>
        context.dependencies() <i class="conum" data-value="3"></i><b>(3)</b>
                .use( <span class="string"><span class="delimiter">&quot;</span><span class="content">genre</span><span class="delimiter">&quot;</span></span> );

        context.bridge( <i class="conum" data-value="4"></i><b>(4)</b>
                <span class="predefined-type">Book</span>.class, <i class="conum" data-value="5"></i><b>(5)</b>
                <span class="keyword">new</span> Bridge() <i class="conum" data-value="6"></i><b>(6)</b>
        );
    }

    <span class="comment">// ... class continues below</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The binder must implement the <code>RoutingBinder</code> interface.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Implement the <code>bind</code> method in the binder.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Declare the dependencies of the bridge,
i.e. the parts of the entity instances that the bridge will actually use.
See <a href="#binding-bridgedelement-dependencies"> Declaring dependencies to bridged elements</a>
for more information about declaring dependencies.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Call <code>context.bridge(&#8230;&#8203;)</code> to define the routing bridge to use.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Pass the expected type of indexed entities.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Pass the routing bridge instance.</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">    <span class="comment">// ... class BookGenreRoutingBinder (continued)</span>

    <span class="directive">public</span> <span class="directive">static</span> <span class="type">class</span> <span class="class">Bridge</span> <span class="directive">implements</span> RoutingBridge&lt;<span class="predefined-type">Book</span>&gt; { <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="annotation">@Override</span>
        <span class="directive">public</span> <span class="type">void</span> route(DocumentRoutes routes, <span class="predefined-type">Object</span> entityIdentifier, <i class="conum" data-value="2"></i><b>(2)</b>
                <span class="predefined-type">Book</span> indexedEntity, RoutingBridgeRouteContext context) {
            <span class="predefined-type">String</span> routingKey = indexedEntity.getGenre().name(); <i class="conum" data-value="3"></i><b>(3)</b>
            routes.addRoute().routingKey( routingKey ); <i class="conum" data-value="4"></i><b>(4)</b>
        }

        <span class="annotation">@Override</span>
        <span class="directive">public</span> <span class="type">void</span> previousRoutes(DocumentRoutes routes, <span class="predefined-type">Object</span> entityIdentifier, <i class="conum" data-value="5"></i><b>(5)</b>
                <span class="predefined-type">Book</span> indexedEntity, RoutingBridgeRouteContext context) {
            <span class="keyword">for</span> ( Genre possiblePreviousGenre : Genre.values() ) {
                <span class="predefined-type">String</span> routingKey = possiblePreviousGenre.name();
                routes.addRoute().routingKey( routingKey ); <i class="conum" data-value="6"></i><b>(6)</b>
            }
        }
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The bridge must implement the <code>RoutingBridge</code> interface.
Here the bridge class is nested in the binder class,
because it is more convenient,
but you are obviously free to implement it in a separate java file.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Implement the <code>route(&#8230;&#8203;)</code> method in the bridge.
This method is called on indexing.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Extract data from the bridged element and derive a routing key.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Add a route with the generated routing key.
Hibernate Search will follow this route when adding/updating/deleting the entity in the index.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>When the genre of a book changes, the route will change,
and there it might be a previously indexed document in the index that needs to be deleted.
The <code>previousRoutes(&#8230;&#8203;)</code> method allows you to tell Hibernate Search where this document can possibly be.
When necessary, Hibernate Search will follow each given route, look for documents corresponding to this entity,
and delete them.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>In this case, we simply don&#8217;t know what the previous genre of the book was,
so we tell Hibernate Search to follow all possible routes,
one for every possible genre.</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="annotation">@Entity</span>
<span class="annotation">@Indexed</span>(routingBinder = <span class="annotation">@RoutingBinderRef</span>(type = BookGenreRoutingBinder.class)) <i class="conum" data-value="1"></i><b>(1)</b>
<span class="directive">public</span> <span class="type">class</span> <span class="class">Book</span> {

    <span class="annotation">@Id</span>
    <span class="directive">private</span> <span class="predefined-type">Integer</span> id;

    <span class="directive">private</span> <span class="predefined-type">String</span> title;

    <span class="annotation">@Basic</span>(optional = <span class="predefined-constant">false</span>)
    <span class="annotation">@KeywordField</span> <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="directive">private</span> Genre genre;

    <span class="comment">// Getters and setters</span>
    <span class="comment">// ...</span>

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Apply the bridge using the <code>@Indexed</code> annotation.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Properties used in the bridge can still be mapped as index fields, but they don&#8217;t have to be.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Optimizing <code>previousRoutes(&#8230;&#8203;)</code></div>
<div class="paragraph">
<p>In some cases you might have more information than in the example above about the previous routes,
and you can take advantage of that information to trigger fewer deletions in the index:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If the routing key is derived from an immutable property,
then you can be sure the route never changes.
In that case, just call <code>route(&#8230;&#8203;)</code> with the arguments passed to <code>previousRoutes(&#8230;&#8203;)</code>
to tell Hibernate Search that the previous route is the same as the current route,
and Hibernate Search will skip the deletion.</p>
</li>
<li>
<p>If the routing key is derived from a property that changes in a predictable way,
e.g. a status that <strong>always</strong> goes from <code>DRAFT</code> to <code>PUBLISHED</code> to <code>ARCHIVED</code> and never goes back,
then you can be sure the previous routes are those corresponding to the possible previous values.
In that case, just add one route for each possible previous status,
e.g. if the current status is <code>PUBLISHED</code> you only need to add a route for <code>DRAFT</code> and <code>PUBLISHED</code>,
but not for <code>ARCHIVED</code>.</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="binding-routingbridge-parameters"><a class="anchor" href="#binding-routingbridge-parameters"></a>12.6.4. <a id="mapper-orm-bridge-routingbridge-parameters"></a> <a id="mapper-orm-bridge-routingkeybridge-parameters"></a> Passing parameters</h4>
<div class="paragraph">
<p>There are two ways to pass parameters to routing bridges:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>One is (mostly) limited to string parameters, but is trivial to implement.</p>
</li>
<li>
<p>The other can allow any type of parameters, but requires you to declare your own annotations.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Refer to <a href="#binding-typebridge-parameters">this example for <code>TypeBinder</code></a>,
which is fairly similar to what you&#8217;ll need for a <code>RoutingBinder</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="binding-routingbridge-access-orm"><a class="anchor" href="#binding-routingbridge-access-orm"></a>12.6.5. <a id="mapper-orm-bridge-routingbridge-ormsession"></a> Accessing the ORM session from the bridge</h4>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This feature is only available with the <a href="#mapper-orm">Hibernate ORM integration</a>.</p>
</div>
<div class="paragraph">
<p>It <strong>cannot</strong> be used with the <a href="#mapper-pojo-standalone">Standalone POJO Mapper</a> in particular.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Contexts passed to the bridge methods can be used to retrieve the Hibernate ORM session.</p>
</div>
<div class="exampleblock">
<div class="title">Example 109. Retrieving the ORM session from a <code>RoutingBridge</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="directive">private</span> <span class="directive">static</span> <span class="type">class</span> <span class="class">Bridge</span> <span class="directive">implements</span> RoutingBridge&lt;MyEntity&gt; {

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> route(DocumentRoutes routes, <span class="predefined-type">Object</span> entityIdentifier, MyEntity indexedEntity,
            RoutingBridgeRouteContext context) {
        Session session = context.extension( HibernateOrmExtension.get() ) <i class="conum" data-value="1"></i><b>(1)</b>
                .session(); <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="comment">// ... do something with the session ...</span>
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> previousRoutes(DocumentRoutes routes, <span class="predefined-type">Object</span> entityIdentifier, MyEntity indexedEntity,
            RoutingBridgeRouteContext context) {
        <span class="comment">// ...</span>
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Apply an extension to the context to access content specific to Hibernate ORM.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Retrieve the <code>Session</code> from the extended context.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="binding-routingbridge-injection"><a class="anchor" href="#binding-routingbridge-injection"></a>12.6.6. <a id="mapper-orm-bridge-routingbridge-injection"></a> Injecting beans into the binder</h4>
<div class="paragraph">
<p>With <a href="#configuration-bean-frameworks">compatible frameworks</a>,
Hibernate Search supports injecting beans into:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the <code>TypeMappingAnnotationProcessor</code> if you use <a href="#binding-routingbridge-parameters">custom annotations</a>.</p>
</li>
<li>
<p>the <code>RoutingBinder</code> if you use <a href="#binding-routingbridge-basics"><code>@Indexed(routingBinder = &#8230;&#8203;)</code></a>.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This only applies to beans instantiated
through Hibernate Search&#8217;s <a href="#configuration-bean-resolution">bean resolution</a>.
As a rule of thumb, if you need to call <code>new MyBinder()</code> explicitly at some point,
the binder won&#8217;t get auto-magically injected.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The context passed to the routing binder&#8217;s <code>bind</code> method
also exposes a <code>beanResolver()</code> method to access the bean resolver and instantiate beans explicitly.</p>
</div>
<div class="paragraph">
<p>See <a href="#configuration-bean-injection"> Bean injection</a> for more details.</p>
</div>
</div>
<div class="sect3">
<h4 id="binding-routingbridge-programmatic"><a class="anchor" href="#binding-routingbridge-programmatic"></a>12.6.7. <a id="mapper-orm-bridge-routingbridge-programmatic"></a> <a id="mapper-orm-bridge-routingkeybridge-programmatic"></a> Programmatic mapping</h4>
<div class="paragraph">
<p>You can apply a routing key bridge through the <a href="#mapping-programmatic">programmatic mapping</a> too.
Just pass an instance of the binder.</p>
</div>
<div class="exampleblock">
<div class="title">Example 110. Applying an <code>RoutingBinder</code> with <code>.binder(&#8230;&#8203;)</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">TypeMappingStep bookMapping = mapping.type( <span class="predefined-type">Book</span>.class );
bookMapping.indexed()
        .routingBinder( <span class="keyword">new</span> BookStatusRoutingBinder() );
bookMapping.property( <span class="string"><span class="delimiter">&quot;</span><span class="content">status</span><span class="delimiter">&quot;</span></span> ).keywordField();</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="binding-routingbridge-incubating"><a class="anchor" href="#binding-routingbridge-incubating"></a>12.6.8. <a id="mapper-orm-bridge-routingbridge-incubating"></a> Incubating features</h4>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Features detailed below are <em>incubating</em>: they are still under active development.</p>
</div>
<div class="paragraph">
<p>The usual <a href="https://hibernate.org/community/compatibility-policy/">compatibility policy</a> does not apply:
the contract of incubating elements (e.g. types, methods, configuration properties, etc.)
may be altered in a backward-incompatible way&#8201;&#8212;&#8201;or even removed&#8201;&#8212;&#8201;in subsequent releases.</p>
</div>
<div class="paragraph">
<p>You are encouraged to use incubating features so the development team can get feedback and improve them,
but you should be prepared to update code which relies on them as needed.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The context passed to the routing binder&#8217;s <code>bind</code> method
exposes a <code>bridgedElement()</code> method that gives access to metadata about the type being bound.</p>
</div>
<div class="paragraph">
<p>The metadata can in particular be used to inspect the type in details:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Getting accessors to properties.</p>
</li>
<li>
<p>Detecting properties with markers.
Markers are applied by specific annotations carrying a <code>@MarkerBinding</code> meta-annotation.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>See the javadoc for more information.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="binding-bridgedelement-dependencies"><a class="anchor" href="#binding-bridgedelement-dependencies"></a>12.7. <a id="mapper-orm-bridge-bridgedelement-dependencies"></a> Declaring dependencies to bridged elements</h3>
<div class="sect3">
<h4 id="binding-bridgedelement-dependencies-basics"><a class="anchor" href="#binding-bridgedelement-dependencies-basics"></a>12.7.1. <a id="mapper-orm-bridge-bridgedelement-dependencies-basics"></a> Basics</h4>
<div class="paragraph">
<p>In order to keep the index synchronized,
Hibernate Search needs to be aware of all the entity properties that are used to produce indexed documents,
so that it can trigger reindexing when they change.</p>
</div>
<div class="paragraph">
<p>When using a <a href="#binding-typebridge">type bridge</a> or a <a href="#binding-propertybridge">property bridge</a>,
the bridge itself decides which entity properties to access during indexing.
Thus, it needs to let Hibernate Search know of its "dependencies" (the entity properties it may access).</p>
</div>
<div class="paragraph">
<p>This is done through a dedicated DSL, accessible from the <code>bind(&#8230;&#8203;)</code> method of <a href="#binding-typebridge"><code>TypeBinder</code></a>
and <a href="#binding-propertybridge"><code>PropertyBinder</code></a>.</p>
</div>
<div class="paragraph">
<p>Below is an example of a type binder that expects to be applied to the <code>ScientificPaper</code> type,
and declares a dependency to the paper author&#8217;s last name and first name.</p>
</div>
<div class="exampleblock">
<div class="title">Example 111. Declaring dependencies in a bridge</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="directive">public</span> <span class="type">class</span> <span class="class">AuthorFullNameBinder</span> <span class="directive">implements</span> TypeBinder {

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> bind(TypeBindingContext context) {
        context.dependencies() <i class="conum" data-value="1"></i><b>(1)</b>
                .use( <span class="string"><span class="delimiter">&quot;</span><span class="content">author.firstName</span><span class="delimiter">&quot;</span></span> ) <i class="conum" data-value="2"></i><b>(2)</b>
                .use( <span class="string"><span class="delimiter">&quot;</span><span class="content">author.lastName</span><span class="delimiter">&quot;</span></span> ); <i class="conum" data-value="3"></i><b>(3)</b>

        IndexFieldReference&lt;<span class="predefined-type">String</span>&gt; authorFullNameField = context.indexSchemaElement()
                .field( <span class="string"><span class="delimiter">&quot;</span><span class="content">authorFullName</span><span class="delimiter">&quot;</span></span>, f -&gt; f.asString().analyzer( <span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span> ) )
                .toReference();

        context.bridge( <span class="predefined-type">Book</span>.class, <span class="keyword">new</span> Bridge( authorFullNameField ) );
    }

    <span class="directive">private</span> <span class="directive">static</span> <span class="type">class</span> <span class="class">Bridge</span> <span class="directive">implements</span> TypeBridge&lt;<span class="predefined-type">Book</span>&gt; {

        <span class="comment">// ...</span>
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Start the declaration of dependencies.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Declare that the bridge will access the paper&#8217;s <code>author</code> property,
then the author&#8217;s <code>firstName</code> property.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Declare that the bridge will access the paper&#8217;s <code>author</code> property,
then the author&#8217;s <code>lastName</code> property.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>The above should be enough to get started, but if you want to know more,
here are a few facts about declaring dependencies.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Paths are relative to the bridged element</dt>
<dd>
<p>For example:</p>
<div class="ulist">
<ul>
<li>
<p>for a type bridge on type <code>ScientificPaper</code>, path <code>author</code> will refer to the value of property <code>author</code> on <code>ScientificPaper</code> instances.</p>
</li>
<li>
<p>for a property bridge on the property <code>author</code> of <code>ScientificPaper</code>,
path <code>name</code> will refer to the value of property <code>name</code> on <code>Author</code> instances.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Every component of given paths will be considered as a dependency</dt>
<dd>
<p>You do not need to declare any parent path.</p>
<div class="paragraph">
<p>For example, if the path <code>myProperty.someOtherProperty</code> is declared as used,
Hibernate Search will automatically assume that <code>myProperty</code> is also used.</p>
</div>
</dd>
<dt class="hdlist1">Only mutable properties need to be declared</dt>
<dd>
<p>If a property never, ever changes after the entity is first persisted,
then it will never trigger reindexing and Hibernate Search
does not need to know about the dependency.</p>
<div class="paragraph">
<p>If your bridge only relies on immutable properties,
see <a href="#binding-bridgedelement-dependencies-useRootOnly"> <code>useRootOnly()</code>: declaring no dependency at all</a>.</p>
</div>
</dd>
<dt class="hdlist1">Associations included in dependency paths need to have an inverse side</dt>
<dd>
<p>If you declare a dependency that crosses entity boundaries through an association,
and that association has no inverse side in the other entity, an exception will be thrown.</p>
<div class="paragraph">
<p>For example, when you declare a dependency to path <code>author.lastName</code>,
Hibernate Search infers that whenever the last name of an author changes,
its books need to be re-indexed.
Thus, when it detects an author&#8217;s last name changed, Hibernate Search will need to retrieve the books to reindex them.
That&#8217;s why the <code>author</code> association in entity <code>ScientificPaper</code> needs to have an inverse side in entity <code>Author</code>,
e.g. a <code>books</code> association.</p>
</div>
<div class="paragraph">
<p>See <a href="#mapping-reindexing"> Tuning when to trigger reindexing</a> for more information about these constraints and how to address non-trivial models.</p>
</div>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="binding-bridgedelement-dependencies-containers"><a class="anchor" href="#binding-bridgedelement-dependencies-containers"></a>12.7.2. <a id="mapper-orm-bridge-bridgedelement-dependencies-containers"></a> Traversing non-default containers (map keys, &#8230;&#8203;)</h4>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Features detailed below are <em>incubating</em>: they are still under active development.</p>
</div>
<div class="paragraph">
<p>The usual <a href="https://hibernate.org/community/compatibility-policy/">compatibility policy</a> does not apply:
the contract of incubating elements (e.g. types, methods, configuration properties, etc.)
may be altered in a backward-incompatible way&#8201;&#8212;&#8201;or even removed&#8201;&#8212;&#8201;in subsequent releases.</p>
</div>
<div class="paragraph">
<p>You are encouraged to use incubating features so the development team can get feedback and improve them,
but you should be prepared to update code which relies on them as needed.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>When a path element refers to a property of a container type (<code>List</code>, <code>Map</code>, <code>Optional</code>, &#8230;&#8203;),
the path will be implicitly resolved to elements of that container.
For example <code>someMap.otherObject</code> will resolve to the <code>otherObject</code> property
of the <em>values</em> (not the keys) of <code>someMap</code>.</p>
</div>
<div class="paragraph">
<p>If the default resolution is not what you need,
you can explicitly control how to traverse containers by passing <code>PojoModelPath</code> objects
instead of just strings:</p>
</div>
<div class="exampleblock">
<div class="title">Example 112. Declaring dependencies in a bridge with explicit container extractors</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="annotation">@Entity</span>
<span class="annotation">@Indexed</span>
<span class="annotation">@TypeBinding</span>(binder = <span class="annotation">@TypeBinderRef</span>(type = BookEditionsForSaleTypeBinder.class)) <i class="conum" data-value="1"></i><b>(1)</b>
<span class="directive">public</span> <span class="type">class</span> <span class="class">Book</span> {

    <span class="annotation">@Id</span>
    <span class="annotation">@GeneratedValue</span>
    <span class="directive">private</span> <span class="predefined-type">Integer</span> id;

    <span class="annotation">@FullTextField</span>(analyzer = <span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">private</span> <span class="predefined-type">String</span> title;

    <span class="annotation">@ElementCollection</span>
    <span class="annotation">@JoinTable</span>(
            name = <span class="string"><span class="delimiter">&quot;</span><span class="content">book_editionbyprice</span><span class="delimiter">&quot;</span></span>,
            joinColumns = <span class="annotation">@JoinColumn</span>(name = <span class="string"><span class="delimiter">&quot;</span><span class="content">book_id</span><span class="delimiter">&quot;</span></span>)
    )
    <span class="annotation">@MapKeyJoinColumn</span>(name = <span class="string"><span class="delimiter">&quot;</span><span class="content">edition_id</span><span class="delimiter">&quot;</span></span>)
    <span class="annotation">@Column</span>(name = <span class="string"><span class="delimiter">&quot;</span><span class="content">price</span><span class="delimiter">&quot;</span></span>)
    <span class="annotation">@OrderBy</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">edition_id asc</span><span class="delimiter">&quot;</span></span>)
    <span class="annotation">@AssociationInverseSide</span>(
            extraction = <span class="annotation">@ContainerExtraction</span>(BuiltinContainerExtractors.MAP_KEY),
            inversePath = <span class="annotation">@ObjectPath</span>(<span class="annotation">@PropertyValue</span>(propertyName = <span class="string"><span class="delimiter">&quot;</span><span class="content">book</span><span class="delimiter">&quot;</span></span>))
    )
    <span class="directive">private</span> <span class="predefined-type">Map</span>&lt;BookEdition, <span class="predefined-type">BigDecimal</span>&gt; priceByEdition = <span class="keyword">new</span> <span class="predefined-type">LinkedHashMap</span>&lt;&gt;(); <i class="conum" data-value="2"></i><b>(2)</b>

    <span class="directive">public</span> <span class="predefined-type">Book</span>() {
    }

    <span class="comment">// Getters and setters</span>
    <span class="comment">// ...</span>

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Apply a custom bridge to the <code>ScientificPaper</code> entity.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>This (rather complex) map is the one we&#8217;ll access in the custom bridge.</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="directive">public</span> <span class="type">class</span> <span class="class">BookEditionsForSaleTypeBinder</span> <span class="directive">implements</span> TypeBinder {

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> bind(TypeBindingContext context) {
        context.dependencies()
                .use( PojoModelPath.builder() <i class="conum" data-value="1"></i><b>(1)</b>
                        .property( <span class="string"><span class="delimiter">&quot;</span><span class="content">priceByEdition</span><span class="delimiter">&quot;</span></span> ) <i class="conum" data-value="2"></i><b>(2)</b>
                        .value( BuiltinContainerExtractors.MAP_KEY ) <i class="conum" data-value="3"></i><b>(3)</b>
                        .property( <span class="string"><span class="delimiter">&quot;</span><span class="content">label</span><span class="delimiter">&quot;</span></span> ) <i class="conum" data-value="4"></i><b>(4)</b>
                        .toValuePath() ); <i class="conum" data-value="5"></i><b>(5)</b>

        IndexFieldReference&lt;<span class="predefined-type">String</span>&gt; editionsForSaleField = context.indexSchemaElement()
                .field( <span class="string"><span class="delimiter">&quot;</span><span class="content">editionsForSale</span><span class="delimiter">&quot;</span></span>, f -&gt; f.asString().analyzer( <span class="string"><span class="delimiter">&quot;</span><span class="content">english</span><span class="delimiter">&quot;</span></span> ) )
                .multiValued()
                .toReference();

        context.bridge( <span class="predefined-type">Book</span>.class, <span class="keyword">new</span> Bridge( editionsForSaleField ) );
    }

    <span class="directive">private</span> <span class="directive">static</span> <span class="type">class</span> <span class="class">Bridge</span> <span class="directive">implements</span> TypeBridge&lt;<span class="predefined-type">Book</span>&gt; {

        <span class="directive">private</span> <span class="directive">final</span> IndexFieldReference&lt;<span class="predefined-type">String</span>&gt; editionsForSaleField;

        <span class="directive">private</span> Bridge(IndexFieldReference&lt;<span class="predefined-type">String</span>&gt; editionsForSaleField) {
            <span class="local-variable">this</span>.editionsForSaleField = editionsForSaleField;
        }

        <span class="annotation">@Override</span>
        <span class="directive">public</span> <span class="type">void</span> write(DocumentElement target, <span class="predefined-type">Book</span> book, TypeBridgeWriteContext context) {
            <span class="keyword">for</span> ( BookEdition edition : book.getPriceByEdition().keySet() ) { <i class="conum" data-value="6"></i><b>(6)</b>
                target.addValue( editionsForSaleField, edition.getLabel() );
            }
        }
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Start building a <code>PojoModelPath</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Append the <code>priceByEdition</code> property (a <code>Map</code>) to the path.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Explicitly mention that the bridge will access <em>keys</em> from the <code>priceByEdition</code> map&#8201;&#8212;&#8201;the paper editions.
Without this, Hibernate Search would have assumed that <em>values</em> are accessed.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Append the <code>label</code> property to the path. This is the <code>label</code> property in paper editions.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Create the path and pass it to <code>.use(&#8230;&#8203;)</code> to declare the dependency.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>This is the actual code that accesses the paths as declared above.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>For property binders applied to a container property,
you can control how to traverse the property itself
by passing a container extractor path as the first argument to <code>use(&#8230;&#8203;)</code>:</p>
</div>
<div class="exampleblock">
<div class="title">Example 113. Declaring dependencies in a bridge with explicit container extractors for the bridged property</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="annotation">@Entity</span>
<span class="annotation">@Indexed</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">Book</span> {

    <span class="annotation">@Id</span>
    <span class="annotation">@GeneratedValue</span>
    <span class="directive">private</span> <span class="predefined-type">Integer</span> id;

    <span class="annotation">@FullTextField</span>(analyzer = <span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">private</span> <span class="predefined-type">String</span> title;

    <span class="annotation">@ElementCollection</span>
    <span class="annotation">@JoinTable</span>(
            name = <span class="string"><span class="delimiter">&quot;</span><span class="content">book_editionbyprice</span><span class="delimiter">&quot;</span></span>,
            joinColumns = <span class="annotation">@JoinColumn</span>(name = <span class="string"><span class="delimiter">&quot;</span><span class="content">book_id</span><span class="delimiter">&quot;</span></span>)
    )
    <span class="annotation">@MapKeyJoinColumn</span>(name = <span class="string"><span class="delimiter">&quot;</span><span class="content">edition_id</span><span class="delimiter">&quot;</span></span>)
    <span class="annotation">@Column</span>(name = <span class="string"><span class="delimiter">&quot;</span><span class="content">price</span><span class="delimiter">&quot;</span></span>)
    <span class="annotation">@OrderBy</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">edition_id asc</span><span class="delimiter">&quot;</span></span>)
    <span class="annotation">@AssociationInverseSide</span>(
            extraction = <span class="annotation">@ContainerExtraction</span>(BuiltinContainerExtractors.MAP_KEY),
            inversePath = <span class="annotation">@ObjectPath</span>(<span class="annotation">@PropertyValue</span>(propertyName = <span class="string"><span class="delimiter">&quot;</span><span class="content">book</span><span class="delimiter">&quot;</span></span>))
    )
    <span class="annotation">@PropertyBinding</span>(binder = <span class="annotation">@PropertyBinderRef</span>(type = BookEditionsForSalePropertyBinder.class)) <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="directive">private</span> <span class="predefined-type">Map</span>&lt;BookEdition, <span class="predefined-type">BigDecimal</span>&gt; priceByEdition = <span class="keyword">new</span> <span class="predefined-type">LinkedHashMap</span>&lt;&gt;();

    <span class="directive">public</span> <span class="predefined-type">Book</span>() {
    }

    <span class="comment">// Getters and setters</span>
    <span class="comment">// ...</span>

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Apply a custom bridge to the <code>pricesByEdition</code> property of the <code>ScientificPaper</code> entity.</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="directive">public</span> <span class="type">class</span> <span class="class">BookEditionsForSalePropertyBinder</span> <span class="directive">implements</span> PropertyBinder {

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> bind(PropertyBindingContext context) {
        context.dependencies()
                .use( ContainerExtractorPath.explicitExtractor( BuiltinContainerExtractors.MAP_KEY ), <i class="conum" data-value="1"></i><b>(1)</b>
                        <span class="string"><span class="delimiter">&quot;</span><span class="content">label</span><span class="delimiter">&quot;</span></span> ); <i class="conum" data-value="2"></i><b>(2)</b>

        IndexFieldReference&lt;<span class="predefined-type">String</span>&gt; editionsForSaleField = context.indexSchemaElement()
                .field( <span class="string"><span class="delimiter">&quot;</span><span class="content">editionsForSale</span><span class="delimiter">&quot;</span></span>, f -&gt; f.asString().analyzer( <span class="string"><span class="delimiter">&quot;</span><span class="content">english</span><span class="delimiter">&quot;</span></span> ) )
                .multiValued()
                .toReference();

        context.bridge( <span class="predefined-type">Map</span>.class, <span class="keyword">new</span> Bridge( editionsForSaleField ) );
    }

    <span class="annotation">@SuppressWarnings</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">rawtypes</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">private</span> <span class="directive">static</span> <span class="type">class</span> <span class="class">Bridge</span> <span class="directive">implements</span> PropertyBridge&lt;<span class="predefined-type">Map</span>&gt; {

        <span class="directive">private</span> <span class="directive">final</span> IndexFieldReference&lt;<span class="predefined-type">String</span>&gt; editionsForSaleField;

        <span class="directive">private</span> Bridge(IndexFieldReference&lt;<span class="predefined-type">String</span>&gt; editionsForSaleField) {
            <span class="local-variable">this</span>.editionsForSaleField = editionsForSaleField;
        }

        <span class="annotation">@Override</span>
        <span class="directive">public</span> <span class="type">void</span> write(DocumentElement target, <span class="predefined-type">Map</span> bridgedElement, PropertyBridgeWriteContext context) {
            <span class="annotation">@SuppressWarnings</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">unchecked</span><span class="delimiter">&quot;</span></span>)
            <span class="predefined-type">Map</span>&lt;BookEdition, ?&gt; priceByEdition = (<span class="predefined-type">Map</span>&lt;BookEdition, ?&gt;) bridgedElement;

            <span class="keyword">for</span> ( BookEdition edition : priceByEdition.keySet() ) { <i class="conum" data-value="3"></i><b>(3)</b>
                target.addValue( editionsForSaleField, edition.getLabel() );
            }
        }
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Explicitly mention that the bridge will access <em>keys</em> from the <code>priceByEdition</code> property&#8201;&#8212;&#8201;the paper editions.
Without this, Hibernate Search would have assumed that <em>values</em> are accessed.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Declare a dependency to the <code>label</code> property in paper editions.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>This is the actual code that accesses the paths as declared above.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="binding-bridgedelement-dependencies-useRootOnly"><a class="anchor" href="#binding-bridgedelement-dependencies-useRootOnly"></a>12.7.3. <a id="mapper-orm-bridge-bridgedelement-dependencies-useRootOnly"></a> <code>useRootOnly()</code>: declaring no dependency at all</h4>
<div class="paragraph">
<p>If your bridge only accesses immutable properties,
then it&#8217;s safe to declare that its only dependency is to the root object.</p>
</div>
<div class="paragraph">
<p>To do so, call <code>.dependencies().useRootOnly()</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Without this call, Hibernate Search will suspect an oversight and will throw an exception on startup.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="binding-bridgedelement-dependencies-fromOtherEntity"><a class="anchor" href="#binding-bridgedelement-dependencies-fromOtherEntity"></a>12.7.4. <a id="mapper-orm-bridge-bridgedelement-dependencies-fromOtherEntity"></a> <code>fromOtherEntity(&#8230;&#8203;)</code>: declaring dependencies using the inverse path</h4>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Features detailed below are <em>incubating</em>: they are still under active development.</p>
</div>
<div class="paragraph">
<p>The usual <a href="https://hibernate.org/community/compatibility-policy/">compatibility policy</a> does not apply:
the contract of incubating elements (e.g. types, methods, configuration properties, etc.)
may be altered in a backward-incompatible way&#8201;&#8212;&#8201;or even removed&#8201;&#8212;&#8201;in subsequent releases.</p>
</div>
<div class="paragraph">
<p>You are encouraged to use incubating features so the development team can get feedback and improve them,
but you should be prepared to update code which relies on them as needed.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>It is not always possible to represent the dependency as a path
from the bridged element to the values accessed by the bridge.</p>
</div>
<div class="paragraph">
<p>In particular, when the bridge relies on other components (queries, services) to retrieve another entity,
there may not even be a path from the bridge element to that entity.
In this case, if there is an <em>inverse</em> path from the other entity to the bridged element,
and the bridged element is an entity,
you can simply declare the dependency from the other entity, as shown below.</p>
</div>
<div class="exampleblock">
<div class="title">Example 114. Declaring dependencies in a bridge using the inverse path</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="annotation">@Entity</span>
<span class="annotation">@Indexed</span>
<span class="annotation">@TypeBinding</span>(binder = <span class="annotation">@TypeBinderRef</span>(type = ScientificPapersReferencedByBinder.class)) <i class="conum" data-value="1"></i><b>(1)</b>
<span class="directive">public</span> <span class="type">class</span> <span class="class">ScientificPaper</span> {

    <span class="annotation">@Id</span>
    <span class="directive">private</span> <span class="predefined-type">Integer</span> id;

    <span class="directive">private</span> <span class="predefined-type">String</span> title;

    <span class="annotation">@ManyToMany</span>
    <span class="directive">private</span> <span class="predefined-type">List</span>&lt;ScientificPaper&gt; references = <span class="keyword">new</span> <span class="predefined-type">ArrayList</span>&lt;&gt;();

    <span class="directive">public</span> ScientificPaper() {
    }

    <span class="comment">// Getters and setters</span>
    <span class="comment">// ...</span>

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Apply a custom bridge to the <code>ScientificPaper</code> type.</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="directive">public</span> <span class="type">class</span> <span class="class">ScientificPapersReferencedByBinder</span> <span class="directive">implements</span> TypeBinder {

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> bind(TypeBindingContext context) {
        context.dependencies()
                .fromOtherEntity( ScientificPaper.class, <span class="string"><span class="delimiter">&quot;</span><span class="content">references</span><span class="delimiter">&quot;</span></span> ) <i class="conum" data-value="1"></i><b>(1)</b>
                .use( <span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span> ); <i class="conum" data-value="2"></i><b>(2)</b>

        IndexFieldReference&lt;<span class="predefined-type">String</span>&gt; papersReferencingThisOneField = context.indexSchemaElement()
                .field( <span class="string"><span class="delimiter">&quot;</span><span class="content">referencedBy</span><span class="delimiter">&quot;</span></span>, f -&gt; f.asString().analyzer( <span class="string"><span class="delimiter">&quot;</span><span class="content">english</span><span class="delimiter">&quot;</span></span> ) )
                .multiValued()
                .toReference();

        context.bridge( ScientificPaper.class, <span class="keyword">new</span> Bridge( papersReferencingThisOneField ) );
    }

    <span class="directive">private</span> <span class="directive">static</span> <span class="type">class</span> <span class="class">Bridge</span> <span class="directive">implements</span> TypeBridge&lt;ScientificPaper&gt; {

        <span class="directive">private</span> <span class="directive">final</span> IndexFieldReference&lt;<span class="predefined-type">String</span>&gt; referencedByField;

        <span class="directive">private</span> Bridge(IndexFieldReference&lt;<span class="predefined-type">String</span>&gt; referencedByField) { <i class="conum" data-value="2"></i><b>(2)</b>
            <span class="local-variable">this</span>.referencedByField = referencedByField;
        }

        <span class="annotation">@Override</span>
        <span class="directive">public</span> <span class="type">void</span> write(DocumentElement target, ScientificPaper paper, TypeBridgeWriteContext context) {
            <span class="keyword">for</span> ( <span class="predefined-type">String</span> referencingPaperTitle : findReferencingPaperTitles( context, paper ) ) { <i class="conum" data-value="3"></i><b>(3)</b>
                target.addValue( referencedByField, referencingPaperTitle );
            }
        }

        <span class="directive">private</span> <span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt; findReferencingPaperTitles(TypeBridgeWriteContext context, ScientificPaper paper) {
            Session session = context.extension( HibernateOrmExtension.get() ).session();
            <span class="predefined-type">Query</span>&lt;<span class="predefined-type">String</span>&gt; query = session.createQuery(
                    <span class="string"><span class="delimiter">&quot;</span><span class="content">select p.title from ScientificPaper p where :this member of p.references</span><span class="delimiter">&quot;</span></span>,
                    <span class="predefined-type">String</span>.class );
            query.setParameter( <span class="string"><span class="delimiter">&quot;</span><span class="content">this</span><span class="delimiter">&quot;</span></span>, paper );
            <span class="keyword">return</span> query.list();
        }
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Declare that this bridge relies on other entities of type <code>ScientificPaper</code>,
and that those other entities reference the indexed entity through their <code>references</code> property.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Declare which parts of the other entities are actually used by the bridge.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The bridge retrieves the other entity through a query,
but then uses exclusively the parts that were declared previously.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Currently, dependencies declared this way will be ignored when the "other entity" gets deleted.</p>
</div>
<div class="paragraph">
<p>See <a href="https://hibernate.atlassian.net/browse/HSEARCH-3567">HSEARCH-3567</a> to track progress on solving this problem.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="binding-index-field-dsl"><a class="anchor" href="#binding-index-field-dsl"></a>12.8. <a id="mapper-orm-bridge-index-field-dsl"></a> Declaring and writing to index fields</h3>
<div class="sect3">
<h4 id="binding-index-field-dsl-basics"><a class="anchor" href="#binding-index-field-dsl-basics"></a>12.8.1. <a id="mapper-orm-bridge-index-field-dsl-basics"></a> Basics</h4>
<div class="paragraph">
<p>When implementing a <a href="#binding-propertybridge"><code>PropertyBinder</code></a>
or <a href="#binding-typebridge"><code>TypeBinder</code></a>,
it is necessary to declare the index fields that the bridge will contribute to.
This declaration is performed using a dedicated DSL.</p>
</div>
<div class="paragraph">
<p>The entry point to this DSL is the <code>IndexNode</code>,
which represents the part of the document structure that the binder will push data to.
From the <code>IndexNode</code>, it is possible to declare fields.</p>
</div>
<div class="paragraph">
<p>The declaration of each field yields a field <em>reference</em>.
This reference is to be stored in the bridge,
which will use it at runtime to set the value of this field in a given document,
represented by a <code>DocumentElement</code>.</p>
</div>
<div class="paragraph">
<p>Below is a simple example using the DSL to declare a single field in a property binder
and then write to that field in a property bridge.</p>
</div>
<div class="exampleblock">
<div class="title">Example 115. Declaring a simple index field and writing to that field</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="directive">public</span> <span class="type">class</span> <span class="class">ISBNBinder</span> <span class="directive">implements</span> PropertyBinder {

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> bind(PropertyBindingContext context) {
        context.dependencies()
                <span class="comment">/* ... (declaration of dependencies, not relevant) ... */</span>

        IndexSchemaElement schemaElement = context.indexSchemaElement(); <i class="conum" data-value="1"></i><b>(1)</b>

        IndexFieldReference&lt;<span class="predefined-type">String</span>&gt; field =
                schemaElement.field( <i class="conum" data-value="2"></i><b>(2)</b>
                        <span class="string"><span class="delimiter">&quot;</span><span class="content">isbn</span><span class="delimiter">&quot;</span></span>, <i class="conum" data-value="3"></i><b>(3)</b>
                        f -&gt; f.asString() <i class="conum" data-value="4"></i><b>(4)</b>
                                .normalizer( <span class="string"><span class="delimiter">&quot;</span><span class="content">isbn</span><span class="delimiter">&quot;</span></span> )
                )
                        .toReference(); <i class="conum" data-value="5"></i><b>(5)</b>

        context.bridge( <i class="conum" data-value="6"></i><b>(6)</b>
                ISBN.class, <i class="conum" data-value="7"></i><b>(7)</b>
                <span class="keyword">new</span> ISBNBridge( field ) <i class="conum" data-value="8"></i><b>(8)</b>
        );
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Get the <code>IndexNode</code>, the entry point to the index field declaration DSL.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Declare a field.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Pass the name of the field.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Declare the type of the field.
This is done through a lambda taking advantage of another DSL.
See <a href="#binding-index-field-type-dsl"> Defining index field types</a> for more information.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Get a reference to the declared field.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Call <code>context.bridge(&#8230;&#8203;)</code> to define the bridge to use.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Pass the expected type of values.</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>Pass the bridge instance.</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="directive">private</span> <span class="directive">static</span> <span class="type">class</span> <span class="class">ISBNBridge</span> <span class="directive">implements</span> PropertyBridge&lt;ISBN&gt; {

    <span class="directive">private</span> <span class="directive">final</span> IndexFieldReference&lt;<span class="predefined-type">String</span>&gt; fieldReference;

    <span class="directive">private</span> ISBNBridge(IndexFieldReference&lt;<span class="predefined-type">String</span>&gt; fieldReference) {
        <span class="local-variable">this</span>.fieldReference = fieldReference;
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> write(DocumentElement target, ISBN bridgedElement, PropertyBridgeWriteContext context) {
        <span class="predefined-type">String</span> indexedValue = <span class="comment">/* ... (extraction of data, not relevant) ... */</span>
        target.addValue( <span class="local-variable">this</span>.fieldReference, indexedValue ); <i class="conum" data-value="1"></i><b>(1)</b>
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>In the bridge, use the reference obtained above to add a value to the field for the current document.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="binding-index-field-dsl-type-objects"><a class="anchor" href="#binding-index-field-dsl-type-objects"></a>12.8.2. <a id="mapper-orm-bridge-index-field-dsl-type-objects"></a> <a id="_type_objects"></a> Type objects</h4>
<div class="paragraph">
<p>The lambda syntax to declare the type of each field is convenient,
but sometimes gets in the way,
in particular when multiple fields must be declared with the exact same type.</p>
</div>
<div class="paragraph">
<p>For that reason, the context object passed to binders exposes a <code>typeFactory()</code> method.
Using this factory, it is possible to build <code>IndexFieldType</code> objects
that can be re-used in multiple field declarations.</p>
</div>
<div class="exampleblock">
<div class="title">Example 116. Re-using an index field type in multiple field declarations</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="annotation">@Override</span>
<span class="directive">public</span> <span class="type">void</span> bind(TypeBindingContext context) {
    context.dependencies()
            <span class="comment">/* ... (declaration of dependencies, not relevant) ... */</span>

    IndexSchemaElement schemaElement = context.indexSchemaElement();

    IndexFieldType&lt;<span class="predefined-type">String</span>&gt; nameType = context.typeFactory() <i class="conum" data-value="1"></i><b>(1)</b>
            .asString() <i class="conum" data-value="2"></i><b>(2)</b>
            .analyzer( <span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span> )
            .toIndexFieldType(); <i class="conum" data-value="3"></i><b>(3)</b>

    context.bridge( Author.class, <span class="keyword">new</span> Bridge(
            schemaElement.field( <span class="string"><span class="delimiter">&quot;</span><span class="content">firstName</span><span class="delimiter">&quot;</span></span>, nameType ) <i class="conum" data-value="4"></i><b>(4)</b>
                    .toReference(),
            schemaElement.field( <span class="string"><span class="delimiter">&quot;</span><span class="content">lastName</span><span class="delimiter">&quot;</span></span>, nameType ) <i class="conum" data-value="4"></i><b>(4)</b>
                    .toReference(),
            schemaElement.field( <span class="string"><span class="delimiter">&quot;</span><span class="content">fullName</span><span class="delimiter">&quot;</span></span>, nameType ) <i class="conum" data-value="4"></i><b>(4)</b>
                    .toReference()
    ) );
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Get the type factory.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Define the type.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Get the resulting type.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Pass the type directly instead of using a lambda when defining the field.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="binding-index-field-dsl-multi-valued-fields"><a class="anchor" href="#binding-index-field-dsl-multi-valued-fields"></a>12.8.3. <a id="mapper-orm-bridge-index-field-dsl-multi-valued-fields"></a> <a id="_multi_valued_fields"></a> Multivalued fields</h4>
<div class="paragraph">
<p>Fields are considered single-valued by default:
if you attempt to add multiple values to a single-valued field during indexing,
an exception will be thrown.</p>
</div>
<div class="paragraph">
<p>In order to add multiple values to a field,
this field must be marked as multivalued during its declaration:</p>
</div>
<div class="exampleblock">
<div class="title">Example 117. Declaring a field as multivalued</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="annotation">@Override</span>
<span class="directive">public</span> <span class="type">void</span> bind(TypeBindingContext context) {
    context.dependencies()
            <span class="comment">/* ... (declaration of dependencies, not relevant) ... */</span>

    IndexSchemaElement schemaElement = context.indexSchemaElement();

    context.bridge( Author.class, <span class="keyword">new</span> Bridge(
            schemaElement.field( <span class="string"><span class="delimiter">&quot;</span><span class="content">names</span><span class="delimiter">&quot;</span></span>, f -&gt; f.asString().analyzer( <span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span> ) )
                    .multiValued() <i class="conum" data-value="1"></i><b>(1)</b>
                    .toReference()
    ) );
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Declare the field as multivalued.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="binding-index-field-dsl-object"><a class="anchor" href="#binding-index-field-dsl-object"></a>12.8.4. <a id="mapper-orm-bridge-index-field-dsl-object"></a> Object fields</h4>
<div class="paragraph">
<p>The previous sections only presented flat schemas with value fields,
but the index schema can actually be organized in a tree structure,
with two categories of index fields:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Value fields, often simply called "fields", which hold an atomic value of a specific type:
string, integer, date, &#8230;&#8203;</p>
</li>
<li>
<p>Object fields, which hold a composite value.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Object fields are declared similarly to value fields,
with an additional step to declare each subfield,
as shown below.</p>
</div>
<div class="exampleblock">
<div class="title">Example 118. Declaring an object field</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="annotation">@Override</span>
<span class="directive">public</span> <span class="type">void</span> bind(PropertyBindingContext context) {
    context.dependencies()
            <span class="comment">/* ... (declaration of dependencies, not relevant) ... */</span>

    IndexSchemaElement schemaElement = context.indexSchemaElement();

    IndexSchemaObjectField summaryField =
            schemaElement.objectField( <span class="string"><span class="delimiter">&quot;</span><span class="content">summary</span><span class="delimiter">&quot;</span></span> ); <i class="conum" data-value="1"></i><b>(1)</b>

    IndexFieldType&lt;<span class="predefined-type">BigDecimal</span>&gt; amountFieldType = context.typeFactory()
            .asBigDecimal().decimalScale( <span class="integer">2</span> )
            .toIndexFieldType();

    context.bridge( <span class="predefined-type">List</span>.class, <span class="keyword">new</span> Bridge(
            summaryField.toReference(), <i class="conum" data-value="2"></i><b>(2)</b>
            summaryField.field( <span class="string"><span class="delimiter">&quot;</span><span class="content">total</span><span class="delimiter">&quot;</span></span>, amountFieldType ) <i class="conum" data-value="3"></i><b>(3)</b>
                    .toReference(),
            summaryField.field( <span class="string"><span class="delimiter">&quot;</span><span class="content">books</span><span class="delimiter">&quot;</span></span>, amountFieldType ) <i class="conum" data-value="3"></i><b>(3)</b>
                    .toReference(),
            summaryField.field( <span class="string"><span class="delimiter">&quot;</span><span class="content">shipping</span><span class="delimiter">&quot;</span></span>, amountFieldType ) <i class="conum" data-value="3"></i><b>(3)</b>
                    .toReference()
    ) );
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Declare an object field with <code>objectField</code>, passing its name in parameter.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Get a reference to the declared object field
and pass it to the bridge for later use.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Create subfields, get references to these fields
and pass them to the bridge for later use.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The subfields of an object field can include object fields.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Just as value fields, object fields are single-valued by default.
Be sure to call <code>.multiValued()</code> during the object field definition
if you want to make it multivalued.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Object fields as well as their subfields are each assigned a reference,
which will be used by the bridge to write to documents,
as shown in the example below.</p>
</div>
<div class="exampleblock">
<div class="title">Example 119. Writing to an object field</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="annotation">@Override</span>
<span class="directive">public</span> <span class="type">void</span> write(DocumentElement target, <span class="predefined-type">List</span> bridgedElement, PropertyBridgeWriteContext context) {
    <span class="annotation">@SuppressWarnings</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">unchecked</span><span class="delimiter">&quot;</span></span>)
    <span class="predefined-type">List</span>&lt;InvoiceLineItem&gt; lineItems = (<span class="predefined-type">List</span>&lt;InvoiceLineItem&gt;) bridgedElement;

    <span class="predefined-type">BigDecimal</span> total = <span class="predefined-type">BigDecimal</span>.ZERO;
    <span class="predefined-type">BigDecimal</span> books = <span class="predefined-type">BigDecimal</span>.ZERO;
    <span class="predefined-type">BigDecimal</span> shipping = <span class="predefined-type">BigDecimal</span>.ZERO;
    <span class="comment">/* ... (computation of amounts, not relevant) ... */</span>

    DocumentElement summary = target.addObject( <span class="local-variable">this</span>.summaryField ); <i class="conum" data-value="1"></i><b>(1)</b>
    summary.addValue( <span class="local-variable">this</span>.totalField, total ); <i class="conum" data-value="2"></i><b>(2)</b>
    summary.addValue( <span class="local-variable">this</span>.booksField, books ); <i class="conum" data-value="2"></i><b>(2)</b>
    summary.addValue( <span class="local-variable">this</span>.shippingField, shipping ); <i class="conum" data-value="2"></i><b>(2)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Add an object to the <code>summary</code> object field for the current document,
and get a reference to that object.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Add a value to the subfields for the object we just added.
Note we&#8217;re calling <code>addValue</code> on the object we just added, not on <code>target</code>.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="binding-index-field-dsl-object-structure"><a class="anchor" href="#binding-index-field-dsl-object-structure"></a>12.8.5. <a id="mapper-orm-bridge-index-field-dsl-object-structure"></a> <a id="_object_structure"></a> Object structure</h4>
<div class="paragraph">
<p>By default, object fields are flattened,
meaning that the tree structure is not preserved.
See <a href="#mapping-indexedembedded-structure-flattened">  <code>DEFAULT</code> or <code>FLATTENED</code> structure</a> for more information.</p>
</div>
<div class="paragraph">
<p>It is possible to switch to <a href="#mapping-indexedembedded-structure-nested">a nested structure</a>
by passing an argument to the <code>objectField</code> method, as shown below.
Each value of the object field will then transparently be indexed as a separate nested document,
without any change to the <code>write</code> method of the bridge.</p>
</div>
<div class="exampleblock">
<div class="title">Example 120. Declaring an object field as nested</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="annotation">@Override</span>
<span class="directive">public</span> <span class="type">void</span> bind(PropertyBindingContext context) {
    context.dependencies()
            <span class="comment">/* ... (declaration of dependencies, not relevant) ... */</span>

    IndexSchemaElement schemaElement = context.indexSchemaElement();

    IndexSchemaObjectField lineItemsField =
            schemaElement.objectField( <i class="conum" data-value="1"></i><b>(1)</b>
                    <span class="string"><span class="delimiter">&quot;</span><span class="content">lineItems</span><span class="delimiter">&quot;</span></span>, <i class="conum" data-value="2"></i><b>(2)</b>
                    ObjectStructure.NESTED <i class="conum" data-value="3"></i><b>(3)</b>
            )
                    .multiValued(); <i class="conum" data-value="4"></i><b>(4)</b>

    context.bridge( <span class="predefined-type">List</span>.class, <span class="keyword">new</span> Bridge(
            lineItemsField.toReference(), <i class="conum" data-value="5"></i><b>(5)</b>
            lineItemsField.field( <span class="string"><span class="delimiter">&quot;</span><span class="content">category</span><span class="delimiter">&quot;</span></span>, f -&gt; f.asString() ) <i class="conum" data-value="6"></i><b>(6)</b>
                    .toReference(),
            lineItemsField.field( <span class="string"><span class="delimiter">&quot;</span><span class="content">amount</span><span class="delimiter">&quot;</span></span>, f -&gt; f.asBigDecimal().decimalScale( <span class="integer">2</span> ) ) <i class="conum" data-value="7"></i><b>(7)</b>
                    .toReference()
    ) );
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Declare an object field with <code>objectField</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Define the name of the object field.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Define the structure of the object field, here <code>NESTED</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Define the object field as multivalued.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Get a reference to the declared object field
and pass it to the bridge for later use.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Create subfields, get references to these fields
and pass them to the bridge for later use.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="binding-index-field-dsl-dynamic"><a class="anchor" href="#binding-index-field-dsl-dynamic"></a>12.8.6. <a id="mapper-orm-bridge-index-field-dsl-dynamic"></a> Dynamic fields with field templates</h4>
<div class="paragraph">
<p>Field declared in the sections above are all <em>static</em>:
their path and type are known on bootstrap.</p>
</div>
<div class="paragraph">
<p>In some very specific cases, the path of a field is not known until you actually index it;
for example, you may want to index a <code>Map&lt;String, Integer&gt;</code> by using the map keys as field names,
or index the properties of a JSON object whose schema is not known in advance.
The fields, then, are considered <em>dynamic</em>.</p>
</div>
<div class="paragraph">
<p>Dynamic fields are not declared on bootstrap,
but need to match a field <em>template</em> that is declared on bootstrap.
The template includes the field types and structural information (multivalued or not, &#8230;&#8203;),
but omits the field names.</p>
</div>
<div class="paragraph">
<p>A field template is always declared in a binder: either in a <a href="#binding-typebridge">type binder</a>
or in a <a href="#binding-propertybridge">property binder</a>.
As for static fields, the entry point to declaring a template is the <code>IndexNode</code>
passed to the binder&#8217;s <code>bind(&#8230;&#8203;)</code> method.
A call to the <code>fieldTemplate</code> method on the schema element will declare a field template.</p>
</div>
<div class="paragraph">
<p>Assuming a field template was declared during binding,
the bridge can then add dynamic fields to the <code>DocumentElement</code> when indexing,
by calling <code>addValue</code> and passing the field name (as a string) and the field value.</p>
</div>
<div class="paragraph">
<p>Below is a simple example using the DSL to declare a field template in a property binder
and then write to that field in a property bridge.</p>
</div>
<div class="exampleblock">
<div class="title">Example 121. Declaring a field template and writing to a dynamic field</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="directive">public</span> <span class="type">class</span> <span class="class">UserMetadataBinder</span> <span class="directive">implements</span> PropertyBinder {

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> bind(PropertyBindingContext context) {
        context.dependencies()
                <span class="comment">/* ... (declaration of dependencies, not relevant) ... */</span>

        IndexSchemaElement schemaElement = context.indexSchemaElement();

        IndexSchemaObjectField userMetadataField =
                schemaElement.objectField( <span class="string"><span class="delimiter">&quot;</span><span class="content">userMetadata</span><span class="delimiter">&quot;</span></span> ); <i class="conum" data-value="1"></i><b>(1)</b>

        userMetadataField.fieldTemplate( <i class="conum" data-value="2"></i><b>(2)</b>
                <span class="string"><span class="delimiter">&quot;</span><span class="content">userMetadataValueTemplate</span><span class="delimiter">&quot;</span></span>, <i class="conum" data-value="3"></i><b>(3)</b>
                f -&gt; f.asString().analyzer( <span class="string"><span class="delimiter">&quot;</span><span class="content">english</span><span class="delimiter">&quot;</span></span> ) <i class="conum" data-value="4"></i><b>(4)</b>
        ); <i class="conum" data-value="5"></i><b>(5)</b>

        context.bridge( <span class="predefined-type">Map</span>.class, <span class="keyword">new</span> UserMetadataBridge(
                userMetadataField.toReference() <i class="conum" data-value="6"></i><b>(6)</b>
        ) );
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Declare an object field with <code>objectField</code>.
It&#8217;s better to always host your dynamic fields on a dedicated object field,
to avoid conflicts with other templates.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Declare a field template with <code>fieldTemplate</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Pass the <strong>template</strong> name&#8201;&#8212;&#8201;this is not the field name, and is only used to uniquely identify the template.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Define the field type.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>On contrary to static field declarations, field template declarations do not return a field reference,
because you won&#8217;t need it when writing to the document.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Get a reference to the declared object field
and pass it to the bridge for later use.</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="annotation">@SuppressWarnings</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">rawtypes</span><span class="delimiter">&quot;</span></span>)
<span class="directive">private</span> <span class="directive">static</span> <span class="type">class</span> <span class="class">UserMetadataBridge</span> <span class="directive">implements</span> PropertyBridge&lt;<span class="predefined-type">Map</span>&gt; {

    <span class="directive">private</span> <span class="directive">final</span> IndexObjectFieldReference userMetadataFieldReference;

    <span class="directive">private</span> UserMetadataBridge(IndexObjectFieldReference userMetadataFieldReference) {
        <span class="local-variable">this</span>.userMetadataFieldReference = userMetadataFieldReference;
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> write(DocumentElement target, <span class="predefined-type">Map</span> bridgedElement, PropertyBridgeWriteContext context) {
        <span class="annotation">@SuppressWarnings</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">unchecked</span><span class="delimiter">&quot;</span></span>)
        <span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; userMetadata = (<span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt;) bridgedElement;

        DocumentElement indexedUserMetadata = target.addObject( userMetadataFieldReference ); <i class="conum" data-value="1"></i><b>(1)</b>

        <span class="keyword">for</span> ( <span class="predefined-type">Map</span>.Entry&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; entry : userMetadata.entrySet() ) {
            <span class="predefined-type">String</span> fieldName = entry.getKey();
            <span class="predefined-type">String</span> fieldValue = entry.getValue();
            indexedUserMetadata.addValue( fieldName, fieldValue ); <i class="conum" data-value="2"></i><b>(2)</b>
        }
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Add an object to the <code>userMetadata</code> object field for the current document,
and get a reference to that object.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Add one field per user metadata entry,
with the field name and field value defined by the user.
Note that field names should usually be validated before that point,
in order to avoid exotic characters (whitespaces, dots, &#8230;&#8203;).</td>
</tr>
</table>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Though rarely necessary, you can also declare templates for object fields using the <code>objectFieldTemplate</code> methods.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>It is also possible to add multiple fields with different types to the same object.
To that end, make sure that the format of a field can be inferred from the field name.
You can then declare multiple templates and assign a path pattern to each template,
as shown below.</p>
</div>
<div class="exampleblock">
<div class="title">Example 122. Declaring multiple field templates with different types</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="directive">public</span> <span class="type">class</span> <span class="class">MultiTypeUserMetadataBinder</span> <span class="directive">implements</span> PropertyBinder {

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> bind(PropertyBindingContext context) {
        context.dependencies()
                <span class="comment">/* ... (declaration of dependencies, not relevant) ... */</span>

        IndexSchemaElement schemaElement = context.indexSchemaElement();

        IndexSchemaObjectField userMetadataField =
                schemaElement.objectField( <span class="string"><span class="delimiter">&quot;</span><span class="content">multiTypeUserMetadata</span><span class="delimiter">&quot;</span></span> ); <i class="conum" data-value="1"></i><b>(1)</b>

        userMetadataField.fieldTemplate( <i class="conum" data-value="2"></i><b>(2)</b>
                <span class="string"><span class="delimiter">&quot;</span><span class="content">userMetadataValueTemplate_int</span><span class="delimiter">&quot;</span></span>, <i class="conum" data-value="3"></i><b>(3)</b>
                f -&gt; f.asInteger().sortable( Sortable.YES ) <i class="conum" data-value="4"></i><b>(4)</b>
        )
                .matchingPathGlob( <span class="string"><span class="delimiter">&quot;</span><span class="content">*_int</span><span class="delimiter">&quot;</span></span> ); <i class="conum" data-value="5"></i><b>(5)</b>

        userMetadataField.fieldTemplate( <i class="conum" data-value="6"></i><b>(6)</b>
                <span class="string"><span class="delimiter">&quot;</span><span class="content">userMetadataValueTemplate_default</span><span class="delimiter">&quot;</span></span>,
                f -&gt; f.asString().analyzer( <span class="string"><span class="delimiter">&quot;</span><span class="content">english</span><span class="delimiter">&quot;</span></span> )
        );

        context.bridge( <span class="predefined-type">Map</span>.class, <span class="keyword">new</span> Bridge( userMetadataField.toReference() ) );
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Declare an object field with <code>objectField</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Declare a field template for integer with <code>fieldTemplate</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Pass the <strong>template</strong> name.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Define the field type as integer, sortable.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Assign a path pattern to the template, so that only fields ending with <code>_int</code> will be considered as integers.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Declare another field template,
so that fields are considered as english text if they do not match the previous template.</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="annotation">@SuppressWarnings</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">rawtypes</span><span class="delimiter">&quot;</span></span>)
<span class="directive">private</span> <span class="directive">static</span> <span class="type">class</span> <span class="class">Bridge</span> <span class="directive">implements</span> PropertyBridge&lt;<span class="predefined-type">Map</span>&gt; {

    <span class="directive">private</span> <span class="directive">final</span> IndexObjectFieldReference userMetadataFieldReference;

    <span class="directive">private</span> Bridge(IndexObjectFieldReference userMetadataFieldReference) {
        <span class="local-variable">this</span>.userMetadataFieldReference = userMetadataFieldReference;
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> write(DocumentElement target, <span class="predefined-type">Map</span> bridgedElement, PropertyBridgeWriteContext context) {
        <span class="annotation">@SuppressWarnings</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">unchecked</span><span class="delimiter">&quot;</span></span>)
        <span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Object</span>&gt; userMetadata = (<span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Object</span>&gt;) bridgedElement;

        DocumentElement indexedUserMetadata = target.addObject( userMetadataFieldReference ); <i class="conum" data-value="1"></i><b>(1)</b>

        <span class="keyword">for</span> ( <span class="predefined-type">Map</span>.Entry&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Object</span>&gt; entry : userMetadata.entrySet() ) {
            <span class="predefined-type">String</span> fieldName = entry.getKey();
            <span class="predefined-type">Object</span> fieldValue = entry.getValue();
            indexedUserMetadata.addValue( fieldName, fieldValue ); <i class="conum" data-value="2"></i><b>(2)</b>
        }
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Add an object to the <code>userMetadata</code> object field for the current document,
and get a reference to that object.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Add one field per user metadata entry,
with the field name and field value defined by the user.
Note that field values should be validated before that point;
in this case, adding a field named <code>foo_int</code> with a value of type <code>String</code>
will lead to a <code>SearchException</code> when indexing.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Precedence of field templates</div>
<div class="paragraph">
<p>Hibernate Search tries to match templates in the order they are declared,
so you should always declare the templates with the most specific path pattern first.</p>
</div>
<div class="paragraph">
<p>Templates declared on a given schema element can be matched in children of that element.
For example, if you declare templates at the root of your entity (through a <a href="#binding-typebridge">type bridge</a>),
these templates will be implicitly available in every single property bridge of that entity.
In such cases, templates declared in property bridges will take precedence over those declared in the type bridge.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="binding-index-field-type-dsl"><a class="anchor" href="#binding-index-field-type-dsl"></a>12.9. <a id="mapper-orm-bridge-index-field-type-dsl"></a> Defining index field types</h3>
<div class="sect3">
<h4 id="binding-index-field-type-dsl-basics"><a class="anchor" href="#binding-index-field-type-dsl-basics"></a>12.9.1. <a id="mapper-orm-bridge-index-field-type-dsl-basics"></a> Basics</h4>
<div class="paragraph">
<p>A specificity of Lucene-based search engines (including Elasticsearch) is that field types
are much more complex than just a data type ("string", "integer", &#8230;&#8203;).</p>
</div>
<div class="paragraph">
<p>When declaring a field, you must not only declare the data type,
but also various characteristics that will define how the data is stored exactly:
is the field sortable,
is it projectable,
is it analyzed and if so with which analyzer,
&#8230;&#8203;</p>
</div>
<div class="paragraph">
<p>Because of this complexity,
when field types must be defined in the various binders
(<code>ValueBinder</code>, <code>PropertyBinder</code>, <code>TypeBinder</code>),
they are defined using a dedicated DSL.</p>
</div>
<div class="paragraph">
<p>The entry point to this DSL is the <code>IndexFieldTypeFactory</code>.
The type factory is generally accessible though the context object passed to the binders
(<code>context.typeFactory()</code>).
In the case of <code>PropertyBinder</code> and <code>TypeBinder</code>,
the type factory can also be passed to the lambda expression passed to the <code>field</code> method
to define the field type inline.</p>
</div>
<div class="paragraph">
<p>The type factory exposes various <code>as*()</code> methods,
for example <code>asString</code> or <code>asLocalDate</code>.
These are the first steps of the type definition DSL,
where the data type is defined.
They return other steps, from which options
can be set, such as the analyzer.
See below for an example.</p>
</div>
<div class="exampleblock">
<div class="title">Example 123. Defining a field type</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">IndexFieldType&lt;<span class="predefined-type">String</span>&gt; type = context.typeFactory() <i class="conum" data-value="1"></i><b>(1)</b>
        .asString() <i class="conum" data-value="2"></i><b>(2)</b>
        .normalizer( <span class="string"><span class="delimiter">&quot;</span><span class="content">isbn</span><span class="delimiter">&quot;</span></span> ) <i class="conum" data-value="3"></i><b>(3)</b>
        .sortable( Sortable.YES ) <i class="conum" data-value="3"></i><b>(3)</b>
        .toIndexFieldType(); <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Get the <code>IndexFieldTypeFactory</code> from the binding context.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Define the data type.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Define options.
Available options differ based on the field type:
for example, <code>normalizer</code> is available for <code>String</code> fields,
but not for <code>Double</code> fields.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Get the index field type.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>In <code>ValueBinder</code>, the call to <code>toIndexFieldType()</code> is omitted:
<code>context.bridge(&#8230;&#8203;)</code> expects to be passed the last DSL step,
not a fully built type.</p>
</div>
<div class="paragraph">
<p><code>toIndexFieldType()</code> is also omitted in the lambda expressions
passed to the <code>field</code> method of
the <a href="#binding-index-field-dsl">field declaration DSL</a>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="binding-index-field-type-dsl-data-types"><a class="anchor" href="#binding-index-field-type-dsl-data-types"></a>12.9.2. <a id="mapper-orm-bridge-index-field-type-dsl-data-types"></a> <a id="_available_data_types"></a> Available data types</h4>
<div class="paragraph">
<p>All available data types have a dedicated <code>as*()</code> method in <code>IndexFieldTypeFactory</code>.
For details, see the javadoc of <code>IndexFieldTypeFactory</code>,
or the backend-specific documentation:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#backend-lucene-field-types-available">available data types in the Lucene backend</a></p>
</li>
<li>
<p><a href="#backend-elasticsearch-field-types-available">available data types in the Elasticsearch backend</a></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="binding-index-field-type-dsl-options"><a class="anchor" href="#binding-index-field-type-dsl-options"></a>12.9.3. <a id="mapper-orm-bridge-index-field-type-dsl-options"></a> <a id="_available_type_options"></a> Available type options</h4>
<div class="paragraph">
<p>Most of the options available in the index field type DSL are identical
to the options exposed by <code>@*Field</code> annotations.
See <a href="#mapping-directfieldmapping-annotation-attributes"> Field annotation attributes</a> for details about them.</p>
</div>
<div class="paragraph">
<p>Other options are explained in the following sections.</p>
</div>
</div>
<div class="sect3">
<h4 id="binding-index-field-type-dsl-converter"><a class="anchor" href="#binding-index-field-type-dsl-converter"></a>12.9.4. <a id="mapper-orm-bridge-index-field-type-dsl-converter"></a> <a id="_dsl_converter"></a> DSL converter</h4>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This section is not relevant for <code>ValueBinder</code>:
Hibernate Search sets the DSL converter automatically for value bridges,
creating a DSL converter that simply delegates to the value bridge.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The various search DSLs expose some methods that expect a field value:
<code>matching()</code>, <code>between()</code>, <code>atMost()</code>, <code>missingValue().use()</code>, &#8230;&#8203;
By default, the expected type will be the same as the data type,
i.e. <code>String</code> if you called <code>asString()</code>,
<code>LocalDate</code> if you called <code>asLocalDate()</code>,
etc.</p>
</div>
<div class="paragraph">
<p>This can be annoying when the bridge converts values from a different type when indexing.
For example, if the bridge converts an enum to a string when indexing,
you probably don&#8217;t want to pass a string to search predicates,
but rather the enum.</p>
</div>
<div class="paragraph">
<p>By setting a DSL converter on a field type,
it is possible to change the expected type of values passed to the various DSL,
See below for an example.</p>
</div>
<div class="exampleblock">
<div class="title">Example 124. Assigning a DSL converter to a field type</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">IndexFieldType&lt;<span class="predefined-type">String</span>&gt; type = context.typeFactory()
        .asString() <i class="conum" data-value="1"></i><b>(1)</b>
        .normalizer( <span class="string"><span class="delimiter">&quot;</span><span class="content">isbn</span><span class="delimiter">&quot;</span></span> )
        .sortable( Sortable.YES )
        .dslConverter( <i class="conum" data-value="2"></i><b>(2)</b>
                ISBN.class, <i class="conum" data-value="3"></i><b>(3)</b>
                (value, convertContext) -&gt; value.getStringValue() <i class="conum" data-value="4"></i><b>(4)</b>
        )
        .toIndexFieldType();</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Define the data type as <code>String</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Define a DSL converter that converts from <code>ISBN</code> to <code>String</code>.
This converter will be used transparently by the search DSLs.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Define the input type as <code>ISBN</code> by passing <code>ISBN.class</code> as the first parameter.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Define how to convert an <code>ISBN</code> to a <code>String</code> by passing a converter as the second parameter.</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">ISBN expectedISBN = <span class="comment">/* ... */</span>
<span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; result = searchSession.search( <span class="predefined-type">Book</span>.class )
        .where( f -&gt; f.match().field( <span class="string"><span class="delimiter">&quot;</span><span class="content">isbn</span><span class="delimiter">&quot;</span></span> )
                .matching( expectedISBN ) ) <i class="conum" data-value="1"></i><b>(1)</b>
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Thanks to the DSL converter,
predicates targeting fields using our type
accept <code>ISBN</code> values by default.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
DSL converters can be disabled in the various DSLs where necessary.
See <a href="#search-dsl-argument-type">Type of arguments passed to the DSL</a>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="binding-index-field-type-dsl-projection-converter"><a class="anchor" href="#binding-index-field-type-dsl-projection-converter"></a>12.9.5. <a id="mapper-orm-bridge-index-field-type-dsl-projection-converter"></a> <a id="_projection_converter"></a> Projection converter</h4>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This section is not relevant for <code>ValueBinder</code>:
Hibernate Search sets the projection converter automatically for value bridges,
creating a projection converter that simply delegates to the value bridge.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>By default, the type of values returned by <a href="#search-dsl-projection-field">field projections</a>
or <a href="#search-dsl-aggregation">aggregations</a>
will be the same as the data type of the corresponding field,
i.e. <code>String</code> if you called <code>asString()</code>,
<code>LocalDate</code> if you called <code>asLocalDate()</code>,
etc.</p>
</div>
<div class="paragraph">
<p>This can be annoying when the bridge converts values from a different type when indexing.
For example, if the bridge converts an enum to a string when indexing,
you probably don&#8217;t want projections to return a string,
but rather the enum.</p>
</div>
<div class="paragraph">
<p>By setting a projection converter on a field type,
it is possible to change the type of values returned by field projections or aggregations.
See below for an example.</p>
</div>
<div class="exampleblock">
<div class="title">Example 125. Assigning a projection converter to a field type</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">IndexFieldType&lt;<span class="predefined-type">String</span>&gt; type = context.typeFactory()
        .asString() <i class="conum" data-value="1"></i><b>(1)</b>
        .projectable( Projectable.YES )
        .projectionConverter( <i class="conum" data-value="2"></i><b>(2)</b>
                ISBN.class, <i class="conum" data-value="3"></i><b>(3)</b>
                (value, convertContext) -&gt; ISBN.parse( value ) <i class="conum" data-value="4"></i><b>(4)</b>
        )
        .toIndexFieldType();</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Define the data type as <code>String</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Define a projection converter that converts from <code>String</code> to <code>ISBN</code>.
This converter will be used transparently by the search DSLs.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Define the converted type as <code>ISBN</code> by passing <code>ISBN.class</code> as the first parameter.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Define how to convert a <code>String</code> to an <code>ISBN</code> by passing a converter as the second parameter.</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;ISBN&gt; result = searchSession.search( <span class="predefined-type">Book</span>.class )
        .select( f -&gt; f.field( <span class="string"><span class="delimiter">&quot;</span><span class="content">isbn</span><span class="delimiter">&quot;</span></span>, ISBN.class ) ) <i class="conum" data-value="1"></i><b>(1)</b>
        .where( f -&gt; f.matchAll() )
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Thanks to the projection converter,
fields using our type are projected to an <code>ISBN</code> by default.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Projection converters can be disabled in the projection DSL where necessary.
See <a href="#search-dsl-projected-value-type">Type of projected values</a>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="binding-index-field-type-dsl-backend-specific-types"><a class="anchor" href="#binding-index-field-type-dsl-backend-specific-types"></a>12.9.6. <a id="mapper-orm-bridge-index-field-type-dsl-backend-specific-types"></a> <a id="_backend_specific_types"></a> Backend-specific types</h4>
<div class="paragraph">
<p>Backends define extensions to this DSL
to define backend-specific types.</p>
</div>
<div class="paragraph">
<p>See:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#backend-lucene-field-types-extension">Lucene index field type DSL extension</a></p>
</li>
<li>
<p><a href="#backend-elasticsearch-field-types-extension">Elasticsearch index field type DSL extension</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="binding-named-predicate"><a class="anchor" href="#binding-named-predicate"></a>12.10. <a id="mapper-orm-bridge-named-predicate"></a> Defining named predicates</h3>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Features detailed below are <em>incubating</em>: they are still under active development.</p>
</div>
<div class="paragraph">
<p>The usual <a href="https://hibernate.org/community/compatibility-policy/">compatibility policy</a> does not apply:
the contract of incubating elements (e.g. types, methods, configuration properties, etc.)
may be altered in a backward-incompatible way&#8201;&#8212;&#8201;or even removed&#8201;&#8212;&#8201;in subsequent releases.</p>
</div>
<div class="paragraph">
<p>You are encouraged to use incubating features so the development team can get feedback and improve them,
but you should be prepared to update code which relies on them as needed.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>When implementing a <a href="#binding-propertybridge"><code>PropertyBinder</code></a>
or <a href="#binding-typebridge"><code>TypeBinder</code></a>,
it is possible to assign "named predicates"
to index schema elements (either the index root or an <a href="#binding-index-field-dsl-object">object field</a>).</p>
</div>
<div class="paragraph">
<p>These named predicates will then be usable <a href="#search-dsl-predicate-named">through the Search DSL</a>,
referencing them by name and optionally passing parameters.
The main point is that the implementation is hidden from callers:
they do not need to understand how data is indexed in order to use a named predicate.</p>
</div>
<div class="paragraph">
<p>Below is a simple example using the DSL to declare an object field and assign a named predicate to that field,
in a property binder.</p>
</div>
<div class="exampleblock">
<div class="title">Example 126. Declaring a named predicate</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="comment">/**
 * A binder for Stock Keeping Unit (SKU) identifiers, i.e. Strings with a specific format.
 */</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">SkuIdentifierBinder</span> <span class="directive">implements</span> PropertyBinder {

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> bind(PropertyBindingContext context) {
        context.dependencies().useRootOnly();

        IndexSchemaObjectField skuIdObjectField = context.indexSchemaElement()
                .objectField( context.bridgedElement().name() );

        IndexFieldType&lt;<span class="predefined-type">String</span>&gt; skuIdPartType = context.typeFactory()
                .asString().normalizer( <span class="string"><span class="delimiter">&quot;</span><span class="content">lowercase</span><span class="delimiter">&quot;</span></span> ).toIndexFieldType();

        context.bridge( <span class="predefined-type">String</span>.class, <span class="keyword">new</span> Bridge(
                skuIdObjectField.toReference(),
                skuIdObjectField.field( <span class="string"><span class="delimiter">&quot;</span><span class="content">departmentCode</span><span class="delimiter">&quot;</span></span>, skuIdPartType ).toReference(),
                skuIdObjectField.field( <span class="string"><span class="delimiter">&quot;</span><span class="content">collectionCode</span><span class="delimiter">&quot;</span></span>, skuIdPartType ).toReference(),
                skuIdObjectField.field( <span class="string"><span class="delimiter">&quot;</span><span class="content">itemCode</span><span class="delimiter">&quot;</span></span>, skuIdPartType ).toReference()
        ) );

        skuIdObjectField.namedPredicate( <i class="conum" data-value="1"></i><b>(1)</b>
                <span class="string"><span class="delimiter">&quot;</span><span class="content">skuIdMatch</span><span class="delimiter">&quot;</span></span>, <i class="conum" data-value="2"></i><b>(2)</b>
                <span class="keyword">new</span> SkuIdentifierMatchPredicateDefinition() <i class="conum" data-value="3"></i><b>(3)</b>
        );
    }

    <span class="comment">// ... class continues below</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The binder defines a named predicate.
Note this predicate is assigned to an object field.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The predicate name will be used to refer to this predicate when <a href="#search-dsl-predicate-named">calling the named predicate</a>.
Since the predicate is assigned to an object field,
callers will have to prefix the predicate name with the path to that object field.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The predicate definition will define how to create the predicate when searching.</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="comment">// ... class SkuIdentifierBinder (continued)</span>

<span class="directive">private</span> <span class="directive">static</span> <span class="type">class</span> <span class="class">Bridge</span> <span class="directive">implements</span> PropertyBridge&lt;<span class="predefined-type">String</span>&gt; { <i class="conum" data-value="1"></i><b>(1)</b>

    <span class="directive">private</span> <span class="directive">final</span> IndexObjectFieldReference skuIdObjectField;
    <span class="directive">private</span> <span class="directive">final</span> IndexFieldReference&lt;<span class="predefined-type">String</span>&gt; departmentCodeField;
    <span class="directive">private</span> <span class="directive">final</span> IndexFieldReference&lt;<span class="predefined-type">String</span>&gt; collectionCodeField;
    <span class="directive">private</span> <span class="directive">final</span> IndexFieldReference&lt;<span class="predefined-type">String</span>&gt; itemCodeField;

    <span class="directive">private</span> Bridge(IndexObjectFieldReference skuIdObjectField,
            IndexFieldReference&lt;<span class="predefined-type">String</span>&gt; departmentCodeField,
            IndexFieldReference&lt;<span class="predefined-type">String</span>&gt; collectionCodeField,
            IndexFieldReference&lt;<span class="predefined-type">String</span>&gt; itemCodeField) {
        <span class="local-variable">this</span>.skuIdObjectField = skuIdObjectField;
        <span class="local-variable">this</span>.departmentCodeField = departmentCodeField;
        <span class="local-variable">this</span>.collectionCodeField = collectionCodeField;
        <span class="local-variable">this</span>.itemCodeField = itemCodeField;
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> write(DocumentElement target, <span class="predefined-type">String</span> skuId, PropertyBridgeWriteContext context) {
        DocumentElement skuIdObject = target.addObject( <span class="local-variable">this</span>.skuIdObjectField );<i class="conum" data-value="2"></i><b>(2)</b>

        <span class="comment">// An SKU identifier is formatted this way: &quot;&lt;department code&gt;.&lt;collection code&gt;.&lt;item code&gt;&quot;.</span>
        <span class="predefined-type">String</span><span class="type">[]</span> skuIdParts = skuId.split( <span class="string"><span class="delimiter">&quot;</span><span class="char">\\</span><span class="content">.</span><span class="delimiter">&quot;</span></span> );
        skuIdObject.addValue( <span class="local-variable">this</span>.departmentCodeField, skuIdParts[<span class="integer">0</span>] ); <i class="conum" data-value="3"></i><b>(3)</b>
        skuIdObject.addValue( <span class="local-variable">this</span>.collectionCodeField, skuIdParts[<span class="integer">1</span>] ); <i class="conum" data-value="3"></i><b>(3)</b>
        skuIdObject.addValue( <span class="local-variable">this</span>.itemCodeField, skuIdParts[<span class="integer">2</span>] ); <i class="conum" data-value="3"></i><b>(3)</b>
    }
}

<span class="comment">// ... class continues below</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Here the bridge class is nested in the binder class,
because it is more convenient,
but you are obviously free to implement it as you wish:
as a lambda expression, in a separate Java file&#8230;&#8203;</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The bridge creates an object to hold the various components of the SKU identifier.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The bridge populates the various components of the SKU identifier.</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">    <span class="comment">// ... class SkuIdentifierBinder (continued)</span>

    <span class="directive">private</span> <span class="directive">static</span> <span class="type">class</span> <span class="class">SkuIdentifierMatchPredicateDefinition</span> <span class="directive">implements</span> PredicateDefinition { <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="annotation">@Override</span>
        <span class="directive">public</span> SearchPredicate create(PredicateDefinitionContext context) {
            SearchPredicateFactory f = context.predicate(); <i class="conum" data-value="2"></i><b>(2)</b>

            <span class="predefined-type">String</span> pattern = context.param( <span class="string"><span class="delimiter">&quot;</span><span class="content">pattern</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">String</span>.class ); <i class="conum" data-value="3"></i><b>(3)</b>

            <span class="keyword">return</span> f.and().with( and -&gt; { <i class="conum" data-value="4"></i><b>(4)</b>
                <span class="comment">// An SKU identifier pattern is formatted this way: &quot;&lt;department code&gt;.&lt;collection code&gt;.&lt;item code&gt;&quot;.</span>
                <span class="comment">// Each part supports * and ? wildcards.</span>
                <span class="predefined-type">String</span><span class="type">[]</span> patternParts = pattern.split( <span class="string"><span class="delimiter">&quot;</span><span class="char">\\</span><span class="content">.</span><span class="delimiter">&quot;</span></span> );
                <span class="keyword">if</span> ( patternParts.length &gt; <span class="integer">0</span> ) {
                    and.add( f.wildcard()
                            .field( <span class="string"><span class="delimiter">&quot;</span><span class="content">departmentCode</span><span class="delimiter">&quot;</span></span> ) <i class="conum" data-value="5"></i><b>(5)</b>
                            .matching( patternParts[<span class="integer">0</span>] ) );
                }
                <span class="keyword">if</span> ( patternParts.length &gt; <span class="integer">1</span> ) {
                    and.add( f.wildcard()
                            .field( <span class="string"><span class="delimiter">&quot;</span><span class="content">collectionCode</span><span class="delimiter">&quot;</span></span> )
                            .matching( patternParts[<span class="integer">1</span>] ) );
                }
                <span class="keyword">if</span> ( patternParts.length &gt; <span class="integer">2</span> ) {
                    and.add( f.wildcard()
                            .field( <span class="string"><span class="delimiter">&quot;</span><span class="content">itemCode</span><span class="delimiter">&quot;</span></span> )
                            .matching( patternParts[<span class="integer">2</span>] ) );
                }
            } ).toPredicate(); <i class="conum" data-value="6"></i><b>(6)</b>
        }
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The predicate definition must implement the <code>PredicateDefinition</code> interface.
<div class="paragraph">
<p>Here the predicate definition class is nested in the binder class,
because it is more convenient,
but you are obviously free to implement it in a separate java file.</p>
</div></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The context passed to the definition exposes the predicate factory,
which is the entry point to the <a href="#search-dsl-predicate">predicate DSL</a>,
used to create predicates.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The definition can access parameters that are passed when calling the named predicates.
<div class="paragraph">
<p>The <code>param</code> method will throw an exception if the parameter has not been defined.
Alternatively, use <code>paramOptional</code> to get an <code>java.util.Optional</code> that will be empty if the parameter has not been defined.</p>
</div></td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The definition uses the predicate factory to create predicates.
In this example, this implementation transforms a pattern with a custom format into three patterns,
one for each field populated by the bridge.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Be careful: the search predicate factory expects paths
relative to the object field where the named predicate was registered.
Here the path <code>departmentCode</code> will be understood as <code>&lt;path to the object field&gt;.departmentCode</code>.
See also <a href="#search-dsl-paths">Field paths</a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Do not forget to call <code>toPredicate()</code> to return a <code>SearchPredicate</code> instance.</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="annotation">@Entity</span>
<span class="annotation">@Indexed</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">ItemStock</span> {

    <span class="annotation">@Id</span>
    <span class="annotation">@PropertyBinding</span>(binder = <span class="annotation">@PropertyBinderRef</span>(type = SkuIdentifierBinder.class)) <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="directive">private</span> <span class="predefined-type">String</span> skuId;

    <span class="directive">private</span> <span class="type">int</span> amountInStock;

    <span class="comment">// Getters and setters</span>
    <span class="comment">// ...</span>


}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Apply the bridge using the <code>@PropertyBinding</code> annotation.
The predicate will be available in the Search DSL,
as shown in <a href="#search-dsl-predicate-named"> <code>named</code>: call a predicate defined in the mapping</a>.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="binding-bridge-resolver"><a class="anchor" href="#binding-bridge-resolver"></a>12.11. <a id="mapper-orm-bridge-resolver"></a> <a id="_bridgeprovider_associate_a_bridge_to_a_given_return_type"></a> Assigning default bridges with the bridge resolver</h3>
<div class="sect3">
<h4 id="binding-bridge-resolver-basics"><a class="anchor" href="#binding-bridge-resolver-basics"></a>12.11.1. <a id="mapper-orm-bridge-resolver-basics"></a> Basics</h4>
<div class="paragraph">
<p>Both the <a href="#mapping-directfieldmapping-supported-types"><code>@*Field</code> annotations</a>
and the <a href="#mapping-identifiermapping-supported-types"><code>@DocumentId</code> annotation</a>
support a broad range of standard types by default,
without needing to tell Hibernate Search how to convert values to something that can be indexed.</p>
</div>
<div class="paragraph">
<p>Under the hood, the support for default types is handled by the bridge resolver.
For example, when a property is mapped with <code>@GenericField</code>
and neither <code>@GenericField.valueBridge</code> nor <code>@GenericField.valueBinder</code> is set,
Hibernate Search will resolve the type of this property,
then pass it to the bridge resolver,
which will return an appropriate bridge, or fail if there isn&#8217;t any.</p>
</div>
<div class="paragraph">
<p>It is possible to customize the bridge resolver,
to override existing default bridges (indexing <code>java.util.Date</code> differently, for example)
or to define default bridges for additional types (a geospatial type from an external library, for example).</p>
</div>
<div class="paragraph">
<p>To that end, define a mapping configurer as explained in <a href="#mapping-programmatic">   Programmatic mapping</a>,
then define bridges as shown below:</p>
</div>
<div class="exampleblock">
<div class="title">Example 127. Defining default bridges with a mapping configurer</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="directive">public</span> <span class="type">class</span> <span class="class">MyDefaultBridgesConfigurer</span> <span class="directive">implements</span> HibernateOrmSearchMappingConfigurer {
    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> configure(HibernateOrmMappingConfigurationContext context) {
        context.bridges().exactType( MyCoordinates.class )
                .valueBridge( <span class="keyword">new</span> MyCoordinatesBridge() ); <i class="conum" data-value="1"></i><b>(1)</b>

        context.bridges().exactType( MyProductId.class )
                .identifierBridge( <span class="keyword">new</span> MyProductIdBridge() ); <i class="conum" data-value="2"></i><b>(2)</b>

        context.bridges().exactType( ISBN.class )
                .valueBinder( <span class="keyword">new</span> ValueBinder() { <i class="conum" data-value="3"></i><b>(3)</b>
                    <span class="annotation">@Override</span>
                    <span class="directive">public</span> <span class="type">void</span> bind(ValueBindingContext&lt;?&gt; context) {
                        context.bridge( ISBN.class, <span class="keyword">new</span> ISBNValueBridge(),
                                context.typeFactory().asString().normalizer( <span class="string"><span class="delimiter">&quot;</span><span class="content">isbn</span><span class="delimiter">&quot;</span></span> ) );
                    }
                } );
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Use our custom bridge (<code>MyCoordinatesBridge</code>) by default when a property of type <code>MyCoordinates</code>
is mapped to an index field (e.g. with <code>@GenericField</code>).</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Use our custom bridge (<code>MyProductBridge</code>) by default when a property of type <code>MyProductId</code>
is mapped to a document identifier (e.g. with <code>@DocumentId</code>).</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>It&#8217;s also possible to specify a binder instead of a bridge,
so that additional settings can be tuned.
Here we&#8217;re assigning the "isbn" normalizer every time we map an ISBN to an index field.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="binding-bridge-resolver-single-binder-multiple-types"><a class="anchor" href="#binding-bridge-resolver-single-binder-multiple-types"></a>12.11.2. <a id="mapper-orm-bridge-resolver-single-binder-multiple-types"></a> <a id="_assigning_a_single_binder_to_multiple_types"></a> Assigning a single binder to multiple types</h4>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Features detailed below are <em>incubating</em>: they are still under active development.</p>
</div>
<div class="paragraph">
<p>The usual <a href="https://hibernate.org/community/compatibility-policy/">compatibility policy</a> does not apply:
the contract of incubating elements (e.g. types, methods, configuration properties, etc.)
may be altered in a backward-incompatible way&#8201;&#8212;&#8201;or even removed&#8201;&#8212;&#8201;in subsequent releases.</p>
</div>
<div class="paragraph">
<p>You are encouraged to use incubating features so the development team can get feedback and improve them,
but you should be prepared to update code which relies on them as needed.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For more advanced use cases, it is also possible to assign a single binder to subtypes of a given type.
This is useful when many types should be indexed similarly.</p>
</div>
<div class="paragraph">
<p>Below is an example where enums are not indexed as their <code>.name()</code> (which is the default),
but instead are indexed as their label retrieved from an external service.</p>
</div>
<div class="exampleblock">
<div class="title">Example 128. Assigning a single default binder to multiple types with a mapping configurer</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">context.bridges().subTypesOf( <span class="predefined-type">Enum</span>.class ) <i class="conum" data-value="1"></i><b>(1)</b>
        .valueBinder( <span class="keyword">new</span> ValueBinder() {
            <span class="annotation">@Override</span>
            <span class="directive">public</span> <span class="type">void</span> bind(ValueBindingContext&lt;?&gt; context) {
                <span class="predefined-type">Class</span>&lt;?&gt; enumType = context.bridgedElement().rawType(); <i class="conum" data-value="2"></i><b>(2)</b>
                doBind( context, enumType );
            }

            <span class="directive">private</span> &lt;T&gt; <span class="type">void</span> doBind(ValueBindingContext&lt;?&gt; context, <span class="predefined-type">Class</span>&lt;T&gt; enumType) {
                BeanHolder&lt;EnumLabelService&gt; serviceHolder = context.beanResolver()
                        .resolve( EnumLabelService.class, BeanRetrieval.ANY ); <i class="conum" data-value="3"></i><b>(3)</b>
                context.bridge(
                        enumType,
                        <span class="keyword">new</span> EnumLabelBridge&lt;&gt;( enumType, serviceHolder )
                ); <i class="conum" data-value="4"></i><b>(4)</b>
            }
        } );</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Match all subtypes of <code>Enum</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><a href="#binding-valuebridge-incubating">Retrieve the type of the element being bridged</a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td><a href="#binding-valuebridge-injection">Retrieve an external service</a> (through CDI/Spring).</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Create and assign the bridge.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="binding-projection"><a class="anchor" href="#binding-projection"></a>12.12. Projection binder</h3>
<div class="sect3">
<h4 id="binding-projection-basics"><a class="anchor" href="#binding-projection-basics"></a>12.12.1. Basics</h4>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Projection binders are an advanced feature that application developers generally shouldn&#8217;t need to bother with.
Before resorting to custom projection binders,
consider relying on <a href="#mapping-projection-inner-explicit">explicit projection constructor parameter mapping</a>
using built-in annotations such as <a href="#search-dsl-projection-id-mapping"><code>@IdProjection</code></a>,
<a href="#search-dsl-projection-field-mapping"><code>@FieldProjection</code></a>,
<a href="#search-dsl-projection-object-mapping"><code>@ObjectProjection</code></a>, &#8230;&#8203;
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>A projection binder is a pluggable component that implements
the binding of a constructor parameter to a <a href="#search-dsl-projection">projection</a>.
It is applied to a parameter of a <a href="#mapping-projection">projection constructor</a>
with the <code>@ProjectionBinding</code> annotation
or with a <a href="#mapping-custom-annotations">custom annotation</a>.</p>
</div>
<div class="paragraph">
<p>The projection binder can inspect the constructor parameter,
and is expected to assign a projection definition to that constructor parameter,
so that whenever the <a href="#mapping-projection">projection constructor</a> is invoked,
Hibernate Search will pass the result of that projection through that constructor parameter.</p>
</div>
<div class="paragraph">
<p>Implementing a projection binder requires two components:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>A custom implementation of <code>ProjectionBinder</code>, to bind the projection definition to the parameter at bootstrap.
This involves inspecting the constructor parameter if necessary,
and instantiating the projection definition.</p>
</li>
<li>
<p>A custom implementation of <code>ProjectionDefinition</code>, to instantiate the projection at runtime.
This involves using the <a href="#search-dsl-projection">projection DSL</a>
and returning the resulting <code>SearchProjection</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Below is an example of a custom projection binder that binds
a parameter of type <code>String</code> to a projection to the <code>title</code> field in the index.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
A similar result can be achieved without a custom projection binder.
This is just to keep the example simple.
</td>
</tr>
</table>
</div>
<div class="exampleblock">
<div class="title">Example 129. Implementing and using a <code>ProjectionBinder</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="directive">public</span> <span class="type">class</span> <span class="class">MyFieldProjectionBinder</span> <span class="directive">implements</span> ProjectionBinder { <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> bind(ProjectionBindingContext context) { <i class="conum" data-value="2"></i><b>(2)</b>
        context.definition( <i class="conum" data-value="3"></i><b>(3)</b>
                <span class="predefined-type">String</span>.class, <i class="conum" data-value="4"></i><b>(4)</b>
                <span class="keyword">new</span> MyProjectionDefinition() <i class="conum" data-value="5"></i><b>(5)</b>
        );
    }

    <span class="comment">// ... class continues below</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The binder must implement the <code>ProjectionBinder</code> interface.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Implement the <code>bind</code> method in the binder.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Call <code>context.definition(&#8230;&#8203;)</code> to define the projection to use.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Pass the expected type of the constructor parameter.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Pass the projection definition instance,
which will create the projection at runtime.</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">    <span class="comment">// ... class MyFieldProjectionBinder (continued)</span>

    <span class="directive">private</span> <span class="directive">static</span> <span class="type">class</span> <span class="class">MyProjectionDefinition</span> <i class="conum" data-value="1"></i><b>(1)</b>
            <span class="directive">implements</span> ProjectionDefinition&lt;<span class="predefined-type">String</span>&gt; { <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="annotation">@Override</span>
        <span class="directive">public</span> SearchProjection&lt;<span class="predefined-type">String</span>&gt; create(SearchProjectionFactory&lt;?, ?&gt; factory,
                ProjectionDefinitionContext context) {
            <span class="keyword">return</span> factory.field( <span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">String</span>.class ) <i class="conum" data-value="3"></i><b>(3)</b>
                    .toProjection(); <i class="conum" data-value="4"></i><b>(4)</b>
        }
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Here the definition class is nested in the binder class,
because it is more convenient,
but you are obviously free to implement it as you wish:
as a lambda expression, in a separate Java file&#8230;&#8203;</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The definition must implement the <code>ProjectionDefinition</code> interface.
One generic type argument must be provided: the type of the projected value,
i.e. the type of the constructor parameter.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Use the provided <code>SearchProjectionFactory</code> and the <a href="#search-dsl-projection">projection DSL</a>
to define the appropriate projection.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Get the resulting projection by calling <code>.toProjection()</code> and return it.</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="annotation">@ProjectionConstructor</span>
<span class="directive">public</span> record MyBookProjection(
        <span class="annotation">@ProjectionBinding</span>(binder = <span class="annotation">@ProjectionBinderRef</span>( <i class="conum" data-value="1"></i><b>(1)</b>
                type = MyFieldProjectionBinder.class
        ))
        <span class="predefined-type">String</span> title) {
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Apply the binder using the <code>@ProjectionBinding</code> annotation.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The book projection can then be used as any <a href="#search-dsl-projection-mapped">custom projection type</a>,
and its <code>title</code> parameter will be initialized with values returned by the custom projection definition:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;MyBookProjection&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .select( MyBookProjection.class )
        .where( f -&gt; f.matchAll() )
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="binding-projection-multi"><a class="anchor" href="#binding-projection-multi"></a>12.12.2. Multi-valued projections</h4>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Features detailed below are <em>incubating</em>: they are still under active development.</p>
</div>
<div class="paragraph">
<p>The usual <a href="https://hibernate.org/community/compatibility-policy/">compatibility policy</a> does not apply:
the contract of incubating elements (e.g. types, methods, configuration properties, etc.)
may be altered in a backward-incompatible way&#8201;&#8212;&#8201;or even removed&#8201;&#8212;&#8201;in subsequent releases.</p>
</div>
<div class="paragraph">
<p>You are encouraged to use incubating features so the development team can get feedback and improve them,
but you should be prepared to update code which relies on them as needed.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can call <code>.multi()</code> on the context passed to the projection binder
in order to discover whether the constructor parameter being bound is multi-valued
(according to the same rules as <a href="#mapping-projection-inner-inference-type">implicit inner projection inference</a>),
and to bind a multi-valued projection.</p>
</div>
<div class="exampleblock">
<div class="title">Example 130. Implementing and using a <code>ProjectionBinder</code> supporting multi-valued projections</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="directive">public</span> <span class="type">class</span> <span class="class">MyFieldProjectionBinder</span> <span class="directive">implements</span> ProjectionBinder {
    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> bind(ProjectionBindingContext context) {
        Optional&lt;? <span class="directive">extends</span> ProjectionBindingMultiContext&gt; multi = context.multi(); <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="keyword">if</span> ( multi.isPresent() ) {
            multi.get().definition( <span class="predefined-type">String</span>.class, <span class="keyword">new</span> MyProjectionDefinition() ); <i class="conum" data-value="2"></i><b>(2)</b>
        }
        <span class="keyword">else</span> {
            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="exception">RuntimeException</span>( <span class="string"><span class="delimiter">&quot;</span><span class="content">This binder only supports multi-valued constructor parameters</span><span class="delimiter">&quot;</span></span> ); <i class="conum" data-value="3"></i><b>(3)</b>
        }
    }

    <span class="directive">private</span> <span class="directive">static</span> <span class="type">class</span> <span class="class">MyProjectionDefinition</span>
            <span class="directive">implements</span> ProjectionDefinition&lt;<span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt;&gt; { <i class="conum" data-value="4"></i><b>(4)</b>
        <span class="annotation">@Override</span>
        <span class="directive">public</span> SearchProjection&lt;<span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt;&gt; create(SearchProjectionFactory&lt;?, ?&gt; factory,
                ProjectionDefinitionContext context) {
            <span class="keyword">return</span> factory.field( <span class="string"><span class="delimiter">&quot;</span><span class="content">tags</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">String</span>.class )
                    .multi() <i class="conum" data-value="4"></i><b>(4)</b>
                    .toProjection();
        }
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>multi()</code> returns an optional that contains a context
if and only if the constructor parameter is considered multi-valued.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Call <code>multi.definition(&#8230;&#8203;)</code> to define the projection to use.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Here we&#8217;re failing for single-valued constructor parameters,
but we could theoreticall fall back to a single-valued projection.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The projection definition, being multi-valued,
must implement <code>ProjectionDefinition&lt;List&lt;T&gt;&gt;</code>,
where <code>T</code> is the exepected type of projected values,
and must configure returned projections accordingly.</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="annotation">@ProjectionConstructor</span>
<span class="directive">public</span> record MyBookProjection(
        <span class="annotation">@ProjectionBinding</span>(binder = <span class="annotation">@ProjectionBinderRef</span>( <i class="conum" data-value="1"></i><b>(1)</b>
                type = MyFieldProjectionBinder.class
        ))
        <span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt; tags) {
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Apply the binder using the <code>@ProjectionBinding</code> annotation.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The book projection can then be used as any <a href="#search-dsl-projection-mapped">custom projection type</a>,
and its <code>tags</code> parameter will be initialized with values returned by the custom projection definition:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;MyBookProjection&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .select( MyBookProjection.class )
        .where( f -&gt; f.matchAll() )
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="binding-projection-composing"><a class="anchor" href="#binding-projection-composing"></a>12.12.3. Composing projection constructors</h4>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Features detailed below are <em>incubating</em>: they are still under active development.</p>
</div>
<div class="paragraph">
<p>The usual <a href="https://hibernate.org/community/compatibility-policy/">compatibility policy</a> does not apply:
the contract of incubating elements (e.g. types, methods, configuration properties, etc.)
may be altered in a backward-incompatible way&#8201;&#8212;&#8201;or even removed&#8201;&#8212;&#8201;in subsequent releases.</p>
</div>
<div class="paragraph">
<p>You are encouraged to use incubating features so the development team can get feedback and improve them,
but you should be prepared to update code which relies on them as needed.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can call <code>.createObjectDefinition( "someFieldPath", SomeType.class )</code> on the context passed to the projection binder
in order to retrieve the definition of an <a href="#search-dsl-projection-object">object projection</a>
based on the <a href="#mapping-projection">projection constructor mapping</a> of <code>SomeType</code>.</p>
</div>
<div class="paragraph">
<p>This effectively allows using projection constructors within projection binders,
simply by passing the resulting definition to <code>.definition(&#8230;&#8203;)</code>
or by delegating to it in a custom projection definition.</p>
</div>
<div class="paragraph">
<p>Other methods exposed on the binding context work similarly:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>.createObjectDefinitionMulti(&#8230;&#8203;)</code> returns a <a href="#binding-projection-multi">multi-valued</a> object projection definition.</p>
</li>
<li>
<p><code>.createCompositeDefinition(&#8230;&#8203;)</code> returns a (single-valued)
<a href="#search-dsl-projection-composite">composite projection</a> definition
(which, on contrary to an <a href="#search-dsl-projection-object">object projection</a>, is not bound to an object field in the index).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Below is an example using <code>.createObjectDefinition(&#8230;&#8203;)</code> to delegate to another projection constructor.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
A similar result can be achieved without a custom projection binder,
simply by relying on <a href="#mapping-projection-inner-inference">implicit inner projection inference</a>
or by using <a href="#search-dsl-projection-object-mapping"><code>@ObjectProjection</code></a>.
This is just to keep the example simple.
</td>
</tr>
</table>
</div>
<div class="exampleblock">
<div class="title">Example 131. Implementing and using a <code>ProjectionBinder</code> that delegates to a projection constructor</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="directive">public</span> <span class="type">class</span> <span class="class">MyObjectFieldProjectionBinder</span> <span class="directive">implements</span> ProjectionBinder {
    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> bind(ProjectionBindingContext context) {
        <span class="type">var</span> authorProjection = context.createObjectDefinition( <i class="conum" data-value="1"></i><b>(1)</b>
                <span class="string"><span class="delimiter">&quot;</span><span class="content">author</span><span class="delimiter">&quot;</span></span>, <i class="conum" data-value="2"></i><b>(2)</b>
                MyBookProjection.MyAuthorProjection.class, <i class="conum" data-value="3"></i><b>(3)</b>
                TreeFilterDefinition.includeAll() <i class="conum" data-value="4"></i><b>(4)</b>
        );
        context.definition( <i class="conum" data-value="5"></i><b>(5)</b>
                MyBookProjection.MyAuthorProjection.class,
                authorProjection
        );
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Call <code>createObjectDefinition(&#8230;&#8203;)</code> to create a definition to delegate to.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Pass the <a href="#search-dsl-projection-object-syntax">name of the object field to project on</a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Pass the <a href="#search-dsl-projection-object-as-mapped">projected type</a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Pass the filter for nested projections; here we&#8217;re not filtering at all.
This controls the same feature as <a href="#search-dsl-projection-object-mapping-filters"><code>includePaths</code>/<code>excludePaths</code>/<code>includeDepths</code> in <code>@ObjectProjection</code></a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Call <code>definition(&#8230;&#8203;)</code> and pass the definition created just above.</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="annotation">@ProjectionConstructor</span>
<span class="directive">public</span> record MyBookProjection(
        <span class="annotation">@ProjectionBinding</span>(binder = <span class="annotation">@ProjectionBinderRef</span>( <i class="conum" data-value="1"></i><b>(1)</b>
                type = MyObjectFieldProjectionBinder.class
        ))
        MyAuthorProjection author) {

    <span class="annotation">@ProjectionConstructor</span> <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="directive">public</span> record MyAuthorProjection(<span class="predefined-type">String</span> name) {
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Apply the binder using the <code>@ProjectionBinding</code> annotation.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Make sure the projected type passed to <code>createObjectDefinition(&#8230;&#8203;)</code> has a projection constructor.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The book projection can then be used as any <a href="#search-dsl-projection-mapped">custom projection type</a>,
and its <code>author</code> parameter will be initialized with values returned by the custom projection definition:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;MyBookProjection&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .select( MyBookProjection.class )
        .where( f -&gt; f.matchAll() )
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="binding-projection-parameters"><a class="anchor" href="#binding-projection-parameters"></a>12.12.4. Passing parameters</h4>
<div class="paragraph">
<p>There are two ways to pass parameters to property bridges:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>One is (mostly) limited to string parameters, but is trivial to implement.</p>
</li>
<li>
<p>The other can allow any type of parameters, but requires you to declare your own annotations.</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="binding-projection-parameters-string"><a class="anchor" href="#binding-projection-parameters-string"></a>Simple, string parameters</h5>
<div class="paragraph">
<p>You can pass string parameters to the <code>@ProjectionBinderRef</code> annotation and then use them later in the binder:</p>
</div>
<div class="exampleblock">
<div class="title">Example 132. Passing parameters to a <code>ProjectionBinder</code> using the <code>@ProjectionBinderRef</code> annotation</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="directive">public</span> <span class="type">class</span> <span class="class">MyFieldProjectionBinder</span> <span class="directive">implements</span> ProjectionBinder {
    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> bind(ProjectionBindingContext context) {
        <span class="predefined-type">String</span> fieldName = context.param( <span class="string"><span class="delimiter">&quot;</span><span class="content">fieldName</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">String</span>.class ); <i class="conum" data-value="1"></i><b>(1)</b>
        context.definition(
                <span class="predefined-type">String</span>.class,
                <span class="keyword">new</span> MyProjectionDefinition( fieldName ) <i class="conum" data-value="2"></i><b>(2)</b>
        );
    }

    <span class="directive">private</span> <span class="directive">static</span> <span class="type">class</span> <span class="class">MyProjectionDefinition</span>
            <span class="directive">implements</span> ProjectionDefinition&lt;<span class="predefined-type">String</span>&gt; {

        <span class="directive">private</span> <span class="directive">final</span> <span class="predefined-type">String</span> fieldName;

        <span class="directive">public</span> MyProjectionDefinition(<span class="predefined-type">String</span> fieldName) { <i class="conum" data-value="2"></i><b>(2)</b>
            <span class="local-variable">this</span>.fieldName = fieldName;
        }

        <span class="annotation">@Override</span>
        <span class="directive">public</span> SearchProjection&lt;<span class="predefined-type">String</span>&gt; create(SearchProjectionFactory&lt;?, ?&gt; factory,
                ProjectionDefinitionContext context) {
            <span class="keyword">return</span> factory.field( fieldName, <span class="predefined-type">String</span>.class ) <i class="conum" data-value="3"></i><b>(3)</b>
                    .toProjection();
        }
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Use the binding context to get the parameter value.
<div class="paragraph">
<p>The <code>param</code> method will throw an exception if the parameter has not been defined.
Alternatively, use <code>paramOptional</code> to get an <code>java.util.Optional</code> that will be empty if the parameter has not been defined.</p>
</div></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Pass the parameter value as an argument to the definition constructor.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Use the parameter value in the projection definition.</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="annotation">@ProjectionConstructor</span>
<span class="directive">public</span> record MyBookProjection(
        <span class="annotation">@ProjectionBinding</span>(binder = <span class="annotation">@ProjectionBinderRef</span>(
                type = MyFieldProjectionBinder.class,
                params = <span class="annotation">@Param</span>( name = <span class="string"><span class="delimiter">&quot;</span><span class="content">fieldName</span><span class="delimiter">&quot;</span></span>, value = <span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span> )
        )) <span class="predefined-type">String</span> title) { <i class="conum" data-value="1"></i><b>(1)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Define the binder to use on the constructor parameter,
setting the <code>fieldName</code> parameter.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="binding-projection-parameters-custom-annotation"><a class="anchor" href="#binding-projection-parameters-custom-annotation"></a>Parameters with custom annotations</h5>
<div class="paragraph">
<p>You can pass parameters of any type to the bridge by defining
a <a href="#mapping-custom-annotations">custom annotation</a> with attributes:</p>
</div>
<div class="exampleblock">
<div class="title">Example 133. Passing parameters to a <code>PropertyBinder</code> using a custom annotation</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="annotation">@Retention</span>(<span class="predefined-type">RetentionPolicy</span>.RUNTIME) <i class="conum" data-value="1"></i><b>(1)</b>
<span class="annotation">@Target</span>({ <span class="predefined-type">ElementType</span>.PARAMETER }) <i class="conum" data-value="2"></i><b>(2)</b>
<span class="annotation">@MethodParameterMapping</span>(processor = <span class="annotation">@MethodParameterMappingAnnotationProcessorRef</span>( <i class="conum" data-value="3"></i><b>(3)</b>
        type = MyFieldProjectionBinding.Processor.class
))
<span class="annotation">@Documented</span> <i class="conum" data-value="4"></i><b>(4)</b>
<span class="directive">public</span> <span class="annotation">@interface</span> MyFieldProjectionBinding {

    <span class="predefined-type">String</span> fieldName() <span class="keyword">default</span> <span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>; <i class="conum" data-value="5"></i><b>(5)</b>

    <span class="type">class</span> <span class="class">Processor</span> <i class="conum" data-value="6"></i><b>(6)</b>
            <span class="directive">implements</span> MethodParameterMappingAnnotationProcessor&lt;MyFieldProjectionBinding&gt; { <i class="conum" data-value="7"></i><b>(7)</b>
        <span class="annotation">@Override</span>
        <span class="directive">public</span> <span class="type">void</span> process(MethodParameterMappingStep mapping, MyFieldProjectionBinding annotation,
                MethodParameterMappingAnnotationProcessorContext context) {
            MyFieldProjectionBinder binder = <span class="keyword">new</span> MyFieldProjectionBinder(); <i class="conum" data-value="8"></i><b>(8)</b>
            <span class="keyword">if</span> ( !annotation.fieldName().isEmpty() ) { <i class="conum" data-value="9"></i><b>(9)</b>
                binder.fieldName( annotation.fieldName() );
            }
            mapping.projection( binder ); <i class="conum" data-value="10"></i><b>(10)</b>
        }
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Define an annotation with <code>RUNTIME</code> retention.
<strong>Any other retention policy will cause the annotation to be ignored by Hibernate Search</strong>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Since we will be mapping a projection definition to a projection constructor,
allow the annotation to target method parameters (constructors are methods).</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Mark this annotation as a method parameter mapping,
and instruct Hibernate Search to apply the given processor whenever it finds this annotation.
It is also possible to reference the processor by its CDI/Spring bean name.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Optionally, mark the annotation as documented,
so that it is included in the javadoc of your entities.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Define an attribute of type <code>String</code> to specify the field name.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Here the processor class is nested in the annotation class,
because it is more convenient,
but you are obviously free to implement it in a separate Java file.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>The processor must implement the <code>MethodParameterMappingAnnotationProcessor</code> interface,
setting its generic type argument to the type of the corresponding annotation.</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>In the annotation processor, instantiate the binder.</td>
</tr>
<tr>
<td><i class="conum" data-value="9"></i><b>9</b></td>
<td>Process the annotation attributes and pass the data to the binder.
<div class="paragraph">
<p>Here we&#8217;re using a setter, but passing the data through the constructor would work, too.</p>
</div></td>
</tr>
<tr>
<td><i class="conum" data-value="10"></i><b>10</b></td>
<td>Apply the binder to the constructor parameter.</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="directive">public</span> <span class="type">class</span> <span class="class">MyFieldProjectionBinder</span> <span class="directive">implements</span> ProjectionBinder {

    <span class="directive">private</span> <span class="predefined-type">String</span> fieldName = <span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>;

    <span class="directive">public</span> MyFieldProjectionBinder fieldName(<span class="predefined-type">String</span> fieldName) { <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="local-variable">this</span>.fieldName = fieldName;
        <span class="keyword">return</span> <span class="local-variable">this</span>;
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> bind(ProjectionBindingContext context) {
        context.definition(
                <span class="predefined-type">String</span>.class,
                <span class="keyword">new</span> MyProjectionDefinition( fieldName ) <i class="conum" data-value="2"></i><b>(2)</b>
        );
    }

    <span class="directive">private</span> <span class="directive">static</span> <span class="type">class</span> <span class="class">MyProjectionDefinition</span>
            <span class="directive">implements</span> ProjectionDefinition&lt;<span class="predefined-type">String</span>&gt; {

        <span class="directive">private</span> <span class="directive">final</span> <span class="predefined-type">String</span> fieldName;

        <span class="directive">public</span> MyProjectionDefinition(<span class="predefined-type">String</span> fieldName) { <i class="conum" data-value="2"></i><b>(2)</b>
            <span class="local-variable">this</span>.fieldName = fieldName;
        }

        <span class="annotation">@Override</span>
        <span class="directive">public</span> SearchProjection&lt;<span class="predefined-type">String</span>&gt; create(SearchProjectionFactory&lt;?, ?&gt; factory,
                ProjectionDefinitionContext context) {
            <span class="keyword">return</span> factory.field( fieldName, <span class="predefined-type">String</span>.class ) <i class="conum" data-value="3"></i><b>(3)</b>
                    .toProjection();
        }
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Implement setters in the binder.
Alternatively, we could expose a parameterized constructor.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>In the <code>bind</code> method, use the value of parameters.
Here we pass the parameter value as an argument to the definition constructor.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Use the parameter value in the projection definition.</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="annotation">@ProjectionConstructor</span>
<span class="directive">public</span> record MyBookProjection(
        <span class="annotation">@MyFieldProjectionBinding</span>(fieldName = <span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>) <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="predefined-type">String</span> title) {
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Apply the binder using its custom annotation,
setting the <code>fieldName</code> parameter.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="binding-projection-injecting-beans"><a class="anchor" href="#binding-projection-injecting-beans"></a>12.12.5. Injecting beans into the binder</h4>
<div class="paragraph">
<p>With <a href="#configuration-bean-frameworks">compatible frameworks</a>,
Hibernate Search supports injecting beans into:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the <code>MethodParameterMappingAnnotationProcessor</code> if you use <a href="#binding-projection-parameters-custom-annotation">custom annotations</a>.</p>
</li>
<li>
<p>the <code>ProjectionBinder</code> if you use the <a href="#binding-projection-basics"><code>@ProjectionBinding</code> annotation</a>.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This only applies to beans instantiated
through Hibernate Search&#8217;s <a href="#configuration-bean-resolution">bean resolution</a>.
As a rule of thumb, if you need to call <code>new MyBinder()</code> explicitly at some point,
the binder won&#8217;t get auto-magically injected.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The context passed to the property binder&#8217;s <code>bind</code> method
also exposes a <code>beanResolver()</code> method to access the bean resolver and instantiate beans explicitly.</p>
</div>
<div class="paragraph">
<p>See <a href="#configuration-bean-injection"> Bean injection</a> for more details.</p>
</div>
</div>
<div class="sect3">
<h4 id="binding-projection-programmatic"><a class="anchor" href="#binding-projection-programmatic"></a>12.12.6. Programmatic mapping</h4>
<div class="paragraph">
<p>You can apply a projection binder through the <a href="#mapping-programmatic">programmatic mapping</a> too.
Just pass an instance of the binder to <code>.projection(&#8230;&#8203;)</code>. You can pass arguments either through the binder&#8217;s constructor, or through setters.</p>
</div>
<div class="exampleblock">
<div class="title">Example 134. Applying a <code>ProjectionBinder</code> with <code>.projection(&#8230;&#8203;)</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">TypeMappingStep myBookProjectionMapping = mapping.type( MyBookProjection.class );
myBookProjectionMapping.mainConstructor().projectionConstructor();
myBookProjectionMapping.mainConstructor().parameter( <span class="integer">0</span> )
        .projection( <span class="keyword">new</span> MyFieldProjectionBinder().fieldName( <span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span> ) );</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="binding-projection-parameters-incubating"><a class="anchor" href="#binding-projection-parameters-incubating"></a>12.12.7. Other incubating features</h4>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Features detailed below are <em>incubating</em>: they are still under active development.</p>
</div>
<div class="paragraph">
<p>The usual <a href="https://hibernate.org/community/compatibility-policy/">compatibility policy</a> does not apply:
the contract of incubating elements (e.g. types, methods, configuration properties, etc.)
may be altered in a backward-incompatible way&#8201;&#8212;&#8201;or even removed&#8201;&#8212;&#8201;in subsequent releases.</p>
</div>
<div class="paragraph">
<p>You are encouraged to use incubating features so the development team can get feedback and improve them,
but you should be prepared to update code which relies on them as needed.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The context passed to the projection binder&#8217;s <code>bind</code> method
exposes a <code>constructorParameter()</code> method that gives access to metadata about the constructor parameter being bound.</p>
</div>
<div class="paragraph">
<p>The metadata can be used to inspect the constructor parameter in details:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Getting the name of the constructor parameter.</p>
</li>
<li>
<p>Checking the type of the constructor parameter.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Similarly, the <a href="#binding-projection-multi">context used for multi-valued projection binding</a>
exposes a <code>containerElement()</code> method that gives access to the type of elements
of the (multi-valued) constructor parameter type.</p>
</div>
<div class="paragraph">
<p>See the javadoc for more information.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The name of the constructor parameter is only available:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>For the canonical constructor of record types, regardless of compiler flags.</p>
</li>
<li>
<p>For constructors of non-record types or non-canonical constructors of record types
if and only if the type was compiled with the <code>-parameters</code> compiler flag.</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Below is an example of the simplest use of this metadata,
getting the constructor parameter name and using it as a field name.</p>
</div>
<div class="exampleblock">
<div class="title">Example 135. Projecting on a field whose name is the same as the constructor parameter name in a <code>ProjectionBinder</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="directive">public</span> <span class="type">class</span> <span class="class">MyFieldProjectionBinder</span> <span class="directive">implements</span> ProjectionBinder {
    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> bind(ProjectionBindingContext context) {
        <span class="type">var</span> constructorParam = context.constructorParameter(); <i class="conum" data-value="1"></i><b>(1)</b>
        context.definition(
                <span class="predefined-type">String</span>.class,
                <span class="keyword">new</span> MyProjectionDefinition( constructorParam.name().orElseThrow() ) <i class="conum" data-value="2"></i><b>(2)</b>
        );
    }

    <span class="directive">private</span> <span class="directive">static</span> <span class="type">class</span> <span class="class">MyProjectionDefinition</span>
            <span class="directive">implements</span> ProjectionDefinition&lt;<span class="predefined-type">String</span>&gt; {
        <span class="directive">private</span> <span class="directive">final</span> <span class="predefined-type">String</span> fieldName;

        <span class="directive">private</span> MyProjectionDefinition(<span class="predefined-type">String</span> fieldName) {
            <span class="local-variable">this</span>.fieldName = fieldName;
        }

        <span class="annotation">@Override</span>
        <span class="directive">public</span> SearchProjection&lt;<span class="predefined-type">String</span>&gt; create(SearchProjectionFactory&lt;?, ?&gt; factory,
                ProjectionDefinitionContext context) {
            <span class="keyword">return</span> factory.field( fieldName, <span class="predefined-type">String</span>.class ) <i class="conum" data-value="3"></i><b>(3)</b>
                    .toProjection();
        }
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Use the binding context to get the constructor parameter.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Pass the name of the constructor parameter to the projection definition.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Use the name of the constructor parameter as the projected field name.</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="annotation">@ProjectionConstructor</span>
<span class="directive">public</span> record MyBookProjection(
        <span class="annotation">@ProjectionBinding</span>(binder = <span class="annotation">@ProjectionBinderRef</span>( <i class="conum" data-value="1"></i><b>(1)</b>
                type = MyFieldProjectionBinder.class
        ))
        <span class="predefined-type">String</span> title) {
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Apply the binder using the <code>@ProjectionBinding</code> annotation.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="schema-management"><a class="anchor" href="#schema-management"></a>13. <a id="mapper-orm-schema-management"></a> Managing the index schema</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="schema-management-basics"><a class="anchor" href="#schema-management-basics"></a>13.1. <a id="mapper-orm-schema-management-basics"></a> Basics</h3>
<div class="paragraph">
<p>Before indexes can be used for indexing or searching, they must be created on disk (Lucene) or in the remote cluster (Elasticsearch).
With Elasticsearch in particular, this creation may not be obvious since it requires to describe the schema for each index,
which includes in particular:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the definition of every analyzer or normalizer used in this index;</p>
</li>
<li>
<p>the definition of every single field used in this index,
including in particular its type, the analyzer assigned to it, whether it requires doc values, etc.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Hibernate Search has all the necessary information to generate this schema automatically,
so it is possible to delegate the task of managing the schema to Hibernate Search.</p>
</div>
</div>
<div class="sect2">
<h3 id="schema-management-strategy"><a class="anchor" href="#schema-management-strategy"></a>13.2. <a id="mapper-orm-schema-management-strategy"></a> Automatic schema management on startup/shutdown</h3>
<div class="paragraph">
<p>The property <code>hibernate.search.schema_management.strategy</code> can be set to one of the following values
in order to define what to do with the indexes and their schema on startup and shutdown.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 50%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Strategy</th>
<th class="tableblock halign-left valign-top">Definition</th>
<th class="tableblock halign-left valign-top">Warnings</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="mapper-orm-schema-management-strategy-none"></a><code>none</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>A strategy that does not do anything on startup or shutdown.</p>
</div>
<div class="paragraph">
<p>Indexes and their schema will not be created nor deleted on startup or shutdown.
Hibernate Search will <strong>not even check</strong> that the index actually exists.</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>With Elasticsearch, indexes and their schema will have to be created explicitly before startup.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="mapper-orm-schema-management-strategy-validate"></a><code>validate</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>A strategy that does not change indexes nor their schema,
but checks that indexes exist and validates their schema on startup.</p>
</div>
<div class="paragraph">
<p>An exception will be thrown on startup if:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Indexes are missing</p>
</li>
<li>
<p>OR, with the Elasticsearch backend only, indexes exist but their schema does not match the requirements
of the Hibernate Search mapping:
missing fields, fields with incorrect type, missing analyzer definitions or normalizer definitions, &#8230;&#8203;</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>"Compatible" differences such as extra fields <a href="#schema-management-concepts-validation-permissive">are ignored</a>.</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Indexes and their schema will have to be created explicitly before startup.</p>
</div>
<div class="paragraph">
<p>With the Lucene backend, validation is limited to checking that the indexes exist,
because <a href="#schema-management-concepts-lucene-schema">local Lucene indexes don&#8217;t have a schema</a>.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="schema-management-strategy-create"></a><code>create</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="mapper-orm-schema-management-strategy-create"></a>A strategy that creates missing indexes and their schema on startup,
but does not touch existing indexes and assumes their schema is correct without validating it.</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a href="#schema-management-concepts-massindexing">Creating a schema does not populate indexed data</a>.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="schema-management-strategy-create-or-validate"></a><code>create-or-validate</code> (<strong>default</strong>)</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="mapper-orm-schema-management-strategy-create-or-validate"></a>A strategy that creates missing indexes and their schema on startup,
and validates the schema of existing indexes.</p>
</div>
<div class="paragraph">
<p>With the Elasticsearch backend only, an exception will be thrown on startup if some indexes already exist
but their schema does not match the requirements of the Hibernate Search mapping:
missing fields, fields with incorrect type, missing analyzer definitions or normalizer definitions, &#8230;&#8203;</p>
</div>
<div class="paragraph">
<p>"Compatible" differences such as extra fields <a href="#schema-management-concepts-validation-permissive">are ignored</a>.</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a href="#schema-management-concepts-massindexing">Creating a schema does not populate indexed data</a>.</p>
</div>
<div class="paragraph">
<p>With the Lucene backend, validation is limited to checking that the indexes exist,
because <a href="#schema-management-concepts-lucene-schema">local Lucene indexes don&#8217;t have a schema</a>.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="schema-management-strategy-create-or-update"></a><code>create-or-update</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="mapper-orm-schema-management-strategy-create-or-update"></a>A strategy that creates missing indexes and their schema on startup,
and updates the schema of existing indexes if possible.</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a href="#schema-management-concepts-massindexing">Updating a schema does not update indexed data</a>.</p>
</div>
<div class="paragraph">
<p><strong>This strategy is unfit for production environments</strong>,
due to several limitations including
<a href="#schema-management-concepts-update-failure">the impossibility to change the type of an existing field</a>
or <a href="#schema-management-concepts-index-closing">the requirement to close indexes while updating analyzer definitions</a>
(which is not possible at all on AWS).</p>
</div>
<div class="paragraph">
<p>With the Lucene backend, schema update is a no-op,
because <a href="#schema-management-concepts-lucene-schema">local Lucene indexes don&#8217;t have a schema</a>.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="mapper-orm-schema-management-strategy-drop-and-create"></a><code>drop-and-create</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>A strategy that drops existing indexes and re-creates them and their schema on startup.</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a href="#schema-management-concepts-drop-loses-data">All indexed data will be lost</a> on startup.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="mapper-orm-schema-management-strategy-drop-and-create-and-drop"></a><code>drop-and-create-and-drop</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>A strategy that drops existing indexes and re-creates them and their schema on startup,
then drops the indexes on shutdown.</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a href="#schema-management-concepts-drop-loses-data">All indexed data will be lost</a> on startup and shutdown.</p>
</div></div></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="schema-management-manager"><a class="anchor" href="#schema-management-manager"></a>13.3. <a id="mapper-orm-schema-management-manager"></a> Manual schema management</h3>
<div class="paragraph">
<p>Schema management does not have to happen automatically on startup and shutdown.</p>
</div>
<div class="paragraph">
<p>Using the <code>SearchSchemaManager</code> interface,
it is possible to trigger schema management operations explicitly
after Hibernate Search has started.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The most common use case is to set the <a href="#schema-management-strategy">automatic schema management strategy</a> to <code>none</code>
and handle the creation/deletion of indexes manually when some other conditions are met,
for example the Elasticsearch cluster has finished booting.</p>
</div>
<div class="paragraph">
<p>After schema management operations are complete,
you will often want to populate indexes.
To that end, use the <a href="#indexing-massindexer">mass indexer</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <code>SearchSchemaManager</code> interface exposes the following methods.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 50%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Method</th>
<th class="tableblock halign-left valign-top">Definition</th>
<th class="tableblock halign-left valign-top">Warnings</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="mapper-orm-schema-management-manager-validate"></a><code>validate()</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Does not change indexes nor their schema,
but checks that indexes exist and validates their schema.</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>With the Lucene backend, validation is limited to checking that the indexes exist,
because <a href="#schema-management-concepts-lucene-schema">local Lucene indexes don&#8217;t have a schema</a>.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="mapper-orm-schema-management-manager-create-if-missing"></a><code>createIfMissing()</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Creates missing indexes and their schema,
but does not touch existing indexes and assumes their schema is correct without validating it.</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a href="#schema-management-concepts-massindexing">Creating a schema does not populate indexed data</a>.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="mapper-orm-schema-management-manager-create-or-validate"></a><code>createOrValidate()</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Creates missing indexes and their schema,
and validates the schema of existing indexes.</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a href="#schema-management-concepts-massindexing">Creating a schema does not populate indexed data</a>.</p>
</div>
<div class="paragraph">
<p>With the Lucene backend, validation is limited to checking that the indexes exist,
because <a href="#schema-management-concepts-lucene-schema">local Lucene indexes don&#8217;t have a schema</a>.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="mapper-orm-schema-management-manager-create-or-update"></a><code>createOrUpdate()</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Creates missing indexes and their schema,
and updates the schema of existing indexes if possible.</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a href="#schema-management-concepts-massindexing">Updating a schema does not update indexed data</a>.</p>
</div>
<div class="paragraph">
<p>With the Elasticsearch backend, <a href="#schema-management-concepts-update-failure">updating a schema may fail</a>.</p>
</div>
<div class="paragraph">
<p>With the Elasticsearch backend, <a href="#schema-management-concepts-index-closing">updating a schema may close indexes while updating analyzer definitions</a>
(which is not possible at all on <a href="#backend-elasticsearch-compatibility-amazon-opensearch-service">Amazon OpenSearch Service</a>).</p>
</div>
<div class="paragraph">
<p>With the Lucene backend, schema update is a no-op,
because <a href="#schema-management-concepts-lucene-schema">local Lucene indexes don&#8217;t have a schema</a>.
(it just creates missing indexes).</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="mapper-orm-schema-management-manager-drop-if-existing"></a><code>dropIfExisting()</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Drops existing indexes.</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a href="#schema-management-concepts-drop-loses-data">All indexed data will be lost</a>.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="mapper-orm-schema-management-manager-drop-and-create"></a><code>dropAndCreate()</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Drops existing indexes and re-creates them and their schema.</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a href="#schema-management-concepts-drop-loses-data">All indexed data will be lost</a>.</p>
</div></div></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Below is an example using a <code>SearchSchemaManager</code> to drop and create indexes,
then using a <a href="#indexing-massindexer">mass indexer</a> to re-populate the indexes.
The
<a href="#indexing-massindexer-parameters-drop-and-create-schema"><code>dropAndCreateSchemaOnStart</code> setting of the mass indexer</a>
would be an alternative solution to achieve the same results.</p>
</div>
<div class="exampleblock">
<div class="title">Example 136. Reinitializing indexes using a <code>SearchSchemaManager</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">SearchSession searchSession = <span class="comment">/* ... */</span> <i class="conum" data-value="1"></i><b>(1)</b>
SearchSchemaManager schemaManager = searchSession.schemaManager(); <i class="conum" data-value="2"></i><b>(2)</b>
schemaManager.dropAndCreate(); <i class="conum" data-value="3"></i><b>(3)</b>
searchSession.massIndexer()
        .purgeAllOnStart( <span class="predefined-constant">false</span> )
        .startAndWait(); <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><a href="#entrypoints-search-session">Retrieve the <code>SearchSession</code></a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Get a schema manager.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Drop and create the indexes.
This method is synchronous and will only return after the operation is complete.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Optionally, trigger <a href="#indexing-massindexer">mass indexing</a>.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>You can also select entity types when creating a schema manager,
to manage the indexes of these types only (and their indexed subtypes, if any):</p>
</div>
<div class="exampleblock">
<div class="title">Example 137. Reinitializing only some indexes using a <code>SearchSchemaManager</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">SearchSchemaManager schemaManager = searchSession.schemaManager( <span class="predefined-type">Book</span>.class ); <i class="conum" data-value="1"></i><b>(1)</b>
schemaManager.dropAndCreate(); <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Get a schema manager targeting the index mapped to the <code>Book</code> entity type.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Drop and create the index for the <code>Book</code> entity only.
Other indexes are unaffected.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="schema-management-concepts"><a class="anchor" href="#schema-management-concepts"></a>13.4. <a id="mapper-orm-schema-management-concepts"></a> How schema management works</h3>
<div id="schema-management-concepts-massindexing" class="dlist">
<dl>
<dt class="hdlist1"><a id="mapper-orm-schema-management-concepts-massindexing"></a>Creating/updating a schema does not create/update indexed data</dt>
<dd>
<p>Creating or updating indexes and their schema through schema management
will not populate the indexes:</p>
<div class="ulist">
<ul>
<li>
<p>newly created indexes will always be empty.</p>
</li>
<li>
<p>indexes with a recently updated schema will still contain the same indexed data,
i.e. new fields won&#8217;t be added to documents just because they were added to the schema.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>This is by design: reindexing is a potentially long-running task that should be triggered explicitly.
To populate indexes with pre-existing data from the database,
use <a href="#indexing-massindexer">mass indexing</a>.</p>
</div>
<div id="schema-management-concepts-drop-loses-data" class="dlist">
<dl>
<dt class="hdlist1"><a id="mapper-orm-schema-management-concepts-drop-loses-data"></a>Dropping the schema means losing indexed data</dt>
<dd>
<p>Dropping a schema will drop the whole index, including all indexed data.</p>
<div class="paragraph">
<p>A dropped index will need to be re-created through schema management,
then populated with pre-existing data from the database through <a href="#indexing-massindexer">mass indexing</a>.</p>
</div>
</dd>
</dl>
</div>
<div id="schema-management-concepts-lucene-schema" class="dlist">
<dl>
<dt class="hdlist1"><a id="mapper-orm-schema-management-concepts-lucene-schema"></a>Schema validation and update are not effective with Lucene</dt>
<dd>
<p>The Lucene backend will only validate that the index actually exists and create missing indexes,
because there is no concept of schema in Lucene
beyond the existence of index segments.</p>
</dd>
</dl>
</div>
<div id="schema-management-concepts-validation-permissive" class="dlist">
<dl>
<dt class="hdlist1"><a id="mapper-orm-schema-management-concepts-validation-permissive"></a>Schema validation is permissive</dt>
<dd>
<p>With Elasticsearch, schema validation is as permissive as possible:</p>
<div class="ulist">
<ul>
<li>
<p>Fields that are unknown to Hibernate Search will be ignored.</p>
</li>
<li>
<p>Settings that are more powerful than required will be deemed valid.
For example, a field that is not marked as sortable in Hibernate Search
but marked as <code>"docvalues": true</code> in Elasticsearch will be deemed valid.</p>
</li>
<li>
<p>Analyzer/normalizer definitions that are unknown to Hibernate Search will be ignored.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>One exception: date formats must match exactly the formats specified by Hibernate Search,
due to implementation constraints.</p>
</div>
</dd>
</dl>
</div>
<div id="schema-management-concepts-update-failure" class="dlist">
<dl>
<dt class="hdlist1"><a id="mapper-orm-schema-management-concepts-update-failure"></a>Schema updates may fail</dt>
<dd>
<p>A schema update, triggered by the <code>create-or-update</code> strategy, may simply fail.
This is because schemas may change in an incompatible way, such as a field having its type changed,
or its analyzer changed, etc.</p>
<div class="paragraph">
<p>Worse, since updates are handled on a per-index basis,
a schema update may succeed for one index but fail on another,
leaving your schema as a whole half-updated.</p>
</div>
<div class="paragraph">
<p>For these reasons, <strong>using schema updates in a production environment is not recommended</strong>.
Whenever the schema changes, you should either:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>drop and create indexes, then <a href="#indexing-massindexer">reindex</a>.</p>
</li>
<li>
<p>OR update the schema manually through custom scripts.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In this case, the <code>create-or-update</code> strategy will prevent Hibernate Search from starting,
but it may already have successfully updated the schema for another index, making a rollback difficult.</p>
</div>
</dd>
</dl>
</div>
<div id="schema-management-concepts-index-closing" class="dlist">
<dl>
<dt class="hdlist1"><a id="mapper-orm-schema-management-concepts-index-closing"></a>Schema updates on Elasticsearch may close indexes</dt>
<dd>
<p>Elasticsearch does not allow updating analyzer/normalizer definitions on an open index.
Thus, when analyzer or normalizer definitions have to be updated during a schema update,
Hibernate Search will temporarily stop the affected indexes.</p>
<div class="paragraph">
<p>For this reason, the <code>create-or-update</code> strategy should be used with caution
when multiple clients use Elasticsearch indexes managed by Hibernate Search:
those clients should be synchronized in such a way that while Hibernate Search is starting,
no other client needs to access the index.</p>
</div>
<div class="paragraph">
<p>Also, on <a href="#backend-elasticsearch-compatibility-amazon-opensearch-service">Amazon OpenSearch Service</a>
running Elasticsearch (not OpenSearch) in version 7.1 or older,
as well as on <a href="#backend-elasticsearch-compatibility-amazon-opensearch-serverless">Amazon OpenSearch Serverless</a>,
the <code>_close</code>/<code>_open</code> operations are not supported,
so <strong>the schema update will fail</strong> when trying to update analyzer definitions.
The only workaround is to avoid the schema update on these platforms.
It should be avoided in production environments regardless:
see <a href="#schema-management-concepts-update-failure">[schema-management-concepts-update-failure]</a>.</p>
</div>
</dd>
</dl>
</div>
</div>
<div class="sect2">
<h3 id="schema-management-export"><a class="anchor" href="#schema-management-export"></a>13.5. Exporting the schema</h3>
<div class="sect3">
<h4 id="schema-management-export-filesystem"><a class="anchor" href="#schema-management-export-filesystem"></a>13.5.1. Exporting the schema to a set of files</h4>
<div class="paragraph">
<p>The <a href="#mapper-orm-schema-management-manager">schema manager</a> provides a way to export schemas to the filesystem.
The output is backend-specific.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Schema exports are constructed based on the mapping information and configurations (e.g. such as the backend version).
Resulting exports are not compared to or validated against the actual backend schema.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For Elasticsearch, the files provide the necessary information to create indexes (along with their settings and mapping).
The file tree structure of an export is shown below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code># For the default backend the index schema will be written to:
.../backend/indexes/&lt;index-name&gt;/create-index.json
.../backend/indexes/&lt;index-name&gt;/create-index-query-params.json
# For additional named backends:
.../backends/&lt;name of a particular backend&gt;/indexes/&lt;index-name&gt;/create-index.json
.../backends/&lt;name of a particular backend&gt;/indexes/&lt;index-name&gt;/create-index-query-params.json</code></pre>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 138. Exporting the schema to the filesystem</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">SearchSchemaManager schemaManager = searchSession.schemaManager(); <i class="conum" data-value="1"></i><b>(1)</b>
schemaManager.exportExpectedSchema( targetDirectory ); <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Retrieve the <code>SearchSchemaManager</code> from a <code>SearchSession</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Export the schema to a target directory.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="schema-management-export-custom"><a class="anchor" href="#schema-management-export-custom"></a>13.5.2. Exporting to a custom collector</h4>
<div class="paragraph">
<p><a href="#mapper-orm-schema-management-manager">Search schema managers</a> allow walking through the schema exports based on the data such managers contains.
To do so a <code>SearchSchemaCollector</code> must be implemented and passed to the schema manager&#8217;s <code>exportExpectedSchema(..)</code> method.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Schema exports are constructed based on the mapping information and configurations (e.g. such as the backend version).
Resulting exports are not compared to or validated against the actual backend schema.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="exampleblock">
<div class="title">Example 139. Exporting to a custom collector</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">SearchSchemaManager schemaManager = searchSession.schemaManager(); <i class="conum" data-value="1"></i><b>(1)</b>
schemaManager.exportExpectedSchema(
        <span class="keyword">new</span> SearchSchemaCollector() { <i class="conum" data-value="2"></i><b>(2)</b>
            <span class="annotation">@Override</span>
            <span class="directive">public</span> <span class="type">void</span> indexSchema(Optional&lt;<span class="predefined-type">String</span>&gt; backendName, <span class="predefined-type">String</span> indexName, SchemaExport <span class="keyword">export</span>) {
                <span class="predefined-type">String</span> name = backendName.orElse( <span class="string"><span class="delimiter">&quot;</span><span class="content">default</span><span class="delimiter">&quot;</span></span> ) + <span class="string"><span class="delimiter">&quot;</span><span class="content">:</span><span class="delimiter">&quot;</span></span> + indexName; <i class="conum" data-value="3"></i><b>(3)</b>
                <span class="comment">// perform any other actions with an index schema export</span>
            }
        }
);</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Retrieve the <code>SearchSchemaManager</code> from a <code>SearchSession</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Instantiate and pass the <code>SearchSchemaCollector</code> to walk a schema.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Create a name from an index and backend names.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>To access backend-specific functionality, an extension to <code>SchemaExport</code> can be applied:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="keyword">new</span> SearchSchemaCollector() {

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> indexSchema(Optional&lt;<span class="predefined-type">String</span>&gt; backendName, <span class="predefined-type">String</span> indexName, SchemaExport <span class="keyword">export</span>) {
        <span class="predefined-type">List</span>&lt;JsonObject&gt; bodyParts = <span class="keyword">export</span>
                .extension( ElasticsearchExtension.get() ) <i class="conum" data-value="1"></i><b>(1)</b>
                .bodyParts(); <i class="conum" data-value="2"></i><b>(2)</b>
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Extend the <code>SchemaExport</code> with the Elasticsearch extension.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Access an HTTP body of a request that is needed to create an index in an Elasticsearch cluster.</td>
</tr>
</table>
</div>
</div>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="schema-management-export-offline"><a class="anchor" href="#schema-management-export-offline"></a>13.5.3. Exporting in offline mode</h4>
<div class="paragraph">
<p>Sometimes it can be useful to export the schema offline,
from an environment that doesn&#8217;t have access to e.g. the Elasticsearch cluster.</p>
</div>
<div class="paragraph">
<p>See <a href="#backend-elasticsearch-configuration-version">this section</a> for more information on how to achieve offline startup.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="indexing"><a class="anchor" href="#indexing"></a>14. <a id="mapper-orm-indexing"></a> Indexing entities</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="indexing-basics"><a class="anchor" href="#indexing-basics"></a>14.1. Basics</h3>
<div class="paragraph">
<p>There are multiple ways to index entities in Hibernate Search.</p>
</div>
<div class="paragraph">
<p>If you want to get to know the most popular ones,
head directly to the following section:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>To keep indexes synchronized transparently as entities change in a Hibernate ORM <code>Session</code>,
see <a href="#listener-triggered-indexing">listener-triggered indexing</a>.</p>
</li>
<li>
<p>To index a large amount of data&#8201;&#8212;&#8201;for example the whole database, when adding Hibernate Search to an existing application&#8201;&#8212;&#8201;see the <a href="#indexing-massindexer"><code>MassIndexer</code></a>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Otherwise, the following table may help you figure out what&#8217;s best for your use case.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 7. Comparison of indexing methods</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name and link</th>
<th class="tableblock halign-center valign-top">Use case</th>
<th class="tableblock halign-center valign-top">API</th>
<th class="tableblock halign-center valign-top">Mapper</th>
</tr>
</thead>
<tbody>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock"><a href="#listener-triggered-indexing">Listener-triggered indexing</a></p></th>
<td class="tableblock halign-center valign-top"><p class="tableblock">Handle incremental changes in application transactions</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">None: works implicitly without API calls</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><a href="#mapper-orm">Hibernate ORM integration</a> only</p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock"><a href="#indexing-massindexer"><code>MassIndexer</code></a></p></th>
<td class="tableblock halign-center valign-top" rowspan="2"><p class="tableblock">Reindex large volumes of data in batches</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">Specific to Hibernate Search</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><a href="#mapper-orm">Hibernate ORM integration</a> or <a href="#mapper-pojo-standalone">Standalone POJO Mapper</a></p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock"><a href="#mapper-orm-indexing-jakarta-batch">Jakarta Batch mass indexing job</a></p></th>
<td class="tableblock halign-center valign-top"><p class="tableblock">Jakarta EE standard</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><a href="#mapper-orm">Hibernate ORM integration</a> only</p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock"><a href="#indexing-explicit">Explicit indexing</a></p></th>
<td class="tableblock halign-center valign-top"><p class="tableblock">Anything else</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">Specific to Hibernate Search</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><a href="#mapper-orm">Hibernate ORM integration</a> or <a href="#mapper-pojo-standalone">Standalone POJO Mapper</a></p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="indexing-plan"><a class="anchor" href="#indexing-plan"></a>14.2. Indexing plans</h3>
<div class="sect3">
<h4 id="indexing-plan-basics"><a class="anchor" href="#indexing-plan-basics"></a>14.2.1. Basics</h4>
<div class="paragraph">
<p>For <a href="#listener-triggered-indexing">listener-triggered indexing</a> as well
as <a href="#indexing-explicit">some forms of explicit indexing</a>,
Hibernate Search relies on an "indexing plan" to aggregate "entity change" events
and infer the resulting indexing operations to execute.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Indexing plans are not used for the <a href="#indexing-massindexer"><code>MassIndexer</code></a>
or the <a href="#mapper-orm-indexing-jakarta-batch">Jakarta Batch mass indexing job</a>:
those assume all entities they process need to be indexed
and don&#8217;t need the more subtle mechanisms of indexing plans.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Here is how indexing plans work at a high level:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>While the application performs entity changes,
entity change events (entity created, updated, deleted) are added to the plan.</p>
<div class="paragraph">
<p>For <a href="#listener-triggered-indexing">listener-triggered indexing</a> (<a href="#mapper-orm">Hibernate ORM integration</a> only)
this happens implicitly as changes are performed,
but it can also be done <a href="#indexing-explicit">explicitly</a>.</p>
</div>
</li>
<li>
<p>Eventually, the application decides changes are complete,
and the plan processes change events added so far,
either inferring which entities need to be reindexed and building the corresponding documents (<a href="#coordination-none">no coordination</a>)
or building events to be sent to the outbox (<a href="#coordination-outbox-polling"><code>outbox-polling</code> coordination</a>).</p>
<div class="paragraph">
<p>For the <a href="#mapper-orm">Hibernate ORM integration</a> this happens when the Hibernate ORM <code>Session</code> gets flushed
(explicitly or as part of a transaction commit),
while for the <a href="#mapper-pojo-standalone">Standalone POJO Mapper</a> this happens when the <code>SearchSession</code> is closed.</p>
</div>
</li>
<li>
<p>Finally the plan gets executed, triggering indexing, potentially asynchronously.</p>
<div class="paragraph">
<p>For the <a href="#mapper-orm">Hibernate ORM integration</a> this happens on transaction commit,
while for the <a href="#mapper-pojo-standalone">Standalone POJO Mapper</a> this happens when the <code>SearchSession</code> is closed.</p>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Below is a summary of key characteristics of indexing plans
and how they vary depending on the configured <a href="#coordination">coordination strategy</a>.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 8. Comparison of indexing plans depending on the coordination strategy</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Coordination strategy</th>
<th class="tableblock halign-center valign-top"><a href="#coordination-none">No coordination</a> (default)</th>
<th class="tableblock halign-center valign-top"><a href="#coordination-outbox-polling">Outbox polling</a> (<a href="#mapper-orm">Hibernate ORM integration</a> only)</th>
</tr>
</thead>
<tbody>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">Guarantee of indexes updates</p></th>
<td class="tableblock halign-center valign-top"><p class="tableblock"><a href="#coordination-none-indexing-guarantee">Non-transactional, after the database transaction / <code>SearchSession.close()</code> returns</a></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><a href="#coordination-outbox-polling-indexing-guarantee">Transactional, on database transaction commit</a></p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">Visibility of index updates</p></th>
<td class="tableblock halign-center valign-top"><p class="tableblock"><a href="#coordination-none-indexing-visibility">Configurable: immediate (poor performance) or eventual</a></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><a href="#coordination-outbox-polling-indexing-visibility">Eventual</a></p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">Overhead for application threads</p></th>
<td class="tableblock halign-center valign-top"><p class="tableblock"><a href="#coordination-none-indexing-on-flush">Low to medium</a></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><a href="#coordination-outbox-polling-indexing-background">Very low</a></p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">Overhead for the database (<a href="#mapper-orm">Hibernate ORM integration</a> only)</p></th>
<td class="tableblock halign-center valign-top"><p class="tableblock"><a href="#coordination-none-indexing-lazy-loading">Low</a></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><a href="#coordination-outbox-polling-indexing-full-loading">Low to medium</a></p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="indexing-plan-synchronization"><a class="anchor" href="#indexing-plan-synchronization"></a>14.2.2. <a id="indexing-automatic-synchronization"></a> <a id="mapper-orm-indexing-automatic-synchronization"></a> Synchronization with the indexes</h4>
<div class="sect4">
<h5 id="indexing-plan-synchronization-basics"><a class="anchor" href="#indexing-plan-synchronization-basics"></a><a id="mapper-orm-indexing-automatic-synchronization-basics"></a> Basics</h5>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>For a preliminary introduction to writing to and reading from indexes in Hibernate Search,
including in particular the concepts of <em>commit</em> and <em>refresh</em>,
see <a href="#concepts-commit-refresh">Commit and refresh</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>When using the <a href="#coordination-outbox-polling"><code>outbox-polling</code> coordination strategy</a>,
the actual indexing plan performing the index changes
is created asynchronously in a background thread.
Because of that, with that coordination strategy it does not make sense
to set a non-default indexing plan synchronization strategy,
and doing so will lead to an exception on startup.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>When a transaction is committed (<a href="#mapper-orm">Hibernate ORM integration</a>)
or the <code>SearchSession</code> is closed (<a href="#mapper-pojo-standalone">Standalone POJO Mapper</a>),
<a href="#coordination-none">with default coordination settings</a>,
the execution of the indexing plan (<a href="#listener-triggered-indexing">implicit (listener-triggered)</a> or <a href="#indexing-explicit">explicit</a>)
can block the application thread
until indexing reaches a certain level of completion.</p>
</div>
<div class="paragraph">
<p>There are two main reasons for blocking the thread:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Indexed data safety</strong>:
if, once the database transaction completes,
index data must be safely stored to disk,
an <a href="#concepts-commit-refresh">index commit</a> is necessary.
Without it, index changes may only be safe after a few seconds,
when a periodic index commit happens in the background.</p>
</li>
<li>
<p><strong>Real-time search queries</strong>:
if, once the database transaction completes (for the <a href="#mapper-orm">Hibernate ORM integration</a>)
or the <code>SearchSession</code>'s <code>close()</code> method returns (for the <a href="#mapper-pojo-standalone">Standalone POJO Mapper</a>),
any search query must immediately take the index changes into account,
an <a href="#concepts-commit-refresh">index refresh</a> is necessary.
Without it, index changes may only be visible after a few seconds,
when a periodic index refresh happens in the background.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>These two requirements are controlled by the <em>synchronization strategy</em>.
The default strategy is defined by the configuration property
<code>hibernate.search.indexing.plan.synchronization.strategy</code>.
Below is a reference of all available strategies and their guarantees.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
</colgroup>
<tbody>
<tr>
<th class="tableblock halign-left valign-top" rowspan="2"><p class="tableblock">Strategy</p></th>
<th class="tableblock halign-left valign-top" rowspan="2"><p class="tableblock">Throughput</p></th>
<th class="tableblock halign-left valign-top" colspan="3"><p class="tableblock">Guarantees when the application thread resumes</p></th>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">Changes applied (with or without <a href="#concepts-commit-refresh">commit</a>)</p></th>
<th class="tableblock halign-left valign-top"><p class="tableblock">Changes safe from crash/power loss (<a href="#concepts-commit-refresh">commit</a>)</p></th>
<th class="tableblock halign-left valign-top"><p class="tableblock">Changes visible on search (<a href="#concepts-commit-refresh">refresh</a>)</p></th>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>async</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Best</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No guarantee</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No guarantee</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No guarantee</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>write-sync</code> (<strong>default</strong>)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Medium</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Guaranteed</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Guaranteed</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No guarantee</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>read-sync</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Medium to <a href="#indexing-plan-synchronization-refresh-throughput">worst</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Guaranteed</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No guarantee</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Guaranteed</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>sync</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#indexing-plan-synchronization-refresh-throughput">Worst</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Guaranteed</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Guaranteed</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Guaranteed</p></td>
</tr>
</tbody>
</table>
<div id="indexing-plan-synchronization-refresh-throughput" class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p><a id="mapper-orm-indexing-automatic-synchronization-refresh-throughput"></a> Depending on the backend and its configuration,
the <code>sync</code> and <code>read-sync</code> strategies may lead to poor indexing throughput,
because the backend may not be designed for frequent, on-demand index refreshes.</p>
</div>
<div class="paragraph">
<p>This is why this strategy is only recommended if you know your backend is designed for it, or for integration tests.
In particular, the <code>sync</code> strategy will work fine with the default configuration of the Lucene backend,
but will perform poorly with the Elasticsearch backend.</p>
</div>
</td>
</tr>
</table>
</div>
<div id="indexing-plan-synchronization-failures" class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div id="mapper-orm-indexing-automatic-synchronization-failures" class="paragraph">
<p>Indexing failures may be reported differently depending on the chosen strategy:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Failure to extract data from entities:</p>
<div class="ulist">
<ul>
<li>
<p>Regardless of the strategy, throws an exception in the application thread.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Failure to apply index changes (i.e. I/O operations on the index):</p>
<div class="ulist">
<ul>
<li>
<p>For strategies that apply changes immediately: throws an exception in the application thread.</p>
</li>
<li>
<p>For strategies that do <strong>not</strong> apply changes immediately:
forwards the failure to the <a href="#configuration-background-failure-handling">failure handler</a>,
which by default will simply log the failure.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Failure to commit index changes:</p>
<div class="ulist">
<ul>
<li>
<p>For strategies that guarantee an index commit: throws an exception in the application thread.</p>
</li>
<li>
<p>For strategies that do <strong>not</strong> guarantee an index commit:
forwards the failure to the <a href="#configuration-background-failure-handling">failure handler</a>,
which by default will simply log the failure.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="indexing-plan-synchronization-override-per-session"><a class="anchor" href="#indexing-plan-synchronization-override-per-session"></a><a id="mapper-orm-indexing-automatic-synchronization-override-per-session"></a> <a id="_per_session_override"></a> Per-session override</h5>
<div class="paragraph">
<p>While the configuration property mentioned above defines a default,
it is possible to override this default on a particular session
by calling <code>SearchSession#indexingPlanSynchronizationStrategy(&#8230;&#8203;)</code> and passing a different strategy.</p>
</div>
<div class="paragraph">
<p>The built-in strategies can be retrieved by calling:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>IndexingPlanSynchronizationStrategy.async()</code></p>
</li>
<li>
<p><code>IndexingPlanSynchronizationStrategy.writeSync()</code></p>
</li>
<li>
<p><code>IndexingPlanSynchronizationStrategy.readSync()</code></p>
</li>
<li>
<p>or <code>IndexingPlanSynchronizationStrategy.sync()</code></p>
</li>
</ul>
</div>
<div class="exampleblock">
<div class="title">Example 140. Overriding the indexing plan synchronization strategy</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">SearchSession searchSession = <span class="comment">/* ... */</span> <i class="conum" data-value="1"></i><b>(1)</b>
searchSession.indexingPlanSynchronizationStrategy(
        IndexingPlanSynchronizationStrategy.sync()
); <i class="conum" data-value="2"></i><b>(2)</b>

entityManager.getTransaction().begin();
<span class="keyword">try</span> {
    <span class="predefined-type">Book</span> book = entityManager.find( <span class="predefined-type">Book</span>.class, <span class="integer">1</span> );
    book.setTitle( book.getTitle() + <span class="string"><span class="delimiter">&quot;</span><span class="content"> (2nd edition)</span><span class="delimiter">&quot;</span></span> ); <i class="conum" data-value="3"></i><b>(3)</b>
    entityManager.getTransaction().commit(); <i class="conum" data-value="4"></i><b>(4)</b>
}
<span class="keyword">catch</span> (<span class="exception">RuntimeException</span> e) {
    entityManager.getTransaction().rollback();
}

<span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; result = searchSession.search( <span class="predefined-type">Book</span>.class )
        .where( f -&gt; f.match().field( <span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span> ).matching( <span class="string"><span class="delimiter">&quot;</span><span class="content">2nd edition</span><span class="delimiter">&quot;</span></span> ) )
        .fetchHits( <span class="integer">20</span> ); <i class="conum" data-value="5"></i><b>(5)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><a href="#entrypoints-search-session">Retrieve the <code>SearchSession</code></a>, which by default uses the synchronization strategy configured in properties.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Override the synchronization strategy.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Change an entity.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Commit the changes, triggering reindexing.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>The overridden strategy guarantees that the modified book will be present in these results,
even though the query was executed <em>just after</em> the transaction commit
(here we&#8217;re using the <a href="#mapper-orm">Hibernate ORM integration</a>).</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="indexing-plan-synchronization-custom"><a class="anchor" href="#indexing-plan-synchronization-custom"></a><a id="mapper-orm-indexing-automatic-synchronization-custom"></a> <a id="_custom_strategy"></a> Custom strategy</h5>
<div class="paragraph">
<p>You can also implement custom strategy.
The custom strategy can then be set just like the built-in strategies:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>as the default by setting
the configuration property <code>hibernate.search.indexing.plan.synchronization.strategy</code>
to a <a href="#configuration-bean-reference-parsing">bean reference</a> pointing to the custom implementation,
for example <code>class:com.mycompany.MySynchronizationStrategy</code>.</p>
</li>
<li>
<p>at the session level by passing an instance of the custom implementation
to <code>SearchSession#indexingPlanSynchronizationStrategy(&#8230;&#8203;)</code>.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="indexing-plan-filter"><a class="anchor" href="#indexing-plan-filter"></a>14.2.3. Indexing plan filter</h4>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Features detailed below are <em>incubating</em>: they are still under active development.</p>
</div>
<div class="paragraph">
<p>The usual <a href="https://hibernate.org/community/compatibility-policy/">compatibility policy</a> does not apply:
the contract of incubating elements (e.g. types, methods, configuration properties, etc.)
may be altered in a backward-incompatible way&#8201;&#8212;&#8201;or even removed&#8201;&#8212;&#8201;in subsequent releases.</p>
</div>
<div class="paragraph">
<p>You are encouraged to use incubating features so the development team can get feedback and improve them,
but you should be prepared to update code which relies on them as needed.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In some scenarios, it might be helpful to pause the <a href="#architecture-hsearch-indexing">explicit and listener-triggered indexing</a> programmatically, for example,
when importing larger amounts of data. Hibernate Search allows configuring application-wide
and session-level filters to manage which types are tracked for changes and indexed.</p>
</div>
<div class="exampleblock">
<div class="title">Example 141. Configuring an application-wide filter</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">SearchMapping searchMapping = <span class="comment">/* ... */</span> <i class="conum" data-value="1"></i><b>(1)</b>
searchMapping.indexingPlanFilter( <i class="conum" data-value="2"></i><b>(2)</b>
        ctx -&gt; ctx.exclude( EntityA.class ) <i class="conum" data-value="3"></i><b>(3)</b>
                .include( EntityExtendsA2.class )
);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Configuring an application-wide filter requires an instance of the <code>SearchMapping</code>.</p>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><a href="#entrypoints-search-mapping">Retrieve the <code>SearchMapping</code></a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Start the declaration of the indexing plan filter.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Configure included/excluded types through the <code>SearchIndexingPlanFilter</code></td>
</tr>
</table>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 142. Configuring a session-level filter</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">SearchSession session = <span class="comment">/* ... */</span> <i class="conum" data-value="1"></i><b>(1)</b>
session.indexingPlanFilter(
        ctx -&gt; ctx.exclude( EntityA.class ) <i class="conum" data-value="2"></i><b>(2)</b>
                .include( EntityExtendsA2.class )
);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Configuring a session level filter is available through an instance of the <code>SearchSession</code>.</p>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><a href="#entrypoints-search-session">Retrieve the <code>SearchSession</code></a></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Configure included/excluded types through the <code>SearchIndexingPlanFilter</code></td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>Filter can be defined by providing indexed and contained types as well as their supertypes.
Interfaces are not allowed and passing an interface class to any of the filter definition methods will result in an exception.
If dynamic types represented by a <code>Map</code> are used then their names must be used to configure the filter.
Filter rules are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If the type <code>A</code> is explicitly included by the filter, then a change to an object that is exactly of a type <code>A</code> is processed.</p>
</li>
<li>
<p>If the type <code>A</code> is explicitly excluded by the filter, then a change to an object that is exactly of a type <code>A</code> is ignored.</p>
</li>
<li>
<p>If the type <code>A</code> is explicitly included by the filter, then a change to an object that is exactly of a type <code>B</code>,
which is a subtype of the type <code>A</code>, is processed unless the filter explicitly excludes a more specific supertype of a type <code>B</code>.</p>
</li>
<li>
<p>If the type <code>A</code> is excluded by the filter explicitly, then a change to an object that is exactly of a type <code>B</code>,
which is a subtype of type the <code>A</code>, is ignored unless the filter explicitly includes a more specific supertype of a type <code>B</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>A session-level filter takes precedence over an application-wide one. If the session-level filter configuration does not
either explicitly or through inheritance include/exclude the exact type of an entity, then the decision will be made by
the application-wide filter. If an application-wide filter also has no explicit configuration for a type, then this type
is considered to be included.</p>
</div>
<div class="paragraph">
<p>In some cases we might need to disable the indexing entirely. Listing all entities one by one might be cumbersome,
but since filter configuration is implicitly applied to subtypes, <code>.exclude(Object.class)</code> can be used to exclude all types.
Conversely, <code>.include(Object.class)</code> can be used to enable indexing within a session filter when
the application-wide filter disables indexing completely.</p>
</div>
<div class="exampleblock">
<div class="title">Example 143. Disable all indexing within a session</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">SearchSession searchSession = <span class="comment">/* ... */</span> <i class="conum" data-value="1"></i><b>(1)</b>
searchSession.indexingPlanFilter(
        ctx -&gt; ctx.exclude( <span class="predefined-type">Object</span>.class ) <i class="conum" data-value="2"></i><b>(2)</b>
);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Configuring a session level filter is available through an instance of the <code>SearchSession</code>.</p>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><a href="#entrypoints-search-session">Retrieve the <code>SearchSession</code></a></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Excluding <code>Object.class</code> will lead to excluding all its subtypes which means nothing will be included.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 144. Enable indexing in the session while application-wide indexing is paused</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">SearchMapping searchMapping = <span class="comment">/* ... */</span> <i class="conum" data-value="1"></i><b>(1)</b>
searchMapping.indexingPlanFilter(
        ctx -&gt; ctx.exclude( <span class="predefined-type">Object</span>.class ) <i class="conum" data-value="2"></i><b>(2)</b>
);</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre>            SearchSession searchSession = /* ... */ <i class="conum" data-value="3"></i><b>(3)</b>
            searchSession.indexingPlanFilter(
                    ctx -&gt; ctx.include( Object.class ) <i class="conum" data-value="4"></i><b>(4)</b>
            );</pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><a href="#entrypoints-search-mapping">Retrieve the <code>SearchMapping</code></a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>An application-wide filter disables any indexing</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td><a href="#entrypoints-search-session">Retrieve the <code>SearchSession</code></a></td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>A session level filter re-enables indexing <strong>for changes happening in current session only</strong></td>
</tr>
</table>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Trying to configure the same type as both included and excluded at the same time by the same filter
will lead to an exception being thrown.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Only an application-wide filter is safe to use when using the <a href="#coordination-database-polling"><code>outbox-polling</code> coordination strategy</a>.
When this coordination strategy is in use, entities are loaded and indexed in a different session from
the one where they were changed. It might lead to unexpected results as the session where events are processed will not
apply the filter configured by the session in which entities were modified.
An exception will be thrown if such a filter is configured unless this filter excludes all the types to prevent any
unexpected consequences of configuring session-level filters with this coordination strategy.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="listener-triggered-indexing"><a class="anchor" href="#listener-triggered-indexing"></a>14.3. <a id="indexing-automatic"></a> <a id="mapper-orm-indexing-automatic"></a> <a id="_automatic_indexing"></a> Implicit, listener-triggered indexing</h3>
<div class="sect3">
<h4 id="listener-triggered-indexing-concepts"><a class="anchor" href="#listener-triggered-indexing-concepts"></a>14.3.1. <a id="indexing-automatic-concepts"></a><a id="mapper-orm-indexing-automatic-concepts"></a> Basics</h4>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This feature is only available with the <a href="#mapper-orm">Hibernate ORM integration</a>.</p>
</div>
<div class="paragraph">
<p>It <strong>cannot</strong> be used with the <a href="#mapper-pojo-standalone">Standalone POJO Mapper</a> in particular.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>By default, every time an entity is changed through a Hibernate ORM Session,
if the <a href="#concepts-entity">entity type</a> is <a href="#mapping-entityindexmapping">mapped to an index</a>,
Hibernate Search updates the relevant index transparently.</p>
</div>
<div class="paragraph">
<p>Here is how listener-triggered indexing works at a high level:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>When the Hibernate ORM <code>Session</code> gets flushed (explicitly or as part of a transaction commit),
Hibernate ORM determines what changed exactly (entity created, updated, deleted),
forwards the information to Hibernate Search.</p>
</li>
<li>
<p>Hibernate Search adds this information to a (session-scoped) <a href="#indexing-plan">indexing plan</a>
and the plan processes change events added so far,
either inferring which entities need to be reindexed and building the corresponding documents (<a href="#coordination-none">no coordination</a>)
or building events to be sent to the outbox (<a href="#coordination-outbox-polling"><code>outbox-polling</code> coordination</a>).</p>
</li>
<li>
<p>On database transaction commit, the plan gets executed,
either sending the document indexing/deletion request to the backend (<a href="#coordination-none">no coordination</a>)
or sending the events to the database (<a href="#coordination-outbox-polling"><code>outbox-polling</code> coordination</a>).</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Below is a summary of key characteristics of listener-triggered indexing
and how they vary depending on the configured <a href="#coordination">coordination strategy</a>.</p>
</div>
<div class="paragraph">
<p>Follow the links for more details.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 9. Comparison of listener-triggered indexing depending on the coordination strategy</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Coordination strategy</th>
<th class="tableblock halign-center valign-top"><a href="#coordination-none">No coordination</a> (default)</th>
<th class="tableblock halign-center valign-top"><a href="#coordination-outbox-polling">Outbox polling</a></th>
</tr>
</thead>
<tbody>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">Detects changes occurring in ORM sessions (<code>session.persist(&#8230;&#8203;)</code>, <code>session.delete(&#8230;&#8203;)</code>, setters, &#8230;&#8203;)</p></th>
<td class="tableblock halign-center valign-top" colspan="2"><p class="tableblock"><a href="#indexing-automatic-concepts-changes-in-session">Yes</a></p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">Detects changes caused by JPQL or SQL queries (<code>insert</code>/<code>update</code>/<code>delete</code>)</p></th>
<td class="tableblock halign-center valign-top" colspan="2"><p class="tableblock"><a href="#limitations-changes-in-session">No</a></p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">Associations must be updated on both sides</p></th>
<td class="tableblock halign-center valign-top" colspan="2"><p class="tableblock"><a href="#limitations-changes-asymmetric-association-updates">Yes</a></p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">Changes triggering reindexing</p></th>
<td class="tableblock halign-center valign-top" colspan="2"><p class="tableblock"><a href="#indexing-automatic-concepts-dirty-checking">Only relevant changes</a></p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">Guarantee of indexes updates</p></th>
<td class="tableblock halign-center valign-top"><p class="tableblock"><a href="#coordination-none-indexing-guarantee">Non-transactional, after the database transaction / <code>SearchSession.close()</code> returns</a></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><a href="#coordination-outbox-polling-indexing-guarantee">Transactional, on database transaction commit</a></p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">Visibility of index updates</p></th>
<td class="tableblock halign-center valign-top"><p class="tableblock"><a href="#coordination-none-indexing-visibility">Configurable: immediate (poor performance) or eventual</a></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><a href="#coordination-outbox-polling-indexing-visibility">Eventual</a></p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">Overhead for application threads</p></th>
<td class="tableblock halign-center valign-top"><p class="tableblock"><a href="#coordination-none-indexing-on-flush">Low to medium</a></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><a href="#coordination-outbox-polling-indexing-background">Very low</a></p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">Overhead for the database</p></th>
<td class="tableblock halign-center valign-top"><p class="tableblock"><a href="#coordination-none-indexing-lazy-loading">Low</a></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><a href="#coordination-outbox-polling-indexing-full-loading">Low to medium</a></p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="indexing-automatic-configuration"><a class="anchor" href="#indexing-automatic-configuration"></a>14.3.2. <a id="mapper-orm-indexing-automatic-configuration"></a> Configuration</h4>
<div class="paragraph">
<p>Listener-triggered indexing may be unnecessary if your index is read-only
or if you update it regularly by reindexing,
either using the <a href="#indexing-massindexer"><code>MassIndexer</code></a>,
using the <a href="#mapper-orm-indexing-jakarta-batch">Jakarta Batch mass indexing job</a>,
or <a href="#indexing-explicit">explicitly</a>.</p>
</div>
<div class="paragraph">
<p>You can disable listener-triggered indexing by setting the configuration property
<code>hibernate.search.indexing.listeners.enabled</code> to <code>false</code>.</p>
</div>
<div class="paragraph">
<p>As listener-triggered indexing uses <a href="#indexing-plan">indexing plans</a> under the hood,
several configuration options affecting indexing plans will affect listener-triggered indexing as well:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The <a href="#indexing-plan-synchronization">indexing plan synchronization strategy</a>.</p>
</li>
<li>
<p>The <a href="#indexing-plan-filter">indexing plan filter</a>.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="indexing-automatic-concepts-changes-in-session"><a class="anchor" href="#indexing-automatic-concepts-changes-in-session"></a>14.3.3. <a id="mapper-orm-indexing-automatic-concepts-changes-in-session"></a> In-session entity change detection and limitations</h4>
<div class="paragraph">
<p>Hibernate Search uses internal events of Hibernate ORM in order to detect changes.
These events will be triggered if you actually manipulate managed entity objects in your code:
calls to <code>session.persist(&#8230;&#8203;)</code>, <code>session.delete(&#8230;&#8203;)</code>, to entity setters, etc.</p>
</div>
<div class="paragraph">
<p>This works great for most applications, but you need to consider some limitations:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#limitations-changes-in-session">Listener-triggered indexing only considers changes applied directly to entity instances in Hibernate ORM sessions</a></p>
</li>
<li>
<p><a href="#limitations-changes-asymmetric-association-updates"> Listener-triggered indexing ignores asymmetric association updates</a></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="indexing-automatic-concepts-dirty-checking"><a class="anchor" href="#indexing-automatic-concepts-dirty-checking"></a>14.3.4. <a id="mapper-orm-indexing-automatic-concepts-dirty-checking"></a> Dirty checking</h4>
<div class="paragraph">
<p>Hibernate Search is aware of the entity properties that are accessed when building indexed documents.
When processing Hibernate ORM entity change events, it is also aware of which properties actually changed.
Thanks to that knowledge, it is able to detect which entity changes are actually relevant to indexing,
and to skip reindexing when a property is modified, but does not affect the indexed document.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="indexing-massindexer"><a class="anchor" href="#indexing-massindexer"></a>14.4. <a id="mapper-orm-indexing-massindexer"></a> <a id="search-batchindex-massindexer"></a> Indexing a large amount of data with the <code>MassIndexer</code></h3>
<div class="sect3">
<h4 id="indexing-massindexer-basics"><a class="anchor" href="#indexing-massindexer-basics"></a>14.4.1. <a id="mapper-orm-indexing-massindexer-basics"></a> Basics</h4>
<div class="paragraph">
<p>There are cases where <a href="#architecture-hsearch-indexing">listener-triggered or explicit indexing</a> is not enough,
because pre-existing data has to be indexed:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>when restoring a database backup;</p>
</li>
<li>
<p>when indexes had to be wiped,
for example because the Hibernate Search <a href="#mapping">mapping</a> or some core settings changed;</p>
</li>
<li>
<p>when entities cannot be indexed as they change (e.g. with <a href="#listener-triggered-indexing">listener-triggered indexing</a>) for performance reasons,
and periodic reindexing (every night, &#8230;&#8203;) is preferred.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To address these situations, Hibernate Search provides the <code>MassIndexer</code>:
a tool to rebuild indexes completely based on the content of an external datastore
(for the <a href="#mapper-orm">Hibernate ORM integration</a>, that datastore is the database).
The <code>MassIndexer</code> can be told to reindex a few selected indexed types, or all of them.</p>
</div>
<div class="paragraph">
<p>The <code>MassIndexer</code> takes the following approach to achieve a reasonably high throughput:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Indexes are purged completely when mass indexing starts.</p>
</li>
<li>
<p>Mass indexing is performed by several parallel threads,
each loading data from the database and sending indexing requests to the indexes,
not triggering any <a href="#concepts-commit-refresh">commit or refresh</a>.</p>
</li>
<li>
<p>An implicit <a href="#indexing-workspace-flush">flush</a> (commit) and <a href="#indexing-workspace-refresh">refresh</a>
are performed upon mass indexing completion,
except for <a href="#backend-elasticsearch-compatibility-amazon-opensearch-serverless">Amazon OpenSearch Serverless</a>
since it doesn&#8217;t support explicit flushes or refreshes.</p>
</li>
</ul>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Because of the initial index purge, and because mass indexing is a very resource-intensive operation,
it is recommended to take your application offline while the <code>MassIndexer</code> is working.</p>
</div>
<div class="paragraph">
<p>Querying the index while a <code>MassIndexer</code> is busy may be slower than usual
and will likely return incomplete results.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The following snippet of code will rebuild the index of all indexed entities,
deleting the index and then reloading all entities from the database.</p>
</div>
<div class="exampleblock">
<div class="title">Example 145. Reindexing everything using a <code>MassIndexer</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">SearchSession searchSession = <span class="comment">/* ... */</span> <i class="conum" data-value="1"></i><b>(1)</b>
searchSession.massIndexer() <i class="conum" data-value="2"></i><b>(2)</b>
        .startAndWait(); <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><a href="#entrypoints-search-session">Retrieve the <code>SearchSession</code></a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Create a <code>MassIndexer</code> targeting every indexed entity type.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Start the mass indexing process and return when it is over.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The <code>MassIndexer</code> creates its own, separate sessions and (read-only) transactions,
so there is no need to begin a database transaction before the <code>MassIndexer</code> is started
or to commit a transaction after it is done.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>A note to MySQL users: the <code>MassIndexer</code> uses forward-only scrollable results
to iterate on the primary keys to be loaded,
but MySQL&#8217;s JDBC driver will preload all values in memory.</p>
</div>
<div class="paragraph">
<p>To avoid this "optimization" set the <a href="#indexing-massindexer-parameters-idfetchsize"><code>idFetchSize</code> parameter</a>
to <code>Integer.MIN_VALUE</code>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Although the <code>MassIndexer</code> is simple to use, some tweaking is recommended to speed up the process.
Several optional parameters are available, and can be set as shown below,
before the mass indexer starts.
See <a href="#indexing-massindexer-parameters">  <code>MassIndexer</code> parameters</a> for a reference of all available parameters,
and <a href="#indexing-massindexer-tuning"> Tuning the <code>MassIndexer</code> for best performance</a> for details about key topics.</p>
</div>
<div class="exampleblock">
<div class="title">Example 146. Using a tuned MassIndexer</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">searchSession.massIndexer() <i class="conum" data-value="1"></i><b>(1)</b>
        .idFetchSize( <span class="integer">150</span> ) <i class="conum" data-value="2"></i><b>(2)</b>
        .batchSizeToLoadObjects( <span class="integer">25</span> ) <i class="conum" data-value="3"></i><b>(3)</b>
        .threadsToLoadObjects( <span class="integer">12</span> ) <i class="conum" data-value="4"></i><b>(4)</b>
        .startAndWait(); <i class="conum" data-value="5"></i><b>(5)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Create a <code>MassIndexer</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Load <code>Book</code> identifiers by batches of 150 elements.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Load <code>Book</code> entities to reindex by batches of 25 elements.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Create 12 parallel threads to load the <code>Book</code> entities.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Start the mass indexing process and return when it is over.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Running the <code>MassIndexer</code> with many threads may require many connections to the database.
If you don&#8217;t have a sufficiently large connection pool, the <code>MassIndexer</code> itself and/or your other
applications could starve and be unable to serve other requests:
make sure you size your connection pool according to the mass indexing parameters,
as explained in <a href="#indexing-massindexer-tuning-threads">  Threads and connections</a>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="indexing-massindexer-selecting-types"><a class="anchor" href="#indexing-massindexer-selecting-types"></a>14.4.2. Selecting types to be indexed</h4>
<div class="paragraph">
<p>You can select entity types when creating a mass indexer,
to reindex only these types (and their indexed subtypes, if any):</p>
</div>
<div class="exampleblock">
<div class="title">Example 147. Reindexing selected types using a <code>MassIndexer</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">searchSession.massIndexer( <span class="predefined-type">Book</span>.class ) <i class="conum" data-value="1"></i><b>(1)</b>
        .startAndWait(); <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Create a <code>MassIndexer</code> targeting the <code>Book</code> type and its indexed subtypes (if any).</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Start the mass indexing process for the selected types and return when it is over.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="indexing-massindexer-multitenancy"><a class="anchor" href="#indexing-massindexer-multitenancy"></a>14.4.3. Mass indexing multiple tenants</h4>
<div class="paragraph">
<p>Examples in sections above create a mass indexer from a given session,
which will always limit mass indexing to the tenant targeted by that session.</p>
</div>
<div class="paragraph">
<p>When using <a href="#configuration-multi-tenancy">multi-tenancy</a>
you can reindex multiple tenants at once by retrieving the mass indexer from a <a href="#entrypoints-search-scope"><code>SearchScope</code></a>
and passing a collection of tenant identifiers:</p>
</div>
<div class="exampleblock">
<div class="title">Example 148. Reindexing multiple tenants listed explicitly using a <code>MassIndexer</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">SearchMapping searchMapping = <span class="comment">/* ... */</span> <i class="conum" data-value="1"></i><b>(1)</b>
searchMapping.scope( <span class="predefined-type">Object</span>.class ) <i class="conum" data-value="2"></i><b>(2)</b>
        .massIndexer( asSet( <span class="string"><span class="delimiter">&quot;</span><span class="content">tenant1</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">tenant2</span><span class="delimiter">&quot;</span></span> ) ) <i class="conum" data-value="3"></i><b>(3)</b>
        .startAndWait(); <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><a href="#entrypoints-search-mapping">Retrieve the <code>SearchMapping</code></a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><a href="#entrypoints-search-mapping">Retrieve a <code>SearchScope</code></a> targeting all types that we want reindexed;
here we use <code>Object.class</code>, meaning "all indexed types that extent `Object`",
i.e. simply all indexed types.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Pass the identifiers of tenants we want to mass index and create the mass indexer.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Start the mass indexing process and return when it is over.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>With the <a href="#mapper-orm">Hibernate ORM mapper</a>,
if you <a href="#configuration-multi-tenancy">included the comprehensive list of tenants in Hibernate Search&#8217;s configuration</a>,
you can simply call <code>scope.massIndexer()</code> without any argument,
and the resulting mass indexer will target all configured tenants:</p>
</div>
<div class="exampleblock">
<div class="title">Example 149. Reindexing multiple tenants configured implicitly using a <code>MassIndexer</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">SearchMapping searchMapping = <span class="comment">/* ... */</span> <i class="conum" data-value="1"></i><b>(1)</b>
searchMapping.scope( <span class="predefined-type">Object</span>.class ) <i class="conum" data-value="2"></i><b>(2)</b>
        .massIndexer() <i class="conum" data-value="3"></i><b>(3)</b>
        .startAndWait(); <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><a href="#entrypoints-search-mapping">Retrieve the <code>SearchMapping</code></a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><a href="#entrypoints-search-mapping">Retrieve a <code>SearchScope</code></a> targeting all types that we want reindexed;
here we use <code>Object.class</code>, meaning "all indexed types that extent `Object`",
i.e. simply all indexed types.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Create a mass indexer targeting all tenants <a href="#configuration-multi-tenancy">included in the configuration</a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Start the mass indexing process and return when it is over.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="indexing-massindexer-asynchronous"><a class="anchor" href="#indexing-massindexer-asynchronous"></a>14.4.4. Running the mass indexer asynchronously</h4>
<div class="paragraph">
<p>It is possible to run the mass indexer asynchronously,
because it does not rely on the original Hibernate ORM session.
When used asynchronously, the mass indexer will return a completion stage
to track the completion of mass indexing:</p>
</div>
<div class="exampleblock">
<div class="title">Example 150. Reindexing asynchronously using a <code>MassIndexer</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">        searchSession.massIndexer() <i class="conum" data-value="1"></i><b>(1)</b>
                .start() <i class="conum" data-value="2"></i><b>(2)</b>
                .thenRun( () -&gt; { <i class="conum" data-value="3"></i><b>(3)</b>
                    log.info( <span class="string"><span class="delimiter">&quot;</span><span class="content">Mass indexing succeeded!</span><span class="delimiter">&quot;</span></span> );
                } )
                .exceptionally( throwable -&gt; {
                    log.error( <span class="string"><span class="delimiter">&quot;</span><span class="content">Mass indexing failed!</span><span class="delimiter">&quot;</span></span>, throwable );
                    <span class="keyword">return</span> <span class="predefined-constant">null</span>;
                } );

<span class="comment">// OR</span>
<span class="predefined-type">Future</span>&lt;?&gt; future = searchSession.massIndexer()
        .start()
        .toCompletableFuture(); <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Create a <code>MassIndexer</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Start the mass indexing process, but do not wait for the process to finish.
A <code>CompletionStage</code> is returned.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The <code>CompletionStage</code> exposes methods to execute more code after indexing is complete.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Alternatively, call <code>toCompletableFuture()</code> on the returned object to get a <code>Future</code>.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="indexing-massindexer-conditional"><a class="anchor" href="#indexing-massindexer-conditional"></a>14.4.5. <a id="mapper-orm-indexing-massindexer-conditional"></a> Conditional reindexing</h4>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This feature is only available with the <a href="#mapper-orm">Hibernate ORM integration</a>.</p>
</div>
<div class="paragraph">
<p>It <strong>cannot</strong> be used with the <a href="#mapper-pojo-standalone">Standalone POJO Mapper</a> in particular.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can select a subset of target entities to be reindexed
by passing a condition as string to the mass indexer.
The condition will be applied when querying the database for entities to index.</p>
</div>
<div class="paragraph">
<p>The condition string is expected to follow the <a href="https://docs.jboss.org/hibernate/orm/6.4/userguide/html_single/Hibernate_User_Guide.html#query-language">Hibernate Query Language (HQL)</a> syntax.
Accessible entity properties are those of the entity being reindexed (and nothing more).</p>
</div>
<div class="exampleblock">
<div class="title">Example 151. Use of conditional reindexing</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">SearchSession searchSession = <span class="comment">/* ... */</span> <i class="conum" data-value="1"></i><b>(1)</b>
MassIndexer massIndexer = searchSession.massIndexer(); <i class="conum" data-value="2"></i><b>(2)</b>
massIndexer.type( <span class="predefined-type">Book</span>.class ).reindexOnly( <span class="string"><span class="delimiter">&quot;</span><span class="content">publicationYear &lt; 1950</span><span class="delimiter">&quot;</span></span> ); <i class="conum" data-value="3"></i><b>(3)</b>
massIndexer.type( Author.class ).reindexOnly( <span class="string"><span class="delimiter">&quot;</span><span class="content">birthDate &lt; :cutoff</span><span class="delimiter">&quot;</span></span> ) <i class="conum" data-value="4"></i><b>(4)</b>
        .param( <span class="string"><span class="delimiter">&quot;</span><span class="content">cutoff</span><span class="delimiter">&quot;</span></span>, Year.of( <span class="integer">1950</span> ).atDay( <span class="integer">1</span> ) ); <i class="conum" data-value="5"></i><b>(5)</b>
massIndexer.startAndWait(); <i class="conum" data-value="6"></i><b>(6)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><a href="#entrypoints-search-session">Retrieve the <code>SearchSession</code></a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Create a <code>MassIndexer</code> targeting every indexed entity type.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Reindex only the books published before year 1950.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Reindex only the authors born prior to a given local date.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>In this example the cutoff date is passed as a query parameter.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Start the mass indexing process and return when it is over.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Even if the reindexing is applied on a subset of entities, by default <strong>all entities</strong> will be purged at the start.
The purge <a href="#indexing-massindexer-parameters">can be disabled completely</a>,
but when enabled there is no way to filter the entities that will be purged.</p>
</div>
<div class="paragraph">
<p>See <a href="https://hibernate.atlassian.net/browse/HSEARCH-3304">HSEARCH-3304</a> for more information.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="indexing-massindexer-parameters"><a class="anchor" href="#indexing-massindexer-parameters"></a>14.4.6. <a id="mapper-orm-indexing-massindexer-parameters"></a> <a id="_useful_parameters_for_batch_indexing"></a> <code>MassIndexer</code> parameters</h4>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 10. <code>MassIndexer</code> parameters</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Setter</th>
<th class="tableblock halign-left valign-top">Default value</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>typesToIndexInParallel(int)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>1</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The number of types to index in parallel.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a id="indexing-massindexer-parameters-threadstoloadobjects"></a><code>threadsToLoadObjects(int)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>6</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The number of threads for entity loading, for <strong>each type indexed in parallel</strong>.
That is to say, the number of threads spawned for entity loading
will be <code>typesToIndexInParallel * threadsToLoadObjects</code>
(+ 1 thread per type to retrieve the IDs of entities to load).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a id="indexing-massindexer-parameters-idfetchsize"></a><code>idFetchSize(int)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>100</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a id="mapper-orm-indexing-massindexer-parameters-idfetchsize"></a><strong>Only supported with the <a href="#mapper-orm">Hibernate ORM integration</a>.</strong>
The fetch size to be used when loading primary keys. Some databases
accept special values, for example MySQL might benefit from using <code>Integer#MIN_VALUE</code>, otherwise it
will attempt to preload everything in memory.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a id="indexing-massindexer-parameters-batchsizetoloadobjects"></a><code>batchSizeToLoadObjects(int)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>10</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Only supported with the <a href="#mapper-orm">Hibernate ORM integration</a>.</strong>
The fetch size to be used when loading entities from database. Some databases
accept special values, for example MySQL might benefit from using <code>Integer#MIN_VALUE</code>, otherwise it
will attempt to preload everything in memory.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a id="indexing-massindexer-parameters-drop-and-create-schema"></a><code>dropAndCreateSchemaOnStart(boolean)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>false</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a id="mapper-orm-indexing-massindexer-parameters-drop-and-create-schema"></a>Drops the indexes and their schema (if they exist) and re-creates them before indexing.</p>
<p class="tableblock">Indexes will be unavailable for a short time during the dropping and re-creation,
so this should only be used when failures of concurrent operations on the indexes (<a href="#listener-triggered-indexing">listener-triggered indexing</a>, &#8230;&#8203;)
are acceptable.</p>
<p class="tableblock">This should be used when the existing schema is known to be obsolete,
for example when <a href="#mapping-changes">the Hibernate Search mapping changed</a>
and some fields now have a different type, a different analyzer, new capabilities (projectable, &#8230;&#8203;), etc.</p>
<p class="tableblock">This may also be used when the schema is up-to-date,
since it can be faster than a purge (<code>purgeAllOnStart</code>) on large indexes,
especially with the Elasticsearch backend.</p>
<p class="tableblock">As an alternative to this parameter,
you can also use a schema manager to manage schemas manually at the time of your choosing:
<a href="#schema-management-manager"> Manual schema management</a>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>purgeAllOnStart(boolean)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Default value depends on <a href="#indexing-massindexer-parameters-drop-and-create-schema"><code>dropAndCreateSchemaOnStart(boolean)</code></a>.
Defaults to <code>false</code> if the mass indexer is configured to drop and create the schema on start, to <code>true</code> otherwise.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Removes all entities from the indexes before indexing.</p>
<p class="tableblock">Only set this to <code>false</code> if you know the index is already empty;
otherwise, you will end up with duplicates in the index.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>mergeSegmentsAfterPurge(boolean)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>true</code> in general, <code>false</code> on <a href="#backend-elasticsearch-compatibility-amazon-opensearch-serverless">Amazon OpenSearch Serverless</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Force merging of each index into a single segment after the initial index purge, just before indexing.
This setting has no effect if <code>purgeAllOnStart</code> is set to false.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>mergeSegmentsOnFinish(boolean)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>false</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Force merging of each index into a single segment after indexing.
This operation does not always improve performance: see <a href="#indexing-workspace-merge-segments">Merging segments and performance</a>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>cacheMode(CacheMode)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>CacheMode.IGNORE</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Only supported with the <a href="#mapper-orm">Hibernate ORM integration</a>.</strong>
The Hibernate <code>CacheMode</code> when loading entities.
The default is <code>CacheMode.IGNORE</code>, and it will be the most efficient choice in most cases,
but using another mode such as <code>CacheMode.GET</code> may be more efficient if many of the entities being indexed
refer to a small set of other entities.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>transactionTimeout</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Only supported in JTA-enabled environments and with the <a href="#mapper-orm">Hibernate ORM integration</a>.</strong>
Timeout of transactions for loading ids and entities to be re-indexed.
The timeout should be long enough to load and index all entities of one type.
Note that these transactions are read-only,
so choosing a large value (e.g. <code>1800</code>, meaning 30 minutes)
should not cause any problem.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>limitIndexedObjectsTo(long)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Only supported with the <a href="#mapper-orm">Hibernate ORM integration</a>.</strong>
The maximum number of results to load per entity type. This parameter let you define a threshold
value to avoid loading too many entities accidentally. The value defined must be greater than 0.
The parameter is not used by default. It is equivalent to keyword <code>LIMIT</code> in SQL.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>monitor(MassIndexingMonitor)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A logging monitor.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a id="indexing-massindexer-parameters-monitor"></a>The component responsible for monitoring progress of mass indexing.</p>
<p class="tableblock">As a <code>MassIndexer</code> can take some time to finish its job,
it is often necessary to monitor its progress.
The default, built-in monitor logs progress periodically at the <code>INFO</code> level,
but a custom monitor can be set by implementing the <code>MassIndexingMonitor</code> interface
and passing an instance using the <code>monitor</code> method.</p>
<p class="tableblock">Implementations of <code>MassIndexingMonitor</code> must be thread-safe.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>failureHandler(MassIndexingFailureHandler)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A failure handler.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The component responsible for handling failures occurring during mass indexing.</p>
<p class="tableblock">A <code>MassIndexer</code> performs multiple operations in parallel,
some of which can fail without stopping the whole mass indexing process.
As a result, it may be necessary to trace individual failures.</p>
<p class="tableblock">The default, built-in failure handler just forwards the failures
to the global <a href="#configuration-background-failure-handling">background failure handler</a>,
which by default will log them at the <code>ERROR</code> level,
but a custom handler can be set by implementing the <code>MassIndexingFailureHandler</code> interface
and passing an instance using the <code>failureHandler</code> method.
This can be used to simply log failures in a context specific to the mass indexer,
e.g. a web interface in a maintenance console from which mass indexing was requested,
or for more advanced use cases, such as cancelling mass indexing on the first failure.</p>
<p class="tableblock">Implementations of <code>MassIndexingFailureHandler</code> must be thread-safe.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>environment(MassIndexingEnvironment)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">An empty environment (no threadlocals, &#8230;&#8203;).</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>This feature is <em>incubating</em>: it is still under active development.</strong>
The contract of incubating elements (e.g. types, methods, configuration properties, etc.)
may be altered in a backward-incompatible way&#8201;&#8212;&#8201;or even removed&#8201;&#8212;&#8201;in subsequent releases.</p>
<p class="tableblock">The component responsible for setting up an environment (threadlocals, &#8230;&#8203;) on mass indexing threads before mass indexing
starts, and tearing down that environment after mass indexing.</p>
<p class="tableblock">Implementations should handle their exceptions unless it is an unrecoverable situation in which further mass indexing
does not make sense: any exception thrown by the <code>MassIndexingEnvironment</code> will abort mass indexing.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>failureFloodingThreshold(long)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>100</code> with the default failure handler (see description)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>This feature is <em>incubating</em>: it is still under active development.</strong>
The maximum number of failures to be handled per indexed type.
Any failures exceeding this number will be ignored and not sent for processing by <code>MassIndexingFailureHandler</code>.
Can be set to <code>Long.MAX_VALUE</code> if none of the failures should be ignored.</p>
<p class="tableblock">Defaults to a threshold defined by the failure handler in use; see <code>MassIndexingFailureHandler#failureFloodingThreshold</code>,
<code>FailureHandler#failureFloodingThreshold</code>.
For the default log-based failure handler, the default threshold is 100.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="indexing-massindexer-tuning"><a class="anchor" href="#indexing-massindexer-tuning"></a>14.4.7. <a id="mapper-orm-indexing-massindexer-tuning"></a> Tuning the <code>MassIndexer</code> for best performance</h4>
<div class="sect4">
<h5 id="indexing-massindexer-tuning-basics"><a class="anchor" href="#indexing-massindexer-tuning-basics"></a><a id="mapper-orm-indexing-massindexer-tuning-basics"></a> Basics</h5>
<div class="paragraph">
<p>The <code>MassIndexer</code> was designed to finish the re-indexing task as quickly as possible,
but there is no one-size-fits-all solution,
so some configuration is required to get the best of it.</p>
</div>
<div class="paragraph">
<p>Performance optimization can get quite complex,
so keep the following in mind while you attempt to configure the <code>MassIndexer</code>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Always test your changes to assess their actual effect:
advice provided in this section is true in general,
but each application and environment is different,
and some options, when combined, may produce unexpected results.</p>
</li>
<li>
<p>Take baby steps:
before tuning mass indexing with 40 indexed entity types
with two million instances each,
try a more reasonable scenario with only one entity type,
optionally limiting the number of entities to index
to assess performance more quickly.</p>
</li>
<li>
<p>Tune your entity types individually <strong>before</strong>
you try to tune a mass indexing operation that indexes multiple entity types in parallel.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="indexing-massindexer-tuning-threads"><a class="anchor" href="#indexing-massindexer-tuning-threads"></a><a id="mapper-orm-indexing-massindexer-tuning-threads"></a> <a id="search-batchindexing-threadsandconnections"></a> Threads and connections</h5>
<div class="paragraph">
<p>Increasing parallelism usually helps as the bottleneck
usually is the latency to the database/datastore connection:
it&#8217;s probably worth it to experiment with a number of threads significantly higher
than the number of actual cores available.</p>
</div>
<div class="paragraph">
<p>However, each thread requires one connection (e.g. a JDBC connection),
and connections are usually in limited supply.
In order to increase the number of threads safely:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>You should make sure your database/datastore can actually handle the resulting number of connections.</p>
</li>
<li>
<p>Your connection pool should be configured to provide a sufficient number of connections.</p>
</li>
<li>
<p>The above should take into account the rest of your application (request threads in a web application):
ignoring this may bring other processes to a halt while the <code>MassIndexer</code> is working.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>There is a simple formula to understand how
the different options applied to the <code>MassIndexer</code> affect
the number of used worker threads and connections:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>if ( using the default 'none' coordination strategy ) {
    threadsToCoordinate = 0;
}
else {
    threadsToCoordinate = 1;
}
threadsToLoadIdentifiers = 1;
threads = threadsToCoordinate + typesToIndexInParallel * (threadsToLoadObjects + threadsToLoadIdentifiers);
required connections = threads;</pre>
</div>
</div>
<div class="paragraph">
<p>Here are a few suggestions for a roughly sane tuning starting point
for the parameters that affect parallelism:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>typesToIndexInParallel</code></dt>
<dd>
<p>Should probably be a low value, like 1 or 2, depending on how much
of your CPUs have spare cycles and how slow a database round trip will be.</p>
</dd>
<dt class="hdlist1"><code>threadsToLoadObjects</code></dt>
<dd>
<p>Higher increases the preloading rate for the picked entities from
the database, but also increases memory usage and the pressure on the threads working on subsequent
indexing.
Note that each thread will extract data from the entity to reindex,
which depending on your mapping might require accessing lazy associations
and load associated entities, thus making blocking calls to the database/datastore,
so you will probably need a high number of threads working in parallel.</p>
</dd>
</dl>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>All internal thread groups have meaningful names prefixed with "Hibernate Search",
so they should be easily identified with most diagnostic tools,
including simply thread dumps.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="mapper-orm-indexing-jakarta-batch"><a class="anchor" href="#mapper-orm-indexing-jakarta-batch"></a>14.5. <a id="mapper-orm-indexing-jsr352"></a> <a id="jsr352-integration"></a> Indexing a large amount of data with the Jakarta Batch integration</h3>
<div class="sect3">
<h4 id="mapper-orm-indexing-jakarta-batch-basics"><a class="anchor" href="#mapper-orm-indexing-jakarta-batch-basics"></a>14.5.1. Basics</h4>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This feature is only available with the <a href="#mapper-orm">Hibernate ORM integration</a>.</p>
</div>
<div class="paragraph">
<p>It <strong>cannot</strong> be used with the <a href="#mapper-pojo-standalone">Standalone POJO Mapper</a> in particular.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Hibernate Search provides a Jakarta Batch job to perform mass indexing. It covers not only the existing
functionality of the mass indexer described above, but also benefits from some powerful standard
features of Jakarta Batch, such as failure recovery using checkpoints, chunk
oriented processing, and parallel execution. This batch job accepts different entity type(s) as
input, loads the relevant entities from the database, then rebuilds the full-text index from these.</p>
</div>
<div class="paragraph">
<p>Executing this job requires a batch runtime that is not provided by Hibernate Search.
You are free to choose one that fits your needs, e.g. the default
batch runtime embedded in your Jakarta EE container.
Hibernate Search provides full integration to the JBeret
implementation (see <a href="#mapper-orm-indexing-jakarta-batch-emf-jberet">how to configure it here</a>).
As for other implementations, they can also be used, but will require
<a href="#mapper-orm-indexing-jakarta-batch-emf-other-implementation">a bit more configuration on your side</a>.</p>
</div>
<div class="paragraph">
<p>If the runtime is JBeret, you need to add the following dependency:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="XML"><span class="tag">&lt;dependency&gt;</span>
   <span class="tag">&lt;groupId&gt;</span>org.hibernate.search<span class="tag">&lt;/groupId&gt;</span>
   <span class="tag">&lt;artifactId&gt;</span>hibernate-search-mapper-orm-jakarta-batch-jberet<span class="tag">&lt;/artifactId&gt;</span>
   <span class="tag">&lt;version&gt;</span>7.1.2.Final<span class="tag">&lt;/version&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>For any other runtime, you need to add the following dependency:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="XML"><span class="tag">&lt;dependency&gt;</span>
   <span class="tag">&lt;groupId&gt;</span>org.hibernate.search<span class="tag">&lt;/groupId&gt;</span>
   <span class="tag">&lt;artifactId&gt;</span>hibernate-search-mapper-orm-jakarta-batch-core<span class="tag">&lt;/artifactId&gt;</span>
   <span class="tag">&lt;version&gt;</span>7.1.2.Final<span class="tag">&lt;/version&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is an example of how to run a batch instance:</p>
</div>
<div class="exampleblock">
<div class="title">Example 152. Reindexing everything using a Jakarta Batch mass-indexing job</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">Properties</span> jobProps = MassIndexingJob.parameters() <i class="conum" data-value="1"></i><b>(1)</b>
        .forEntities( <span class="predefined-type">Book</span>.class, Author.class ) <i class="conum" data-value="2"></i><b>(2)</b>
        .build();

JobOperator jobOperator = BatchRuntime.getJobOperator(); <i class="conum" data-value="3"></i><b>(3)</b>
<span class="type">long</span> executionId = jobOperator.start( MassIndexingJob.NAME, jobProps ); <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Start building parameters for a mass-indexing job.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Define some parameters. In this case, the list of the entity types to be indexed.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Get the <code>JobOperator</code> from the framework.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Start the job.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="mapper-orm-indexing-jakarta-batch-parameters"><a class="anchor" href="#mapper-orm-indexing-jakarta-batch-parameters"></a>14.5.2. <a id="mapper-orm-indexing-jsr352-parameters"></a><a id="_job_parameters"></a> Job Parameters</h4>
<div class="paragraph">
<p>The following table contains all the job parameters you can use to customize the mass-indexing job.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 11. Job Parameters in Jakarta Batch Integration</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 16.6666%;">
<col style="width: 50.0001%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Parameter Name / Builder Method</th>
<th class="tableblock halign-left valign-top">Default value</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>entityTypes</code> / <code>.forEntity(Class&lt;?&gt;)</code>, <code>.forEntities(Class&lt;?&gt;, Class&lt;?&gt;&#8230;&#8203;)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><strong>This parameter is always required</strong>.</p>
</div>
<div class="paragraph">
<p>The entity types to index in this job execution, comma-separated.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>purgeAllOnStart</code> / <code>.purgeAllOnStart(boolean)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">True</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Specify whether the existing index should be purged at the beginning of the job. This operation
takes place before indexing.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>mergeSegmentsAfterPurge</code> / <code>.mergeSegmentsAfterPurge(boolean)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">True</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Specify whether the mass indexer should merge segments at the beginning of the job. This operation
takes place after the purge operation and before indexing.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>mergeSegmentsOnFinish</code> / <code>.mergeSegmentsOnFinish(boolean)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">True</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Specify whether the mass indexer should merge segments at the end of the job. This operation takes
place after indexing.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>cacheMode</code> / <code>.cacheMode(CacheMode)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>IGNORE</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Specify the Hibernate <code>CacheMode</code> when loading entities.
The default is <code>IGNORE</code>, and it will be the most efficient choice in most cases,
but using another mode such as <code>GET</code> may be more efficient if many of the entities being indexed
are already present in the Hibernate ORM second-level cache before mass indexing.
Enabling caches has an effect only if the entity id is also the document id, which is the default.
<code>PUT</code> or <code>NORMAL</code> values may lead to bad performance, because all the entities are also loaded into
Hibernate second level cache.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>idFetchSize</code> / <code>.idFetchSize(int)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1000</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Specifies the fetch size to be used when loading primary keys. Some databases
accept special values, for example MySQL might benefit from using <code>Integer#MIN_VALUE</code>, otherwise it
will attempt to preload everything in memory.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>entityFetchSize</code> / <code>.entityFetchSize(int)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">200, or the value of <code>checkpointInterval</code> if it is smaller</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Specifies the fetch size to be used when loading entities from database. The value defined must be greater
than 0, and equal to or less than the value of <code>checkpointInterval</code>.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>customQueryHQL</code> / <code>.restrictedBy(String)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Use HQL / JPQL to index entities of a target entity type. Your query should contain only one entity
type. Mixing this approach with the criteria restriction is not allowed. Please notice that there&#8217;s
no query validation for your input. See <a href="#mapper-orm-indexing-jakarta-batch-indexing-mode">[mapper-orm-indexing-jakarta-batch-indexing-mode]</a> for more detail and limitations.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>maxResultsPerEntity</code> / <code>.maxResultsPerEntity(int)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The maximum number of results to load per entity type. This parameter let you define a threshold
value to avoid loading too many entities accidentally. The value defined must be greater than 0.
The parameter is not used by default. It is equivalent to keyword <code>LIMIT</code> in SQL.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>rowsPerPartition</code> / <code>.rowsPerPartition(int)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">20,000</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The maximum number of rows to process per partition. The value defined must be greater than 0, and
equal to or greater than the value of <code>checkpointInterval</code>.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>maxThreads</code> / <code>.maxThreads(int)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The number of partitions</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The maximum number of threads to use for processing the job. Note the batch runtime cannot
guarantee the request number of threads are available; it will use as many as it can up to the
request maximum.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>checkpointInterval</code> / <code>.checkpointInterval(int)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2,000, or the value of <code>rowsPerPartition</code> if it is smaller</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The number of entities to process before triggering a checkpoint. The value defined must be greater
than 0, and equal to or less than the value of <code>rowsPerPartition</code>.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>entityManagerFactoryReference</code> / <code>.entityManagerFactoryReference(String)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><strong>This parameter is required</strong> when there is more than one persistence unit.</p>
</div>
<div class="paragraph">
<p>The string that will identify the <code>EntityManagerFactory</code>.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>entityManagerFactoryNamespace</code> / <code>.entityManagerFactoryNamespace(String)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>-</p>
</div></div></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="mapper-orm-indexing-jakarta-batch-conditional"><a class="anchor" href="#mapper-orm-indexing-jakarta-batch-conditional"></a>14.5.3. <a id="mapper-orm-indexing-jakarta-batch-indexing-mode"></a> <a id="jsr-352-indexing-mode"></a> Conditional indexing</h4>
<div class="paragraph">
<p>You can select a subset of target entities to be indexed
by passing a condition as string to the mass indexing job.
The condition will be applied when querying the database for entities to index.</p>
</div>
<div class="paragraph">
<p>The condition string is expected to follow the <a href="https://docs.jboss.org/hibernate/orm/6.4/userguide/html_single/Hibernate_User_Guide.html#query-language">Hibernate Query Language (HQL)</a> syntax.
Accessible entity properties are those of the entity being reindexed (and nothing more).</p>
</div>
<div class="exampleblock">
<div class="title">Example 153. Conditional indexing using a <code>reindexOnly</code> HQL parameter</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">Properties</span> jobProps = MassIndexingJob.parameters() <i class="conum" data-value="1"></i><b>(1)</b>
        .forEntities( Author.class ) <i class="conum" data-value="2"></i><b>(2)</b>
        .reindexOnly( <span class="string"><span class="delimiter">&quot;</span><span class="content">birthDate &lt; :cutoff</span><span class="delimiter">&quot;</span></span>, <i class="conum" data-value="3"></i><b>(3)</b>
                <span class="predefined-type">Map</span>.of( <span class="string"><span class="delimiter">&quot;</span><span class="content">cutoff</span><span class="delimiter">&quot;</span></span>, Year.of( <span class="integer">1950</span> ).atDay( <span class="integer">1</span> ) ) ) <i class="conum" data-value="4"></i><b>(4)</b>
        .build();

JobOperator jobOperator = BatchRuntime.getJobOperator(); <i class="conum" data-value="5"></i><b>(5)</b>
<span class="type">long</span> executionId = jobOperator.start( MassIndexingJob.NAME, jobProps ); <i class="conum" data-value="6"></i><b>(6)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Start building parameters for a mass-indexing job.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Define the entity type to be indexed.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Reindex only the authors born prior to a given local date.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>In this example the cutoff date is passed as a query parameter.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Get <code>JobOperator</code> from the framework.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Start the job.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Even if the reindexing is applied on a subset of entities, by default <strong>all entities</strong> will be purged at the start.
The purge <a href="#mapper-orm-indexing-jakarta-batch-parameters">can be disabled completely</a>,
but when enabled there is no way to filter the entities that will be purged.</p>
</div>
<div class="paragraph">
<p>See <a href="https://hibernate.atlassian.net/browse/HSEARCH-3304">HSEARCH-3304</a> for more information.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="mapper-orm-indexing-jakarta-batch-parallel-indexing"><a class="anchor" href="#mapper-orm-indexing-jakarta-batch-parallel-indexing"></a>14.5.4. <a id="mapper-orm-indexing-jsr352-parallel-indexing"></a><a id="_parallel_indexing"></a> Parallel indexing</h4>
<div class="paragraph">
<p>For better performance, indexing is performed in parallel using multiple threads. The set of
entities to index is split into multiple partitions. Each thread processes one partition at a time.</p>
</div>
<div class="paragraph">
<p>The following section will explain how to tune the parallel execution.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The "sweet spot" of number of threads, fetch size, partition size, etc. to achieve best performance
is highly dependent on your overall architecture, database design and even data values.</p>
</div>
<div class="paragraph">
<p>You should experiment with these settings to find out what&#8217;s best in your particular case.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="mapper-orm-indexing-jakarta-batch-parallel-indexing-threads"><a class="anchor" href="#mapper-orm-indexing-jakarta-batch-parallel-indexing-threads"></a><a id="mapper-orm-indexing-jsr352-parallel-indexing-threads"></a><a id="_threads"></a> Threads</h5>
<div class="paragraph">
<p>The maximum number of threads used by the job execution is defined through method <code>maxThreads()</code>.
Within the N threads given, theres 1 thread reserved for the core, so only N - 1 threads are
available for different partitions. If N = 1, the program will work, and all batch elements will run
in the same thread. The default number of threads used in Hibernate Search is 10. You can overwrite
it with your preferred number.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">MassIndexingJob.parameters()
        .maxThreads( <span class="integer">5</span> )
        ...</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Note that the batch runtime cannot guarantee the requested number of threads are available, it will
use as many as possible up to the requested maximum (Jakarta Batch Specification v2.1 Final Release, page 29). Note also that all
batch jobs share the same thread pool, so it&#8217;s not always a good idea to execute jobs concurrently.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="mapper-orm-indexing-jakarta-batch-parallel-indexing-rows-per-partition"><a class="anchor" href="#mapper-orm-indexing-jakarta-batch-parallel-indexing-rows-per-partition"></a><a id="mapper-orm-indexing-jsr352-parallel-indexing-rows-per-partition"></a><a id="_rows_per_partition"></a> Rows per partition</h5>
<div class="paragraph">
<p>Each partition consists of a fixed number of elements to index. You may tune exactly how many elements
a partition will hold with <code>rowsPerPartition</code>.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">MassIndexingJob.parameters()
        .rowsPerPartition( <span class="integer">5000</span> )
        ...</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This property has <strong>nothing</strong> to do with "chunk size",
which is how many elements are processed together between each write.
That aspect of processing is addressed by chunking.</p>
</div>
<div class="paragraph">
<p>Instead, <code>rowsPerPartition</code> is more about how parallel your mass indexing job will be.</p>
</div>
<div class="paragraph">
<p>Please see the <a href="#mapper-orm-indexing-jakarta-batch-chunking">Chunking section</a> to see how to tune chunking.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>When <code>rowsPerPartition</code> is low, there will be many small partitions,
so processing threads will be less likely to starve (stay idle because there&#8217;s no more partition to process),
but on the other hand you will only be able to take advantage of a small fetch size,
which will increase the number of database accesses.
Also, due to the failure recovery mechanisms, there is some overhead in starting a new partition,
so with an unnecessarily large number of partitions, this overhead will add up.</p>
</div>
<div class="paragraph">
<p>When <code>rowsPerPartition</code> is high, there will be a few big partitions,
so you will be able to take advantage of a higher <a href="#mapper-orm-indexing-jakarta-batch-chunking">chunk size</a>,
and thus a higher fetch size,
which will reduce the number of database accesses,
and the overhead of starting a new partition will be less noticeable,
but on the other hand you may not use all the threads available.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Each partition deals with one root entity type, so two different entity types will never run under
the same partition.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="mapper-orm-indexing-jakarta-batch-chunking"><a class="anchor" href="#mapper-orm-indexing-jakarta-batch-chunking"></a>14.5.5. <a id="jsr-352-chunking"></a> Chunking and session clearing</h4>
<div class="paragraph">
<p>The mass indexing job supports restart a suspended or failed job more or less from where it stopped.</p>
</div>
<div class="paragraph">
<p>This is made possible by splitting each partition in several consecutive <em>chunks</em> of entities,
and saving process information in a <em>checkpoint</em> at the end of each chunk.
When a job is restarted, it will resume from the last checkpoint.</p>
</div>
<div class="paragraph">
<p>The size of each chunk is determined by the <code>checkpointInterval</code> parameter.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">MassIndexingJob.parameters()
        .checkpointInterval( <span class="integer">1000</span> )
        ...</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>But the size of a chunk is not only about saving progress, it is also about performance:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>a new Hibernate session is opened for each chunk;</p>
</li>
<li>
<p>a new transaction is started for each chunk;</p>
</li>
<li>
<p>inside a chunk, the session is cleared periodically
according to the <code>entityFetchSize</code> parameter,
which must thereby be smaller than (or equal to) the chunk size;</p>
</li>
<li>
<p>documents are flushed to the index at the end of each chunk.</p>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>In general the checkpoint interval should be small compared to the number of rows per partition.</p>
</div>
<div class="paragraph">
<p>Indeed, due to the failure recovery mechanism,
the elements before the first checkpoint of each partition will take longer to process than the other,
so in a 1000-element partition, having a 100-element checkpoint interval will be faster than
having a 1000-element checkpoint interval.</p>
</div>
<div class="paragraph">
<p>On the other hand, <strong>chunks shouldn&#8217;t be too small</strong> in absolute terms.
Performing a checkpoint means your Jakarta Batch runtime
will write information about the progress of the job execution to its persistent storage,
which also has a cost.
Also, a new transaction and session are created for each chunk
which doesn&#8217;t come for free, and implies that setting the fetch size
to a value higher than the chunk size is pointless.
Finally, the index flush performed at the end of each chunk
is an expensive operation that involves a global lock,
which essentially means that the less you do it, the faster indexing will be.
Thus having a 1-element checkpoint interval is definitely not a good idea.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="mapper-orm-indexing-jakarta-batch-emf"><a class="anchor" href="#mapper-orm-indexing-jakarta-batch-emf"></a>14.5.6. <a id="jsr-352-emf"></a> Selecting the persistence unit (EntityManagerFactory)</h4>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Regardless of how the entity manager factory is retrieved,
you must make sure that the entity manager factory used by the mass indexer
will stay open during the whole mass indexing process.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="mapper-orm-indexing-jakarta-batch-emf-jberet"><a class="anchor" href="#mapper-orm-indexing-jakarta-batch-emf-jberet"></a><a id="jsr-352-emf-jberet"></a> JBeret</h5>
<div class="paragraph">
<p>If your Jakarta Batch runtime is JBeret (used in WildFly in particular),
you can use CDI to retrieve the <code>EntityManagerFactory</code>.</p>
</div>
<div class="paragraph">
<p>If you use only one persistence unit, the mass indexer will be able to access your database
automatically without any special configuration.</p>
</div>
<div class="paragraph">
<p>If you want to use multiple persistence units, you will have to register the <code>EntityManagerFactories</code>
as beans in the CDI context.
Note that entity manager factories will probably not be considered as beans by default, in which case
you will have to register them yourself. You may use an application-scoped bean to do so:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="annotation">@ApplicationScoped</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">EntityManagerFactoriesProducer</span> {

    <span class="annotation">@PersistenceUnit</span>(unitName = <span class="string"><span class="delimiter">&quot;</span><span class="content">db1</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">private</span> EntityManagerFactory db1Factory;

    <span class="annotation">@PersistenceUnit</span>(unitName = <span class="string"><span class="delimiter">&quot;</span><span class="content">db2</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">private</span> EntityManagerFactory db2Factory;

    <span class="annotation">@Produces</span>
    <span class="annotation">@Singleton</span>
    <span class="annotation">@Named</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">db1</span><span class="delimiter">&quot;</span></span>) <span class="comment">// The name to use when referencing the bean</span>
    <span class="directive">public</span> EntityManagerFactory createEntityManagerFactoryForDb1() {
        <span class="keyword">return</span> db1Factory;
    }

    <span class="annotation">@Produces</span>
    <span class="annotation">@Singleton</span>
    <span class="annotation">@Named</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">db2</span><span class="delimiter">&quot;</span></span>) <span class="comment">// The name to use when referencing the bean</span>
    <span class="directive">public</span> EntityManagerFactory createEntityManagerFactoryForDb2() {
        <span class="keyword">return</span> db2Factory;
    }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Once the entity manager factories are registered in the CDI context, you can instruct the mass
indexer to use one in particular by naming it using the <code>entityManagerReference</code> parameter.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Due to limitations of the CDI APIs, it is not currently possible to reference
an entity manager factory by its persistence unit name when using the mass indexer with CDI.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="mapper-orm-indexing-jakarta-batch-emf-other-implementation"><a class="anchor" href="#mapper-orm-indexing-jakarta-batch-emf-other-implementation"></a><a id="jsr-352-emf-other-implementation"></a> Other DI-enabled Jakarta Batch implementations</h5>
<div class="paragraph">
<p>If you want to use a different Jakarta Batch implementation that happens to allow dependency injection:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>You must map the following two scope annotations
to the relevant scope in the dependency injection mechanism:</p>
<div class="ulist">
<ul>
<li>
<p><code>org.hibernate.search.jakarta.batch.core.inject.scope.spi.HibernateSearchJobScoped</code></p>
</li>
<li>
<p><code>org.hibernate.search.jakarta.batch.core.inject.scope.spi.HibernateSearchPartitionScoped</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>You must make sure that the dependency injection mechanism will register
all injection-annotated classes (<code>@Named</code>, &#8230;&#8203;) from the
<code>hibernate-search-mapper-orm-jakarta-batch-core</code> module in the dependency injection context.
For instance this can be achieved in Spring DI using the <code>@ComponentScan</code> annotation.</p>
</li>
<li>
<p>You must register a single bean in the dependency injection context
that will implement the <code>EntityManagerFactoryRegistry</code> interface.</p>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="mapper-orm-indexing-jakarta-batch-no-dependency-injection"><a class="anchor" href="#mapper-orm-indexing-jakarta-batch-no-dependency-injection"></a><a id="mapper-orm-indexing-jsr352-no-dependency-injection"></a><a id="_plain_java_environment_no_dependency_injection_at_all"></a> Plain Java environment (no dependency injection at all)</h5>
<div class="paragraph">
<p>The following will work only if your Jakarta Batch runtime does not support dependency injection at all,
i.e. it ignores <code>@Inject</code> annotations in batch artifacts.
This is the case for JBatch in Java SE mode, for instance.</p>
</div>
<div class="paragraph">
<p>If you use only one persistence unit,
the mass indexer will be able to access your database automatically without any special configuration:
you only have to make sure to create the <code>EntityManagerFactory</code> (or <code>SessionFactory</code>)
in your application before launching the mass indexer.</p>
</div>
<div class="paragraph">
<p>If you want to use multiple persistence units, you will have to add two parameters when launching the
mass indexer:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>entityManagerFactoryReference</code>: this is the string that will identify the <code>EntityManagerFactory</code>.</p>
</li>
<li>
<p><code>entityManagerFactoryNamespace</code>: this allows to select how you want to reference the
<code>EntityManagerFactory</code>. Possible values are:</p>
<div class="ulist">
<ul>
<li>
<p><code>persistence-unit-name</code> (the default): use the persistence unit name defined in
<code>persistence.xml</code>.</p>
</li>
<li>
<p><code>session-factory-name</code>: use the session factory name defined in the Hibernate configuration by
the <code>hibernate.session_factory_name</code> configuration property.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you set the <code>hibernate.session_factory_name</code> property in the Hibernate configuration,
and you don&#8217;t use JNDI, you will also have to set <code>hibernate.session_factory_name_is_jndi</code> to <code>false</code>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="indexing-explicit"><a class="anchor" href="#indexing-explicit"></a>14.6. <a id="mapper-orm-indexing-manual"></a> <a id="manual-index-changes"></a> Explicit indexing</h3>
<div class="sect3">
<h4 id="indexing-explicit-basics"><a class="anchor" href="#indexing-explicit-basics"></a>14.6.1. <a id="mapper-orm-indexing-manual-basics"></a> <a id="search-batchindex"></a> Basics</h4>
<div class="paragraph">
<p>While <a href="#listener-triggered-indexing">listener-triggered indexing</a> and
the <a href="#indexing-massindexer"><code>MassIndexer</code></a>
or <a href="#mapper-orm-indexing-jakarta-batch">the mass indexing job</a>
should take care of most needs,
it is sometimes necessary to control indexing manually.</p>
</div>
<div class="paragraph">
<p>The need arises in particular when <a href="#listener-triggered-indexing">listener-triggered indexing</a> is <a href="#mapping-annotations">disabled</a>
or simply not supported (e.g. <a href="#mapper-pojo-standalone-indexing-listener-triggered">with the Standalone POJO Mapper</a>),
or when listener-triggered cannot detect entity changes&#8201;&#8212;&#8201;<a href="#limitations-changes-in-session">such as JPQL/SQL <code>insert</code>, <code>update</code> or <code>delete</code> queries</a>.</p>
</div>
<div class="paragraph">
<p>To address these use cases, Hibernate Search exposes several APIs
explained if the following sections.</p>
</div>
</div>
<div class="sect3">
<h4 id="listener-triggered-indexing-synchronization"><a class="anchor" href="#listener-triggered-indexing-synchronization"></a>14.6.2. Configuration</h4>
<div class="paragraph">
<p>As explicit indexing uses <a href="#indexing-plan">indexing plans</a> under the hood,
several configuration options affecting indexing plans will affect explicit indexing as well:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The <a href="#indexing-plan-synchronization">indexing plan synchronization strategy</a>.</p>
</li>
<li>
<p>The <a href="#indexing-plan-filter">indexing plan filter</a>.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="indexing-explicit-plan"><a class="anchor" href="#indexing-explicit-plan"></a>14.6.3. <a id="mapper-orm-indexing-manual-indexingplan-writes"></a> <a id="_deleting_instances_from_the_index"></a> <a id="_adding_instances_to_the_index"></a> Using a <code>SearchIndexingPlan</code> manually</h4>
<div class="paragraph">
<p>Explicit access to the <a href="#indexing-plan">indexing plan</a> is done in the context of a <a href="#entrypoints-search-session"><code>SearchSession</code></a>
using the <code>SearchIndexingPlan</code> interface.
This interface represents the (mutable) set of changes
that are planned in the context of a session,
and will be applied to indexes upon transaction commit (for the <a href="#mapper-orm">Hibernate ORM integration</a>)
or upon closing the <code>SearchSession</code> (for the <a href="#mapper-pojo-standalone">Standalone POJO Mapper</a>).</p>
</div>
<div class="paragraph">
<p>Here is how explicit indexing based on an <a href="#indexing-plan">indexing plan</a> works at a high level:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>When the application wants an index change,
it calls one of the <code>add</code>/<code>addOrUpdate</code>/<code>delete</code> methods on the indexing plan of the current <a href="#entrypoints-search-session"><code>SearchSession</code></a>.</p>
<div class="paragraph">
<p>For the <a href="#mapper-orm">Hibernate ORM integration</a> the current <code>SearchSession</code> is <a href="#entrypoints-search-session-mapper-orm">bound to the Hibernate ORM <code>Session</code></a>,
while for the <a href="#mapper-pojo-standalone">Standalone POJO Mapper</a> the <code>SearchSession</code> is <a href="#entrypoints-search-session-mapper-pojo-standalone">is created explicitly by the application</a>.</p>
</div>
</li>
<li>
<p>Eventually, the application decides changes are complete,
and the plan processes change events added so far,
either inferring which entities need to be reindexed and building the corresponding documents (<a href="#coordination-none">no coordination</a>)
or building events to be sent to the outbox (<a href="#coordination-outbox-polling"><code>outbox-polling</code> coordination</a>).</p>
<div class="paragraph">
<p>The application may trigger this explicitly using the indexing plan&#8217;s <code>process</code> method,
but it is generally not necessary as it happens automatically:
for the <a href="#mapper-orm">Hibernate ORM integration</a> this happens when the Hibernate ORM <code>Session</code> gets flushed
(explicitly or as part of a transaction commit),
while for the <a href="#mapper-pojo-standalone">Standalone POJO Mapper</a> this happens when the <code>SearchSession</code> is closed.</p>
</div>
</li>
<li>
<p>Finally the plan gets executed, triggering indexing, potentially asynchronously.</p>
<div class="paragraph">
<p>The application may trigger this explicitly using the indexing plan&#8217;s <code>execute</code> method,
but it is generally not necessary as it happens automatically:
for the <a href="#mapper-orm">Hibernate ORM integration</a> this happens on transaction commit,
while for the <a href="#mapper-pojo-standalone">Standalone POJO Mapper</a> this happens when the <code>SearchSession</code> is closed.</p>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>The <code>SearchIndexingPlan</code> interface offers the following methods:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>add(Object entity)</code></dt>
<dd>
<p>(Available with the <a href="#mapper-pojo-standalone">Standalone POJO Mapper</a> only.)</p>
<div class="paragraph">
<p>Add a document to the index if the entity type is mapped to an index (<code>@Indexed</code>).</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
This may create duplicates in the index if the document already exists.
Prefer <code>addOrUpdate</code> unless you are really sure of yourself and need a (slight) performance boost.
</td>
</tr>
</table>
</div>
</dd>
<dt class="hdlist1"><code>addOrUpdate(Object entity)</code></dt>
<dd>
<p>Add or update a document in the index if the entity type is mapped to an index (<code>@Indexed</code>),
and re-index documents that embed this entity (through <code>@IndexedEmbedded</code> for example).</p>
</dd>
<dt class="hdlist1"><code>delete(Object entity)</code></dt>
<dd>
<p>Delete a document from the index if the entity type is mapped to an index (<code>@Indexed</code>),
and re-index documents that embed this entity (through <code>@IndexedEmbedded</code> for example).</p>
</dd>
<dt class="hdlist1"><code>purge(Class&lt;?&gt; entityType, Object id)</code></dt>
<dd>
<p>Delete the entity from the index,
but do not try to re-index documents that embed this entity.</p>
<div class="paragraph">
<p>Compared to <code>delete</code>, this is mainly useful if the entity has already been deleted from the database
and is not available, even in a detached state, in the session.
In that case, reindexing associated entities will be the user&#8217;s responsibility,
since Hibernate Search cannot know which entities are associated to an entity that no longer exists.</p>
</div>
</dd>
<dt class="hdlist1"><code>purge(String entityName, Object id)</code></dt>
<dd>
<p>Same as <code>purge(Class&lt;?&gt; entityType, Object id)</code>,
but the entity type is referenced by its name (see <code>@javax.persistence.Entity#name</code>).</p>
</dd>
<dt class="hdlist1"><code>process()`</code></dt>
<dd>
<p>(Available with the <a href="#mapper-orm">Hibernate ORM integration</a> only.)</p>
<div class="paragraph">
<p>Process change events added so far,
either inferring which entities need to be reindexed and building the corresponding documents (<a href="#coordination-none">no coordination</a>)
or building events to be sent to the outbox (<a href="#coordination-outbox-polling"><code>outbox-polling</code> coordination</a>).</p>
</div>
<div class="paragraph">
<p>This method is generally executed automatically (see the high-level description near top of this section),
so calling it explicitly is only useful for batching when processing a large number of items,
as explained in <a href="#mapper-orm-indexing-manual-indexingplan-process-execute"> Hibernate ORM and the periodic "flush-clear" pattern with <code>SearchIndexingPlan</code></a>.</p>
</div>
</dd>
<dt class="hdlist1"><code>execute()</code></dt>
<dd>
<p>(Available with the <a href="#mapper-orm">Hibernate ORM integration</a> only.)</p>
<div class="paragraph">
<p>Execute the indexing plan, triggering indexing, potentially asynchronously.</p>
</div>
<div class="paragraph">
<p>This method is generally executed automatically (see the high-level description near top of this section),
so calling it explicitly is only useful in very rare cases,
for batching when processing a large number of items <strong>and transactions are not an option</strong>,
as explained in <a href="#mapper-orm-indexing-manual-indexingplan-process-execute"> Hibernate ORM and the periodic "flush-clear" pattern with <code>SearchIndexingPlan</code></a>.</p>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Below are examples of using <code>addOrUpdate</code> and <code>delete</code>.</p>
</div>
<div class="exampleblock">
<div class="title">Example 154. Explicitly adding or updating an entity in the index using <code>SearchIndexingPlan</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="comment">// Not shown: open a transaction if relevant</span>

SearchSession searchSession = <span class="comment">/* ... */</span> <i class="conum" data-value="1"></i><b>(1)</b>
SearchIndexingPlan indexingPlan = searchSession.indexingPlan(); <i class="conum" data-value="2"></i><b>(2)</b>

<span class="predefined-type">Book</span> book = entityManager.getReference( <span class="predefined-type">Book</span>.class, <span class="integer">5</span> ); <i class="conum" data-value="3"></i><b>(3)</b>

indexingPlan.addOrUpdate( book ); <i class="conum" data-value="4"></i><b>(4)</b>

<span class="comment">// Not shown: commit the transaction or close the session if relevant</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><a href="#entrypoints-search-session">Retrieve the <code>SearchSession</code></a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Get the search session&#8217;s indexing plan.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Fetch from the database the <code>Book</code> we want to index;
this could be replaced with any other way of loading an entity when using the <a href="#mapper-pojo-standalone">Standalone POJO Mapper</a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Submit the <code>Book</code> to the indexing plan for an add-or-update operation.
The operation won&#8217;t be executed immediately,
but will be delayed until the transaction is committed (<a href="#mapper-orm">Hibernate ORM integration</a>)
or until the <code>SearchSession</code> is closed (<a href="#mapper-pojo-standalone">Standalone POJO Mapper</a>).</td>
</tr>
</table>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 155. Explicitly deleting an entity from the index using <code>SearchIndexingPlan</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="comment">// Not shown: open a transaction if relevant</span>

SearchSession searchSession = <span class="comment">/* ... */</span> <i class="conum" data-value="1"></i><b>(1)</b>
SearchIndexingPlan indexingPlan = searchSession.indexingPlan(); <i class="conum" data-value="2"></i><b>(2)</b>

<span class="predefined-type">Book</span> book = entityManager.getReference( <span class="predefined-type">Book</span>.class, <span class="integer">5</span> ); <i class="conum" data-value="3"></i><b>(3)</b>

indexingPlan.delete( book ); <i class="conum" data-value="4"></i><b>(4)</b>

<span class="comment">// Not shown: commit the transaction or close the session if relevant</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><a href="#entrypoints-search-session">Retrieve the <code>SearchSession</code></a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Get the search session&#8217;s indexing plan.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Fetch from the database the <code>Book</code> we want to un-index;
this could be replaced with any other way of loading an entity when using the <a href="#mapper-pojo-standalone">Standalone POJO Mapper</a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Submit the <code>Book</code> to the indexing plan for a delete operation.
The operation won&#8217;t be executed immediately,
but will be delayed until the transaction is committed (<a href="#mapper-orm">Hibernate ORM integration</a>)
or until the <code>SearchSession</code> is closed (<a href="#mapper-pojo-standalone">Standalone POJO Mapper</a>).</td>
</tr>
</table>
</div>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Multiple operations can be performed in a single indexing plan.
The same entity can even be changed multiple times,
for example added and then removed:
Hibernate Search will simplify the operation as expected.</p>
</div>
<div class="paragraph">
<p>This will work fine for any reasonable number of entities,
but changing or simply loading large numbers of entities in a single session
requires special care with Hibernate ORM,
and then some extra care with Hibernate Search.
See <a href="#mapper-orm-indexing-manual-indexingplan-process-execute"> Hibernate ORM and the periodic "flush-clear" pattern with <code>SearchIndexingPlan</code></a> for more information.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="mapper-orm-indexing-manual-indexingplan-process-execute"><a class="anchor" href="#mapper-orm-indexing-manual-indexingplan-process-execute"></a>14.6.4. <a id="search-batchindex-flushtoindexes"></a> Hibernate ORM and the periodic "flush-clear" pattern with <code>SearchIndexingPlan</code></h4>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This feature is only available with the <a href="#mapper-orm">Hibernate ORM integration</a>.</p>
</div>
<div class="paragraph">
<p>It <strong>cannot</strong> be used with the <a href="#mapper-pojo-standalone">Standalone POJO Mapper</a> in particular.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>A fairly common use case when manipulating large datasets with JPA
is the <a href="https://docs.jboss.org/hibernate/orm/6.4/userguide/html_single/Hibernate_User_Guide.html#batch-session-batch-insert">periodic "flush-clear" pattern</a>,
where a loop reads or writes entities for every iteration
and flushes then clears the session every <code>n</code> iterations.
This pattern allows processing a large number of entities
while keeping the memory footprint reasonably low.</p>
</div>
<div class="paragraph">
<p>Below is an example of this pattern to persist a large number of entities
when not using Hibernate Search.</p>
</div>
<div class="exampleblock">
<div class="title">Example 156. A batch process with JPA</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">entityManager.getTransaction().begin();
<span class="keyword">try</span> {
    <span class="keyword">for</span> ( <span class="type">int</span> i = <span class="integer">0</span>; i &lt; NUMBER_OF_BOOKS; ++i ) { <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="predefined-type">Book</span> book = newBook( i );
        entityManager.persist( book ); <i class="conum" data-value="2"></i><b>(2)</b>

        <span class="keyword">if</span> ( ( i + <span class="integer">1</span> ) % BATCH_SIZE == <span class="integer">0</span> ) {
            entityManager.flush(); <i class="conum" data-value="3"></i><b>(3)</b>
            entityManager.clear(); <i class="conum" data-value="4"></i><b>(4)</b>
        }
    }
    entityManager.getTransaction().commit();
}
<span class="keyword">catch</span> (<span class="exception">RuntimeException</span> e) {
    entityManager.getTransaction().rollback();
    <span class="keyword">throw</span> e;
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Execute a loop for a large number of elements, inside a transaction.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>For every iteration of the loop, instantiate a new entity and persist it.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Every <code>BATCH_SIZE</code> iterations of the loop, <code>flush</code> the entity manager to send the changes to the database-side buffer.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>After a <code>flush</code>, <code>clear</code> the ORM session to release some memory.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>With Hibernate Search 6 (on contrary to Hibernate Search 5 and earlier),
this pattern will work as expected:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#coordination-none">with coordination disabled</a> (the default),
documents will be built on flushes, and sent to the index upon transaction commit.</p>
</li>
<li>
<p><a href="#coordination-outbox-polling">with outbox-polling coordination</a>,
entity change events will be persisted on flushes, and committed along with the rest of the changes upon transaction commit.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>However, each <code>flush</code> call will potentially add data to an internal buffer,
which for large volumes of data may lead to an <code>OutOfMemoryException</code>,
depending on the JVM heap size,
the <a href="#coordination">coordination strategy</a>
and the complexity and number of documents.</p>
</div>
<div class="paragraph">
<p>If you run into memory issues,
the first solution is to break down the batch process
into multiple transactions, each handling a smaller number of elements:
the internal document buffer will be cleared after each transaction.</p>
</div>
<div class="paragraph">
<p>See below for an example.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>With this pattern, if one transaction fails,
part of the data will already be in the database and in indexes,
with no way to roll back the changes.</p>
</div>
<div class="paragraph">
<p>However, the indexes will be consistent with the database,
and it will be possible to (manually) restart the process
from the last transaction that failed.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="exampleblock">
<div class="title">Example 157. A batch process with Hibernate Search using multiple transactions</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="keyword">try</span> {
    <span class="type">int</span> i = <span class="integer">0</span>;
    <span class="keyword">while</span> ( i &lt; NUMBER_OF_BOOKS ) { <i class="conum" data-value="1"></i><b>(1)</b>
        entityManager.getTransaction().begin(); <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="type">int</span> end = <span class="predefined-type">Math</span>.min( i + BATCH_SIZE, NUMBER_OF_BOOKS ); <i class="conum" data-value="3"></i><b>(3)</b>
        <span class="keyword">for</span> ( ; i &lt; end; ++i ) {
            <span class="predefined-type">Book</span> book = newBook( i );
            entityManager.persist( book ); <i class="conum" data-value="4"></i><b>(4)</b>
        }
        entityManager.getTransaction().commit(); <i class="conum" data-value="5"></i><b>(5)</b>
    }
}
<span class="keyword">catch</span> (<span class="exception">RuntimeException</span> e) {
    entityManager.getTransaction().rollback();
    <span class="keyword">throw</span> e;
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Add an outer loop that creates one transaction per iteration.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Begin the transaction at the beginning of each iteration of the outer loop.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Only handle a limited number of elements per transaction.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>For every iteration of the loop, instantiate a new entity and persist it.
Note we&#8217;re relying on listener-triggered indexing to index the entity,
but this would work just as well if listener-triggered indexing was disabled,
only requiring an extra call to index the entity.
See <a href="#indexing-plan">Indexing plans</a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Commit the transaction at the end of each iteration of the outer loop.
The entities will be flushed and indexed automatically.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The multi-transaction solution
and the original <code>flush()</code>/<code>clear()</code> loop pattern can be combined,
breaking down the process in multiple medium-sized transactions,
and periodically calling <code>flush</code>/<code>clear</code> inside each transaction.</p>
</div>
<div class="paragraph">
<p>This combined solution is the most flexible,
hence the most suitable if you want to fine-tune your batch process.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If breaking down the batch process into multiple transactions is not an option,
a second solution is to just write to indexes
after the call to <code>session.flush()</code>/<code>session.clear()</code>,
without waiting for the database transaction to be committed:
the internal document buffer will be cleared after each write to indexes.</p>
</div>
<div class="paragraph">
<p>This is done by calling the <code>execute()</code> method on the indexing plan,
as shown in the example below.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>With this pattern, if an exception is thrown,
part of the data will already be in the index, with no way to roll back the changes,
while the database changes will have been rolled back.
The index will thus be inconsistent with the database.</p>
</div>
<div class="paragraph">
<p>To recover from that situation, you will have to either
execute the exact same database changes that failed manually
(to get the database back in sync with the index),
or <a href="#indexing-plan">reindex the entities</a> affected by the transaction manually
(to get the index back in sync with the database).</p>
</div>
<div class="paragraph">
<p>Of course, if you can afford to take the indexes offline for a longer period of time,
a simpler solution would be to wipe the indexes clean
and <a href="#indexing-massindexer">reindex everything</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="exampleblock">
<div class="title">Example 158. A batch process with Hibernate Search using <code>execute()</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">SearchSession searchSession = Search.session( entityManager ); <i class="conum" data-value="1"></i><b>(1)</b>
SearchIndexingPlan indexingPlan = searchSession.indexingPlan(); <i class="conum" data-value="2"></i><b>(2)</b>

entityManager.getTransaction().begin();
<span class="keyword">try</span> {
    <span class="keyword">for</span> ( <span class="type">int</span> i = <span class="integer">0</span>; i &lt; NUMBER_OF_BOOKS; ++i ) {
        <span class="predefined-type">Book</span> book = newBook( i );
        entityManager.persist( book ); <i class="conum" data-value="3"></i><b>(3)</b>

        <span class="keyword">if</span> ( ( i + <span class="integer">1</span> ) % BATCH_SIZE == <span class="integer">0</span> ) {
            entityManager.flush();
            entityManager.clear();
            indexingPlan.execute(); <i class="conum" data-value="4"></i><b>(4)</b>
        }
    }
    entityManager.getTransaction().commit(); <i class="conum" data-value="5"></i><b>(5)</b>
}
<span class="keyword">catch</span> (<span class="exception">RuntimeException</span> e) {
    entityManager.getTransaction().rollback();
    <span class="keyword">throw</span> e;
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Get the <code>SearchSession</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Get the search session&#8217;s indexing plan.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>For every iteration of the loop, instantiate a new entity and persist it.
Note we&#8217;re relying on listener-triggered indexing to index the entity,
but this would work just as well if listener-triggered indexing was disabled,
only requiring an extra call to index the entity.
See <a href="#indexing-plan">Indexing plans</a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>After a <code>flush()</code>/<code>clear()</code>, call <code>indexingPlan.execute()</code>.
The entities will be processed and <strong>the changes will be sent to the indexes immediately</strong>.
Hibernate Search will wait for index changes to be "completed"
as required by the configured <a href="#indexing-automatic-synchronization">synchronization strategy</a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>After the loop, commit the transaction.
The remaining entities that were not flushed/cleared will be flushed and indexed automatically.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="indexing-workspace"><a class="anchor" href="#indexing-workspace"></a>14.7. <a id="mapper-orm-indexing-manual-largescale"></a> Explicitly altering a whole index</h3>
<div class="paragraph">
<p>Some index operations are not about a specific entity/document,
but rather about a large number of documents, possibly all of them.
This includes, for example, purging the index to remove all of its content.</p>
</div>
<div class="paragraph">
<p>The operations are accessed through the <code>SearchWorkspace</code> interface,
and executed immediately (<strong>outside</strong> the context of a <code>SearchSession</code>, Hibernate ORM session or transaction).</p>
</div>
<div class="paragraph">
<p>The <code>SearchWorkspace</code> can be retrieved from the <a href="#entrypoints-search-mapping"><code>SearchMapping</code></a>,
and can target one, several or all indexes:</p>
</div>
<div class="exampleblock">
<div class="title">Example 159. Retrieving a <code>SearchWorkspace</code> from the <code>SearchMapping</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">SearchMapping searchMapping = <span class="comment">/* ... */</span> <i class="conum" data-value="1"></i><b>(1)</b>
SearchWorkspace allEntitiesWorkspace = searchMapping.scope( <span class="predefined-type">Object</span>.class ).workspace(); <i class="conum" data-value="2"></i><b>(2)</b>
SearchWorkspace bookWorkspace = searchMapping.scope( <span class="predefined-type">Book</span>.class ).workspace(); <i class="conum" data-value="3"></i><b>(3)</b>
SearchWorkspace bookAndAuthorWorkspace = searchMapping.scope( <span class="predefined-type">Arrays</span>.asList( <span class="predefined-type">Book</span>.class, Author.class ) )
        .workspace(); <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><a href="#entrypoints-search-mapping">Retrieve the <code>SearchMapping</code></a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Get a workspace targeting all indexes.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Get a workspace targeting the index mapped to the <code>Book</code> entity type.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Get a workspace targeting the indexes mapped to the <code>Book</code> and <code>Author</code> entity types.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>Alternatively, for convenience, the <code>SearchWorkspace</code> can be retrieved from the <a href="#entrypoints-search-session"><code>SearchSession</code></a>:</p>
</div>
<div class="exampleblock">
<div class="title">Example 160. Retrieving a <code>SearchWorkspace</code> from the <code>SearchSession</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">SearchMapping searchMapping = <span class="comment">/* ... */</span> <i class="conum" data-value="1"></i><b>(1)</b>
SearchWorkspace allEntitiesWorkspace = searchMapping.scope( <span class="predefined-type">Object</span>.class ).workspace(); <i class="conum" data-value="2"></i><b>(2)</b>
SearchWorkspace bookWorkspace = searchMapping.scope( <span class="predefined-type">Book</span>.class ).workspace(); <i class="conum" data-value="3"></i><b>(3)</b>
SearchWorkspace bookAndAuthorWorkspace = searchMapping.scope( <span class="predefined-type">Arrays</span>.asList( <span class="predefined-type">Book</span>.class, Author.class ) )
        .workspace(); <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><a href="#entrypoints-search-session">Retrieve the <code>SearchSession</code></a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Get a workspace targeting all indexes.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Get a workspace targeting the index mapped to the <code>Book</code> entity type.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Get a workspace targeting the indexes mapped to the <code>Book</code> and <code>Author</code> entity types.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>The <code>SearchWorkspace</code> exposes various large-scale operations
that can be applied to an index or a set of indexes.
These operations are triggered as soon as they are requested,
without waiting for the <code>SearchSession</code> to be closed or the Hibernate ORM transaction to be committed.</p>
</div>
<div class="paragraph">
<p>This interface offers the following methods:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><a id="indexing-workspace-purge"></a><code>purge()</code></dt>
<dd>
<p>Delete all documents from indexes targeted by this workspace.</p>
<div class="paragraph">
<p>With multi-tenancy enabled, only documents of the current tenant will be removed:
the tenant of the session from which this workspace originated.</p>
</div>
</dd>
<dt class="hdlist1"><code>purgeAsync()</code></dt>
<dd>
<p>Asynchronous version of <code>purge()</code> returning a <code>CompletionStage</code>.</p>
</dd>
<dt class="hdlist1"><code>purge(Set&lt;String&gt; routingKeys)</code></dt>
<dd>
<p>Delete documents from indexes targeted by this workspace
that were indexed with any of the given routing keys.</p>
<div class="paragraph">
<p>With multi-tenancy enabled, only documents of the current tenant will be removed:
the tenant of the session from which this workspace originated.</p>
</div>
</dd>
<dt class="hdlist1"><code>purgeAsync(Set&lt;String&gt; routingKeys)</code></dt>
<dd>
<p>Asynchronous version of <code>purge(Set&lt;String&gt;)</code> returning a <code>CompletionStage</code>.</p>
</dd>
<dt class="hdlist1"><a id="indexing-workspace-flush"></a><code>flush()</code></dt>
<dd>
<p><a id="mapper-orm-indexing-manual-flush"></a>Flush to disk the changes to indexes that have not been committed yet.
In the case of backends with a transaction log (Elasticsearch),
also apply operations from the transaction log that were not applied yet.</p>
<div class="paragraph">
<p>This is generally not useful as Hibernate Search commits changes automatically.
See <a href="#concepts-commit-refresh">Commit and refresh</a> for more information.</p>
</div>
</dd>
<dt class="hdlist1"><code>flushAsync()</code></dt>
<dd>
<p>Asynchronous version of <code>flush()</code> returning a <code>CompletionStage</code>.</p>
</dd>
<dt class="hdlist1"><a id="indexing-workspace-refresh"></a><code>refresh()</code></dt>
<dd>
<p><a id="mapper-orm-indexing-manual-refresh"></a>Refresh the indexes so that all changes executed so far will be visible in search queries.</p>
<div class="paragraph">
<p>This is generally not useful as indexes are refreshed automatically.
See <a href="#concepts-commit-refresh">Commit and refresh</a> for more information.</p>
</div>
</dd>
<dt class="hdlist1"><code>refreshAsync()</code></dt>
<dd>
<p>Asynchronous version of <code>refresh()</code> returning a <code>CompletionStage</code>.</p>
</dd>
<dt class="hdlist1"><a id="indexing-workspace-merge"></a><code>mergeSegments()</code></dt>
<dd>
<p><a id="mapper-orm-indexing-manual-merge"></a>Merge each index targeted by this workspace into a single segment.
This operation does not always improve performance: see <a href="#indexing-workspace-merge-segments">Merging segments and performance</a>.</p>
</dd>
<dt class="hdlist1"><code>mergeSegmentsAsync()</code></dt>
<dd>
<p>Asynchronous version of <code>mergeSegments()</code> returning a <code>CompletionStage</code>.
This operation does not always improve performance: see <a href="#indexing-workspace-merge-segments">Merging segments and performance</a>.</p>
</dd>
</dl>
</div>
<div id="indexing-workspace-merge-segments" class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Merging segments and performance</div>
<div class="paragraph">
<p><a id="mapper-orm-indexing-merge-segments"></a>The merge-segments operation may affect performance positively as well as negatively.</p>
</div>
<div class="paragraph">
<p>This operation will regroup all index data into a single, huge segment (a file).
This may speed up search at first, but as documents are deleted,
this huge segment will begin to fill with "holes" which have to be handled as special cases
during search, degrading performance.</p>
</div>
<div class="paragraph">
<p>Elasticsearch/Lucene do address this by rebuilding the segment at some point,
but only once a certain ratio of deleted documents is reached.
If all documents are in a single, huge segment, this ratio is less likely to be reached,
and the index performance will continue to degrade for a long time.</p>
</div>
<div class="paragraph">
<p>There are, however, two situations in which merging segments may help:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>No deletions or document updates are expected for an extended period of time.</p>
</li>
<li>
<p>Most, or all documents have just been removed from the index,
leading to segments consisting mostly of deleted documents.
In that case, it makes sense to regroup the few remaining documents into a single segment,
though Elasticsearch/Lucene will probably do it automatically.</p>
</li>
</ol>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Below is an example using a <code>SearchWorkspace</code> to purge several indexes.</p>
</div>
<div class="exampleblock">
<div class="title">Example 161. Purging indexes using a <code>SearchWorkspace</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">SearchSession searchSession = <span class="comment">/* ... */</span> <i class="conum" data-value="1"></i><b>(1)</b>
SearchWorkspace workspace = searchSession.workspace( <span class="predefined-type">Book</span>.class, Author.class ); <i class="conum" data-value="2"></i><b>(2)</b>
workspace.purge(); <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><a href="#entrypoints-search-session">Retrieve the <code>SearchSession</code></a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Get a workspace targeting the indexes mapped to the <code>Book</code> and <code>Author</code> entity types.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Trigger a purge.
This method is synchronous and will only return after the purge is complete,
but an asynchronous method, <code>purgeAsync</code>, is also available.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="search-dsl"><a class="anchor" href="#search-dsl"></a>15. <a id="search-query-querydsl"></a> Searching</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Beyond simply indexing, Hibernate Search also exposes high-level APIs to search these indexes
without having to resort to native APIs.</p>
</div>
<div class="paragraph">
<p>One key feature of these search APIs is the ability to use indexes to perform the search,
but to return entities loaded <strong>from the database</strong>,
effectively offering a new type of query for Hibernate ORM entities.</p>
</div>
<div class="sect2">
<h3 id="search-dsl-query"><a class="anchor" href="#search-dsl-query"></a>15.1. <a id="search-query"></a> Query DSL</h3>
<div class="sect3">
<h4 id="search-dsl-query-generality"><a class="anchor" href="#search-dsl-query-generality"></a>15.1.1. <a id="_building_a_hibernate_search_query"></a> Basics</h4>
<div class="paragraph">
<p>Preparing and executing a query requires just a few lines:</p>
</div>
<div class="exampleblock">
<div class="title">Example 162. Executing a search query</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="comment">// Not shown: open a transaction if relevant</span>
SearchSession searchSession = <span class="comment">/* ... */</span> <i class="conum" data-value="1"></i><b>(1)</b>

<span class="predefined-type">SearchResult</span>&lt;<span class="predefined-type">Book</span>&gt; result = searchSession.search( <span class="predefined-type">Book</span>.class ) <i class="conum" data-value="2"></i><b>(2)</b>
        .where( f -&gt; f.match() <i class="conum" data-value="3"></i><b>(3)</b>
                .field( <span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span> )
                .matching( <span class="string"><span class="delimiter">&quot;</span><span class="content">robot</span><span class="delimiter">&quot;</span></span> ) )
        .fetch( <span class="integer">20</span> ); <i class="conum" data-value="4"></i><b>(4)</b>

<span class="type">long</span> totalHitCount = result.total().hitCount(); <i class="conum" data-value="5"></i><b>(5)</b>
<span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; hits = result.hits(); <i class="conum" data-value="6"></i><b>(6)</b>
<span class="comment">// Not shown: commit the transaction if relevant</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><a href="#entrypoints-search-session">Retrieve the <code>SearchSession</code></a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Initiate a search query on the index mapped to the <code>Book</code> <a href="#concepts-entity">entity</a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Define that only documents matching the given predicate should be returned.
The predicate is created using a factory <code>f</code> passed as an argument to the lambda expression.
See <a href="#search-dsl-predicate"> Predicate DSL</a> for more information about predicates.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Build the query and fetch the results, limiting to the top 20 hits.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Retrieve the total number of matching entities.
See <a href="#search-dsl-query-fetching-results-total">Fetching the total (hit count, &#8230;&#8203;)</a> for ways to optimize computation of the total hit count.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Retrieve matching entities.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>This will work fine with the <a href="#mapper-orm">Hibernate ORM integration</a>:
by default, the hits of a search query will be <a href="#concepts-entity">entities</a> managed by Hibernate ORM,
bound to the entity manager used to create the search session.
This provides all the benefits of Hibernate ORM,
in particular the ability to navigate the entity graph to retrieve associated entities if necessary.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>For the <a href="#mapper-pojo-standalone">Standalone POJO Mapper</a>,
the snippet above will fail by default.</p>
</div>
<div class="paragraph">
<p>You will need to either:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#mapping-entitydefinition-loading-selection">configure target entity types to enable loading</a>,
if you want to load entities from an external datasource.</p>
</li>
<li>
<p>add a <a href="#mapping-projection-basics">projection constructor</a> to target entity types,
if you want to reconstruct entities from the content of the index.</p>
</li>
<li>
<p>use explicit <a href="#search-dsl-projection">projections</a> to retrieve specific data from the index instead.</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The query DSL offers many features, detailed in the following sections.
Some commonly used features include:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#search-dsl-predicate">predicates</a>,
the main component of a search query,
i.e. the condition that every document must satisfy in order to be included in search results.</p>
</li>
<li>
<p><a href="#search-dsl-query-fetching-results">fetching the results differently</a>:
getting the hits directly as a list,
using pagination, scrolling, etc.</p>
</li>
<li>
<p><a href="#search-dsl-sort">sorts</a>,
to order the hits in various ways:
by score, by the value of a field, by distance to a point, etc.</p>
</li>
<li>
<p><a href="#search-dsl-projection">projections</a>,
to retrieve hits that are not just managed entities:
data can be extracted from the index (field values),
or even from both the index and the database.</p>
</li>
<li>
<p><a href="#search-dsl-aggregation">aggregations</a>,
to group hits and compute aggregated metrics for each group&#8201;&#8212;&#8201;hit count by category, for example.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="search-dsl-query-targeting"><a class="anchor" href="#search-dsl-query-targeting"></a>15.1.2. Advanced entity types targeting</h4>
<div class="sect4">
<h5 id="search-dsl-query-targeting-multiple"><a class="anchor" href="#search-dsl-query-targeting-multiple"></a>Targeting multiple entity types</h5>
<div class="paragraph">
<p>When multiple entity types have similar indexed fields,
it is possible to search across these multiple types in a single search query:
the search result will contain hits from any of the targeted types.</p>
</div>
<div class="exampleblock">
<div class="title">Example 163. Targeting multiple entity types in a single search query</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">SearchResult</span>&lt;Person&gt; result = searchSession.search( <span class="predefined-type">Arrays</span>.asList( <i class="conum" data-value="1"></i><b>(1)</b>
        Manager.class, Associate.class
) )
        .where( f -&gt; f.match() <i class="conum" data-value="2"></i><b>(2)</b>
                .field( <span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span> )
                .matching( <span class="string"><span class="delimiter">&quot;</span><span class="content">james</span><span class="delimiter">&quot;</span></span> ) )
        .fetch( <span class="integer">20</span> ); <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Initiate a search query targeting the indexes mapped to the <code>Manager</code> and <code>Associate</code> entity types.
Since both entity types implement the <code>Person</code> interface,
search hits will be instances of <code>Person</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Continue building the query as usual.
There are restrictions regarding the fields that can be used: see the note below.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Fetch the search result. Hits will all be instances of <code>Person</code>.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Multi-entity (multi-index) searches will only work well as long
as the fields referenced in predicates/sorts/etc. are identical in all targeted indexes (same type, same analyzer, &#8230;&#8203;).
Fields that are defined in only one of the targeted indexes will also work correctly.</p>
</div>
<div class="paragraph">
<p>If you want to reference index fields that are even <strong>slightly</strong> different
in one of the targeted indexes (different type, different analyzer, &#8230;&#8203;),
see <a href="#search-dsl-multiple-fields">Targeting multiple fields</a>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="search-dsl-query-targeting-entityName"><a class="anchor" href="#search-dsl-query-targeting-entityName"></a>Targeting entity types by name</h5>
<div class="paragraph">
<p>Though rarely necessary, it is also possible to use <a href="#mapping-entitydefinition-name">entity names</a> instead of classes
to designate the <a href="#concepts-entity">entity types</a> targeted by the search:</p>
</div>
<div class="exampleblock">
<div class="title">Example 164. Targeting entity types by name</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">SearchResult</span>&lt;Person&gt; result = searchSession.search( <i class="conum" data-value="1"></i><b>(1)</b>
        searchSession.scope( <i class="conum" data-value="2"></i><b>(2)</b>
                Person.class,
                <span class="predefined-type">Arrays</span>.asList( <span class="string"><span class="delimiter">&quot;</span><span class="content">Manager</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Associate</span><span class="delimiter">&quot;</span></span> )
        )
)
        .where( f -&gt; f.match() <i class="conum" data-value="3"></i><b>(3)</b>
                .field( <span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span> )
                .matching( <span class="string"><span class="delimiter">&quot;</span><span class="content">james</span><span class="delimiter">&quot;</span></span> ) )
        .fetch( <span class="integer">20</span> ); <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Initiate a search query.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Pass a custom scope encompassing the indexes mapped to the <code>Manager</code> and <code>Associate</code> entity types,
expecting those entity types to implement the <code>Person</code> interface (Hibernate Search will check that).</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Continue building the query as usual.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Fetch the search result. Hits will all be instances of <code>Person</code>.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="search-dsl-query-fetching-results"><a class="anchor" href="#search-dsl-query-fetching-results"></a>15.1.3. <a id="_retrieving_the_results"></a> Fetching results</h4>
<div class="sect4">
<h5 id="search-dsl-query-fetching-results-basics"><a class="anchor" href="#search-dsl-query-fetching-results-basics"></a><a id="_result_size"></a> Basics</h5>
<div class="paragraph">
<p>In Hibernate Search, the default search result is a bit more complicated than just "a list of hits".
This is why the default methods return a composite <code>SearchResult</code> object offering getters
to retrieve the part of the result you want,
as shown in the example below.</p>
</div>
<div class="exampleblock">
<div class="title">Example 165. Getting information from a <code>SearchResult</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">SearchResult</span>&lt;<span class="predefined-type">Book</span>&gt; result = searchSession.search( <span class="predefined-type">Book</span>.class ) <i class="conum" data-value="1"></i><b>(1)</b>
        .where( f -&gt; f.matchAll() )
        .fetch( <span class="integer">20</span> ); <i class="conum" data-value="2"></i><b>(2)</b>

<span class="type">long</span> totalHitCount = result.total().hitCount(); <i class="conum" data-value="3"></i><b>(3)</b>
<span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; hits = result.hits(); <i class="conum" data-value="4"></i><b>(4)</b>
<span class="comment">// ... </span><i class="conum" data-value="5"></i><b>(5)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Start building the query as usual.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Fetch the results, limiting to the top 20 hits.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Retrieve the total hit count, i.e. the total number of matching entities/documents,
which could be 10,000 even if you only retrieved the top 20 hits.
This is useful to give end users and idea of how many more hits they query produced.
See <a href="#search-dsl-query-fetching-results-total">Fetching the total (hit count, &#8230;&#8203;)</a> for ways to optimize computation of the total hit count.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Retrieve the top hits, in this case the top 20 matching entities/documents.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Other kinds of results and information can be retrieved from <code>SearchResult</code>.
They are explained in dedicated sections, such as <a href="#search-dsl-aggregation"> Aggregation DSL</a>.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>It is possible to retrieve the total hit count alone,
for cases where only the number of hits is of interest,
not the hits themselves:</p>
</div>
<div class="exampleblock">
<div class="title">Example 166. Getting the total hit count directly</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="type">long</span> totalHitCount = searchSession.search( <span class="predefined-type">Book</span>.class )
        .where( f -&gt; f.matchAll() )
        .fetchTotalHitCount();</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The top hits can also be obtained directly,
without going through a <code>SearchResult</code>,
which can be handy if only the top hits are useful, and not the total hit count:</p>
</div>
<div class="exampleblock">
<div class="title">Example 167. Getting the top hits directly</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .where( f -&gt; f.matchAll() )
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>If only zero to one hit is expected, it is possible to retrieve it as an <code>Optional</code>.
An exception will be thrown if more than one hits are returned.</p>
</div>
<div class="exampleblock">
<div class="title">Example 168. Getting the only hit directly</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">Optional&lt;<span class="predefined-type">Book</span>&gt; hit = searchSession.search( <span class="predefined-type">Book</span>.class )
        .where( f -&gt; f.id().matching( <span class="integer">1</span> ) )
        .fetchSingleHit();</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="search-dsl-query-fetching-results-all"><a class="anchor" href="#search-dsl-query-fetching-results-all"></a>Fetching all hits</h5>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Fetching all hits is rarely a good idea:
if the query matches many entities/documents,
this may lead to loading millions of entities in memory,
which will likely crash the JVM,
or at the very least slow it down to a crawl.</p>
</div>
<div class="paragraph">
<p>If you know your query will always have less than N hits,
consider setting the limit to N to avoid memory issues.</p>
</div>
<div class="paragraph">
<p>If there is no bound to the number of hits you expect,
you should consider <a href="#search-dsl-query-fetching-results-pagination"> Pagination</a>
or <a href="#search-dsl-query-fetching-results-scrolling"> Scrolling</a>
to retrieve data in batches.</p>
</div>
<div class="paragraph">
<p>If you still want to fetch all hits in one call,
be aware that the Elasticsearch backend will only ever return 10,000 hits at a time,
due to internal safety mechanisms in the Elasticsearch cluster.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="exampleblock">
<div class="title">Example 169. Getting all hits in a <code>SearchResult</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">SearchResult</span>&lt;<span class="predefined-type">Book</span>&gt; result = searchSession.search( <span class="predefined-type">Book</span>.class )
        .where( f -&gt; f.id().matchingAny( <span class="predefined-type">Arrays</span>.asList( <span class="integer">1</span>, <span class="integer">2</span> ) ) )
        .fetchAll();

<span class="type">long</span> totalHitCount = result.total().hitCount();
<span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; hits = result.hits();</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 170. Getting all hits directly</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .where( f -&gt; f.id().matchingAny( <span class="predefined-type">Arrays</span>.asList( <span class="integer">1</span>, <span class="integer">2</span> ) ) )
        .fetchAllHits();</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="search-dsl-query-fetching-results-total"><a class="anchor" href="#search-dsl-query-fetching-results-total"></a>Fetching the total (hit count, &#8230;&#8203;)</h5>
<div class="paragraph">
<p>A <code>SearchResultTotal</code> contains the count of the <strong>total</strong> hits have been matched the query, either belonging
to the current page or not. For pagination see <a href="#search-dsl-query-fetching-results-pagination"> Pagination</a>.</p>
</div>
<div class="paragraph">
<p>The total hit count is exact by default, but can be replaced with a lower-bound estimate in the following cases:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The <code>totalHitCountThreshold</code> option is enabled. See <a href="#search-dsl-query-total-hits-threshold"><code>totalHitCountThreshold(&#8230;&#8203;)</code>: optimizing total hit count computation</a>.</p>
</li>
<li>
<p>The <code>truncateAfter</code> option is enabled and a timeout occurs.</p>
</li>
</ul>
</div>
<div class="exampleblock">
<div class="title">Example 171. Working with the result total</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">SearchResult</span>&lt;<span class="predefined-type">Book</span>&gt; result = searchSession.search( <span class="predefined-type">Book</span>.class )
        .where( f -&gt; f.matchAll() )
        .fetch( <span class="integer">20</span> );

SearchResultTotal resultTotal = result.total(); <i class="conum" data-value="1"></i><b>(1)</b>
<span class="type">long</span> totalHitCount = resultTotal.hitCount(); <i class="conum" data-value="2"></i><b>(2)</b>
<span class="type">long</span> totalHitCountLowerBound = resultTotal.hitCountLowerBound(); <i class="conum" data-value="3"></i><b>(3)</b>
<span class="type">boolean</span> hitCountExact = resultTotal.isHitCountExact(); <i class="conum" data-value="4"></i><b>(4)</b>
<span class="type">boolean</span> hitCountLowerBound = resultTotal.isHitCountLowerBound(); <i class="conum" data-value="5"></i><b>(5)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Extract the <code>SearchResultTotal</code> from the <code>SearchResult</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Retrieve the exact total hit count. This call will raise an exception if the only available hit count is a lower-bound estimate.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Retrieve a lower-bound estimate of the total hit count. This will return the exact hit count if available.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Test if the count is exact.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Test if the count is a lower bound.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="search-dsl-query-total-hits-threshold"><a class="anchor" href="#search-dsl-query-total-hits-threshold"></a><code>totalHitCountThreshold(&#8230;&#8203;)</code>: optimizing total hit count computation</h5>
<div class="paragraph">
<p>When working with large result sets, counting the number of hits exactly can be very resource-consuming.</p>
</div>
<div class="paragraph">
<p>When sorting by score (the default) and retrieving the result through <code>fetch(&#8230;&#8203;)</code>,
it is possible to yield significant performance improvements by allowing Hibernate Search to return
a lower-bound estimate of the total hit count, instead of the exact total hit count.
In that case, the underlying engine (Lucene or Elasticsearch) will be able to skip large chunks of non-competitive hits,
leading to fewer index scans and thus better performance.</p>
</div>
<div class="paragraph">
<p>To enable this performance optimization, call <code>totalHitCountThreshold(&#8230;&#8203;)</code> when building the query, as shown in the example below.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This optimization has no effect in the following cases:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>when calling <code>fetchHits(&#8230;&#8203;)</code>: it is already optimized by default.</p>
</li>
<li>
<p>when calling <code>fetchTotalHitCount()</code>: it always returns an exact hit count.</p>
</li>
<li>
<p>when calling <code>scroll(&#8230;&#8203;)</code> with the Elasticsearch backend:
Elasticsearch does not support this optimization when scrolling.
The optimization is enabled for <code>scroll(&#8230;&#8203;)</code> calls with the Lucene backend, however.</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="exampleblock">
<div class="title">Example 172. Defining a total hit count threshold</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">SearchResult</span>&lt;<span class="predefined-type">Book</span>&gt; result = searchSession.search( <span class="predefined-type">Book</span>.class )
        .where( f -&gt; f.matchAll() )
        .totalHitCountThreshold( <span class="integer">1000</span> ) <i class="conum" data-value="1"></i><b>(1)</b>
        .fetch( <span class="integer">20</span> );

SearchResultTotal resultTotal = result.total(); <i class="conum" data-value="2"></i><b>(2)</b>
<span class="type">long</span> totalHitCountLowerBound = resultTotal.hitCountLowerBound(); <i class="conum" data-value="3"></i><b>(3)</b>
<span class="type">boolean</span> hitCountExact = resultTotal.isHitCountExact(); <i class="conum" data-value="4"></i><b>(4)</b>
<span class="type">boolean</span> hitCountLowerBound = resultTotal.isHitCountLowerBound(); <i class="conum" data-value="5"></i><b>(5)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Define a <code>totalHitCountThreshold</code> for the current query</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Extract the <code>SearchResultTotal</code> from the <code>SearchResult</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Retrieve a lower-bound estimate of the total hit count. This will return the exact hit count if available.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Test if the count is exact.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Test if the count is a lower-bound estimate.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="search-dsl-query-fetching-results-pagination"><a class="anchor" href="#search-dsl-query-fetching-results-pagination"></a><a id="_pagination"></a> Pagination</h5>
<div class="paragraph">
<p>Pagination is the concept of splitting hits in successive "pages",
all pages containing a fixed number of elements (except potentially the last one).
When displaying results on a web page,
the user will be able to go to an arbitrary page and see the corresponding results,
for example "results 151 to 170 of 14,265".</p>
</div>
<div class="paragraph">
<p>Pagination is achieved in Hibernate Search by passing an offset and a limit to the <code>fetch</code> or <code>fetchHits</code> method:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The offset defines the number of documents that should be skipped because they were displayed in previous pages.
It is a <strong>number of documents</strong>, not a number of pages,
so you will usually want to compute it from the page number and page size this way:
<code>offset = zero-based-page-number * page-size</code>.</p>
</li>
<li>
<p>The limit defines the maximum number of hits to return, i.e. the page size.</p>
</li>
</ul>
</div>
<div class="exampleblock">
<div class="title">Example 173. Pagination retrieving a <code>SearchResult</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">SearchResult</span>&lt;<span class="predefined-type">Book</span>&gt; result = searchSession.search( <span class="predefined-type">Book</span>.class )
        .where( f -&gt; f.matchAll() )
        .fetch( <span class="integer">40</span>, <span class="integer">20</span> ); <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Set the offset to <code>40</code> and the limit to <code>20</code>.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 174. Pagination retrieving hits directly</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .where( f -&gt; f.matchAll() )
        .fetchHits( <span class="integer">40</span>, <span class="integer">20</span> ); <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Set the offset to <code>40</code> and the limit to <code>20</code>.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The index may be modified between the retrieval of two pages.
As a result of that modification, it is possible that some hits change position,
and end up being present on two subsequent pages.</p>
</div>
<div class="paragraph">
<p>If you&#8217;re running a batch process and want to avoid this, use <a href="#search-dsl-query-fetching-results-scrolling"> Scrolling</a>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="search-dsl-query-fetching-results-scrolling"><a class="anchor" href="#search-dsl-query-fetching-results-scrolling"></a><a id="_performance_considerations"></a> Scrolling</h5>
<div class="paragraph">
<p>Scrolling is the concept of keeping a cursor on the search query at the lowest level,
and advancing that cursor progressively to collect subsequent "chunks" of search hits.</p>
</div>
<div class="paragraph">
<p>Scrolling relies on the internal state of the cursor (which must be closed at some point),
and thus is not appropriate for stateless operations such as displaying a page of results to a user in a webpage.
However, thanks to this internal state, scrolling is able to guarantee that all returned hits are consistent:
there is absolutely no way for a given hit to appear twice.</p>
</div>
<div class="paragraph">
<p>Scrolling is therefore most useful when processing a large result set as small chunks.</p>
</div>
<div class="paragraph">
<p>Below is an example of using scrolling in Hibernate Search.</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<code>SearchScroll</code> exposes a <code>close()</code> method that <strong>must</strong> be called to avoid resource leaks.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>With the Elasticsearch backend, scrolls can time out and become unusable after some time;
See <a href="#backend-elasticsearch-search-scroll-timeout">here</a> for more information.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="exampleblock">
<div class="title">Example 175. Scrolling to retrieve search results in small chunks</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="keyword">try</span> ( SearchScroll&lt;<span class="predefined-type">Book</span>&gt; scroll = searchSession.search( <span class="predefined-type">Book</span>.class )
        .where( f -&gt; f.matchAll() )
        .scroll( <span class="integer">20</span> ) ) { <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="keyword">for</span> ( SearchScrollResult&lt;<span class="predefined-type">Book</span>&gt; chunk = scroll.next(); <i class="conum" data-value="2"></i><b>(2)</b>
            chunk.hasHits(); chunk = scroll.next() ) { <i class="conum" data-value="3"></i><b>(3)</b>
        <span class="keyword">for</span> ( <span class="predefined-type">Book</span> hit : chunk.hits() ) { <i class="conum" data-value="4"></i><b>(4)</b>
            <span class="comment">// ... do something with the hits ...</span>
        }

        totalHitCount = chunk.total().hitCount(); <i class="conum" data-value="5"></i><b>(5)</b>

        entityManager.flush(); <i class="conum" data-value="6"></i><b>(6)</b>
        entityManager.clear(); <i class="conum" data-value="6"></i><b>(6)</b>
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Start a scroll that will return chunks of <code>20</code> hits.
Note the scroll is used in a <code>try-with-resource</code> block to avoid resource leaks.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Retrieve the first chunk by calling <code>next()</code>.
Each chunk will include at most 20 hits, since that was the selected chunk size.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Detect the end of the scroll by calling <code>hasHits()</code> on the last retrieved chunk,
and retrieve the next chunk by calling <code>next()</code> again on the scroll.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Retrieve the hits of a chunk.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Optionally, retrieve the total number of matching entities.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Optionally, if using Hibernate ORM and retrieving entities,
you might want to use the <a href="https://docs.jboss.org/hibernate/orm/6.4/userguide/html_single/Hibernate_User_Guide.html#batch-session-batch-insert">periodic "flush-clear" pattern</a>
to ensure entities don&#8217;t stay in the session taking more and more memory.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="search-dsl-query-routing"><a class="anchor" href="#search-dsl-query-routing"></a>15.1.4. <a id="query-filter-shard"></a> Routing</h4>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>For a preliminary introduction to sharding,
including how it works in Hibernate Search and what its limitations are,
see <a href="#concepts-sharding-routing">Sharding and routing</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If, for a given index, there is one immutable value that documents are often filtered on,
for example a "category" or a "user id",
it is possible to match documents with this value using a routing key instead of a predicate.</p>
</div>
<div class="paragraph">
<p>The main advantage of a routing key over a predicate is that, on top of filtering documents,
the routing key will also filter <a href="#concepts-sharding-routing">shards</a>.
If sharding is enabled, this means only part of the index
will be scanned during query execution,
potentially increasing search performance.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>A pre-requisite to using routing in search queries is to map your entity in such a way that
<a href="#binding-routingbridge-routingkey">it is assigned a routing key</a> at indexing time.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Specifying routing keys is done by calling the <code>.routing(String)</code> or <code>.routing(Collection&lt;String&gt;)</code> methods
when building the query:</p>
</div>
<div class="exampleblock">
<div class="title">Example 176. Routing a query to a subset of all shards</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">SearchResult</span>&lt;<span class="predefined-type">Book</span>&gt; result = searchSession.search( <span class="predefined-type">Book</span>.class ) <i class="conum" data-value="1"></i><b>(1)</b>
        .where( f -&gt; f.match()
                .field( <span class="string"><span class="delimiter">&quot;</span><span class="content">genre</span><span class="delimiter">&quot;</span></span> )
                .matching( Genre.SCIENCE_FICTION ) ) <i class="conum" data-value="2"></i><b>(2)</b>
        .routing( Genre.SCIENCE_FICTION.name() ) <i class="conum" data-value="3"></i><b>(3)</b>
        .fetch( <span class="integer">20</span> ); <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Start building the query.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Define that only documents matching the given <code>genre</code> should be returned.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>In this case, the entity is mapped in such a way that the <code>genre</code> is also used as a routing key.
We know all documents will have the given <code>genre</code> value,
so we can specify the routing key to limit the query to relevant shards.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Build the query and fetch the results.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="search-dsl-query-entity-loading-options"><a class="anchor" href="#search-dsl-query-entity-loading-options"></a>15.1.5. Entity loading options for Hibernate ORM</h4>
<div class="paragraph">
<p>When using the Hibernate ORM mapper,
Hibernate Search executes database queries to load entities
that are returned as part of the hits of a search query.</p>
</div>
<div class="paragraph">
<p>This section presents all available options related to entity loading in search queries.</p>
</div>
<div class="sect4">
<h5 id="search-dsl-query-cache-lookup-strategy"><a class="anchor" href="#search-dsl-query-cache-lookup-strategy"></a><a id="_customizing_object_initialization_strategies"></a> Cache lookup strategy</h5>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This feature is only available with the <a href="#mapper-orm">Hibernate ORM integration</a>.</p>
</div>
<div class="paragraph">
<p>It <strong>cannot</strong> be used with the <a href="#mapper-pojo-standalone">Standalone POJO Mapper</a> in particular.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>By default, Hibernate Search will load entities from the database directly,
without looking at any cache.
This is a good strategy when the size of caches (Hibernate ORM session or second level cache)
is much lower than the total number of indexed entities.</p>
</div>
<div class="paragraph">
<p>If a significant portion of your entities are present in the second level cache,
you can force Hibernate Search to retrieve entities from the persistence context (the session)
and/or the second level cache if possible.
Hibernate Search will still need to execute a database query to retrieve entities missing from the cache,
but the query will likely have to fetch fewer entities,
leading to better performance and lower stress on your database.</p>
</div>
<div class="paragraph">
<p>This is done through the cache lookup strategy,
which can be configured by setting the configuration property <code>hibernate.search.query.loading.cache_lookup.strategy</code>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>skip</code> (the default) will not perform any cache lookup.</p>
</li>
<li>
<p><code>persistence-context</code> will only look into the persistence context,
i.e. will check if the entities are already loaded in the session.
Useful if most search hits are expected to already be loaded in session,
which is generally unlikely.</p>
</li>
<li>
<p><code>persistence-context-then-second-level-cache</code> will first look into the persistence context,
then into the second level cache, if enabled in Hibernate ORM for the searched entity.
Useful if most search hits are expected to be cached,
which may be likely if you have a small number of entities and a large cache.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Before a second-level cache can be used for a given entity type,
some configuration is required in Hibernate ORM.</p>
</div>
<div class="paragraph">
<p>See <a href="https://docs.jboss.org/hibernate/orm/6.4/userguide/html_single/Hibernate_User_Guide.html#caching">the caching section of the Hibernate ORM documentation</a>
for more information.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>It is also possible to override the configured strategy on a per-query basis, as shown below.</p>
</div>
<div class="exampleblock">
<div class="title">Example 177. Overriding the cache lookup strategy in a single search query</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">SearchResult</span>&lt;<span class="predefined-type">Book</span>&gt; result = searchSession.search( <span class="predefined-type">Book</span>.class ) <i class="conum" data-value="1"></i><b>(1)</b>
        .where( f -&gt; f.match()
                .field( <span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span> )
                .matching( <span class="string"><span class="delimiter">&quot;</span><span class="content">robot</span><span class="delimiter">&quot;</span></span> ) )
        .loading( o -&gt; o.cacheLookupStrategy( <i class="conum" data-value="2"></i><b>(2)</b>
                EntityLoadingCacheLookupStrategy.PERSISTENCE_CONTEXT_THEN_SECOND_LEVEL_CACHE
        ) )
        .fetch( <span class="integer">20</span> ); <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Start building the query.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Access the loading options of the query,
then mention that the persistence context and second level cache should be checked
before entities are loaded from the database.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Fetch the results.
The more entities found in the persistence context or second level cache,
the fewer entities will be loaded from the database.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="search-dsl-query-fetch-size"><a class="anchor" href="#search-dsl-query-fetch-size"></a>Fetch size</h5>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This feature is only available with the <a href="#mapper-orm">Hibernate ORM integration</a>.</p>
</div>
<div class="paragraph">
<p>It <strong>cannot</strong> be used with the <a href="#mapper-pojo-standalone">Standalone POJO Mapper</a> in particular.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>By default, Hibernate Search will use a fetch size of <code>100</code>,
meaning that for a single <code>fetch*()</code> call on a single query,
it will run a first query to load the first 100 entities,
then if there are more hits it will run a second query to load the next 100,
etc.</p>
</div>
<div class="paragraph">
<p>The fetch size can be configured by setting the configuration property <code>hibernate.search.query.loading.fetch_size</code>.
This property expects a strictly positive <a href="#configuration-property-types">Integer value</a>.</p>
</div>
<div class="paragraph">
<p>It is also possible to override the configured fetch size on a per-query basis, as shown below.</p>
</div>
<div class="exampleblock">
<div class="title">Example 178. Overriding the fetch size in a single search query</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">SearchResult</span>&lt;<span class="predefined-type">Book</span>&gt; result = searchSession.search( <span class="predefined-type">Book</span>.class ) <i class="conum" data-value="1"></i><b>(1)</b>
        .where( f -&gt; f.match()
                .field( <span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span> )
                .matching( <span class="string"><span class="delimiter">&quot;</span><span class="content">robot</span><span class="delimiter">&quot;</span></span> ) )
        .loading( o -&gt; o.fetchSize( <span class="integer">50</span> ) ) <i class="conum" data-value="2"></i><b>(2)</b>
        .fetch( <span class="integer">200</span> ); <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Start building the query.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Access the loading options of the query,
then set the fetch size to an arbitrary value (must be <code>1</code> or more).</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Fetch the results, limiting to the top 200 hits.
One query will be executed to load the hits if there are fewer hits than the given fetch size;
two queries if there are more hits than the fetch size but less than twice the fetch size,
etc.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="search-dsl-query-entity-graph"><a class="anchor" href="#search-dsl-query-entity-graph"></a><a id="_fetching_strategy"></a> Entity graph</h5>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This feature is only available with the <a href="#mapper-orm">Hibernate ORM integration</a>.</p>
</div>
<div class="paragraph">
<p>It <strong>cannot</strong> be used with the <a href="#mapper-pojo-standalone">Standalone POJO Mapper</a> in particular.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>By default, Hibernate Search will load associations according to the defaults of your mappings:
associations marked as lazy won&#8217;t be loaded,
while associations marked as eager will be loaded before returning the entities.</p>
</div>
<div class="paragraph">
<p>It is possible to force the loading of a lazy association, or to prevent the loading of an eager association,
by referencing an entity graph in the query.
See below for an example, and
<a href="https://docs.jboss.org/hibernate/orm/6.4/userguide/html_single/Hibernate_User_Guide.html#fetching-strategies-dynamic-fetching-entity-graph">this section of the Hibernate ORM documentation</a>
for more information about entity graphs.</p>
</div>
<div class="exampleblock">
<div class="title">Example 179. Applying an entity graph to a search query</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">EntityManager entityManager = <span class="comment">/* ... */</span>

EntityGraph&lt;Manager&gt; graph = entityManager.createEntityGraph( Manager.class ); <i class="conum" data-value="1"></i><b>(1)</b>
graph.addAttributeNodes( <span class="string"><span class="delimiter">&quot;</span><span class="content">associates</span><span class="delimiter">&quot;</span></span> );

<span class="predefined-type">SearchResult</span>&lt;Manager&gt; result = Search.session( entityManager ).search( Manager.class ) <i class="conum" data-value="2"></i><b>(2)</b>
        .where( f -&gt; f.match()
                .field( <span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span> )
                .matching( <span class="string"><span class="delimiter">&quot;</span><span class="content">james</span><span class="delimiter">&quot;</span></span> ) )
        .loading( o -&gt; o.graph( graph, GraphSemantic.FETCH ) ) <i class="conum" data-value="3"></i><b>(3)</b>
        .fetch( <span class="integer">20</span> ); <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Build an entity graph.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Start building the query.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Access the loading options of the query,
then set the entity graph to the graph built above.
You must also pass a semantic: <code>GraphSemantic.FETCH</code> means only associations referenced in the graph will be loaded;
<code>GraphSemantic.LOAD</code> means associations referenced in the graph <strong>and</strong> associations marked as <code>EAGER</code> in the mapping will be loaded.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Fetch the results.
All managers loaded by this search query will have their <code>associates</code> association already populated.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>Instead of building the entity graph on the spot,
you can also define the entity graph statically using the <code>@NamedEntityGraph</code> annotation,
and pass the name of your graph to Hibernate Search, as shown below.
See <a href="https://docs.jboss.org/hibernate/orm/6.4/userguide/html_single/Hibernate_User_Guide.html#fetching-strategies-dynamic-fetching-entity-graph">this section of the Hibernate ORM documentation</a>
for more information about <code>@NamedEntityGraph</code>.</p>
</div>
<div class="exampleblock">
<div class="title">Example 180. Applying a named entity graph to a search query</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">SearchResult</span>&lt;Manager&gt; result = Search.session( entityManager ).search( Manager.class ) <i class="conum" data-value="1"></i><b>(1)</b>
        .where( f -&gt; f.match()
                .field( <span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span> )
                .matching( <span class="string"><span class="delimiter">&quot;</span><span class="content">james</span><span class="delimiter">&quot;</span></span> ) )
        .loading( o -&gt; o.graph( <span class="string"><span class="delimiter">&quot;</span><span class="content">preload-associates</span><span class="delimiter">&quot;</span></span>, GraphSemantic.FETCH ) ) <i class="conum" data-value="2"></i><b>(2)</b>
        .fetch( <span class="integer">20</span> ); <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Start building the query.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Access the loading options of the query,
then set the entity graph to "preload-associates", which was defined elsewhere using the <code>@NamedEntityGraph</code> annotation.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Fetch the results.
All managers loaded by this search query will have their <code>associates</code> association already populated.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="search-dsl-query-timeout"><a class="anchor" href="#search-dsl-query-timeout"></a>15.1.6. <a id="_limiting_the_time_of_a_query"></a> Timeout</h4>
<div class="paragraph">
<p>You can limit the time it takes for a search query to execute in two ways:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Aborting (throwing an exception) when the time limit is reached with <code>failAfter()</code>.</p>
</li>
<li>
<p>Truncating the results when the time limit is reached with <code>truncateAfter()</code>.</p>
</li>
</ul>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Currently, the two approaches are incompatible:
trying to set both <code>failAfter</code> and <code>truncateAfter</code> will result in unspecified behavior.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="search-dsl-query-timeout-failafter"><a class="anchor" href="#search-dsl-query-timeout-failafter"></a><a id="_raise_an_exception_on_time_limit"></a> <code>failAfter()</code>: Aborting the query after a given amount of time</h5>
<div class="paragraph">
<p>By calling <code>failAfter(&#8230;&#8203;)</code> when building the query,
it is possible to set a time limit for the query execution.
Once the time limit is reached,
Hibernate Search will stop the query execution and throw a <code>SearchTimeoutException</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Timeouts are handled on a best-effort basis.</p>
</div>
<div class="paragraph">
<p>Depending on the resolution of the internal clock
and on how often Hibernate Search is able to check that clock,
it is possible that a query execution exceeds the timeout.
Hibernate Search will try to minimize this excess execution time.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="exampleblock">
<div class="title">Example 181. Triggering a failure on timeout</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">            <span class="keyword">try</span> {
                <span class="predefined-type">SearchResult</span>&lt;<span class="predefined-type">Book</span>&gt; result = searchSession.search( <span class="predefined-type">Book</span>.class ) <i class="conum" data-value="1"></i><b>(1)</b>
                        .where( f -&gt; f.match()
                                .field( <span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span> )
                                .matching( <span class="string"><span class="delimiter">&quot;</span><span class="content">robot</span><span class="delimiter">&quot;</span></span> ) )
                        .failAfter( <span class="integer">500</span>, <span class="predefined-type">TimeUnit</span>.MILLISECONDS ) <i class="conum" data-value="2"></i><b>(2)</b>
                        .fetch( <span class="integer">20</span> ); <i class="conum" data-value="3"></i><b>(3)</b>
            }
            <span class="keyword">catch</span> (SearchTimeoutException e) { <i class="conum" data-value="4"></i><b>(4)</b>
                <span class="comment">// ...</span>
            }</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Build the query as usual.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Call <code>failAfter</code> to set the timeout.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Fetch the results.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Catch the exception if necessary.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p><code>explain()</code> does not honor this timeout:
this method is used for debugging purposes and in particular to find out why a query is slow.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="limit_the_number_of_results_when_the_time_limit_is_reached"><a class="anchor" href="#limit_the_number_of_results_when_the_time_limit_is_reached"></a><a id="_limit_the_number_of_results_when_the_time_limit_is_reached"></a> <code>truncateAfter()</code>: Truncating the results after a given amount of time</h5>
<div class="paragraph">
<p>By calling <code>truncateAfter(&#8230;&#8203;)</code> when building the query,
it is possible to set a time limit for the collection of search results.
Once the time limit is reached,
Hibernate Search will stop collecting hits and return an incomplete result.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Timeouts are handled on a best-effort basis.</p>
</div>
<div class="paragraph">
<p>Depending on the resolution of the internal clock
and on how often Hibernate Search is able to check that clock,
it is possible that a query execution exceeds the timeout.
Hibernate Search will try to minimize this excess execution time.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="exampleblock">
<div class="title">Example 182. Truncating the results on timeout</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">            <span class="predefined-type">SearchResult</span>&lt;<span class="predefined-type">Book</span>&gt; result = searchSession.search( <span class="predefined-type">Book</span>.class ) <i class="conum" data-value="1"></i><b>(1)</b>
                    .where( f -&gt; f.match()
                            .field( <span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span> )
                            .matching( <span class="string"><span class="delimiter">&quot;</span><span class="content">robot</span><span class="delimiter">&quot;</span></span> ) )
                    .truncateAfter( <span class="integer">500</span>, <span class="predefined-type">TimeUnit</span>.MILLISECONDS ) <i class="conum" data-value="2"></i><b>(2)</b>
                    .fetch( <span class="integer">20</span> ); <i class="conum" data-value="3"></i><b>(3)</b>

            <span class="predefined-type">Duration</span> took = result.took(); <i class="conum" data-value="4"></i><b>(4)</b>
            <span class="predefined-type">Boolean</span> timedOut = result.timedOut(); <i class="conum" data-value="5"></i><b>(5)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Build the query as usual.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Call <code>truncateAfter</code> to set the timeout.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Fetch the results.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Optionally extract <em>took</em>: how much time the query took to execute.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Optionally extract <em>timedOut</em>: whether the query timed out.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p><code>explain()</code> and <code>fetchTotalHitCount()</code> do not honor this timeout.
The former is used for debugging purposes and in particular to find out why a query is slow.
For the latter it does not make sense to return a <em>partial</em> result.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="search-dsl-query-object"><a class="anchor" href="#search-dsl-query-object"></a>15.1.7. Obtaining a query object</h4>
<div class="paragraph">
<p>The example presented in most of this documentation fetch the query results
directly at the end of the query definition DSL,
not showing any "query" object that can be manipulated.
This is because the query object generally only makes code more verbose
without bringing anything worthwhile.</p>
</div>
<div class="paragraph">
<p>However, in some cases a query object can be useful.
To get a query object, just call <code>toQuery()</code> at the end of the query definition:</p>
</div>
<div class="exampleblock">
<div class="title">Example 183. Getting a <code>SearchQuery</code> object</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">SearchQuery&lt;<span class="predefined-type">Book</span>&gt; query = searchSession.search( <span class="predefined-type">Book</span>.class ) <i class="conum" data-value="1"></i><b>(1)</b>
        .where( f -&gt; f.matchAll() )
        .toQuery(); <i class="conum" data-value="2"></i><b>(2)</b>
<span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; hits = query.fetchHits( <span class="integer">20</span> ); <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Build the query as usual.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Retrieve a <code>SearchQuery</code> object.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Fetch the results.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>This query object supports all <a href="#search-dsl-query-fetching-results"><code>fetch*</code> methods supported by the query DSL</a>.
The main advantage over calling these methods directly at the end of a query definition
is mostly related to <a href="#troubleshooting">troubleshooting</a>,
but the query object can also be useful if you need an adapter to another API.</p>
</div>
<div class="paragraph">
<p>Hibernate Search provides an adapter to JPA and Hibernate ORM&#8217;s native APIs,
i.e. a way to turn a <code>SearchQuery</code> into a <code>javax.persistence.TypedQuery</code> (JPA)
or a <code>org.hibernate.query.Query</code> (native ORM API):</p>
</div>
<div class="exampleblock">
<div class="title">Example 184. Turning a <code>SearchQuery</code> into a JPA or Hibernate ORM query</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">SearchQuery&lt;<span class="predefined-type">Book</span>&gt; query = searchSession.search( <span class="predefined-type">Book</span>.class ) <i class="conum" data-value="1"></i><b>(1)</b>
        .where( f -&gt; f.matchAll() )
        .toQuery(); <i class="conum" data-value="2"></i><b>(2)</b>
jakarta.persistence.TypedQuery&lt;<span class="predefined-type">Book</span>&gt; jpaQuery = Search.toJpaQuery( query ); <i class="conum" data-value="3"></i><b>(3)</b>
org.hibernate.query.Query&lt;<span class="predefined-type">Book</span>&gt; ormQuery = Search.toOrmQuery( query ); <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Build the query as usual.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Retrieve a <code>SearchQuery</code> object.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Turn the <code>SearchQuery</code> object into a JPA query.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Turn the <code>SearchQuery</code> object into a Hibernate ORM query.</td>
</tr>
</table>
</div>
</div>
</div>
<div id="_resulttransformer" class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The resulting query <strong>does not support all operations</strong>,
so it is recommended to only convert search queries when absolutely required,
for example when integrating with code that only works with Hibernate ORM queries.</p>
</div>
<div class="paragraph">
<p>The following operations are expected to work correctly in most cases,
even though they may behave slightly differently from what is expected from a JPA <code>TypedQuery</code>
or Hibernate ORM <code>Query</code> in some cases
(including, but not limited to, the type of thrown exceptions):</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Direct hit retrieval methods: <code>list</code>, <code>getResultList</code>, <code>uniqueResult</code>, &#8230;&#8203;</p>
</li>
<li>
<p>Scrolling: <code>scroll()</code>, <code>scroll(ScrollMode)</code> (but only with <code>ScrollMode.FORWARDS_ONLY</code>).</p>
</li>
<li>
<p><code>setFirstResult</code>/<code>setMaxResults</code> and getters.</p>
</li>
<li>
<p><code>setFetchSize</code></p>
</li>
<li>
<p><code>unwrap</code></p>
</li>
<li>
<p><code>setHint</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The following operations are known not to work correctly,
with no plan to fix them at the moment:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>getHints</code></p>
</li>
<li>
<p>Parameter-related methods: <code>setParameter</code>, &#8230;&#8203;</p>
</li>
<li>
<p>Result transformer: <code>setResultTransformer</code>, &#8230;&#8203;
Use <a href="#search-dsl-projection-composite">composite projections</a> instead.</p>
</li>
<li>
<p>Lock-related methods: <code>setLockOptions</code>, &#8230;&#8203;</p>
</li>
<li>
<p>And more: this list is not exhaustive.</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="search-dsl-query-explain"><a class="anchor" href="#search-dsl-query-explain"></a>15.1.8. <code>explain(&#8230;&#8203;)</code>: Explaining scores</h4>
<div class="paragraph">
<p>In order to <a href="#troubleshooting-faq-search-score">explain the score</a> of a particular document,
<a href="#search-dsl-query-object">create a <code>SearchQuery</code> object</a>
using <code>toQuery()</code> at the end of the query definition,
and then use one of the backend-specific <code>explain(&#8230;&#8203;)</code> methods;
the result of these methods will include a human-readable description of
how the score of a specific document was computed.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Regardless of the API used, explanations are rather costly performance-wise:
only use them for debugging purposes.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="exampleblock">
<div class="title">Example 185. Retrieving score explanation&#8201;&#8212;&#8201;Lucene</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">LuceneSearchQuery&lt;<span class="predefined-type">Book</span>&gt; query = searchSession.search( <span class="predefined-type">Book</span>.class )
        .extension( LuceneExtension.get() ) <i class="conum" data-value="1"></i><b>(1)</b>
        .where( f -&gt; f.match()
                .field( <span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span> )
                .matching( <span class="string"><span class="delimiter">&quot;</span><span class="content">robot</span><span class="delimiter">&quot;</span></span> ) )
        .toQuery(); <i class="conum" data-value="2"></i><b>(2)</b>

Explanation explanation1 = query.explain( <span class="integer">1</span> ); <i class="conum" data-value="3"></i><b>(3)</b>
Explanation explanation2 = query.explain( <span class="string"><span class="delimiter">&quot;</span><span class="content">Book</span><span class="delimiter">&quot;</span></span>, <span class="integer">1</span> ); <i class="conum" data-value="4"></i><b>(4)</b>

LuceneSearchQuery&lt;<span class="predefined-type">Book</span>&gt; luceneQuery = query.extension( LuceneExtension.get() ); <i class="conum" data-value="5"></i><b>(5)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Build the query as usual,
but using the Lucene extension so that the retrieved query exposes Lucene-specific operations.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Retrieve a <code>SearchQuery</code> object.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Retrieve the explanation of the score of the entity with ID <code>1</code>.
The explanation is of type <code>Explanation</code>, but you can convert it to a readable string using <code>toString()</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>For multi-index queries, it is necessary to refer to the entity not only by its ID,
but also by the name of its type.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>If you cannot change the code building the query to use the Lucene extension,
you can instead use the Lucene extension on the <code>SearchQuery</code> to convert it after its creation.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 186. Retrieving score explanation&#8201;&#8212;&#8201;Elasticsearch</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">ElasticsearchSearchQuery&lt;<span class="predefined-type">Book</span>&gt; query = searchSession.search( <span class="predefined-type">Book</span>.class )
        .extension( ElasticsearchExtension.get() ) <i class="conum" data-value="1"></i><b>(1)</b>
        .where( f -&gt; f.match()
                .field( <span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span> )
                .matching( <span class="string"><span class="delimiter">&quot;</span><span class="content">robot</span><span class="delimiter">&quot;</span></span> ) )
        .toQuery(); <i class="conum" data-value="2"></i><b>(2)</b>

JsonObject explanation1 = query.explain( <span class="integer">1</span> ); <i class="conum" data-value="3"></i><b>(3)</b>
JsonObject explanation2 = query.explain( <span class="string"><span class="delimiter">&quot;</span><span class="content">Book</span><span class="delimiter">&quot;</span></span>, <span class="integer">1</span> ); <i class="conum" data-value="4"></i><b>(4)</b>

ElasticsearchSearchQuery&lt;<span class="predefined-type">Book</span>&gt; elasticsearchQuery = query.extension( ElasticsearchExtension.get() ); <i class="conum" data-value="5"></i><b>(5)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Build the query as usual,
but using the Elasticsearch extension so that the retrieved query exposes Elasticsearch-specific operations.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Retrieve a <code>SearchQuery</code> object.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Retrieve the explanation of the score of the entity with ID <code>1</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>For multi-index queries, it is necessary to refer to the entity not only by its ID,
but also by the name of its type.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>If you cannot change the code building the query to use the Elasticsearch extension,
you can instead use the Elasticsearch extension on the <code>SearchQuery</code> to convert it after its creation.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="search-dsl-query-took-timedout"><a class="anchor" href="#search-dsl-query-took-timedout"></a>15.1.9. <a id="search-dsl-query-debugging-took-timedout"></a> <code>took</code> and <code>timedOut</code>: finding out how long the query took</h4>
<div class="exampleblock">
<div class="title">Example 187. Returning query execution time and whether a timeout occurred</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">SearchQuery&lt;<span class="predefined-type">Book</span>&gt; query = searchSession.search( <span class="predefined-type">Book</span>.class )
        .where( f -&gt; f.match()
                .field( <span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span> )
                .matching( <span class="string"><span class="delimiter">&quot;</span><span class="content">robot</span><span class="delimiter">&quot;</span></span> ) )
        .toQuery();

<span class="predefined-type">SearchResult</span>&lt;<span class="predefined-type">Book</span>&gt; result = query.fetch( <span class="integer">20</span> ); <i class="conum" data-value="1"></i><b>(1)</b>

<span class="predefined-type">Duration</span> took = result.took(); <i class="conum" data-value="2"></i><b>(2)</b>
<span class="predefined-type">Boolean</span> timedOut = result.timedOut(); <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Fetch the results.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Extract <em>took</em>: how much time the query took
(in case of Elasticsearch, ignoring network latency between the application and the Elasticsearch cluster).</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Extract <em>timedOut</em>: whether the query timed out
(in case of Elasticsearch, ignoring network latency between the application and the Elasticsearch cluster).</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="search-dsl-query-elasticsearch-json"><a class="anchor" href="#search-dsl-query-elasticsearch-json"></a>15.1.10. Elasticsearch: leveraging advanced features with JSON manipulation</h4>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Features detailed below are <em>incubating</em>: they are still under active development.</p>
</div>
<div class="paragraph">
<p>The usual <a href="https://hibernate.org/community/compatibility-policy/">compatibility policy</a> does not apply:
the contract of incubating elements (e.g. types, methods, configuration properties, etc.)
may be altered in a backward-incompatible way&#8201;&#8212;&#8201;or even removed&#8201;&#8212;&#8201;in subsequent releases.</p>
</div>
<div class="paragraph">
<p>You are encouraged to use incubating features so the development team can get feedback and improve them,
but you should be prepared to update code which relies on them as needed.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Elasticsearch ships with many features.
It is possible that at some point, one feature you need will not be exposed by the Search DSL.</p>
</div>
<div class="paragraph">
<p>To work around such limitations, Hibernate Search provides ways to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Transform the HTTP request sent to Elasticsearch for search queries.</p>
</li>
<li>
<p>Read the raw JSON of the HTTP response received from Elasticsearch for search queries.</p>
</li>
</ul>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Direct changes to the HTTP request may conflict with Hibernate Search features
and be supported differently by different versions of Elasticsearch.</p>
</div>
<div class="paragraph">
<p>Similarly, the content of the HTTP response may change
depending on the version of Elasticsearch,
depending on which Hibernate Search features are used,
and even depending on how Hibernate Search features are implemented.</p>
</div>
<div class="paragraph">
<p>Thus, features relying on direct access to HTTP requests or responses
cannot be guaranteed to continue to work when upgrading Hibernate Search,
even for micro upgrades (<code>x.y.z</code> to <code>x.y.(z+1)</code>).</p>
</div>
<div class="paragraph">
<p>Use this at your own risk.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Most simple use cases will only need to change the HTTP request slightly, as shown below.</p>
</div>
<div class="exampleblock">
<div class="title">Example 188. Transforming the Elasticsearch request manually in a search query</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .extension( ElasticsearchExtension.get() ) <i class="conum" data-value="1"></i><b>(1)</b>
        .where( f -&gt; f.match()
                .field( <span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span> )
                .matching( <span class="string"><span class="delimiter">&quot;</span><span class="content">robot</span><span class="delimiter">&quot;</span></span> ) )
        .requestTransformer( context -&gt; { <i class="conum" data-value="2"></i><b>(2)</b>
            <span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; parameters = context.parametersMap(); <i class="conum" data-value="3"></i><b>(3)</b>
            parameters.put( <span class="string"><span class="delimiter">&quot;</span><span class="content">search_type</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">dfs_query_then_fetch</span><span class="delimiter">&quot;</span></span> );

            JsonObject body = context.body(); <i class="conum" data-value="4"></i><b>(4)</b>
            body.addProperty( <span class="string"><span class="delimiter">&quot;</span><span class="content">min_score</span><span class="delimiter">&quot;</span></span>, <span class="float">0.5f</span> );
        } )
        .fetchHits( <span class="integer">20</span> ); <i class="conum" data-value="5"></i><b>(5)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Build the query as usual,
but using the Elasticsearch extension so that Elasticsearch-specific options are available.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Add a request transformer to the query.
Its <code>transform</code> method will be called whenever a request is about to be sent to Elasticsearch.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Inside the <code>transform</code> method, alter the HTTP query parameters.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>It is also possible to alter the request&#8217;s JSON body as shown here,
or even the request&#8217;s path (not shown in this example).</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Retrieve the result as usual.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>For more complicated use cases, it is possible to access the raw JSON of the HTTP response, as shown below.</p>
</div>
<div class="exampleblock">
<div class="title">Example 189. Accessing the Elasticsearch response body manually in a search query</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">ElasticsearchSearchResult&lt;<span class="predefined-type">Book</span>&gt; result = searchSession.search( <span class="predefined-type">Book</span>.class )
        .extension( ElasticsearchExtension.get() ) <i class="conum" data-value="1"></i><b>(1)</b>
        .where( f -&gt; f.match()
                .field( <span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span> )
                .matching( <span class="string"><span class="delimiter">&quot;</span><span class="content">robt</span><span class="delimiter">&quot;</span></span> ) )
        .requestTransformer( context -&gt; { <i class="conum" data-value="2"></i><b>(2)</b>
            JsonObject body = context.body();
            body.add( <span class="string"><span class="delimiter">&quot;</span><span class="content">suggest</span><span class="delimiter">&quot;</span></span>, jsonObject( suggest -&gt; { <i class="conum" data-value="3"></i><b>(3)</b>
                suggest.add( <span class="string"><span class="delimiter">&quot;</span><span class="content">my-suggest</span><span class="delimiter">&quot;</span></span>, jsonObject( mySuggest -&gt; {
                    mySuggest.addProperty( <span class="string"><span class="delimiter">&quot;</span><span class="content">text</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">robt</span><span class="delimiter">&quot;</span></span> );
                    mySuggest.add( <span class="string"><span class="delimiter">&quot;</span><span class="content">term</span><span class="delimiter">&quot;</span></span>, jsonObject( term -&gt; {
                        term.addProperty( <span class="string"><span class="delimiter">&quot;</span><span class="content">field</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span> );
                    } ) );
                } ) );
            } ) );
        } )
        .fetch( <span class="integer">20</span> ); <i class="conum" data-value="4"></i><b>(4)</b>

JsonObject responseBody = result.responseBody(); <i class="conum" data-value="5"></i><b>(5)</b>
JsonArray mySuggestResults = responseBody.getAsJsonObject( <span class="string"><span class="delimiter">&quot;</span><span class="content">suggest</span><span class="delimiter">&quot;</span></span> ) <i class="conum" data-value="6"></i><b>(6)</b>
        .getAsJsonArray( <span class="string"><span class="delimiter">&quot;</span><span class="content">my-suggest</span><span class="delimiter">&quot;</span></span> );</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Build the query as usual,
but using the Elasticsearch extension so that Elasticsearch-specific options are available.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Add a request transformer to the query.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Add content to the request body,
so that Elasticsearch will return more data in the response.
Here we&#8217;re asking Elasticsearch to apply a <a href="https://www.elastic.co/guide/en/elasticsearch/reference/8.13/search-suggesters.html">suggester</a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Retrieve the result as usual.
Since we used the Elasticsearch extension when building the query,
the result is an <code>ElasticsearchSearchResult</code> instead of the usual <code>SearchResult</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Get the response body as a <code>JsonObject</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Extract useful information from the response body.
Here we&#8217;re extracting the result of the suggester we configured above.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Gson&#8217;s API for building JSON objects is quite verbose,
so the example above relies on a small, custom helper method to make the code more readable:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="directive">private</span> <span class="directive">static</span> JsonObject jsonObject(Consumer&lt;JsonObject&gt; instructions) {
    JsonObject object = <span class="keyword">new</span> JsonObject();
    instructions.accept( object );
    <span class="keyword">return</span> object;
}</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>When data needs to be extracted from each hit,
it is often more convenient to use the <a href="#search-dsl-projection-extensions-elasticsearch-jsonHit"><code>jsonHit</code> projection</a>
than parsing the whole response.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="search-dsl-query-lucene-low-level"><a class="anchor" href="#search-dsl-query-lucene-low-level"></a>15.1.11. Lucene: retrieving low-level components</h4>
<div class="paragraph">
<p>Lucene queries allow to retrieve some low-level components.
This should only be useful to integrators, but is documented here for the sake of completeness.</p>
</div>
<div class="exampleblock">
<div class="title">Example 190. Accessing low-level components in a Lucene search query</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">LuceneSearchQuery&lt;<span class="predefined-type">Book</span>&gt; query = searchSession.search( <span class="predefined-type">Book</span>.class )
        .extension( LuceneExtension.get() ) <i class="conum" data-value="1"></i><b>(1)</b>
        .where( f -&gt; f.match()
                .field( <span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span> )
                .matching( <span class="string"><span class="delimiter">&quot;</span><span class="content">robot</span><span class="delimiter">&quot;</span></span> ) )
        .sort( f -&gt; f.field( <span class="string"><span class="delimiter">&quot;</span><span class="content">title_sort</span><span class="delimiter">&quot;</span></span> ) )
        .toQuery(); <i class="conum" data-value="2"></i><b>(2)</b>

Sort sort = query.luceneSort(); <i class="conum" data-value="3"></i><b>(3)</b>

LuceneSearchResult&lt;<span class="predefined-type">Book</span>&gt; result = query.fetch( <span class="integer">20</span> ); <i class="conum" data-value="4"></i><b>(4)</b>

TopDocs topDocs = result.topDocs(); <i class="conum" data-value="5"></i><b>(5)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Build the query as usual,
but using the Lucene extension so that Lucene-specific options are available.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Since we used the Lucene extension when building the query,
the query is a <code>LuceneSearchQuery</code> instead of the usual <code>SearchQuery</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Retrieve the <code>org.apache.lucene.search.Sort</code> this query relies on.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Retrieve the result as usual.
<code>LuceneSearchQuery</code> returns a <code>LuceneSearchResult</code> instead of the usual <code>SearchResult</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Retrieve the <code>org.apache.lucene.search.TopDocs</code> for this result.
Note that the <code>TopDocs</code> are offset according to the arguments to the <code>fetch</code> method, if any.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="search-dsl-predicate"><a class="anchor" href="#search-dsl-predicate"></a>15.2. <a id="query-predicate"></a> Predicate DSL</h3>
<div class="sect3">
<h4 id="search-dsl-predicate-concepts"><a class="anchor" href="#search-dsl-predicate-concepts"></a>15.2.1. Basics</h4>
<div class="paragraph">
<p>The main component of a search query is the <em>predicate</em>,
i.e. the condition that every document must satisfy in order to be included in search results.</p>
</div>
<div class="paragraph">
<p>The predicate is configured when building the search query:</p>
</div>
<div class="exampleblock">
<div class="title">Example 191. Defining the predicate of a search query</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">SearchSession searchSession = <span class="comment">/* ... */</span> <i class="conum" data-value="1"></i><b>(1)</b>

<span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; result = searchSession.search( <span class="predefined-type">Book</span>.class ) <i class="conum" data-value="2"></i><b>(2)</b>
        .where( f -&gt; f.match().field( <span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span> ) <i class="conum" data-value="3"></i><b>(3)</b>
                .matching( <span class="string"><span class="delimiter">&quot;</span><span class="content">robot</span><span class="delimiter">&quot;</span></span> ) )
        .fetchHits( <span class="integer">20</span> ); <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><a href="#entrypoints-search-session">Retrieve the <code>SearchSession</code></a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Start building the query.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Mention that the results of the query are expected to have a <code>title</code> field matching the value <code>robot</code>.
If the field does not exist or cannot be searched on, an exception will be thrown.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Fetch the results, which will match the given predicate.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>Alternatively, if you don&#8217;t want to use lambdas:</p>
</div>
<div class="exampleblock">
<div class="title">Example 192. Defining the predicate of a search query&#8201;&#8212;&#8201;object-based syntax</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">SearchSession searchSession = <span class="comment">/* ... */</span>

SearchScope&lt;<span class="predefined-type">Book</span>&gt; scope = searchSession.scope( <span class="predefined-type">Book</span>.class );

<span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; result = searchSession.search( scope )
        .where( scope.predicate().match().field( <span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span> )
                .matching( <span class="string"><span class="delimiter">&quot;</span><span class="content">robot</span><span class="delimiter">&quot;</span></span> )
                .toPredicate() )
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The predicate DSL offers more predicate types, and multiple options for each type of predicate.
To learn more about the <code>match</code> predicate, and all the other types of predicate,
refer to the following sections.</p>
</div>
</div>
<div class="sect3">
<h4 id="search-dsl-predicate-match-all"><a class="anchor" href="#search-dsl-predicate-match-all"></a>15.2.2. <code>matchAll</code>: match all documents</h4>
<div class="paragraph">
<p>The <code>matchAll</code> predicate simply matches all documents.</p>
</div>
<div class="exampleblock">
<div class="title">Example 193. Matching all documents</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .where( f -&gt; f.matchAll() )
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="search-dsl-predicate-match-all-except"><a class="anchor" href="#search-dsl-predicate-match-all-except"></a><code>except(&#8230;&#8203;)</code>: exclude documents matching a given predicate</h5>
<div class="paragraph">
<p>Optionally, you can exclude a few documents from the hits:</p>
</div>
<div class="exampleblock">
<div class="title">Example 194. Matching all documents except those matching a given predicate</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .where( f -&gt; f.matchAll()
                .except( f.match().field( <span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span> )
                        .matching( <span class="string"><span class="delimiter">&quot;</span><span class="content">robot</span><span class="delimiter">&quot;</span></span> ) )
        )
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="search-dsl-predicate-match-all-other"><a class="anchor" href="#search-dsl-predicate-match-all-other"></a>Other options</h5>
<div class="ulist">
<ul>
<li>
<p>The score of a <code>matchAll</code> predicate is constant and equal to 1 by default,
but can be <a href="#search-dsl-predicate-common-boost">boosted with <code>.boost(&#8230;&#8203;)</code></a>.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="search-dsl-predicate-match-none"><a class="anchor" href="#search-dsl-predicate-match-none"></a>15.2.3. <code>matchNone</code>: match no documents</h4>
<div class="paragraph">
<p>The <code>matchNone</code> predicate is the inverse of <code>matchAll</code> and matches no documents.</p>
</div>
<div class="exampleblock">
<div class="title">Example 195. Matching no documents</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .where( f -&gt; f.matchNone() )
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="search-dsl-predicate-id"><a class="anchor" href="#search-dsl-predicate-id"></a>15.2.4. <code>id</code>: match a document identifier</h4>
<div class="paragraph">
<p>The <code>id</code> predicate matches documents by their identifier.</p>
</div>
<div class="exampleblock">
<div class="title">Example 196. Matching a document with a given identifier</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .where( f -&gt; f.id().matching( <span class="integer">1</span> ) )
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>You can also match multiple ids in a single predicate:</p>
</div>
<div class="exampleblock">
<div class="title">Example 197. Matching all documents with an identifier among a given collection</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;<span class="predefined-type">Integer</span>&gt; ids = <span class="keyword">new</span> <span class="predefined-type">ArrayList</span>&lt;&gt;();
ids.add( <span class="integer">1</span> );
ids.add( <span class="integer">2</span> );
<span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .where( f -&gt; f.id().matchingAny( ids ) )
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="search-dsl-predicate-id-argument-type"><a class="anchor" href="#search-dsl-predicate-id-argument-type"></a>Expected type of arguments</h5>
<div class="paragraph">
<p>By default, the <code>id</code> predicate expects arguments to the <code>matching(&#8230;&#8203;)</code>/<code>matchingAny(&#8230;&#8203;)</code> methods
to have the same type as the entity property corresponding to the document id.</p>
</div>
<div class="paragraph">
<p>For example, if the document identifier is generated from an entity identifier of type <code>Long</code>,
the document identifier will still be of type <code>String</code>.
<code>matching(&#8230;&#8203;)</code>/<code>matchingAny(&#8230;&#8203;)</code> will expect its argument to be of type <code>Long</code> regardless.</p>
</div>
<div class="paragraph">
<p>This should generally be what you want,
but if you ever need to bypass conversion and pass an unconverted argument (of type <code>String</code>)
to <code>matching(&#8230;&#8203;)</code>/<code>matchingAny(&#8230;&#8203;)</code>, see <a href="#search-dsl-argument-type">Type of arguments passed to the DSL</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="search-dsl-predicate-id-other"><a class="anchor" href="#search-dsl-predicate-id-other"></a>Other options</h5>
<div class="ulist">
<ul>
<li>
<p>The score of an <code>id</code> predicate is constant and equal to 1 by default,
but can be <a href="#search-dsl-predicate-common-boost">boosted with <code>.boost(&#8230;&#8203;)</code></a>.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="search-dsl-predicate-match"><a class="anchor" href="#search-dsl-predicate-match"></a>15.2.5. <a id="_keyword_queries"></a> <code>match</code>: match a value</h4>
<div class="paragraph">
<p>The <code>match</code> predicate matches documents for which a given field has a given value.</p>
</div>
<div class="exampleblock">
<div class="title">Example 198. Matching a value</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .where( f -&gt; f.match().field( <span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span> )
                .matching( <span class="string"><span class="delimiter">&quot;</span><span class="content">robot</span><span class="delimiter">&quot;</span></span> ) )
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="search-dsl-predicate-match-argument-type"><a class="anchor" href="#search-dsl-predicate-match-argument-type"></a>Expected type of arguments</h5>
<div class="paragraph">
<p>By default, the <code>match</code> predicate expects arguments to the <code>matching(&#8230;&#8203;)</code> method
to have the same type as the entity property corresponding to the target field.</p>
</div>
<div class="paragraph">
<p>For example, if an entity property is of an enum type,
<a href="#mapping-directfieldmapping-supported-types">the corresponding field may be of type <code>String</code></a>.
<code>.matching(&#8230;&#8203;)</code> will expect its argument to have the enum type regardless.</p>
</div>
<div class="paragraph">
<p>This should generally be what you want,
but if you ever need to bypass conversion and pass an unconverted argument
(of type <code>String</code> in the example above)
to <code>.matching(&#8230;&#8203;)</code>, see <a href="#search-dsl-argument-type">Type of arguments passed to the DSL</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="search-dsl-predicate-match-multiple-fields"><a class="anchor" href="#search-dsl-predicate-match-multiple-fields"></a>Targeting multiple fields</h5>
<div class="paragraph">
<p>Optionally, the predicate can target multiple fields.
In that case, the predicate will match documents for which <em>any</em> of the given fields matches.</p>
</div>
<div class="paragraph">
<p>See <a href="#search-dsl-predicate-common-multiple-fields">Targeting multiple fields in one predicate</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="search-dsl-predicate-match-analysis"><a class="anchor" href="#search-dsl-predicate-match-analysis"></a>Analysis</h5>
<div class="paragraph">
<p>For most field types (number, date, &#8230;&#8203;), the match is exact.
However, for <a href="#mapping-directfieldmapping-annotations-fulltextfield">full-text</a> fields
or <a href="#mapping-directfieldmapping-annotations-keywordfield">normalized keyword</a> fields,
the value passed to the <code>matching(&#8230;&#8203;)</code> method is analyzed or normalized before being compared to the values in the index.
This means the match is more subtle in two ways.</p>
</div>
<div class="paragraph">
<p>First, the predicate will not just match documents for which a given field has the exact same value:
it will match all documents for which this field has a value whose normalized form is identical.
See below for an example.</p>
</div>
<div class="exampleblock">
<div class="title">Example 199. Matching normalized terms</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;Author&gt; hits = searchSession.search( Author.class )
        .where( f -&gt; f.match().field( <span class="string"><span class="delimiter">&quot;</span><span class="content">lastName</span><span class="delimiter">&quot;</span></span> )
                .matching( <span class="string"><span class="delimiter">&quot;</span><span class="content">ASIMOV</span><span class="delimiter">&quot;</span></span> ) )<i class="conum" data-value="1"></i><b>(1)</b>
        .fetchHits( <span class="integer">20</span> );

assertThat( hits ).extracting( Author::getLastName )
        .contains( <span class="string"><span class="delimiter">&quot;</span><span class="content">Asimov</span><span class="delimiter">&quot;</span></span> );<i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>For analyzed/normalized fields, the value passed to <code>matching</code> will be analyzed/normalized.
In this case, the result of analysis is a lowercase string: <code>asimov</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>All returned hits will have a value whose normalized form is identical.
In this case, <code>Asimov</code> was normalized to <code>asimov</code> too, so it matched.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>Second, for <a href="#mapping-directfieldmapping-annotations-fulltextfield">full-text</a> fields,
the value passed to the <code>matching(&#8230;&#8203;)</code> method is tokenized.
This means multiple terms may be extracted from the input value,
and the predicate will match all documents for which the given field has a value that <em>contains any of those terms</em>,
at any place and in any order.
See below for an example.</p>
</div>
<div class="exampleblock">
<div class="title">Example 200. Matching multiple terms</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .where( f -&gt; f.match().field( <span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span> )
                .matching( <span class="string"><span class="delimiter">&quot;</span><span class="content">ROBOT Dawn</span><span class="delimiter">&quot;</span></span> ) ) <i class="conum" data-value="1"></i><b>(1)</b>
        .fetchHits( <span class="integer">20</span> );

assertThat( hits ).extracting( <span class="predefined-type">Book</span>::getTitle )
        .contains( <span class="string"><span class="delimiter">&quot;</span><span class="content">The Robots of Dawn</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">I, Robot</span><span class="delimiter">&quot;</span></span> ); <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>For full-text fields, the value passed to <code>matching</code> will be tokenized and normalized.
In this case, the result of analysis is the terms <code>robot</code> and <code>dawn</code> (notice they were lowercased).</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>All returned hits will match <strong>at least one</strong> term of the given string.
<code>The Robots of Dawn</code> contained both normalized terms <code>robot</code> and <code>dawn</code>, so it matched,
but so did <code>I, Robot</code>, even though it didn&#8217;t contain <code>dawn</code>: only one term is required.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Hits matching multiple terms, or matching more relevant terms, will have a higher <a href="#search-dsl-predicate-common-score">score</a>.
Thus, if you sort by score, the most relevant hits will appear to the top of the result list.
This usually makes up for the fact that the predicate does not require <em>all</em> terms to be present in matched documents.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you need <em>all</em> terms to be present in matched documents,
you should be able to do so by using the <a href="#search-dsl-predicate-simple-query-string"><code>simpleQueryString</code></a> predicate,
in particular its ability to define a <a href="#search-dsl-predicate-simple-query-string-boolean-operators-default">default operator</a>.
Just make sure to define which <a href="#search-dsl-predicate-simple-query-string-flags">syntax features</a>
you want to expose to your users.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="search-dsl-predicate-match-fuzzy"><a class="anchor" href="#search-dsl-predicate-match-fuzzy"></a><a id="_fuzzy_queries"></a> <code>fuzzy</code>: match a text value approximately</h5>
<div class="paragraph">
<p>The <code>.fuzzy()</code> option allows for approximate matches,
i.e. it allows matching documents for which a given field has a value that is not exactly the value passed to <code>matching(&#8230;&#8203;)</code>,
but a close value, for example with one letter that was switched for another.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This option is only available on text fields.
</td>
</tr>
</table>
</div>
<div class="exampleblock">
<div class="title">Example 201. Matching a text value approximately</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .where( f -&gt; f.match()
                .field( <span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span> )
                .matching( <span class="string"><span class="delimiter">&quot;</span><span class="content">robto</span><span class="delimiter">&quot;</span></span> )
                .fuzzy() )
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Roughly speaking, the edit distance is the number of changes between two terms:
switching characters, removing them, &#8230;&#8203;
It defaults to <code>2</code> when fuzzy matching is enabled,
but can also be set to <code>0</code> (fuzzy matching disabled) or <code>1</code> (only one change allowed, so "less fuzzy").
Values higher than 2 are not allowed.</p>
</div>
<div class="exampleblock">
<div class="title">Example 202. Matching a text value approximately with explicit edit distance</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .where( f -&gt; f.match()
                .field( <span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span> )
                .matching( <span class="string"><span class="delimiter">&quot;</span><span class="content">robto</span><span class="delimiter">&quot;</span></span> )
                .fuzzy( <span class="integer">1</span> ) )
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Optionally, you can force the match to be exact for the first <code>n</code> characters.
<code>n</code> is called the "exact-prefix length".
Setting this to a non-zero value is recommended for indexes containing a large amount of distinct terms,
for performance reasons.</p>
</div>
<div class="exampleblock">
<div class="title">Example 203. Matching a text value approximately with exact prefix length</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .where( f -&gt; f.match()
                .field( <span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span> )
                .matching( <span class="string"><span class="delimiter">&quot;</span><span class="content">robto</span><span class="delimiter">&quot;</span></span> )
                .fuzzy( <span class="integer">1</span>, <span class="integer">3</span> ) )
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="search-dsl-predicate-match-other"><a class="anchor" href="#search-dsl-predicate-match-other"></a>Other options</h5>
<div class="ulist">
<ul>
<li>
<p>The score of a <code>match</code> predicate is variable for text fields by default,
but can be <a href="#search-dsl-predicate-common-constantScore">made constant with <code>.constantScore()</code></a>.</p>
</li>
<li>
<p>The score of a <code>match</code> predicate can be <a href="#search-dsl-predicate-common-boost">boosted</a>,
either on a per-field basis with a call to <code>.boost(&#8230;&#8203;)</code> just after <code>.field(&#8230;&#8203;)</code>/<code>.fields(&#8230;&#8203;)</code>
or for the whole predicate with a call to <code>.boost(&#8230;&#8203;)</code> after <code>.matching(&#8230;&#8203;)</code>.</p>
</li>
<li>
<p>The <code>match</code> predicate uses the <a href="#mapping-directfieldmapping-search-analyzer">search analyzer</a>
of targeted fields to analyze searched text by default,
but this can be <a href="#search-dsl-predicate-common-overriding-analysis">overridden</a>.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="search-dsl-predicate-range"><a class="anchor" href="#search-dsl-predicate-range"></a>15.2.6. <a id="_range_queries"></a> <code>range</code>: match a range of values</h4>
<div class="paragraph">
<p>The <code>range</code> predicate matches documents for which a given field has a value within a given range.</p>
</div>
<div class="exampleblock">
<div class="title">Example 204. Matching a range of values</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .where( f -&gt; f.range().field( <span class="string"><span class="delimiter">&quot;</span><span class="content">pageCount</span><span class="delimiter">&quot;</span></span> )
                .between( <span class="integer">210</span>, <span class="integer">250</span> ) )
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The <code>between</code> method includes both bounds,
i.e. documents whose value is exactly one of the bounds will match the <code>range</code> predicate.</p>
</div>
<div class="paragraph">
<p>At least one bound must be provided.
If a bound is <code>null</code>, it will not constrain matches.
For example <code>.between( 2, null )</code> will match all values higher than or equal to 2.</p>
</div>
<div class="paragraph">
<p>Different methods can be called instead of <code>between</code> in order to control the inclusion of the lower and upper bound:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>atLeast</code></dt>
<dd>
<div class="exampleblock">
<div class="title">Example 205. Matching values equal to or greater than a given value</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .where( f -&gt; f.range().field( <span class="string"><span class="delimiter">&quot;</span><span class="content">pageCount</span><span class="delimiter">&quot;</span></span> )
                .atLeast( <span class="integer">400</span> ) )
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
</div>
</div>
</dd>
<dt class="hdlist1"><code>greaterThan</code></dt>
<dd>
<div class="exampleblock">
<div class="title">Example 206. Matching values strictly greater than a given value</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .where( f -&gt; f.range().field( <span class="string"><span class="delimiter">&quot;</span><span class="content">pageCount</span><span class="delimiter">&quot;</span></span> )
                .greaterThan( <span class="integer">400</span> ) )
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
</div>
</div>
</dd>
<dt class="hdlist1"><code>atMost</code></dt>
<dd>
<div class="exampleblock">
<div class="title">Example 207. Matching values equal to or less than a given value</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .where( f -&gt; f.range().field( <span class="string"><span class="delimiter">&quot;</span><span class="content">pageCount</span><span class="delimiter">&quot;</span></span> )
                .atMost( <span class="integer">400</span> ) )
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
</div>
</div>
</dd>
<dt class="hdlist1"><code>lessThan</code></dt>
<dd>
<div class="exampleblock">
<div class="title">Example 208. Matching values strictly less than a given value</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .where( f -&gt; f.range().field( <span class="string"><span class="delimiter">&quot;</span><span class="content">pageCount</span><span class="delimiter">&quot;</span></span> )
                .lessThan( <span class="integer">400</span> ) )
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
</div>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Alternatively, you can specify whether bounds are included or excluded explicitly:</p>
</div>
<div class="exampleblock">
<div class="title">Example 209. Matching a range of values with explicit bound inclusion/exclusion</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .where( f -&gt; f.range().field( <span class="string"><span class="delimiter">&quot;</span><span class="content">pageCount</span><span class="delimiter">&quot;</span></span> )
                .between(
                        <span class="integer">200</span>, RangeBoundInclusion.EXCLUDED,
                        <span class="integer">250</span>, RangeBoundInclusion.EXCLUDED
                ) )
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="search-dsl-predicate-range-argument-type"><a class="anchor" href="#search-dsl-predicate-range-argument-type"></a>Expected type of arguments</h5>
<div class="paragraph">
<p>By default, the <code>range</code> predicate expects arguments to the <code>between(&#8230;&#8203;)</code>/<code>atLeast(&#8230;&#8203;)</code>/etc. method
to have the same type as the entity property corresponding to the target field.</p>
</div>
<div class="paragraph">
<p>For example, if an entity property is of type <code>java.util.Date</code>,
<a href="#mapping-directfieldmapping-supported-types">the corresponding field may be of type <code>java.time.Instant</code></a>;
<code>between(&#8230;&#8203;)</code>/<code>atLeast(&#8230;&#8203;)</code>/etc. will expect its arguments to have type <code>java.util.Date</code> regardless.
Similarly, <code>range(&#8230;&#8203;)</code> will expect an argument of type <code>Range&lt;java.util.Date&gt;</code>.</p>
</div>
<div class="paragraph">
<p>This should generally be what you want,
but if you ever need to bypass conversion and pass an unconverted argument
(of type <code>java.time.Instant</code> in the example above)
to <code>between(&#8230;&#8203;)</code>/<code>atLeast(&#8230;&#8203;)</code>/etc., see <a href="#search-dsl-argument-type">Type of arguments passed to the DSL</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="search-dsl-predicate-range-multiple-fields"><a class="anchor" href="#search-dsl-predicate-range-multiple-fields"></a>Targeting multiple fields</h5>
<div class="paragraph">
<p>Optionally, the predicate can target multiple fields.
In that case, the predicate will match documents for which <em>any</em> of the given fields matches.</p>
</div>
<div class="paragraph">
<p>See <a href="#search-dsl-predicate-common-multiple-fields">Targeting multiple fields in one predicate</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="search-dsl-predicate-range-other"><a class="anchor" href="#search-dsl-predicate-range-other"></a>Other options</h5>
<div class="ulist">
<ul>
<li>
<p>The score of a <code>range</code> predicate is constant and equal to 1 by default,
but can be <a href="#search-dsl-predicate-common-boost">boosted</a>,
either on a per-field basis with a call to <code>.boost(&#8230;&#8203;)</code> just after <code>.field(&#8230;&#8203;)</code>/<code>.fields(&#8230;&#8203;)</code>
or for the whole predicate with a call to <code>.boost(&#8230;&#8203;)</code> after <code>.between(&#8230;&#8203;)</code>/<code>atLeast(&#8230;&#8203;)</code>/etc.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="search-dsl-predicate-phrase"><a class="anchor" href="#search-dsl-predicate-phrase"></a>15.2.7. <a id="_phrase_queries"></a> <code>phrase</code>: match a sequence of words</h4>
<div class="paragraph">
<p>The <code>phrase</code> predicate matches documents for which a given field contains a given sequence of words, in the given order.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This predicate is only available on <a href="#mapping-directfieldmapping-annotations-fulltextfield">full-text fields</a>.
</td>
</tr>
</table>
</div>
<div class="exampleblock">
<div class="title">Example 210. Matching a sequence of words</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .where( f -&gt; f.phrase().field( <span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span> )
                .matching( <span class="string"><span class="delimiter">&quot;</span><span class="content">robots of dawn</span><span class="delimiter">&quot;</span></span> ) )
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="search-dsl-predicate-phrase-slop"><a class="anchor" href="#search-dsl-predicate-phrase-slop"></a><code>slop</code>: match a sequence of words approximately</h5>
<div class="paragraph">
<p>Specifying a <em>slop</em> allows for approximate matches,
i.e. it allows matching documents for which a given field contains the given sequence of words,
but in a slightly different order, or with extra words.</p>
</div>
<div class="paragraph">
<p>The slop represents the number of edit operations that can be applied to the sequence of words to match,
where each edit operation moves one word by one position.
So <code>quick fox</code> with a slop of <code>1</code> can become <code>quick &lt;word&gt; fox</code>, where <code>&lt;word&gt;</code> can be any word.
<code>quick fox</code> with a slop of <code>2</code> can become <code>quick &lt;word&gt; fox</code>, or <code>quick &lt;word1&gt; &lt;word2&gt; fox</code>
or even <code>fox quick</code> (two operations: moved <code>fox</code> to the left and <code>quick</code> to the right).
And similarly for higher slops and for phrases with more words.</p>
</div>
<div class="exampleblock">
<div class="title">Example 211. Matching a sequence of words approximately with <code>slop(&#8230;&#8203;)</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .where( f -&gt; f.phrase().field( <span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span> )
                .matching( <span class="string"><span class="delimiter">&quot;</span><span class="content">dawn robot</span><span class="delimiter">&quot;</span></span> )
                .slop( <span class="integer">3</span> ) )
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="search-dsl-predicate-phrase-multiple-fields"><a class="anchor" href="#search-dsl-predicate-phrase-multiple-fields"></a>Targeting multiple fields</h5>
<div class="paragraph">
<p>Optionally, the predicate can target multiple fields.
In that case, the predicate will match documents for which <em>any</em> of the given fields matches.</p>
</div>
<div class="paragraph">
<p>See <a href="#search-dsl-predicate-common-multiple-fields">Targeting multiple fields in one predicate</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="search-dsl-predicate-phrase-other"><a class="anchor" href="#search-dsl-predicate-phrase-other"></a>Other options</h5>
<div class="ulist">
<ul>
<li>
<p>The score of a <code>phrase</code> predicate is variable by default,
but can be <a href="#search-dsl-predicate-common-constantScore">made constant with <code>.constantScore()</code></a>.</p>
</li>
<li>
<p>The score of a <code>phrase</code> predicate can be <a href="#search-dsl-predicate-common-boost">boosted</a>,
either on a per-field basis with a call to <code>.boost(&#8230;&#8203;)</code> just after <code>.field(&#8230;&#8203;)</code>/<code>.fields(&#8230;&#8203;)</code>
or for the whole predicate with a call to <code>.boost(&#8230;&#8203;)</code> after <code>.matching(&#8230;&#8203;)</code>.</p>
</li>
<li>
<p>The <code>phrase</code> predicate uses the <a href="#mapping-directfieldmapping-search-analyzer">search analyzer</a>
of targeted fields  to analyze searched text by default,
but this can be <a href="#search-dsl-predicate-common-overriding-analysis">overridden</a>.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="search-dsl-predicate-exists"><a class="anchor" href="#search-dsl-predicate-exists"></a>15.2.8. <code>exists</code>: match fields with content</h4>
<div class="paragraph">
<p>The <code>exists</code> predicate matches documents for which a given field has a non-null value.</p>
</div>
<div class="exampleblock">
<div class="title">Example 212. Matching fields with content</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .where( f -&gt; f.exists().field( <span class="string"><span class="delimiter">&quot;</span><span class="content">comment</span><span class="delimiter">&quot;</span></span> ) )
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>There isn&#8217;t any built-in predicate to match documents for which a given field is null,
but you can easily create one yourself by negating an <code>exists</code> predicate.</p>
</div>
<div class="paragraph">
<p>This can be achieved by passing in an <code>exists</code> predicate
to a <a href="#search-dsl-predicate-not"><code>not</code> predicate</a>,
or by using it in an <a href="#search-dsl-predicate-match-all-except"><code>except</code> clause in a <code>matchAll</code> predicate</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="search-dsl-predicate-exists-object-field"><a class="anchor" href="#search-dsl-predicate-exists-object-field"></a>Object fields</h5>
<div class="paragraph">
<p>The <code>exists</code> predicate can also be applied to an object field.
In that case, it will match all documents for which at least one inner field of the given object field has a non-null value.</p>
</div>
<div class="exampleblock">
<div class="title">Example 213. Matching object fields with content</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;Author&gt; hits = searchSession.search( Author.class )
        .where( f -&gt; f.exists().field( <span class="string"><span class="delimiter">&quot;</span><span class="content">placeOfBirth</span><span class="delimiter">&quot;</span></span> ) )
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Object fields need to have at least one inner field with content in order to be considered as "existing".</p>
</div>
<div class="paragraph">
<p>Let&#8217;s consider the example above, and let&#8217;s assume the <code>placeOfBirth</code> object field
only has one inner field: <code>placeOfBirth.country</code>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>an author whose <code>placeOfBirth</code> is null will not match.</p>
</li>
<li>
<p>an author whose <code>placeOfBirth</code> is not null and has the <code>country</code> filled in will match.</p>
</li>
<li>
<p>an author whose <code>placeOfBirth</code> is not null but does not have the <code>country</code> filled in <strong>will not match</strong>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Because of this, it is preferable to use the <code>exists</code> predicate
on object fields that are known to have at least one inner field that is never null: an identifier, a name, &#8230;&#8203;</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="search-dsl-predicate-exists-other"><a class="anchor" href="#search-dsl-predicate-exists-other"></a>Other options</h5>
<div class="ulist">
<ul>
<li>
<p>The score of an <code>exists</code> predicate is constant and equal to 1 by default,
but can be <a href="#search-dsl-predicate-common-boost">boosted with a call to <code>.boost(&#8230;&#8203;)</code></a>.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="search-dsl-predicate-wildcard"><a class="anchor" href="#search-dsl-predicate-wildcard"></a>15.2.9. <a id="_wildcard_queries"></a> <code>wildcard</code>: match a simple pattern</h4>
<div class="paragraph">
<p>The <code>wildcard</code> predicate matches documents for which a given field contains a word matching the given pattern.</p>
</div>
<div class="exampleblock">
<div class="title">Example 214. Matching a simple pattern</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .where( f -&gt; f.wildcard().field( <span class="string"><span class="delimiter">&quot;</span><span class="content">description</span><span class="delimiter">&quot;</span></span> )
                .matching( <span class="string"><span class="delimiter">&quot;</span><span class="content">rob*t</span><span class="delimiter">&quot;</span></span> ) )
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The pattern may include the following characters:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>*</code> matches zero, one or multiple characters.</p>
</li>
<li>
<p><code>?</code> matches zero or one character.</p>
</li>
<li>
<p><code>\</code> escape the following character,
e.g. <code>\?</code> is interpreted as a literal <code>?</code>, <code>\\</code> as a literal <code>\</code>, etc.</p>
</li>
<li>
<p>any other character is interpreted as a literal.</p>
</li>
</ul>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If a normalizer has been defined on the field, the patterns used in wildcard predicates
will be normalized.</p>
</div>
<div class="paragraph">
<p>If an analyzer has been defined on the field:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>when using the Elasticsearch backend, the patterns won&#8217;t be analyzed nor normalized,
and will be expected to match a <strong>single</strong> indexed token, not a sequence of tokens.
This may behave differently on an older versions of the underlying search engine
(for example with Elasticsearch 7.7-7.11 or OpenSearch prior to 2.5 the wildcard pattern will get normalized).
Hence, please refer to the documentation of your particular version for the exact behaviour.</p>
</li>
<li>
<p>when using the Lucene backend the patterns will be normalized, but not tokenized:
the pattern will still be expected to match a <strong>single</strong> indexed token, not a sequence of tokens.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For example, a pattern such as <code>Cat*</code> could match <code>cat</code>
when targeting a field having a normalizer that applies a lowercase filter when indexing.</p>
</div>
<div class="paragraph">
<p>A pattern such as <code>john gr*</code> will not match anything
when targeting a field that tokenizes on spaces.
<code>gr*</code> may match, since it doesn&#8217;t include any space.</p>
</div>
<div class="paragraph">
<p>When the goal is to match user-provided query strings,
the <a href="#search-dsl-predicate-simple-query-string">simple query string predicate</a> should be preferred.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="search-dsl-predicate-wildcard-multiple-fields"><a class="anchor" href="#search-dsl-predicate-wildcard-multiple-fields"></a>Targeting multiple fields</h5>
<div class="paragraph">
<p>Optionally, the predicate can target multiple fields.
In that case, the predicate will match documents for which <em>any</em> of the given fields matches.</p>
</div>
<div class="paragraph">
<p>See <a href="#search-dsl-predicate-common-multiple-fields">Targeting multiple fields in one predicate</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="search-dsl-predicate-wildcard-other"><a class="anchor" href="#search-dsl-predicate-wildcard-other"></a>Other options</h5>
<div class="ulist">
<ul>
<li>
<p>The score of a <code>wildcard</code> predicate is constant and equal to 1 by default,
but can be <a href="#search-dsl-predicate-common-boost">boosted</a>,
either on a per-field basis with a call to <code>.boost(&#8230;&#8203;)</code> just after <code>.field(&#8230;&#8203;)</code>/<code>.fields(&#8230;&#8203;)</code>
or for the whole predicate with a call to <code>.boost(&#8230;&#8203;)</code> after <code>.matching(&#8230;&#8203;)</code>.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="search-dsl-predicate-regexp"><a class="anchor" href="#search-dsl-predicate-regexp"></a>15.2.10. <code>regexp</code>: match a regular expression pattern</h4>
<div class="paragraph">
<p>The <code>regexp</code> predicate matches documents for which a given field contains a word matching the given regular expression.</p>
</div>
<div class="exampleblock">
<div class="title">Example 215. Matching a regular expression pattern</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .where( f -&gt; f.regexp().field( <span class="string"><span class="delimiter">&quot;</span><span class="content">description</span><span class="delimiter">&quot;</span></span> )
                .matching( <span class="string"><span class="delimiter">&quot;</span><span class="content">r.*t</span><span class="delimiter">&quot;</span></span> ) )
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="search-dsl-predicate-regexp-analysis"><a class="anchor" href="#search-dsl-predicate-regexp-analysis"></a><a id="_regexp_predicates_and_analysis"></a> Regexp predicates and analysis</h5>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
For an introduction to analysis and how to configure it,
refer to the <a href="#concepts-analysis"> Analysis</a> section.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The behavior of regexp predicates on analyzed/normalized fields is a bit complex,
so here is a summary of how it works.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Regexps must match <strong>the entirety</strong> of analyzed/normalized tokens</dt>
<dd>
<p>For a field that is lowercased and tokenized on spaces (using an analyzer), the regexp <code>robots?</code>:</p>
<div class="ulist">
<ul>
<li>
<p>will match <code>Robot</code>: the indexed token <code>robot</code> matches.</p>
</li>
<li>
<p>will match <code>I love robots</code>: the indexed token <code>robots</code> matches.</p>
</li>
<li>
<p>will <strong>not</strong> match <code>Mr. Roboto</code>: the indexed token <code>roboto</code> does not match.</p>
<div class="paragraph">
<p>For a field that is lowercased but not tokenized (using a normalizer), the regexp <code>robots?</code>:</p>
</div>
</li>
<li>
<p>will match <code>Robot</code>: the indexed token <code>robot</code> matches.</p>
</li>
<li>
<p>will <strong>not</strong> match <code>I love robots</code>: the indexed token <code>i love robots</code> does not match.</p>
</li>
<li>
<p>will <strong>not</strong> match <code>Mr. Roboto</code>: the indexed token <code>mr. roboto</code> does not match.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Regexps are never tokenized, even if fields are</dt>
<dd>
<p>Beware of spaces in regexps, in particular.</p>
<div class="paragraph">
<p>For a field that is tokenized on spaces (using an analyzer), the regexp <code>.*love .* robots?</code> will never match anything,
because it requires a space inside the token and indexed tokens don&#8217;t contain any (since tokenization happens on spaces).</p>
</div>
<div class="paragraph">
<p>For a field that is lowercased, but not tokenized (using a normalizer), the regexp <code>.*love .* robots?</code>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>will match <code>I love robots</code>, which was indexed as <code>i love robots</code>.</p>
</li>
<li>
<p>will match <code>I love my Robot</code>, which was indexed as <code>i love my robot</code>.</p>
</li>
<li>
<p>will <strong>not</strong> match <code>I love Mr. Roboto</code>, which was indexed as <code>i love mr. roboto</code>: <code>roboto</code> doesn&#8217;t match <code>robots?</code>.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">With the Lucene backend, regexps are never analyzed nor normalized</dt>
<dd>
<p>For a field that is lowercased and tokenized on spaces:</p>
<div class="ulist">
<ul>
<li>
<p>the regexp <code>Robots?</code> will <strong>not</strong> be normalized and will never match anything,
because it requires an uppercase letter and indexed tokens don&#8217;t contain any (since they are lowercased).</p>
</li>
<li>
<p>the regexp <code>[Rr]obots?</code> will <strong>not</strong> be normalized but will match <code>I love Robots</code>: the indexed token <code>robots</code> matches.</p>
</li>
<li>
<p>the regexp <code>love .* robots?</code> will <strong>not</strong> be normalized and will match <code>I love my Robot</code> as well as <code>I love robots</code>, but not <code>Robots love me</code>.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">With the Elasticsearch backend, regexps are not analyzed nor normalized on text (tokenized) fields, but <strong>are normalized on keyword (non-tokenized) fields</strong></dt>
<dd>
<p>For a field that is lowercased and tokenized on spaces (using an analyzer):</p>
<div class="ulist">
<ul>
<li>
<p>the regexp <code>Robots?</code> will <strong>not</strong> be normalized and will never match anything,
because it requires an uppercase letter and indexed tokens don&#8217;t contain any (since they are lowercased).</p>
</li>
<li>
<p>the regexp <code>[Rr]obots?</code> will <strong>not</strong> be normalized but will match <code>I love Robots</code>: the indexed token <code>robots</code> matches.</p>
</li>
<li>
<p>the regexp <code>love .* robots?</code> will <strong>not</strong> be normalized and will match <code>I love my Robot</code> as well as <code>I love robots</code>, but not <code>Robots love me</code>.</p>
<div class="paragraph">
<p>However, <strong>behavior differs from Lucene for normalized fields</strong>!
For a field that is lowercased, but not tokenized (using a normalizer):</p>
</div>
</li>
<li>
<p>the regexp <code>Robots?+</code> will be normalized to <code>robots?</code> and will match <code>I love robots</code>: the indexed token <code>robots</code> matches.</p>
</li>
<li>
<p>the regexp <code>[Rr]obots?+</code> will be normalized to <code>[rr]obots?</code> and will match <code>I love Robots</code>: the indexed token <code>robots</code> matches.</p>
</li>
<li>
<p>the regexp <code>love .* robots?</code> will match <code>I love my Robot</code> as well as <code>I love robots</code>, but not <code>Robots love me</code>.</p>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>As a result of Elasticsearch normalizing regular expressions,
normalizers can interfere with regexp meta-characters and completely change the meaning of a regexp.</p>
</div>
<div class="paragraph">
<p>For example, for a field whose normalizer replaces the characters <code>*</code> and <code>?</code> with <code>_</code>,
the regexp <code>Robots?</code> will be normalized to <code>Robots_</code> and will probably never match anything.</p>
</div>
<div class="paragraph">
<p>This behavior is considered a bug and
<a href="https://github.com/elastic/elasticsearch/issues/80189">was reported to the Elasticsearch project</a>.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
<div class="sect4">
<h5 id="search-dsl-predicate-regexp-flags"><a class="anchor" href="#search-dsl-predicate-regexp-flags"></a><code>flags</code>: enabling only specific syntax constructs</h5>
<div class="paragraph">
<p>By default, Hibernate Search does not enable any optional operators.
To enable some of them, it is possible to specify the <code>flags</code> attribute.</p>
</div>
<div class="exampleblock">
<div class="title">Example 216. Matching a regular expression pattern with flags</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .where( f -&gt; f.regexp().field( <span class="string"><span class="delimiter">&quot;</span><span class="content">description</span><span class="delimiter">&quot;</span></span> )
                .matching( <span class="string"><span class="delimiter">&quot;</span><span class="content">r@t</span><span class="delimiter">&quot;</span></span> )
                .flags( RegexpQueryFlag.ANY_STRING )
        )
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The following flags/operators are available:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>INTERVAL</code>: the <code>&lt;&gt;</code> operator matches a non-negative integer range, both ends included.</p>
<div class="paragraph">
<p>For example <code>a&lt;1-10&gt;</code> matches <code>a1</code>, <code>a2</code>, &#8230;&#8203; <code>a9</code>, <code>a10</code>, but not <code>a11</code>.</p>
</div>
<div class="paragraph">
<p>Leading zeroes are meaningful, e.g. <code>a&lt;01-10&gt;</code> matches <code>a01</code> and <code>a02</code> but not <code>a1</code> nor <code>a2</code>.</p>
</div>
</li>
<li>
<p><code>INTERSECTION</code>: the <code>&amp;</code> operator combines two regexps with an AND operator.</p>
<div class="paragraph">
<p>For example <code>.*a.*&amp;.*z.*</code> matches <code>az</code>, <code>za</code>, <code>babzb</code>, <code>bzbab</code>, but not <code>a</code> nor <code>z</code>.</p>
</div>
</li>
<li>
<p><code>ANYSTRING</code>: the <code>@</code> operator matches any string; equivalent to <code>.*</code>.</p>
<div class="paragraph">
<p>This operator is mostly useful to negate a pattern, e.g. <code>@&amp;~(ab)</code> matches anything except the string <code>ab</code>.</p>
</div>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="search-dsl-predicate-regexp-multiple-fields"><a class="anchor" href="#search-dsl-predicate-regexp-multiple-fields"></a>Targeting multiple fields</h5>
<div class="paragraph">
<p>Optionally, the predicate can target multiple fields.
In that case, the predicate will match documents for which <em>any</em> of the given fields matches.</p>
</div>
<div class="paragraph">
<p>See <a href="#search-dsl-predicate-common-multiple-fields">Targeting multiple fields in one predicate</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="search-dsl-predicate-regexp-other"><a class="anchor" href="#search-dsl-predicate-regexp-other"></a>Other options</h5>
<div class="ulist">
<ul>
<li>
<p>The score of a <code>regexp</code> predicate is constant and equal to 1 by default,
but can be <a href="#search-dsl-predicate-common-boost">boosted</a>,
either on a per-field basis with a call to <code>.boost(&#8230;&#8203;)</code> just after <code>.field(&#8230;&#8203;)</code>/<code>.fields(&#8230;&#8203;)</code>
or for the whole predicate with a call to <code>.boost(&#8230;&#8203;)</code> after <code>.matching(&#8230;&#8203;)</code>.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="search-dsl-predicate-terms"><a class="anchor" href="#search-dsl-predicate-terms"></a>15.2.11. <code>terms</code>: match a set of terms</h4>
<div class="paragraph">
<p>The <code>terms</code> predicate matches documents for which a given field contains some terms, any or all of them.</p>
</div>
<div class="paragraph">
<p>With <code>matchingAny</code> we require that at least one of the provided terms matches.
Functionally, this is somewhat similar to a <a href="#search-dsl-predicate-boolean-or">boolean <code>OR</code></a> with one <a href="#search-dsl-predicate-match"><code>match</code></a> predicate per term, but the syntax for a single <code>terms</code> predicate is more concise.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<code>matchingAny</code> expects to be passed <strong>terms</strong>, not just any string. The given terms will not be analyzed. See <a href="#search-dsl-predicate-terms-analysis"><code>terms</code> predicates and analysis</a>.
</td>
</tr>
</table>
</div>
<div class="exampleblock">
<div class="title">Example 217. Matching any of the provided terms</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .where( f -&gt; f.terms().field( <span class="string"><span class="delimiter">&quot;</span><span class="content">genre</span><span class="delimiter">&quot;</span></span> )
                .matchingAny( Genre.CRIME_FICTION, Genre.SCIENCE_FICTION ) )
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>With <code>matchingAll</code> we require that all the provided terms match.
Functionally, this is somewhat similar to a <a href="#search-dsl-predicate-boolean-and">boolean <code>AND</code></a> with one <a href="#search-dsl-predicate-match"><code>match</code></a> predicate per term, but the syntax for a single <code>terms</code> predicate is more concise.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<code>matchingAll</code> expects to be passed <strong>terms</strong>, not just any string. The given terms will not be analyzed. See <a href="#search-dsl-predicate-terms-analysis"><code>terms</code> predicates and analysis</a>.
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>By default, <code>matchingAll</code> will not accept more than 1024 terms.</p>
</div>
<div class="paragraph">
<p>It is possible to raise this limit through backend-specific configuration:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>For the Lucene backend, run this code when starting up your application: <code>org.apache.lucene.search.BooleanQuery.maxClauseCount = &lt;your limit&gt;;</code></p>
</li>
<li>
<p>For the Elasticsearch backend, see <a href="https://www.elastic.co/guide/en/elasticsearch/reference/8.13/search-settings.html">the global setting <code>indices.query.bool.max_clause_count</code> in the Elasticsearch documentation</a>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>However, keep in mind the limit is there for a reason: attempts to match very large numbers of terms will perform poorly and could lead to crashes.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="exampleblock">
<div class="title">Example 218. Matching all the provided terms</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .where( f -&gt; f.terms().field( <span class="string"><span class="delimiter">&quot;</span><span class="content">genre</span><span class="delimiter">&quot;</span></span> )
                .matchingAny( Genre.CRIME_FICTION, Genre.SCIENCE_FICTION ) )
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="search-dsl-predicate-terms-analysis"><a class="anchor" href="#search-dsl-predicate-terms-analysis"></a><code>terms</code> predicates and analysis</h5>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
For an introduction to analysis and how to configure it,
refer to the <a href="#concepts-analysis"> Analysis</a> section.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Differently from other predicates, the terms passed to <code>matchingAny()</code> or <code>matchingAll()</code>
are never analyzed nor <strong>usually</strong> normalized.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If an analyzer has been defined on the field, the terms will not be analyzed nor normalized.</p>
</div>
<div class="paragraph">
<p>If a normalizer has been defined on the field:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>when using the Elasticsearch backend, the terms <strong>will</strong> be normalized.</p>
</li>
<li>
<p>when using the Lucene backend, the terms <strong>will not</strong> be normalized.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For example, the term <code>Cat</code> could match <code>cat</code>
when targeting a field having a normalizer that applies a lowercase filter when indexing,
but only when using the Elasticsearch backend.
When using the Lucene backend, only the term <code>cat</code> could match <code>cat</code>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="search-dsl-predicate-terms-argument-type"><a class="anchor" href="#search-dsl-predicate-terms-argument-type"></a><a id="_expected_type_of_arguments"></a> Expected type of arguments</h5>
<div class="paragraph">
<p>By default, the <code>terms</code> predicate expects arguments to the <code>matchingAny(&#8230;&#8203;)</code> or <code>matchingAll(&#8230;&#8203;)</code> methods
to have the same type as the entity property corresponding to the target field.</p>
</div>
<div class="paragraph">
<p>For example, if an entity property is of an enum type,
<a href="#mapping-directfieldmapping-supported-types">the corresponding field may be of type <code>String</code></a>.
<code>.matchingAny(&#8230;&#8203;)</code> will expect its argument to have the enum type regardless.</p>
</div>
<div class="paragraph">
<p>This should generally be what you want,
but if you ever need to bypass conversion and pass an unconverted argument
(of type <code>String</code> in the example above)
to <code>.matchingAny(&#8230;&#8203;)</code> or <code>.matchingAll(&#8230;&#8203;)</code>, see <a href="#search-dsl-argument-type">Type of arguments passed to the DSL</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="search-dsl-predicate-terms-multiple-fields"><a class="anchor" href="#search-dsl-predicate-terms-multiple-fields"></a>Targeting multiple fields</h5>
<div class="paragraph">
<p>Optionally, the predicate can target multiple fields.
In that case, the predicate will match documents for which <em>any</em> of the given fields matches.</p>
</div>
<div class="paragraph">
<p>See <a href="#search-dsl-predicate-common-multiple-fields">Targeting multiple fields in one predicate</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="search-dsl-predicate-terms-other"><a class="anchor" href="#search-dsl-predicate-terms-other"></a>Other options</h5>
<div class="ulist">
<ul>
<li>
<p>The score of a <code>terms</code> predicate is constant and equal to 1 by default,
but can be <a href="#search-dsl-predicate-common-boost">boosted</a>,
either on a per-field basis with a call to <code>.boost(&#8230;&#8203;)</code> just after <code>.field(&#8230;&#8203;)</code>/<code>.fields(&#8230;&#8203;)</code>
or for the whole predicate with a call to <code>.boost(&#8230;&#8203;)</code> after <code>.matchingAny(&#8230;&#8203;)</code> or <code>.matchingAll(&#8230;&#8203;)</code>.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="search-dsl-predicate-and"><a class="anchor" href="#search-dsl-predicate-and"></a>15.2.12. <code>and</code>: match all clauses</h4>
<div class="paragraph">
<p>The <code>and</code> predicate matches documents that match <strong>all</strong> of its inner predicates, called "clauses".</p>
</div>
<div class="paragraph">
<p>Matching "and" clauses are taken into account during <a href="#search-dsl-predicate-common-score">score</a> computation.</p>
</div>
<div class="exampleblock">
<div class="title">Example 219. Matching a document that matches all the multiple given predicates (~<code>AND</code> operator)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .where( f -&gt; f.and(
                f.match().field( <span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span> )
                        .matching( <span class="string"><span class="delimiter">&quot;</span><span class="content">robot</span><span class="delimiter">&quot;</span></span> ), <i class="conum" data-value="1"></i><b>(1)</b>
                f.match().field( <span class="string"><span class="delimiter">&quot;</span><span class="content">description</span><span class="delimiter">&quot;</span></span> )
                        .matching( <span class="string"><span class="delimiter">&quot;</span><span class="content">crime</span><span class="delimiter">&quot;</span></span> ) <i class="conum" data-value="2"></i><b>(2)</b>
        ) )
        .fetchHits( <span class="integer">20</span> ); <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The hits <strong>must</strong> have a <code>title</code> field matching the text <code>robot</code>,
independently of other clauses in the same boolean predicate.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The hits <strong>must</strong> have a <code>description</code> field matching the text <code>crime</code>,
independently of other clauses in the same boolean predicate.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>All returned hits will match <strong>all</strong> the clauses above:
they will have a <code>title</code> field matching the text <code>robot</code>
<strong>and</strong> they will have a <code>description</code> field matching the text <code>crime</code>.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect4">
<h5 id="search-dsl-predicate-and-lambda"><a class="anchor" href="#search-dsl-predicate-and-lambda"></a>Adding clauses dynamically with the lambda syntax</h5>
<div class="paragraph">
<p>It is possible to define the <code>and</code> predicate inside a lambda expression.
This is especially useful when clauses need to be added dynamically to the <code>and</code> predicate,
for example based on user input.</p>
</div>
<div class="exampleblock">
<div class="title">Example 220. Easily adding clauses dynamically using <code>.where(&#8230;&#8203;)</code> and the lambda syntax</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">MySearchParameters searchParameters = getSearchParameters(); <i class="conum" data-value="1"></i><b>(1)</b>
<span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .where( (f, root) -&gt; { <i class="conum" data-value="2"></i><b>(2)</b>
            root.add( f.matchAll() ); <i class="conum" data-value="3"></i><b>(3)</b>
            <span class="keyword">if</span> ( searchParameters.getGenreFilter() != <span class="predefined-constant">null</span> ) { <i class="conum" data-value="4"></i><b>(4)</b>
                root.add( f.match().field( <span class="string"><span class="delimiter">&quot;</span><span class="content">genre</span><span class="delimiter">&quot;</span></span> )
                        .matching( searchParameters.getGenreFilter() ) );
            }
            <span class="keyword">if</span> ( searchParameters.getFullTextFilter() != <span class="predefined-constant">null</span> ) {
                root.add( f.match().fields( <span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">description</span><span class="delimiter">&quot;</span></span> )
                        .matching( searchParameters.getFullTextFilter() ) );
            }
            <span class="keyword">if</span> ( searchParameters.getPageCountMaxFilter() != <span class="predefined-constant">null</span> ) {
                root.add( f.range().field( <span class="string"><span class="delimiter">&quot;</span><span class="content">pageCount</span><span class="delimiter">&quot;</span></span> )
                        .atMost( searchParameters.getPageCountMaxFilter() ) );
            }
        } )
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Get a custom object holding the search parameters provided by the user through a web form, for example.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Call <code>.where(BiConsumer)</code>.
The consumer, implemented by a lambda expression, will receive a predicate factory as well as clause collector as an argument,
and will add clauses to that collector as necessary.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>By default, a boolean predicate will match nothing if there is no clause.
To match every document when there is no clause, add a <code>and</code> clause that matches everything.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Inside the lambda, the code is free to use any Java language constructs, such as <code>if</code> or <code>for</code>,
to control the addition of clauses.
In this case, we only add clauses if the relevant parameter was filled in by the user.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>Another syntax relying on the method <code>with(&#8230;&#8203;)</code> can be useful when the <code>and</code> predicate is not the root predicate:</p>
</div>
<div class="exampleblock">
<div class="title">Example 221. Easily adding clauses dynamically using <code>with(&#8230;&#8203;)</code> and the lambda syntax</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">MySearchParameters searchParameters = getSearchParameters(); <i class="conum" data-value="1"></i><b>(1)</b>
<span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .where( f -&gt; f.and().with( and -&gt; { <i class="conum" data-value="2"></i><b>(2)</b>
            and.add( f.matchAll() ); <i class="conum" data-value="3"></i><b>(3)</b>
            <span class="keyword">if</span> ( searchParameters.getGenreFilter() != <span class="predefined-constant">null</span> ) { <i class="conum" data-value="4"></i><b>(4)</b>
                and.add( f.match().field( <span class="string"><span class="delimiter">&quot;</span><span class="content">genre</span><span class="delimiter">&quot;</span></span> )
                        .matching( searchParameters.getGenreFilter() ) );
            }
            <span class="keyword">if</span> ( searchParameters.getFullTextFilter() != <span class="predefined-constant">null</span> ) {
                and.add( f.match().fields( <span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">description</span><span class="delimiter">&quot;</span></span> )
                        .matching( searchParameters.getFullTextFilter() ) );
            }
            <span class="keyword">if</span> ( searchParameters.getPageCountMaxFilter() != <span class="predefined-constant">null</span> ) {
                and.add( f.range().field( <span class="string"><span class="delimiter">&quot;</span><span class="content">pageCount</span><span class="delimiter">&quot;</span></span> )
                        .atMost( searchParameters.getPageCountMaxFilter() ) );
            }
        } ) )
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Get a custom object holding the search parameters provided by the user through a web form, for example.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Call <code>.where(Function)</code>.
The function, implemented by a lambda expression, will receive a predicate factory, use it to build an <code>and</code> predicate,
invoke the <code>with(Consumer)</code> method and return this predicate. The consumer, implemented by a lambda expression,
will receive a clause collector for the <code>and</code> predicate as an argument, and will add clauses to that collector as necessary.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>By default, a boolean predicate will match nothing if there is no clause.
To match every document when there is no clause, add an <code>and</code> clause that matches everything.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Inside the lambda, the code is free to use any Java language constructs, such as <code>if</code> or <code>for</code>,
to control the addition of clauses.
In this case, we only add clauses if the relevant parameter was filled in by the user.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="search-dsl-predicate-and-other"><a class="anchor" href="#search-dsl-predicate-and-other"></a>Options</h5>
<div class="ulist">
<ul>
<li>
<p>The score of an <code>and</code> predicate is variable by default,
but can be <a href="#search-dsl-predicate-common-constantScore">made constant with <code>.constantScore()</code></a>.</p>
</li>
<li>
<p>The score of an <code>and</code> predicate can be <a href="#search-dsl-predicate-common-boost">boosted</a>
with a call to <code>.boost(&#8230;&#8203;)</code>.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="search-dsl-predicate-or"><a class="anchor" href="#search-dsl-predicate-or"></a>15.2.13. <code>or</code>: match any clause</h4>
<div class="paragraph">
<p>The <code>or</code> predicate matches documents that match <strong>any</strong> of its inner predicates, called "clauses".</p>
</div>
<div class="paragraph">
<p>Matching <code>or</code> clauses are taken into account during <a href="#search-dsl-predicate-common-score">score</a> computation.</p>
</div>
<div class="exampleblock">
<div class="title">Example 222. Matching a document that matches any of multiple given predicates (~<code>OR</code> operator)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .where( f -&gt; f.or(
                f.match().field( <span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span> )
                        .matching( <span class="string"><span class="delimiter">&quot;</span><span class="content">robot</span><span class="delimiter">&quot;</span></span> ), <i class="conum" data-value="1"></i><b>(1)</b>
                f.match().field( <span class="string"><span class="delimiter">&quot;</span><span class="content">description</span><span class="delimiter">&quot;</span></span> )
                        .matching( <span class="string"><span class="delimiter">&quot;</span><span class="content">investigation</span><span class="delimiter">&quot;</span></span> ) <i class="conum" data-value="2"></i><b>(2)</b>
        ) )
        .fetchHits( <span class="integer">20</span> ); <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The hits <strong>should</strong> have a <code>title</code> field matching the text <code>robot</code>,
<strong>or</strong> they should match any other clause in the same boolean predicate.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The hits <strong>should</strong> have a <code>description</code> field matching the text <code>investigation</code>,
<strong>or</strong> they should match any other clause in the same boolean predicate.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>All returned hits will match <strong>at least one</strong> of the clauses above:
they will have a <code>title</code> field matching the text <code>robot</code>
<strong>or</strong> they will have a <code>description</code> field matching the text <code>investigation</code>.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect4">
<h5 id="search-dsl-predicate-or-lambda"><a class="anchor" href="#search-dsl-predicate-or-lambda"></a>Adding clauses dynamically with the lambda syntax</h5>
<div class="paragraph">
<p>It is possible to define the <code>or</code> predicate inside a lambda expression.
This is especially useful when clauses need to be added dynamically to the <code>or</code> predicate,
for example based on user input.</p>
</div>
<div class="exampleblock">
<div class="title">Example 223. Easily adding clauses dynamically using <code>with(&#8230;&#8203;)</code> and the lambda syntax</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">MySearchParameters searchParameters = getSearchParameters(); <i class="conum" data-value="1"></i><b>(1)</b>
<span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .where( f -&gt; f.or().with( or -&gt; { <i class="conum" data-value="2"></i><b>(2)</b>
            <span class="keyword">if</span> ( !searchParameters.getAuthorFilters().isEmpty() ) {
                <span class="keyword">for</span> ( <span class="predefined-type">String</span> authorFilter : searchParameters.getAuthorFilters() ) { <i class="conum" data-value="3"></i><b>(3)</b>
                    or.add( f.match().fields( <span class="string"><span class="delimiter">&quot;</span><span class="content">authors.firstName</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">authors.lastName</span><span class="delimiter">&quot;</span></span> )
                            .matching( authorFilter ) );
                }
            }
        } ) )
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Get a custom object holding the search parameters provided by the user through a web form, for example.0</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Call <code>.where(Function)</code>.
The function, implemented by a lambda expression, will receive a predicate factory, use it to build an <code>or</code> predicate,
invoke the <code>with(Consumer)</code> method and return this predicate. The consumer, implemented by a lambda expression,
will receive a clause collector for the <code>or</code> predicate as an argument, and will add clauses to that collector as necessary.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Inside the lambda, the code is free to use any Java language constructs, such as <code>if</code> or <code>for</code>,
to control the addition of clauses.
In this case, we only add clauses if the relevant parameter was filled in by the user.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="search-dsl-predicate-or-other"><a class="anchor" href="#search-dsl-predicate-or-other"></a>Options</h5>
<div class="ulist">
<ul>
<li>
<p>The score of an <code>or</code> predicate is variable by default,
but can be <a href="#search-dsl-predicate-common-constantScore">made constant with <code>.constantScore()</code></a>.</p>
</li>
<li>
<p>The score of an <code>or</code> predicate can be <a href="#search-dsl-predicate-common-boost">boosted</a>
with a call to <code>.boost(&#8230;&#8203;)</code>.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="search-dsl-predicate-not"><a class="anchor" href="#search-dsl-predicate-not"></a>15.2.14. <code>not</code>: negating another predicate</h4>
<div class="paragraph">
<p>The <code>not</code> predicate matches documents that are not matched by a given predicate.</p>
</div>
<div class="exampleblock">
<div class="title">Example 224. Negating a <code>match</code> predicate</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .where( f -&gt; f.not(
                f.match()
                        .field( <span class="string"><span class="delimiter">&quot;</span><span class="content">genre</span><span class="delimiter">&quot;</span></span> )
                        .matching( Genre.SCIENCE_FICTION )
        ) )
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="search-dsl-predicate-not-other"><a class="anchor" href="#search-dsl-predicate-not-other"></a>Other options</h5>
<div class="ulist">
<ul>
<li>
<p>The score of a <code>not</code> predicate is constant and equal to 0 by default,
but if <a href="#search-dsl-predicate-common-boost">boosted with <code>.boost(&#8230;&#8203;)</code></a> the default would be changed to 1
and corresponding boost will be applied.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="search-dsl-predicate-boolean"><a class="anchor" href="#search-dsl-predicate-boolean"></a>15.2.15. <a id="_combining_queries"></a> <code>bool</code>: advanced combinations of predicates (or/and/&#8230;&#8203;)</h4>
<div class="paragraph">
<p>The <code>bool</code> predicate allows combining inner predicates in a more complex fashion than with simpler
<a href="#search-dsl-predicate-and"><code>and</code></a>/<a href="#search-dsl-predicate-or"><code>or</code></a> predicates.</p>
</div>
<div class="paragraph">
<p>The <code>bool</code> predicate matches documents that match one or more inner predicates, called "clauses".
It can be used in particular to build <code>AND</code>/<code>OR</code> operators with additional settings.</p>
</div>
<div class="paragraph">
<p>Inner predicates are added as clauses of one of the following types:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><a id="search-dsl-predicate-boolean-clauses-must"></a><code>must</code></dt>
<dd>
<p><code>must</code> clauses are required to match: if they don&#8217;t match, then the <code>bool</code> predicate will not match.</p>
<div class="paragraph">
<p>Matching "must" clauses are taken into account during <a href="#search-dsl-predicate-common-score">score</a> computation.</p>
</div>
</dd>
<dt class="hdlist1"><a id="search-dsl-predicate-boolean-clauses-mustNot"></a><code>mustNot</code></dt>
<dd>
<p><code>mustNot</code> clauses are required to not match: if they match, then the <code>bool</code> predicate will not match.</p>
<div class="paragraph">
<p>"must not" clauses are ignored during <a href="#search-dsl-predicate-common-score">score</a> computation.</p>
</div>
</dd>
<dt class="hdlist1"><a id="search-dsl-predicate-boolean-clauses-filter"></a><code>filter</code></dt>
<dd>
<p><code>filter</code> clauses are required to match: if they don&#8217;t match, then the boolean predicate will not match.</p>
<div class="paragraph">
<p><code>filter</code> clauses are ignored during <a href="#search-dsl-predicate-common-score">score</a> computation,
and so are any clauses of boolean predicates contained in the filter clause (even <code>must</code> or <code>should</code> clauses).</p>
</div>
</dd>
<dt class="hdlist1"><a id="search-dsl-predicate-boolean-clauses-should"></a><code>should</code></dt>
<dd>
<p><code>should</code> clauses may optionally match, and are required to match depending on the context.</p>
<div class="paragraph">
<p>Matching <code>should</code> clauses are taken into account during <a href="#search-dsl-predicate-common-score">score</a> computation.</p>
</div>
<div class="paragraph">
<p>The exact behavior of <code>should</code> clauses is as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>When there isn&#8217;t any <code>must</code> clause nor any <code>filter</code> clause in the <code>bool</code> predicate
then at least one "should" clause is required to match.
Simply put, in this case, the "should" clauses
behave as if there was an <code>OR</code> operator between each of them.</p>
</li>
<li>
<p>When there is at least one <code>must</code> clause or one <code>filter</code> clause in the <code>bool</code> predicate,
then the "should" clauses are not required to match,
and are simply used for scoring.</p>
</li>
<li>
<p>This behavior can be changed by specifying
<a href="#search-dsl-predicate-boolean-minimumshouldmatch"><code>minimumShouldMatch</code> constraints</a>.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="sect4">
<h5 id="search-dsl-predicate-boolean-or"><a class="anchor" href="#search-dsl-predicate-boolean-or"></a>Emulating an <code>OR</code> operator</h5>
<div class="paragraph">
<p>A <code>bool</code> predicate with only <code>should</code> clauses and no <a href="#search-dsl-predicate-boolean-minimumshouldmatch"><code>minimumShouldMatch</code> specification</a> will behave as an <code>OR</code> operator.
In such case, using the simpler <a href="#search-dsl-predicate-or"><code>or</code></a> syntax is recommended.</p>
</div>
</div>
<div class="sect4">
<h5 id="search-dsl-predicate-boolean-and"><a class="anchor" href="#search-dsl-predicate-boolean-and"></a>Emulating an <code>AND</code> operator</h5>
<div class="paragraph">
<p>A <code>bool</code> predicate with only <code>must</code> clauses will behave as an <code>AND</code> operator.
In such case, using the simpler <a href="#search-dsl-predicate-and"><code>and</code></a> syntax is recommended.</p>
</div>
</div>
<div class="sect4">
<h5 id="search-dsl-predicate-boolean-mustNot"><a class="anchor" href="#search-dsl-predicate-boolean-mustNot"></a><code>mustNot</code>: excluding documents that match a given predicate</h5>
<div class="exampleblock">
<div class="title">Example 225. Matching a document that does <strong>not</strong> match a given predicate</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .where( f -&gt; f.bool()
                .must( f.match().field( <span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span> )
                        .matching( <span class="string"><span class="delimiter">&quot;</span><span class="content">robot</span><span class="delimiter">&quot;</span></span> ) ) <i class="conum" data-value="1"></i><b>(1)</b>
                .mustNot( f.match().field( <span class="string"><span class="delimiter">&quot;</span><span class="content">description</span><span class="delimiter">&quot;</span></span> )
                        .matching( <span class="string"><span class="delimiter">&quot;</span><span class="content">investigation</span><span class="delimiter">&quot;</span></span> ) ) <i class="conum" data-value="2"></i><b>(2)</b>
        )
        .fetchHits( <span class="integer">20</span> ); <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The hits <strong>must</strong> have a <code>title</code> field matching the text <code>robot</code>,
independently of other clauses in the same boolean predicate.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The hits <strong>must not</strong> have a <code>description</code> field matching the text <code>investigation</code>,
independently of other clauses in the same boolean predicate.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>All returned hits will match <strong>all</strong> the clauses above:
they will have a <code>title</code> field matching the text <code>robot</code>
<strong>and</strong> they will not have a <code>description</code> field matching the text <code>investigation</code>.</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>While it is possible to execute a boolean predicate with only "negative" clauses (<code>mustNot</code>),
performance may be disappointing because the full power of indexes cannot be leveraged in that case.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="search-dsl-predicate-boolean-filter"><a class="anchor" href="#search-dsl-predicate-boolean-filter"></a><code>filter</code>: matching documents that match a given predicate without affecting the score</h5>
<div class="paragraph">
<p><code>filter</code> clauses are essentially <code>must</code> clauses with only one difference:
they are ignored when computing the total <a href="#search-dsl-predicate-common-score">score</a> of a document.</p>
</div>
<div class="exampleblock">
<div class="title">Example 226. Matching a document that matches a given predicate without affecting the score</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .where( f -&gt; f.bool() <i class="conum" data-value="1"></i><b>(1)</b>
                .should( f.bool() <i class="conum" data-value="2"></i><b>(2)</b>
                        .filter( f.match().field( <span class="string"><span class="delimiter">&quot;</span><span class="content">genre</span><span class="delimiter">&quot;</span></span> )
                                .matching( Genre.SCIENCE_FICTION ) ) <i class="conum" data-value="3"></i><b>(3)</b>
                        .must( f.match().fields( <span class="string"><span class="delimiter">&quot;</span><span class="content">description</span><span class="delimiter">&quot;</span></span> )
                                .matching( <span class="string"><span class="delimiter">&quot;</span><span class="content">crime</span><span class="delimiter">&quot;</span></span> ) ) <i class="conum" data-value="4"></i><b>(4)</b>
                )
                .should( f.bool() <i class="conum" data-value="5"></i><b>(5)</b>
                        .filter( f.match().field( <span class="string"><span class="delimiter">&quot;</span><span class="content">genre</span><span class="delimiter">&quot;</span></span> )
                                .matching( Genre.CRIME_FICTION ) ) <i class="conum" data-value="6"></i><b>(6)</b>
                        .must( f.match().fields( <span class="string"><span class="delimiter">&quot;</span><span class="content">description</span><span class="delimiter">&quot;</span></span> )
                                .matching( <span class="string"><span class="delimiter">&quot;</span><span class="content">robot</span><span class="delimiter">&quot;</span></span> ) ) <i class="conum" data-value="7"></i><b>(7)</b>
                )
        )
        .fetchHits( <span class="integer">20</span> ); <i class="conum" data-value="8"></i><b>(8)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Create a top-level boolean predicate, with two <code>should</code> clauses.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>In the first <code>should</code> clause, create a nested boolean predicate.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Use a <code>filter</code> clause to require documents to have the <code>science-fiction</code> genre,
without taking this predicate into account when scoring.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Use a <code>must</code> clause to require documents with the <code>science-fiction</code> genre
to have a <code>title</code> field matching <code>crime</code>,
and take this predicate into account when scoring.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>In the second <code>should</code> clause, create a nested boolean predicate.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Use a <code>filter</code> clause to require documents to have the <code>crime fiction</code> genre,
without taking this predicate into account when scoring.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Use a <code>must</code> clause to require documents with the <code>crime fiction</code> genre
to have a <code>description</code> field matching <code>robot</code>,
and take this predicate into account when scoring.</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>The score of hits will ignore the <code>filter</code> clauses,
leading to fairer sorts if there are much more "crime fiction" documents than "science-fiction" documents.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="search-dsl-predicate-boolean-should-scoring"><a class="anchor" href="#search-dsl-predicate-boolean-should-scoring"></a><code>should</code> as a way to tune scoring</h5>
<div class="paragraph">
<p>Apart from being <a href="#search-dsl-predicate-boolean-or">used alone to emulate an <code>OR</code> operator</a>,
<code>should</code> clauses can also be used in conjunction with <code>must</code> clauses.
When doing so, the <code>should</code> clauses become completely optional,
and their only purpose is to increase the score of documents that match these clauses.</p>
</div>
<div class="exampleblock">
<div class="title">Example 227. Using optional <code>should</code> clauses to boost the score of some documents</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .where( f -&gt; f.bool()
                .must( f.match().field( <span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span> )
                        .matching( <span class="string"><span class="delimiter">&quot;</span><span class="content">robot</span><span class="delimiter">&quot;</span></span> ) ) <i class="conum" data-value="1"></i><b>(1)</b>
                .should( f.match().field( <span class="string"><span class="delimiter">&quot;</span><span class="content">description</span><span class="delimiter">&quot;</span></span> )
                        .matching( <span class="string"><span class="delimiter">&quot;</span><span class="content">crime</span><span class="delimiter">&quot;</span></span> ) ) <i class="conum" data-value="2"></i><b>(2)</b>
                .should( f.match().field( <span class="string"><span class="delimiter">&quot;</span><span class="content">description</span><span class="delimiter">&quot;</span></span> )
                        .matching( <span class="string"><span class="delimiter">&quot;</span><span class="content">investigation</span><span class="delimiter">&quot;</span></span> ) ) <i class="conum" data-value="3"></i><b>(3)</b>
        )
        .fetchHits( <span class="integer">20</span> ); <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The hits <strong>must</strong> have a <code>title</code> field matching the text <code>robot</code>,
independently of other clauses in the same boolean predicate.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The hits <strong>should</strong> have a <code>description</code> field matching the text <code>crime</code>,
but they might not, because matching the <code>must</code> clause above is enough.
However, matching this <code>should</code> clause will improve the score of the document.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The hits <strong>should</strong> have a <code>description</code> field matching the text <code>investigation</code>,
but they might not, because matching the <code>must</code> clause above is enough.
However, matching this <code>should</code> clause will improve the score of the document.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>All returned hits will match the <code>must</code> clause, and optionally the <code>should</code> clauses:
they will have a <code>title</code> field matching the text <code>robot</code>,
and the ones whose description matches either <code>crime</code> or <code>investigation</code> will have a better score.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="search-dsl-predicate-boolean-minimumshouldmatch"><a class="anchor" href="#search-dsl-predicate-boolean-minimumshouldmatch"></a><code>minimumShouldMatch</code>: fine-tuning how many <code>should</code> clauses are required to match</h5>
<div class="paragraph">
<p>It is possible to require that an arbitrary number of <code>should</code> clauses match
in order for the <code>bool</code> predicate to match.
This is the purpose of the <code>minimumShouldMatch*</code> methods,
as demonstrated below.</p>
</div>
<div class="exampleblock">
<div class="title">Example 228. Fine-tuning <code>should</code> clauses matching requirements with <code>minimumShouldMatch</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .where( f -&gt; f.bool()
                .minimumShouldMatchNumber( <span class="integer">2</span> ) <i class="conum" data-value="1"></i><b>(1)</b>
                .should( f.match().field( <span class="string"><span class="delimiter">&quot;</span><span class="content">description</span><span class="delimiter">&quot;</span></span> )
                        .matching( <span class="string"><span class="delimiter">&quot;</span><span class="content">robot</span><span class="delimiter">&quot;</span></span> ) ) <i class="conum" data-value="2"></i><b>(2)</b>
                .should( f.match().field( <span class="string"><span class="delimiter">&quot;</span><span class="content">description</span><span class="delimiter">&quot;</span></span> )
                        .matching( <span class="string"><span class="delimiter">&quot;</span><span class="content">investigation</span><span class="delimiter">&quot;</span></span> ) ) <i class="conum" data-value="3"></i><b>(3)</b>
                .should( f.match().field( <span class="string"><span class="delimiter">&quot;</span><span class="content">description</span><span class="delimiter">&quot;</span></span> )
                        .matching( <span class="string"><span class="delimiter">&quot;</span><span class="content">disappearance</span><span class="delimiter">&quot;</span></span> ) ) <i class="conum" data-value="4"></i><b>(4)</b>
        )
        .fetchHits( <span class="integer">20</span> ); <i class="conum" data-value="5"></i><b>(5)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>At least two "should" clauses must match for this boolean predicate to match.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The hits <strong>should</strong> have a <code>description</code> field matching the text <code>robot</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The hits <strong>should</strong> have a <code>description</code> field matching the text <code>investigate</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The hits <strong>should</strong> have a <code>description</code> field matching the text <code>crime</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>All returned hits will match at least two of the <code>should</code> clauses:
their description will match either <code>robot</code> and <code>investigate</code>,
<code>robot</code> and <code>crime</code>, <code>investigate</code> and <code>crime</code>, or all three of these terms.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="search-dsl-predicate-boolean-lambda"><a class="anchor" href="#search-dsl-predicate-boolean-lambda"></a>Adding clauses dynamically with the lambda syntax</h5>
<div class="paragraph">
<p>It is possible to define the <code>bool</code> predicate inside a lambda expression.
This is especially useful when clauses need to be added dynamically to the <code>bool</code> predicate,
for example based on user input.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
If you simply want to build a root predicate matching multiple, dynamically generated clauses,
consider using the <a href="#search-dsl-predicate-and-lambda"><code>.where( (f, root) &#8594; &#8230;&#8203; )</code> syntax</a> instead.
</td>
</tr>
</table>
</div>
<div class="exampleblock">
<div class="title">Example 229. Easily adding clauses dynamically using <code>with(&#8230;&#8203;)</code> and the lambda syntax</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">MySearchParameters searchParameters = getSearchParameters(); <i class="conum" data-value="1"></i><b>(1)</b>
<span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .where( (f, root) -&gt; { <i class="conum" data-value="2"></i><b>(2)</b>
            root.add( f.matchAll() );
            <span class="keyword">if</span> ( searchParameters.getGenreFilter() != <span class="predefined-constant">null</span> ) {
                root.add( f.match().field( <span class="string"><span class="delimiter">&quot;</span><span class="content">genre</span><span class="delimiter">&quot;</span></span> )
                        .matching( searchParameters.getGenreFilter() ) );
            }
            <span class="keyword">if</span> ( !searchParameters.getAuthorFilters().isEmpty() ) {
                root.add( f.bool().with( b -&gt; { <i class="conum" data-value="3"></i><b>(3)</b>
                    <span class="keyword">for</span> ( <span class="predefined-type">String</span> authorFilter : searchParameters.getAuthorFilters() ) { <i class="conum" data-value="4"></i><b>(4)</b>
                        b.should( f.match().fields( <span class="string"><span class="delimiter">&quot;</span><span class="content">authors.firstName</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">authors.lastName</span><span class="delimiter">&quot;</span></span> )
                                .matching( authorFilter ) );
                    }
                } ) );
            }
        } )
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Get a custom object holding the search parameters provided by the user through a web form, for example.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Call <code>.where(BiConsumer)</code> to create the root predicate, which is not the one we&#8217;re interested in here.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Call <code>.bool().with(Consumer)</code> to create an inner, non-root predicate.
The consumer, implemented by a lambda expression, will receive a collector as an argument
and will add clauses to that collector as necessary.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Inside the lambda, the code is free to use any Java language constructs, such as <code>if</code> or <code>for</code>,
to control the addition of clauses.
In this case, we add one clause per author filter.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="search-dsl-predicate-boolean-deprecated-variants"><a class="anchor" href="#search-dsl-predicate-boolean-deprecated-variants"></a>Deprecated variants</h5>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Features detailed in this section are <em>deprecated</em>: they should be avoided in favor of non-deprecated alternatives.</p>
</div>
<div class="paragraph">
<p>The usual <a href="https://hibernate.org/community/compatibility-policy/">compatibility policy</a> applies,
meaning the features are expected to remain available at least until the next major version of Hibernate Search.
Beyond that, they may be altered in a backward-incompatible way&#8201;&#8212;&#8201;or even removed.</p>
</div>
<div class="paragraph">
<p>Usage of deprecated features is not recommended.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Another syntax can be used to <a href="#search-dsl-predicate-boolean-lambda">create a boolean predicate from a lambda expression</a>,
but it is deprecated.</p>
</div>
<div class="exampleblock">
<div class="title">Example 230. Deprecated variant of <code>.bool</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">MySearchParameters searchParameters = getSearchParameters(); <i class="conum" data-value="1"></i><b>(1)</b>
<span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .where( f -&gt; f.bool( b -&gt; { <i class="conum" data-value="2"></i><b>(2)</b>
            b.must( f.matchAll() ); <i class="conum" data-value="3"></i><b>(3)</b>
            <span class="keyword">if</span> ( searchParameters.getGenreFilter() != <span class="predefined-constant">null</span> ) { <i class="conum" data-value="4"></i><b>(4)</b>
                b.must( f.match().field( <span class="string"><span class="delimiter">&quot;</span><span class="content">genre</span><span class="delimiter">&quot;</span></span> )
                        .matching( searchParameters.getGenreFilter() ) );
            }
            <span class="keyword">if</span> ( searchParameters.getFullTextFilter() != <span class="predefined-constant">null</span> ) {
                b.must( f.match().fields( <span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">description</span><span class="delimiter">&quot;</span></span> )
                        .matching( searchParameters.getFullTextFilter() ) );
            }
            <span class="keyword">if</span> ( searchParameters.getPageCountMaxFilter() != <span class="predefined-constant">null</span> ) {
                b.must( f.range().field( <span class="string"><span class="delimiter">&quot;</span><span class="content">pageCount</span><span class="delimiter">&quot;</span></span> )
                        .atMost( searchParameters.getPageCountMaxFilter() ) );
            }
        } ) )
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Get a custom object holding the search parameters provided by the user through a web form, for example.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Call <code>.bool(Consumer)</code>.
The consumer, implemented by a lambda expression, will receive a collector as an argument
and will add clauses to that collector as necessary.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>By default, a boolean predicate will match nothing if there is no clause.
To match every document when there is no clause, add a <code>must</code> clause that matches everything.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Inside the lambda, the code is free to use any Java language constructs, such as <code>if</code> or <code>for</code>,
to control the addition of clauses.
In this case, we only add clauses if the relevant parameter was filled in by the user.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="search-dsl-predicate-boolean-other"><a class="anchor" href="#search-dsl-predicate-boolean-other"></a>Other options</h5>
<div class="ulist">
<ul>
<li>
<p>The score of a <code>bool</code> predicate is variable by default,
but can be <a href="#search-dsl-predicate-common-constantScore">made constant with <code>.constantScore()</code></a>.</p>
</li>
<li>
<p>The score of a <code>bool</code> predicate can be <a href="#search-dsl-predicate-common-boost">boosted</a>
with a call to <code>.boost(&#8230;&#8203;)</code>.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="search-dsl-predicate-simple-query-string"><a class="anchor" href="#search-dsl-predicate-simple-query-string"></a>15.2.16. <a id="_simple_query_string_queries"></a> <code>simpleQueryString</code>: match a user-provided query string</h4>
<div class="paragraph">
<p>The <code>simpleQueryString</code> predicate matches documents according to a structured query given as a string.</p>
</div>
<div class="paragraph">
<p>Its syntax is quite simple, so it&#8217;s especially helpful when end user expect to be able to submit text queries
with a few syntax elements such as boolean operators, quotes, etc.</p>
</div>
<div class="sect4">
<h5 id="search-dsl-predicate-simple-query-string-boolean-operators"><a class="anchor" href="#search-dsl-predicate-simple-query-string-boolean-operators"></a>Boolean operators</h5>
<div class="paragraph">
<p>The syntax includes three boolean operators:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>AND using <code>+</code></p>
</li>
<li>
<p>OR using <code>|</code></p>
</li>
<li>
<p>NOT using <code>-</code></p>
</li>
</ul>
</div>
<div class="exampleblock">
<div class="title">Example 231. Matching a simple query string: AND/OR operators</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .where( f -&gt; f.simpleQueryString().field( <span class="string"><span class="delimiter">&quot;</span><span class="content">description</span><span class="delimiter">&quot;</span></span> )
                .matching( <span class="string"><span class="delimiter">&quot;</span><span class="content">robots + (crime | investigation | disappearance)</span><span class="delimiter">&quot;</span></span> ) )
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 232. Matching a simple query string: NOT operator</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .where( f -&gt; f.simpleQueryString().field( <span class="string"><span class="delimiter">&quot;</span><span class="content">description</span><span class="delimiter">&quot;</span></span> )
                .matching( <span class="string"><span class="delimiter">&quot;</span><span class="content">robots + -investigation</span><span class="delimiter">&quot;</span></span> ) )
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="search-dsl-predicate-simple-query-string-boolean-operators-default"><a class="anchor" href="#search-dsl-predicate-simple-query-string-boolean-operators-default"></a>Default boolean operator</h5>
<div class="paragraph">
<p>By default, the query uses the OR operator if the operator is not explicitly defined.
If you prefer using the AND operator as default,
you can call <code>.defaultOperator(&#8230;&#8203;)</code>.</p>
</div>
<div class="exampleblock">
<div class="title">Example 233. Matching a simple query string: AND as default operator</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .where( f -&gt; f.simpleQueryString().field( <span class="string"><span class="delimiter">&quot;</span><span class="content">description</span><span class="delimiter">&quot;</span></span> )
                .matching( <span class="string"><span class="delimiter">&quot;</span><span class="content">robots investigation</span><span class="delimiter">&quot;</span></span> )
                .defaultOperator( BooleanOperator.AND ) )
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="search-dsl-predicate-simple-query-string-prefix"><a class="anchor" href="#search-dsl-predicate-simple-query-string-prefix"></a>Prefix</h5>
<div class="paragraph">
<p>The syntax includes support for prefix predicates through the <code>*</code> wildcard.</p>
</div>
<div class="exampleblock">
<div class="title">Example 234. Matching a simple query string: prefix</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .where( f -&gt; f.simpleQueryString().field( <span class="string"><span class="delimiter">&quot;</span><span class="content">description</span><span class="delimiter">&quot;</span></span> )
                .matching( <span class="string"><span class="delimiter">&quot;</span><span class="content">rob*</span><span class="delimiter">&quot;</span></span> ) )
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The <code>*</code> wildcard will only be understood at the end of a word.
<code>rob*t</code> will be interpreted as a literal.
This really is a <em>prefix</em> predicate, not a <a href="#search-dsl-predicate-wildcard"><em>wildcard</em> predicate</a>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="search-dsl-predicate-simple-query-string-fuzzy"><a class="anchor" href="#search-dsl-predicate-simple-query-string-fuzzy"></a>Fuzzy</h5>
<div class="paragraph">
<p>The syntax includes support for the fuzzy operator <code>~</code>.
Its behavior is similar to that of <a href="#search-dsl-predicate-match-fuzzy">fuzzy matching in the <code>match</code> predicate</a>.</p>
</div>
<div class="exampleblock">
<div class="title">Example 235. Matching a simple query string: fuzzy</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .where( f -&gt; f.simpleQueryString().field( <span class="string"><span class="delimiter">&quot;</span><span class="content">description</span><span class="delimiter">&quot;</span></span> )
                .matching( <span class="string"><span class="delimiter">&quot;</span><span class="content">robto~2</span><span class="delimiter">&quot;</span></span> ) )
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="search-dsl-predicate-simple-query-string-phrase"><a class="anchor" href="#search-dsl-predicate-simple-query-string-phrase"></a>Phrase</h5>
<div class="paragraph">
<p>The syntax includes support for <a href="#search-dsl-predicate-phrase"><code>phrase</code> predicates</a>
using quotes around the sequence of terms to match.</p>
</div>
<div class="exampleblock">
<div class="title">Example 236. Matching a simple query string: phrase</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .where( f -&gt; f.simpleQueryString().field( <span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span> )
                .matching( <span class="string"><span class="delimiter">&quot;</span><span class="char">\&quot;</span><span class="content">robots of dawn</span><span class="char">\&quot;</span><span class="delimiter">&quot;</span></span> ) )
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>A <a href="#search-dsl-predicate-phrase-slop">slop</a> can be assigned to a phrase predicate
using the NEAR operator <code>~</code>.</p>
</div>
<div class="exampleblock">
<div class="title">Example 237. Matching a simple query string: phrase with slop</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .where( f -&gt; f.simpleQueryString().field( <span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span> )
                .matching( <span class="string"><span class="delimiter">&quot;</span><span class="char">\&quot;</span><span class="content">dawn robot</span><span class="char">\&quot;</span><span class="content">~3</span><span class="delimiter">&quot;</span></span> ) )
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="search-dsl-predicate-simple-query-string-flags"><a class="anchor" href="#search-dsl-predicate-simple-query-string-flags"></a><code>flags</code>: enabling only specific syntax constructs</h5>
<div class="paragraph">
<p>By default, all syntax features are enabled.
You can pick the operators to enable explicitly through the <code>.flags(&#8230;&#8203;)</code> method.</p>
</div>
<div class="exampleblock">
<div class="title">Example 238. Matching a simple query string: enabling only specific syntax constructs</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .where( f -&gt; f.simpleQueryString().field( <span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span> )
                .matching( <span class="string"><span class="delimiter">&quot;</span><span class="content">I want a **robot**</span><span class="delimiter">&quot;</span></span> )
                .flags( SimpleQueryFlag.AND, SimpleQueryFlag.OR, SimpleQueryFlag.NOT ) )
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>If you wish, you can disable all syntax constructs:</p>
</div>
<div class="exampleblock">
<div class="title">Example 239. Matching a simple query string: disabling all syntax constructs</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .where( f -&gt; f.simpleQueryString().field( <span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span> )
                .matching( <span class="string"><span class="delimiter">&quot;</span><span class="content">**robot**</span><span class="delimiter">&quot;</span></span> )
                .flags( <span class="predefined-type">Collections</span>.emptySet() ) )
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="search-dsl-predicate-simple-query-string-minimumshouldmatch"><a class="anchor" href="#search-dsl-predicate-simple-query-string-minimumshouldmatch"></a><code>minimumShouldMatch</code>: fine-tuning how many <code>should</code> clauses are required to match</h5>
<div class="paragraph">
<p>The resulting query parsed from the query string may result in a boolean query with should clauses.
It may be helpful to control how many <code>should</code> clauses must match to consider a document as a match.</p>
</div>
<div class="exampleblock">
<div class="title">Example 240. Fine-tuning <code>should</code> clauses matching requirements with <code>minimumShouldMatch</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .where( f -&gt; f.simpleQueryString().field( <span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span> )
                .matching( <span class="string"><span class="delimiter">&quot;</span><span class="content">crime robot investigate automatic detective</span><span class="delimiter">&quot;</span></span> )
                .minimumShouldMatchNumber( <span class="integer">2</span> ) )
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>This is similar to <a href="#search-dsl-predicate-boolean-minimumshouldmatch">boolean</a> or
<a href="#search-dsl-predicate-query-string-minimumshouldmatch">query string</a>
predicates <code>minimumShouldMatch</code> options.</p>
</div>
</div>
<div class="sect4">
<h5 id="search-dsl-predicate-simpleQueryString-multiple-fields"><a class="anchor" href="#search-dsl-predicate-simpleQueryString-multiple-fields"></a>Targeting multiple fields</h5>
<div class="paragraph">
<p>Optionally, the predicate can target multiple fields.
In that case, the predicate will match documents for which <em>any</em> of the given fields matches.</p>
</div>
<div class="paragraph">
<p>See <a href="#search-dsl-predicate-common-multiple-fields">Targeting multiple fields in one predicate</a>.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
If targeted fields have different analyzers, an exception will be thrown.
You can avoid this by <a href="#search-dsl-predicate-common-overriding-analysis">picking an analyzer explicitly</a>,
but make sure you know what you&#8217;re doing.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="search-dsl-predicate-simpleQueryString-other"><a class="anchor" href="#search-dsl-predicate-simpleQueryString-other"></a>Other options</h5>
<div class="ulist">
<ul>
<li>
<p>The score of a <code>simpleQueryString</code> predicate is variable by default,
but can be <a href="#search-dsl-predicate-common-constantScore">made constant with <code>.constantScore()</code></a>.</p>
</li>
<li>
<p>The score of a <code>simpleQueryString</code> predicate can be <a href="#search-dsl-predicate-common-boost">boosted</a>,
either on a per-field basis with a call to <code>.boost(&#8230;&#8203;)</code> just after <code>.field(&#8230;&#8203;)</code>/<code>.fields(&#8230;&#8203;)</code>
or for the whole predicate with a call to <code>.boost(&#8230;&#8203;)</code> after <code>.matching(&#8230;&#8203;)</code>.</p>
</li>
<li>
<p>The <code>simpleQueryString</code> predicate uses the <a href="#mapping-directfieldmapping-search-analyzer">search analyzer</a>
of targeted fields to analyze searched text by default,
but this can be <a href="#search-dsl-predicate-common-overriding-analysis">overridden</a>.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="search-dsl-predicate-nested"><a class="anchor" href="#search-dsl-predicate-nested"></a>15.2.17. <code>nested</code>: match nested documents</h4>
<div class="paragraph">
<p>The <code>nested</code> predicate can be used on object fields <a href="#mapping-indexedembedded-structure">indexed as nested documents</a>
to require two or more inner predicates to match <em>the same object</em>.
This is how you ensure that <code>authors.firstname:isaac AND authors.lastname:asimov</code>
will not match a book whose authors are "Jane Asimov" and "Isaac Deutscher".</p>
</div>
<div class="exampleblock">
<div class="title">Example 241. Matching multiple predicates against a single nested object</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .where( f -&gt; f.nested( <span class="string"><span class="delimiter">&quot;</span><span class="content">authors</span><span class="delimiter">&quot;</span></span> ) <i class="conum" data-value="1"></i><b>(1)</b>
                .add( f.match().field( <span class="string"><span class="delimiter">&quot;</span><span class="content">authors.firstName</span><span class="delimiter">&quot;</span></span> )
                        .matching( <span class="string"><span class="delimiter">&quot;</span><span class="content">isaac</span><span class="delimiter">&quot;</span></span> ) ) <i class="conum" data-value="2"></i><b>(2)</b>
                .add( f.match().field( <span class="string"><span class="delimiter">&quot;</span><span class="content">authors.lastName</span><span class="delimiter">&quot;</span></span> )
                        .matching( <span class="string"><span class="delimiter">&quot;</span><span class="content">asimov</span><span class="delimiter">&quot;</span></span> ) ) ) <i class="conum" data-value="3"></i><b>(3)</b>
        .fetchHits( <span class="integer">20</span> ); <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Create a nested predicate on the <code>authors</code> object field.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The author must have a first name matching <code>isaac</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The author must have a last name matching <code>asimov</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>All returned hits will be books for which at least one author
has a first name matching <code>isaac</code> and a last name matching <code>asimov</code>.
Books that happen to have multiple authors,
one of which has a first name matching <code>isaac</code>
and <strong>another</strong> of which has a last name matching <code>asimov</code>,
will <strong>not</strong> match.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect4">
<h5 id="search-dsl-predicate-nested-implicit"><a class="anchor" href="#search-dsl-predicate-nested-implicit"></a><a id="_implicit_nesting"></a> Implicit nesting</h5>
<div class="paragraph">
<p>Hibernate Search automatically wraps a nested predicate around other predicates when necessary.
However, this is done for each single predicate,
so implicit nesting will not give the same behavior as explicit nesting grouping multiple inner predicates.
See below for an example.</p>
</div>
<div id="search-dsl-predicate-nested-implicit-example" class="exampleblock">
<div class="title">Example 242. Using implicit nesting</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .where( f -&gt; f.and()
                .add( f.match().field( <span class="string"><span class="delimiter">&quot;</span><span class="content">authors.firstName</span><span class="delimiter">&quot;</span></span> ) <i class="conum" data-value="1"></i><b>(1)</b>
                        .matching( <span class="string"><span class="delimiter">&quot;</span><span class="content">isaac</span><span class="delimiter">&quot;</span></span> ) ) <i class="conum" data-value="2"></i><b>(2)</b>
                .add( f.match().field( <span class="string"><span class="delimiter">&quot;</span><span class="content">authors.lastName</span><span class="delimiter">&quot;</span></span> )
                        .matching( <span class="string"><span class="delimiter">&quot;</span><span class="content">asimov</span><span class="delimiter">&quot;</span></span> ) ) ) <i class="conum" data-value="3"></i><b>(3)</b>
        .fetchHits( <span class="integer">20</span> ); <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The nested predicate is created implicitly, since target fields here belong to a nested object.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The author must have a first name matching <code>isaac</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The author must have a last name matching <code>asimov</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>All returned hits will be books for which at least one author
has a first name matching <code>isaac</code> and a last name matching <code>asimov</code>.
Books that happen to have multiple authors,
one of which has a first name matching <code>isaac</code>
and <strong>another</strong> of which has a last name matching <code>asimov</code>,
will match, because we apply the nested predicate <strong>separately</strong> to <strong>each match</strong> predicate.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="search-dsl-predicate-nested-deprecated-variants"><a class="anchor" href="#search-dsl-predicate-nested-deprecated-variants"></a>Deprecated variants</h5>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Features detailed in this section are <em>deprecated</em>: they should be avoided in favor of non-deprecated alternatives.</p>
</div>
<div class="paragraph">
<p>The usual <a href="https://hibernate.org/community/compatibility-policy/">compatibility policy</a> applies,
meaning the features are expected to remain available at least until the next major version of Hibernate Search.
Beyond that, they may be altered in a backward-incompatible way&#8201;&#8212;&#8201;or even removed.</p>
</div>
<div class="paragraph">
<p>Usage of deprecated features is not recommended.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Another syntax can be used to create a nested predicate,
but it is more verbose and deprecated.</p>
</div>
<div class="exampleblock">
<div class="title">Example 243. Deprecated variant of <code>.nested</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .where( f -&gt; f.nested().objectField( <span class="string"><span class="delimiter">&quot;</span><span class="content">authors</span><span class="delimiter">&quot;</span></span> ) <i class="conum" data-value="1"></i><b>(1)</b>
                .nest( f.and()
                        .add( f.match().field( <span class="string"><span class="delimiter">&quot;</span><span class="content">authors.firstName</span><span class="delimiter">&quot;</span></span> )
                                .matching( <span class="string"><span class="delimiter">&quot;</span><span class="content">isaac</span><span class="delimiter">&quot;</span></span> ) ) <i class="conum" data-value="2"></i><b>(2)</b>
                        .add( f.match().field( <span class="string"><span class="delimiter">&quot;</span><span class="content">authors.lastName</span><span class="delimiter">&quot;</span></span> )
                                .matching( <span class="string"><span class="delimiter">&quot;</span><span class="content">asimov</span><span class="delimiter">&quot;</span></span> ) ) ) ) <i class="conum" data-value="3"></i><b>(3)</b>
        .fetchHits( <span class="integer">20</span> ); <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Create a nested predicate on the <code>authors</code> object field.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The author must have a first name matching <code>isaac</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The author must have a last name matching <code>asimov</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>All returned hits will be books for which at least one author
has a first name matching <code>isaac</code> and a last name matching <code>asimov</code>.
Books that happen to have multiple authors,
one of which has a first name matching <code>isaac</code>
and <strong>another</strong> of which has a last name matching <code>asimov</code>,
will <strong>not</strong> match.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="search-dsl-predicate-spatial-within"><a class="anchor" href="#search-dsl-predicate-spatial-within"></a>15.2.18. <a id="spatial-queries"></a> <code>within</code>: match points within a circle, box, polygon</h4>
<div class="paragraph">
<p>The <code>within</code> predicate matches documents for which a given field is a geo-point
contained within a given circle, bounding-box or polygon.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This predicate is only available on <a href="#mapping-geopoint">geo-point fields</a>.
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="search-dsl-predicate-spatial-within-circle"><a class="anchor" href="#search-dsl-predicate-spatial-within-circle"></a>Matching points within a circle (within a distance to a point)</h5>
<div class="paragraph">
<p>With <code>.circle(&#8230;&#8203;)</code>, the matched points must be within a given distance from a given point (center).</p>
</div>
<div class="exampleblock">
<div class="title">Example 244. Matching points within a circle</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">GeoPoint center = GeoPoint.of( <span class="float">53.970000</span>, <span class="float">32.150000</span> );
<span class="predefined-type">List</span>&lt;Author&gt; hits = searchSession.search( Author.class )
        .where( f -&gt; f.spatial().within().field( <span class="string"><span class="delimiter">&quot;</span><span class="content">placeOfBirth.coordinates</span><span class="delimiter">&quot;</span></span> )
                .circle( center, <span class="integer">50</span>, DistanceUnit.KILOMETERS ) )
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Other distance units are available, in particular <code>METERS</code>, <code>YARDS</code> and <code>MILES</code>.
When the distance unit is omitted, it defaults to <code>METERS</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can also pass the coordinates of the center as two doubles (latitude, then longitude).</p>
</div>
<div class="exampleblock">
<div class="title">Example 245. Matching points within a circle: passing center coordinates as doubles</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;Author&gt; hits = searchSession.search( Author.class )
        .where( f -&gt; f.spatial().within().field( <span class="string"><span class="delimiter">&quot;</span><span class="content">placeOfBirth.coordinates</span><span class="delimiter">&quot;</span></span> )
                .circle( <span class="float">53.970000</span>, <span class="float">32.150000</span>, <span class="integer">50</span>, DistanceUnit.KILOMETERS ) )
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="search-dsl-predicate-spatial-within-bounding-box"><a class="anchor" href="#search-dsl-predicate-spatial-within-bounding-box"></a>Matching points within a bounding box</h5>
<div class="paragraph">
<p>With <code>.boundingBox(&#8230;&#8203;)</code>, the matched points must be within a given bounding box
defined by its top-left and bottom-right corners.</p>
</div>
<div class="exampleblock">
<div class="title">Example 246. Matching points within a box</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">GeoBoundingBox box = GeoBoundingBox.of(
        <span class="float">53.99</span>, <span class="float">32.13</span>,
        <span class="float">53.95</span>, <span class="float">32.17</span>
);
<span class="predefined-type">List</span>&lt;Author&gt; hits = searchSession.search( Author.class )
        .where( f -&gt; f.spatial().within().field( <span class="string"><span class="delimiter">&quot;</span><span class="content">placeOfBirth.coordinates</span><span class="delimiter">&quot;</span></span> )
                .boundingBox( box ) )
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>You can also pass the coordinates of the top-left and bottom-right corners as four doubles:
top-left latitude, top-left longitude, bottom-right latitude, bottom-right longitude.</p>
</div>
<div class="exampleblock">
<div class="title">Example 247. Matching points within a box: passing corner coordinates as doubles</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;Author&gt; hits = searchSession.search( Author.class )
        .where( f -&gt; f.spatial().within().field( <span class="string"><span class="delimiter">&quot;</span><span class="content">placeOfBirth.coordinates</span><span class="delimiter">&quot;</span></span> )
                .boundingBox( <span class="float">53.99</span>, <span class="float">32.13</span>,
                        <span class="float">53.95</span>, <span class="float">32.17</span> ) )
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="search-dsl-predicate-spatial-within-polygon"><a class="anchor" href="#search-dsl-predicate-spatial-within-polygon"></a>Matching points within a polygon</h5>
<div class="paragraph">
<p>With <code>.polygon(&#8230;&#8203;)</code>, the matched points must be within a given polygon.</p>
</div>
<div class="exampleblock">
<div class="title">Example 248. Matching points within a polygon</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">GeoPolygon polygon = GeoPolygon.of(
        GeoPoint.of( <span class="float">53.976177</span>, <span class="float">32.138627</span> ),
        GeoPoint.of( <span class="float">53.986177</span>, <span class="float">32.148627</span> ),
        GeoPoint.of( <span class="float">53.979177</span>, <span class="float">32.168627</span> ),
        GeoPoint.of( <span class="float">53.876177</span>, <span class="float">32.159627</span> ),
        GeoPoint.of( <span class="float">53.956177</span>, <span class="float">32.155627</span> ),
        GeoPoint.of( <span class="float">53.976177</span>, <span class="float">32.138627</span> )
);
<span class="predefined-type">List</span>&lt;Author&gt; hits = searchSession.search( Author.class )
        .where( f -&gt; f.spatial().within().field( <span class="string"><span class="delimiter">&quot;</span><span class="content">placeOfBirth.coordinates</span><span class="delimiter">&quot;</span></span> )
                .polygon( polygon ) )
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="search-dsl-predicate-spatial-within-multiple-fields"><a class="anchor" href="#search-dsl-predicate-spatial-within-multiple-fields"></a>Targeting multiple fields</h5>
<div class="paragraph">
<p>Optionally, the predicate can target multiple fields.
In that case, the predicate will match documents for which <em>any</em> of the given fields matches.</p>
</div>
<div class="paragraph">
<p>See <a href="#search-dsl-predicate-common-multiple-fields">Targeting multiple fields in one predicate</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="search-dsl-predicate-spatial-within-other"><a class="anchor" href="#search-dsl-predicate-spatial-within-other"></a>Other options</h5>
<div class="ulist">
<ul>
<li>
<p>The score of a <code>within</code> predicate is constant and equal to 1 by default,
but can be <a href="#search-dsl-predicate-common-boost">boosted</a>,
either on a per-field basis with a call to <code>.boost(&#8230;&#8203;)</code> just after <code>.field(&#8230;&#8203;)</code>/<code>.fields(&#8230;&#8203;)</code>
or for the whole predicate with a call to <code>.boost(&#8230;&#8203;)</code>
after <code>.circle(&#8230;&#8203;)</code>/<code>.boundingBox(&#8230;&#8203;)</code>/<code>.polygon(&#8230;&#8203;)</code>.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="search-dsl-predicate-knn"><a class="anchor" href="#search-dsl-predicate-knn"></a>15.2.19. <code>knn</code>: K-Nearest Neighbors a.k.a. vector search</h4>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Features detailed below are <em>incubating</em>: they are still under active development.</p>
</div>
<div class="paragraph">
<p>The usual <a href="https://hibernate.org/community/compatibility-policy/">compatibility policy</a> does not apply:
the contract of incubating elements (e.g. types, methods, configuration properties, etc.)
may be altered in a backward-incompatible way&#8201;&#8212;&#8201;or even removed&#8201;&#8212;&#8201;in subsequent releases.</p>
</div>
<div class="paragraph">
<p>You are encouraged to use incubating features so the development team can get feedback and improve them,
but you should be prepared to update code which relies on them as needed.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <code>knn</code> predicate, with <code>k</code> being a positive integer, matches the <code>k</code> documents for which a given vector field&#8217;s value is "nearest" to a given vector.</p>
</div>
<div class="paragraph">
<p>Distance is measured based on the vector similarity configured for the given <a href="#mapping-directfieldmapping-annotations-vectorfield">vector field</a>.</p>
</div>
<div class="exampleblock">
<div class="title">Example 249. Simple K-Nearest Neighbors search</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="type">float</span><span class="type">[]</span> coverImageEmbeddingsVector = <span class="comment">/*...*/</span>
<span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .where( f -&gt; f.knn( <span class="integer">5</span> ).field( <span class="string"><span class="delimiter">&quot;</span><span class="content">coverImageEmbeddings</span><span class="delimiter">&quot;</span></span> ).matching( coverImageEmbeddingsVector ) )
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="search-dsl-predicate-knn-argument-type"><a class="anchor" href="#search-dsl-predicate-knn-argument-type"></a>Expected type of arguments</h5>
<div class="paragraph">
<p>The <code>knn</code> predicate expects arguments to the <code>matching(&#8230;&#8203;)</code> method
to have the same type as the index type of a target field.</p>
</div>
<div class="paragraph">
<p>For example, if an entity property is mapped in the index to a byte array type (<code>byte[]</code>) ,
<code>.matching(&#8230;&#8203;)</code> will expect its argument to be a byte array (<code>byte[]</code>) only.</p>
</div>
</div>
<div class="sect4">
<h5 id="search-dsl-predicate-knn-filter"><a class="anchor" href="#search-dsl-predicate-knn-filter"></a>Filtering the neighbors</h5>
<div class="paragraph">
<p>Optionally, the predicate can filter out some of the neighbors using the <code>.filter(..)</code> clause of the predicate.
<code>.filter(&#8230;&#8203;)</code> expects a predicate to be passed to it.</p>
</div>
<div class="exampleblock">
<div class="title">Example 250. K-Nearest Neighbors search with a filter</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="type">float</span><span class="type">[]</span> coverImageEmbeddingsVector = <span class="comment">/*...*/</span>
<span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .where( f -&gt; f.knn( <span class="integer">5</span> ).field( <span class="string"><span class="delimiter">&quot;</span><span class="content">coverImageEmbeddings</span><span class="delimiter">&quot;</span></span> ).matching( coverImageEmbeddingsVector )
                .filter( f.match().field( <span class="string"><span class="delimiter">&quot;</span><span class="content">authors.firstName</span><span class="delimiter">&quot;</span></span> ).matching( <span class="string"><span class="delimiter">&quot;</span><span class="content">isaac</span><span class="delimiter">&quot;</span></span> ) ) )
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="search-dsl-predicate-knn-with-text-search"><a class="anchor" href="#search-dsl-predicate-knn-with-text-search"></a>Combining <code>knn</code> with other predicates</h5>
<div class="paragraph">
<p>A <code>knn</code> predicate can be combined with the regular text-search predicates. It can improve the quality of search results
by increasing the score of documents that are more relevant based on vector embeddings characteristics:</p>
</div>
<div class="exampleblock">
<div class="title">Example 251. Enriching regular text search with K-Nearest Neighbors search</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="type">float</span><span class="type">[]</span> coverImageEmbeddingsVector = <span class="comment">/*...*/</span>
<span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .where( f -&gt; f.bool()
                .must( f.match().field( <span class="string"><span class="delimiter">&quot;</span><span class="content">genre</span><span class="delimiter">&quot;</span></span> ).matching( Genre.SCIENCE_FICTION ) ) <i class="conum" data-value="1"></i><b>(1)</b>
                .should( f.knn( <span class="integer">10</span> ).field( <span class="string"><span class="delimiter">&quot;</span><span class="content">coverImageEmbeddings</span><span class="delimiter">&quot;</span></span> ).matching( coverImageEmbeddingsVector ) ) <i class="conum" data-value="2"></i><b>(2)</b>
        )
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Find science fiction books.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Improve the score of science fiction books that have a cover similar to the one we are searching for.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="search-dsl-predicate-knn-with-similarity"><a class="anchor" href="#search-dsl-predicate-knn-with-similarity"></a>Filtering out irrelevant results with <code>knn</code> similarity</h5>
<div class="paragraph">
<p>By its nature a <code>knn</code> predicate will always try to find <code>k</code> nearest vectors,
even if the found vectors are quite far away from each other, i.e. are not that similar.
This may lead to getting irrelevant results returned by the query.</p>
</div>
<div class="paragraph">
<p>To address this, a <code>knn</code> predicate allows configuring the minimum required similarity.
If configured, <code>knn</code> predicate will find <code>k</code> nearest vectors
and filter out any that will have similarity lower than this configured threshold.
Note that the expected value for this property is a distance value between two vectors according to configured
<a href="#mapping-directfieldmapping-vectorSimilarity">vector similarity</a>.</p>
</div>
<div class="exampleblock">
<div class="title">Example 252. Filtering out irrelevant results</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="type">float</span><span class="type">[]</span> coverImageEmbeddingsVector = <span class="comment">/*...*/</span>
<span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .where( f -&gt; f.knn( <span class="integer">5</span> ).field( <span class="string"><span class="delimiter">&quot;</span><span class="content">coverImageEmbeddings</span><span class="delimiter">&quot;</span></span> ).matching( coverImageEmbeddingsVector ) <i class="conum" data-value="1"></i><b>(1)</b>
                .requiredMinimumSimilarity( <span class="integer">5</span> ) ) <i class="conum" data-value="2"></i><b>(2)</b>
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Create a knn predicate as usual.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Specify the required minimum similarity value, to filter out irrelevant results.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This configuration is only available for a <a href="#backend-lucene">Lucene backend</a>
and for the <a href="#backend-elasticsearch-compatibility-elasticsearch">Elastic</a> distribution of
an <a href="#backend-elasticsearch">Elasticsearch backend</a>.
<a href="#backend-elasticsearch-compatibility-opensearch">OpenSearch</a> does not have this option available,
and trying to use it will lead to an exception being thrown.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="search-dsl-predicate-knn-limitations"><a class="anchor" href="#search-dsl-predicate-knn-limitations"></a>Backend specifics and limitations</h5>
<div class="paragraph">
<p>The parameter <code>k</code> has different behavior between backends, and their distributions.</p>
</div>
<div class="paragraph">
<p>With the <a href="#backend-lucene">Lucene backend</a> <code>k</code> is the number that will limit the final amount of documents
matched by a <a href="#search-dsl-predicate-knn"><code>knn</code> predicate</a>.
When using the <a href="#backend-elasticsearch-compatibility-elasticsearch">Elastic</a> distribution of the <a href="#backend-elasticsearch">Elasticsearch backend</a>
<code>k</code> will be treated as both <code>k</code> and <code>num_candidates</code>.
See the Elasticsearch <a href="https://www.elastic.co/guide/en/elasticsearch/reference/8.13/knn-search.html#tune-approximate-knn-for-speed-accuracy">documentation</a> for more details.
While when an <a href="#backend-elasticsearch-compatibility-opensearch">OpenSearch</a> distribution is used,
<code>k</code> will be mapped to <code>k</code> attribute of <code>knn</code> query. Note that in this case you may get more than <code>k</code> results,
when the index is configured to have more than one shard.
See this section of the OpenSearch <a href="https://opensearch.org/docs/2.13/search-plugins/knn/approximate-knn/#get-started-with-approximate-k-nn">documentation</a> for more details.</p>
</div>
<div class="paragraph">
<p>Using the <code>knn</code> predicate inside a nested predicate with the Elasticsearch backend has some limitations.
In particular, when a <a href="#backend-elasticsearch-multi-tenancy">tenant</a> or <a href="#concepts-sharding-routing">routing</a> filters
are implicitly applied, the produced results may contain fewer documents than expected. To address this limitation,
a schema change is required and should be addressed in one of the future major releases (<a href="https://hibernate.atlassian.net/browse/HSEARCH-5085">HSEARCH-5085</a>).</p>
</div>
</div>
<div class="sect4">
<h5 id="search-dsl-predicate-knn-other"><a class="anchor" href="#search-dsl-predicate-knn-other"></a>Other options</h5>
<div class="ulist">
<ul>
<li>
<p>The score of a <code>knn</code> predicate is variable by default (higher for "nearer" documents),
but can be <a href="#search-dsl-predicate-common-constantScore">made constant with <code>.constantScore()</code></a>.</p>
</li>
<li>
<p>The score of a <code>knn</code> predicate can be <a href="#search-dsl-predicate-common-boost">boosted</a>
for the whole predicate with a call to <code>.boost(&#8230;&#8203;)</code> after <code>.matching(&#8230;&#8203;)</code>.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="search-dsl-predicate-query-string"><a class="anchor" href="#search-dsl-predicate-query-string"></a>15.2.20. <code>queryString</code>: match a user-provided query string</h4>
<div class="paragraph">
<p>The <code>queryString</code> predicate matches documents according to a structured query given as a string.
It allows building more advanced query strings and has more configuration options than a <a href="#search-dsl-predicate-simple-query-string"><code>simpleQueryString</code></a> predicate.</p>
</div>
<div class="paragraph">
<p>We will not go much into details of a query syntax in this guide
To familiarize yourself with it, please refer to your backend
(<a href="https://www.elastic.co/guide/en/elasticsearch/reference/8.13/query-dsl-query-string-query.html#query-string-syntax">Elasticsearch</a>/<a href="https://opensearch.org/docs/2.13/query-dsl/full-text/query-string/">OpenSearch</a>/<a href="https://lucene.apache.org/core/9_9_2/core/../queryparser/org/apache/lucene/queryparser/classic/package-summary.html#package.description/">Lucene</a>)
guides.</p>
</div>
<div class="exampleblock">
<div class="title">Example 253. Matching a query string</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .where( f -&gt; f.queryString().field( <span class="string"><span class="delimiter">&quot;</span><span class="content">description</span><span class="delimiter">&quot;</span></span> )
                .matching(
                        <span class="string"><span class="delimiter">&quot;</span><span class="content">robots +(crime investigation disappearance)^10 +</span><span class="char">\&quot;</span><span class="content">investigation help</span><span class="char">\&quot;</span><span class="content">~2 -/(dis)?a[p]+ea?ance/</span><span class="delimiter">&quot;</span></span> ) ) <i class="conum" data-value="1"></i><b>(1)</b>
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This query string will result in a boolean query with 4 clauses:
<div class="ulist">
<ul>
<li>
<p>a should clause matching <code>robots</code>;</p>
</li>
<li>
<p>two must clauses</p>
<div class="ulist">
<ul>
<li>
<p>another boolean query constructed from <code>(crime || investigation || disappearance)</code> string with a boost of <code>10</code></p>
</li>
<li>
<p>a query matching the phrase <code>investigation help</code> with the phrase slop equals to <code>2</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>a must not clause matching a regular expression <code>(dis)?a[p]+ea?ance</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Note that each of the mentioned clauses may itself end up being translated into other types of queries.</p>
</div></td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect4">
<h5 id="search-dsl-predicate-query-string-boolean-operators-default"><a class="anchor" href="#search-dsl-predicate-query-string-boolean-operators-default"></a>Default boolean operator</h5>
<div class="paragraph">
<p>By default, the query uses the OR operator if the operator is not explicitly defined.
If you prefer using the AND operator as default,
you can call <code>.defaultOperator(&#8230;&#8203;)</code>.</p>
</div>
<div class="exampleblock">
<div class="title">Example 254. Matching a query string: AND as default operator</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .where( f -&gt; f.queryString().field( <span class="string"><span class="delimiter">&quot;</span><span class="content">description</span><span class="delimiter">&quot;</span></span> )
                .matching( <span class="string"><span class="delimiter">&quot;</span><span class="content">robots investigation</span><span class="delimiter">&quot;</span></span> )
                .defaultOperator( BooleanOperator.AND ) )
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="search-dsl-predicate-query-string-phrase-slop"><a class="anchor" href="#search-dsl-predicate-query-string-phrase-slop"></a>Phrase slop</h5>
<div class="paragraph">
<p>The phrase slop option defines how permissive a constructed phrase predicate will be;
in other words, how many transpositions in the phrase are allowed for it to still be considered a match.
With query predicate, this option can be set in the query string itself.</p>
</div>
<div class="exampleblock">
<div class="title">Example 255. Matching a query string: phrase slop as part of query string itself</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .where( f -&gt; f.queryString().field( <span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span> )
                .matching( <span class="string"><span class="delimiter">&quot;</span><span class="char">\&quot;</span><span class="content">dawn robot</span><span class="char">\&quot;</span><span class="content">~3</span><span class="delimiter">&quot;</span></span> ) )
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Alternatively, <code>.phraseSlop(&#8230;&#8203;)</code> can be applied to a query string predicate.</p>
</div>
<div class="exampleblock">
<div class="title">Example 256. Matching a query string: phrase slop as predicate option</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .where( f -&gt; f.queryString().field( <span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span> )
                .matching( <span class="string"><span class="delimiter">&quot;</span><span class="char">\&quot;</span><span class="content">dawn robot</span><span class="char">\&quot;</span><span class="delimiter">&quot;</span></span> )
                .phraseSlop( <span class="integer">3</span> ) )
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Note that passing the value to <code>.phraseSlop(&#8230;&#8203;)</code> sets the default phrase slop value, that can be overridden in the query string.</p>
</div>
<div class="exampleblock">
<div class="title">Example 257. Matching a query string: phrase slop as predicate option overridden by query</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .where( f -&gt; f.queryString().field( <span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span> )
                .matching( <span class="string"><span class="delimiter">&quot;</span><span class="char">\&quot;</span><span class="content">dawn robot</span><span class="char">\&quot;</span><span class="content">~3 -</span><span class="char">\&quot;</span><span class="content">automatic detective</span><span class="char">\&quot;</span><span class="delimiter">&quot;</span></span> ) <i class="conum" data-value="1"></i><b>(1)</b>
                .phraseSlop( <span class="integer">1</span> ) ) <i class="conum" data-value="2"></i><b>(2)</b>
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Query string is combination of two phrase queries.
First phrase query <code>"dawn robot"</code> applies an override of the default phrase slop parameter and sets it to <code>3</code>.
Second phrase query <code>"automatic detective"</code> uses the default phrase slop set in (2).</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Set the default pharse slop value to apply to the phrase queries that do not specify the slop explicitly in the query string.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="search-dsl-predicate-query-string-allow-leading-wildcard"><a class="anchor" href="#search-dsl-predicate-query-string-allow-leading-wildcard"></a>Allowing leading wildcards</h5>
<div class="paragraph">
<p>A query string can use a wildcard at any position within a query by default.
If there is a need to prevent users from using leading wildcards, <code>.allowLeadingWildcard(..)</code> can be called
with a <code>false</code> value to disallow such queries.</p>
</div>
<div class="exampleblock">
<div class="title">Example 258. Matching a query string: disallowing leading wildcards</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .where( f -&gt; f.queryString().field( <span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span> )
                .matching( <span class="string"><span class="delimiter">&quot;</span><span class="content">robo?</span><span class="delimiter">&quot;</span></span> )
                .allowLeadingWildcard( <span class="predefined-constant">false</span> ) )
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this example, a query uses the wildcard at the end of the word; hence, it is acceptable regardless of the option value.
If queries like <code>?obot</code> or <code>*bot</code> were supplied, and at the same time, leading wildcards were disallowed
it would have resulted in an exception being thrown.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>Note that this option affects not just the whole query string, but individual clauses in that query string.
For example, in a query string <code>robot ?etective</code> the wildcard <code>?</code> is not a leading character,
but this query is broken down as two clauses for <code>robot</code> and <code>?etecitve</code> where in the second
clause, the <code>?</code> wildcard becomes a leading character.</p>
</div>
</div>
<div class="sect4">
<h5 id="search-dsl-predicate-query-string-enable-position-increments"><a class="anchor" href="#search-dsl-predicate-query-string-enable-position-increments"></a>Enabling position increments</h5>
<div class="paragraph">
<p>Position increments are enabled by default.
Position increments are enabled by default, allowing phrase queries to take into account stop words removed by a <code>stopwords</code> filter.
Position increments can be disabled as shown below,
leading to a change in the behaviour of phrase queries:
assuming that there is a phrase <code>book at the shelve</code> in the document, and the stop filter removes both <code>at</code> and <code>the</code>,
with disabled position increments, phrase query <code>"book shelve"</code> will not match such document.</p>
</div>
<div class="exampleblock">
<div class="title">Example 259. Matching a query string: disabling position increments</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .where( f -&gt; f.queryString().field( <span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span> )
                .matching( <span class="string"><span class="delimiter">&quot;</span><span class="char">\&quot;</span><span class="content">crime robots</span><span class="char">\&quot;</span><span class="delimiter">&quot;</span></span> )
                .enablePositionIncrements( <span class="predefined-constant">false</span> ) )
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="search-dsl-predicate-query-string-rewrite-method"><a class="anchor" href="#search-dsl-predicate-query-string-rewrite-method"></a>Rewrite method</h5>
<div class="paragraph">
<p>The rewrite method determines how the backend&#8217;s query parser rewrites and scores multi-term queries.</p>
</div>
<div class="paragraph">
<p>To change the default <code>CONSTANT_SCORE</code> rewrite method, one of the allowed <code>RewriteMethod</code> enum values can be passed
to <code>.rewriteMethod(RewriteMethod)</code>/<code>rewriteMethod(RewriteMethod, int)</code>.</p>
</div>
<div class="paragraph">
<p>Note, even though the default rewrite method is called <code>CONSTANT_SCORE</code>
it does not mean that the matched documents' final score will be constant across all results,
it is more about how the query parsing works internally.
To achieve a constant score for results, see <a href="#search-dsl-predicate-query-string-other">this documentation section</a> on the query string predicate.</p>
</div>
<div class="paragraph">
<p>We will not go into details about different rewrite methods in this guide.
To learn more about them, please refer to your backend&#8217;s guide
(<a href="https://www.elastic.co/guide/en/elasticsearch/reference/8.13/query-dsl-multi-term-rewrite.html">Elasticsearch</a>/<a href="https://opensearch.org/docs/2.13/query-dsl/full-text/query-string/">OpenSearch</a>/<a href="https://lucene.apache.org/core/9_9_2/core/org/apache/lucene/search/MultiTermQuery.html">Lucene</a>).</p>
</div>
<div class="exampleblock">
<div class="title">Example 260. Matching a query string: rewrite method</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .where( f -&gt; f.queryString().field( <span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span> )
                .matching(
                        <span class="comment">// some complex query string</span>
                )
                .rewriteMethod( RewriteMethod.CONSTANT_SCORE_BOOLEAN ) )
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="search-dsl-predicate-query-string-minimumshouldmatch"><a class="anchor" href="#search-dsl-predicate-query-string-minimumshouldmatch"></a><code>minimumShouldMatch</code>: fine-tuning how many <code>should</code> clauses are required to match</h5>
<div class="paragraph">
<p>The resulting query parsed from the query string may result in a boolean query with should clauses.
It may be helpful to control how many <code>should</code> clauses must match to consider a document as a match.</p>
</div>
<div class="exampleblock">
<div class="title">Example 261. Fine-tuning <code>should</code> clauses matching requirements with <code>minimumShouldMatch</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .where( f -&gt; f.simpleQueryString().field( <span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span> )
                .matching( <span class="string"><span class="delimiter">&quot;</span><span class="content">crime robot investigate automatic detective</span><span class="delimiter">&quot;</span></span> )
                .minimumShouldMatchNumber( <span class="integer">2</span> ) )
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>This is similar to <a href="#search-dsl-predicate-boolean-minimumshouldmatch">boolean</a> or
<a href="#search-dsl-predicate-simple-query-string-minimumshouldmatch">simple query string</a>
predicates <code>minimumShouldMatch</code> options.</p>
</div>
</div>
<div class="sect4">
<h5 id="search-dsl-predicate-query-string-multiple-fields"><a class="anchor" href="#search-dsl-predicate-query-string-multiple-fields"></a>Targeting multiple fields</h5>
<div class="paragraph">
<p>Optionally, the predicate can target multiple fields.
In that case, the predicate will match documents for which <em>any</em> of the given fields matches.</p>
</div>
<div class="paragraph">
<p>See <a href="#search-dsl-predicate-common-multiple-fields">Targeting multiple fields in one predicate</a>.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
If targeted fields have different analyzers, an exception will be thrown.
You can avoid this by <a href="#search-dsl-predicate-common-overriding-analysis">picking an analyzer explicitly</a>,
but make sure you know what you&#8217;re doing.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="search-dsl-predicate-query-string-other"><a class="anchor" href="#search-dsl-predicate-query-string-other"></a>Other options</h5>
<div class="ulist">
<ul>
<li>
<p>The score of a <code>queryString</code> predicate is variable by default,
but can be <a href="#search-dsl-predicate-common-constantScore">made constant with <code>.constantScore()</code></a>.</p>
</li>
<li>
<p>The score of a <code>queryString</code> predicate can be <a href="#search-dsl-predicate-common-boost">boosted</a>,
either on a per-field basis with a call to <code>.boost(&#8230;&#8203;)</code> just after <code>.field(&#8230;&#8203;)</code>/<code>.fields(&#8230;&#8203;)</code>
or for the whole predicate with a call to <code>.boost(&#8230;&#8203;)</code> after <code>.matching(&#8230;&#8203;)</code>.</p>
</li>
<li>
<p>The <code>queryString</code> predicate uses the <a href="#mapping-directfieldmapping-search-analyzer">search analyzer</a>
of targeted fields to analyze searched text by default,
but this can be <a href="#search-dsl-predicate-common-overriding-analysis">overridden</a>.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="search-dsl-predicate-named"><a class="anchor" href="#search-dsl-predicate-named"></a>15.2.21. <a id="query-filter-fulltext"></a> <code>named</code>: call a predicate defined in the mapping</h4>
<div class="paragraph">
<p>A <code>named</code> predicate, i.e. a predicate defined in the mapping,
can be called and included in a query.</p>
</div>
<div class="paragraph">
<p>Below is an example that calls the named predicate
from the example of section <a href="#binding-named-predicate"> Defining named predicates</a>.</p>
</div>
<div class="exampleblock">
<div class="title">Example 262. Calling a named predicate</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;ItemStock&gt; hits = searchSession.search( ItemStock.class )
        .where( f -&gt; f.named( <span class="string"><span class="delimiter">&quot;</span><span class="content">skuId.skuIdMatch</span><span class="delimiter">&quot;</span></span> ) <i class="conum" data-value="1"></i><b>(1)</b>
                .param( <span class="string"><span class="delimiter">&quot;</span><span class="content">pattern</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">*.WI2012</span><span class="delimiter">&quot;</span></span> ) ) <i class="conum" data-value="2"></i><b>(2)</b>
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The named predicate is referred to by its name,
prefixed with the path of the object where the predicate was defined and a dot.
<div class="paragraph">
<p>Here, the predicate is named <code>skuIdMatch</code> and was defined on an object field named <code>skuId</code>.
For named predicates defined at the root of the index,
you can pass the predicate name directly, without any prefix.</p>
</div></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Named predicates can accept parameters,
which will be handled as explained in <a href="#binding-named-predicate"> Defining named predicates</a>.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="search-dsl-predicate-extensions"><a class="anchor" href="#search-dsl-predicate-extensions"></a>15.2.22. Backend-specific extensions</h4>
<div class="paragraph">
<p>By calling <code>.extension(&#8230;&#8203;)</code> while building a query,
it is possible to access backend-specific predicates.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>As their name suggests, backend-specific predicates are not portable from one backend technology to the other.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="search-dsl-predicate-extensions-lucene-from-lucene-query"><a class="anchor" href="#search-dsl-predicate-extensions-lucene-from-lucene-query"></a>Lucene: <code>fromLuceneQuery</code></h5>
<div class="paragraph">
<p><code>.fromLuceneQuery(&#8230;&#8203;)</code> turns a native Lucene <code>Query</code> into a Hibernate Search predicate.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This feature implies that application code rely on Lucene APIs directly.</p>
</div>
<div class="paragraph">
<p>An upgrade of Hibernate Search, even for a bugfix (micro) release,
may require an upgrade of Lucene,
which may lead to breaking API changes in Lucene.</p>
</div>
<div class="paragraph">
<p>If this happens, you will need to change application code to deal with the changes.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="exampleblock">
<div class="title">Example 263. Matching a native <code>org.apache.lucene.search.Query</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .extension( LuceneExtension.get() ) <i class="conum" data-value="1"></i><b>(1)</b>
        .where( f -&gt; f.fromLuceneQuery( <i class="conum" data-value="2"></i><b>(2)</b>
                <span class="keyword">new</span> RegexpQuery( <span class="keyword">new</span> Term( <span class="string"><span class="delimiter">&quot;</span><span class="content">description</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">neighbor|neighbour</span><span class="delimiter">&quot;</span></span> ) )
        ) )
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Build the query as usual,
but using the Lucene extension so that Lucene-specific options are available.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Add a predicate defined by a given Lucene <code>Query</code> object.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="search-dsl-predicate-extensions-elasticsearch-from-json"><a class="anchor" href="#search-dsl-predicate-extensions-elasticsearch-from-json"></a>Elasticsearch: <code>fromJson</code></h5>
<div class="paragraph">
<p><code>.fromJson(&#8230;&#8203;)</code> turns JSON representing an Elasticsearch query into a Hibernate Search predicate.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This feature requires to directly manipulate JSON in application code.</p>
</div>
<div class="paragraph">
<p>The syntax of this JSON may change:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>when you upgrade the underlying Elasticsearch cluster to the next version;</p>
</li>
<li>
<p>when you upgrade Hibernate Search to the next version, even for a bugfix (micro) release.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If this happens, you will need to change application code to deal with the changes.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="exampleblock">
<div class="title">Example 264. Matching a native Elasticsearch JSON query provided as a <code>JsonObject</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">JsonObject jsonObject =
<span class="comment">/* ... */</span>; <i class="conum" data-value="1"></i><b>(1)</b>
<span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .extension( ElasticsearchExtension.get() ) <i class="conum" data-value="2"></i><b>(2)</b>
        .where( f -&gt; f.fromJson( jsonObject ) ) <i class="conum" data-value="3"></i><b>(3)</b>
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Build a JSON object using <a href="https://github.com/google/gson">Gson</a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Build the query as usual,
but using the Lucene extension so that Lucene-specific options are available.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Add a predicate defined by a given <code>JsonObject</code>.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 265. Matching a native Elasticsearch JSON query provided as a JSON-formatted string</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .extension( ElasticsearchExtension.get() ) <i class="conum" data-value="1"></i><b>(1)</b>
        .where( f -&gt; f.fromJson( <span class="string"><span class="delimiter">&quot;</span><span class="content">{</span><span class="delimiter">&quot;</span></span> <i class="conum" data-value="2"></i><b>(2)</b>
                + <span class="string"><span class="delimiter">&quot;</span><span class="content">    </span><span class="char">\&quot;</span><span class="content">regexp</span><span class="char">\&quot;</span><span class="content">: {</span><span class="delimiter">&quot;</span></span>
                + <span class="string"><span class="delimiter">&quot;</span><span class="content">        </span><span class="char">\&quot;</span><span class="content">description</span><span class="char">\&quot;</span><span class="content">: </span><span class="char">\&quot;</span><span class="content">neighbor|neighbour</span><span class="char">\&quot;</span><span class="delimiter">&quot;</span></span>
                + <span class="string"><span class="delimiter">&quot;</span><span class="content">    }</span><span class="delimiter">&quot;</span></span>
                + <span class="string"><span class="delimiter">&quot;</span><span class="content">}</span><span class="delimiter">&quot;</span></span> ) )
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Build the query as usual,
but using the Lucene extension so that Lucene-specific options are available.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Add a predicate defined by a given JSON-formatted string.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="search-dsl-predicate-common"><a class="anchor" href="#search-dsl-predicate-common"></a>15.2.23. <a id="_query_options"></a> Options common to multiple predicate types</h4>
<div class="sect4">
<h5 id="search-dsl-predicate-common-multiple-fields"><a class="anchor" href="#search-dsl-predicate-common-multiple-fields"></a>Targeting multiple fields in one predicate</h5>
<div class="paragraph">
<p>Some predicates offer the ability to target multiple fields in the same predicate.</p>
</div>
<div class="paragraph">
<p>In that case, the predicate will match documents for which <em>any</em> of the given fields matches.</p>
</div>
<div class="paragraph">
<p>Below is an example with the <a href="#search-dsl-predicate-match"><code>match</code> predicate</a>.</p>
</div>
<div class="exampleblock">
<div class="title">Example 266. Matching a value in any of multiple fields</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .where( f -&gt; f.match()
                .field( <span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span> ).field( <span class="string"><span class="delimiter">&quot;</span><span class="content">description</span><span class="delimiter">&quot;</span></span> )
                .matching( <span class="string"><span class="delimiter">&quot;</span><span class="content">robot</span><span class="delimiter">&quot;</span></span> ) )
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .where( f -&gt; f.match()
                .fields( <span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">description</span><span class="delimiter">&quot;</span></span> )
                .matching( <span class="string"><span class="delimiter">&quot;</span><span class="content">robot</span><span class="delimiter">&quot;</span></span> ) )
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>It is possible to boost the score of each field separately;
see <a href="#search-dsl-predicate-common-boost">Boosting the score of a predicate</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="search-dsl-predicate-common-score"><a class="anchor" href="#search-dsl-predicate-common-score"></a>Tuning the score</h5>
<div class="paragraph">
<p>Each predicate yields a score if it matched the document.
The more relevant a document for a given predicate, the higher the score.</p>
</div>
<div class="paragraph">
<p>That score can be used when <a href="#search-dsl-sort-score">sorting by score</a> (which is the default)
to get more relevant hits at the top of the result list.</p>
</div>
<div class="paragraph">
<p>Below are a few ways to tune the score, and thus to get the most of the relevance sort.</p>
</div>
<div class="sect5">
<h6 id="search-dsl-predicate-common-boost"><a class="anchor" href="#search-dsl-predicate-common-boost"></a>Boosting the score of a predicate</h6>
<div class="paragraph">
<p>The score of each predicate may be assigned a multiplier, called a <em>boost</em>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>if a given predicate is more relevant to your search query than other predicates,
assigning it a <a href="#search-dsl-predicate-common-boost">boost</a> (multiplier) higher than 1
will increase its impact on the total document score.</p>
</li>
<li>
<p>if a given predicate is less relevant to your search query than other predicates,
assigning it a <a href="#search-dsl-predicate-common-boost">boost</a> (multiplier) lower than 1
will decrease its impact on the total document score.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The boost should always be higher than 0.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Below is an example with the <a href="#search-dsl-predicate-match"><code>match</code> predicate</a>.</p>
</div>
<div class="exampleblock">
<div class="title">Example 267. Boosting on a per-predicate basis</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .where( f -&gt; f.and(
                f.match()
                        .field( <span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span> )
                        .matching( <span class="string"><span class="delimiter">&quot;</span><span class="content">robot</span><span class="delimiter">&quot;</span></span> )
                        .boost( <span class="float">2.0f</span> ),
                f.match()
                        .field( <span class="string"><span class="delimiter">&quot;</span><span class="content">description</span><span class="delimiter">&quot;</span></span> )
                        .matching( <span class="string"><span class="delimiter">&quot;</span><span class="content">self-aware</span><span class="delimiter">&quot;</span></span> )
        ) )
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>For predicates targeting multiple fields,
it is also possible to assign more importance to matches on a given field (or set of fields)
by calling <code>.boost(&#8230;&#8203;)</code> after the call to <code>.field(&#8230;&#8203;)</code>/<code>.fields(&#8230;&#8203;)</code>.</p>
</div>
<div class="paragraph">
<p>Below is an example with the <a href="#search-dsl-predicate-match"><code>match</code> predicate</a>.</p>
</div>
<div class="exampleblock">
<div class="title">Example 268. Boosting on a per-field basis</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .where( f -&gt; f.match()
                .field( <span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span> ).boost( <span class="float">2.0f</span> )
                .field( <span class="string"><span class="delimiter">&quot;</span><span class="content">description</span><span class="delimiter">&quot;</span></span> )
                .matching( <span class="string"><span class="delimiter">&quot;</span><span class="content">robot</span><span class="delimiter">&quot;</span></span> ) )
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect5">
<h6 id="search-dsl-predicate-common-constantScore"><a class="anchor" href="#search-dsl-predicate-common-constantScore"></a>Variable and constant score</h6>
<div class="paragraph">
<p>Some predicates already have a constant score by default, because a variable score doesn&#8217;t make sense for them.
For example, the <a href="#search-dsl-predicate-id"><code>id</code> predicate</a> has a constant score by default.</p>
</div>
<div class="paragraph">
<p>Predicates with a constant score have an "all-or-nothing" impact on the total document score:
either a document matches and it will benefit from the score of this predicate
(<code>1.0f</code> by default, but it can be <a href="#search-dsl-predicate-common-boost">boosted</a>),
or it doesn&#8217;t match and it won&#8217;t benefit from the score of this predicate.</p>
</div>
<div class="paragraph">
<p>Predicates with a variable score have a more subtle impact on the score.
For example the <a href="#search-dsl-predicate-match"><code>match</code> predicate</a>, on a text field,
will yield a higher score for documents that contain the term to match multiple times.</p>
</div>
<div class="paragraph">
<p>When this "variable score" behavior is not desired,
you can suppress it by calling <code>.constantScore()</code>.
This may be useful if only the fact that the predicate matched is relevant,
but not the content of the document.</p>
</div>
<div class="paragraph">
<p>Below is an example with the <a href="#search-dsl-predicate-match"><code>match</code> predicate</a>.</p>
</div>
<div class="exampleblock">
<div class="title">Example 269. Making the score of a predicate constant</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .where( f -&gt; f.and(
                f.match()
                        .field( <span class="string"><span class="delimiter">&quot;</span><span class="content">genre</span><span class="delimiter">&quot;</span></span> )
                        .matching( Genre.SCIENCE_FICTION )
                        .constantScore(),
                f.match()
                        .field( <span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span> )
                        .matching( <span class="string"><span class="delimiter">&quot;</span><span class="content">robot</span><span class="delimiter">&quot;</span></span> )
                        .boost( <span class="float">2.0f</span> )
        ) )
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Alternatively, you can take advantage of
the <a href="#search-dsl-predicate-boolean-filter">filter</a> clause in boolean predicates,
which is equivalent to a <code>must</code> clause but completely suppresses the impact of the clause on the score.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect4">
<h5 id="search-dsl-predicate-common-overriding-analysis"><a class="anchor" href="#search-dsl-predicate-common-overriding-analysis"></a>Overriding analysis</h5>
<div class="paragraph">
<p>In some cases it might be necessary to use a different analyzer to analyze searched text
than the one used to analyze indexed text.</p>
</div>
<div class="paragraph">
<p>This can be achieved by calling <code>.analyzer(&#8230;&#8203;)</code> and passing the name of the analyzer to use.</p>
</div>
<div class="paragraph">
<p>Below is an example with the <a href="#search-dsl-predicate-match"><code>match</code> predicate</a>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
If you always apply the same analyzer when searching,
you might want to configure a <a href="#mapping-directfieldmapping-search-analyzer">search analyzer</a>
on your field instead. Then you won&#8217;t need to use <code>.analyzer(&#8230;&#8203;)</code> when searching.
</td>
</tr>
</table>
</div>
<div class="exampleblock">
<div class="title">Example 270. Matching a value, analyzing it with a different analyzer</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .where( f -&gt; f.match()
                .field( <span class="string"><span class="delimiter">&quot;</span><span class="content">title_autocomplete</span><span class="delimiter">&quot;</span></span> )
                .matching( <span class="string"><span class="delimiter">&quot;</span><span class="content">robo</span><span class="delimiter">&quot;</span></span> )
                .analyzer( <span class="string"><span class="delimiter">&quot;</span><span class="content">autocomplete_query</span><span class="delimiter">&quot;</span></span> ) )
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>If you need to disable analysis of searched text completely,
call <code>.skipAnalysis()</code>.</p>
</div>
<div class="exampleblock">
<div class="title">Example 271. Matching a value without analyzing it</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .where( f -&gt; f.match()
                .field( <span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span> )
                .matching( <span class="string"><span class="delimiter">&quot;</span><span class="content">robot</span><span class="delimiter">&quot;</span></span> )
                .skipAnalysis() )
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="search-dsl-sort"><a class="anchor" href="#search-dsl-sort"></a>15.3. <a id="query-sorting"></a> Sort DSL</h3>
<div class="sect3">
<h4 id="search-dsl-sort-concepts"><a class="anchor" href="#search-dsl-sort-concepts"></a>15.3.1. Basics</h4>
<div class="paragraph">
<p>By default, query results are sorted by <a href="#search-dsl-sort-score">matching score (relevance)</a>.
Other sorts, including the sort by field value, can be configured when building the search query:</p>
</div>
<div class="exampleblock">
<div class="title">Example 272. Using custom sorts</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">SearchSession searchSession = <span class="comment">/* ... */</span> <i class="conum" data-value="1"></i><b>(1)</b>

<span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; result = searchSession.search( <span class="predefined-type">Book</span>.class ) <i class="conum" data-value="2"></i><b>(2)</b>
        .where( f -&gt; f.matchAll() )
        .sort( f -&gt; f.field( <span class="string"><span class="delimiter">&quot;</span><span class="content">pageCount</span><span class="delimiter">&quot;</span></span> ).desc() <i class="conum" data-value="3"></i><b>(3)</b>
                .then().field( <span class="string"><span class="delimiter">&quot;</span><span class="content">title_sort</span><span class="delimiter">&quot;</span></span> ) )
        .fetchHits( <span class="integer">20</span> ); <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><a href="#entrypoints-search-session">Retrieve the <code>SearchSession</code></a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Start building the query as usual.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Mention that the results of the query are expected to be sorted on field "pageCount" in descending order,
then (for those with the same page count) on field "title_sort" in ascending order.
If the field does not exist or cannot be sorted on, an exception will be thrown.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Fetch the results, which will be sorted according to instructions.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>Alternatively, if you don&#8217;t want to use lambdas:</p>
</div>
<div class="exampleblock">
<div class="title">Example 273. Using custom sorts&#8201;&#8212;&#8201;object-based syntax</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">SearchSession searchSession = <span class="comment">/* ... */</span>

SearchScope&lt;<span class="predefined-type">Book</span>&gt; scope = searchSession.scope( <span class="predefined-type">Book</span>.class );

<span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; result = searchSession.search( scope )
        .where( scope.predicate().matchAll().toPredicate() )
        .sort( scope.sort()
                .field( <span class="string"><span class="delimiter">&quot;</span><span class="content">pageCount</span><span class="delimiter">&quot;</span></span> ).desc()
                .then().field( <span class="string"><span class="delimiter">&quot;</span><span class="content">title_sort</span><span class="delimiter">&quot;</span></span> )
                .toSort() )
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>In order to use sorts based on the value of a given field,
you need to mark the field as <a href="#mapping-directfieldmapping-sortable">sortable</a> in the mapping.</p>
</div>
<div class="paragraph">
<p>This is not possible for full-text fields (multi-word text fields), in particular;
see <a href="#mapping-directfieldmapping-annotations-fulltextfield">here</a> for an explanation and some solutions.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The sort DSL offers more sort types, and multiple options for each type of sort.
To learn more about the <code>field</code> sort, and all the other types of sort,
refer to the following sections.</p>
</div>
</div>
<div class="sect3">
<h4 id="search-dsl-sort-score"><a class="anchor" href="#search-dsl-sort-score"></a>15.3.2. <code>score</code>: sort by matching score (relevance)</h4>
<div class="paragraph">
<p><code>score</code> sorts on the score of each document:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>in descending order (the default), documents with a higher score appear first in the list of hits.</p>
</li>
<li>
<p>in ascending order, documents with a lower score appear first in the list of hits.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The score is computed differently for each query,
but roughly speaking you can consider that a higher score means that more <a href="#search-dsl-predicate">predicates</a>
were matched, or they were matched better.
Thus, the score of a given document is a representation of how relevant that document is to a particular query.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>To get the most out of a sort by score, you will need
to <a href="#search-dsl-predicate-common-score">assign weight to your predicates by boosting some of them</a>.</p>
</div>
<div class="paragraph">
<p>Advanced users may even want to change the scoring formula by specifying a different <a href="#backend-lucene-analysis-similarity">Similarity</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Sorting by score is the default, so it&#8217;s generally not necessary to ask for a sort by score explicitly,
but below is an example of how you can do it.</p>
</div>
<div class="exampleblock">
<div class="title">Example 274. Sorting by relevance</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .where( f -&gt; f.match().field( <span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span> )
                .matching( <span class="string"><span class="delimiter">&quot;</span><span class="content">robot dawn</span><span class="delimiter">&quot;</span></span> ) )
        .sort( f -&gt; f.score() )
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="search-dsl-sort-score-options"><a class="anchor" href="#search-dsl-sort-score-options"></a>Options</h5>
<div class="ulist">
<ul>
<li>
<p>You can sort by ascending score by <a href="#search-dsl-sort-common-order">changing the sort order</a>.
However, this means the least relevant hits will appear first,
which is completely pointless. This option is only provided for completeness.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="search-dsl-sort-index-order"><a class="anchor" href="#search-dsl-sort-index-order"></a>15.3.3. <code>indexOrder</code>: sort according to the order of documents on storage</h4>
<div class="paragraph">
<p><code>indexOrder</code> sorts on the position of documents on internal storage.</p>
</div>
<div class="paragraph">
<p>This sort is not predictable, but is the most efficient.
Use it when performance matters more than the order of hits.</p>
</div>
<div class="exampleblock">
<div class="title">Example 275. Sorting according to the order of documents on storage</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .where( f -&gt; f.matchAll() )
        .sort( f -&gt; f.indexOrder() )
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<code>indexOrder</code> should <strong>not</strong> be used to stabilize sorts.
That&#8217;s because the index order may change when the index is updated,
or even without any change, after index segments are <a href="#backend-lucene-io-merge">merged</a>.
See <a href="#search-dsl-sort-stabilize">Stabilizing a sort</a> for a solution to unstable sorts.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="search-dsl-sort-field"><a class="anchor" href="#search-dsl-sort-field"></a>15.3.4. <code>field</code>: sort by field values</h4>
<div class="paragraph">
<p><code>field</code> sorts on the value of a given field for each document.</p>
</div>
<div id="search-dsl-sort-field-prerequisites" class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>In order to use sorts based on the value of a given field,
you need to mark the field as <a href="#mapping-directfieldmapping-sortable">sortable</a> in the mapping.</p>
</div>
<div class="paragraph">
<p>This is not possible for full-text fields (multi-word text fields), in particular;
see <a href="#mapping-directfieldmapping-annotations-fulltextfield">here</a> for an explanation and some solutions.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The values of <a href="#mapping-geopoint">GeoPoint</a> fields cannot be compared directly
and thus the <code>field</code> sort cannot be used on those fields.</p>
</div>
<div class="paragraph">
<p>Refer to the <a href="#search-dsl-sort-distance">distance sort</a> for these fields.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The sort order is defined as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>in ascending order (the default), documents with a lower value appear first in the list of hits.</p>
</li>
<li>
<p>in descending order, documents with a higher value appear first in the list of hits.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>For text fields, "lower" means "lower in the alphabetical order".</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="search-dsl-sort-field-syntax"><a class="anchor" href="#search-dsl-sort-field-syntax"></a>Syntax</h5>
<div class="exampleblock">
<div class="title">Example 276. Sorting by field values</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .where( f -&gt; f.matchAll() )
        .sort( f -&gt; f.field( <span class="string"><span class="delimiter">&quot;</span><span class="content">title_sort</span><span class="delimiter">&quot;</span></span> ) )
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="search-dsl-sort-field-options"><a class="anchor" href="#search-dsl-sort-field-options"></a>Options</h5>
<div class="ulist">
<ul>
<li>
<p>The sort order is ascending by default,
but can be <a href="#search-dsl-sort-common-order">controlled explicitly with <code>.asc()</code>/<code>.desc()</code></a>.</p>
</li>
<li>
<p>The behavior on missing values
can be <a href="#search-dsl-sort-common-missing">controlled explicitly with <code>.missing()</code></a>.</p>
</li>
<li>
<p>The behavior on multivalued fields
can be <a href="#search-dsl-sort-common-multi-value-mode">controlled explicitly with <code>.mode(&#8230;&#8203;)</code></a>.</p>
</li>
<li>
<p>For fields in nested objects, all nested objects are considered by default,
but that can be <a href="#search-dsl-sort-common-filter">controlled explicitly with <code>.filter(&#8230;&#8203;)</code></a>.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="search-dsl-sort-distance"><a class="anchor" href="#search-dsl-sort-distance"></a>15.3.5. <code>distance</code>: sort by distance to a point</h4>
<div class="paragraph">
<p><code>distance</code> sorts on the distance from a given center to the geo-point value of a given field for each document.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>in ascending order (the default), documents with a lower distance appear first in the list of hits.</p>
</li>
<li>
<p>in descending order, documents with a higher distance appear first in the list of hits.</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="search-dsl-sort-distance-prerequisites"><a class="anchor" href="#search-dsl-sort-distance-prerequisites"></a>Prerequisites</h5>
<div class="paragraph">
<p>In order for the <code>distance</code> sort to be available on a given field,
you need to mark the field as <a href="#mapping-directfieldmapping-sortable">sortable</a> in the mapping.</p>
</div>
</div>
<div class="sect4">
<h5 id="search-dsl-sort-distance-syntax"><a class="anchor" href="#search-dsl-sort-distance-syntax"></a>Syntax</h5>
<div class="exampleblock">
<div class="title">Example 277. Sorting by distance to a point</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">GeoPoint center = GeoPoint.of( <span class="float">47.506060</span>, <span class="float">2.473916</span> );
<span class="predefined-type">List</span>&lt;Author&gt; hits = searchSession.search( Author.class )
        .where( f -&gt; f.matchAll() )
        .sort( f -&gt; f.distance( <span class="string"><span class="delimiter">&quot;</span><span class="content">placeOfBirth</span><span class="delimiter">&quot;</span></span>, center ) )
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="search-dsl-sort-distance-options"><a class="anchor" href="#search-dsl-sort-distance-options"></a>Options</h5>
<div class="ulist">
<ul>
<li>
<p>The sort order is ascending by default,
but can be <a href="#search-dsl-sort-common-order">controlled explicitly with <code>.asc()</code>/<code>.desc()</code></a>.</p>
</li>
<li>
<p>The behavior on multivalued fields
can be <a href="#search-dsl-sort-common-multi-value-mode">controlled explicitly with <code>.mode(&#8230;&#8203;)</code></a>.</p>
</li>
<li>
<p>For fields in nested objects, all nested objects are considered by default,
but that can be <a href="#search-dsl-sort-common-filter">controlled explicitly with <code>.filter(&#8230;&#8203;)</code></a>.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="search-dsl-sort-composite"><a class="anchor" href="#search-dsl-sort-composite"></a>15.3.6. <code>composite</code>: combine sorts</h4>
<div class="paragraph">
<p><code>composite</code> applies multiple sorts one after the other.
It is useful when applying incomplete sorts.</p>
</div>
<div class="exampleblock">
<div class="title">Example 278. Sorting by multiple composed sorts using <code>composite()</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .where( f -&gt; f.matchAll() )
        .sort( f -&gt; f.composite() <i class="conum" data-value="1"></i><b>(1)</b>
                .add( f.field( <span class="string"><span class="delimiter">&quot;</span><span class="content">genre_sort</span><span class="delimiter">&quot;</span></span> ) ) <i class="conum" data-value="2"></i><b>(2)</b>
                .add( f.field( <span class="string"><span class="delimiter">&quot;</span><span class="content">title_sort</span><span class="delimiter">&quot;</span></span> ) ) ) <i class="conum" data-value="3"></i><b>(3)</b>
        .fetchHits( <span class="integer">20</span> ); <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Start a <code>composite</code> sort.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Add a <code>field</code> sort on the <code>genre_sort</code> field.
Since many books share the same genre, this sort is incomplete:
the relative order of books with the same genre is undetermined,
and may change from one query execution to the other.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Add a <code>field</code> sort on the <code>title_sort</code> field.
When two books have the same genre,
their relative order will be determined by comparing their titles.
If two books can have the same title,
we can <a href="#search-dsl-sort-stabilize">stabilize the sort even further by adding a last sort on the id</a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The hits will be sorted by genre, then by title.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>Alternatively, you can append a sort to another simply by calling <code>.then()</code> after the first sort:</p>
</div>
<div class="exampleblock">
<div class="title">Example 279. Sorting by multiple composed sorts using <code>then()</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .where( f -&gt; f.matchAll() )
        .sort( f -&gt; f.field( <span class="string"><span class="delimiter">&quot;</span><span class="content">genre_sort</span><span class="delimiter">&quot;</span></span> )
                .then().field( <span class="string"><span class="delimiter">&quot;</span><span class="content">title_sort</span><span class="delimiter">&quot;</span></span> ) )
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="search-dsl-sort-composite-lambda"><a class="anchor" href="#search-dsl-sort-composite-lambda"></a>Adding sorts dynamically with the lambda syntax</h5>
<div class="paragraph">
<p>It is possible to define the <code>composite</code> sort inside a lambda expression.
This is especially useful when inner sorts need to be added dynamically to the <code>composite</code> sort,
for example based on user input.</p>
</div>
<div class="exampleblock">
<div class="title">Example 280. Easily composing sorts dynamically with the lambda syntax</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">MySearchParameters searchParameters = getSearchParameters(); <i class="conum" data-value="1"></i><b>(1)</b>
<span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .where( f -&gt; f.matchAll() )
        .sort( f -&gt; f.composite( b -&gt; { <i class="conum" data-value="2"></i><b>(2)</b>
            <span class="keyword">for</span> ( MySort mySort : searchParameters.getSorts() ) { <i class="conum" data-value="3"></i><b>(3)</b>
                <span class="keyword">switch</span> ( mySort.getType() ) {
                    <span class="keyword">case</span> GENRE:
                        b.add( f.field( <span class="string"><span class="delimiter">&quot;</span><span class="content">genre_sort</span><span class="delimiter">&quot;</span></span> ).order( mySort.getOrder() ) );
                        <span class="keyword">break</span>;
                    <span class="keyword">case</span> TITLE:
                        b.add( f.field( <span class="string"><span class="delimiter">&quot;</span><span class="content">title_sort</span><span class="delimiter">&quot;</span></span> ).order( mySort.getOrder() ) );
                        <span class="keyword">break</span>;
                    <span class="keyword">case</span> PAGE_COUNT:
                        b.add( f.field( <span class="string"><span class="delimiter">&quot;</span><span class="content">pageCount</span><span class="delimiter">&quot;</span></span> ).order( mySort.getOrder() ) );
                        <span class="keyword">break</span>;
                }
            }
        } ) )
        .fetchHits( <span class="integer">20</span> ); <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Get a custom object holding the search parameters provided by the user through a web form, for example.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Call <code>.composite(Consumer)</code>.
The consumer, implemented by a lambda expression, will receive a builder as an argument
and will add sorts to that builder as necessary.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Inside the lambda, the code is free to do whatever is necessary before adding sorts.
In this case, we iterate over user-selected sorts and add sorts accordingly.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The hits will be sorted according to sorts added by the lambda expression.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="search-dsl-sort-stabilize"><a class="anchor" href="#search-dsl-sort-stabilize"></a>Stabilizing a sort</h5>
<div class="paragraph">
<p>If your first sort (e.g. by <a href="#search-dsl-sort-field">field value</a>)
results in a tie for many documents (e.g. many documents have the same field value),
you may want to append an arbitrary sort just to stabilize your sort:
to make sure the search hits will always be in the same order if you execute the same query.</p>
</div>
<div class="paragraph">
<p>In most cases, a quick and easy solution for stabilizing a sort is
to change your mapping to add a <a href="#mapping-directfieldmapping-sortable">sortable field</a> on your entity ID,
and to append a <code>field</code> sort by id to your unstable sort:</p>
</div>
<div class="exampleblock">
<div class="title">Example 281. Stabilizing a sort</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .where( f -&gt; f.matchAll() )
        .sort( f -&gt; f.field( <span class="string"><span class="delimiter">&quot;</span><span class="content">genre_sort</span><span class="delimiter">&quot;</span></span> ).then().field( <span class="string"><span class="delimiter">&quot;</span><span class="content">id_sort</span><span class="delimiter">&quot;</span></span> ) )
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="search-dsl-sort-extensions"><a class="anchor" href="#search-dsl-sort-extensions"></a>15.3.7. Backend-specific extensions</h4>
<div class="paragraph">
<p>By calling <code>.extension(&#8230;&#8203;)</code> while building a query,
it is possible to access backend-specific sorts.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>As their name suggests, backend-specific sorts are not portable from one backend technology to the other.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="search-dsl-sort-extensions-lucene-from-lucene-sort"><a class="anchor" href="#search-dsl-sort-extensions-lucene-from-lucene-sort"></a>Lucene: <code>fromLuceneSort</code></h5>
<div class="paragraph">
<p><code>.fromLuceneSort(&#8230;&#8203;)</code> turns a native Lucene <code>Sort</code> into a Hibernate Search sort.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This feature implies that application code rely on Lucene APIs directly.</p>
</div>
<div class="paragraph">
<p>An upgrade of Hibernate Search, even for a bugfix (micro) release,
may require an upgrade of Lucene,
which may lead to breaking API changes in Lucene.</p>
</div>
<div class="paragraph">
<p>If this happens, you will need to change application code to deal with the changes.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="exampleblock">
<div class="title">Example 282. Sorting by a native <code>org.apache.lucene.search.Sort</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .extension( LuceneExtension.get() )
        .where( f -&gt; f.matchAll() )
        .sort( f -&gt; f.fromLuceneSort(
                <span class="keyword">new</span> Sort(
                        <span class="keyword">new</span> SortedSetSortField( <span class="string"><span class="delimiter">&quot;</span><span class="content">genre_sort</span><span class="delimiter">&quot;</span></span>, <span class="predefined-constant">false</span> ),
                        <span class="keyword">new</span> SortedSetSortField( <span class="string"><span class="delimiter">&quot;</span><span class="content">title_sort</span><span class="delimiter">&quot;</span></span>, <span class="predefined-constant">false</span> )
                )
        ) )
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="search-dsl-sort-extensions-lucene-from-lucene-sort-field"><a class="anchor" href="#search-dsl-sort-extensions-lucene-from-lucene-sort-field"></a><a id="_using_native_sorts_within_the_sort_dsl"></a> Lucene: <code>fromLuceneSortField</code></h5>
<div class="paragraph">
<p><code>.fromLuceneSortField(&#8230;&#8203;)</code> turns a native Lucene <code>SortField</code> into a Hibernate Search sort.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This feature implies that application code rely on Lucene APIs directly.</p>
</div>
<div class="paragraph">
<p>An upgrade of Hibernate Search, even for a bugfix (micro) release,
may require an upgrade of Lucene,
which may lead to breaking API changes in Lucene.</p>
</div>
<div class="paragraph">
<p>If this happens, you will need to change application code to deal with the changes.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="exampleblock">
<div class="title">Example 283. Sorting by a native <code>org.apache.lucene.search.SortField</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .extension( LuceneExtension.get() )
        .where( f -&gt; f.matchAll() )
        .sort( f -&gt; f.fromLuceneSortField(
                <span class="keyword">new</span> SortedSetSortField( <span class="string"><span class="delimiter">&quot;</span><span class="content">title_sort</span><span class="delimiter">&quot;</span></span>, <span class="predefined-constant">false</span> )
        ) )
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="search-dsl-sort-extensions-elasticsearch-from-json"><a class="anchor" href="#search-dsl-sort-extensions-elasticsearch-from-json"></a>Elasticsearch: <code>fromJson</code></h5>
<div class="paragraph">
<p><code>.fromJson(&#8230;&#8203;)</code> turns JSON representing an Elasticsearch sort into a Hibernate Search sort.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This feature requires to directly manipulate JSON in application code.</p>
</div>
<div class="paragraph">
<p>The syntax of this JSON may change:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>when you upgrade the underlying Elasticsearch cluster to the next version;</p>
</li>
<li>
<p>when you upgrade Hibernate Search to the next version, even for a bugfix (micro) release.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If this happens, you will need to change application code to deal with the changes.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="exampleblock">
<div class="title">Example 284. Sorting by a native Elasticsearch JSON sort provided as a <code>JsonObject</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">JsonObject jsonObject =
<span class="comment">/* ... */</span>;
<span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .extension( ElasticsearchExtension.get() )
        .where( f -&gt; f.matchAll() )
        .sort( f -&gt; f.fromJson( jsonObject ) )
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 285. Sorting by a native Elasticsearch JSON sort provided as a JSON-formatted string</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .extension( ElasticsearchExtension.get() )
        .where( f -&gt; f.matchAll() )
        .sort( f -&gt; f.fromJson( <span class="string"><span class="delimiter">&quot;</span><span class="content">{</span><span class="delimiter">&quot;</span></span>
                + <span class="string"><span class="delimiter">&quot;</span><span class="content">     </span><span class="char">\&quot;</span><span class="content">title_sort</span><span class="char">\&quot;</span><span class="content">: </span><span class="char">\&quot;</span><span class="content">asc</span><span class="char">\&quot;</span><span class="delimiter">&quot;</span></span>
                + <span class="string"><span class="delimiter">&quot;</span><span class="content">}</span><span class="delimiter">&quot;</span></span> ) )
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="search-dsl-sort-common"><a class="anchor" href="#search-dsl-sort-common"></a>15.3.8. Options common to multiple sort types</h4>
<div class="sect4">
<h5 id="search-dsl-sort-common-order"><a class="anchor" href="#search-dsl-sort-common-order"></a>Sort order</h5>
<div class="paragraph">
<p>Most sorts use the ascending order by default, with the notable exception of the <a href="#search-dsl-sort-score">score sort</a>.</p>
</div>
<div class="paragraph">
<p>The order controlled explicitly through the following options:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>.asc()</code> for an ascending order.</p>
</li>
<li>
<p><code>.desc()</code> for a descending order.</p>
</li>
<li>
<p><code>.order(&#8230;&#8203;)</code> for an order defined by the given argument: <code>SortOrder.ASC</code>/<code>SortOrder.DESC</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Below are a few examples with the <a href="#search-dsl-sort-field">field sort</a>.</p>
</div>
<div class="exampleblock">
<div class="title">Example 286. Sorting by field values in explicitly ascending order with <code>asc()</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .where( f -&gt; f.matchAll() )
        .sort( f -&gt; f.field( <span class="string"><span class="delimiter">&quot;</span><span class="content">title_sort</span><span class="delimiter">&quot;</span></span> ).asc() )
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 287. Sorting by field values in explicitly descending order with <code>desc()</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .where( f -&gt; f.matchAll() )
        .sort( f -&gt; f.field( <span class="string"><span class="delimiter">&quot;</span><span class="content">title_sort</span><span class="delimiter">&quot;</span></span> ).desc() )
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 288. Sorting by field values in explicitly descending order with <code>order(&#8230;&#8203;)</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .where( f -&gt; f.matchAll() )
        .sort( f -&gt; f.field( <span class="string"><span class="delimiter">&quot;</span><span class="content">title_sort</span><span class="delimiter">&quot;</span></span> ).order( SortOrder.DESC ) )
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="search-dsl-sort-common-missing"><a class="anchor" href="#search-dsl-sort-common-missing"></a><a id="_handling_missing_values"></a> Missing values</h5>
<div class="paragraph">
<p>By default:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>For <a href="#search-dsl-sort-field">sorts by field values</a>, the documents that do not have any value for a sort field
will appear in the last position.</p>
</li>
<li>
<p>For <a href="#search-dsl-sort-distance">sorts by distance to a point</a>, the documents that do not have any value for a sort field
will be treated as if their distance from the given point was infinite.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The behavior for missing values can be controlled explicitly through the <code>.missing()</code> option:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>.missing().first()</code> puts documents with no value in first position (regardless of the sort order).</p>
</li>
<li>
<p><code>.missing().last()</code> puts documents with no value in last position (regardless of the sort order).</p>
</li>
<li>
<p><code>.missing().lowest()</code> interprets missing values as the lowest value:
it puts documents with no value in the first position when using ascending order or in the last position when using descending order.</p>
</li>
<li>
<p><code>.missing().highest()</code> interprets missing values as the highest value:
it puts documents with no value in the last position when using ascending order or in the first position when using descending order.</p>
</li>
<li>
<p><code>.missing().use(&#8230;&#8203;)</code> uses the given value as a default for documents with no value.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>All these options are supported for sorts by field values and sorts by distance to a point
using the Lucene backend.</p>
</div>
<div class="paragraph">
<p>When sorting by distance to a point using the Elasticsearch backend, due to limitations of the Elasticsearch APIs,
only the following combinations are supported:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>.missing().first()</code> using a descending order.</p>
</li>
<li>
<p><code>.missing().last()</code> using an ascending order.</p>
</li>
<li>
<p><code>.missing().highest()</code> using either an ascending or a descending order.</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Below are a few examples with the <a href="#search-dsl-sort-field">field sort</a>.</p>
</div>
<div class="exampleblock">
<div class="title">Example 289. Sorting by field values, documents with no value in first position</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .where( f -&gt; f.matchAll() )
        .sort( f -&gt; f.field( <span class="string"><span class="delimiter">&quot;</span><span class="content">pageCount</span><span class="delimiter">&quot;</span></span> ).missing().first() )
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 290. Sorting by field values, documents with no value in last position</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .where( f -&gt; f.matchAll() )
        .sort( f -&gt; f.field( <span class="string"><span class="delimiter">&quot;</span><span class="content">pageCount</span><span class="delimiter">&quot;</span></span> ).missing().last() )
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 291. Sorting by field values, documents with no value using a given default value</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .where( f -&gt; f.matchAll() )
        .sort( f -&gt; f.field( <span class="string"><span class="delimiter">&quot;</span><span class="content">pageCount</span><span class="delimiter">&quot;</span></span> ).missing().use( <span class="integer">300</span> ) )
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
</div>
</div>
<div class="sect5">
<h6 id="search-dsl-sort-common-missing-argument-type"><a class="anchor" href="#search-dsl-sort-common-missing-argument-type"></a>Expected type of arguments</h6>
<div class="paragraph">
<p>By default, <code>.use(&#8230;&#8203;)</code> expects its argument to have the same type as
the entity property corresponding to the target field.</p>
</div>
<div class="paragraph">
<p>For example, if an entity property is of type <code>java.util.Date</code>,
<a href="#mapping-directfieldmapping-supported-types">the corresponding field may be of type <code>java.time.Instant</code></a>.
<code>.use(&#8230;&#8203;)</code> will expect its argument to be of type <code>java.util.Date</code> regardless.</p>
</div>
<div class="paragraph">
<p>This should generally be what you want,
but if you ever need to bypass conversion and pass an unconverted argument
(of type <code>java.time.Instant</code> in the example above)
to <code>.use(&#8230;&#8203;)</code>, see <a href="#search-dsl-argument-type">Type of arguments passed to the DSL</a>.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="search-dsl-sort-common-multi-value-mode"><a class="anchor" href="#search-dsl-sort-common-multi-value-mode"></a>Sort mode for multivalued fields</h5>
<div class="paragraph">
<p>Documents that have multiple values for a sort field can be sorted too.
A single value is picked for each document in order to compare it with order documents.
How the value is picked is called the <strong>sort mode</strong>, specified using the <code>.mode(&#8230;&#8203;)</code> option.
The following sort modes are available:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Mode</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Description</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Supported value types</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Unsupported value types</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>SortMode.MIN</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Picks the lowest value for field sorts, the lowest distance for distance sorts.</p>
<p class="tableblock">This is default for ascending sorts.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">All.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>SortMode.MAX</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Picks the highest value for field sorts, the highest distance for distance sorts.</p>
<p class="tableblock">This is default for descending sorts.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">All.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>SortMode.SUM</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Computes the sum of all values for each document,
and picks that sum for comparison with other documents.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Numeric fields (<code>long</code>, &#8230;&#8203;).</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Text and temporal fields (<code>String</code>, <code>LocalDate</code>, &#8230;&#8203;), <a href="#search-dsl-sort-distance">distance</a>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>SortMode.AVG</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Computes the <a href="https://en.wikipedia.org/wiki/Arithmetic_mean">arithmetic mean</a> of all values for each document
and picks that average for comparison with other documents.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Numeric and temporal fields (<code>long</code>, <code>LocalDate</code>, &#8230;&#8203;), <a href="#search-dsl-sort-distance">distance</a>.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Text fields (<code>String</code>, &#8230;&#8203;).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>SortMode.MEDIAN</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Computes the <a href="https://en.wikipedia.org/wiki/Median">median</a> of all values for each document,
and picks that median for comparison with other documents.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Numeric and temporal fields (<code>long</code>, <code>LocalDate</code>, &#8230;&#8203;), <a href="#search-dsl-sort-distance">distance</a>.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Text fields (<code>String</code>, &#8230;&#8203;).</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Below is an example with the <a href="#search-dsl-sort-field">field sort</a>.</p>
</div>
<div class="exampleblock">
<div class="title">Example 292. Sorting by field values using the average value for each document</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;Author&gt; hits = searchSession.search( Author.class )
        .where( f -&gt; f.matchAll() )
        .sort( f -&gt; f.field( <span class="string"><span class="delimiter">&quot;</span><span class="content">books.pageCount</span><span class="delimiter">&quot;</span></span> ).mode( SortMode.AVG ) )
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="search-dsl-sort-common-filter"><a class="anchor" href="#search-dsl-sort-common-filter"></a>Filter for fields in nested objects</h5>
<div class="paragraph">
<p>When the sort field is located in a <a href="#mapping-indexedembedded-structure-nested">nested object</a>,
by default all nested objects will be considered for the sort
and their values will be combined using the configured <a href="#search-dsl-sort-common-multi-value-mode">sort mode</a>.</p>
</div>
<div class="paragraph">
<p>It is possible to filter the nested documents whose values will be considered for the sort
using one of the <code>filter(&#8230;&#8203;)</code> methods.</p>
</div>
<div class="paragraph">
<p>Below is an example with the <a href="#search-dsl-sort-field">field sort</a>:
authors are sorted by the average page count of their books,
but only books of the "crime fiction" genre are considered:</p>
</div>
<div class="exampleblock">
<div class="title">Example 293. Sorting by field values using a filter for nested objects</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;Author&gt; hits = searchSession.search( Author.class )
        .where( f -&gt; f.matchAll() )
        .sort( f -&gt; f.field( <span class="string"><span class="delimiter">&quot;</span><span class="content">books.pageCount</span><span class="delimiter">&quot;</span></span> )
                .mode( SortMode.AVG )
                .filter( pf -&gt; pf.match().field( <span class="string"><span class="delimiter">&quot;</span><span class="content">books.genre</span><span class="delimiter">&quot;</span></span> )
                        .matching( Genre.CRIME_FICTION ) ) )
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="search-dsl-projection"><a class="anchor" href="#search-dsl-projection"></a>15.4. <a id="projections"></a> Projection DSL</h3>
<div class="sect3">
<h4 id="search-dsl-projection-concepts"><a class="anchor" href="#search-dsl-projection-concepts"></a>15.4.1. Basics</h4>
<div class="paragraph">
<p>For some use cases, you only need the query to return a small subset of the data contained in your domain object.
In these cases, returning managed entities and extracting data from these entities may be overkill:
extracting the data from the index itself would avoid the database round-trip.</p>
</div>
<div class="paragraph">
<p>Projections do just that: they allow the query to return something more precise than just "the matching entities".
Projections can be configured when building the search query:</p>
</div>
<div class="exampleblock">
<div class="title">Example 294. Using projections to extract data from the index</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">SearchSession searchSession = <span class="comment">/* ... */</span> <i class="conum" data-value="1"></i><b>(1)</b>

<span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt; result = searchSession.search( <span class="predefined-type">Book</span>.class ) <i class="conum" data-value="2"></i><b>(2)</b>
        .select( f -&gt; f.field( <span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">String</span>.class ) ) <i class="conum" data-value="3"></i><b>(3)</b>
        .where( f -&gt; f.matchAll() )
        .fetchHits( <span class="integer">20</span> ); <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><a href="#entrypoints-search-session">Retrieve the <code>SearchSession</code></a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Start building the query as usual.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Mention that the expected result of the query is a projection on field "title", of type String.
If that type is not appropriate or if the field does not exist, an exception will be thrown.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Fetch the results, which will have the expected type.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>Alternatively, if you don&#8217;t want to use lambdas:</p>
</div>
<div class="exampleblock">
<div class="title">Example 295. Using projections to extract data from the index&#8201;&#8212;&#8201;object-based syntax</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">SearchSession searchSession = <span class="comment">/* ... */</span>

SearchScope&lt;<span class="predefined-type">Book</span>&gt; scope = searchSession.scope( <span class="predefined-type">Book</span>.class );

<span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt; result = searchSession.search( scope )
        .select( scope.projection().field( <span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">String</span>.class )
                .toProjection() )
        .where( scope.predicate().matchAll().toPredicate() )
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>In order to use projections based on the value of a given field,
you need to mark the field as <a href="#mapping-directfieldmapping-projectable">projectable</a> in the mapping.</p>
</div>
<div class="paragraph">
<p>This is optional with the <a href="#backend-elasticsearch">Elasticsearch backend</a>,
where all fields are projectable by default.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>While <code>field</code> projections are certainly the most common,
they are not the only type of projection.
Other projections allow
<a href="#search-dsl-projection-composite">composing custom beans containing extracted data</a>,
getting references to the <a href="#search-dsl-projection-documentReference">extracted documents</a>
or the <a href="#search-dsl-projection-reference">corresponding entities</a>,
or getting information related to the search query itself
(<a href="#search-dsl-projection-score">score</a>, &#8230;&#8203;).</p>
</div>
</div>
<div class="sect3">
<h4 id="search-dsl-projection-mapped"><a class="anchor" href="#search-dsl-projection-mapped"></a>15.4.2. Projecting to a custom (annotated) type</h4>
<div class="paragraph">
<p>For more complex projections, it is possible to <a href="#mapping-projection">define a custom (annotated) record or class</a>
and have Hibernate Search infer the corresponding projections from the custom type&#8217;s constructor parameters.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>There are a few constraints to keep in mind when annotating a custom projection type:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The custom projection type must be in the same JAR as entity types,
or Hibernate Search will <a href="#mapping-projection-type-detection">require additional configuration</a>.</p>
</li>
<li>
<p>When projecting on value fields or object fields, the path to the projected field
is inferred from the constructor parameter name by default,
but <a href="#mapping-projection-inner-inference-fieldpath">inference will fail if constructor parameter names are not included in the Java bytecode</a>.
Alternatively the path can be provided explicitly
through <a href="#search-dsl-projection-field-mapping"><code>@FieldProjection(path = &#8230;&#8203;)</code></a>/<a href="#search-dsl-projection-object-mapping"><code>@ObjectProjection(path = &#8230;&#8203;)</code></a>,
in which case Hibernate Search won&#8217;t rely on constructor parameter names.</p>
</li>
<li>
<p>When projecting on value fields, the constraints of the <a href="#search-dsl-projection-field"><code>field</code></a> projection still apply.
In particular, with the <a href="#backend-lucene">Lucene backend</a>, value fields involved in the projection
must be configured as <a href="#mapping-directfieldmapping-projectable">projectable</a>.</p>
</li>
<li>
<p>When projecting on object fields, the constraints of the <a href="#search-dsl-projection-object"><code>object</code></a> projection still apply.
In particular, with the <a href="#backend-lucene">Lucene backend</a>, multi-valued object fields involved in the projection
must be configured as <a href="#mapping-indexedembedded-structure-nested">nested</a>.</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="exampleblock">
<div class="title">Example 296. Using a custom record type to project data from the index</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="annotation">@ProjectionConstructor</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="directive">public</span> record MyBookProjection(
        <span class="annotation">@IdProjection</span> <span class="predefined-type">Integer</span> id, <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="predefined-type">String</span> title, <i class="conum" data-value="3"></i><b>(3)</b>
        <span class="predefined-type">List</span>&lt;MyBookProjection.Author&gt; authors) { <i class="conum" data-value="4"></i><b>(4)</b>
    <span class="annotation">@ProjectionConstructor</span> <i class="conum" data-value="5"></i><b>(5)</b>
    <span class="directive">public</span> record Author(<span class="predefined-type">String</span> firstName, <span class="predefined-type">String</span> lastName) {
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Annotate the record type with <code>@ProjectionConstructor</code>,
either at the type level (if there&#8217;s only one constructor)
or at the constructor level (if there are <a href="#mapping-projection-multiple-constructors">multiple constructors</a>).</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>To project on the entity identifier, annotate the relevant constructor parameter with <a href="#search-dsl-projection-id-mapping"><code>@IdProjection</code></a>.
<div class="paragraph">
<p>Most projections have a corresponding annotation that can be used on constructor parameters.</p>
</div></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>To project on a value field, add a constructor parameter named after that field and with the same type as that field.
See <a href="#mapping-projection-inner-inference"> Implicit inner projection inference</a> for more information on how constructor parameters should be defined.
<div class="paragraph">
<p>Alternatively, the field projection can be configured explicitly with <a href="#search-dsl-projection-field-mapping"><code>@FieldProjection</code></a>.</p>
</div></td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>To project on an object field, add a constructor parameter named after that field and with its own custom projection type.
Multivalued projections <a href="#mapping-projection-inner-inference-type">must be modeled as a <code>List&lt;&#8230;&#8203;&gt;</code></a> or supertype.
<div class="paragraph">
<p>Alternatively, the object projection can be configured explicitly with <a href="#search-dsl-projection-object-mapping"><code>@ObjectProjection</code></a>.</p>
</div></td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Annotate any custom projection type used for object fields with <code>@ProjectionConstructor</code> as well.</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;MyBookProjection&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .select( MyBookProjection.class )<i class="conum" data-value="1"></i><b>(1)</b>
        .where( f -&gt; f.matchAll() )
        .fetchHits( <span class="integer">20</span> ); <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Pass the custom projection type to <code>.select(&#8230;&#8203;)</code>.
Hibernate Search will <a href="#mapping-projection-inner-inference">infer the inner projections</a>
from the custom type&#8217;s constructor parameters.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Each hit will be an instance of the custom projection type,
populated with data retrieved from the index.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Custom, non-record classes can also be annotated with <code>@ProjectionConstructor</code>,
which can be useful if you cannot use records for some reason
(for example because you&#8217;re still using Java 13 or below).</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
For more information about mapping custom projection types, see <a href="#mapping-projection"> Mapping index content to custom types (projection constructors)</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Beside <code>.select(Class&lt;?&gt;)</code>, some projections also allow using custom projection types;
see <a href="#search-dsl-projection-composite-as-mapped">the <code>composite</code> projection</a>
and <a href="#search-dsl-projection-object-as-mapped">the <code>object</code> projection</a>.
For more information about  mapping projection types, see <a href="#mapping-projection"> Mapping index content to custom types (projection constructors)</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="search-dsl-projection-documentReference"><a class="anchor" href="#search-dsl-projection-documentReference"></a>15.4.3. <code>documentReference</code>: return references to matched documents</h4>
<div class="paragraph">
<p>The <code>documentReference</code> projection returns a reference to the matched document as a <code>DocumentReference</code> object.</p>
</div>
<div class="sect4">
<h5 id="search-dsl-projection-documentReference-syntax"><a class="anchor" href="#search-dsl-projection-documentReference-syntax"></a>Syntax</h5>
<div class="exampleblock">
<div class="title">Example 297. Returning references to matched documents</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;DocumentReference&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .select( f -&gt; f.documentReference() )
        .where( f -&gt; f.matchAll() )
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Since it&#8217;s a reference to the <em>document</em>, not the entity,
<code>DocumentReference</code> only exposes low-level concepts such as the type name and the document identifier (a <code>String</code>).
Use the <a href="#search-dsl-projection-reference"><code>entityReference</code></a> projection to get a reference to the entity.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="search-dsl-projection-documentReference-mapping"><a class="anchor" href="#search-dsl-projection-documentReference-mapping"></a><code>@DocumentReferenceProjection</code> in projections to custom types</h5>
<div class="paragraph">
<p>To achieve a <code>documentReference</code> projection inside a <a href="#search-dsl-projection-mapped">projection to an annotated custom type</a>,
use the <code>@DocumentReferenceProjection</code> annotation:</p>
</div>
<div class="exampleblock">
<div class="title">Example 298. Returning references to matched documents within a projection constructor</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="annotation">@ProjectionConstructor</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="directive">public</span> record MyBookDocRefAndTitleProjection(
        <span class="annotation">@DocumentReferenceProjection</span> <i class="conum" data-value="2"></i><b>(2)</b>
        DocumentReference ref, <i class="conum" data-value="3"></i><b>(3)</b>
        <span class="predefined-type">String</span> title <i class="conum" data-value="4"></i><b>(4)</b>
) {
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Annotate the record type with <a href="#mapping-projection-basics"><code>@ProjectionConstructor</code></a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Annotate the parameter that should receive the document reference with <code>@DocumentReferenceProjection</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The type of the constructor parameter must be assignable from <code>DocumentReference</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>You can of course also declare other parameters with different projections;
in this example an <a href="#mapping-projection-inner-inference">inferred projection</a> to the <code>title</code> field.</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;MyBookDocRefAndTitleProjection&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .select( MyBookDocRefAndTitleProjection.class )<i class="conum" data-value="1"></i><b>(1)</b>
        .where( f -&gt; f.matchAll() )
        .fetchHits( <span class="integer">20</span> ); <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Pass the custom projection type to <code>.select(&#8230;&#8203;)</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Each hit will be an instance of the custom projection type,
populated with the requested document reference and field.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>For <a href="#mapping-projection-programmatic">programmatic mapping</a>, use <code>DocumentReferenceProjectionBinder.create()</code>.</p>
</div>
<div class="exampleblock">
<div class="title">Example 299. Programmatic mapping of a <code>documentReference</code> projection within a projection constructor</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">TypeMappingStep myBookDocRefAndTitleProjection =
        mapping.type( MyBookDocRefAndTitleProjection.class );
myBookDocRefAndTitleProjection.mainConstructor()
        .projectionConstructor();
myBookDocRefAndTitleProjection.mainConstructor().parameter( <span class="integer">0</span> )
        .projection( DocumentReferenceProjectionBinder.create() );</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="search-dsl-projection-reference"><a class="anchor" href="#search-dsl-projection-reference"></a>15.4.4. <code>entityReference</code>: return references to matched entities</h4>
<div class="paragraph">
<p>The <code>entityReference</code> projection returns a reference to the matched entity as an <code>EntityReference</code> object.</p>
</div>
<div class="sect4">
<h5 id="search-dsl-projection-reference-syntax"><a class="anchor" href="#search-dsl-projection-reference-syntax"></a>Syntax</h5>
<div class="exampleblock">
<div class="title">Example 300. Returning references to matched entities</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;? <span class="directive">extends</span> EntityReference&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .select( f -&gt; f.entityReference() )
        .where( f -&gt; f.matchAll() )
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The entity does not get loaded as part of the projection.
If you want the actual entity instance, use the <a href="#search-dsl-projection-entity"><code>entity</code> projection</a>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="search-dsl-projection-reference-mapping"><a class="anchor" href="#search-dsl-projection-reference-mapping"></a><code>@EntityReferenceProjection</code> in projections to custom types</h5>
<div class="paragraph">
<p>To achieve an <code>entityReference</code> projection inside a <a href="#search-dsl-projection-mapped">projection to an annotated custom type</a>,
use the <code>@EntityReferenceProjection</code> annotation:</p>
</div>
<div class="exampleblock">
<div class="title">Example 301. Returning references to matched entities within a projection constructor</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="annotation">@ProjectionConstructor</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="directive">public</span> record MyBookEntityRefAndTitleProjection(
        <span class="annotation">@EntityReferenceProjection</span> <i class="conum" data-value="2"></i><b>(2)</b>
        EntityReference ref, <i class="conum" data-value="3"></i><b>(3)</b>
        <span class="predefined-type">String</span> title <i class="conum" data-value="4"></i><b>(4)</b>
) {
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Annotate the record type with <a href="#mapping-projection-basics"><code>@ProjectionConstructor</code></a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Annotate the parameter that should receive the entity reference with <code>@EntityReferenceProjection</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The type of the constructor parameter must be assignable from <code>EntityReference</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>You can of course also declare other parameters with different projections;
in this example an <a href="#mapping-projection-inner-inference">inferred projection</a> to the <code>title</code> field.</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;MyBookEntityRefAndTitleProjection&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .select( MyBookEntityRefAndTitleProjection.class )<i class="conum" data-value="1"></i><b>(1)</b>
        .where( f -&gt; f.matchAll() )
        .fetchHits( <span class="integer">20</span> ); <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Pass the custom projection type to <code>.select(&#8230;&#8203;)</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Each hit will be an instance of the custom projection type,
populated with the requested entity reference and field.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>For <a href="#mapping-projection-programmatic">programmatic mapping</a>, use <code>EntityReferenceProjectionBinder.create()</code>.</p>
</div>
<div class="exampleblock">
<div class="title">Example 302. Programmatic mapping of an <code>entityReference</code> projection within a projection constructor</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">TypeMappingStep myBookEntityRefAndTitleProjection =
        mapping.type( MyBookEntityRefAndTitleProjection.class );
myBookEntityRefAndTitleProjection.mainConstructor()
        .projectionConstructor();
myBookEntityRefAndTitleProjection.mainConstructor().parameter( <span class="integer">0</span> )
        .projection( EntityReferenceProjectionBinder.create() );</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="search-dsl-projection-id"><a class="anchor" href="#search-dsl-projection-id"></a>15.4.5. <a id="_id_return_identifiers_of_matched_entities"></a> <code>id</code>: return identifiers of matched entities</h4>
<div class="paragraph">
<p>The <code>id</code> projection returns the identifier of the matched entity.</p>
</div>
<div class="sect4">
<h5 id="search-dsl-projection-id-syntax"><a class="anchor" href="#search-dsl-projection-id-syntax"></a>Syntax</h5>
<div class="exampleblock">
<div class="title">Example 303. Returning ids to matched entities, providing the identity type.</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;<span class="predefined-type">Integer</span>&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .select( f -&gt; f.id( <span class="predefined-type">Integer</span>.class ) )
        .where( f -&gt; f.matchAll() )
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>If the provided identifier type does not match the type of identifiers for targeted entity types,
an exception will be thrown. See also <a href="#search-dsl-projected-value-type">Type of projected values</a>.</p>
</div>
<div class="paragraph">
<p>You can omit the "identifier type" argument, but then you will get projections of type <code>Object</code>:</p>
</div>
<div class="exampleblock">
<div class="title">Example 304. Returning ids to matched entities, without providing the identity type.</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;<span class="predefined-type">Object</span>&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .select( f -&gt; f.id() )
        .where( f -&gt; f.matchAll() )
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="search-dsl-projection-id-mapping"><a class="anchor" href="#search-dsl-projection-id-mapping"></a><code>@IdProjection</code> in projections to custom types</h5>
<div class="paragraph">
<p>To achieve an <code>id</code> projection inside a <a href="#search-dsl-projection-mapped">projection to an annotated custom type</a>,
use the <code>@IdProjection</code> annotation:</p>
</div>
<div class="exampleblock">
<div class="title">Example 305. Returning ids to matched entities within a projection constructor</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="annotation">@ProjectionConstructor</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="directive">public</span> record MyBookIdAndTitleProjection(
        <span class="annotation">@IdProjection</span> <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="predefined-type">Integer</span> id, <i class="conum" data-value="3"></i><b>(3)</b>
        <span class="predefined-type">String</span> title) { <i class="conum" data-value="4"></i><b>(4)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Annotate the record type with <a href="#mapping-projection-basics"><code>@ProjectionConstructor</code></a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Annotate the parameter that should receive the entity identifier with <code>@IdProjection</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The type of the constructor parameter must be assignable from
the type of the target entity&#8217;s identifier.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>You can of course also declare other parameters with different projections;
in this example an <a href="#mapping-projection-inner-inference">inferred projection</a> to the <code>title</code> field.</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;MyBookIdAndTitleProjection&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .select( MyBookIdAndTitleProjection.class )<i class="conum" data-value="1"></i><b>(1)</b>
        .where( f -&gt; f.matchAll() )
        .fetchHits( <span class="integer">20</span> ); <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Pass the custom projection type to <code>.select(&#8230;&#8203;)</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Each hit will be an instance of the custom projection type,
populated with the requested identifier and field.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>For <a href="#mapping-projection-programmatic">programmatic mapping</a>, use <code>IdProjectionBinder.create()</code>.</p>
</div>
<div class="exampleblock">
<div class="title">Example 306. Programmatic mapping of an <code>id</code> projection within a projection constructor</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">TypeMappingStep myBookIdAndTitleProjectionMapping =
        mapping.type( MyBookIdAndTitleProjection.class );
myBookIdAndTitleProjectionMapping.mainConstructor()
        .projectionConstructor();
myBookIdAndTitleProjectionMapping.mainConstructor().parameter( <span class="integer">0</span> )
        .projection( IdProjectionBinder.create() );</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="search-dsl-projection-entity"><a class="anchor" href="#search-dsl-projection-entity"></a>15.4.6. <code>entity</code>: return matched entities</h4>
<div class="paragraph">
<p>The <code>entity</code> projection returns the entity corresponding to the document that matched.</p>
</div>
<div class="paragraph">
<p>How the entity is loaded exactly depends on your mapper and configuration:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>With the <a href="#mapper-orm">Hibernate ORM integration</a>, returned objects are managed entities loaded by Hibernate ORM from the database.
You can use them as you would use any entity returned from traditional Hibernate ORM queries.</p>
</li>
<li>
<p>With the <a href="#mapper-pojo-standalone">Standalone POJO Mapper</a>,
entities are loaded from an external datastore if <a href="#mapping-entitydefinition-loading-selection">configured</a>,
or (failing that) are projected from the index if the entity type declares a <a href="#mapping-projection">projection constructor</a>.
If neither loading configuration nor projection constructor are found,
the <code>entity</code> projection will simply fail.</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="search-dsl-projection-entity-syntax"><a class="anchor" href="#search-dsl-projection-entity-syntax"></a>Syntax</h5>
<div class="exampleblock">
<div class="title">Example 307. Returning matched entities loaded from the database</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .select( f -&gt; f.entity() )
        .where( f -&gt; f.matchAll() )
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If an entity cannot be loaded from the external datastore/database
(e.g. it was deleted there, and the index wasn&#8217;t updated yet),
the hit will be omitted and won&#8217;t appear in the returned <code>List</code> at all.
The total hit count, however, will not take this omission into account.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="search-dsl-projection-entity-requested-type"><a class="anchor" href="#search-dsl-projection-entity-requested-type"></a>Requesting a specific entity type</h5>
<div class="paragraph">
<p>In some (rare) cases, the code creating the projection
may have to work with a <code>SearchProjectionFactory&lt;?, ?&gt;</code>,
i.e. a factory that carries no information regarding the type of loaded entities.</p>
</div>
<div class="paragraph">
<p>In those cases, it&#8217;s possible to request a specific type of entities:
Hibernate Search will check when the projection is created that
the requested type matches the type of loaded entities.</p>
</div>
<div class="exampleblock">
<div class="title">Example 308. Requesting a specific entity type when for the <code>entity</code> projection</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">f.entity( <span class="predefined-type">Book</span>.class )</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="search-dsl-projection-entity-mapping"><a class="anchor" href="#search-dsl-projection-entity-mapping"></a><code>@EntityProjection</code> in projections to custom types</h5>
<div class="paragraph">
<p>To achieve a <code>entity</code> projection inside a <a href="#search-dsl-projection-mapped">projection to an annotated custom type</a>,
use the <code>@EntityProjection</code> annotation:</p>
</div>
<div class="exampleblock">
<div class="title">Example 309. Returning matched entities loaded from the database within a projection constructor</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="annotation">@ProjectionConstructor</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="directive">public</span> record MyBookEntityAndTitleProjection(
        <span class="annotation">@EntityProjection</span> <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="predefined-type">Book</span> entity, <i class="conum" data-value="3"></i><b>(3)</b>
        <span class="predefined-type">String</span> title <i class="conum" data-value="4"></i><b>(4)</b>
) {
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Annotate the record type with <a href="#mapping-projection-basics"><code>@ProjectionConstructor</code></a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Annotate the parameter that should receive the entity with <code>@EntityProjection</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The type of the constructor parameter must be assignable from the searched entity type&#8201;&#8212;&#8201;<strong>all</strong> of them in the case of <a href="#search-dsl-query-targeting-multiple">queries targeting multiple indexes</a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>You can of course also declare other parameters with different projections;
in this example an <a href="#mapping-projection-inner-inference">inferred projection</a> to the <code>title</code> field.</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;MyBookEntityAndTitleProjection&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .select( MyBookEntityAndTitleProjection.class )<i class="conum" data-value="1"></i><b>(1)</b>
        .where( f -&gt; f.matchAll() )
        .fetchHits( <span class="integer">20</span> ); <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Pass the custom projection type to <code>.select(&#8230;&#8203;)</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Each hit will be an instance of the custom projection type,
populated with the requested entity and field.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>For <a href="#mapping-projection-programmatic">programmatic mapping</a>, use <code>EntityProjectionBinder.create()</code>.</p>
</div>
<div class="exampleblock">
<div class="title">Example 310. Programmatic mapping of an <code>entity</code> projection within a projection constructor</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">TypeMappingStep myBookEntityAndTitleProjection =
        mapping.type( MyBookEntityAndTitleProjection.class );
myBookEntityAndTitleProjection.mainConstructor()
        .projectionConstructor();
myBookEntityAndTitleProjection.mainConstructor().parameter( <span class="integer">0</span> )
        .projection( EntityProjectionBinder.create() );</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="search-dsl-projection-field"><a class="anchor" href="#search-dsl-projection-field"></a>15.4.7. <code>field</code>: return field values from matched documents</h4>
<div class="paragraph">
<p>The <code>field</code> projection returns the value of a given field for the matched document.</p>
</div>
<div id="search-dsl-projection-field-prerequisites" class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>In order to use projections based on the value of a given field,
you need to mark the field as <a href="#mapping-directfieldmapping-projectable">projectable</a> in the mapping.</p>
</div>
<div class="paragraph">
<p>This is optional with the <a href="#backend-elasticsearch">Elasticsearch backend</a>,
where all fields are projectable by default.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="search-dsl-projection-field-syntax"><a class="anchor" href="#search-dsl-projection-field-syntax"></a>Syntax</h5>
<div class="paragraph">
<p>By default, the <code>field</code> projection returns a single value per document,
so the code below will be enough for a single-valued field:</p>
</div>
<div class="exampleblock">
<div class="title">Example 311. Returning field values from matched documents</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;Genre&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .select( f -&gt; f.field( <span class="string"><span class="delimiter">&quot;</span><span class="content">genre</span><span class="delimiter">&quot;</span></span>, Genre.class ) )
        .where( f -&gt; f.matchAll() )
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Hibernate Search will throw an exception when building the query if you do this on a multivalued field.
To project on multivalued fields, see <a href="#search-dsl-projection-field-multivalued">Multivalued fields</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can omit the "field type" argument, but then you will get projections of type <code>Object</code>:</p>
</div>
<div class="exampleblock">
<div class="title">Example 312. Returning field values from matched documents, without specifying the field type</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;<span class="predefined-type">Object</span>&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .select( f -&gt; f.field( <span class="string"><span class="delimiter">&quot;</span><span class="content">genre</span><span class="delimiter">&quot;</span></span> ) )
        .where( f -&gt; f.matchAll() )
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="search-dsl-projection-field-multivalued"><a class="anchor" href="#search-dsl-projection-field-multivalued"></a>Multivalued fields</h5>
<div class="paragraph">
<p>To return multiple values, and thus allow projection on multivalued fields, use <code>.multi()</code>.
This will change the return type of the projection to <code>List&lt;T&gt;</code> where <code>T</code> is what the single-valued projection
would have returned.</p>
</div>
<div class="exampleblock">
<div class="title">Example 313. Returning field values from matched documents, for multivalued fields</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;<span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt;&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .select( f -&gt; f.field( <span class="string"><span class="delimiter">&quot;</span><span class="content">authors.lastName</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">String</span>.class ).multi() )
        .where( f -&gt; f.matchAll() )
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="search-dsl-projection-field-skipping-conversion"><a class="anchor" href="#search-dsl-projection-field-skipping-conversion"></a>Skipping conversion</h5>
<div class="paragraph">
<p>By default, the values returned by the <code>field</code> projection have the same type as
the entity property corresponding to the target field.</p>
</div>
<div class="paragraph">
<p>For example, if an entity property if of an enum type,
<a href="#mapping-directfieldmapping-supported-types">the corresponding field may be of type <code>String</code></a>;
the values returned by the <code>field</code> projection will be of the enum type regardless.</p>
</div>
<div class="paragraph">
<p>This should generally be what you want,
but if you ever need to bypass conversion and have unconverted values returned to you instead
(of type <code>String</code> in the example above),
you can do it this way:</p>
</div>
<div class="exampleblock">
<div class="title">Example 314. Returning field values from matched documents, without converting the field value</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .select( f -&gt; f.field( <span class="string"><span class="delimiter">&quot;</span><span class="content">genre</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">String</span>.class, ValueConvert.NO ) )
        .where( f -&gt; f.matchAll() )
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>See <a href="#search-dsl-projected-value-type">Type of projected values</a> for more information.</p>
</div>
</div>
<div class="sect4">
<h5 id="search-dsl-projection-field-mapping"><a class="anchor" href="#search-dsl-projection-field-mapping"></a><code>@FieldProjection</code> in projections to custom types</h5>
<div class="paragraph">
<p>To achieve a <code>field</code> projection inside a <a href="#search-dsl-projection-mapped">projection to an annotated custom type</a>,
you can rely on the default <a href="#mapping-projection-inner-inference">inferred projection</a>:
when no annotations are present on a constructor parameter,
it will be inferred to a field projection to the field with the same name as the constructor parameter
(or an <a href="#search-dsl-projection-object">object projection</a>,
see <a href="#mapping-projection-inner-inference-type">here for details</a>).</p>
</div>
<div class="paragraph">
<p>To force a field projection,
or to customize the field projection further (for example to set the field path explicitly),
use the <code>@FieldProjection</code> annotation on the constructor parameter:</p>
</div>
<div class="exampleblock">
<div class="title">Example 315. Returning field values from matched documents within a projection constructor</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="annotation">@ProjectionConstructor</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="directive">public</span> record MyBookTitleAndAuthorNamesProjection(
        <span class="annotation">@FieldProjection</span> <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="predefined-type">String</span> title, <i class="conum" data-value="3"></i><b>(3)</b>
        <span class="annotation">@FieldProjection</span>(path = <span class="string"><span class="delimiter">&quot;</span><span class="content">authors.lastName</span><span class="delimiter">&quot;</span></span>) <i class="conum" data-value="4"></i><b>(4)</b>
        <span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt; authorLastNames <i class="conum" data-value="5"></i><b>(5)</b>
) {
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Annotate the record type with <a href="#mapping-projection-basics"><code>@ProjectionConstructor</code></a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Annotate the parameter that should receive the field value with <code>@FieldProjection</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>For single-valued projections,
the type of the constructor parameter must be assignable from the type of the projected field.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Annotation attributes allow customization.
<div class="paragraph">
<p>Here we&#8217;re using a path that contains a dot,
which we can&#8217;t possibly include in the name of the Java constructor parameter.</p>
</div></td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>For multi-valued projections,
the type of the constructor parameter must be assignable from <code>List&lt;T&gt;</code>,
where <code>T</code> is the type of the projected field or a supertype.
See <a href="#mapping-projection-inner-inference-type"> Inner projection and type</a> for more information.</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;MyBookTitleAndAuthorNamesProjection&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .select( MyBookTitleAndAuthorNamesProjection.class )<i class="conum" data-value="1"></i><b>(1)</b>
        .where( f -&gt; f.matchAll() )
        .fetchHits( <span class="integer">20</span> ); <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Pass the custom projection type to <code>.select(&#8230;&#8203;)</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Each hit will be an instance of the custom projection type,
populated with the requested fields.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>The annotation exposes the following attributes:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>path</code></dt>
<dd>
<p>The path to the projected field.</p>
<div class="paragraph">
<p>If not set, it is inferred from the constructor parameter name.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Field path inference will <a href="#mapping-projection-inner-inference-fieldpath">fail if constructor parameter names are not included in the Java bytecode</a>.</p>
</div>
</td>
</tr>
</table>
</div>
</dd>
<dt class="hdlist1"><code>convert</code></dt>
<dd>
<p>How to <a href="#search-dsl-projection-field-skipping-conversion">convert</a> values retrieved from the index.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>For <a href="#mapping-projection-programmatic">programmatic mapping</a>, use <code>FieldProjectionBinder.create()</code>.</p>
</div>
<div class="exampleblock">
<div class="title">Example 316. Programmatic mapping of a <code>field</code> projection within a projection constructor</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">TypeMappingStep myBookTitleAndAuthorNamesProjectionMapping =
        mapping.type( MyBookTitleAndAuthorNamesProjection.class );
myBookTitleAndAuthorNamesProjectionMapping.mainConstructor()
        .projectionConstructor();
myBookTitleAndAuthorNamesProjectionMapping.mainConstructor().parameter( <span class="integer">0</span> )
        .projection( FieldProjectionBinder.create() );
myBookTitleAndAuthorNamesProjectionMapping.mainConstructor().parameter( <span class="integer">1</span> )
        .projection( FieldProjectionBinder.create( <span class="string"><span class="delimiter">&quot;</span><span class="content">authors.lastName</span><span class="delimiter">&quot;</span></span> ) );</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="search-dsl-projection-score"><a class="anchor" href="#search-dsl-projection-score"></a>15.4.8. <code>score</code>: return the score of matched documents</h4>
<div class="paragraph">
<p>The <code>score</code> projection returns the <a href="#search-dsl-predicate-common-score">score</a> of the matched document.</p>
</div>
<div class="sect4">
<h5 id="search-dsl-projection-score-syntax"><a class="anchor" href="#search-dsl-projection-score-syntax"></a>Syntax</h5>
<div class="exampleblock">
<div class="title">Example 317. Returning the score of matched documents</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;<span class="predefined-type">Float</span>&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .select( f -&gt; f.score() )
        .where( f -&gt; f.match().field( <span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span> )
                .matching( <span class="string"><span class="delimiter">&quot;</span><span class="content">robot dawn</span><span class="delimiter">&quot;</span></span> ) )
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Two scores can only be reliably compared if they were computed during the very same query execution.
Trying to compare scores from two separate query executions will only lead to confusing results,
in particular if the predicates are different or
if the content of the index changed enough to alter the frequency of some terms significantly.</p>
</div>
<div class="paragraph">
<p>On a related note, exposing scores to end users is generally not an easy task.
See <a href="https://cwiki.apache.org/confluence/display/LUCENE/ScoresAsPercentages">this article</a> for some insight
into what&#8217;s wrong with displaying the score as a percentage, specifically.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="search-dsl-projection-score-mapping"><a class="anchor" href="#search-dsl-projection-score-mapping"></a><code>@ScoreProjection</code> in projections to custom types</h5>
<div class="paragraph">
<p>To achieve a <code>score</code> projection inside a <a href="#search-dsl-projection-mapped">projection to an annotated custom type</a>,
use the <code>@ScoreProjection</code> annotation:</p>
</div>
<div class="exampleblock">
<div class="title">Example 318. Returning the score of matched documents within a projection constructor</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="annotation">@ProjectionConstructor</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="directive">public</span> record MyBookScoreAndTitleProjection(
        <span class="annotation">@ScoreProjection</span> <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="type">float</span> score, <i class="conum" data-value="3"></i><b>(3)</b>
        <span class="predefined-type">String</span> title <i class="conum" data-value="4"></i><b>(4)</b>
) {
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Annotate the record type with <a href="#mapping-projection-basics"><code>@ProjectionConstructor</code></a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Annotate the parameter that should receive the score with <code>@ScoreProjection</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The type of the constructor parameter must be assignable from <code>float</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>You can of course also declare other parameters with different projections;
in this example an <a href="#mapping-projection-inner-inference">inferred projection</a> to the <code>title</code> field.</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;MyBookScoreAndTitleProjection&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .select( MyBookScoreAndTitleProjection.class )<i class="conum" data-value="1"></i><b>(1)</b>
        .where( f -&gt; f.matchAll() )
        .fetchHits( <span class="integer">20</span> ); <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Pass the custom projection type to <code>.select(&#8230;&#8203;)</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Each hit will be an instance of the custom projection type,
populated with the requested score and field.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>For <a href="#mapping-projection-programmatic">programmatic mapping</a>, use <code>ScoreProjectionBinder.create()</code>.</p>
</div>
<div class="exampleblock">
<div class="title">Example 319. Programmatic mapping of a <code>score</code> projection within a projection constructor</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">TypeMappingStep myBookScoreAndTitleProjection =
        mapping.type( MyBookScoreAndTitleProjection.class );
myBookScoreAndTitleProjection.mainConstructor()
        .projectionConstructor();
myBookScoreAndTitleProjection.mainConstructor().parameter( <span class="integer">0</span> )
        .projection( ScoreProjectionBinder.create() );</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="search-dsl-projection-distance"><a class="anchor" href="#search-dsl-projection-distance"></a>15.4.9. <code>distance</code>: return the distance to a point</h4>
<div class="paragraph">
<p>The <code>distance</code> projection returns the distance between a given point
and the geo-point value of a given field for the matched document.</p>
</div>
<div id="search-dsl-projection-distance-prerequisites" class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>In order to use projections based on the value of a given field,
you need to mark the field as <a href="#mapping-directfieldmapping-projectable">projectable</a> in the mapping.</p>
</div>
<div class="paragraph">
<p>This is optional with the <a href="#backend-elasticsearch">Elasticsearch backend</a>,
where all fields are projectable by default.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="search-dsl-projection-distance-syntax"><a class="anchor" href="#search-dsl-projection-distance-syntax"></a>Syntax</h5>
<div class="paragraph">
<p>By default, the <code>distance</code> projection returns a single value per document,
so the code below will be enough for a single-valued field:</p>
</div>
<div class="exampleblock">
<div class="title">Example 320. Returning the distance to a point</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">GeoPoint center = GeoPoint.of( <span class="float">47.506060</span>, <span class="float">2.473916</span> );
<span class="predefined-type">SearchResult</span>&lt;<span class="predefined-type">Double</span>&gt; result = searchSession.search( Author.class )
        .select( f -&gt; f.distance( <span class="string"><span class="delimiter">&quot;</span><span class="content">placeOfBirth</span><span class="delimiter">&quot;</span></span>, center ) )
        .where( f -&gt; f.matchAll() )
        .fetch( <span class="integer">20</span> );</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Hibernate Search will throw an exception when building the query if you do this on a multivalued field.
To project on multivalued fields, see <a href="#search-dsl-projection-distance-multivalued">Multivalued fields</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The returned distance is in meters by default, but you can pick a different unit:</p>
</div>
<div class="exampleblock">
<div class="title">Example 321. Returning the distance to a point with a given distance unit</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">GeoPoint center = GeoPoint.of( <span class="float">47.506060</span>, <span class="float">2.473916</span> );
<span class="predefined-type">SearchResult</span>&lt;<span class="predefined-type">Double</span>&gt; result = searchSession.search( Author.class )
        .select( f -&gt; f.distance( <span class="string"><span class="delimiter">&quot;</span><span class="content">placeOfBirth</span><span class="delimiter">&quot;</span></span>, center )
                .unit( DistanceUnit.KILOMETERS ) )
        .where( f -&gt; f.matchAll() )
        .fetch( <span class="integer">20</span> );</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="search-dsl-projection-distance-multivalued"><a class="anchor" href="#search-dsl-projection-distance-multivalued"></a>Multivalued fields</h5>
<div class="paragraph">
<p>To return multiple values, and thus allow projection on multivalued fields, use <code>.multi()</code>.
This will change the return type of the projection to <code>List&lt;Double&gt;</code>.</p>
</div>
<div class="exampleblock">
<div class="title">Example 322. Returning the distance to a point, for multivalued fields</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">GeoPoint center = GeoPoint.of( <span class="float">47.506060</span>, <span class="float">2.473916</span> );
<span class="predefined-type">SearchResult</span>&lt;<span class="predefined-type">List</span>&lt;<span class="predefined-type">Double</span>&gt;&gt; result = searchSession.search( <span class="predefined-type">Book</span>.class )
        .select( f -&gt; f.distance( <span class="string"><span class="delimiter">&quot;</span><span class="content">authors.placeOfBirth</span><span class="delimiter">&quot;</span></span>, center ).multi() )
        .where( f -&gt; f.matchAll() )
        .fetch( <span class="integer">20</span> );</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="search-dsl-projection-distance-mapping"><a class="anchor" href="#search-dsl-projection-distance-mapping"></a>In projections to custom types</h5>
<div class="paragraph">
<p>There is no built-in annotation to use the <code>distance</code> projection
inside a <a href="#search-dsl-projection-mapped">projection to an annotated custom type</a>
<a href="https://hibernate.atlassian.net/browse/HSEARCH-4807">at the moment</a>.</p>
</div>
<div class="paragraph">
<p>You can <a href="#binding-projection-parameters-custom-annotation">create your own annotation</a> if you need one,
backed by a <a href="#binding-projection">custom projection binder</a>,
but the center of the distance projection won&#8217;t be able to change from query to query,
which limits its usefulness drastically at the moment.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="search-dsl-projection-composite"><a class="anchor" href="#search-dsl-projection-composite"></a>15.4.10. <code>composite</code>: combine projections</h4>
<div class="sect4">
<h5 id="search-dsl-projection-composite-basics"><a class="anchor" href="#search-dsl-projection-composite-basics"></a>Basics</h5>
<div class="paragraph">
<p>The <code>composite</code> projection applies multiple projections and combines their results,
either as a <code>List&lt;?&gt;</code> or as a single object generated using a custom transformer.</p>
</div>
<div class="paragraph">
<p>To preserve type-safety, you can provide a custom transformer.
The transformer can be a <code>Function</code>, a <code>BiFunction</code>,
or a <code>org.hibernate.search.util.common.function.TriFunction</code>,
depending on the number of inner projections.
It will receive values returned by inner projections and return an object combining these values.</p>
</div>
<div class="exampleblock">
<div class="title">Example 323. Returning custom objects created from multiple projected values with <code>.composite().from(&#8230;&#8203;).as(&#8230;&#8203;)</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;MyPair&lt;<span class="predefined-type">String</span>, Genre&gt;&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .select( f -&gt; f.composite() <i class="conum" data-value="1"></i><b>(1)</b>
                .from( f.field( <span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">String</span>.class ), <i class="conum" data-value="2"></i><b>(2)</b>
                        f.field( <span class="string"><span class="delimiter">&quot;</span><span class="content">genre</span><span class="delimiter">&quot;</span></span>, Genre.class ) ) <i class="conum" data-value="3"></i><b>(3)</b>
                .as( MyPair::<span class="keyword">new</span> ) )<i class="conum" data-value="4"></i><b>(4)</b>
        .where( f -&gt; f.matchAll() )
        .fetchHits( <span class="integer">20</span> ); <i class="conum" data-value="5"></i><b>(5)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Call <code>.composite()</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Define the first inner projection as a projection on the <code>title</code> field.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Define the second inner projection as a projection on the <code>genre</code> field.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Define the result of the composite projection as the result of calling the constructor of a custom object, <code>MyPair</code>.
The constructor of <code>MyPair</code> will be called for each matched document,
with the value of the <code>title</code> field as its first argument,
and the value of the <code>genre</code> field as its second argument.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Each hit will be an instance of <code>MyPair</code>.
Thus, the list of hits will be an instance of <code>List&lt;MyPair&gt;</code>.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="search-dsl-projection-composite-more-inners"><a class="anchor" href="#search-dsl-projection-composite-more-inners"></a>Composing more than 3 inner projections</h5>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>For complex projections, consider <a href="#search-dsl-projection-composite-as-mapped">projecting to a custom (annotated) type</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If you pass more than 3 projections as arguments to <code>from(&#8230;&#8203;)</code>,
then the transform function will have to take a <code>List&lt;?&gt;</code> as an argument,
and will be set using <code>asList(&#8230;&#8203;)</code> instead of <code>as(..,)</code>:</p>
</div>
<div class="exampleblock">
<div class="title">Example 324. Returning custom objects created from multiple projected values with <code>.composite().from(&#8230;&#8203;).asList(&#8230;&#8203;)</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;MyTuple4&lt;<span class="predefined-type">String</span>, Genre, <span class="predefined-type">Integer</span>, <span class="predefined-type">String</span>&gt;&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .select( f -&gt; f.composite() <i class="conum" data-value="1"></i><b>(1)</b>
                .from( f.field( <span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">String</span>.class ), <i class="conum" data-value="2"></i><b>(2)</b>
                        f.field( <span class="string"><span class="delimiter">&quot;</span><span class="content">genre</span><span class="delimiter">&quot;</span></span>, Genre.class ), <i class="conum" data-value="3"></i><b>(3)</b>
                        f.field( <span class="string"><span class="delimiter">&quot;</span><span class="content">pageCount</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">Integer</span>.class ), <i class="conum" data-value="4"></i><b>(4)</b>
                        f.field( <span class="string"><span class="delimiter">&quot;</span><span class="content">description</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">String</span>.class ) ) <i class="conum" data-value="5"></i><b>(5)</b>
                .asList( list -&gt; <i class="conum" data-value="6"></i><b>(6)</b>
                    <span class="keyword">new</span> MyTuple4&lt;&gt;( (<span class="predefined-type">String</span>) list.get( <span class="integer">0</span> ), (Genre) list.get( <span class="integer">1</span> ),
                            (<span class="predefined-type">Integer</span>) list.get( <span class="integer">2</span> ), (<span class="predefined-type">String</span>) list.get( <span class="integer">3</span> ) ) ) )
        .where( f -&gt; f.matchAll() )
        .fetchHits( <span class="integer">20</span> ); <i class="conum" data-value="7"></i><b>(7)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Call <code>.composite()</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Define the first inner projection as a projection on the <code>title</code> field.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Define the second inner projection as a projection on the <code>genre</code> field.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Define the third inner projection as a projection on the <code>pageCount</code> field.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Define the fourth inner projection as a projection on the <code>description</code> field.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Define the result of the object projection as the result of calling a lambda.
The lambda will take elements of the list (the results of projections defined above, in order),
cast them, and pass them to the constructor of a custom class, <code>MyTuple4</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Each hit will be an instance of <code>MyTuple4</code>.
Thus, the list of hits will be an instance of <code>List&lt;MyTuple4&gt;</code>.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="search-dsl-projection-composite-as-list"><a class="anchor" href="#search-dsl-projection-composite-as-list"></a>Projecting to a <code>List&lt;?&gt;</code> or <code>Object[]</code></h5>
<div class="paragraph">
<p>If you don&#8217;t mind receiving the result of inner projections as a <code>List&lt;?&gt;</code>,
you can do without the transformer by calling <code>asList()</code>:</p>
</div>
<div class="exampleblock">
<div class="title">Example 325. Returning a <code>List</code> of projected values with <code>.composite().add(&#8230;&#8203;).asList()</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;<span class="predefined-type">List</span>&lt;?&gt;&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .select( f -&gt; f.composite() <i class="conum" data-value="1"></i><b>(1)</b>
                .from( f.field( <span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">String</span>.class ), <i class="conum" data-value="2"></i><b>(2)</b>
                        f.field( <span class="string"><span class="delimiter">&quot;</span><span class="content">genre</span><span class="delimiter">&quot;</span></span>, Genre.class ) ) <i class="conum" data-value="3"></i><b>(3)</b>
                .asList() ) <i class="conum" data-value="4"></i><b>(4)</b>
        .where( f -&gt; f.matchAll() )
        .fetchHits( <span class="integer">20</span> ); <i class="conum" data-value="5"></i><b>(5)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Call <code>.composite()</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Define the first inner projection as a projection on the <code>title</code> field.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Define the second inner projection as a projection on the <code>genre</code> field.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Define the result of the projection as a list,
meaning the hits will be <code>List</code> instances with the value of the <code>title</code> field of the matched document at index <code>0</code>,
and the value of the <code>genre</code> field of the matched document at index <code>1</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Each hit will be an instance of <code>List&lt;?&gt;</code>:
a list containing the result of the inner projections, in the given order.
Thus, the list of hits will be an instance of <code>List&lt;List&lt;?&gt;&gt;</code>.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>Similarly, to get the result of inner projections as an array (<code>Object[]</code>),
you can do without the transformer by calling <code>asArray()</code>:</p>
</div>
<div class="exampleblock">
<div class="title">Example 326. Returning an array of projected values with <code>.composite(&#8230;&#8203;).add(&#8230;&#8203;).asArray()</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;<span class="predefined-type">Object</span><span class="type">[]</span>&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .select( f -&gt; f.composite() <i class="conum" data-value="1"></i><b>(1)</b>
                .from( f.field( <span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">String</span>.class ), <i class="conum" data-value="2"></i><b>(2)</b>
                        f.field( <span class="string"><span class="delimiter">&quot;</span><span class="content">genre</span><span class="delimiter">&quot;</span></span>, Genre.class ) ) <i class="conum" data-value="3"></i><b>(3)</b>
                .asArray() ) <i class="conum" data-value="4"></i><b>(4)</b>
        .where( f -&gt; f.matchAll() )
        .fetchHits( <span class="integer">20</span> ); <i class="conum" data-value="5"></i><b>(5)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Call <code>.composite()</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Define the first inner projection as a projection on the <code>title</code> field.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Define the second inner projection as a projection on the <code>genre</code> field.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Define the result of the projection as an array,
meaning the hits will be <code>Object[]</code> instances with the value of the <code>title</code> field of the matched document at index <code>0</code>,
and the value of the <code>genre</code> field of the matched document at index <code>1</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Each hit will be an instance of <code>Object[]</code>:
a array of objects containing the result of the inner projections, in the given order.
Thus, the list of hits will be an instance of <code>List&lt;Object[]&gt;</code>.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>Alternatively, to get the result as a <code>List&lt;?&gt;</code>,
you can use the shorter variant of <code>.composite(&#8230;&#8203;)</code> that directly takes projections as arguments:</p>
</div>
<div class="exampleblock">
<div class="title">Example 327. Returning a <code>List</code> of projected values with <code>.composite(&#8230;&#8203;)</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;<span class="predefined-type">List</span>&lt;?&gt;&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .select( f -&gt; f.composite( <i class="conum" data-value="1"></i><b>(1)</b>
                f.field( <span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">String</span>.class ), <i class="conum" data-value="2"></i><b>(2)</b>
                f.field( <span class="string"><span class="delimiter">&quot;</span><span class="content">genre</span><span class="delimiter">&quot;</span></span>, Genre.class ) <i class="conum" data-value="3"></i><b>(3)</b>
        ) )
        .where( f -&gt; f.matchAll() )
        .fetchHits( <span class="integer">20</span> ); <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Call <code>.composite(&#8230;&#8203;)</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Define the first projection to combine as a projection on the <code>title</code> field.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Define the second projection to combine as a projection on the <code>genre</code> field.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Each hit will be an instance of <code>List&lt;?&gt;</code>:
a list containing the result of the inner projections, in the given order.
Thus, the list of hits will be an instance of <code>List&lt;List&lt;?&gt;&gt;</code>.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="search-dsl-projection-composite-as-mapped"><a class="anchor" href="#search-dsl-projection-composite-as-mapped"></a>Projecting to a custom (annotated) type</h5>
<div class="paragraph">
<p>For more complex composite projections, it is possible to define a custom (annotated) record or class
and have Hibernate Search infer the corresponding inner projections from the custom type&#8217;s constructor parameters.
This is similar to the <a href="#search-dsl-projection-mapped">projection to a custom (annotated) type through <code>.select(&#8230;&#8203;)</code></a>.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>There are a few constraints to keep in mind when annotating a custom projection type:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The custom projection type must be in the same JAR as entity types,
or Hibernate Search will <a href="#mapping-projection-type-detection">require additional configuration</a>.</p>
</li>
<li>
<p>When projecting on value fields or object fields, the path to the projected field
is inferred from the constructor parameter name by default,
but <a href="#mapping-projection-inner-inference-fieldpath">inference will fail if constructor parameter names are not included in the Java bytecode</a>.
Alternatively the path can be provided explicitly
through <a href="#search-dsl-projection-field-mapping"><code>@FieldProjection(path = &#8230;&#8203;)</code></a>/<a href="#search-dsl-projection-object-mapping"><code>@ObjectProjection(path = &#8230;&#8203;)</code></a>,
in which case Hibernate Search won&#8217;t rely on constructor parameter names.</p>
</li>
<li>
<p>When projecting on value fields, the constraints of the <a href="#search-dsl-projection-field"><code>field</code></a> projection still apply.
In particular, with the <a href="#backend-lucene">Lucene backend</a>, value fields involved in the projection
must be configured as <a href="#mapping-directfieldmapping-projectable">projectable</a>.</p>
</li>
<li>
<p>When projecting on object fields, the constraints of the <a href="#search-dsl-projection-object"><code>object</code></a> projection still apply.
In particular, with the <a href="#backend-lucene">Lucene backend</a>, multi-valued object fields involved in the projection
must be configured as <a href="#mapping-indexedembedded-structure-nested">nested</a>.</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="exampleblock">
<div class="title">Example 328. Using a custom record type to project data from the index</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="annotation">@ProjectionConstructor</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="directive">public</span> record MyBookProjection(
        <span class="annotation">@IdProjection</span> <span class="predefined-type">Integer</span> id, <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="predefined-type">String</span> title, <i class="conum" data-value="3"></i><b>(3)</b>
        <span class="predefined-type">List</span>&lt;MyBookProjection.Author&gt; authors) { <i class="conum" data-value="4"></i><b>(4)</b>
    <span class="annotation">@ProjectionConstructor</span> <i class="conum" data-value="5"></i><b>(5)</b>
    <span class="directive">public</span> record Author(<span class="predefined-type">String</span> firstName, <span class="predefined-type">String</span> lastName) {
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Annotate the record type with <code>@ProjectionConstructor</code>,
either at the type level (if there&#8217;s only one constructor)
or at the constructor level (if there are <a href="#mapping-projection-multiple-constructors">multiple constructors</a>).</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>To project on the entity identifier, annotate the relevant constructor parameter with <a href="#search-dsl-projection-id-mapping"><code>@IdProjection</code></a>.
<div class="paragraph">
<p>Most projections have a corresponding annotation that can be used on constructor parameters.</p>
</div></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>To project on a value field, add a constructor parameter named after that field and with the same type as that field.
See <a href="#mapping-projection-inner-inference"> Implicit inner projection inference</a> for more information on how constructor parameters should be defined.
<div class="paragraph">
<p>Alternatively, the field projection can be configured explicitly with <a href="#search-dsl-projection-field-mapping"><code>@FieldProjection</code></a>.</p>
</div></td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>To project on an object field, add a constructor parameter named after that field and with its own custom projection type.
Multivalued projections <a href="#mapping-projection-inner-inference-type">must be modeled as a <code>List&lt;&#8230;&#8203;&gt;</code></a> or supertype.
<div class="paragraph">
<p>Alternatively, the object projection can be configured explicitly with <a href="#search-dsl-projection-object-mapping"><code>@ObjectProjection</code></a>.</p>
</div></td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Annotate any custom projection type used for object fields with <code>@ProjectionConstructor</code> as well.</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;MyBookProjection&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .select( f -&gt; f.composite() <i class="conum" data-value="1"></i><b>(1)</b>
                .as( MyBookProjection.class ) )<i class="conum" data-value="2"></i><b>(2)</b>
        .where( f -&gt; f.matchAll() )
        .fetchHits( <span class="integer">20</span> ); <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Call <code>.composite()</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Define the result of the projection as a custom (annotated) type.
Hibernate Search will <a href="#mapping-projection-inner-inference">infer the inner projections</a>
from the custom type&#8217;s constructor parameters.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Each hit will be an instance of the custom projection type,
populated with data retrieved from the index.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Custom, non-record classes can also be annotated with <code>@ProjectionConstructor</code>,
which can be useful if you cannot use records for some reason
(for example because you&#8217;re still using Java 13 or below).</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
For more information about mapping custom projection types, see <a href="#mapping-projection"> Mapping index content to custom types (projection constructors)</a>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="search-dsl-projection-composite-mapping"><a class="anchor" href="#search-dsl-projection-composite-mapping"></a><code>@CompositeProjection</code> in projections to custom types</h5>
<div class="paragraph">
<p>To achieve a <code>composite</code> projection inside a <a href="#search-dsl-projection-mapped">projection to an annotated custom type</a>,
use the <code>@CompositeProjection</code> annotation on the constructor parameter:</p>
</div>
<div class="exampleblock">
<div class="title">Example 329. Returning custom objects created from multiple projections within a projection constructor</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="annotation">@ProjectionConstructor</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="directive">public</span> record MyBookMiscInfoAndTitleProjection(
        <span class="annotation">@CompositeProjection</span> <i class="conum" data-value="2"></i><b>(2)</b>
        MiscInfo miscInfo, <i class="conum" data-value="3"></i><b>(3)</b>
        <span class="predefined-type">String</span> title <i class="conum" data-value="4"></i><b>(4)</b>
) {

    <span class="annotation">@ProjectionConstructor</span> <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="directive">public</span> record MiscInfo(
            Genre genre,
            <span class="predefined-type">Integer</span> pageCount
    ) {
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Annotate the record type with <a href="#mapping-projection-basics"><code>@ProjectionConstructor</code></a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Annotate the parameter that should receive the composite projection with <code>@CompositeProjection</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The type of the constructor parameter must have a projection constructor itself.
See <a href="#mapping-projection-inner-inference-type"> Inner projection and type</a> for more information.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>You can of course also declare other parameters with different projections;
in this example an <a href="#mapping-projection-inner-inference">inferred projection</a> to the <code>title</code> field.</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;MyBookMiscInfoAndTitleProjection&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .select( MyBookMiscInfoAndTitleProjection.class )<i class="conum" data-value="1"></i><b>(1)</b>
        .where( f -&gt; f.matchAll() )
        .fetchHits( <span class="integer">20</span> ); <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Pass the custom projection type to <code>.select(&#8230;&#8203;)</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Each hit will be an instance of the custom projection type,
populated with the requested composite projection.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>For <a href="#mapping-projection-programmatic">programmatic mapping</a>, use <code>CompositeProjectionBinder.create()</code>.</p>
</div>
<div class="exampleblock">
<div class="title">Example 330. Programmatic mapping of a <code>composite</code> projection within a projection constructor</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">TypeMappingStep myBookMiscInfoAndTitleProjection =
        mapping.type( MyBookMiscInfoAndTitleProjection.class );
myBookMiscInfoAndTitleProjection.mainConstructor()
        .projectionConstructor();
myBookMiscInfoAndTitleProjection.mainConstructor().parameter( <span class="integer">0</span> )
        .projection( CompositeProjectionBinder.create() );
TypeMappingStep miscInfoProjection =
        mapping.type( MyBookMiscInfoAndTitleProjection.MiscInfo.class );
miscInfoProjection.mainConstructor().projectionConstructor();</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="search-dsl-projection-composite-deprecated-variants"><a class="anchor" href="#search-dsl-projection-composite-deprecated-variants"></a>Deprecated variants</h5>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Features detailed in this section are <em>deprecated</em>: they should be avoided in favor of non-deprecated alternatives.</p>
</div>
<div class="paragraph">
<p>The usual <a href="https://hibernate.org/community/compatibility-policy/">compatibility policy</a> applies,
meaning the features are expected to remain available at least until the next major version of Hibernate Search.
Beyond that, they may be altered in a backward-incompatible way&#8201;&#8212;&#8201;or even removed.</p>
</div>
<div class="paragraph">
<p>Usage of deprecated features is not recommended.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>A few <code>.composite(&#8230;&#8203;)</code> methods accepting both a function and a list of projections
are available on <code>SearchProjectionFactory</code>, but they are deprecated.</p>
</div>
<div class="exampleblock">
<div class="title">Example 331. Deprecated variant of <code>composite</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;MyPair&lt;<span class="predefined-type">String</span>, Genre&gt;&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .select( f -&gt; f.composite( <i class="conum" data-value="1"></i><b>(1)</b>
                MyPair::<span class="keyword">new</span>, <i class="conum" data-value="2"></i><b>(2)</b>
                f.field( <span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">String</span>.class ), <i class="conum" data-value="3"></i><b>(3)</b>
                f.field( <span class="string"><span class="delimiter">&quot;</span><span class="content">genre</span><span class="delimiter">&quot;</span></span>, Genre.class ) <i class="conum" data-value="4"></i><b>(4)</b>
        ) )
        .where( f -&gt; f.matchAll() )
        .fetchHits( <span class="integer">20</span> ); <i class="conum" data-value="5"></i><b>(5)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Call <code>.composite(&#8230;&#8203;)</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Define the transformer as the constructor of a custom object, <code>MyPair</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Define the first projection to combine as a projection on the <code>title</code> field,
meaning the constructor of <code>MyPair</code> will be called for each matched document
with the value of the <code>title</code> field as its first argument.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Define the second projection to combine as a projection on the <code>genre</code> field,
meaning the constructor of <code>MyPair</code> will be called for each matched document
with the value of the <code>genre</code> field as its second argument.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Each hit will be an instance of <code>MyPair</code>.
Thus, the list of hits will be an instance of <code>List&lt;MyPair&gt;</code>.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="search-dsl-projection-object"><a class="anchor" href="#search-dsl-projection-object"></a>15.4.11. <code>object</code>: return one value per object in an object field</h4>
<div class="paragraph">
<p>The <code>object</code> projection yields one projected value for each object in a given object field,
the value being generated by applying multiple inner projections and combining their results
either as a <code>List&lt;?&gt;</code> or as a single object generated using a custom transformer.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The <code>object</code> projection may seem very similar to the <a href="#search-dsl-projection-composite"><code>composite</code> projection</a>,
and its definition via the Search DSL certainly is indeed similar.</p>
</div>
<div class="paragraph">
<p>However, there are two key differences:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The <code>object</code> projection will yield <code>null</code> when projecting on a single-valued object field
if the object was null when indexing.</p>
</li>
<li>
<p>The <code>object</code> projection will yield multiple values when projecting on a multivalued object field
if there were multiple objects when indexing.</p>
</li>
</ol>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>With the <a href="#backend-lucene">Lucene backend</a>, the object projection has a few limitations:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>It is only available for single-valued object fields regardless of their <a href="#mapping-indexedembedded-structure">structure</a>,
or multi-valued object fields with a
<a href="#mapping-indexedembedded-structure-nested"><code>NESTED</code> structure</a>.</p>
</li>
<li>
<p>It will never yield <code>null</code> objects for multi-valued object fields.
The Lucene backend does not index <code>null</code> objects,
and thus cannot find them when searching.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>These limitations do not apply to the <a href="#backend-elasticsearch">Elasticsearch backend</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="search-dsl-projection-object-syntax"><a class="anchor" href="#search-dsl-projection-object-syntax"></a>Syntax</h5>
<div class="paragraph">
<p>To preserve type-safety, you can provide a custom transformer.
The transformer can be a <code>Function</code>, a <code>BiFunction</code>,
or a <code>org.hibernate.search.util.common.function.TriFunction</code>,
depending on the number of inner projections.
It will receive values returned by inner projections and return an object combining these values.</p>
</div>
<div class="exampleblock">
<div class="title">Example 332. Returning custom objects created from an object field with <code>.object(&#8230;&#8203;).from(&#8230;&#8203;).as(&#8230;&#8203;)</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;<span class="predefined-type">List</span>&lt;MyAuthorName&gt;&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .select( f -&gt; f.object( <span class="string"><span class="delimiter">&quot;</span><span class="content">authors</span><span class="delimiter">&quot;</span></span> ) <i class="conum" data-value="1"></i><b>(1)</b>
                .from( f.field( <span class="string"><span class="delimiter">&quot;</span><span class="content">authors.firstName</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">String</span>.class ), <i class="conum" data-value="2"></i><b>(2)</b>
                        f.field( <span class="string"><span class="delimiter">&quot;</span><span class="content">authors.lastName</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">String</span>.class ) ) <i class="conum" data-value="3"></i><b>(3)</b>
                .as( MyAuthorName::<span class="keyword">new</span> ) <i class="conum" data-value="4"></i><b>(4)</b>
                .multi() ) <i class="conum" data-value="5"></i><b>(5)</b>
        .where( f -&gt; f.matchAll() )
        .fetchHits( <span class="integer">20</span> ); <i class="conum" data-value="6"></i><b>(6)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Call <code>.object( "authors" )</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Define the first inner projection as a projection on the <code>firstName</code> field of <code>authors</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Define the second inner projection as a projection on the <code>lastName</code> field of <code>authors</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Define the result of the object projection as the result of calling the constructor of a custom object, <code>MyAuthorName</code>.
The constructor of <code>MyAuthorName</code> will be called for each object in the <code>authors</code> object field,
with the value of the <code>authors.firstName</code> field as its first argument,
and the value of the <code>authors.lastName</code> field as its second argument.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Define the projection as multivalued,
meaning it will yield values of type <code>List&lt;MyAuthorName&gt;</code>:
one <code>MyAuthorName</code> per object in the <code>authors</code> object field.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Each hit will be an instance of <code>List&lt;MyAuthorName&gt;</code>.
Thus, the list of hits will be an instance of <code>List&lt;List&lt;MyAuthorName&gt;&gt;</code>.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="search-dsl-projection-object-more-inners"><a class="anchor" href="#search-dsl-projection-object-more-inners"></a>Composing more than 3 inner projections</h5>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>For complex projections, consider <a href="#search-dsl-projection-object-as-mapped">projecting to a custom (annotated) type</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If you pass more than 3 projections as arguments,
then the transform function will have to take a <code>List&lt;?&gt;</code> as an argument,
and will be set using <code>asList(&#8230;&#8203;)</code> instead of <code>as(..,)</code>:</p>
</div>
<div class="exampleblock">
<div class="title">Example 333. Returning custom objects created from an object field with <code>.object(&#8230;&#8203;).from(&#8230;&#8203;).asList(&#8230;&#8203;)</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">GeoPoint center = GeoPoint.of( <span class="float">53.970000</span>, <span class="float">32.150000</span> );
<span class="predefined-type">List</span>&lt;<span class="predefined-type">List</span>&lt;MyAuthorNameAndBirthDateAndPlaceOfBirthDistance&gt;&gt; hits = searchSession
        .search( <span class="predefined-type">Book</span>.class )
        .select( f -&gt; f.object( <span class="string"><span class="delimiter">&quot;</span><span class="content">authors</span><span class="delimiter">&quot;</span></span> ) <i class="conum" data-value="1"></i><b>(1)</b>
                .from( f.field( <span class="string"><span class="delimiter">&quot;</span><span class="content">authors.firstName</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">String</span>.class ), <i class="conum" data-value="2"></i><b>(2)</b>
                        f.field( <span class="string"><span class="delimiter">&quot;</span><span class="content">authors.lastName</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">String</span>.class ), <i class="conum" data-value="3"></i><b>(3)</b>
                        f.field( <span class="string"><span class="delimiter">&quot;</span><span class="content">authors.birthDate</span><span class="delimiter">&quot;</span></span>, LocalDate.class ), <i class="conum" data-value="4"></i><b>(4)</b>
                        f.distance( <span class="string"><span class="delimiter">&quot;</span><span class="content">authors.placeOfBirth</span><span class="delimiter">&quot;</span></span>, center ) <i class="conum" data-value="5"></i><b>(5)</b>
                                .unit( DistanceUnit.KILOMETERS ) )
                .asList( list -&gt; <i class="conum" data-value="6"></i><b>(6)</b>
                        <span class="keyword">new</span> MyAuthorNameAndBirthDateAndPlaceOfBirthDistance(
                                (<span class="predefined-type">String</span>) list.get( <span class="integer">0</span> ), (<span class="predefined-type">String</span>) list.get( <span class="integer">1</span> ),
                                (LocalDate) list.get( <span class="integer">2</span> ), (<span class="predefined-type">Double</span>) list.get( <span class="integer">3</span> ) ) )
                .multi() ) <i class="conum" data-value="7"></i><b>(7)</b>
        .where( f -&gt; f.matchAll() )
        .fetchHits( <span class="integer">20</span> ); <i class="conum" data-value="8"></i><b>(8)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Call <code>.object( "authors" )</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Define the first inner projection as a projection on the <code>firstName</code> field of <code>authors</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Define the second inner projection as a projection on the <code>lastName</code> field of <code>authors</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Define the third inner projection as a projection on the <code>birthDate</code> field of <code>authors</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Define the fourth inner projection as a <a href="#search-dsl-projection-distance">distance projection</a>
on the <code>placeOfBirth</code> field with the given center and unit.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Define the result of the object projection as the result of calling a lambda.
The lambda will take elements of the list (the results of projections defined above, in order),
cast them, and pass them to the constructor of a custom class, <code>MyAuthorNameAndBirthDateAndPlaceOfBirthDistance</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Define the projection as multivalued,
meaning it will yield values of type <code>List&lt;MyAuthorNameAndBirthDateAndPlaceOfBirthDistance&gt;</code>:
one <code>MyAuthorNameAndBirthDateAndPlaceOfBirthDistance</code> per object in the <code>authors</code> object field.
instead of just <code>MyAuthorNameAndBirthDateAndPlaceOfBirthDistance</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>Each hit will be an instance of <code>List&lt;MyAuthorNameAndBirthDateAndPlaceOfBirthDistance&gt;</code>.
Thus, the list of hits will be an instance of <code>List&lt;List&lt;MyAuthorNameAndBirthDateAndPlaceOfBirthDistance&gt;&gt;</code>.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>Similarly, <code>asArray(&#8230;&#8203;)</code> can be used to get passed an <code>Object[]</code> argument instead of <code>List&lt;?&gt;</code>.</p>
</div>
<div class="exampleblock">
<div class="title">Example 334. Returning custom objects created from an object field with <code>.object(&#8230;&#8203;).from(&#8230;&#8203;).asArray(&#8230;&#8203;)</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">GeoPoint center = GeoPoint.of( <span class="float">53.970000</span>, <span class="float">32.150000</span> );
<span class="predefined-type">List</span>&lt;<span class="predefined-type">List</span>&lt;MyAuthorNameAndBirthDateAndPlaceOfBirthDistance&gt;&gt; hits = searchSession
        .search( <span class="predefined-type">Book</span>.class )
        .select( f -&gt; f.object( <span class="string"><span class="delimiter">&quot;</span><span class="content">authors</span><span class="delimiter">&quot;</span></span> ) <i class="conum" data-value="1"></i><b>(1)</b>
                .from( f.field( <span class="string"><span class="delimiter">&quot;</span><span class="content">authors.firstName</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">String</span>.class ), <i class="conum" data-value="2"></i><b>(2)</b>
                        f.field( <span class="string"><span class="delimiter">&quot;</span><span class="content">authors.lastName</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">String</span>.class ), <i class="conum" data-value="3"></i><b>(3)</b>
                        f.field( <span class="string"><span class="delimiter">&quot;</span><span class="content">authors.birthDate</span><span class="delimiter">&quot;</span></span>, LocalDate.class ), <i class="conum" data-value="4"></i><b>(4)</b>
                        f.distance( <span class="string"><span class="delimiter">&quot;</span><span class="content">authors.placeOfBirth</span><span class="delimiter">&quot;</span></span>, center ) <i class="conum" data-value="5"></i><b>(5)</b>
                                .unit( DistanceUnit.KILOMETERS ) )
                .asArray( array -&gt; <i class="conum" data-value="6"></i><b>(6)</b>
                        <span class="keyword">new</span> MyAuthorNameAndBirthDateAndPlaceOfBirthDistance(
                                (<span class="predefined-type">String</span>) array[<span class="integer">0</span>], (<span class="predefined-type">String</span>) array[<span class="integer">1</span>],
                                (LocalDate) array[<span class="integer">2</span>], (<span class="predefined-type">Double</span>) array[<span class="integer">3</span>] ) )
                .multi() ) <i class="conum" data-value="7"></i><b>(7)</b>
        .where( f -&gt; f.matchAll() )
        .fetchHits( <span class="integer">20</span> ); <i class="conum" data-value="8"></i><b>(8)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Call <code>.object( "authors" )</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Define the first inner projection as a projection on the <code>firstName</code> field of <code>authors</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Define the second inner projection as a projection on the <code>lastName</code> field of <code>authors</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Define the third inner projection as a projection on the <code>birthDate</code> field of <code>authors</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Define the fourth inner projection as a <a href="#search-dsl-projection-distance">distance projection</a>
on the <code>placeOfBirth</code> field with the given center and unit.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Define the result of the object projection as the result of calling a lambda.
The lambda will take elements of the array (the results of projections defined above, in order),
cast them, and pass them to the constructor of a custom class, <code>MyAuthorNameAndBirthDateAndPlaceOfBirthDistance</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Define the projection as multivalued,
meaning it will yield values of type <code>List&lt;MyAuthorNameAndBirthDateAndPlaceOfBirthDistance&gt;</code>:
one <code>MyAuthorNameAndBirthDateAndPlaceOfBirthDistance</code> per object in the <code>authors</code> object field.
instead of just <code>MyAuthorNameAndBirthDateAndPlaceOfBirthDistance</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>Each hit will be an instance of <code>List&lt;MyAuthorNameAndBirthDateAndPlaceOfBirthDistance&gt;</code>.
Thus, the list of hits will be an instance of <code>List&lt;List&lt;MyAuthorNameAndBirthDateAndPlaceOfBirthDistance&gt;&gt;</code>.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="search-dsl-projection-object-as-list"><a class="anchor" href="#search-dsl-projection-object-as-list"></a>Projecting to a <code>List&lt;?&gt;</code> or <code>Object[]</code></h5>
<div class="paragraph">
<p>If you don&#8217;t mind receiving the result of inner projections as a <code>List&lt;?&gt;</code>,
you can do without the transformer by calling <code>asList()</code>:</p>
</div>
<div class="exampleblock">
<div class="title">Example 335. Returning a <code>List</code> of projected values with <code>.object(&#8230;&#8203;).add(&#8230;&#8203;).asList()</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;<span class="predefined-type">List</span>&lt;<span class="predefined-type">List</span>&lt;?&gt;&gt;&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .select( f -&gt; f.object( <span class="string"><span class="delimiter">&quot;</span><span class="content">authors</span><span class="delimiter">&quot;</span></span> ) <i class="conum" data-value="1"></i><b>(1)</b>
                .from( f.field( <span class="string"><span class="delimiter">&quot;</span><span class="content">authors.firstName</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">String</span>.class ), <i class="conum" data-value="2"></i><b>(2)</b>
                        f.field( <span class="string"><span class="delimiter">&quot;</span><span class="content">authors.lastName</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">String</span>.class ) ) <i class="conum" data-value="3"></i><b>(3)</b>
                .asList() <i class="conum" data-value="4"></i><b>(4)</b>
                .multi() ) <i class="conum" data-value="5"></i><b>(5)</b>
        .where( f -&gt; f.matchAll() )
        .fetchHits( <span class="integer">20</span> ); <i class="conum" data-value="6"></i><b>(6)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Call <code>.object( "authors" )</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Define the first inner projection as a projection on the <code>firstName</code> field of <code>authors</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Define the second inner projection as a projection on the <code>lastName</code> field of <code>authors</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Define the result of the projection as a list,
meaning the hits will be <code>List</code> instances with at index <code>0</code> the value of the <code>firstName</code> field of <code>authors</code> ,
and at index <code>1</code> the value of the <code>lastName</code> field of <code>authors</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Define the projection as multivalued,
meaning it will yield values of type <code>List&lt;List&lt;?&gt;&gt;</code>:
one <code>List&lt;?&gt;</code> per object in the <code>authors</code> object field.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Each hit will be an instance of <code>List&lt;List&lt;?&gt;&gt;</code>:
a list containing one list per author, which in turns contains the result of the inner projections, in the given order.
Thus, the list of hits will be an instance of <code>List&lt;List&lt;List&lt;?&gt;&gt;&gt;</code>.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>Similarly, to get the result of inner projections as an array (<code>Object[]</code>),
you can do without the transformer by calling <code>asArray()</code>:</p>
</div>
<div class="exampleblock">
<div class="title">Example 336. Returning an array of projected values with <code>.object(&#8230;&#8203;).add(&#8230;&#8203;).asArray()</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;<span class="predefined-type">List</span>&lt;<span class="predefined-type">Object</span><span class="type">[]</span>&gt;&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .select( f -&gt; f.object( <span class="string"><span class="delimiter">&quot;</span><span class="content">authors</span><span class="delimiter">&quot;</span></span> ) <i class="conum" data-value="1"></i><b>(1)</b>
                .from( f.field( <span class="string"><span class="delimiter">&quot;</span><span class="content">authors.firstName</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">String</span>.class ), <i class="conum" data-value="2"></i><b>(2)</b>
                        f.field( <span class="string"><span class="delimiter">&quot;</span><span class="content">authors.lastName</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">String</span>.class ) ) <i class="conum" data-value="3"></i><b>(3)</b>
                .asArray() <i class="conum" data-value="4"></i><b>(4)</b>
                .multi() ) <i class="conum" data-value="5"></i><b>(5)</b>
        .where( f -&gt; f.matchAll() )
        .fetchHits( <span class="integer">20</span> ); <i class="conum" data-value="6"></i><b>(6)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Call <code>.object( "authors" )</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Define the first inner projection as a projection on the <code>firstName</code> field of <code>authors</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Define the second inner projection as a projection on the <code>lastName</code> field of <code>authors</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Define the result of the projection as an array,
meaning the hits will be <code>Object[]</code> instances with at index <code>0</code> the value of the <code>firstName</code> field of <code>authors</code> ,
and at index <code>1</code> the value of the <code>lastName</code> field of <code>authors</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Define the projection as multivalued,
meaning it will yield values of type <code>List&lt;Object[]&gt;</code>:
one <code>Object[]</code> per object in the <code>authors</code> object field.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Each hit will be an instance of <code>List&lt;Object[]&gt;</code>:
a list containing one array per author, which in turns contains the result of the inner projections, in the given order.
Thus, the list of hits will be an instance of <code>List&lt;List&lt;Object[]&gt;&gt;</code>.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="search-dsl-projection-object-as-mapped"><a class="anchor" href="#search-dsl-projection-object-as-mapped"></a>Projecting to a custom (annotated) type</h5>
<div class="paragraph">
<p>For more complex object projections, it is possible to define a custom (annotated) record or class
and have Hibernate Search infer the corresponding inner projections from the custom type&#8217;s constructor parameters.
This is similar to the <a href="#search-dsl-projection-mapped">projection to a custom (annotated) type through <code>.select(&#8230;&#8203;)</code></a>.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>There are a few constraints to keep in mind when annotating a custom projection type:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The custom projection type must be in the same JAR as entity types,
or Hibernate Search will <a href="#mapping-projection-type-detection">require additional configuration</a>.</p>
</li>
<li>
<p>When projecting on value fields or object fields, the path to the projected field
is inferred from the constructor parameter name by default,
but <a href="#mapping-projection-inner-inference-fieldpath">inference will fail if constructor parameter names are not included in the Java bytecode</a>.
Alternatively the path can be provided explicitly
through <a href="#search-dsl-projection-field-mapping"><code>@FieldProjection(path = &#8230;&#8203;)</code></a>/<a href="#search-dsl-projection-object-mapping"><code>@ObjectProjection(path = &#8230;&#8203;)</code></a>,
in which case Hibernate Search won&#8217;t rely on constructor parameter names.</p>
</li>
<li>
<p>When projecting on value fields, the constraints of the <a href="#search-dsl-projection-field"><code>field</code></a> projection still apply.
In particular, with the <a href="#backend-lucene">Lucene backend</a>, value fields involved in the projection
must be configured as <a href="#mapping-directfieldmapping-projectable">projectable</a>.</p>
</li>
<li>
<p>When projecting on object fields, the constraints of the <a href="#search-dsl-projection-object"><code>object</code></a> projection still apply.
In particular, with the <a href="#backend-lucene">Lucene backend</a>, multi-valued object fields involved in the projection
must be configured as <a href="#mapping-indexedembedded-structure-nested">nested</a>.</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="exampleblock">
<div class="title">Example 337. Using a custom record type to project data created from an object field</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="annotation">@ProjectionConstructor</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="directive">public</span> record MyAuthorProjection(<span class="predefined-type">String</span> firstName, <span class="predefined-type">String</span> lastName) { <i class="conum" data-value="2"></i><b>(2)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Annotate the record type with <code>@ProjectionConstructor</code>,
either at the type level (if there&#8217;s only one constructor)
or at the constructor level (if there are <a href="#mapping-projection-multiple-constructors">multiple constructors</a>).</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>To project on a value field, add a constructor parameter named after that field and with the same type as that field.
See <a href="#mapping-projection-inner-inference"> Implicit inner projection inference</a> for more information on how constructor parameters should be defined.
<div class="paragraph">
<p>Alternatively, the field projection can be configured explicitly with <a href="#search-dsl-projection-field-mapping"><code>@FieldProjection</code></a>.</p>
</div>
<div class="paragraph">
<p>Most projections have a corresponding annotation that can be used on constructor parameters.</p>
</div></td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;<span class="predefined-type">List</span>&lt;MyAuthorProjection&gt;&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .select( f -&gt; f.object( <span class="string"><span class="delimiter">&quot;</span><span class="content">authors</span><span class="delimiter">&quot;</span></span> ) <i class="conum" data-value="1"></i><b>(1)</b>
                .as( MyAuthorProjection.class ) <i class="conum" data-value="2"></i><b>(2)</b>
                .multi() ) <i class="conum" data-value="3"></i><b>(3)</b>
        .where( f -&gt; f.matchAll() )
        .fetchHits( <span class="integer">20</span> ); <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Call <code>.object( "authors" )</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Define the result of the projection as a custom (annotated) type.
Hibernate Search will <a href="#mapping-projection-inner-inference">infer the inner projections</a>
from the custom type&#8217;s constructor parameters.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Each hit will be an instance of the custom projection type,
populated with data retrieved from the index.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Custom, non-record classes can also be annotated with <code>@ProjectionConstructor</code>,
which can be useful if you cannot use records for some reason
(for example because you&#8217;re still using Java 13 or below).</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
For more information about mapping custom projection types, see <a href="#mapping-projection"> Mapping index content to custom types (projection constructors)</a>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="search-dsl-projection-object-mapping"><a class="anchor" href="#search-dsl-projection-object-mapping"></a><code>@ObjectProjection</code> in projections to custom types</h5>
<div class="paragraph">
<p>To achieve an <code>object</code> projection inside a <a href="#search-dsl-projection-mapped">projection to an annotated custom type</a>,
you can rely on the default <a href="#mapping-projection-inner-inference">inferred projection</a>:
when no annotations are present on a constructor parameter,
it will be inferred to an object projection to the field with the same name as the constructor parameter
(or a <a href="#search-dsl-projection-field">field projection</a>,
see <a href="#mapping-projection-inner-inference-type">here for details</a>).</p>
</div>
<div class="paragraph">
<p>To force an object projection,
or to customize the object projection further (for example to set the field path explicitly),
use the <code>@ObjectProjection</code> annotation on the constructor parameter:</p>
</div>
<div class="exampleblock">
<div class="title">Example 338. Returning custom objects created from an object field within a projection constructor</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="annotation">@ProjectionConstructor</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="directive">public</span> record MyBookTitleAndAuthorsProjection(
        <span class="annotation">@ObjectProjection</span> <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="predefined-type">List</span>&lt;MyAuthorProjection&gt; authors, <i class="conum" data-value="3"></i><b>(3)</b>
        <span class="annotation">@ObjectProjection</span>(path = <span class="string"><span class="delimiter">&quot;</span><span class="content">mainAuthor</span><span class="delimiter">&quot;</span></span>) <i class="conum" data-value="4"></i><b>(4)</b>
        MyAuthorProjection theMainAuthor, <i class="conum" data-value="5"></i><b>(5)</b>
        <span class="predefined-type">String</span> title <i class="conum" data-value="6"></i><b>(6)</b>
) {
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Annotate the record type with <a href="#mapping-projection-basics"><code>@ProjectionConstructor</code></a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Annotate the parameter that should receive the objects with <code>@ObjectProjection</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>For multi-valued projections,
the type of the constructor parameter must be assignable from <code>List&lt;T&gt;</code>,
where <code>T</code> is a type that has a projection constructor itself.
See <a href="#mapping-projection-inner-inference-type"> Inner projection and type</a> for more information.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Annotation attributes allow customization.
<div class="paragraph">
<p>Here we&#8217;re using a path that is different from the name of the Java constructor parameter.</p>
</div></td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>For single-valued projections,
the type of the constructor parameter must have a projection constructor itself.
See <a href="#mapping-projection-inner-inference-type"> Inner projection and type</a> for more information.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>You can of course also declare other parameters with different projections;
in this example an <a href="#mapping-projection-inner-inference">inferred projection</a> to the <code>title</code> field.</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;MyBookTitleAndAuthorsProjection&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .select( MyBookTitleAndAuthorsProjection.class )<i class="conum" data-value="1"></i><b>(1)</b>
        .where( f -&gt; f.matchAll() )
        .fetchHits( <span class="integer">20</span> ); <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Pass the custom projection type to <code>.select(&#8230;&#8203;)</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Each hit will be an instance of the custom projection type,
populated with the requested objects.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>The annotation exposes the following attributes:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>path</code></dt>
<dd>
<p><a id="search-dsl-projection-object-mapping-path"></a> The path to the projected field.</p>
<div class="paragraph">
<p>If not set, it is inferred from the constructor parameter name.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Field path inference will <a href="#mapping-projection-inner-inference-fieldpath">fail if constructor parameter names are not included in the Java bytecode</a>.</p>
</div>
</td>
</tr>
</table>
</div>
</dd>
<dt class="hdlist1"><code>includePaths</code></dt>
<dd>
<p>See <a href="#search-dsl-projection-object-mapping-filters"><code>@ObjectProjection</code> filters to exclude nested projections and break <code>@ObjectProjection</code> cycles</a>.</p>
</dd>
<dt class="hdlist1"><code>excludePaths</code></dt>
<dd>
<p>See <a href="#search-dsl-projection-object-mapping-filters"><code>@ObjectProjection</code> filters to exclude nested projections and break <code>@ObjectProjection</code> cycles</a>.</p>
</dd>
<dt class="hdlist1"><code>includeDepth</code></dt>
<dd>
<p>See <a href="#search-dsl-projection-object-mapping-filters"><code>@ObjectProjection</code> filters to exclude nested projections and break <code>@ObjectProjection</code> cycles</a>.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>For <a href="#mapping-projection-programmatic">programmatic mapping</a>, use <code>ObjectProjectionBinder.create()</code>.</p>
</div>
<div class="exampleblock">
<div class="title">Example 339. Programmatic mapping of an <code>object</code> projection within a projection constructor</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">TypeMappingStep myBookTitleAndAuthorsProjection =
        mapping.type( MyBookTitleAndAuthorsProjection.class );
myBookTitleAndAuthorsProjection.mainConstructor()
        .projectionConstructor();
myBookTitleAndAuthorsProjection.mainConstructor().parameter( <span class="integer">0</span> )
        .projection( ObjectProjectionBinder.create() );
myBookTitleAndAuthorsProjection.mainConstructor().parameter( <span class="integer">1</span> )
        .projection( ObjectProjectionBinder.create( <span class="string"><span class="delimiter">&quot;</span><span class="content">mainAuthor</span><span class="delimiter">&quot;</span></span> ) );</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="search-dsl-projection-object-mapping-filters"><a class="anchor" href="#search-dsl-projection-object-mapping-filters"></a><code>@ObjectProjection</code> filters to exclude nested projections and break <code>@ObjectProjection</code> cycles</h5>
<div class="paragraph">
<p>By default, <a href="#search-dsl-projection-object-mapping"><code>@ObjectProjection</code></a>
and <a href="#mapping-projection-inner-inference">inferred object projections</a> will include
every projection encountered in the projection constructor of the projected type, recursively.</p>
</div>
<div class="paragraph">
<p>This will work just fine for simpler use cases, but may lead to problems for more complex models:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If the projection constructor of the projected type declares many nested projections,
only some of which are actually useful to the "surrounding" type,
the extra projections will decrease search performance needlessly.</p>
</li>
<li>
<p>If there is a cycle of <code>@ObjectProjection</code>
(e.g. <code>A</code> includes a nested object projection <code>b</code> of type <code>B</code>, which includes a nested projection <code>a</code> of type <code>A</code>)
the root projection type will end up with an infinite amount of fields
(<code>a.b.someField</code>, <code>a.b.a.b.someField</code>, <code>a.b.a.b.a.b.someField</code>, &#8230;&#8203;),
which Hibernate Search will detect and reject with an exception.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To address these problems, it is possible to apply filters
to only include those nested projections that are actually useful.
Projections on excluded fields, at runtime, will have their value set to <code>null</code>,
or an empty list for multivalued projections.</p>
</div>
<div class="paragraph">
<p>Available filtering attributes on <code>@ObjectProjection</code> are:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>includePaths</code></dt>
<dd>
<p>The paths of nested index field to be included,
i.e. for which the corresponding nested projections will actually be retrieved from the index.</p>
<div class="paragraph">
<p>Provided paths must be relative to the projected object field,
i.e. they must not include its <a href="#search-dsl-projection-object-mapping-path">path</a>.</p>
</div>
<div class="paragraph">
<p>This takes precedence over <code>includeDepth</code> (see below).</p>
</div>
<div class="paragraph">
<p>Cannot be used in combination with <code>excludePaths</code> in the same <code>@ObjectProjection</code>.</p>
</div>
</dd>
<dt class="hdlist1"><code>excludePaths</code></dt>
<dd>
<p>The paths of index fields from the indexed-embedded element that must <strong>not</strong> be embedded.</p>
<div class="paragraph">
<p>Provided paths must be relative to the projected object field,
i.e. they must not include its <a href="#search-dsl-projection-object-mapping-path">path</a>.</p>
</div>
<div class="paragraph">
<p>This takes precedence over <code>includeDepth</code> (see below).</p>
</div>
<div class="paragraph">
<p>Cannot be used in combination with <code>includePaths</code> in the same <code>@ObjectProjection</code>.</p>
</div>
</dd>
<dt class="hdlist1"><code>includeDepth</code></dt>
<dd>
<p>The number of levels of indexed-embedded that will have all their fields included by default.</p>
<div class="paragraph">
<p><code>includeDepth</code> is the number of levels of object projections that
will have all their nested field/object projections
included by default and actually be retrieved from the index.</p>
</div>
<div class="paragraph">
<p>Up to and including that depth, object projections
will be included along with their nested (non-object) field projections,
even if these fields are not included explicitly through <code>includePaths</code>,
unless these fields are excluded explicitly through <code>excludePaths</code>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>includeDepth=0</code> means fields of this object projection are <strong>not</strong> included,
nor is any field of nested indexed-embedded elements,
unless these fields are included explicitly through <code>includePaths</code>.</p>
</li>
<li>
<p><code>includeDepth=1</code> means fields of this object projection <strong>are</strong> included,
unless these fields are excluded explicitly through <code>excludePaths</code>,
but <strong>not</strong> fields of nested object projections (<code>@ObjectProjection</code> within this <code>@ObjectProjection</code>),
unless these fields are included explicitly through <code>includePaths</code>.</p>
</li>
<li>
<p><code>includeDepth=2</code> means fields of this object projection
and fields of immediately nested object projections (<code>@ObjectProjection</code> within this <code>@ObjectProjection</code>) <strong>are</strong> included,
unless these fields are explicitly excluded through <code>excludePaths</code>,
but <strong>not</strong> fields of nested object projections beyond that
(<code>@ObjectProjection</code> within an <code>@ObjectProjection</code> within this <code>@ObjectProjection</code>),
unless these fields are included explicitly through <code>includePaths</code>.</p>
</li>
<li>
<p>And so on.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The default value depends on the value of the <code>includePaths</code> attribute:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>if <code>includePaths</code> is empty, <code>includeDepth</code> defaults to infinity (include all fields at every level).</p>
</li>
<li>
<p>if <code>includePaths</code> is <strong>not</strong> empty, <code>includeDepth</code> defaults to <code>0</code>
(only include fields included explicitly).</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Mixing <code>includePaths</code> and <code>excludePaths</code> at different nesting levels</div>
<div class="paragraph">
<p>In general, it is possible to use <code>includePaths</code> and <code>excludePaths</code> at different levels of nested <code>@ObjectProjection</code>.
When doing so, keep in mind that the filter at each level can only reference reachable paths,
i.e. a filter cannot reference a path that was excluded by a nested <code>@ObjectProjection</code> (implicitly or explicitly).</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Below are three examples: one leveraging <code>includePaths</code> only,
one leveraging <code>excludePaths</code>, and one leveraging <code>includePaths</code> and <code>includeDepth</code>.</p>
</div>
<div class="paragraph">
<p>All three examples are based on the following mapped entity
that rely on <a href="#mapping-indexedembedded">@IndexedEmbedded</a>
and the <a href="#mapping-indexedembedded-filtering">very similar filters</a> it provides:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="annotation">@Entity</span>
<span class="annotation">@Indexed</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">Human</span> {

    <span class="annotation">@Id</span>
    <span class="directive">private</span> <span class="predefined-type">Integer</span> id;

    <span class="annotation">@FullTextField</span>(analyzer = <span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>, projectable = Projectable.YES)
    <span class="directive">private</span> <span class="predefined-type">String</span> name;

    <span class="annotation">@FullTextField</span>(analyzer = <span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>, projectable = Projectable.YES)
    <span class="directive">private</span> <span class="predefined-type">String</span> nickname;

    <span class="annotation">@ManyToMany</span>
    <span class="annotation">@IndexedEmbedded</span>(includeDepth = <span class="integer">5</span>, structure = ObjectStructure.NESTED)
    <span class="directive">private</span> <span class="predefined-type">List</span>&lt;Human&gt; parents = <span class="keyword">new</span> <span class="predefined-type">ArrayList</span>&lt;&gt;();

    <span class="annotation">@ManyToMany</span>(mappedBy = <span class="string"><span class="delimiter">&quot;</span><span class="content">parents</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">private</span> <span class="predefined-type">List</span>&lt;Human&gt; children = <span class="keyword">new</span> <span class="predefined-type">ArrayList</span>&lt;&gt;();

    <span class="directive">public</span> Human() {
    }

    <span class="comment">// Getters and setters</span>
    <span class="comment">// ...</span>

}</code></pre>
</div>
</div>
<div id="search-dsl-projection-object-mapping-filters-example-includepaths" class="exampleblock">
<div class="title">Example 340. Filtering nested projections with <code>includePaths</code></div>
<div class="content">
<div class="paragraph">
<p>This projection will include the following fields:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>name</code></p>
</li>
<li>
<p><code>nickname</code></p>
</li>
<li>
<p><code>parents.name</code>: explicitly included because <code>includePaths</code> on <code>parents</code> includes <code>name</code>.</p>
</li>
<li>
<p><code>parents.nickname</code>: explicitly included because <code>includePaths</code> on <code>parents</code> includes <code>nickname</code>.</p>
</li>
<li>
<p><code>parents.parents.name</code>: explicitly included because <code>includePaths</code> on <code>parents</code> includes <code>parents.name</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The following fields in particular are excluded:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>parents.parents.nickname</code>: <strong>not</strong> implicitly included because <code>includeDepth</code> is not set and defaults to <code>0</code>,
and <strong>not</strong> explicitly included either because <code>includePaths</code> on <code>parents</code> does not include <code>parents.nickname</code>.</p>
</li>
<li>
<p><code>parents.parents.parents.name</code>: <strong>not</strong> implicitly included because <code>includeDepth</code> is not set and defaults to <code>0</code>,
and <strong>not</strong> explicitly included either because <code>includePaths</code> on <code>parents</code> does not include <code>parents.parents.name</code>.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="annotation">@ProjectionConstructor</span>
<span class="directive">public</span> record HumanProjection(
        <span class="annotation">@FieldProjection</span>
        <span class="predefined-type">String</span> name,
        <span class="annotation">@FieldProjection</span>
        <span class="predefined-type">String</span> nickname,
        <span class="annotation">@ObjectProjection</span>(includePaths = { <span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">nickname</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">parents.name</span><span class="delimiter">&quot;</span></span> })
        <span class="predefined-type">List</span>&lt;HumanProjection&gt; parents
) {
}</code></pre>
</div>
</div>
</div>
</div>
<div id="search-dsl-projection-object-mapping-filters-example-excludepaths" class="exampleblock">
<div class="title">Example 341. Filtering nested projections with <code>excludePaths</code></div>
<div class="content">
<div class="paragraph">
<p>This projection will include the same fields as in
<a href="#search-dsl-projection-object-mapping-filters-example-includepaths">the <code>includePaths</code> example</a>,
but through using the <code>excludePaths</code> instead.</p>
</div>
<div class="paragraph">
<p>This projection will include the following fields:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>name</code></p>
</li>
<li>
<p><code>nickname</code></p>
</li>
<li>
<p><code>parents.name</code>: implicitly included because <code>includeDepth</code> on <code>parents</code> defaults to infinity.</p>
</li>
<li>
<p><code>parents.nickname</code>: implicitly included because <code>includeDepth</code> on <code>parents</code> defaults to infinity.</p>
</li>
<li>
<p><code>parents.parents.name</code>: implicitly included because <code>includeDepth</code> on <code>parents</code> defaults to infinity.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The following fields in particular are excluded:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>parents.parents.nickname</code>: <strong>not</strong> included because <code>excludePaths</code> explicitly excludes <code>parents.nickname</code>.</p>
</li>
<li>
<p><code>parents.parents.parents</code>/<code>parents.parents.parents.&lt;any-field&gt;</code>: <strong>not</strong> included because <code>excludePaths</code> explicitly excludes <code>parents.parents</code> stopping any further traversing.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="annotation">@ProjectionConstructor</span>
<span class="directive">public</span> record HumanProjection(
        <span class="annotation">@FieldProjection</span>
        <span class="predefined-type">String</span> name,
        <span class="annotation">@FieldProjection</span>
        <span class="predefined-type">String</span> nickname,
        <span class="annotation">@ObjectProjection</span>(excludePaths = { <span class="string"><span class="delimiter">&quot;</span><span class="content">parents.nickname</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">parents.parents</span><span class="delimiter">&quot;</span></span> })
        <span class="predefined-type">List</span>&lt;HumanProjection&gt; parents
) {
}</code></pre>
</div>
</div>
</div>
</div>
<div id="search-dsl-projection-object-mapping-filters-example-includepathsanddepth" class="exampleblock">
<div class="title">Example 342. Filtering nested projections with <code>includePaths</code> and <code>includeDepth</code></div>
<div class="content">
<div class="paragraph">
<p>This projection will include the following fields:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>name</code></p>
</li>
<li>
<p><code>surname</code></p>
</li>
<li>
<p><code>parents.name</code>: implicitly at depth <code>0</code> because <code>includeDepth &gt; 0</code>
(so <code>parents.*</code> is included implicitly).</p>
</li>
<li>
<p><code>parents.nickname</code>: implicitly included at depth <code>0</code> because <code>includeDepth &gt; 0</code>
(so <code>parents.*</code> is included implicitly).</p>
</li>
<li>
<p><code>parents.parents.name</code>: implicitly included at depth <code>1</code> because <code>includeDepth &gt; 1</code>
(so <code>parents.parents.*</code> is included implicitly).</p>
</li>
<li>
<p><code>parents.parents.nickname</code>: implicitly included at depth <code>1</code> because <code>includeDepth &gt; 1</code>
(so <code>parents.parents.*</code> is included implicitly).</p>
</li>
<li>
<p><code>parents.parents.parents.name</code>: <strong>not</strong> implicitly included at depth <code>2</code> because <code>includeDepth = 2</code>
(so <code>parents.parents.parents</code> is included implicitly,
but subfields can only be included explicitly)
but explicitly included because <code>includePaths</code> on <code>parents</code> includes <code>parents.parents.name</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The following fields in particular are excluded:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>parents.parents.parents.nickname</code>: <strong>not</strong> implicitly included at depth <code>2</code> because <code>includeDepth = 2</code>
(so <code>parents.parents.parents</code> is included implicitly, but subfields must be included explicitly)
and <strong>not</strong> explicitly included either because <code>includePaths</code> on <code>parents</code> does not include <code>parents.parents.nickname</code>.</p>
</li>
<li>
<p><code>parents.parents.parents.parents.name</code>: <strong>not</strong> implicitly included at depth <code>3</code> because <code>includeDepth = 2</code>
(so <code>parents.parents.parents</code> is included implicitly,
but <code>parents.parents.parents.parents</code> and subfields can only be included explicitly)
and <strong>not</strong> explicitly included either because <code>includePaths</code> on <code>parents</code> does not include <code>parents.parents.parents.name</code>.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="annotation">@ProjectionConstructor</span>
<span class="directive">public</span> record HumanProjection(
        <span class="annotation">@FieldProjection</span>
        <span class="predefined-type">String</span> name,
        <span class="annotation">@FieldProjection</span>
        <span class="predefined-type">String</span> nickname,
        <span class="annotation">@ObjectProjection</span>(includeDepth = <span class="integer">2</span>, includePaths = { <span class="string"><span class="delimiter">&quot;</span><span class="content">parents.parents.name</span><span class="delimiter">&quot;</span></span> })
        <span class="predefined-type">List</span>&lt;HumanProjection&gt; parents
) {
}</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="search-dsl-projection-constant"><a class="anchor" href="#search-dsl-projection-constant"></a>15.4.12. <code>constant</code>: return a provided constant</h4>
<div class="paragraph">
<p>The <code>constant</code> projection returns the same value for every single document,
the value being provided when defining the projection.</p>
</div>
<div class="paragraph">
<p>This is only useful in some edge cases where one wants to include some broader context in the representation of every single hit.
In this case, the <code>constant</code> value will most likely be used together with
a <a href="#search-dsl-projection-composite"><code>composite</code> projection</a>
or an <a href="#search-dsl-projection-object"><code>object</code> projection</a>.</p>
</div>
<div class="sect4">
<h5 id="search-dsl-projection-constant-syntax"><a class="anchor" href="#search-dsl-projection-constant-syntax"></a>Syntax</h5>
<div class="exampleblock">
<div class="title">Example 343. Returning a constant value for every single matched document</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">Instant searchRequestTimestamp = Instant.now();
<span class="predefined-type">List</span>&lt;MyPair&lt;<span class="predefined-type">Integer</span>, Instant&gt;&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .select( f -&gt; f.composite()
                .from( f.id( <span class="predefined-type">Integer</span>.class ), f.constant( searchRequestTimestamp ) )
                .as( MyPair::<span class="keyword">new</span> ) )
        .where( f -&gt; f.matchAll() )
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="search-dsl-projection-constant-mapping"><a class="anchor" href="#search-dsl-projection-constant-mapping"></a>In projections to custom types</h5>
<div class="paragraph">
<p>There is no built-in annotation to use the <code>constant</code> projection
inside a <a href="#search-dsl-projection-mapped">projection to an annotated custom type</a>.</p>
</div>
<div class="paragraph">
<p>You can <a href="#binding-projection-parameters-custom-annotation">create your own annotation</a> if you need one,
backed by a <a href="#binding-projection">custom projection binder</a>.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="search-dsl-projection-highlight"><a class="anchor" href="#search-dsl-projection-highlight"></a>15.4.13. <code>highlight</code>: return highlighted field values from matched documents</h4>
<div class="paragraph">
<p>The <code>highlight</code> projection returns fragments from full-text fields of matched documents that caused a query match.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>In order to use highlight projections of a given field,
you need to provide the list of <a href="#mapping-directfieldmapping-highlightable">highlighters supported by the field</a> in the mapping.</p>
</div>
<div class="paragraph">
<p>The <a href="#mapping-directfieldmapping-highlightable">highlightable</a> default may already enable the support of highlighting
in some cases. For more details see <a href="#mapping-directfieldmapping-highlightable-default">how the <code>DEFAULT</code> highlightable value behaves</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="search-dsl-projection-highlight-syntax"><a class="anchor" href="#search-dsl-projection-highlight-syntax"></a>Syntax</h5>
<div class="paragraph">
<p>The <code>highlight</code> projection always returns a list of string values per highlighted field, no matter if the field is
a single or a multivalued one:</p>
</div>
<div class="exampleblock">
<div class="title">Example 344. Returning highlights for matched documents</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;<span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt;&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .select( f -&gt; f.highlight( <span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span> ) )
        .where( f -&gt; f.match().field( <span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span> ).matching( <span class="string"><span class="delimiter">&quot;</span><span class="content">detective</span><span class="delimiter">&quot;</span></span> ) )
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
<div class="paragraph">
<p>As an example, the result may look like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JSON">[
    [<span class="string"><span class="delimiter">&quot;</span><span class="content">The Automatic &lt;em&gt;Detective&lt;/em&gt;</span><span class="delimiter">&quot;</span></span>], <i class="conum" data-value="1"></i><b>(1)</b>
    [<span class="string"><span class="delimiter">&quot;</span><span class="content">Dirk Gently's Holistic &lt;em&gt;Detective&lt;/em&gt; Agency</span><span class="delimiter">&quot;</span></span>], <i class="conum" data-value="2"></i><b>(2)</b>
    [
      <span class="string"><span class="delimiter">&quot;</span><span class="content">The Paris &lt;em&gt;Detective&lt;/em&gt;</span><span class="delimiter">&quot;</span></span>,
      <span class="string"><span class="delimiter">&quot;</span><span class="content">&lt;em&gt;Detective&lt;/em&gt; Luc Moncrief series</span><span class="delimiter">&quot;</span></span>
    ], <i class="conum" data-value="3"></i><b>(3)</b>
]</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>First hit.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Second hit.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Third hit with multiple highlighted snippets.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="search-dsl-projection-highlight-multivalued"><a class="anchor" href="#search-dsl-projection-highlight-multivalued"></a>Multivalued fields</h5>
<div class="paragraph">
<p>Each value of a multivalued field is being highlighted. See <a href="#search-dsl-highlighting-highlighter-options">how highlighter can be configured</a>
to adjust the returned results' behaviour and structure.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>At the moment, highlighting a field within a <a href="#mapping-indexedembedded-structure-nested">nested object</a> is <a href="https://hibernate.atlassian.net/browse/HSEARCH-4841">not supported</a> and attempting to do so will lead to an exception.
Highlighting a field within a <a href="#mapping-indexedembedded-structure-flattened">flattened object</a> will work correctly.</p>
</div>
<div class="paragraph">
<p>Placing a highlight projection inside an <a href="#search-dsl-projection-object">object projection</a> is not supported.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="exampleblock">
<div class="title">Example 345. Returning highlights for flattened objects from matched documents</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;<span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt;&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .select( f -&gt; f.highlight( <span class="string"><span class="delimiter">&quot;</span><span class="content">flattenedAuthors.lastName</span><span class="delimiter">&quot;</span></span> ) )
        .where( f -&gt; f.match().field( <span class="string"><span class="delimiter">&quot;</span><span class="content">flattenedAuthors.lastName</span><span class="delimiter">&quot;</span></span> ).matching( <span class="string"><span class="delimiter">&quot;</span><span class="content">martinez</span><span class="delimiter">&quot;</span></span> ) )
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="search-dsl-projection-highlight-options"><a class="anchor" href="#search-dsl-projection-highlight-options"></a>Highlighting options</h5>
<div class="paragraph">
<p>A highlighter can be fine-tuned through its options to change the highlighted output.</p>
</div>
<div class="exampleblock">
<div class="title">Example 346. Configuring the default highlighter</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;<span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt;&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .select( f -&gt; f.highlight( <span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span> ) ) <i class="conum" data-value="1"></i><b>(1)</b>
        .where( f -&gt; f.match().field( <span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span> ).matching( <span class="string"><span class="delimiter">&quot;</span><span class="content">detective</span><span class="delimiter">&quot;</span></span> ) )
        .highlighter( f -&gt; f.unified().tag( <span class="string"><span class="delimiter">&quot;</span><span class="content">&lt;b&gt;</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">&lt;/b&gt;</span><span class="delimiter">&quot;</span></span> ) ) <i class="conum" data-value="2"></i><b>(2)</b>
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Building the highlight query as usual.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Configure the default highlighter. Change the highlighting tag option.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>Additionally, if multiple fields are highlighted, and they need different highlighter options then a named highlighter
can be used to override the default one.</p>
</div>
<div class="exampleblock">
<div class="title">Example 347. Configuring default and named highlighters</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;<span class="predefined-type">List</span>&lt;?&gt;&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .select( f -&gt; f.composite().from(
                f.highlight( <span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span> ),
                f.highlight( <span class="string"><span class="delimiter">&quot;</span><span class="content">description</span><span class="delimiter">&quot;</span></span> ).highlighter( <span class="string"><span class="delimiter">&quot;</span><span class="content">description-highlighter</span><span class="delimiter">&quot;</span></span> ) <i class="conum" data-value="1"></i><b>(1)</b>
        ).asList() )
        .where( f -&gt; f.match().field( <span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span> ).matching( <span class="string"><span class="delimiter">&quot;</span><span class="content">detective</span><span class="delimiter">&quot;</span></span> ) )
        .highlighter( f -&gt; f.unified().tag( <span class="string"><span class="delimiter">&quot;</span><span class="content">&lt;b&gt;</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">&lt;/b&gt;</span><span class="delimiter">&quot;</span></span> ) ) <i class="conum" data-value="2"></i><b>(2)</b>
        .highlighter(
                <span class="string"><span class="delimiter">&quot;</span><span class="content">description-highlighter</span><span class="delimiter">&quot;</span></span>,
                f -&gt; f.unified().tag( <span class="string"><span class="delimiter">&quot;</span><span class="content">&lt;span&gt;</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">&lt;/span&gt;</span><span class="delimiter">&quot;</span></span> )
        ) <i class="conum" data-value="3"></i><b>(3)</b>
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Specifying the name of a named highlighter to be applied to the <code>description</code> field highlight projection.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Configure the default highlighter.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Configure the named highlighter.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>See <a href="#search-dsl-highlighting">Highlight DSL</a> for more information on highlighter configuration.</p>
</div>
</div>
<div class="sect4">
<h5 id="search-dsl-projection-highlight-mapping"><a class="anchor" href="#search-dsl-projection-highlight-mapping"></a><code>@HighlightProjection</code> in projections to custom types</h5>
<div class="paragraph">
<p>To achieve a <code>highlight</code> projection inside a <a href="#search-dsl-projection-mapped">projection to an annotated custom type</a>,
use the <code>@HighlightProjection</code> annotation on the constructor parameter:</p>
</div>
<div class="exampleblock">
<div class="title">Example 348. Returning highlights for matched documents within a projection constructor</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="annotation">@ProjectionConstructor</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="directive">public</span> record MyBookTitleAndHighlightedDescriptionProjection(
        <span class="annotation">@HighlightProjection</span> <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt; description, <i class="conum" data-value="3"></i><b>(3)</b>
        <span class="predefined-type">String</span> title <i class="conum" data-value="4"></i><b>(4)</b>
) {
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Annotate the record type with <a href="#mapping-projection-basics"><code>@ProjectionConstructor</code></a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Annotate the parameter that should receive the highlights value with <code>@HighlightProjection</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The type of the constructor parameter must be assignable from <code>List&lt;String&gt;</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>You can of course also declare other parameters with different projections;
in this example an <a href="#mapping-projection-inner-inference">inferred projection</a> to the <code>title</code> field.</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;MyBookTitleAndHighlightedDescriptionProjection&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .select( MyBookTitleAndHighlightedDescriptionProjection.class )<i class="conum" data-value="1"></i><b>(1)</b>
        .where( f -&gt; f.match().field( <span class="string"><span class="delimiter">&quot;</span><span class="content">description</span><span class="delimiter">&quot;</span></span> ).matching( <span class="string"><span class="delimiter">&quot;</span><span class="content">self-aware</span><span class="delimiter">&quot;</span></span> ) )
        .fetchHits( <span class="integer">20</span> ); <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Pass the custom projection type to <code>.select(&#8230;&#8203;)</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Each hit will be an instance of the custom projection type,
populated with the requested highlights and field.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>The annotation exposes the following attributes:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>path</code></dt>
<dd>
<p>The path to the highlighted field.</p>
<div class="paragraph">
<p>If not set, it is inferred from the constructor parameter name.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Field path inference will <a href="#mapping-projection-inner-inference-fieldpath">fail if constructor parameter names are not included in the Java bytecode</a>.</p>
</div>
</td>
</tr>
</table>
</div>
</dd>
<dt class="hdlist1"><code>highlighter</code></dt>
<dd>
<p>The name of a highlighter configured in the query;
useful to <a href="#search-dsl-projection-highlight-options">apply different options</a> to each highlight projection.</p>
<div class="paragraph">
<p>If not set, the projection will use the default highlighter as configured in the query.</p>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>For <a href="#mapping-projection-programmatic">programmatic mapping</a>, use <code>HighlightProjectionBinder.create()</code>.</p>
</div>
<div class="exampleblock">
<div class="title">Example 349. Programmatic mapping of a <code>highlight</code> projection within a projection constructor</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">TypeMappingStep myBookIdAndHighlightedTitleProjection =
        mapping.type( MyBookTitleAndHighlightedDescriptionProjection.class );
myBookIdAndHighlightedTitleProjection.mainConstructor()
        .projectionConstructor();
myBookIdAndHighlightedTitleProjection.mainConstructor().parameter( <span class="integer">0</span> )
        .projection( HighlightProjectionBinder.create() );</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="search-dsl-projection-highlight-limitations"><a class="anchor" href="#search-dsl-projection-highlight-limitations"></a>Highlight limitations</h5>
<div class="paragraph">
<p>For now, Hibernate Search has limitations on where <a href="#search-dsl-projection-highlight">highlight projections</a> can be included,
and trying to apply highlight projections in these scenarios will lead to an exception being thrown, in particular:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Such projection cannot be a part of an <a href="#search-dsl-projection-object">object projection</a>.</p>
<div class="exampleblock">
<div class="title">Example 350. Illegal use of <code>.highlight(..)</code> projection within an <code>.object(..)</code> projection</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;<span class="predefined-type">List</span>&lt;?&gt;&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .select( f -&gt; f.object( <span class="string"><span class="delimiter">&quot;</span><span class="content">authors</span><span class="delimiter">&quot;</span></span> )
                .from(
                        f.highlight( <span class="string"><span class="delimiter">&quot;</span><span class="content">authors.firstName</span><span class="delimiter">&quot;</span></span> ),
                        f.highlight( <span class="string"><span class="delimiter">&quot;</span><span class="content">authors.lastName</span><span class="delimiter">&quot;</span></span> )
                ).asList()
        )
        .where( f -&gt; f.match().field( <span class="string"><span class="delimiter">&quot;</span><span class="content">authors.firstName</span><span class="delimiter">&quot;</span></span> ).matching( <span class="string"><span class="delimiter">&quot;</span><span class="content">Art*</span><span class="delimiter">&quot;</span></span> ) )
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
<div class="paragraph">
<p>Doing so <strong>will</strong> lead to an <strong>exception</strong>.</p>
</div>
</div>
</div>
</li>
<li>
<p>Fields of an object with a <a href="#mapping-indexedembedded-structure-nested">nested</a> structure cannot be highlighted under any circumstances.</p>
<div class="exampleblock">
<div class="title">Example 351. Illegal use of <code>.highlight(..)</code> projection within an <code>.object(..)</code> projection</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;?&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .select( f -&gt; f.highlight( <span class="string"><span class="delimiter">&quot;</span><span class="content">authors.firstName</span><span class="delimiter">&quot;</span></span> ) )
        .where( f -&gt; f.match().field( <span class="string"><span class="delimiter">&quot;</span><span class="content">authors.firstName</span><span class="delimiter">&quot;</span></span> ).matching( <span class="string"><span class="delimiter">&quot;</span><span class="content">Art*</span><span class="delimiter">&quot;</span></span> ) )
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
<div class="paragraph">
<p>Assuming that <code>authors</code> are mapped as <a href="#mapping-indexedembedded-structure-nested">nested</a> structure, e.g.:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@IndexedEmbedded</span>(structure = ObjectStructure.NESTED)
<span class="directive">private</span> <span class="predefined-type">List</span>&lt;Author&gt; authors = <span class="keyword">new</span> <span class="predefined-type">ArrayList</span>&lt;&gt;();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Trying to apply such projection <strong>will</strong> result in an <strong>exception</strong> being thrown.</p>
</div>
</div>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>These limitations should be addressed by <a href="https://hibernate.atlassian.net/browse/HSEARCH-4841">HSEARCH-4841</a>.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="search-dsl-projection-extensions"><a class="anchor" href="#search-dsl-projection-extensions"></a>15.4.14. Backend-specific extensions</h4>
<div class="paragraph">
<p>By calling <code>.extension(&#8230;&#8203;)</code> while building a query,
it is possible to access backend-specific projections.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>As their name suggests, backend-specific projections are not portable from one backend technology to the other.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="search-dsl-projection-extensions-lucene-document"><a class="anchor" href="#search-dsl-projection-extensions-lucene-document"></a>Lucene: <code>document</code></h5>
<div class="paragraph">
<p>The <code>.document()</code> projection returns the matched document as a native Lucene <code>Document</code>.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This feature implies that application code rely on Lucene APIs directly.</p>
</div>
<div class="paragraph">
<p>An upgrade of Hibernate Search, even for a bugfix (micro) release,
may require an upgrade of Lucene,
which may lead to breaking API changes in Lucene.</p>
</div>
<div class="paragraph">
<p>If this happens, you will need to change application code to deal with the changes.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect5">
<h6 id="search-dsl-projection-extensions-lucene-document-syntax"><a class="anchor" href="#search-dsl-projection-extensions-lucene-document-syntax"></a>Syntax</h6>
<div class="exampleblock">
<div class="title">Example 352. Returning the matched document as a native <code>org.apache.lucene.document.Document</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;<span class="predefined-type">Document</span>&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .extension( LuceneExtension.get() )
        .select( f -&gt; f.document() )
        .where( f -&gt; f.matchAll() )
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The returned document is similar to the one that was indexed.</p>
</div>
<div class="paragraph">
<p>For example, if a value was transformed by the <code>toIndexedValue</code> method
of a <a href="#binding-valuebridge">value bridge</a> upon indexing,
this transformed value (after encoding) will be the value included in the document:
Hibernate Search will not convert it back using <code>ValueBridge#fromIndexedValue</code>.</p>
</div>
<div class="paragraph">
<p>However, there are some differences between the returned document and the one that was indexed:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Only stored fields are present.</p>
</li>
<li>
<p>Even stored fields may not have the same <code>FieldType</code> as they originally had.</p>
</li>
<li>
<p>The document structure flattened,
i.e. even fields from <a href="#mapping-indexedembedded-structure-nested">nested documents</a>
are all added to same returned document.</p>
</li>
<li>
<p><a href="#binding-index-field-dsl-dynamic">Dynamic fields</a> may be missing.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If you want a projection that retrieves the value as it was in your entity upon indexing,
use a <a href="#search-dsl-projection-field"><code>field</code> projection</a>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect5">
<h6 id="search-dsl-projection-extensions-lucene-document-mapping"><a class="anchor" href="#search-dsl-projection-extensions-lucene-document-mapping"></a>In projections to custom types</h6>
<div class="paragraph">
<p>There is no built-in annotation to use the <code>document</code> projection
inside a <a href="#search-dsl-projection-mapped">projection to an annotated custom type</a>.</p>
</div>
<div class="paragraph">
<p>You can <a href="#binding-projection-parameters-custom-annotation">create your own annotation</a> if you need one,
backed by a <a href="#binding-projection">custom projection binder</a>.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="search-dsl-projection-extensions-lucene-explanation"><a class="anchor" href="#search-dsl-projection-extensions-lucene-explanation"></a>Lucene: <code>explanation</code></h5>
<div class="paragraph">
<p>The <code>.explanation()</code> projection returns an <a href="#troubleshooting-faq-search-score">explanation</a>
of the match as a native Lucene <code>Explanation</code>.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Regardless of the API used, explanations are rather costly performance-wise:
only use them for debugging purposes.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This feature implies that application code rely on Lucene APIs directly.</p>
</div>
<div class="paragraph">
<p>An upgrade of Hibernate Search, even for a bugfix (micro) release,
may require an upgrade of Lucene,
which may lead to breaking API changes in Lucene.</p>
</div>
<div class="paragraph">
<p>If this happens, you will need to change application code to deal with the changes.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect5">
<h6 id="search-dsl-projection-extensions-lucene-explanation-syntax"><a class="anchor" href="#search-dsl-projection-extensions-lucene-explanation-syntax"></a>Syntax</h6>
<div class="exampleblock">
<div class="title">Example 353. Returning the score explanation as a native <code>org.apache.lucene.search.Explanation</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;Explanation&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .extension( LuceneExtension.get() )
        .select( f -&gt; f.explanation() )
        .where( f -&gt; f.matchAll() )
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect5">
<h6 id="search-dsl-projection-extensions-lucene-explanation-mapping"><a class="anchor" href="#search-dsl-projection-extensions-lucene-explanation-mapping"></a>In projections to custom types</h6>
<div class="paragraph">
<p>There is no built-in annotation to use the <code>explanation</code> projection
inside a <a href="#search-dsl-projection-mapped">projection to an annotated custom type</a>.</p>
</div>
<div class="paragraph">
<p>You can <a href="#binding-projection-parameters-custom-annotation">create your own annotation</a> if you need one,
backed by a <a href="#binding-projection">custom projection binder</a>.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="search-dsl-projection-extensions-elasticsearch-source"><a class="anchor" href="#search-dsl-projection-extensions-elasticsearch-source"></a>Elasticsearch: <code>source</code></h5>
<div class="paragraph">
<p>The <code>.source()</code> projection returns the JSON of the document as it was indexed in Elasticsearch,
as a <code>JsonObject</code>.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This feature requires to directly manipulate JSON in application code.</p>
</div>
<div class="paragraph">
<p>The syntax of this JSON may change:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>when you upgrade the underlying Elasticsearch cluster to the next version;</p>
</li>
<li>
<p>when you upgrade Hibernate Search to the next version, even for a bugfix (micro) release.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If this happens, you will need to change application code to deal with the changes.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect5">
<h6 id="search-dsl-projection-extensions-elasticsearch-source-syntax"><a class="anchor" href="#search-dsl-projection-extensions-elasticsearch-source-syntax"></a>Syntax</h6>
<div class="exampleblock">
<div class="title">Example 354. Returning the matched document source as a <code>JsonObject</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;JsonObject&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .extension( ElasticsearchExtension.get() )
        .select( f -&gt; f.source() )
        .where( f -&gt; f.matchAll() )
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The source is returned exactly as it appears in the response from Elasticsearch.
In particular, Hibernate Search will not apply any kind of the conversions
described in <a href="#search-dsl-projected-value-type">Type of projected values</a>.</p>
</div>
<div class="paragraph">
<p>For example, if a value was transformed by the <code>toIndexedValue</code> method
of a <a href="#binding-valuebridge">value bridge</a> upon indexing,
this transformed value will be the value included in the source:
Hibernate Search will not convert it back using <code>ValueBridge#fromIndexedValue</code>.</p>
</div>
<div class="paragraph">
<p>If you want a projection that retrieves the value as it was in your entity upon indexing,
use a <a href="#search-dsl-projection-field"><code>field</code> projection</a>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect5">
<h6 id="search-dsl-projection-extensions-elasticsearch-source-mapping"><a class="anchor" href="#search-dsl-projection-extensions-elasticsearch-source-mapping"></a>In projections to custom types</h6>
<div class="paragraph">
<p>There is no built-in annotation to use the <code>source</code> projection
inside a <a href="#search-dsl-projection-mapped">projection to an annotated custom type</a>.</p>
</div>
<div class="paragraph">
<p>You can <a href="#binding-projection-parameters-custom-annotation">create your own annotation</a> if you need one,
backed by a <a href="#binding-projection">custom projection binder</a>.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="search-dsl-projection-extensions-elasticsearch-explanation"><a class="anchor" href="#search-dsl-projection-extensions-elasticsearch-explanation"></a>Elasticsearch: <code>explanation</code></h5>
<div class="paragraph">
<p>The <code>.explanation()</code> projection returns an <a href="#troubleshooting-faq-search-score">explanation</a>
of the match as a <code>JsonObject</code>.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Regardless of the API used, explanations are rather costly performance-wise:
only use them for debugging purposes.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This feature requires to directly manipulate JSON in application code.</p>
</div>
<div class="paragraph">
<p>The syntax of this JSON may change:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>when you upgrade the underlying Elasticsearch cluster to the next version;</p>
</li>
<li>
<p>when you upgrade Hibernate Search to the next version, even for a bugfix (micro) release.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If this happens, you will need to change application code to deal with the changes.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect5">
<h6 id="search-dsl-projection-extensions-elasticsearch-explanation-syntax"><a class="anchor" href="#search-dsl-projection-extensions-elasticsearch-explanation-syntax"></a>Syntax</h6>
<div class="exampleblock">
<div class="title">Example 355. Returning the score explanation as a <code>JsonObject</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;JsonObject&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .extension( ElasticsearchExtension.get() )
        .select( f -&gt; f.explanation() )
        .where( f -&gt; f.matchAll() )
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect5">
<h6 id="search-dsl-projection-extensions-elasticsearch-explanation-mapping"><a class="anchor" href="#search-dsl-projection-extensions-elasticsearch-explanation-mapping"></a>In projections to custom types</h6>
<div class="paragraph">
<p>There is no built-in annotation to use the <code>explanation</code> projection
inside a <a href="#search-dsl-projection-mapped">projection to an annotated custom type</a>.</p>
</div>
<div class="paragraph">
<p>You can <a href="#binding-projection-parameters-custom-annotation">create your own annotation</a> if you need one,
backed by a <a href="#binding-projection">custom projection binder</a>.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="search-dsl-projection-extensions-elasticsearch-jsonHit"><a class="anchor" href="#search-dsl-projection-extensions-elasticsearch-jsonHit"></a>Elasticsearch: <code>jsonHit</code></h5>
<div class="paragraph">
<p>The <code>.jsonHit()</code> projection returns the exact JSON returned by Elasticsearch for the hit, as a <code>JsonObject</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This is particularly useful when <a href="#search-dsl-query-elasticsearch-json">customizing the request&#8217;s JSON</a>
to ask for additional data within each hit.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This feature requires to directly manipulate JSON in application code.</p>
</div>
<div class="paragraph">
<p>The syntax of this JSON may change:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>when you upgrade the underlying Elasticsearch cluster to the next version;</p>
</li>
<li>
<p>when you upgrade Hibernate Search to the next version, even for a bugfix (micro) release.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If this happens, you will need to change application code to deal with the changes.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect5">
<h6 id="search-dsl-projection-extensions-elasticsearch-jsonHit-syntax"><a class="anchor" href="#search-dsl-projection-extensions-elasticsearch-jsonHit-syntax"></a>Syntax</h6>
<div class="exampleblock">
<div class="title">Example 356. Returning the Elasticsearch hit as a <code>JsonObject</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;JsonObject&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .extension( ElasticsearchExtension.get() )
        .select( f -&gt; f.jsonHit() )
        .where( f -&gt; f.matchAll() )
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect5">
<h6 id="search-dsl-projection-extensions-elasticsearch-jsonHit-mapping"><a class="anchor" href="#search-dsl-projection-extensions-elasticsearch-jsonHit-mapping"></a>In projections to custom types</h6>
<div class="paragraph">
<p>There is no built-in annotation to use the <code>jsonHit</code> projection
inside a <a href="#search-dsl-projection-mapped">projection to an annotated custom type</a>.</p>
</div>
<div class="paragraph">
<p>You can <a href="#binding-projection-parameters-custom-annotation">create your own annotation</a> if you need one,
backed by a <a href="#binding-projection">custom projection binder</a>.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="search-dsl-highlighting"><a class="anchor" href="#search-dsl-highlighting"></a>15.5. Highlight DSL</h3>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Features detailed below are <em>incubating</em>: they are still under active development.</p>
</div>
<div class="paragraph">
<p>The usual <a href="https://hibernate.org/community/compatibility-policy/">compatibility policy</a> does not apply:
the contract of incubating elements (e.g. types, methods, configuration properties, etc.)
may be altered in a backward-incompatible way&#8201;&#8212;&#8201;or even removed&#8201;&#8212;&#8201;in subsequent releases.</p>
</div>
<div class="paragraph">
<p>You are encouraged to use incubating features so the development team can get feedback and improve them,
but you should be prepared to update code which relies on them as needed.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="search-dsl-highlighting-basics"><a class="anchor" href="#search-dsl-highlighting-basics"></a>15.5.1. Basics</h4>
<div class="paragraph">
<p>Highlighting is a projection that returns fragments from full-text fields of matched documents that caused a query match.
Specific terms that caused the match are "highlighted" with a pair of opening and closing tags.
It can help a user to quickly identify the information they were searching for on a results page.</p>
</div>
<div class="paragraph">
<p>Highlight projections are only available for <a href="#mapping-directfieldmapping-annotations-fulltextfield">full-text fields</a>
with an attribute configuration that allows it:</p>
</div>
<div id="search-dsl-highlighting-configuring-fields-for-highlighting" class="exampleblock">
<div class="title">Example 357. Configuring fields for highlighting</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="annotation">@Entity</span>(name = <span class="predefined-type">Book</span>.NAME)
<span class="annotation">@Indexed</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">Book</span> {

    <span class="directive">public</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> NAME = <span class="string"><span class="delimiter">&quot;</span><span class="content">Book</span><span class="delimiter">&quot;</span></span>;

    <span class="annotation">@Id</span>
    <span class="directive">private</span> <span class="predefined-type">Integer</span> id;

    <span class="annotation">@FullTextField</span>(analyzer = <span class="string"><span class="delimiter">&quot;</span><span class="content">english</span><span class="delimiter">&quot;</span></span>) <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="directive">private</span> <span class="predefined-type">String</span> author;

    <span class="annotation">@FullTextField</span>(analyzer = <span class="string"><span class="delimiter">&quot;</span><span class="content">english</span><span class="delimiter">&quot;</span></span>,
            highlightable = { Highlightable.PLAIN, Highlightable.UNIFIED }) <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="directive">private</span> <span class="predefined-type">String</span> title;

    <span class="annotation">@FullTextField</span>(analyzer = <span class="string"><span class="delimiter">&quot;</span><span class="content">english</span><span class="delimiter">&quot;</span></span>,
            highlightable = Highlightable.ANY) <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="annotation">@Column</span>(length = <span class="integer">10000</span>)
    <span class="directive">private</span> <span class="predefined-type">String</span> description;

    <span class="annotation">@FullTextField</span>(analyzer = <span class="string"><span class="delimiter">&quot;</span><span class="content">english</span><span class="delimiter">&quot;</span></span>,
            projectable = Projectable.YES,
            termVector = TermVector.WITH_POSITIONS_OFFSETS) <i class="conum" data-value="4"></i><b>(4)</b>
    <span class="annotation">@Column</span>(length = <span class="integer">10000</span>)
    <span class="annotation">@ElementCollection</span>
    <span class="directive">private</span> <span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt; text;

    <span class="annotation">@GenericField</span> <i class="conum" data-value="5"></i><b>(5)</b>
    <span class="annotation">@Column</span>(length = <span class="integer">10000</span>)
    <span class="annotation">@ElementCollection</span>
    <span class="directive">private</span> <span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt; keywords;


}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>A regular full-text field.
Such field can allow highlight projections if the <a href="#backend-elasticsearch">Elasticsearch backend</a> is used.
See the definition of the <a href="#mapping-directfieldmapping-highlightable-default">default highlightable</a> for any details.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>A full-text field that explicitly allows for plain and unified highlighters to be applied to it.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>A full-text field that explicitly allows any highlighter types to be applied to it.
See the definition of the <a href="#mapping-directfieldmapping-highlightable-any"><code>ANY</code> highlightable</a> for further details.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>A full-text field that implicitly allows any highlighter types to be applied to it.
Allowing projection and setting the term vector storage strategy to <code>WITH_POSITIONS_OFFSETS</code>
implies that any highlighter type can be used to create a highlight projection with both <a href="#backend-lucene">Lucene</a>
or <a href="#backend-elasticsearch">Elasticsearch</a> backends.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>A generic text field&#8201;&#8212;&#8201;such field will not allow highlight projections.</td>
</tr>
</table>
</div>
</div>
</div>
<div id="search-dsl-highlighting-using-highlight-projection" class="exampleblock">
<div class="title">Example 358. Using a highlight projection</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">SearchSession searchSession = <span class="comment">/* ... */</span> <i class="conum" data-value="1"></i><b>(1)</b>

<span class="predefined-type">List</span>&lt;<span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt;&gt; result = searchSession.search( <span class="predefined-type">Book</span>.class ) <i class="conum" data-value="2"></i><b>(2)</b>
        .select( f -&gt; f.highlight( <span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span> ) ) <i class="conum" data-value="3"></i><b>(3)</b>
        .where( f -&gt; f.match().field( <span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span> ).matching( <span class="string"><span class="delimiter">&quot;</span><span class="content">mystery</span><span class="delimiter">&quot;</span></span> ) ) <i class="conum" data-value="4"></i><b>(4)</b>
        .fetchHits( <span class="integer">20</span> ); <i class="conum" data-value="5"></i><b>(5)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><a href="#entrypoints-search-session">Retrieve the <code>SearchSession</code></a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Start building the query as usual.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Mention that the expected result of the query is the highlights on the "title" field.
An exception will be thrown if the field is not a <a href="#mapping-directfieldmapping-annotations-fulltextfield">full-text field</a>
with <a href="#mapping-directfieldmapping-highlightable">highlighting enabled</a> or if it does not exist.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The predicate from the where clause will be used to determine which documents to include in the results
and highlight the text from the "title" field.
<div class="paragraph">
<p>Note that to get a nonempty list for a highlight projection,
the field we apply such projection to should be a part of a predicate.
If there&#8217;s no match within the field we want to highlight, be it because the document was added to the results because
of some other predicate condition, or because the highlighted field wasn&#8217;t a part of a predicate at all, an empty list will be returned by default.
See <a href="#search-dsl-highlighting-highlighter-options-no-match-size">no match size configuration</a> option for more details on how this can be adjusted.</p>
</div></td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Fetch the results, which will have highlighted fragments.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Note that the result of applying a highlight projection is always a list of <code>String</code>.</p>
</div>
<div class="paragraph">
<p>As an example, the result may look like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JSON">[
    [<span class="string"><span class="delimiter">&quot;</span><span class="content">The Boscombe Valley &lt;em&gt;Mystery&lt;/em&gt;</span><span class="delimiter">&quot;</span></span>], <i class="conum" data-value="1"></i><b>(1)</b>
    [
      <span class="string"><span class="delimiter">&quot;</span><span class="content">A Caribbean &lt;em&gt;Mystery&lt;/em&gt;</span><span class="delimiter">&quot;</span></span>,
      <span class="string"><span class="delimiter">&quot;</span><span class="content">Miss Marple: A Caribbean &lt;em&gt;Mystery&lt;/em&gt; by Agatha Christie</span><span class="delimiter">&quot;</span></span>
    ], <i class="conum" data-value="2"></i><b>(2)</b>
    [<span class="string"><span class="delimiter">&quot;</span><span class="content">A &lt;em&gt;Mystery&lt;/em&gt; of &lt;em&gt;Mysteries&lt;/em&gt;: The Death and Life of Edgar Allan Poe</span><span class="delimiter">&quot;</span></span>] <i class="conum" data-value="3"></i><b>(3)</b>
]</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>First hit.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Second hit with multiple highlighted snippets.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Third hit.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>Highlight projections, just like <a href="#search-dsl-projection-field">field projections</a>, can also be used in a combination with
other projection types as well as with other highlight projections:</p>
</div>
<div id="search-dsl-highlighting-using-highlight-projection-composite" class="exampleblock">
<div class="title">Example 359. Using a composite highlight projection</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;<span class="predefined-type">List</span>&lt;?&gt;&gt; result = searchSession.search( <span class="predefined-type">Book</span>.class ) <i class="conum" data-value="1"></i><b>(1)</b>
        .select( f -&gt; f.composite().from(
                f.id(), <i class="conum" data-value="2"></i><b>(2)</b>
                f.field( <span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">String</span>.class ), <i class="conum" data-value="3"></i><b>(3)</b>
                f.highlight( <span class="string"><span class="delimiter">&quot;</span><span class="content">description</span><span class="delimiter">&quot;</span></span> ) <i class="conum" data-value="4"></i><b>(4)</b>
        ).asList() )
        .where( f -&gt; f.match().fields( <span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">description</span><span class="delimiter">&quot;</span></span> ).matching( <span class="string"><span class="delimiter">&quot;</span><span class="content">scandal</span><span class="delimiter">&quot;</span></span> ) ) <i class="conum" data-value="5"></i><b>(5)</b>
        .fetchHits( <span class="integer">20</span> ); <i class="conum" data-value="6"></i><b>(6)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Start building the query as usual.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Add an <a href="#search-dsl-projection-id">id projection</a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Add a <a href="#search-dsl-projection-field">regular field projection</a> on a "title" field.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Add a <a href="#search-dsl-projection-highlight">highlight projection</a> on a "description" field.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Provide a predicate to filter documents and to use to highlight the results.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Fetch the results.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>A highlighter behavior can be configured. See various available <a href="#search-dsl-highlighting-highlighter-options">configuration options</a>.
A highlighter definition is provided after a where clause of a query:</p>
</div>
<div id="search-dsl-highlighting-highlighter-confguring-default-highlighter-simple" class="exampleblock">
<div class="title">Example 360. Configuring a default highlighter</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;<span class="predefined-type">List</span>&lt;?&gt;&gt; result = searchSession.search( <span class="predefined-type">Book</span>.class )
        .select( f -&gt; f.composite().from(
                f.highlight( <span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span> ),
                f.highlight( <span class="string"><span class="delimiter">&quot;</span><span class="content">description</span><span class="delimiter">&quot;</span></span> )
        ).asList() )
        .where( f -&gt; f.match().fields( <span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">description</span><span class="delimiter">&quot;</span></span> ).matching( <span class="string"><span class="delimiter">&quot;</span><span class="content">scandal</span><span class="delimiter">&quot;</span></span> ) ) <i class="conum" data-value="1"></i><b>(1)</b>
        .highlighter( f -&gt; f.plain().noMatchSize( <span class="integer">100</span> ) ) <i class="conum" data-value="2"></i><b>(2)</b>
        .fetchHits( <span class="integer">20</span> ); <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Specify a predicate that would look for matches in both <code>title</code> and <code>description</code> fields.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Specify the details of the default highlighter. Setting the no match size to a positive value to let the highlighter know
that we want to get some text back even if there will be nothing to highlight in a particular field.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Fetch the results.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="search-dsl-highlighting-highlighter-type"><a class="anchor" href="#search-dsl-highlighting-highlighter-type"></a>15.5.2. Highlighter type</h4>
<div class="paragraph">
<p>Before a highlighter can be configured, you need to pick its type.
Picking the highlighter type is the first step in a highlighter definition:</p>
</div>
<div class="exampleblock">
<div class="title">Example 361. Specifying the plain highlighter type</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">searchSession.search( <span class="predefined-type">Book</span>.class )
        .select( f -&gt; f.highlight( <span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span> ) )
        .where( f -&gt; f.match().fields( <span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">description</span><span class="delimiter">&quot;</span></span> ).matching( <span class="string"><span class="delimiter">&quot;</span><span class="content">scandal</span><span class="delimiter">&quot;</span></span> ) )
        .highlighter( f -&gt; f.plain() <span class="comment">/* ... */</span> ) <i class="conum" data-value="1"></i><b>(1)</b>
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Starting the definition of a plain highlighter.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 362. Specifying the unified highlighter type</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">searchSession.search( <span class="predefined-type">Book</span>.class )
        .select( f -&gt; f.highlight( <span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span> ) )
        .where( f -&gt; f.match().fields( <span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">description</span><span class="delimiter">&quot;</span></span> ).matching( <span class="string"><span class="delimiter">&quot;</span><span class="content">scandal</span><span class="delimiter">&quot;</span></span> ) )
        .highlighter( f -&gt; f.unified() <span class="comment">/* ... */</span> ) <i class="conum" data-value="1"></i><b>(1)</b>
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Starting the definition of a unified highlighter.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 363. Specifying the fast vector highlighter type</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">searchSession.search( <span class="predefined-type">Book</span>.class )
        .select( f -&gt; f.highlight( <span class="string"><span class="delimiter">&quot;</span><span class="content">description</span><span class="delimiter">&quot;</span></span> ) )
        .where( f -&gt; f.match().fields( <span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">description</span><span class="delimiter">&quot;</span></span> ).matching( <span class="string"><span class="delimiter">&quot;</span><span class="content">scandal</span><span class="delimiter">&quot;</span></span> ) )
        .highlighter( f -&gt; f.fastVector() <span class="comment">/* ... */</span> ) <i class="conum" data-value="1"></i><b>(1)</b>
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Starting the definition of a fast vector highlighter.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>There are three options to choose from when it comes to the highlighter type:</p>
</div>
<div id="search-dsl-highlighting-highlighter-type-plain" class="dlist">
<dl>
<dt class="hdlist1">Plain</dt>
<dd>
<p>The plain highlighter can be useful for simple queries targeting a single field on a small number of documents.
This highlighter uses a standard Lucene highlighter. It reads the string value of a highlighted field,
then creates a small in-memory index from it and applies query logic to perform the highlighting.</p>
</dd>
</dl>
</div>
<div id="search-dsl-highlighting-highlighter-type-unified" class="dlist">
<dl>
<dt class="hdlist1">Unified</dt>
<dd>
<p>The unified highlighter is used by default and does not necessarily rely on re-analyzing the text, as it can
get the offsets either from postings or from term vectors.</p>
<div class="paragraph">
<p>This highlighter uses a break iterator (breaks the text into sentences by default) to break the text into later scored passages.
It better supports more complex queries. Since it can work with prebuilt data, it performs better in case of a larger amount
of documents compared to the plain highlighter.</p>
</div>
</dd>
</dl>
</div>
<div id="search-dsl-highlighting-highlighter-type-fast-vector" class="dlist">
<dl>
<dt class="hdlist1">Fast vector</dt>
<dd>
<p>The fast vector highlighter, in addition to using a break iterator similar to the unified highlighter, it can use the boundary characters
to control the highlighted snippet.</p>
<div class="paragraph">
<p>This is the only highlighter that can assign different weights to highlighted fragments, allowing it to show
a fragment score differences by wrapping it with a different tag.
For more on tags, see <a href="#search-dsl-highlighting-highlighter-options-tags">the corresponding section</a>.</p>
</div>
<div class="paragraph">
<p>The fast vector highlighter is also the one which can highlight entire matched phrases.
Using <a href="#search-dsl-predicate-phrase">phrase predicates</a> with other highlighter types will lead to each word in a phrase
being highlighted separately.</p>
</div>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="search-dsl-highlighting-highlighter-named-highlighters"><a class="anchor" href="#search-dsl-highlighting-highlighter-named-highlighters"></a>15.5.3. Named highlighters</h4>
<div class="paragraph">
<p>Sometimes we might want to apply different highlighters to various fields.
We have already seen that a <a href="#search-dsl-highlighting-highlighter-confguring-default-highlighter-simple">highlighter can be configured</a>.
The highlighter from that example is called the default highlighter. Search queries also allow to configure named highlighters.
A named highlighter has the same configuration capabilities as the default one.
It overrides the options set by the default highlighter if such was configured.
If a default highlighter was configured for a query then every named highlighter configured on the same query
must be of the same type as the default one. Mixing various highlighter types within the same query is only allowed when no default highlighter
was configured.</p>
</div>
<div class="paragraph">
<p>When a highlight projection has a named highlighter passed to an optional <code>highlighter(..)</code> call chained as a part of
the <a href="#search-dsl-projection-highlight">highlight projection definition</a>, then that particular highlighter will be applied
to a field projection. Named highlighters can be reused withing a query,
i.e. the same name of a named highlighter can be passed to multiple highlight projections.</p>
</div>
<div class="exampleblock">
<div class="title">Example 364. Configuring both default and named highlighters</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;<span class="predefined-type">List</span>&lt;?&gt;&gt; result = searchSession.search( <span class="predefined-type">Book</span>.class )
        .select( f -&gt; f.composite().from(
                f.highlight( <span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span> ), <i class="conum" data-value="1"></i><b>(1)</b>
                f.highlight( <span class="string"><span class="delimiter">&quot;</span><span class="content">description</span><span class="delimiter">&quot;</span></span> ).highlighter( <span class="string"><span class="delimiter">&quot;</span><span class="content">customized-plain-highlighter</span><span class="delimiter">&quot;</span></span> ) <i class="conum" data-value="2"></i><b>(2)</b>
        ).asList() )
        .where( f -&gt; f.match().fields( <span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">description</span><span class="delimiter">&quot;</span></span> ).matching( <span class="string"><span class="delimiter">&quot;</span><span class="content">scandal</span><span class="delimiter">&quot;</span></span> ) )
        .highlighter( f -&gt; f.plain().tag( <span class="string"><span class="delimiter">&quot;</span><span class="content">&lt;b&gt;</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">&lt;/b&gt;</span><span class="delimiter">&quot;</span></span> ) ) <i class="conum" data-value="3"></i><b>(3)</b>
        .highlighter( <span class="string"><span class="delimiter">&quot;</span><span class="content">customized-plain-highlighter</span><span class="delimiter">&quot;</span></span>, f -&gt; f.plain().noMatchSize( <span class="integer">100</span> ) ) <i class="conum" data-value="4"></i><b>(4)</b>
        .fetchHits( <span class="integer">20</span> ); <i class="conum" data-value="5"></i><b>(5)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Add the highlight projection on a "title" field. This projection uses the default highlighter.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Add the highlight projection on a "description" field and specify the name of the named highlighter.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Specify the details of the default highlighter.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Specify the details of the named highlighter. Note that the name matches the name passed to the configuration of the "description"
highlight projection.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Fetch the results.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The name of a named highlighter cannot be <code>null</code> or an empty string. An exception will be thrown if such values are used.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="search-dsl-highlighting-highlighter-options"><a class="anchor" href="#search-dsl-highlighting-highlighter-options"></a>15.5.4. <a id="search-dsl-highlighting-highlighter-options-tags"></a> Tags</h4>
<div class="paragraph">
<p>By default, the highlighted text is wrapped with a pair of <code>&lt;em&gt;</code>/<code>&lt;/em&gt;</code> tags. A custom pair of tags can be provided to change this behaviour.
Usually, tags are a pair of HTML tags, but they can be a pair of any character sequences.</p>
</div>
<div class="exampleblock">
<div class="title">Example 365. Setting custom tags</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;<span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt;&gt; result = searchSession.search( <span class="predefined-type">Book</span>.class )
        .select( f -&gt; f.highlight( <span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span> ) )
        .where( f -&gt; f.match().fields( <span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span> ).matching( <span class="string"><span class="delimiter">&quot;</span><span class="content">scandal</span><span class="delimiter">&quot;</span></span> ) )
        .highlighter( f -&gt; f.unified().tag( <span class="string"><span class="delimiter">&quot;</span><span class="content">&lt;strong&gt;</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">&lt;/strong&gt;</span><span class="delimiter">&quot;</span></span> ) ) <i class="conum" data-value="1"></i><b>(1)</b>
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Passing a pair of open/close tags that will be used to highlight the text.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>The fast vector highlighter, which can handle multiple tags, has a few additional methods that accept a collection of tags.</p>
</div>
<div class="exampleblock">
<div class="title">Example 366. Setting multiple custom tags</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">result = searchSession.search( <span class="predefined-type">Book</span>.class )
        .select( f -&gt; f.highlight( <span class="string"><span class="delimiter">&quot;</span><span class="content">description</span><span class="delimiter">&quot;</span></span> ) )
        .where( f -&gt; f.match().fields( <span class="string"><span class="delimiter">&quot;</span><span class="content">description</span><span class="delimiter">&quot;</span></span> ).matching( <span class="string"><span class="delimiter">&quot;</span><span class="content">scandal</span><span class="delimiter">&quot;</span></span> ) )
        .highlighter( f -&gt; f.fastVector()
                .tags( <i class="conum" data-value="1"></i><b>(1)</b>
                        <span class="predefined-type">Arrays</span>.asList( <span class="string"><span class="delimiter">&quot;</span><span class="content">&lt;em class=</span><span class="char">\&quot;</span><span class="content">class1</span><span class="char">\&quot;</span><span class="content">&gt;</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">&lt;em class=</span><span class="char">\&quot;</span><span class="content">class2</span><span class="char">\&quot;</span><span class="content">&gt;</span><span class="delimiter">&quot;</span></span> ),
                        <span class="string"><span class="delimiter">&quot;</span><span class="content">&lt;/em&gt;</span><span class="delimiter">&quot;</span></span>
                ) )
        .fetchHits( <span class="integer">20</span> );
result = searchSession.search( <span class="predefined-type">Book</span>.class )
        .select( f -&gt; f.highlight( <span class="string"><span class="delimiter">&quot;</span><span class="content">description</span><span class="delimiter">&quot;</span></span> ) )
        .where( f -&gt; f.match().fields( <span class="string"><span class="delimiter">&quot;</span><span class="content">description</span><span class="delimiter">&quot;</span></span> ).matching( <span class="string"><span class="delimiter">&quot;</span><span class="content">scandal</span><span class="delimiter">&quot;</span></span> ) )
        .highlighter( f -&gt; f.fastVector()
                .tags( <i class="conum" data-value="2"></i><b>(2)</b>
                        <span class="predefined-type">Arrays</span>.asList( <span class="string"><span class="delimiter">&quot;</span><span class="content">&lt;em&gt;</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">&lt;strong&gt;</span><span class="delimiter">&quot;</span></span> ),
                        <span class="predefined-type">Arrays</span>.asList( <span class="string"><span class="delimiter">&quot;</span><span class="content">&lt;/em&gt;</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">&lt;/strong&gt;</span><span class="delimiter">&quot;</span></span> )
                ) )
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Passing a collection of open tags and a single closing tag that will be used to highlight the text.
It can be helpful when configuring a tag schema that differs only in an attribute of an opening tag.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Passing a pair of collections containing open/close tags that will be used to highlight the text.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>Additionally, a fast vector highlighter has the option to enable a tag schema and set it to <code>HighlighterTagSchema.STYLED</code>
to use a predefined set of tags.</p>
</div>
<div class="exampleblock">
<div class="title">Example 367. Setting a styled tags schema</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;<span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt;&gt; result = searchSession.search( <span class="predefined-type">Book</span>.class )
        .select( f -&gt; f.highlight( <span class="string"><span class="delimiter">&quot;</span><span class="content">description</span><span class="delimiter">&quot;</span></span> ) )
        .where( f -&gt; f.match().fields( <span class="string"><span class="delimiter">&quot;</span><span class="content">description</span><span class="delimiter">&quot;</span></span> ).matching( <span class="string"><span class="delimiter">&quot;</span><span class="content">scandal</span><span class="delimiter">&quot;</span></span> ) )
        .highlighter( f -&gt; f.fastVector()
                .tagSchema( HighlighterTagSchema.STYLED ) <i class="conum" data-value="1"></i><b>(1)</b>
        )
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Passing a styled tags schema that will be used to highlight the text.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>Using a styled tags schema is just a shortcut to defining tags as:</p>
</div>
<div class="exampleblock">
<div class="title">Example 368. Setting tags as if the styled tags schema is used</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;<span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt;&gt; result = searchSession.search( <span class="predefined-type">Book</span>.class )
        .select( f -&gt; f.highlight( <span class="string"><span class="delimiter">&quot;</span><span class="content">description</span><span class="delimiter">&quot;</span></span> ) )
        .where( f -&gt; f.match().fields( <span class="string"><span class="delimiter">&quot;</span><span class="content">description</span><span class="delimiter">&quot;</span></span> ).matching( <span class="string"><span class="delimiter">&quot;</span><span class="content">scandal</span><span class="delimiter">&quot;</span></span> ) )
        .highlighter( f -&gt; f.fastVector()
                .tags( <span class="predefined-type">Arrays</span>.asList(
                        <span class="string"><span class="delimiter">&quot;</span><span class="content">&lt;em class=</span><span class="char">\&quot;</span><span class="content">hlt1</span><span class="char">\&quot;</span><span class="content">&gt;</span><span class="delimiter">&quot;</span></span>,
                        <span class="string"><span class="delimiter">&quot;</span><span class="content">&lt;em class=</span><span class="char">\&quot;</span><span class="content">hlt2</span><span class="char">\&quot;</span><span class="content">&gt;</span><span class="delimiter">&quot;</span></span>,
                        <span class="string"><span class="delimiter">&quot;</span><span class="content">&lt;em class=</span><span class="char">\&quot;</span><span class="content">hlt3</span><span class="char">\&quot;</span><span class="content">&gt;</span><span class="delimiter">&quot;</span></span>,
                        <span class="string"><span class="delimiter">&quot;</span><span class="content">&lt;em class=</span><span class="char">\&quot;</span><span class="content">hlt4</span><span class="char">\&quot;</span><span class="content">&gt;</span><span class="delimiter">&quot;</span></span>,
                        <span class="string"><span class="delimiter">&quot;</span><span class="content">&lt;em class=</span><span class="char">\&quot;</span><span class="content">hlt5</span><span class="char">\&quot;</span><span class="content">&gt;</span><span class="delimiter">&quot;</span></span>,
                        <span class="string"><span class="delimiter">&quot;</span><span class="content">&lt;em class=</span><span class="char">\&quot;</span><span class="content">hlt6</span><span class="char">\&quot;</span><span class="content">&gt;</span><span class="delimiter">&quot;</span></span>,
                        <span class="string"><span class="delimiter">&quot;</span><span class="content">&lt;em class=</span><span class="char">\&quot;</span><span class="content">hlt7</span><span class="char">\&quot;</span><span class="content">&gt;</span><span class="delimiter">&quot;</span></span>,
                        <span class="string"><span class="delimiter">&quot;</span><span class="content">&lt;em class=</span><span class="char">\&quot;</span><span class="content">hlt8</span><span class="char">\&quot;</span><span class="content">&gt;</span><span class="delimiter">&quot;</span></span>,
                        <span class="string"><span class="delimiter">&quot;</span><span class="content">&lt;em class=</span><span class="char">\&quot;</span><span class="content">hlt9</span><span class="char">\&quot;</span><span class="content">&gt;</span><span class="delimiter">&quot;</span></span>,
                        <span class="string"><span class="delimiter">&quot;</span><span class="content">&lt;em class=</span><span class="char">\&quot;</span><span class="content">hlt10</span><span class="char">\&quot;</span><span class="content">&gt;</span><span class="delimiter">&quot;</span></span>
                ), <span class="string"><span class="delimiter">&quot;</span><span class="content">&lt;/em&gt;</span><span class="delimiter">&quot;</span></span> ) <i class="conum" data-value="1"></i><b>(1)</b>
        )
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Passing the same collection of tags used when a styled schema is applied.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Calling different tags configuration methods (<code>tag(..)</code>/<code>tags(..)</code>/<code>tagSchema(..</code>) or the same one multiple times
within the same highlighter definition will <strong>not</strong> combine them.
Tags set by the last call will be applied.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="search-dsl-highlighting-highlighter-options-encoder"><a class="anchor" href="#search-dsl-highlighting-highlighter-options-encoder"></a>15.5.5. Encoder</h4>
<div class="paragraph">
<p>Encoding can be applied to the highlighted snippets when highlighting the fields that store HTML. Applying an
HTML encoder to a highlighter will encode the text for inclusion into an HTML document:
it will replace HTML meta-characters such as <code>&lt;</code> with their entity equivalent such as <code>&amp;lt;</code>;
however it will not escape the highlighting tags.
By default, a <code>HighlighterEncoder.DEFAULT</code> encoder is used, which keeps the text as is.</p>
</div>
<div class="exampleblock">
<div class="title">Example 369. Setting the HTML encoder</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;<span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt;&gt; result = searchSession.search( <span class="predefined-type">Book</span>.class )
        .select( f -&gt; f.highlight( <span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span> ) )
        .where( f -&gt; f.match().fields( <span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span> ).matching( <span class="string"><span class="delimiter">&quot;</span><span class="content">scandal</span><span class="delimiter">&quot;</span></span> ) )
        .highlighter( f -&gt; f.unified().encoder( HighlighterEncoder.HTML ) ) <i class="conum" data-value="1"></i><b>(1)</b>
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Configuring the HTML encoder.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="search-dsl-highlighting-highlighter-options-no-match-size"><a class="anchor" href="#search-dsl-highlighting-highlighter-options-no-match-size"></a>15.5.6. No match size</h4>
<div class="paragraph">
<p>In case of more complex queries or when highlighting is performed for multiple fields, it might lead to a situation
where the query matched a document, but a particular highlighted field did not contribute to that match.
This will lead to an empty list of highlights for that particular document and that field.
No match size option allows you to still get some text returned even if the field didn&#8217;t contribute to the document match,
and there&#8217;s nothing to be highlighted in it.</p>
</div>
<div class="paragraph">
<p>The number set by this property defines the number of characters to be included starting at the beginning of a field.
Depending on the highlighter type, the amount of text returned might not precisely match the configured value since
highlighters usually try not to break the text in the middle of a word/sentence, depending on their configuration.
By default, this option is set to <code>0</code> and text will only be returned if there&#8217;s something to highlight.</p>
</div>
<div class="exampleblock">
<div class="title">Example 370. Setting the no match size</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;<span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt;&gt; result = searchSession.search( <span class="predefined-type">Book</span>.class )
        .select( f -&gt; f.highlight( <span class="string"><span class="delimiter">&quot;</span><span class="content">description</span><span class="delimiter">&quot;</span></span> ) )
        .where( f -&gt; f.bool()
                .must( f.match().fields( <span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span> ).matching( <span class="string"><span class="delimiter">&quot;</span><span class="content">scandal</span><span class="delimiter">&quot;</span></span> ) ) <i class="conum" data-value="1"></i><b>(1)</b>
                .should( f.match().fields( <span class="string"><span class="delimiter">&quot;</span><span class="content">description</span><span class="delimiter">&quot;</span></span> ).matching( <span class="string"><span class="delimiter">&quot;</span><span class="content">scandal</span><span class="delimiter">&quot;</span></span> ) ) <i class="conum" data-value="2"></i><b>(2)</b>
        )
        .highlighter( f -&gt; f.fastVector().noMatchSize( <span class="integer">100</span> ) ) <i class="conum" data-value="3"></i><b>(3)</b>
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We are looking for matches in the title.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>In case a word can also be found in the description, we&#8217;d want it to be highlighted.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Setting the no match size to <code>100</code> to still get at least <code>100</code> first characters of a description even if the match for
a word we are searching for is not found.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The unified highlighter from the <a href="#backend-lucene">Lucene backend</a> has a limited support for this option.
It cannot limit the amount of the returned text, and works more like a boolean flag to enable/disable the
feature. If a highlighter of this type has the option not set or set to <code>0</code> then no text is returned when
there was no match found. Otherwise, if the option for a highlighter of this type was set to a positive integer, all
text is returned, no matter the actual value.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="search-dsl-highlighting-highlighter-options-fragment-size"><a class="anchor" href="#search-dsl-highlighting-highlighter-options-fragment-size"></a>15.5.7. Fragment size and number of fragments</h4>
<div class="paragraph">
<p>The fragment size sets the amount of text included in each highlighted fragment, by default <code>100</code> characters.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This is not a "hard" limit, since highlighters usually try not to break the fragment in the middle of a word. Additionally,
other features such as <a href="#search-dsl-highlighting-highlighter-options-boundary-scanner">boundary scanning</a>
may lead to more text before and after the fragment being included as well.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>A number of fragments configuration sets the maximum number of strings included in the resulting highlighted list.
By default, the number of fragments is limited to <code>5</code>.</p>
</div>
<div class="paragraph">
<p>A combination of these options can be helpful when highlighting large text fields.</p>
</div>
<div class="exampleblock">
<div class="title">Example 371. Setting the fragment size and the number of fragments</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;<span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt;&gt; result = searchSession.search( <span class="predefined-type">Book</span>.class )
        .select( f -&gt; f.highlight( <span class="string"><span class="delimiter">&quot;</span><span class="content">description</span><span class="delimiter">&quot;</span></span> ) )
        .where( f -&gt; f.match().fields( <span class="string"><span class="delimiter">&quot;</span><span class="content">description</span><span class="delimiter">&quot;</span></span> ).matching( <span class="string"><span class="delimiter">&quot;</span><span class="content">king</span><span class="delimiter">&quot;</span></span> )
        )
        .highlighter( f -&gt; f.fastVector()
                .fragmentSize( <span class="integer">50</span> ) <i class="conum" data-value="1"></i><b>(1)</b>
                .numberOfFragments( <span class="integer">2</span> ) <i class="conum" data-value="2"></i><b>(2)</b>
        )
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Configuring the fragment size.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Configuring the maximum number of fragments to be returned.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>These options are supported by all highlighter types on the Elasticsearch backend.
As for the Lucene backend&#8201;&#8212;&#8201;the number of fragments is also supported by all highlighter types,
while only plain and fast-vector highlighters support fragment size.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="search-dsl-highlighting-highlighter-options-order"><a class="anchor" href="#search-dsl-highlighting-highlighter-options-order"></a>15.5.8. Order</h4>
<div class="paragraph">
<p>By default, highlighted fragments are returned in the order of occurrence in the text.
By enabling the order by score option most relevant fragments will be returned at the top of the list.</p>
</div>
<div class="exampleblock">
<div class="title">Example 372. Setting the fragment size and number of fragments</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;<span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt;&gt; result = searchSession.search( <span class="predefined-type">Book</span>.class )
        .select( f -&gt; f.highlight( <span class="string"><span class="delimiter">&quot;</span><span class="content">description</span><span class="delimiter">&quot;</span></span> ) )
        .where( f -&gt; f.bool() <i class="conum" data-value="1"></i><b>(1)</b>
                .should( f.match().fields( <span class="string"><span class="delimiter">&quot;</span><span class="content">description</span><span class="delimiter">&quot;</span></span> ).matching( <span class="string"><span class="delimiter">&quot;</span><span class="content">king</span><span class="delimiter">&quot;</span></span> ) )
                .should( f.match().fields( <span class="string"><span class="delimiter">&quot;</span><span class="content">description</span><span class="delimiter">&quot;</span></span> ).matching( <span class="string"><span class="delimiter">&quot;</span><span class="content">souvenir</span><span class="delimiter">&quot;</span></span> ).boost( <span class="float">10.0f</span> ) )
        )
        .highlighter( f -&gt; f.fastVector().orderByScore( <span class="predefined-constant">true</span> ) ) <i class="conum" data-value="2"></i><b>(2)</b>
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>A query that would boost the match of one of the searched words.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Configuring the order by the score to be enabled.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="search-dsl-highlighting-highlighter-options-fragmenter"><a class="anchor" href="#search-dsl-highlighting-highlighter-options-fragmenter"></a>15.5.9. Fragmenter</h4>
<div class="paragraph">
<p>By default, the plain highlighter breaks up text into same-sized fragments but tries to avoid breaking up a phrase to be highlighted.
This is the behaviour of the <code>HighlighterFragmenter.SPAN</code> fragmenter. Alternatively, fragmenter can be set to <code>HighlighterFragmenter.SIMPLE</code>
that simply breaks up the text into same-sized fragments.</p>
</div>
<div class="exampleblock">
<div class="title">Example 373. Setting the fragmenter</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;<span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt;&gt; result = searchSession.search( <span class="predefined-type">Book</span>.class )
        .select( f -&gt; f.highlight( <span class="string"><span class="delimiter">&quot;</span><span class="content">description</span><span class="delimiter">&quot;</span></span> ) )
        .where( f -&gt; f.match().fields( <span class="string"><span class="delimiter">&quot;</span><span class="content">description</span><span class="delimiter">&quot;</span></span> ).matching( <span class="string"><span class="delimiter">&quot;</span><span class="content">souvenir</span><span class="delimiter">&quot;</span></span> ) )
        .highlighter( f -&gt; f.plain().fragmenter( HighlighterFragmenter.SIMPLE ) ) <i class="conum" data-value="1"></i><b>(1)</b>
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Configuring the simple fragmenter.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This option is supported only by the plain highlighter.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="search-dsl-highlighting-highlighter-options-boundary-scanner"><a class="anchor" href="#search-dsl-highlighting-highlighter-options-boundary-scanner"></a>15.5.10. Boundary scanner</h4>
<div class="paragraph">
<p>Unified and fast vector highlighters use boundary scanners to create highlighted fragments:
they try to expand highlighted fragments by scanning text before and after those fragments for word/sentence boundaries.</p>
</div>
<div class="paragraph">
<p>An optional locale parameter can be supplied to specify how to search
for sentence and word boundaries. A sentence boundary scanner is a default option for the unified highlighter.</p>
</div>
<div class="paragraph">
<p>There are two ways to supply boundary scanner configuration to a highlighter.</p>
</div>
<div class="exampleblock">
<div class="title">Example 374. Setting the boundary scanner with DSL</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;<span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt;&gt; result = searchSession.search( <span class="predefined-type">Book</span>.class )
        .select( f -&gt; f.highlight( <span class="string"><span class="delimiter">&quot;</span><span class="content">description</span><span class="delimiter">&quot;</span></span> ) )
        .where( f -&gt; f.match().fields( <span class="string"><span class="delimiter">&quot;</span><span class="content">description</span><span class="delimiter">&quot;</span></span> ).matching( <span class="string"><span class="delimiter">&quot;</span><span class="content">king</span><span class="delimiter">&quot;</span></span> ) )
        .highlighter( f -&gt; f.fastVector()
                .boundaryScanner() <i class="conum" data-value="1"></i><b>(1)</b>
                        .word() <i class="conum" data-value="2"></i><b>(2)</b>
                        .locale( <span class="predefined-type">Locale</span>.ENGLISH ) <i class="conum" data-value="3"></i><b>(3)</b>
                        .end() <i class="conum" data-value="4"></i><b>(4)</b>
                <span class="comment">/* ... */</span> <i class="conum" data-value="5"></i><b>(5)</b>
        )
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Start the definition of a boundary scanner.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Pick a boundary scanner type&#8201;&#8212;&#8201;a word scanner in this case.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Set an optional locale.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>End the definition of a boundary scanner.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Set any other options.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 375. Setting the boundary scanner using lambda</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;<span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt;&gt; result = searchSession.search( <span class="predefined-type">Book</span>.class )
        .select( f -&gt; f.highlight( <span class="string"><span class="delimiter">&quot;</span><span class="content">description</span><span class="delimiter">&quot;</span></span> ) )
        .where( f -&gt; f.match().fields( <span class="string"><span class="delimiter">&quot;</span><span class="content">description</span><span class="delimiter">&quot;</span></span> ).matching( <span class="string"><span class="delimiter">&quot;</span><span class="content">king</span><span class="delimiter">&quot;</span></span> ) )
        .highlighter( f -&gt; f.fastVector()
                .boundaryScanner(
                        bs -&gt; bs.word() <i class="conum" data-value="1"></i><b>(1)</b>
                )
                <span class="comment">/* ... */</span> <i class="conum" data-value="2"></i><b>(2)</b>
        )
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Pass a lambda configurer to set up a boundary scanner.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Set any other options</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>Alternatively, a fast vector highlighter can use a character boundary scanner which relies on two other configurations&#8201;&#8212;&#8201;boundary characters and boundary max scan. When a character boundary scanner is used after a highlighted fragment is formed
with highlighted text centred, the highlighter checks for the first occurrence of any configured boundary characters to the left and right
of a currently created fragment. This lookup happens only for a maximum number of characters configured by the boundary max scan option.
If no boundary characters are found, no additional text will be included besides the already highlighted phrase
with surrounding text based on a fragment size option set for a highlighter.</p>
</div>
<div class="paragraph">
<p>The default list of boundary characters includes <code>.,!? \t\n</code>.
The default boundary max scan is equal to <code>20</code> characters.</p>
</div>
<div class="paragraph">
<p>Character boundary scanner is a default option for the fast vector highlighters.</p>
</div>
<div class="exampleblock">
<div class="title">Example 376. Setting the character boundary scanner</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;<span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt;&gt; result = searchSession.search( <span class="predefined-type">Book</span>.class )
        .select( f -&gt; f.highlight( <span class="string"><span class="delimiter">&quot;</span><span class="content">description</span><span class="delimiter">&quot;</span></span> ) )
        .where( f -&gt; f.match().fields( <span class="string"><span class="delimiter">&quot;</span><span class="content">description</span><span class="delimiter">&quot;</span></span> ).matching( <span class="string"><span class="delimiter">&quot;</span><span class="content">scene</span><span class="delimiter">&quot;</span></span> ) )
        .highlighter( f -&gt; f.fastVector()
                .boundaryScanner() <i class="conum" data-value="1"></i><b>(1)</b>
                        .chars() <i class="conum" data-value="2"></i><b>(2)</b>
                        .boundaryChars( <span class="string"><span class="delimiter">&quot;</span><span class="char">\n</span><span class="delimiter">&quot;</span></span> ) <i class="conum" data-value="3"></i><b>(3)</b>
                        .boundaryMaxScan( <span class="integer">1000</span> ) <i class="conum" data-value="4"></i><b>(4)</b>
                        .end() <i class="conum" data-value="5"></i><b>(5)</b>
                <span class="comment">/* ... */</span> <i class="conum" data-value="6"></i><b>(6)</b>
        )
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
<div class="paragraph">
<p>Assuming that we have a text that contains multiple paragraphs separated with a new line (<code>\n</code>), we want to
get the entire paragraph containing the highlighted phrase. To do so, boundary characters will be set to <code>\n</code>, and
the max scan option will be based on the number of characters in paragraphs.</p>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Start the definition of a boundary scanner.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Pick a boundary scanner type&#8201;&#8212;&#8201;a character scanner.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Set a string containing boundary characters. The overloaded methods can accept a <code>String</code> or a <code>Character</code> array.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Set the max scan option.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>End the definition of a boundary scanner.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Set any other options.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This option is supported by the unified and fast vector highlighter types.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="search-dsl-highlighting-highlighter-options-phrase-limit"><a class="anchor" href="#search-dsl-highlighting-highlighter-options-phrase-limit"></a>15.5.11. Phrase limit</h4>
<div class="paragraph">
<p>Phrase limit allows specifying the maximum number of matching phrases in a document for highlighting.
The highlighter will be going through the text and as soon as it reaches the maximum number of highlighted phrases it&#8217;ll stop leaving any further occurrences as not highlighted.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This limit is different from the <a href="#search-dsl-highlighting-highlighter-options-fragment-size">maximum number of fragments</a>:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Fragments are the strings returned by the highlight projections, while phrases are the sequences of highlighted (matching) terms in each fragment.
A fragment may include multiple highlighted phrases, and a given phrase may appear in multiple fragments.</p>
</li>
<li>
<p>The phrase limit is about limiting the highlighting of occurrences of matched phrases, be it multiple occurrences of the same phrase or a mix of different phrases.
For example, if we were to search for <code>fox</code> and <code>dog</code> occurrences in the sentence
<code>The quick brown fox jumps over the lazy dog</code> and set the phrase limit to <code>1</code>, then we&#8217;ll have only <code>fox</code> being highlighted
since it was the first match in the text and the phrase limit was reached.</p>
</li>
</ol>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>By default, this phrase limit is equal to <code>256</code>.</p>
</div>
<div class="paragraph">
<p>This option can be helpful if a field contains many matches and has a lot of text overall, but we are not interested in
highlighting every occurrence.</p>
</div>
<div class="exampleblock">
<div class="title">Example 377. Setting the phrase limit</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;<span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt;&gt; result = searchSession.search( <span class="predefined-type">Book</span>.class )
        .select( f -&gt; f.highlight( <span class="string"><span class="delimiter">&quot;</span><span class="content">description</span><span class="delimiter">&quot;</span></span> ) )
        .where( f -&gt; f.match().fields( <span class="string"><span class="delimiter">&quot;</span><span class="content">description</span><span class="delimiter">&quot;</span></span> ).matching( <span class="string"><span class="delimiter">&quot;</span><span class="content">bank</span><span class="delimiter">&quot;</span></span> ) )
        .highlighter( f -&gt; f.fastVector()
                .phraseLimit( <span class="integer">1</span> ) <i class="conum" data-value="1"></i><b>(1)</b>
        )
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Configuring the phrase limit.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This option is supported only by the fast vector highlighter type.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="search-dsl-aggregation"><a class="anchor" href="#search-dsl-aggregation"></a>15.6. <a id="query-faceting"></a> Aggregation DSL</h3>
<div class="sect3">
<h4 id="search-dsl-aggregation-concepts"><a class="anchor" href="#search-dsl-aggregation-concepts"></a>15.6.1. Basics</h4>
<div class="paragraph">
<p>Sometimes, you don&#8217;t just need to list query hits directly:
you also need to group and aggregate the hits.</p>
</div>
<div id="example-amazon-facets" class="paragraph">
<p>For example, almost any e-commerce website you can visit will have some sort of "faceting",
which is a simple form of aggregation.
In the "book search" webpage of an online bookshop, beside the list of matching books,
you will find "facets", i.e. a count of matching documents in various categories.
These categories can be taken directly from the indexed data, e.g. the genre of the book (science-fiction, crime fiction, &#8230;&#8203;),
but also derived from the indexed data slightly, e.g. a price range ("less than $5", "less than $10", &#8230;&#8203;).</p>
</div>
<div class="paragraph">
<p>Aggregations allow just that (and, depending on the backend, much more):
they allow the query to return "aggregated" hits.</p>
</div>
<div class="paragraph">
<p><a id="section-creating-faceting-request"></a><a id="section-applying-faceting-request"></a>
Aggregations can be configured when building the search query:</p>
</div>
<div id="example-applying-faceting" class="exampleblock">
<div class="title">Example 378. Defining an aggregation in a search query</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">SearchSession searchSession = <span class="comment">/* ... */</span> <i class="conum" data-value="1"></i><b>(1)</b>

AggregationKey&lt;<span class="predefined-type">Map</span>&lt;Genre, <span class="predefined-type">Long</span>&gt;&gt; countsByGenreKey = AggregationKey.of( <span class="string"><span class="delimiter">&quot;</span><span class="content">countsByGenre</span><span class="delimiter">&quot;</span></span> ); <i class="conum" data-value="2"></i><b>(2)</b>

<span class="predefined-type">SearchResult</span>&lt;<span class="predefined-type">Book</span>&gt; result = searchSession.search( <span class="predefined-type">Book</span>.class ) <i class="conum" data-value="3"></i><b>(3)</b>
        .where( f -&gt; f.match().field( <span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span> ) <i class="conum" data-value="4"></i><b>(4)</b>
                .matching( <span class="string"><span class="delimiter">&quot;</span><span class="content">robot</span><span class="delimiter">&quot;</span></span> ) )
        .aggregation( countsByGenreKey, f -&gt; f.terms() <i class="conum" data-value="5"></i><b>(5)</b>
                .field( <span class="string"><span class="delimiter">&quot;</span><span class="content">genre</span><span class="delimiter">&quot;</span></span>, Genre.class ) )
        .fetch( <span class="integer">20</span> ); <i class="conum" data-value="6"></i><b>(6)</b>

<span class="predefined-type">Map</span>&lt;Genre, <span class="predefined-type">Long</span>&gt; countsByGenre = result.aggregation( countsByGenreKey ); <i class="conum" data-value="7"></i><b>(7)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><a href="#entrypoints-search-session">Retrieve the <code>SearchSession</code></a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Define a key that will uniquely identify the aggregation. Make sure to give it the correct type (see &lt;6&gt;).</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Start building the query as usual.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Define a predicate: the aggregation will only take into account documents matching this predicate.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Request an aggregation on the <code>genre</code> field,
with a separate count for each genre: science-fiction, crime fiction, &#8230;&#8203;
If the field does not exist or cannot be aggregated, an exception will be thrown.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Fetch the results.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Retrieve the aggregation from the results as a <code>Map</code>,
with the genre as key and the hit count as value of type <code>Long</code>.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>Alternatively, if you don&#8217;t want to use lambdas:</p>
</div>
<div class="exampleblock">
<div class="title">Example 379. Defining an aggregation in a search query&#8201;&#8212;&#8201;object-based syntax</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">SearchSession searchSession = <span class="comment">/* ... */</span>

SearchScope&lt;<span class="predefined-type">Book</span>&gt; scope = searchSession.scope( <span class="predefined-type">Book</span>.class );

AggregationKey&lt;<span class="predefined-type">Map</span>&lt;Genre, <span class="predefined-type">Long</span>&gt;&gt; countsByGenreKey = AggregationKey.of( <span class="string"><span class="delimiter">&quot;</span><span class="content">countsByGenre</span><span class="delimiter">&quot;</span></span> );

<span class="predefined-type">SearchResult</span>&lt;<span class="predefined-type">Book</span>&gt; result = searchSession.search( scope )
        .where( scope.predicate().match().field( <span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span> )
                .matching( <span class="string"><span class="delimiter">&quot;</span><span class="content">robot</span><span class="delimiter">&quot;</span></span> )
                .toPredicate() )
        .aggregation( countsByGenreKey, scope.aggregation().terms()
                .field( <span class="string"><span class="delimiter">&quot;</span><span class="content">genre</span><span class="delimiter">&quot;</span></span>, Genre.class )
                .toAggregation() )
        .fetch( <span class="integer">20</span> );

<span class="predefined-type">Map</span>&lt;Genre, <span class="predefined-type">Long</span>&gt; countsByGenre = result.aggregation( countsByGenreKey );</code></pre>
</div>
</div>
</div>
</div>
<div id="example-faceting-entity" class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>In order to use aggregations based on the value of a given field,
you need to mark the field as <a href="#mapping-directfieldmapping-aggregable">aggregable</a> in the mapping.</p>
</div>
<div class="paragraph">
<p>This is not possible for full-text fields, in particular;
see <a href="#mapping-directfieldmapping-annotations-fulltextfield">here</a> for an explanation and some solutions.</p>
</div>
</td>
</tr>
</table>
</div>
<div id="example-restricting-query-results" class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Faceting generally involves a concept of "drill-down",
i.e. the ability to select a facet and restrict the hits
to only those that match that facet.</p>
</div>
<div class="paragraph">
<p>Hibernate Search 5 used to offer a dedicated API to enable this "drill-down",
but in Hibernate Search 6 you should simply create a new query
with the appropriate <a href="#search-dsl-predicate">predicate</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The aggregation DSL offers more aggregation types, and multiple options for each type of aggregation.
To learn more about the <code>terms</code> aggregation, and all the other types of aggregations,
refer to the following sections.</p>
</div>
</div>
<div class="sect3">
<h4 id="search-dsl-aggregation-terms"><a class="anchor" href="#search-dsl-aggregation-terms"></a>15.6.2. <a id="discrete-faceting-request"></a> <code>terms</code>: group by the value of a field</h4>
<div class="paragraph">
<p>The <code>terms</code> aggregation returns a count of documents for each term value of a given field.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>In order to use aggregations based on the value of a given field,
you need to mark the field as <a href="#mapping-directfieldmapping-aggregable">aggregable</a> in the mapping.</p>
</div>
<div class="paragraph">
<p>This is not possible for full-text fields, in particular;
see <a href="#mapping-directfieldmapping-annotations-fulltextfield">here</a> for an explanation and some solutions.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The <code>terms</code> aggregation is not available on geo-point fields.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="exampleblock">
<div class="title">Example 380. Counting hits grouped by the value of a field</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">AggregationKey&lt;<span class="predefined-type">Map</span>&lt;Genre, <span class="predefined-type">Long</span>&gt;&gt; countsByGenreKey = AggregationKey.of( <span class="string"><span class="delimiter">&quot;</span><span class="content">countsByGenre</span><span class="delimiter">&quot;</span></span> );
<span class="predefined-type">SearchResult</span>&lt;<span class="predefined-type">Book</span>&gt; result = searchSession.search( <span class="predefined-type">Book</span>.class )
        .where( f -&gt; f.matchAll() )
        .aggregation( countsByGenreKey, f -&gt; f.terms()
                .field( <span class="string"><span class="delimiter">&quot;</span><span class="content">genre</span><span class="delimiter">&quot;</span></span>, Genre.class ) ) <i class="conum" data-value="1"></i><b>(1)</b>
        .fetch( <span class="integer">20</span> );
<span class="predefined-type">Map</span>&lt;Genre, <span class="predefined-type">Long</span>&gt; countsByGenre = result.aggregation( countsByGenreKey ); <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Define the path and type of the field whose values should be considered.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The result is a map from field value to document count.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect4">
<h5 id="search-dsl-aggregation-terms-skipping-conversion"><a class="anchor" href="#search-dsl-aggregation-terms-skipping-conversion"></a>Skipping conversion</h5>
<div class="paragraph">
<p>By default, the values returned by the <code>terms</code> aggregation have the same type as
the entity property corresponding to the target field.</p>
</div>
<div class="paragraph">
<p>For example, if an entity property if of an enum type,
<a href="#mapping-directfieldmapping-supported-types">the corresponding field may be of type <code>String</code></a>;
the values returned by the <code>terms</code> aggregation will be of the enum type regardless.</p>
</div>
<div class="paragraph">
<p>This should generally be what you want,
but if you ever need to bypass conversion and have unconverted values returned to you instead
(of type <code>String</code> in the example above),
you can do it this way:</p>
</div>
<div class="exampleblock">
<div class="title">Example 381. Counting hits grouped by the value of a field, without converting field values</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">AggregationKey&lt;<span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Long</span>&gt;&gt; countsByGenreKey = AggregationKey.of( <span class="string"><span class="delimiter">&quot;</span><span class="content">countsByGenre</span><span class="delimiter">&quot;</span></span> );
<span class="predefined-type">SearchResult</span>&lt;<span class="predefined-type">Book</span>&gt; result = searchSession.search( <span class="predefined-type">Book</span>.class )
        .where( f -&gt; f.matchAll() )
        .aggregation( countsByGenreKey, f -&gt; f.terms()
                .field( <span class="string"><span class="delimiter">&quot;</span><span class="content">genre</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">String</span>.class, ValueConvert.NO ) )
        .fetch( <span class="integer">20</span> );
<span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Long</span>&gt; countsByGenre = result.aggregation( countsByGenreKey );</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>See <a href="#search-dsl-projected-value-type">Type of projected values</a> for more information.</p>
</div>
</div>
<div class="sect4">
<h5 id="search-dsl-aggregation-terms-maxtermcount"><a class="anchor" href="#search-dsl-aggregation-terms-maxtermcount"></a><code>maxTermCount</code>: limiting the number of returned entries</h5>
<div class="paragraph">
<p>By default, Hibernate Search will return at most 100 entries.
You can customize the limit by calling <code>.maxTermCount(&#8230;&#8203;)</code>:</p>
</div>
<div class="exampleblock">
<div class="title">Example 382. Setting the maximum number of returned entries in a <code>terms</code> aggregation</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">AggregationKey&lt;<span class="predefined-type">Map</span>&lt;Genre, <span class="predefined-type">Long</span>&gt;&gt; countsByGenreKey = AggregationKey.of( <span class="string"><span class="delimiter">&quot;</span><span class="content">countsByGenre</span><span class="delimiter">&quot;</span></span> );
<span class="predefined-type">SearchResult</span>&lt;<span class="predefined-type">Book</span>&gt; result = searchSession.search( <span class="predefined-type">Book</span>.class )
        .where( f -&gt; f.matchAll() )
        .aggregation( countsByGenreKey, f -&gt; f.terms()
                .field( <span class="string"><span class="delimiter">&quot;</span><span class="content">genre</span><span class="delimiter">&quot;</span></span>, Genre.class )
                .maxTermCount( <span class="integer">1</span> ) )
        .fetch( <span class="integer">20</span> );
<span class="predefined-type">Map</span>&lt;Genre, <span class="predefined-type">Long</span>&gt; countsByGenre = result.aggregation( countsByGenreKey );</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="search-dsl-aggregation-terms-mindocumentcount"><a class="anchor" href="#search-dsl-aggregation-terms-mindocumentcount"></a><code>minDocumentCount</code>: requiring at least N matching documents per term</h5>
<div class="paragraph">
<p>By default, Hibernate search will return an entry only if the document count is at least 1.</p>
</div>
<div class="paragraph">
<p>You can set the threshold to an arbitrary value by calling <code>.minDocumentCount(&#8230;&#8203;)</code>.</p>
</div>
<div class="paragraph">
<p>This is particularly useful to return all terms that exist in the index,
even if no document containing the term matched the query.
To that end, just call <code>.minDocumentCount(0)</code>:</p>
</div>
<div class="exampleblock">
<div class="title">Example 383. Including values from unmatched documents in a <code>terms</code> aggregation</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">AggregationKey&lt;<span class="predefined-type">Map</span>&lt;Genre, <span class="predefined-type">Long</span>&gt;&gt; countsByGenreKey = AggregationKey.of( <span class="string"><span class="delimiter">&quot;</span><span class="content">countsByGenre</span><span class="delimiter">&quot;</span></span> );
<span class="predefined-type">SearchResult</span>&lt;<span class="predefined-type">Book</span>&gt; result = searchSession.search( <span class="predefined-type">Book</span>.class )
        .where( f -&gt; f.matchAll() )
        .aggregation( countsByGenreKey, f -&gt; f.terms()
                .field( <span class="string"><span class="delimiter">&quot;</span><span class="content">genre</span><span class="delimiter">&quot;</span></span>, Genre.class )
                .minDocumentCount( <span class="integer">0</span> ) )
        .fetch( <span class="integer">20</span> );
<span class="predefined-type">Map</span>&lt;Genre, <span class="predefined-type">Long</span>&gt; countsByGenre = result.aggregation( countsByGenreKey );</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>This can also be used to omit entries with a document count that is too low to matter:</p>
</div>
<div class="exampleblock">
<div class="title">Example 384. Excluding the rarest terms from a <code>terms</code> aggregation</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">AggregationKey&lt;<span class="predefined-type">Map</span>&lt;Genre, <span class="predefined-type">Long</span>&gt;&gt; countsByGenreKey = AggregationKey.of( <span class="string"><span class="delimiter">&quot;</span><span class="content">countsByGenre</span><span class="delimiter">&quot;</span></span> );
<span class="predefined-type">SearchResult</span>&lt;<span class="predefined-type">Book</span>&gt; result = searchSession.search( <span class="predefined-type">Book</span>.class )
        .where( f -&gt; f.matchAll() )
        .aggregation( countsByGenreKey, f -&gt; f.terms()
                .field( <span class="string"><span class="delimiter">&quot;</span><span class="content">genre</span><span class="delimiter">&quot;</span></span>, Genre.class )
                .minDocumentCount( <span class="integer">2</span> ) )
        .fetch( <span class="integer">20</span> );
<span class="predefined-type">Map</span>&lt;Genre, <span class="predefined-type">Long</span>&gt; countsByGenre = result.aggregation( countsByGenreKey );</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="search-dsl-aggregation-terms-order"><a class="anchor" href="#search-dsl-aggregation-terms-order"></a>Order of entries</h5>
<div class="paragraph">
<p>By default, entries are returned in descending order of document count,
i.e. the terms with the most matching documents appear first.</p>
</div>
<div class="paragraph">
<p>Several other orders are available.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>With the Lucene backend, due to limitations of the current implementation,
using any order other than the default one (by descending count)
may lead to incorrect results.
See <a href="https://hibernate.atlassian.net/browse/HSEARCH-3666">HSEARCH-3666</a> for more information.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can order entries by ascending term value:</p>
</div>
<div id="section-sorting-faceting-request" class="exampleblock">
<div class="title">Example 385. Ordering entries by ascending value in a <code>terms</code> aggregation</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">AggregationKey&lt;<span class="predefined-type">Map</span>&lt;Genre, <span class="predefined-type">Long</span>&gt;&gt; countsByGenreKey = AggregationKey.of( <span class="string"><span class="delimiter">&quot;</span><span class="content">countsByGenre</span><span class="delimiter">&quot;</span></span> );
<span class="predefined-type">SearchResult</span>&lt;<span class="predefined-type">Book</span>&gt; result = searchSession.search( <span class="predefined-type">Book</span>.class )
        .where( f -&gt; f.matchAll() )
        .aggregation( countsByGenreKey, f -&gt; f.terms()
                .field( <span class="string"><span class="delimiter">&quot;</span><span class="content">genre</span><span class="delimiter">&quot;</span></span>, Genre.class )
                .orderByTermAscending() )
        .fetch( <span class="integer">20</span> );
<span class="predefined-type">Map</span>&lt;Genre, <span class="predefined-type">Long</span>&gt; countsByGenre = result.aggregation( countsByGenreKey );</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>You can order entries by descending term value:</p>
</div>
<div class="exampleblock">
<div class="title">Example 386. Ordering entries by descending value in a <code>terms</code> aggregation</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">AggregationKey&lt;<span class="predefined-type">Map</span>&lt;Genre, <span class="predefined-type">Long</span>&gt;&gt; countsByGenreKey = AggregationKey.of( <span class="string"><span class="delimiter">&quot;</span><span class="content">countsByGenre</span><span class="delimiter">&quot;</span></span> );
<span class="predefined-type">SearchResult</span>&lt;<span class="predefined-type">Book</span>&gt; result = searchSession.search( <span class="predefined-type">Book</span>.class )
        .where( f -&gt; f.matchAll() )
        .aggregation( countsByGenreKey, f -&gt; f.terms()
                .field( <span class="string"><span class="delimiter">&quot;</span><span class="content">genre</span><span class="delimiter">&quot;</span></span>, Genre.class )
                .orderByTermDescending() )
        .fetch( <span class="integer">20</span> );
<span class="predefined-type">Map</span>&lt;Genre, <span class="predefined-type">Long</span>&gt; countsByGenre = result.aggregation( countsByGenreKey );</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Finally, you can order entries by ascending document count:</p>
</div>
<div class="exampleblock">
<div class="title">Example 387. Ordering entries by ascending count in a <code>terms</code> aggregation</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">AggregationKey&lt;<span class="predefined-type">Map</span>&lt;Genre, <span class="predefined-type">Long</span>&gt;&gt; countsByGenreKey = AggregationKey.of( <span class="string"><span class="delimiter">&quot;</span><span class="content">countsByGenre</span><span class="delimiter">&quot;</span></span> );
<span class="predefined-type">SearchResult</span>&lt;<span class="predefined-type">Book</span>&gt; result = searchSession.search( <span class="predefined-type">Book</span>.class )
        .where( f -&gt; f.matchAll() )
        .aggregation( countsByGenreKey, f -&gt; f.terms()
                .field( <span class="string"><span class="delimiter">&quot;</span><span class="content">genre</span><span class="delimiter">&quot;</span></span>, Genre.class )
                .orderByCountAscending() )
        .fetch( <span class="integer">20</span> );
<span class="predefined-type">Map</span>&lt;Genre, <span class="predefined-type">Long</span>&gt; countsByGenre = result.aggregation( countsByGenreKey );</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>When ordering entries by ascending count in a <code>terms</code> aggregation,
<a href="https://www.elastic.co/guide/en/elasticsearch/reference/8.13/search-aggregations-bucket-terms-aggregation.html#search-aggregations-bucket-terms-aggregation-order">hit counts are approximate</a>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="search-dsl-aggregation-terms-other"><a class="anchor" href="#search-dsl-aggregation-terms-other"></a>Other options</h5>
<div class="ulist">
<ul>
<li>
<p>For fields in nested objects, all nested objects are considered by default,
but that can be <a href="#search-dsl-aggregation-common-filter">controlled explicitly with <code>.filter(&#8230;&#8203;)</code></a>.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="search-dsl-aggregation-range"><a class="anchor" href="#search-dsl-aggregation-range"></a>15.6.3. <a id="range-faceting-request"></a> <code>range</code>: grouped by ranges of values for a field</h4>
<div class="paragraph">
<p>The <code>range</code> aggregation returns a count of documents for given ranges of values of a given field.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>In order to use aggregations based on the value of a given field,
you need to mark the field as <a href="#mapping-directfieldmapping-aggregable">aggregable</a> in the mapping.</p>
</div>
<div class="paragraph">
<p>This is not possible for full-text fields, in particular;
see <a href="#mapping-directfieldmapping-annotations-fulltextfield">here</a> for an explanation and some solutions.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The <code>range</code> aggregation is not available on geo-point fields.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="exampleblock">
<div class="title">Example 388. Counting hits grouped by range of values for a field</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">AggregationKey&lt;<span class="predefined-type">Map</span>&lt;Range&lt;<span class="predefined-type">Double</span>&gt;, <span class="predefined-type">Long</span>&gt;&gt; countsByPriceKey = AggregationKey.of( <span class="string"><span class="delimiter">&quot;</span><span class="content">countsByPrice</span><span class="delimiter">&quot;</span></span> );
<span class="predefined-type">SearchResult</span>&lt;<span class="predefined-type">Book</span>&gt; result = searchSession.search( <span class="predefined-type">Book</span>.class )
        .where( f -&gt; f.matchAll() )
        .aggregation( countsByPriceKey, f -&gt; f.range()
                .field( <span class="string"><span class="delimiter">&quot;</span><span class="content">price</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">Double</span>.class ) <i class="conum" data-value="1"></i><b>(1)</b>
                .range( <span class="float">0.0</span>, <span class="float">10.0</span> ) <i class="conum" data-value="2"></i><b>(2)</b>
                .range( <span class="float">10.0</span>, <span class="float">20.0</span> )
                .range( <span class="float">20.0</span>, <span class="predefined-constant">null</span> ) <i class="conum" data-value="3"></i><b>(3)</b>
        )
        .fetch( <span class="integer">20</span> );
<span class="predefined-type">Map</span>&lt;Range&lt;<span class="predefined-type">Double</span>&gt;, <span class="predefined-type">Long</span>&gt; countsByPrice = result.aggregation( countsByPriceKey );</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Define the path and type of the field whose values should be considered.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Define the ranges to group hits into.
The range can be passed directly as the lower bound (included) and upper bound (excluded).
Other syntaxes exist to define different bound inclusion (see other examples below).</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td><code>null</code> means "to infinity".</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect4">
<h5 id="search-dsl-aggregation-range-range-argument"><a class="anchor" href="#search-dsl-aggregation-range-range-argument"></a><a id="_passing_range_arguments"></a> Passing <code>Range</code> arguments</h5>
<div class="paragraph">
<p>Instead of passing two arguments for each range (a lower and upper bound),
you can pass a single argument of type <code>Range</code>.</p>
</div>
<div class="exampleblock">
<div class="title">Example 389. Counting hits grouped by range of values for a field&#8201;&#8212;&#8201;passing <code>Range</code> objects</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">AggregationKey&lt;<span class="predefined-type">Map</span>&lt;Range&lt;<span class="predefined-type">Double</span>&gt;, <span class="predefined-type">Long</span>&gt;&gt; countsByPriceKey = AggregationKey.of( <span class="string"><span class="delimiter">&quot;</span><span class="content">countsByPrice</span><span class="delimiter">&quot;</span></span> );
<span class="predefined-type">SearchResult</span>&lt;<span class="predefined-type">Book</span>&gt; result = searchSession.search( <span class="predefined-type">Book</span>.class )
        .where( f -&gt; f.matchAll() )
        .aggregation( countsByPriceKey, f -&gt; f.range()
                .field( <span class="string"><span class="delimiter">&quot;</span><span class="content">price</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">Double</span>.class )
                .range( Range.canonical( <span class="float">0.0</span>, <span class="float">10.0</span> ) ) <i class="conum" data-value="1"></i><b>(1)</b>
                .range( Range.between( <span class="float">10.0</span>, RangeBoundInclusion.INCLUDED,
                        <span class="float">20.0</span>, RangeBoundInclusion.EXCLUDED ) ) <i class="conum" data-value="2"></i><b>(2)</b>
                .range( Range.atLeast( <span class="float">20.0</span> ) ) <i class="conum" data-value="3"></i><b>(3)</b>
        )
        .fetch( <span class="integer">20</span> );
<span class="predefined-type">Map</span>&lt;Range&lt;<span class="predefined-type">Double</span>&gt;, <span class="predefined-type">Long</span>&gt; countsByPrice = result.aggregation( countsByPriceKey );</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>With <code>Range.of(Object, Object)</code>, the lower bound is included and the upper bound is excluded.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>Range.of(Object, RangeBoundInclusion, Object, RangeBoundInclusion)</code> is more verbose, but allows setting the bound inclusion explicitly.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td><code>Range</code> also offers multiple static methods to create ranges for a variety of use cases ("at least", "greater than", "at most", &#8230;&#8203;).</td>
</tr>
</table>
</div>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>With the Elasticsearch backend, due to a limitation of Elasticsearch itself,
all ranges must have their lower bound included (or <code>null</code>)
and their upper bound excluded (or <code>null</code>).
Otherwise, an exception will be thrown.</p>
</div>
<div class="paragraph">
<p>If you need to exclude the lower bound, or to include the upper bound,
replace that bound with the immediate next value instead.
For example with integers, <code>.range( 0, 100 )</code> means "0 (included) to 100 (excluded)".
Call <code>.range( 0, 101 )</code> to mean "0 (included) to 100 (included)",
or <code>.range( 1, 100 )</code> to mean "0 (excluded) to 100 (excluded)".</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>It&#8217;s also possible to pass a collection of <code>Range</code> objects,
which is especially useful if ranges are defined dynamically (e.g. in a web interface):</p>
</div>
<div class="exampleblock">
<div class="title">Example 390. Counting hits grouped by range of values for a field&#8201;&#8212;&#8201;passing a collection of <code>Range</code> objects</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;Range&lt;<span class="predefined-type">Double</span>&gt;&gt; ranges =
<span class="comment">/* ... */</span>;

AggregationKey&lt;<span class="predefined-type">Map</span>&lt;Range&lt;<span class="predefined-type">Double</span>&gt;, <span class="predefined-type">Long</span>&gt;&gt; countsByPriceKey = AggregationKey.of( <span class="string"><span class="delimiter">&quot;</span><span class="content">countsByPrice</span><span class="delimiter">&quot;</span></span> );
<span class="predefined-type">SearchResult</span>&lt;<span class="predefined-type">Book</span>&gt; result = searchSession.search( <span class="predefined-type">Book</span>.class )
        .where( f -&gt; f.matchAll() )
        .aggregation( countsByPriceKey, f -&gt; f.range()
                .field( <span class="string"><span class="delimiter">&quot;</span><span class="content">price</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">Double</span>.class )
                .ranges( ranges )
        )
        .fetch( <span class="integer">20</span> );
<span class="predefined-type">Map</span>&lt;Range&lt;<span class="predefined-type">Double</span>&gt;, <span class="predefined-type">Long</span>&gt; countsByPrice = result.aggregation( countsByPriceKey );</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="search-dsl-aggregation-range-skipping-conversion"><a class="anchor" href="#search-dsl-aggregation-range-skipping-conversion"></a>Skipping conversion</h5>
<div class="paragraph">
<p>By default, the bounds of ranges accepted by the <code>range</code> aggregation must have the same type as
the entity property corresponding to the target field.</p>
</div>
<div class="paragraph">
<p>For example, if an entity property if of type <code>java.util.Date</code>,
<a href="#mapping-directfieldmapping-supported-types">the corresponding field may be of type <code>java.time.Instant</code></a>;
the values returned by the <code>terms</code> aggregation will have to be of type <code>java.util.Date</code> regardless.</p>
</div>
<div class="paragraph">
<p>This should generally be what you want,
but if you ever need to bypass conversion and have unconverted values returned to you instead
(of type <code>java.time.Instant</code> in the example above),
you can do it this way:</p>
</div>
<div class="exampleblock">
<div class="title">Example 391. Counting hits grouped by range of values for a field, without converting field values</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">AggregationKey&lt;<span class="predefined-type">Map</span>&lt;Range&lt;Instant&gt;, <span class="predefined-type">Long</span>&gt;&gt; countsByPriceKey = AggregationKey.of( <span class="string"><span class="delimiter">&quot;</span><span class="content">countsByPrice</span><span class="delimiter">&quot;</span></span> );
<span class="predefined-type">SearchResult</span>&lt;<span class="predefined-type">Book</span>&gt; result = searchSession.search( <span class="predefined-type">Book</span>.class )
        .where( f -&gt; f.matchAll() )
        .aggregation( countsByPriceKey, f -&gt; f.range()
                <span class="comment">// Assuming &quot;releaseDate&quot; is of type &quot;java.util.Date&quot; or &quot;java.sql.Date&quot;</span>
                .field( <span class="string"><span class="delimiter">&quot;</span><span class="content">releaseDate</span><span class="delimiter">&quot;</span></span>, Instant.class, ValueConvert.NO )
                .range( <span class="predefined-constant">null</span>,
                        LocalDate.of( <span class="integer">1970</span>, <span class="integer">1</span>, <span class="integer">1</span> )
                                .atStartOfDay().toInstant( ZoneOffset.UTC ) )
                .range( LocalDate.of( <span class="integer">1970</span>, <span class="integer">1</span>, <span class="integer">1</span> )
                                .atStartOfDay().toInstant( ZoneOffset.UTC ),
                        LocalDate.of( <span class="integer">2000</span>, <span class="integer">1</span>, <span class="integer">1</span> )
                                .atStartOfDay().toInstant( ZoneOffset.UTC ) )
                .range( LocalDate.of( <span class="integer">2000</span>, <span class="integer">1</span>, <span class="integer">1</span> )
                                .atStartOfDay().toInstant( ZoneOffset.UTC ),
                        <span class="predefined-constant">null</span> )
        )
        .fetch( <span class="integer">20</span> );
<span class="predefined-type">Map</span>&lt;Range&lt;Instant&gt;, <span class="predefined-type">Long</span>&gt; countsByPrice = result.aggregation( countsByPriceKey );</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>See <a href="#search-dsl-argument-type">Type of arguments passed to the DSL</a> for more information.</p>
</div>
</div>
<div class="sect4">
<h5 id="search-dsl-aggregation-range-other"><a class="anchor" href="#search-dsl-aggregation-range-other"></a>Other options</h5>
<div class="ulist">
<ul>
<li>
<p>For fields in nested objects, all nested objects are considered by default,
but that can be <a href="#search-dsl-aggregation-common-filter">controlled explicitly with <code>.filter(&#8230;&#8203;)</code></a>.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="search-dsl-aggregation-extensions"><a class="anchor" href="#search-dsl-aggregation-extensions"></a>15.6.4. Backend-specific extensions</h4>
<div class="paragraph">
<p>By calling <code>.extension(&#8230;&#8203;)</code> while building a query,
it is possible to access backend-specific aggregations.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>As their name suggests, backend-specific aggregations are not portable from one backend technology to the other.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="search-dsl-aggregation-extensions-elasticsearch-from-json"><a class="anchor" href="#search-dsl-aggregation-extensions-elasticsearch-from-json"></a>Elasticsearch: <code>fromJson</code></h5>
<div class="paragraph">
<p><code>.fromJson(&#8230;&#8203;)</code> turns JSON representing an Elasticsearch aggregation into a Hibernate Search aggregation.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This feature requires to directly manipulate JSON in application code.</p>
</div>
<div class="paragraph">
<p>The syntax of this JSON may change:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>when you upgrade the underlying Elasticsearch cluster to the next version;</p>
</li>
<li>
<p>when you upgrade Hibernate Search to the next version, even for a bugfix (micro) release.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If this happens, you will need to change application code to deal with the changes.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="exampleblock">
<div class="title">Example 392. Defining a native Elasticsearch JSON aggregation as a <code>JsonObject</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">JsonObject jsonObject =
<span class="comment">/* ... */</span>;
AggregationKey&lt;JsonObject&gt; countsByPriceHistogramKey = AggregationKey.of( <span class="string"><span class="delimiter">&quot;</span><span class="content">countsByPriceHistogram</span><span class="delimiter">&quot;</span></span> );
<span class="predefined-type">SearchResult</span>&lt;<span class="predefined-type">Book</span>&gt; result = searchSession.search( <span class="predefined-type">Book</span>.class )
        .extension( ElasticsearchExtension.get() )
        .where( f -&gt; f.matchAll() )
        .aggregation( countsByPriceHistogramKey, f -&gt; f.fromJson( jsonObject ) )
        .fetch( <span class="integer">20</span> );
JsonObject countsByPriceHistogram = result.aggregation( countsByPriceHistogramKey ); <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The aggregation result is a <code>JsonObject</code>.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 393. Defining a native Elasticsearch JSON aggregation as a JSON-formatted string</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">AggregationKey&lt;JsonObject&gt; countsByPriceHistogramKey = AggregationKey.of( <span class="string"><span class="delimiter">&quot;</span><span class="content">countsByPriceHistogram</span><span class="delimiter">&quot;</span></span> );
<span class="predefined-type">SearchResult</span>&lt;<span class="predefined-type">Book</span>&gt; result = searchSession.search( <span class="predefined-type">Book</span>.class )
        .extension( ElasticsearchExtension.get() )
        .where( f -&gt; f.matchAll() )
        .aggregation( countsByPriceHistogramKey, f -&gt; f.fromJson( <span class="string"><span class="delimiter">&quot;</span><span class="content">{</span><span class="delimiter">&quot;</span></span>
                + <span class="string"><span class="delimiter">&quot;</span><span class="content">    </span><span class="char">\&quot;</span><span class="content">histogram</span><span class="char">\&quot;</span><span class="content">: {</span><span class="delimiter">&quot;</span></span>
                + <span class="string"><span class="delimiter">&quot;</span><span class="content">        </span><span class="char">\&quot;</span><span class="content">field</span><span class="char">\&quot;</span><span class="content">: </span><span class="char">\&quot;</span><span class="content">price</span><span class="char">\&quot;</span><span class="content">,</span><span class="delimiter">&quot;</span></span>
                + <span class="string"><span class="delimiter">&quot;</span><span class="content">        </span><span class="char">\&quot;</span><span class="content">interval</span><span class="char">\&quot;</span><span class="content">: 10</span><span class="delimiter">&quot;</span></span>
                + <span class="string"><span class="delimiter">&quot;</span><span class="content">    }</span><span class="delimiter">&quot;</span></span>
                + <span class="string"><span class="delimiter">&quot;</span><span class="content">}</span><span class="delimiter">&quot;</span></span> ) )
        .fetch( <span class="integer">20</span> );
JsonObject countsByPriceHistogram = result.aggregation( countsByPriceHistogramKey ); <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The aggregation result is a <code>JsonObject</code>.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="search-dsl-aggregation-common"><a class="anchor" href="#search-dsl-aggregation-common"></a>15.6.5. Options common to multiple aggregation types</h4>
<div class="sect4">
<h5 id="search-dsl-aggregation-common-filter"><a class="anchor" href="#search-dsl-aggregation-common-filter"></a>Filter for fields in nested objects</h5>
<div class="paragraph">
<p>When the aggregation field is located in a <a href="#mapping-indexedembedded-structure-nested">nested object</a>,
by default all nested objects will be considered for the aggregation,
and the document will be counted once for each value found in any nested object.</p>
</div>
<div class="paragraph">
<p>It is possible to filter the nested documents whose values will be considered for the aggregation
using one of the <code>filter(&#8230;&#8203;)</code> methods.</p>
</div>
<div class="paragraph">
<p>Below is an example with the <a href="#search-dsl-aggregation-range">range aggregation</a>:
the result of the aggregation is a count of books for each price range,
with only the price of "paperback" editions being taken into account;
the price of e-book editions, for example, is ignored.</p>
</div>
<div class="exampleblock">
<div class="title">Example 394. Counting hits grouped by range of values for a field, using a filter for nested objects</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">AggregationKey&lt;<span class="predefined-type">Map</span>&lt;Range&lt;<span class="predefined-type">Double</span>&gt;, <span class="predefined-type">Long</span>&gt;&gt; countsByPriceKey = AggregationKey.of( <span class="string"><span class="delimiter">&quot;</span><span class="content">countsByPrice</span><span class="delimiter">&quot;</span></span> );
<span class="predefined-type">SearchResult</span>&lt;<span class="predefined-type">Book</span>&gt; result = searchSession.search( <span class="predefined-type">Book</span>.class )
        .where( f -&gt; f.matchAll() )
        .aggregation( countsByPriceKey, f -&gt; f.range()
                .field( <span class="string"><span class="delimiter">&quot;</span><span class="content">editions.price</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">Double</span>.class )
                .range( <span class="float">0.0</span>, <span class="float">10.0</span> )
                .range( <span class="float">10.0</span>, <span class="float">20.0</span> )
                .range( <span class="float">20.0</span>, <span class="predefined-constant">null</span> )
                .filter( pf -&gt; pf.match().field( <span class="string"><span class="delimiter">&quot;</span><span class="content">editions.label</span><span class="delimiter">&quot;</span></span> ).matching( <span class="string"><span class="delimiter">&quot;</span><span class="content">paperback</span><span class="delimiter">&quot;</span></span> ) )
        )
        .fetch( <span class="integer">20</span> );
<span class="predefined-type">Map</span>&lt;Range&lt;<span class="predefined-type">Double</span>&gt;, <span class="predefined-type">Long</span>&gt; countsByPrice = result.aggregation( countsByPriceKey );</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="search-dsl-type-compatibility"><a class="anchor" href="#search-dsl-type-compatibility"></a>15.7. Field types and compatibility</h3>
<div class="sect3">
<h4 id="search-dsl-argument-type"><a class="anchor" href="#search-dsl-argument-type"></a>15.7.1. Type of arguments passed to the DSL</h4>
<div class="paragraph">
<p>Some predicates, such as the <code>match</code> predicate or the <code>range</code> predicate,
require a parameter of type <code>Object</code> at some point (<code>matching(Object)</code>, <code>atLeast(Object)</code>, &#8230;&#8203;).
Similarly, it is possible to pass an argument of type <code>Object</code> in the sort DSL
when defining the behavior for missing values (<code>missing().use(Object)</code>).</p>
</div>
<div class="paragraph">
<p>These methods do not actually accept <strong>any</strong> object,
and will throw an exception when passed an argument with the wrong type.</p>
</div>
<div class="paragraph">
<p>Generally the expected type of this argument should be rather obvious:
for example if you created a field by mapping an <code>Integer</code> property,
then an <code>Integer</code> value will be expected when building a predicate;
if you mapped a <code>java.time.LocalDate</code>, then a <code>java.time.LocalDate</code> will be expected,
etc.</p>
</div>
<div class="paragraph">
<p>Things get a little more complex if you start defining and using custom bridges.
You will then have properties of type <code>A</code> mapped to an index field of type <code>B</code>.
What should you pass to the DSL?
To answer that question, we need to understand DSL converters.</p>
</div>
<div class="paragraph">
<p>DSL converters are a feature of Hibernate Search that allows the DSL to accept
arguments that match the type of the indexed property,
instead of the type of the underlying index field.</p>
</div>
<div class="paragraph">
<p>Each custom bridge has the possibility to define a DSL converter for the index fields it populates.
When it does, every time that field is mentioned in the predicate DSL,
Hibernate Search will use that DSL converter to convert the value passed to the DSL to a value that the backend understands.</p>
</div>
<div class="paragraph">
<p>For example, let&#8217;s imagine an <code>AuthenticationEvent</code> entity with an <code>outcome</code> property of type <code>AuthenticationOutcome</code>.
This <code>AuthenticationOutcome</code> type is an enum.
We index the <code>AuthenticationEvent</code> entity and its <code>outcome</code> property in order to allow users to find events by their outcome.</p>
</div>
<div class="paragraph">
<p>The default bridge for enums puts the result of <code>Enum.name()</code> into a <code>String</code> field.
However, this default bridge also defines a DSL converter under the hood.
As a result, any call to the DSL will be expected to pass an <code>AuthenticationOutcome</code> instance:</p>
</div>
<div class="exampleblock">
<div class="title">Example 395. Transparent conversion of DSL parameters</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;AuthenticationEvent&gt; result = searchSession.search( AuthenticationEvent.class )
        .where( f -&gt; f.match().field( <span class="string"><span class="delimiter">&quot;</span><span class="content">outcome</span><span class="delimiter">&quot;</span></span> )
                .matching( AuthenticationOutcome.INVALID_PASSWORD ) )
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>This is handy, and especially appropriate if users are asked to select an outcome in a list of choices.
But what if we want users to type in some words instead, i.e. what if we want full-text search on the <code>outcome</code> field?
Then we will not have an <code>AuthenticationOutcome</code> instance to pass to the DSL, only a <code>String</code>&#8230;&#8203;</p>
</div>
<div class="paragraph">
<p>In that case, we will first need to assign some text to each enum.
This can be achieved by defining a custom <a href="#binding-valuebridge"><code>ValueBridge&lt;AuthenticationOutcome, String&gt;</code></a>
and applying it to the <code>outcome</code> property to index a textual description of the outcome,
instead of the default <code>Enum#name()</code>.</p>
</div>
<div class="paragraph">
<p>Then, we will need to tell Hibernate Search that the value passed to the DSL should not be passed to the DSL converter,
but should be assumed to match the type of the index field directly (in this case, <code>String</code>).
To that end, one can simply use the variant of the <code>matching</code> method that accepts a <code>ValueConvert</code> parameter,
and pass <code>ValueConvert.NO</code>:</p>
</div>
<div class="exampleblock">
<div class="title">Example 396. Disabling the DSL converter</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;AuthenticationEvent&gt; result = searchSession.search( AuthenticationEvent.class )
        .where( f -&gt; f.match().field( <span class="string"><span class="delimiter">&quot;</span><span class="content">outcome</span><span class="delimiter">&quot;</span></span> )
                .matching( <span class="string"><span class="delimiter">&quot;</span><span class="content">Invalid password</span><span class="delimiter">&quot;</span></span>, ValueConvert.NO ) )
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>All methods that apply DSL converters offer a variant that accepts a <code>ValueConvert</code> parameter:
<code>matching</code>, <code>between</code>, <code>atLeast</code>, <code>atMost</code>, <code>greaterThan</code>, <code>lessThan</code>, <code>range</code>, &#8230;&#8203;</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>A DSL converter is always automatically generated for value bridges.
However, more complex bridges will require explicit configuration.</p>
</div>
<div class="paragraph">
<p>See <a href="#binding-typebridge">  Type bridge</a> or <a href="#binding-propertybridge">  Property bridge</a> for more information.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="search-dsl-projected-value-type"><a class="anchor" href="#search-dsl-projected-value-type"></a>15.7.2. Type of projected values</h4>
<div class="paragraph">
<p>Generally the type of values returned by projections should be rather obvious:
for example if you created a field by mapping an <code>Integer</code> property,
then an <code>Integer</code> value will be returned when projecting;
if you mapped a <code>java.time.LocalDate</code>, then a <code>java.time.LocalDate</code> will be returned,
etc.</p>
</div>
<div class="paragraph">
<p>Things get a little more complex if you start defining and using custom bridges.
You will then have properties of type <code>A</code> mapped to an index field of type <code>B</code>.
What will be returned by projections?
To answer that question, we need to understand projection converters.</p>
</div>
<div class="paragraph">
<p>Projection converters are a feature of Hibernate Search that allows the projections to return
values that match the type of the indexed property,
instead of the type of the underlying index field.</p>
</div>
<div class="paragraph">
<p>Each custom bridge has the possibility to define a projection converter for the index fields it populates.
When it does, every time that field is projected on,
Hibernate Search will use that projection converter to convert the projected value returned by the index.</p>
</div>
<div class="paragraph">
<p>For example, let&#8217;s imagine an <code>Order</code> entity with a <code>status</code> property of type <code>OrderStatus</code>.
This <code>OrderStatus</code> type is an enum.
We index the <code>Order</code> entity and its <code>status</code> property.</p>
</div>
<div class="paragraph">
<p>The default bridge for enums puts the result of <code>Enum.name()</code> into a <code>String</code> field.
However, this default bridge also defines a projection converter.
As a result, any projection on the <code>status</code> field will return an <code>OrderStatus</code> instance:</p>
</div>
<div class="exampleblock">
<div class="title">Example 397. Transparent conversion of projections</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;OrderStatus&gt; result = searchSession.search( Order.class )
        .select( f -&gt; f.field( <span class="string"><span class="delimiter">&quot;</span><span class="content">status</span><span class="delimiter">&quot;</span></span>, OrderStatus.class ) )
        .where( f -&gt; f.matchAll() )
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>This is probably what you want in general.
But in some cases, you may want to disable this conversion and return the index value instead
(i.e. the value of <code>Enum.name()</code>).</p>
</div>
<div class="paragraph">
<p>In that case, we will need to tell Hibernate Search that the value returned by the backend should not be passed to the projection converter.
To that end, one can simply use the variant of the <code>field</code> method that accepts a <code>ValueConvert</code> parameter,
and pass <code>ValueConvert.NO</code>:</p>
</div>
<div class="exampleblock">
<div class="title">Example 398. Disabling the projection converter</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt; result = searchSession.search( Order.class )
        .select( f -&gt; f.field( <span class="string"><span class="delimiter">&quot;</span><span class="content">status</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">String</span>.class, ValueConvert.NO ) )
        .where( f -&gt; f.matchAll() )
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Projection converters must be configured explicitly in custom bridges.</p>
</div>
<div class="paragraph">
<p>See <a href="#binding-valuebridge">  Value bridge</a>,
<a href="#binding-propertybridge">  Property bridge</a> or <a href="#binding-typebridge">  Type bridge</a> for more information.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="search-dsl-multiple-fields"><a class="anchor" href="#search-dsl-multiple-fields"></a>15.7.3. Targeting multiple fields</h4>
<div class="paragraph">
<p>Sometimes a predicate/sort/projection targets <strong>multiple</strong> field, which may have conflicting definitions:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>when multiple field names are passed to the <code>fields</code> method in the predicate DSL (each field has its own definition);</p>
</li>
<li>
<p>or when the search query <a href="#search-dsl-query-targeting-multiple">targets multiple indexes</a> (each index has its own definition of each field).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In such cases, the definition of the targeted fields is expected to be compatible.
For example targeting an <code>Integer</code> field and a <code>java.time.LocalDate</code> field
in the same <code>match</code> predicate will not work,
because you won&#8217;t be able to pass a non-null argument to the <code>matching(Object)</code> method
that is both an <code>Integer</code> and a <code>java.time.LocalDate</code>.</p>
</div>
<div class="paragraph">
<p>If you are looking for a simple rule of thumb, here it is:
if the indexed properties do not have the same type, or are mapped differently,
the corresponding fields are probably not going to be compatible.</p>
</div>
<div class="paragraph">
<p>However, if you&#8217;re interested in the details, Hibernate Search is a bit more flexible than that.</p>
</div>
<div class="paragraph">
<p>There are three different constraints when it comes to field compatibility:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The fields must be "encoded" in a compatible way.
This means the backend must use the same representation for the two fields,
for example they are both <code>Integer</code>,
or they are both <code>BigDecimal</code> with the same decimal scale,
or they are both <code>LocalDate</code> with the same date format, etc.</p>
</li>
<li>
<p>The fields must have a compatible DSL converter (for predicates and sorts) or projection converter (for projections).</p>
</li>
<li>
<p>For full-text predicates, the fields must have a compatible analyzer.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The following sections describe all the possible incompatibilities, and how to solve them.</p>
</div>
<div class="sect4">
<h5 id="search-dsl-multiple-fields-incompatible-codec"><a class="anchor" href="#search-dsl-multiple-fields-incompatible-codec"></a><a id="_incompatible_codec"></a> Incompatible codec</h5>
<div class="paragraph">
<p>In a search query targeting multiple indexes,
if a field is encoded differently in each index,
you cannot apply predicates, sorts or projections on that field.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Encoding is not only about the field type, such as <code>LocalDate</code> or <code>BigDecimal</code>.
Some codecs are parameterized and two codecs with different parameters will often be considered incompatible.
Examples of parameters include the format for temporal types
or the <a href="#mapping-directfieldmapping-annotations-scalednumberfield">decimal scale</a>
for <code>BigDecimal</code> and <code>BigInteger</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In that case, your only option is to change your mapping to avoid the conflict:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>rename the field in one index</p>
</li>
<li>
<p>OR change the field type in one index</p>
</li>
<li>
<p>OR if the problem is simply different codec parameters (date format, decimal scale, &#8230;&#8203;),
align the value of these parameters in one index with the other index.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>If you choose to rename the field in one index,
you will still be able to apply a similar predicate
to the two fields in a single query:
you will have to create one predicate per field
and combine them with a <a href="#search-dsl-predicate-boolean">boolean junction</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="search-dsl-multiple-fields-incompatible-dsl-converter"><a class="anchor" href="#search-dsl-multiple-fields-incompatible-dsl-converter"></a><a id="_incompatible_dsl_converters"></a> Incompatible DSL converters</h5>
<div class="paragraph">
<p>Incompatible DSL converters are only a problem when you need to pass an argument to the DSL in certain methods:
<code>matching(Object)</code>/<code>between(Object)</code>/<code>atLeast(Object)</code>/<code>greaterThan(Object)</code>/etc. in the predicate DSL,
<code>missing().use(Object) in the sort DSL,
`range(Object, Object)</code> in the aggregation DSL,
&#8230;&#8203;</p>
</div>
<div class="paragraph">
<p>If two fields encoded in a compatible way (for example both as <code>String</code>),
but that have different DSL converters
(for example the first one converts from <code>String</code> to <code>String</code>, but the second one converts from <code>Integer</code> to <code>String</code>),
you can still use these methods, but you will need to disable the DSL converter
as explained in <a href="#search-dsl-argument-type">Type of arguments passed to the DSL</a>:
you will just pass the "index" value to the DSL (using the same example, a <code>String</code>).</p>
</div>
</div>
<div class="sect4">
<h5 id="search-dsl-multiple-fields-incompatible-projection-converter"><a class="anchor" href="#search-dsl-multiple-fields-incompatible-projection-converter"></a><a id="_incompatible_projection_converters"></a> Incompatible projection converters</h5>
<div class="paragraph">
<p>If, in a search query targeting multiple indexes,
a field is encoded in a compatible way in every index (for example both as <code>String</code>),
but that has a different projection converters
(for example the first one converts from <code>String</code> to <code>String</code>, but the second one converts from <code>String</code> to <code>Integer</code>),
you can still project on this field, but you will need to disable the projection converter
as explained in <a href="#search-dsl-projected-value-type">Type of projected values</a>:
the projection will return the "index", unconverted value (using the same example, a <code>String</code>).</p>
</div>
</div>
<div class="sect4">
<h5 id="search-dsl-multiple-fields-incompatible-analyzer"><a class="anchor" href="#search-dsl-multiple-fields-incompatible-analyzer"></a><a id="_incompatible_analyzer"></a> Incompatible analyzer</h5>
<div class="paragraph">
<p>Incompatible analyzers are only a problem with full-text predicates:
match predicate on a text field, phrase predicate, simple query string predicate, &#8230;&#8203;</p>
</div>
<div class="paragraph">
<p>If two fields encoded in a compatible way (for example both as <code>String</code>),
but that have different analyzers,
you can still use these predicates, but you will need to explicitly configure the predicate to either
set the search analyzer to an analyzer of your choosing with <code>.analyzer(analyzerName)</code>,
or skip analysis completely with <code>.skipAnalysis()</code>.</p>
</div>
<div class="paragraph">
<p>See <a href="#search-dsl-predicate"> Predicate DSL</a> for more information about how to create predicates
and about the available options.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="search-dsl-paths"><a class="anchor" href="#search-dsl-paths"></a>15.8. Field paths</h3>
<div class="sect3">
<h4 id="search-dsl-paths-absolute"><a class="anchor" href="#search-dsl-paths-absolute"></a>15.8.1. Absolute field paths</h4>
<div class="paragraph">
<p>By default, field paths passed to the Search DSL are interpreted as absolute,
i.e. relative to the index root.</p>
</div>
<div class="paragraph">
<p>The components of the paths are separated by a dot (<code>.</code>).</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The following examples use the <a href="#search-dsl-predicate">predicate DSL</a>,
but all information in this section applies to other search DSLs as well:
<a href="#search-dsl-sort">sort DSL</a>, <a href="#search-dsl-projection">projection DSL</a>, <a href="#search-dsl-aggregation">aggregation DSL</a>, &#8230;&#8203;</p>
</div>
</td>
</tr>
</table>
</div>
<div class="exampleblock">
<div class="title">Example 399. Targeting a field using absolute paths</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .where( f -&gt; f.match().field( <span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span> ) <i class="conum" data-value="1"></i><b>(1)</b>
                .matching( <span class="string"><span class="delimiter">&quot;</span><span class="content">robot</span><span class="delimiter">&quot;</span></span> ) )
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Fields declared at the root of the index can simply be referenced by their name.</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .where( f -&gt; f.match().field( <span class="string"><span class="delimiter">&quot;</span><span class="content">writers.firstName</span><span class="delimiter">&quot;</span></span> ) <i class="conum" data-value="1"></i><b>(1)</b>
                .matching( <span class="string"><span class="delimiter">&quot;</span><span class="content">isaac</span><span class="delimiter">&quot;</span></span> ) )
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Fields declared in object fields (created by <a href="#mapping-indexedembedded"><code>@IndexedEmbedded</code></a>, for example)
must be referenced by their absolute path: the absolute path of the object field, followed by a dot,
followed by the name of the targeted field.</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .where( f -&gt; f.nested( <span class="string"><span class="delimiter">&quot;</span><span class="content">writers</span><span class="delimiter">&quot;</span></span> )
                .add( f.match().field( <span class="string"><span class="delimiter">&quot;</span><span class="content">writers.firstName</span><span class="delimiter">&quot;</span></span> ) <i class="conum" data-value="1"></i><b>(1)</b>
                        .matching( <span class="string"><span class="delimiter">&quot;</span><span class="content">isaac</span><span class="delimiter">&quot;</span></span> ) )
                .add( f.match().field( <span class="string"><span class="delimiter">&quot;</span><span class="content">writers.lastName</span><span class="delimiter">&quot;</span></span> )
                        .matching( <span class="string"><span class="delimiter">&quot;</span><span class="content">asimov</span><span class="delimiter">&quot;</span></span> ) )
        )
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Even within a <code>nested</code> predicate, fields referenced in inner predicates must be referenced by their absolute path.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>The only exception is <a href="#binding-named-predicate">named predicates</a> registered on object fields:
the factory used to build those predicates interprets field paths as relative to that object field <strong>by default</strong>.</p>
</div>
</div>
<div class="sect3">
<h4 id="search-dsl-paths-relative"><a class="anchor" href="#search-dsl-paths-relative"></a>15.8.2. Relative field paths</h4>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Features detailed below are <em>incubating</em>: they are still under active development.</p>
</div>
<div class="paragraph">
<p>The usual <a href="https://hibernate.org/community/compatibility-policy/">compatibility policy</a> does not apply:
the contract of incubating elements (e.g. types, methods, configuration properties, etc.)
may be altered in a backward-incompatible way&#8201;&#8212;&#8201;or even removed&#8201;&#8212;&#8201;in subsequent releases.</p>
</div>
<div class="paragraph">
<p>You are encouraged to use incubating features so the development team can get feedback and improve them,
but you should be prepared to update code which relies on them as needed.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In some cases, one may want to pass relative paths instead.
This can be useful when calling reusable methods that can apply the same predicate
on different object fields that have same structure (same subfields).
By calling the <code>withRoot(String)</code> method on a factory,
you can create a new factory which interprets paths as relative to the object field passed as argument to the method.</p>
</div>
<div class="exampleblock">
<div class="title">Example 400. Targeting a field using relative paths</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; hits = searchSession.search( <span class="predefined-type">Book</span>.class )
        .where( f -&gt; f.or()
                .add( f.nested( <span class="string"><span class="delimiter">&quot;</span><span class="content">writers</span><span class="delimiter">&quot;</span></span> )
                        .add( matchFirstAndLastName( <i class="conum" data-value="1"></i><b>(1)</b>
                                f.withRoot( <span class="string"><span class="delimiter">&quot;</span><span class="content">writers</span><span class="delimiter">&quot;</span></span> ), <i class="conum" data-value="2"></i><b>(2)</b>
                                <span class="string"><span class="delimiter">&quot;</span><span class="content">bob</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">kane</span><span class="delimiter">&quot;</span></span> ) ) )
                .add( f.nested( <span class="string"><span class="delimiter">&quot;</span><span class="content">artists</span><span class="delimiter">&quot;</span></span> )
                        .add( matchFirstAndLastName( <i class="conum" data-value="3"></i><b>(3)</b>
                                f.withRoot( <span class="string"><span class="delimiter">&quot;</span><span class="content">artists</span><span class="delimiter">&quot;</span></span> ), <i class="conum" data-value="4"></i><b>(4)</b>
                                <span class="string"><span class="delimiter">&quot;</span><span class="content">bill</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">finger</span><span class="delimiter">&quot;</span></span> ) ) ) )
        .fetchHits( <span class="integer">20</span> );</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Call a reusable method to apply a predicate to the name of the book&#8217;s writers.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Pass to that method a factory whose root will be the object field <code>writers</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Call a reusable method to apply a predicate to the name of the book&#8217;s artists.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Pass to that method a factory whose root will be the object field <code>artists</code>.</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="directive">private</span> SearchPredicate matchFirstAndLastName(SearchPredicateFactory f,
        <span class="predefined-type">String</span> firstName, <span class="predefined-type">String</span> lastName) {
    <span class="keyword">return</span> f.and(
            f.match().field( <span class="string"><span class="delimiter">&quot;</span><span class="content">firstName</span><span class="delimiter">&quot;</span></span> ) <i class="conum" data-value="1"></i><b>(1)</b>
                    .matching( firstName ),
            f.match().field( <span class="string"><span class="delimiter">&quot;</span><span class="content">lastName</span><span class="delimiter">&quot;</span></span> )
                    .matching( lastName )
    )
            .toPredicate();
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>When manipulating factories created with <code>withRoot</code>, paths are interpreted as relative.
Here <code>firstName</code> will be understood as either <code>writers.firstName</code> or <code>artists.firstName</code>,
depending on the factory that was passed to this method.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>When building native constructs (for example <a href="#search-dsl-predicate-extensions-lucene-from-lucene-query">Lucene Queries</a>),
you will need to deal with absolute paths, even if the factory accepts relative paths.</p>
</div>
<div class="paragraph">
<p>To convert a relative path to an absolute path, use the factory&#8217;s <code>toAbsolutePath(String)</code> method.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="backend-lucene"><a class="anchor" href="#backend-lucene"></a>16. <a id="search-lucene-native"></a> Lucene backend</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="backend-lucene-configuration"><a class="anchor" href="#backend-lucene-configuration"></a>16.1. Basic configuration</h3>
<div class="paragraph">
<p>All configuration properties of the Lucene backend are optional,
but the defaults might not suit everyone.
In particular, you might want to
<a href="#backend-lucene-configuration-directory-local-filesystem-location">set the location of your indexes in the filesystem</a>.</p>
</div>
<div class="paragraph">
<p>Other configuration properties are mentioned in the relevant parts of this documentation.
You can find a full reference of available properties in
<a href="#configuration-properties-aggregated-hibernate-search-backend-lucene">the Lucene backend configuration properties appendix</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="backend-lucene-configuration-directory"><a class="anchor" href="#backend-lucene-configuration-directory"></a>16.2. <a id="search-configuration-directory"></a> Index storage (<code>Directory</code>)</h3>
<div class="paragraph">
<p>The component responsible for index storage in Lucene is the <code>org.apache.lucene.store.Directory</code>.
The implementation of the directory determines where the index will be stored:
on the filesystem, in the JVM&#8217;s heap, &#8230;&#8203;</p>
</div>
<div class="paragraph">
<p>By default, the Lucene backend stores the indexes on the filesystem,
in the JVM&#8217;s working directory.</p>
</div>
<div class="paragraph">
<p>The type of directory can be configured as follows:</p>
</div>
<div id="example-configuring-directory-providers" class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code># To configure the defaults for all indexes:
hibernate.search.backend.directory.type = local-filesystem
# To configure a specific index:
hibernate.search.backend.indexes.&lt;index-name&gt;.directory.type = local-filesystem</code></pre>
</div>
</div>
<div id="directory-provider-table" class="paragraph">
<p>The following directory types are available:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>local-filesystem</code>: Store the index on the local filesystem.
See <a href="#backend-lucene-configuration-directory-local-filesystem">Local filesystem storage</a>
for details and configuration options.</p>
</li>
<li>
<p><code>local-heap</code>: Store the index in the local JVM heap.
<strong>Local heap directories and all contained indexes are lost when the JVM shuts down.</strong>
See <a href="#backend-lucene-configuration-directory-local-heap">Local heap storage</a>
for details and configuration options.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="backend-lucene-configuration-directory-local-filesystem"><a class="anchor" href="#backend-lucene-configuration-directory-local-filesystem"></a>16.2.1. Local filesystem storage</h4>
<div class="paragraph">
<p>The <code>local-filesystem</code> directory type will store each index in
a subdirectory of a configured filesystem directory.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Local filesystem directories really are designed to be <strong>local</strong> to one server and one application.</p>
</div>
<div class="paragraph">
<p>In particular, they should not be shared between multiple Hibernate Search instances.
Even if network shares allow to share the raw content of indexes,
using the same index files from multiple Hibernate Search
would require more than that:
non-exclusive locking, routing of write requests from one node to another, &#8230;&#8203;
These additional features are simply not available on <code>local-filesystem</code> directories.</p>
</div>
<div class="paragraph">
<p>If you need to share indexes between multiple Hibernate Search instances,
the Elasticsearch backend will be a better choice.
Refer to <a href="#architecture"> Architecture</a> for more information.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="backend-lucene-configuration-directory-local-filesystem-location"><a class="anchor" href="#backend-lucene-configuration-directory-local-filesystem-location"></a>Index location</h5>
<div class="paragraph">
<p>Each index is assigned a subdirectory under a root directory.</p>
</div>
<div class="paragraph">
<p>By default, the root directory is the JVM&#8217;s working directory.
It can be configured as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code># To configure the defaults for all indexes:
hibernate.search.backend.directory.root = /path/to/my/root
# To configure a specific index:
hibernate.search.backend.indexes.&lt;index-name&gt;.directory.root = /path/to/my/root</code></pre>
</div>
</div>
<div class="paragraph">
<p>For example, with the configuration above,
an <a href="#concepts-entity">entity type</a> named <code>Order</code> will be indexed in directory
<code>/path/to/my/root/Order/</code>.
If that entity is explicitly assigned the index name <code>orders</code>
(see <code>@Indexed(index = &#8230;&#8203;)</code> in <a href="#mapping-entityindexmapping"> Entity/index mapping</a>),
it will instead be indexed in directory
<code>/path/to/my/root/orders/</code>.</p>
</div>
</div>
<div class="sect4">
<h5 id="backend-lucene-configuration-directory-filesystem-access-strategy"><a class="anchor" href="#backend-lucene-configuration-directory-filesystem-access-strategy"></a><a id="_filesystem_access_strategy"></a> Filesystem access strategy</h5>
<div class="paragraph">
<p>The default strategy for accessing the filesystem is determined automatically
based on the operating system and architecture.
It should work well in most situations.</p>
</div>
<div class="paragraph">
<p>For situations where a different filesystem access strategy is needed,
Hibernate Search exposes a configuration property:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code># To configure the defaults for all indexes:
hibernate.search.backend.directory.filesystem_access.strategy = auto
# To configure a specific index:
hibernate.search.backend.indexes.&lt;index-name&gt;.directory.filesystem_access.strategy = auto</code></pre>
</div>
</div>
<div class="paragraph">
<p>Allowed values are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>auto</code>: lets Lucene select the most appropriate implementation
based on the operating system and architecture.
This is the default value for the property.</p>
</li>
<li>
<p><code>mmap</code>: uses <code>mmap</code> for reading, and <code>FSDirectory.FSIndexOutput</code> for writing.
See <code>org.apache.lucene.store.MMapDirectory</code>.</p>
</li>
<li>
<p><code>nio</code>: uses <code>java.nio.channels.FileChannel</code>'s positional read for concurrent reading,
and <code>FSDirectory.FSIndexOutput</code> for writing.
See <code>org.apache.lucene.store.NIOFSDirectory</code>.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Make sure to refer to Javadocs of these <code>Directory</code>
implementations before changing this setting.
Implementations offering better performance
also bring issues of their own.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="backend-lucene-configuration-directory-other"><a class="anchor" href="#backend-lucene-configuration-directory-other"></a>Other configuration options</h5>
<div class="paragraph">
<p>The <code>local-filesystem</code> directory also allows configuring a
<a href="#backend-lucene-configuration-directory-locking-strategy">locking strategy</a>.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="backend-lucene-configuration-directory-local-heap"><a class="anchor" href="#backend-lucene-configuration-directory-local-heap"></a>16.2.2. Local heap storage</h4>
<div class="paragraph">
<p>The <code>local-heap</code> directory type will store indexes in the local JVM&#8217;s heap.</p>
</div>
<div class="paragraph">
<p>As a result, indexes contained in a <code>local-heap</code> directory are <strong>lost when the JVM shuts down</strong>.</p>
</div>
<div class="paragraph">
<p>This directory type is only provided for use in <strong>testing configurations</strong>
with <strong>small indexes</strong> and <strong>low concurrency</strong>,
where it could slightly improve performance.
In setups requiring larger indexes and/or high concurrency,
a <a href="#backend-lucene-configuration-directory-local-filesystem">filesystem-based directory</a>
will achieve better performance.</p>
</div>
<div class="paragraph">
<p>The <code>local-heap</code> directory does not offer any specific option
beyond the <a href="#backend-lucene-configuration-directory-locking-strategy">locking strategy</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="backend-lucene-configuration-directory-locking-strategy"><a class="anchor" href="#backend-lucene-configuration-directory-locking-strategy"></a>16.2.3. <a id="search-configuration-directory-lockfactories"></a> Locking strategy</h4>
<div class="paragraph">
<p>In order to write to an index, Lucene needs to acquire a lock to ensure no other application instance
writes to the same index concurrently.
Each directory type comes with a default locking strategy that should work well enough in most situations.</p>
</div>
<div class="paragraph">
<p>For those (very) rare situations where a different locking strategy is needed,
Hibernate Search exposes a configuration property:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code># To configure the defaults for all indexes:
hibernate.search.backend.directory.locking.strategy = native-filesystem
# To configure a specific index:
hibernate.search.backend.indexes.&lt;index-name&gt;.directory.locking.strategy = native-filesystem</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following strategies are available:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>simple-filesystem</code>:
Locks the index by creating a marker file and checking it before write operations.
This implementation is very simple and based Java&#8217;s File API.
If for some reason an application ends abruptly,
the marker file will stay on the filesystem and will need to be removed manually.</p>
<div class="paragraph">
<p>This strategy is only available for filesystem-based directories.</p>
</div>
<div class="paragraph">
<p>See <code>org.apache.lucene.store.SimpleFSLockFactory</code>.</p>
</div>
</li>
<li>
<p><code>native-filesystem</code>:
Similarly to <code>simple-filesystem</code>, locks the index by creating a marker file,
but using native OS file locks instead of Java&#8217;s File API,
so that locks will be cleaned up if the application ends abruptly.</p>
<div class="paragraph">
<p>This is the default strategy for the <code>local-filesystem</code> directory type.</p>
</div>
<div class="paragraph">
<p>This implementation has known problems with NFS: it should be avoided on network shares.</p>
</div>
<div class="paragraph">
<p>This strategy is only available for filesystem-based directories.</p>
</div>
<div class="paragraph">
<p>See <code>org.apache.lucene.store.NativeFSLockFactory</code>.</p>
</div>
</li>
<li>
<p><code>single-instance</code>:
Locks using a Java object held in the JVM&#8217;s heap.
Since the lock is only accessible by the same JVM,
this strategy will only work properly when it is known
that only a single application will ever try to access the indexes.</p>
<div class="paragraph">
<p>This is the default strategy for the <code>local-heap</code> directory type.</p>
</div>
<div class="paragraph">
<p>See <code>org.apache.lucene.store.SingleInstanceLockFactory</code>.</p>
</div>
</li>
<li>
<p><code>none</code>:
Does not use any lock.
Concurrent writes from another application will result in index corruption.
Test your application carefully and make sure you know what it means.</p>
<div class="paragraph">
<p>See <code>org.apache.lucene.store.NoLockFactory</code>.</p>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="backend-lucene-configuration-sharding"><a class="anchor" href="#backend-lucene-configuration-sharding"></a>16.3. <a id="advanced-features-sharding"></a> Sharding</h3>
<div class="sect3">
<h4 id="backend-lucene-configuration-sharding-basics"><a class="anchor" href="#backend-lucene-configuration-sharding-basics"></a>16.3.1. Basics</h4>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>For a preliminary introduction to sharding,
including how it works in Hibernate Search and what its limitations are,
see <a href="#concepts-sharding-routing">Sharding and routing</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In the Lucene backend, sharding is disabled by default,
but can be enabled by selecting a sharding strategy.
Multiple strategies are available:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><a id="backend-lucene-configuration-sharding-strategy-hash"></a><code>hash</code></dt>
<dd>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code># To configure the defaults for all indexes:
hibernate.search.backend.sharding.strategy = hash
hibernate.search.backend.sharding.number_of_shards = 2
# To configure a specific index:
hibernate.search.backend.indexes.&lt;index-name&gt;.sharding.strategy = hash
hibernate.search.backend.indexes.&lt;index-name&gt;.sharding.number_of_shards = 2</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>hash</code> strategy requires to set a number of shards through the <code>number_of_shards</code> property.</p>
</div>
<div class="paragraph">
<p>This strategy will set up an explicitly configured number of shards,
numbered from 0 to the chosen number minus one
(e.g. for 2 shards, there will be shard "0" and shard "1").</p>
</div>
<div class="paragraph">
<p>When routing, the routing key will be hashed to assign it to a shard.
If the routing key is null, the document ID will be used instead.</p>
</div>
<div class="paragraph">
<p>This strategy is suitable when there is no explicit routing key
<a href="#binding-routingbridge-routingkey">configured in the mapping</a>,
or when the routing key has a large number of possible values that need
to be brought down to a smaller number (e.g. "all integers").</p>
</div>
</dd>
<dt class="hdlist1"><a id="backend-lucene-configuration-sharding-strategy-explicit"></a><code>explicit</code></dt>
<dd>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code># To configure the defaults for all indexes:
hibernate.search.backend.sharding.strategy = explicit
hibernate.search.backend.sharding.shard_identifiers = fr,en,de
# To configure a specific index:
hibernate.search.backend.indexes.&lt;index-name&gt;.sharding.strategy = explicit
hibernate.search.backend.indexes.&lt;index-name&gt;.sharding.shard_identifiers = fr,en,de</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>explicit</code> strategy requires to set a list of shard identifiers through the <code>shard_identifiers</code> property.
The identifiers must be provided as a String containing multiple shard identifiers separated by commas,
or a <code>Collection&lt;String&gt;</code> containing shard identifiers.
A shard identifier can be any string.</p>
</div>
<div class="paragraph">
<p>This strategy will set up one shard per configured shard identifier.</p>
</div>
<div class="paragraph">
<p>When routing, the routing key will be validated to make sure it matches a shard identifier exactly.
If it does, the document will be routed to that shard.
If it does not, an exception will be thrown.
The routing key cannot be null, and the document ID will be ignored.</p>
</div>
<div class="paragraph">
<p>This strategy is suitable when there is an explicit routing key
<a href="#binding-routingbridge-routingkey">configured in the mapping</a>,
and that routing key has a limited number of possible values that are known before starting the application.</p>
</div>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="backend-lucene-configuration-sharding-configuration"><a class="anchor" href="#backend-lucene-configuration-sharding-configuration"></a>16.3.2. Per-shard configuration</h4>
<div class="paragraph">
<p>In some cases, in particular when using the <a href="#backend-lucene-configuration-sharding-strategy-explicit"><code>explicit</code></a>
sharding strategy, it may be necessary to configure some shards in a slightly different way.
For example, one of the shards may hold massive, but infrequently-accessed data,
which should be stored on a different drive.</p>
</div>
<div class="paragraph">
<p>This can be achieved by adding configuration properties for a specific shard:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code># Default configuration for all shards an index:
hibernate.search.backend.indexes.&lt;index-name&gt;.directory.root = /path/to/fast/drive/
# Configuration for a specific shard:
hibernate.search.backend.indexes.&lt;index-name&gt;.shards.&lt;shard-identifier&gt;.directory.root = /path/to/large/drive/</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Not all settings can be overridden per shard; for example you can&#8217;t override the sharding strategy on a per-shard basis.</p>
</div>
<div class="paragraph">
<p>Per-shard overriding is primarily intended for settings
related to the <a href="#backend-lucene-configuration-directory">directory</a> and <a href="#backend-lucene-io">I/O</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Valid shard identifiers depend on the sharding strategy:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>For the <a href="#backend-lucene-configuration-sharding-strategy-hash"><code>hash</code></a> strategy,
each shard is assigned a positive integer, from <code>0</code> to the chosen number of shards minus one.</p>
</li>
<li>
<p>For the <a href="#backend-lucene-configuration-sharding-strategy-explicit"><code>explicit</code></a> strategy,
each shard is assigned one of the identifiers defined with the <code>shard_identifiers</code> property.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="backend-lucene-configuration-lucene-version"><a class="anchor" href="#backend-lucene-configuration-lucene-version"></a>16.4. <a id="_index_format_compatibility"></a> Index format compatibility</h3>
<div class="paragraph">
<p>While Hibernate Search strives to offer a backwards compatible API,
making it easy to port your application to newer versions,
it still delegates to Apache Lucene to handle the index writing and searching.
This creates a dependency to the Lucene index format.
The Lucene developers of course attempt to keep a stable index format,
but sometimes a change in the format can not be avoided.
In those cases you either have to re-index all your data or use an index upgrade tool.
Sometimes, Lucene is also able to read the old format, so you don&#8217;t need to take specific actions
(beside making backup of your index).</p>
</div>
<div class="paragraph">
<p>While an index format incompatibility is a rare event,
it can happen more often that Lucene&#8217;s Analyzer implementations might slightly change its behavior.
This can lead to some documents not matching anymore, even though they used to.</p>
</div>
<div class="paragraph">
<p>To avoid this analyzer incompatibility,
Hibernate Search allows configuring to which version of Lucene
the analyzers and other Lucene classes should conform their behavior.</p>
</div>
<div class="paragraph">
<p>This configuration property is set at the backend level:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>hibernate.search.backend.lucene_version = LUCENE_8_1_1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Depending on the specific version of Lucene you&#8217;re using,
you might have different options available:
see <code>org.apache.lucene.util.Version</code> contained in <code>lucene-core.jar</code>
for a list of allowed values.</p>
</div>
<div class="paragraph">
<p>When this option is not set, Hibernate Search will instruct Lucene to use the latest version,
which is usually the best option for new projects.
Still, it&#8217;s recommended to define the version you&#8217;re using explicitly in the configuration,
so that when you happen to upgrade, Lucene the analyzers will not change behavior.
You can then choose to update this value at a later time,
for example when you have the chance to rebuild the index from scratch.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The setting will be applied consistently when using Hibernate Search APIs,
but if you are also making use of Lucene bypassing Hibernate Search
(for example when instantiating an Analyzer yourself),
make sure to use the same value.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>For information about which versions of Hibernate Search you can upgrade to,
while retaining backward compatibility with a given version of Lucene APIs,
refer to the <a href="https://hibernate.org/community/compatibility-policy/#compatibility-third-party-hsearch-lucene">compatibility policy</a>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="backend-lucene-schema"><a class="anchor" href="#backend-lucene-schema"></a>16.5. Schema</h3>
<div class="paragraph">
<p>Lucene does not really have a concept of centralized schema to specify the data type and capabilities of each field,
but Hibernate Search maintains such a schema in memory,
in order to remember which predicates/projections/sorts can be applied to each field.</p>
</div>
<div class="paragraph">
<p>For the most part, the schema is inferred from
<a href="#mapping">the mapping configured through Hibernate Search&#8217;s mapping APIs</a>,
which are generic and independent of Lucene.</p>
</div>
<div class="paragraph">
<p>Aspects that are specific to the Lucene backend are explained in this section.</p>
</div>
<div class="sect3">
<h4 id="backend-lucene-field-types"><a class="anchor" href="#backend-lucene-field-types"></a>16.5.1. Field types</h4>
<div class="sect4">
<h5 id="backend-lucene-field-types-available"><a class="anchor" href="#backend-lucene-field-types-available"></a>Available field types</h5>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Some types are not supported directly by the Lucene backend,
but will work anyway because they are "bridged" by the mapper.
For example a <code>java.util.Date</code> in your entity model is "bridged" to <code>java.time.Instant</code>,
which is supported by the Lucene backend.
See <a href="#mapping-directfieldmapping-supported-types">  Supported property types</a> for more information.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Field types that are not in this list can still be used with a bit more work:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If a property in the entity model has an unsupported type,
but can be converted to a supported type, you will need a bridge.
See <a href="#binding">  Binding and bridges</a>.</p>
</li>
<li>
<p>If you need an index field with a specific type that is not supported by Hibernate Search,
you will need a bridge that defines a native field type.
See <a href="#backend-lucene-field-types-extension">Index field type DSL extensions</a>.</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 12. Field types supported by the Lucene backend</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field type</th>
<th class="tableblock halign-left valign-top">Limitations</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="literal"><pre>java.lang.String</pre></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="literal"><pre>java.lang.Byte</pre></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="literal"><pre>java.lang.Short</pre></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="literal"><pre>java.lang.Integer</pre></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="literal"><pre>java.lang.Long</pre></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="literal"><pre>java.lang.Double</pre></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="literal"><pre>java.lang.Float</pre></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="literal"><pre>java.lang.Boolean</pre></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="literal"><pre>java.math.BigDecimal</pre></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="literal"><pre>java.math.BigInteger</pre></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="literal"><pre>java.time.Instant</pre></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#backend-lucene-field-types-date-time">Lower range/resolution</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="literal"><pre>java.time.LocalDate</pre></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#backend-lucene-field-types-date-time">Lower range/resolution</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="literal"><pre>java.time.LocalTime</pre></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#backend-lucene-field-types-date-time">Lower range/resolution</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="literal"><pre>java.time.LocalDateTime</pre></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#backend-lucene-field-types-date-time">Lower range/resolution</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="literal"><pre>java.time.ZonedDateTime</pre></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#backend-lucene-field-types-date-time">Lower range/resolution</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="literal"><pre>java.time.OffsetDateTime</pre></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#backend-lucene-field-types-date-time">Lower range/resolution</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="literal"><pre>java.time.OffsetTime</pre></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#backend-lucene-field-types-date-time">Lower range/resolution</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="literal"><pre>java.time.Year</pre></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#backend-lucene-field-types-date-time">Lower range/resolution</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="literal"><pre>java.time.YearMonth</pre></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#backend-lucene-field-types-date-time">Lower range/resolution</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="literal"><pre>java.time.MonthDay</pre></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="literal"><pre>org.hibernate.search.&lt;wbr&gt;engine.&lt;wbr&gt;spatial.&lt;wbr&gt;GeoPoint</pre></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#backend-lucene-field-types-geopoint">Lower resolution</a></p></td>
</tr>
</tbody>
</table>
<div id="backend-lucene-field-types-date-time" class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Range and resolution of date/time fields</div>
<div class="paragraph">
<p>Date/time types do not support the whole range of years that can be represented in <code>java.time</code> types:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>java.time</code> can represent years ranging from <code>-999.999.999</code> to <code>999.999.999</code>.</p>
</li>
<li>
<p>The Lucene backend supports dates ranging from year <code>-292.275.054</code> to year <code>292.278.993</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Values that are out of range will trigger indexing failures.</p>
</div>
<div class="paragraph">
<p>Resolution for time types is also lower:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>java.time</code> supports nanosecond-resolution.</p>
</li>
<li>
<p>The Lucene backend supports millisecond-resolution.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Precision beyond the millisecond will be lost when indexing.</p>
</div>
</td>
</tr>
</table>
</div>
<div id="backend-lucene-field-types-geopoint" class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Range and resolution of <code>GeoPoint</code> fields</div>
<div class="paragraph">
<p><code>GeoPoint</code>s are indexed as <code>LatLonPoint</code>s in the Lucene backend.
According to <code>LatLonPoint</code>'s javadoc, there is a loss of precision when the values are encoded:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Values are indexed with some loss of precision from the
original <code>double</code> values (<code>4.190951585769653E-8</code> for the latitude component
and <code>8.381903171539307E-8</code> for longitude).</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>This effectively means indexed points can be off by about 13 centimeters (5.2 inches) in the worst case.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="backend-lucene-field-types-extension"><a class="anchor" href="#backend-lucene-field-types-extension"></a>Index field type DSL extensions</h5>
<div class="paragraph">
<p>Not all Lucene field types have built-in support in Hibernate Search.
Unsupported field types can still be used, however,
by taking advantage of the "native" field type.
Using this field type, Lucene <code>IndexableField</code> instances can be created directly,
giving access to everything Lucene can offer.</p>
</div>
<div class="paragraph">
<p>Below is an example of how to use the Lucene "native" type.</p>
</div>
<div class="exampleblock">
<div class="title">Example 401. Using the Lucene "native" type</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="directive">public</span> <span class="type">class</span> <span class="class">PageRankValueBinder</span> <span class="directive">implements</span> ValueBinder { <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> bind(ValueBindingContext&lt;?&gt; context) {
        context.bridge(
                <span class="predefined-type">Float</span>.class,
                <span class="keyword">new</span> PageRankValueBridge(),
                context.typeFactory() <i class="conum" data-value="2"></i><b>(2)</b>
                        .extension( LuceneExtension.get() ) <i class="conum" data-value="3"></i><b>(3)</b>
                        .asNative( <i class="conum" data-value="4"></i><b>(4)</b>
                                <span class="predefined-type">Float</span>.class, <i class="conum" data-value="5"></i><b>(5)</b>
                                (absoluteFieldPath, value, collector) -&gt; { <i class="conum" data-value="6"></i><b>(6)</b>
                                    collector.accept( <span class="keyword">new</span> FeatureField( absoluteFieldPath, <span class="string"><span class="delimiter">&quot;</span><span class="content">pageRank</span><span class="delimiter">&quot;</span></span>, value ) );
                                    collector.accept( <span class="keyword">new</span> StoredField( absoluteFieldPath, value ) );
                                },
                                field -&gt; (<span class="predefined-type">Float</span>) field.numericValue() <i class="conum" data-value="7"></i><b>(7)</b>
                        )
        );
    }

    <span class="directive">private</span> <span class="directive">static</span> <span class="type">class</span> <span class="class">PageRankValueBridge</span> <span class="directive">implements</span> ValueBridge&lt;<span class="predefined-type">Float</span>, <span class="predefined-type">Float</span>&gt; {
        <span class="annotation">@Override</span>
        <span class="directive">public</span> <span class="predefined-type">Float</span> toIndexedValue(<span class="predefined-type">Float</span> value, ValueBridgeToIndexedValueContext context) {
            <span class="keyword">return</span> value; <i class="conum" data-value="8"></i><b>(8)</b>
        }

        <span class="annotation">@Override</span>
        <span class="directive">public</span> <span class="predefined-type">Float</span> fromIndexedValue(<span class="predefined-type">Float</span> value, ValueBridgeFromIndexedValueContext context) {
            <span class="keyword">return</span> value; <i class="conum" data-value="8"></i><b>(8)</b>
        }
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Define a <a href="#binding">custom binder</a> and its bridge.
The "native" type can only be used from a binder,
it cannot be used directly with annotation mapping.
Here we&#8217;re defining a <a href="#binding-valuebridge">value binder</a>,
but a <a href="#binding-typebridge">type binder</a>,
or a <a href="#binding-propertybridge">property binder</a>
would work as well.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Get the context&#8217;s type factory.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Apply the Lucene extension to the type factory.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Call <code>asNative</code> to start defining a native type.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Define the field value type.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Define the <code>LuceneFieldContributor</code>.
The contributor will be called upon indexing to add as many fields as necessary to the document.
All fields must be named after the <code>absoluteFieldPath</code> passed to the contributor.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Optionally, if projections are necessary, define the <code>LuceneFieldValueExtractor</code>.
The extractor will be called upon projecting to extract the projected value from a <strong>single</strong> stored field.</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>The value bridge is free to apply a preliminary conversion
before passing the value to Hibernate Search, which will pass it along to the <code>LuceneFieldContributor</code>.</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="annotation">@Entity</span>
<span class="annotation">@Indexed</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">WebPage</span> {

    <span class="annotation">@Id</span>
    <span class="directive">private</span> <span class="predefined-type">Integer</span> id;

    <span class="annotation">@NonStandardField</span>( <i class="conum" data-value="1"></i><b>(1)</b>
            valueBinder = <span class="annotation">@ValueBinderRef</span>(type = PageRankValueBinder.class) <i class="conum" data-value="2"></i><b>(2)</b>
    )
    <span class="directive">private</span> <span class="predefined-type">Float</span> pageRank;

    <span class="comment">// Getters and setters</span>
    <span class="comment">// ...</span>

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Map the property to an index field.
Note that value bridges using a non-standard field type (such as Lucene&#8217;s "native" type)
must be mapped using the <code>@NonStandardField</code> annotation:
other annotations such as <code>@GenericField</code> will fail.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Instruct Hibernate Search to use our custom value binder.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="backend-lucene-multi-tenancy"><a class="anchor" href="#backend-lucene-multi-tenancy"></a>16.5.2. <a id="section-multi-tenancy"></a> Multi-tenancy</h4>
<div class="paragraph">
<p>Multi-tenancy is supported and handled transparently,
according to the tenant ID defined in the current session:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>documents will be indexed with the appropriate values, allowing later filtering;</p>
</li>
<li>
<p>queries will filter results appropriately.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The multi-tenancy is automatically enabled in the backend if it is enabled in the mapper,
e.g. if <a href="https://docs.jboss.org/hibernate/orm/6.4/userguide/html_single/Hibernate_User_Guide.html#multitenacy">a multi-tenancy strategy is selected in Hibernate ORM</a>,
or if <a href="#mapper-pojo-standalone-multi-tenancy">multi-tenancy is explicitly configured in the Standalone POJO mapper</a>.</p>
</div>
<div class="paragraph">
<p>However, it is possible to enable multi-tenancy manually.</p>
</div>
<div class="paragraph">
<p>The multi-tenancy strategy is set at the backend level:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>hibernate.search.backend.multi_tenancy.strategy = none</code></pre>
</div>
</div>
<div class="paragraph">
<p>See the following subsections for details about available strategies.</p>
</div>
<div class="sect4">
<h5 id="backend-lucene-multi-tenancy-none"><a class="anchor" href="#backend-lucene-multi-tenancy-none"></a><code>none</code>: single-tenancy</h5>
<div class="paragraph">
<p>The <code>none</code> strategy (the default) disables multi-tenancy completely.</p>
</div>
<div class="paragraph">
<p>Attempting to set a tenant ID will lead to a failure when indexing.</p>
</div>
</div>
<div class="sect4">
<h5 id="backend-lucene-multi-tenancy-discriminator"><a class="anchor" href="#backend-lucene-multi-tenancy-discriminator"></a><code>discriminator</code>: type name mapping using the index name</h5>
<div class="paragraph">
<p>With the <code>discriminator</code> strategy,
all documents from all tenants are stored in the same index.</p>
</div>
<div class="paragraph">
<p>When indexing, a discriminator field holding the tenant ID is populated transparently for each document.</p>
</div>
<div class="paragraph">
<p>When searching, a filter targeting the tenant ID field is added transparently to the search query
to only return search hits for the current tenant.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="backend-lucene-analysis"><a class="anchor" href="#backend-lucene-analysis"></a>16.6. Analysis</h3>
<div class="sect3">
<h4 id="backend-lucene-analysis-basics"><a class="anchor" href="#backend-lucene-analysis-basics"></a>16.6.1. Basics</h4>
<div class="paragraph">
<p><a href="#concepts-analysis">Analysis</a> is the text processing performed by analyzers,
both when indexing (document processing)
and when searching (query processing).</p>
</div>
<div class="paragraph">
<p>The Lucene backend comes with some <a href="#backend-lucene-analysis-builtin">default analyzers</a>,
but analysis can also be configured explicitly.</p>
</div>
<div class="paragraph">
<p>To configure analysis in a Lucene backend, you will need to:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Define a class that implements the <code>org.hibernate.search.backend.lucene.analysis.LuceneAnalysisConfigurer</code> interface.</p>
</li>
<li>
<p>Configure the backend to use that implementation by setting the configuration property
<code>hibernate.search.backend.analysis.configurer</code>
to a <a href="#configuration-bean-reference-parsing">bean reference</a> pointing to the implementation,
for example <code>class:com.mycompany.MyAnalysisConfigurer</code>.</p>
</li>
</ol>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
You can pass multiple bean references separated by commas. See <a href="#configuration-property-types">Type of configuration properties</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Hibernate Search will call the <code>configure</code> method of this implementation on startup,
and the configurer will be able to take advantage of a DSL to define
<a href="#backend-lucene-analysis-analyzers">analyzers and normalizers</a> or even (for more advanced use) the <a href="#backend-lucene-analysis-similarity">similarity</a>.
See below for examples.</p>
</div>
</div>
<div class="sect3">
<h4 id="backend-lucene-analysis-builtin"><a class="anchor" href="#backend-lucene-analysis-builtin"></a>16.6.2. Built-in analyzers</h4>
<div class="paragraph">
<p>Built-in analyzers are available out-of-the-box and don&#8217;t require explicit configuration.
If necessary, they can be overridden by defining your own analyzer with the same name.</p>
</div>
<div class="paragraph">
<p>The Lucene backend comes with a series of built-in analyzer;
their names are listed as constants in <code>org.hibernate.search.engine.backend.analysis.AnalyzerNames</code>:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>default</code></dt>
<dd>
<p>The analyzer used by default with <a href="#mapping-directfieldmapping-annotations-fulltextfield"><code>@FullTextField</code></a>.</p>
<div class="paragraph">
<p>Default implementation: <code>org.apache.lucene.analysis.standard.StandardAnalyzer</code>.</p>
</div>
<div class="paragraph">
<p>Default behavior: first, tokenize using the standard tokenizer, which follows Word Break rules from the
Unicode Text Segmentation algorithm, as specified in <a href="http://unicode.org/reports/tr29/">Unicode Standard Annex #29</a>.
Then, lowercase each token.</p>
</div>
</dd>
<dt class="hdlist1"><code>standard</code></dt>
<dd>
<p>Default implementation: <code>org.apache.lucene.analysis.standard.StandardAnalyzer</code>.</p>
<div class="paragraph">
<p>Default behavior: first, tokenize using the standard tokenizer, which follows Word Break rules from the
Unicode Text Segmentation algorithm, as specified in <a href="http://unicode.org/reports/tr29/">Unicode Standard Annex #29</a>.
Then, lowercase each token.</p>
</div>
</dd>
<dt class="hdlist1"><code>simple</code></dt>
<dd>
<p>Default implementation: <code>org.apache.lucene.analysis.core.SimpleAnalyzer</code>.</p>
<div class="paragraph">
<p>Default behavior: first, split the text at non-letter characters.
Then, lowercase each token.</p>
</div>
</dd>
<dt class="hdlist1"><code>whitespace</code></dt>
<dd>
<p>Default implementation: <code>org.apache.lucene.analysis.core.WhitespaceAnalyzer</code>.</p>
<div class="paragraph">
<p>Default behavior: split the text at whitespace characters.
Do not change the tokens.</p>
</div>
</dd>
<dt class="hdlist1"><code>stop</code></dt>
<dd>
<p>Default implementation: <code>org.apache.lucene.analysis.core.StopAnalyzer</code>.</p>
<div class="paragraph">
<p>Default behavior: first, split the text at non-letter characters.
Then, lowercase each token.
Finally, remove English stop words.</p>
</div>
</dd>
<dt class="hdlist1"><code>keyword</code></dt>
<dd>
<p>Default implementation: <code>org.apache.lucene.analysis.core.KeywordAnalyzer</code>.</p>
<div class="paragraph">
<p>Default behavior: do not change the text in any way.</p>
</div>
<div class="paragraph">
<p>With this analyzer a full text field would behave similarly to a keyword field,
but with fewer features: no terms aggregations, for example.</p>
</div>
<div class="paragraph">
<p>Consider using a <a href="#mapping-directfieldmapping-annotations-keywordfield"><code>@KeywordField</code></a> instead.</p>
</div>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="backend-lucene-analysis-builtin-normalizer"><a class="anchor" href="#backend-lucene-analysis-builtin-normalizer"></a>16.6.3. Built-in normalizers</h4>
<div class="paragraph">
<p>The Lucene backend does not provide any built-in normalizer.</p>
</div>
</div>
<div class="sect3">
<h4 id="backend-lucene-analysis-analyzers"><a class="anchor" href="#backend-lucene-analysis-analyzers"></a>16.6.4. Custom analyzers and normalizers</h4>
<div class="sect4">
<h5 id="backend-lucene-analysis-analyzers-component-by-factory-name"><a class="anchor" href="#backend-lucene-analysis-analyzers-component-by-factory-name"></a>Referencing components by name</h5>
<div class="paragraph">
<p>The context passed to the configurer exposes a DSL to define analyzers and normalizers:</p>
</div>
<div class="exampleblock">
<div class="title">Example 402. Implementing and using an analysis configurer to define analyzers and normalizers with the Lucene backend</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="keyword">package</span> <span class="namespace">org.hibernate.search.documentation.analysis</span>;

<span class="keyword">import</span> <span class="include">org.hibernate.search.backend.lucene.analysis.LuceneAnalysisConfigurationContext</span>;
<span class="keyword">import</span> <span class="include">org.hibernate.search.backend.lucene.analysis.LuceneAnalysisConfigurer</span>;

<span class="directive">public</span> <span class="type">class</span> <span class="class">MyLuceneAnalysisConfigurer</span> <span class="directive">implements</span> LuceneAnalysisConfigurer {
    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> configure(LuceneAnalysisConfigurationContext context) {
        context.analyzer( <span class="string"><span class="delimiter">&quot;</span><span class="content">english</span><span class="delimiter">&quot;</span></span> ).custom() <i class="conum" data-value="1"></i><b>(1)</b>
                .tokenizer( <span class="string"><span class="delimiter">&quot;</span><span class="content">standard</span><span class="delimiter">&quot;</span></span> ) <i class="conum" data-value="2"></i><b>(2)</b>
                .charFilter( <span class="string"><span class="delimiter">&quot;</span><span class="content">htmlStrip</span><span class="delimiter">&quot;</span></span> ) <i class="conum" data-value="3"></i><b>(3)</b>
                .tokenFilter( <span class="string"><span class="delimiter">&quot;</span><span class="content">lowercase</span><span class="delimiter">&quot;</span></span> ) <i class="conum" data-value="4"></i><b>(4)</b>
                .tokenFilter( <span class="string"><span class="delimiter">&quot;</span><span class="content">snowballPorter</span><span class="delimiter">&quot;</span></span> ) <i class="conum" data-value="4"></i><b>(4)</b>
                        .param( <span class="string"><span class="delimiter">&quot;</span><span class="content">language</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">English</span><span class="delimiter">&quot;</span></span> ) <i class="conum" data-value="5"></i><b>(5)</b>
                .tokenFilter( <span class="string"><span class="delimiter">&quot;</span><span class="content">asciiFolding</span><span class="delimiter">&quot;</span></span> );

        context.normalizer( <span class="string"><span class="delimiter">&quot;</span><span class="content">lowercase</span><span class="delimiter">&quot;</span></span> ).custom() <i class="conum" data-value="6"></i><b>(6)</b>
                .tokenFilter( <span class="string"><span class="delimiter">&quot;</span><span class="content">lowercase</span><span class="delimiter">&quot;</span></span> )
                .tokenFilter( <span class="string"><span class="delimiter">&quot;</span><span class="content">asciiFolding</span><span class="delimiter">&quot;</span></span> );

        context.analyzer( <span class="string"><span class="delimiter">&quot;</span><span class="content">french</span><span class="delimiter">&quot;</span></span> ).custom() <i class="conum" data-value="7"></i><b>(7)</b>
                .tokenizer( <span class="string"><span class="delimiter">&quot;</span><span class="content">standard</span><span class="delimiter">&quot;</span></span> )
                .charFilter( <span class="string"><span class="delimiter">&quot;</span><span class="content">htmlStrip</span><span class="delimiter">&quot;</span></span> )
                .tokenFilter( <span class="string"><span class="delimiter">&quot;</span><span class="content">lowercase</span><span class="delimiter">&quot;</span></span> )
                .tokenFilter( <span class="string"><span class="delimiter">&quot;</span><span class="content">snowballPorter</span><span class="delimiter">&quot;</span></span> )
                        .param( <span class="string"><span class="delimiter">&quot;</span><span class="content">language</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">French</span><span class="delimiter">&quot;</span></span> )
                .tokenFilter( <span class="string"><span class="delimiter">&quot;</span><span class="content">asciiFolding</span><span class="delimiter">&quot;</span></span> );
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Define a custom analyzer named "english", because it will be used to analyze English text such as book titles.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Set the tokenizer to a standard tokenizer: components are referenced by their name.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Set the char filters. Char filters are applied in the order they are given, before the tokenizer.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Set the token filters. Token filters are applied in the order they are given, after the tokenizer.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Set the value of a parameter for the last added char filter/tokenizer/token filter.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Normalizers are defined in a similar way, the only difference being that they cannot use a tokenizer.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Multiple analyzers/normalizers can be defined in the same configurer.</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="XML"><i class="conum" data-value="1"></i><b>(1)</b>
hibernate.search.backend.analysis.configurer = class:org.hibernate.search.documentation.analysis.MyLuceneAnalysisConfigurer</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Assign the configurer to the backend using a Hibernate Search configuration property.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>To know which character filters, tokenizers and token filters are available,
you can call <code>context.availableTokenizers()</code>, <code>context.availableTokenizers()</code>
and <code>context.availableTokenFilters()</code> on the context passed to your analysis configurer;
this will return a set of all valid names.</p>
</div>
<div class="paragraph">
<p>To know more about the behavior of these character filters, tokenizers and token filters,
either browse the <a href="https://lucene.apache.org/core/9_9_2/core/">Lucene Javadoc</a> or read the corresponding section on the
<a href="http://wiki.apache.org/solr/AnalyzersTokenizersTokenFilters">Solr Wiki</a>
(you don&#8217;t need Solr to use these analyzers,
it&#8217;s just that there is no documentation page for Lucene proper).</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>In the Lucene Javadoc, the description of each factory class includes the mention "SPI Name" followed by a string constant.
This is the name that should be passed to use that factory when defining analyzers.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="backend-lucene-analysis-analyzers-component-by-factory-class"><a class="anchor" href="#backend-lucene-analysis-analyzers-component-by-factory-class"></a>Referencing components by factory class</h5>
<div class="paragraph">
<p>Instead of names, you may also pass Lucene factory classes to refer to a particular tokenizer,
char filter or token filter implementation.
Those classes extend <code>org.apache.lucene.analysis.TokenizerFactory</code>,
<code>org.apache.lucene.analysis.TokenFilterFactory</code>
or <code>org.apache.lucene.analysis.CharFilterFactory</code>.</p>
</div>
<div class="paragraph">
<p>This avoids string constants in your code, at the cost of having a direct compile-time dependency to Lucene.</p>
</div>
<div class="exampleblock">
<div class="title">Example 403. Analysis configurer implementation using Lucene factory classes</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">context.analyzer( <span class="string"><span class="delimiter">&quot;</span><span class="content">english</span><span class="delimiter">&quot;</span></span> ).custom()
        .tokenizer( StandardTokenizerFactory.class )
        .charFilter( HTMLStripCharFilterFactory.class )
        .tokenFilter( LowerCaseFilterFactory.class )
        .tokenFilter( SnowballPorterFilterFactory.class )
                .param( <span class="string"><span class="delimiter">&quot;</span><span class="content">language</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">English</span><span class="delimiter">&quot;</span></span> )
        .tokenFilter( ASCIIFoldingFilterFactory.class );

context.normalizer( <span class="string"><span class="delimiter">&quot;</span><span class="content">lowercase</span><span class="delimiter">&quot;</span></span> ).custom()
        .tokenFilter( LowerCaseFilterFactory.class )
        .tokenFilter( ASCIIFoldingFilterFactory.class );</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>To know which character filters, tokenizers and token filters are available,
either browse the <a href="https://lucene.apache.org/core/9_9_2/core/">Lucene Javadoc</a> or read the corresponding section on the
<a href="http://wiki.apache.org/solr/AnalyzersTokenizersTokenFilters">Solr Wiki</a>
(you don&#8217;t need Solr to use these analyzers,
it&#8217;s just that there is no documentation page for Lucene proper).</p>
</div>
</div>
<div class="sect4">
<h5 id="backend-lucene-analysis-analyzers-instance"><a class="anchor" href="#backend-lucene-analysis-analyzers-instance"></a>Assigning names to analyzer instances</h5>
<div class="paragraph">
<p>It is also possible to assign a name to an analyzer instance:</p>
</div>
<div class="exampleblock">
<div class="title">Example 404. Naming an analyzer instance in the Lucene backend</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">context.analyzer( <span class="string"><span class="delimiter">&quot;</span><span class="content">my-standard</span><span class="delimiter">&quot;</span></span> ).instance( <span class="keyword">new</span> StandardAnalyzer() );</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="backend-lucene-analysis-analyzers-default"><a class="anchor" href="#backend-lucene-analysis-analyzers-default"></a>16.6.5. Overriding the default analyzer</h4>
<div class="paragraph">
<p>The default analyzer when using <a href="#mapping-directfieldmapping-annotations-fulltextfield"><code>@FullTextField</code></a>
without specifying an analyzer explicitly, is named <code>default</code>.</p>
</div>
<div class="paragraph">
<p>Like any other <a href="#backend-lucene-analysis-builtin">built-in analyzer</a>, it is possible to override the default analyzer
by defining a <a href="#backend-lucene-analysis-analyzers">custom analyzer</a> with the same name:</p>
</div>
<div class="exampleblock">
<div class="title">Example 405. Overriding the default analyzer in the Lucene backend</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="keyword">package</span> <span class="namespace">org.hibernate.search.documentation.analysis</span>;

<span class="keyword">import</span> <span class="include">org.hibernate.search.backend.lucene.analysis.LuceneAnalysisConfigurationContext</span>;
<span class="keyword">import</span> <span class="include">org.hibernate.search.backend.lucene.analysis.LuceneAnalysisConfigurer</span>;
<span class="keyword">import</span> <span class="include">org.hibernate.search.engine.backend.analysis.AnalyzerNames</span>;

<span class="directive">public</span> <span class="type">class</span> <span class="class">DefaultOverridingLuceneAnalysisConfigurer</span> <span class="directive">implements</span> LuceneAnalysisConfigurer {
    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> configure(LuceneAnalysisConfigurationContext context) {
        context.analyzer( AnalyzerNames.DEFAULT ) <i class="conum" data-value="1"></i><b>(1)</b>
                .custom() <i class="conum" data-value="2"></i><b>(2)</b>
                .tokenizer( <span class="string"><span class="delimiter">&quot;</span><span class="content">standard</span><span class="delimiter">&quot;</span></span> )
                .tokenFilter( <span class="string"><span class="delimiter">&quot;</span><span class="content">lowercase</span><span class="delimiter">&quot;</span></span> )
                .tokenFilter( <span class="string"><span class="delimiter">&quot;</span><span class="content">snowballPorter</span><span class="delimiter">&quot;</span></span> )
                        .param( <span class="string"><span class="delimiter">&quot;</span><span class="content">language</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">French</span><span class="delimiter">&quot;</span></span> )
                .tokenFilter( <span class="string"><span class="delimiter">&quot;</span><span class="content">asciiFolding</span><span class="delimiter">&quot;</span></span> );
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Start the definition of a custom analyzer that happens to be named <code>default</code>.
Here we rely on constants from <code>org.hibernate.search.engine.backend.analysis.AnalyzerNames</code> to use the correct name,
but hardcoding <code>"default"</code> would work just as well.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Continue the analyzer definition <a href="#backend-lucene-analysis-analyzers">as we would for any other custom analyzer</a>.</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="XML"><i class="conum" data-value="1"></i><b>(1)</b>
hibernate.search.backend.analysis.configurer = class:org.hibernate.search.documentation.analysis.DefaultOverridingLuceneAnalysisConfigurer</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Assign the configurer to the backend using a Hibernate Search configuration property.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="backend-lucene-analysis-similarity"><a class="anchor" href="#backend-lucene-analysis-similarity"></a>16.6.6. <a id="section-custom-similarity"></a> Similarity</h4>
<div class="paragraph">
<p>When searching, scores are assigned to documents based on statistics recorded at index time, using a specific formula.
Those statistics and the formula are defined by a single component called the similarity,
implementing Lucene&#8217;s <code>org.apache.lucene.search.similarities.Similarity</code> interface.</p>
</div>
<div class="paragraph">
<p>By default, Hibernate Search uses <code>BM25Similarity</code> with its defaults parameters (<code>k1 = 1.2</code>, <code>b = 0.75</code>).
This should provide satisfying scoring in most situations.</p>
</div>
<div class="paragraph">
<p>If you have advanced needs, you can set a custom <code>Similarity</code> in your analysis configurer, as shown below.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Remember to also reference the analysis configurer from your configuration properties,
as explained in <a href="#backend-lucene-analysis-analyzers">Custom analyzers and normalizers</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="exampleblock">
<div class="title">Example 406. Implementing an analysis configurer to change the Similarity with the Lucene backend</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="directive">public</span> <span class="type">class</span> <span class="class">CustomSimilarityLuceneAnalysisConfigurer</span> <span class="directive">implements</span> LuceneAnalysisConfigurer {
    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> configure(LuceneAnalysisConfigurationContext context) {
        context.similarity( <span class="keyword">new</span> ClassicSimilarity() ); <i class="conum" data-value="1"></i><b>(1)</b>

        context.analyzer( <span class="string"><span class="delimiter">&quot;</span><span class="content">english</span><span class="delimiter">&quot;</span></span> ).custom() <i class="conum" data-value="2"></i><b>(2)</b>
                .tokenizer( <span class="string"><span class="delimiter">&quot;</span><span class="content">standard</span><span class="delimiter">&quot;</span></span> )
                .tokenFilter( <span class="string"><span class="delimiter">&quot;</span><span class="content">lowercase</span><span class="delimiter">&quot;</span></span> )
                .tokenFilter( <span class="string"><span class="delimiter">&quot;</span><span class="content">asciiFolding</span><span class="delimiter">&quot;</span></span> );
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Set the similarity to <code>ClassicSimilarity</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Define analyzers and normalizers as usual.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>For more information about <code>Similarity</code>, its various implementations, and the pros and cons of each implementation,
see the javadoc of <code>Similarity</code> and Lucene&#8217;s source code.</p>
</div>
<div class="paragraph">
<p>You can also find useful resources on the web, for example in Elasticsearch&#8217;s documentation.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="backend-lucene-threads"><a class="anchor" href="#backend-lucene-threads"></a>16.7. Threads</h3>
<div class="paragraph">
<p>The Lucene backend relies on an internal thread pool to execute write operations on the index.</p>
</div>
<div class="paragraph">
<p>By default, the pool contains exactly as many threads as the number of processors available to the JVM on bootstrap.
That can be changed using a configuration property:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>hibernate.search.backend.thread_pool.size = 4</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This number is <em>per backend</em>, not per index.
Adding more indexes will not add more threads.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Operations happening in this thread-pool include blocking I/O,
so raising its size above the number of processor cores available to the JVM
can make sense and may improve performance.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="backend-lucene-indexing-queues"><a class="anchor" href="#backend-lucene-indexing-queues"></a>16.8. Indexing queues</h3>
<div class="paragraph">
<p>Among all the write operations performed by Hibernate Search on the indexes,
it is expected that there will be a lot of "indexing" operations to create/update/delete a specific document.
We generally want to preserve the relative order of these requests
when they are about the same documents.</p>
</div>
<div class="paragraph">
<p>For this reason, Hibernate Search pushes these operations to internal queues and applies them in batches.
Each index maintains 10 queues holding at most 1000 elements each.
Queues operate independently (in parallel), but each queue applies one operation after the other,
so at any given time there can be at most 10 batches of indexing requests being applied for each index.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Indexing operations relative to the same document ID are always pushed to the same queue.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>It is possible to customize the queues in order to reduce resource consumption,
or on the contrary to improve throughput.
This is done through the following configuration properties:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code># To configure the defaults for all indexes:
hibernate.search.backend.indexing.queue_count = 10
hibernate.search.backend.indexing.queue_size = 1000
# To configure a specific index:
hibernate.search.backend.indexes.&lt;index-name&gt;.indexing.queue_count = 10
hibernate.search.backend.indexes.&lt;index-name&gt;.indexing.queue_size = 1000</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>indexing.queue_count</code> defines the number of queues.
Expects a strictly positive integer value.
The default for this property is <code>10</code>.</p>
<div class="paragraph">
<p>Higher values will lead to more indexing operations being performed in parallel,
which may lead to higher indexing throughput if CPU power is the bottleneck when indexing.</p>
</div>
<div class="paragraph">
<p>Note that raising this number above the <a href="#backend-lucene-threads">number of threads</a> is never useful,
as the number of threads limits how many queues can be processed in parallel.</p>
</div>
</li>
<li>
<p><code>indexing.queue_size</code> defines the maximum number of elements each queue can hold.
Expects a strictly positive integer value.
The default for this property is <code>1000</code>.</p>
<div class="paragraph">
<p>Lower values may lead to lower memory usage, especially if there are many queues,
but values that are too low will increase the likeliness of
<a href="#backend-lucene-indexing-queues-blocking">application threads blocking</a>
because the queue is full,
which may lead to lower indexing throughput.</p>
</div>
</li>
</ul>
</div>
<div id="backend-lucene-indexing-queues-blocking" class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>When a queue is full, any attempt to request indexing will block until the request can be put into the queue.</p>
</div>
<div class="paragraph">
<p>In order to achieve a reasonable level of performance,
be sure to set the size of queues to a high enough number that this kind of blocking only happens
when the application is under very high load.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>When <a href="#backend-lucene-configuration-sharding">sharding</a> is enabled,
each shard will be assigned its own set of queues.</p>
</div>
<div class="paragraph">
<p>If you use the <code>hash</code> sharding strategy <strong>based on the document ID</strong> (and not based on a provided routing key),
make sure to set the number of queues to a number with no common denominator with the number of shards;
otherwise, some queues may be used much less than others.</p>
</div>
<div class="paragraph">
<p>For example, if you set the number of shards to 8 and the number of queues to 4,
documents ending up in the shard #0 will always end up in queue #0 of that shard.
That&#8217;s because both the routing to a shard and the routing to a queue take the hash of the document ID
then apply a modulo operation to that hash,
and <code>&lt;some hash&gt; % 8 == 0</code> (routed to shard #0) implies <code>&lt;some hash&gt; % 4 == 0</code> (routed to queue #0 of shard #0).
Again, this is only true if you rely on the document ID and not on a provided routing key for sharding.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="backend-lucene-io"><a class="anchor" href="#backend-lucene-io"></a>16.9. Writing and reading</h3>
<div class="sect3">
<h4 id="backend-lucene-io-commit"><a class="anchor" href="#backend-lucene-io-commit"></a>16.9.1. Commit</h4>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>For a preliminary introduction to writing to and reading from indexes in Hibernate Search,
including in particular the concepts of <em>commit</em> and <em>refresh</em>,
see <a href="#concepts-commit-refresh">Commit and refresh</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In Lucene terminology, a <em>commit</em> is when changes buffered in an index writer
are pushed to the index itself,
so that a crash or power loss will no longer result in data loss.</p>
</div>
<div class="paragraph">
<p>Some operations are critical and are always committed before they are considered complete.
This is the case for changes triggered by <a href="#listener-triggered-indexing">listener-triggered indexing</a>
(unless <a href="#indexing-plan-synchronization">configured otherwise</a>),
and also for large-scale operations such as a <a href="#indexing-workspace">purge</a>.
When such an operation is encountered, a commit will be performed immediately,
guaranteeing that the operation is only considered complete after all changes are safely stored on disk.</p>
</div>
<div class="paragraph">
<p>However, other operations, like changes contributed by the <a href="#indexing-massindexer">mass indexer</a>
or when <a href="#architecture-hsearch-indexing">indexing</a> is using the <a href="#indexing-plan-synchronization"><code>async</code> synchronization strategy</a>,
are not expected to be committed immediately.</p>
</div>
<div class="paragraph">
<p>Performance-wise, committing may be an expensive operation,
which is why Hibernate Search tries not to commit too often.
By default, when changes that do not require an immediate commit are applied to the index,
Hibernate Search will delay the commit by one second.
If other changes are applied during that second,
they will be included in the same commit.
This dramatically reduces the amount of commits in write-intensive scenarios
(e.g. <a href="#indexing-massindexer">mass indexing</a>),
leading to much better performance.</p>
</div>
<div class="paragraph">
<p>It is possible to control exactly how often Hibernate Search will commit
by setting the commit interval (in milliseconds):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code># To configure the defaults for all indexes:
hibernate.search.backend.io.commit_interval = 1000
# To configure a specific index:
hibernate.search.backend.indexes.&lt;index-name&gt;.io.commit_interval = 1000</code></pre>
</div>
</div>
<div class="paragraph">
<p>The default for this property is <code>1000</code>.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Setting the commit interval to 0 will force Hibernate Search to commit after every batch of changes,
which may result in a much lower throughput,
in particular for <a href="#architecture-hsearch-indexing">explicit or listener-triggered indexing</a>
but even more so for <a href="#indexing-massindexer">mass indexing</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Remember that individual write operations may force a commit,
which may cancel out the potential performance gains from setting a higher commit interval.</p>
</div>
<div class="paragraph">
<p>By default, the commit interval may only improve throughput
of the <a href="#indexing-massindexer">mass indexer</a>.
If you want changes triggered <a href="#architecture-hsearch-indexing">explicitly or by listeners</a>
to benefit from it too, you will need to select a non-default
<a href="#indexing-plan-synchronization">synchronization strategy</a>,
so as not to require a commit after each change.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="backend-lucene-io-refresh"><a class="anchor" href="#backend-lucene-io-refresh"></a>16.9.2. Refresh</h4>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>For a preliminary introduction to writing to and reading from indexes in Hibernate Search,
including in particular the concepts of <em>commit</em> and <em>refresh</em>,
see <a href="#concepts-commit-refresh">Commit and refresh</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In Lucene terminology, a <em>refresh</em> is when a new index reader is opened,
so that the next search queries will take into account the latest changes to the index.</p>
</div>
<div class="paragraph">
<p>Performance-wise, refreshing may be an expensive operation,
which is why Hibernate Search tries not to refresh too often.
The index reader is refreshed upon every search query,
but only if writes have occurred since the last refresh.</p>
</div>
<div class="paragraph">
<p>In write-intensive scenarios where refreshing after each write is still too frequent,
it is possible to refresh less frequently
and thus improve read throughput by setting a refresh interval in milliseconds.
When set to a value higher than 0, the index reader will no longer be refreshed upon every search query:
if, when a search query starts, the refresh occurred less than X milliseconds ago,
then the index reader will not be refreshed, even though it may be out-of-date.</p>
</div>
<div class="paragraph">
<p>The refresh interval can be set this way:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code># To configure the defaults for all indexes:
hibernate.search.backend.io.refresh_interval = 0
# To configure a specific index:
hibernate.search.backend.indexes.&lt;index-name&gt;.io.refresh_interval = 0</code></pre>
</div>
</div>
<div class="paragraph">
<p>The default for this property is <code>0</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="backend-lucene-io-writer"><a class="anchor" href="#backend-lucene-io-writer"></a>16.9.3. <a id="lucene-indexing-performance"></a> <code>IndexWriter</code> settings</h4>
<div class="paragraph">
<p>Lucene&#8217;s <code>IndexWriter</code>, used by Hibernate Search to write to indexes,
exposes several settings that can be tweaked to better fit your application,
and ultimately get better performance.</p>
</div>
<div class="paragraph">
<p>Hibernate Search exposes these settings through configuration properties prefixed with <code>io.writer.</code>,
at the index level.</p>
</div>
<div class="paragraph">
<p>Below is a list of all index writer settings.
They can all be set similarly through configuration properties;
for example, <code>io.writer.ram_buffer_size</code> can be set like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code># To configure the defaults for all indexes:
hibernate.search.backend.io.writer.ram_buffer_size = 32
# To configure a specific index:
hibernate.search.backend.indexes.&lt;index-name&gt;.io.writer.ram_buffer_size = 32</code></pre>
</div>
</div>
<table id="table-performance-parameters" class="tableblock frame-all grid-all stretch">
<caption class="title">Table 13. Configuration properties for the <code>IndexWriter</code></caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>[&#8230;&#8203;].io.writer.max_buffered_docs</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The maximum number of documents that can be buffered in-memory
before they are flushed to the Directory.</p>
</div>
<div class="paragraph">
<p>Large values mean faster indexing, but more RAM usage.</p>
</div>
<div class="paragraph">
<p>When used together with <code>ram_buffer_size</code> a flush occurs for whichever event happens first.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>[&#8230;&#8203;].io.writer.ram_buffer_size</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The maximum amount of RAM that may be used for buffering added documents and deletions
before they are flushed to the Directory.</p>
</div>
<div class="paragraph">
<p>Large values mean faster indexing, but more RAM usage.</p>
</div>
<div class="paragraph">
<p>Generally for faster indexing performance it&#8217;s best to use this setting rather than <code>max_buffered_docs</code>.</p>
</div>
<div class="paragraph">
<p>When used together with <code>max_buffered_docs</code> a flush occurs for whichever event happens first.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a id="backend-lucene-io-writer-infostream"></a><code>[&#8230;&#8203;].io.writer.infostream</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Enables low level trace information about Lucene&#8217;s internal components; <code>true</code> or <code>false</code>.</p>
</div>
<div class="paragraph">
<p>Logs will be appended to the logger
<a href="#troubleshooting-logging-lucene-infostream"><code>org.hibernate.search.backend.lucene.infostream</code></a> at the <code>TRACE</code> level.</p>
</div>
<div class="paragraph">
<p>This may cause significant performance degradation, even if the logger ignores the TRACE level,
so this should only be used for troubleshooting purposes.</p>
</div>
<div class="paragraph">
<p>Disabled by default.</p>
</div></div></td>
</tr>
</tbody>
</table>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Refer to Lucene&#8217;s documentation, in particular the javadoc and source code of <code>IndexWriterConfig</code>,
for more information about the settings and their defaults.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="backend-lucene-io-merge"><a class="anchor" href="#backend-lucene-io-merge"></a>16.9.4. <a id="search-optimize"></a> Merge settings</h4>
<div class="paragraph">
<p>A Lucene index is not stored in a single, continuous file.
Instead, each flush to the index will generate a small file containing all the documents added to the index.
This file is called a "segment".
Search can be slower on an index with too many segments,
so Lucene regularly merges small segments to create fewer, larger segments.</p>
</div>
<div class="paragraph">
<p>Lucene&#8217;s merge behavior is controlled through a <code>MergePolicy</code>.
Hibernate Search uses the <code>LogByteSizeMergePolicy</code>,
which exposes several settings that can be tweaked to better fit your application,
and ultimately get better performance.</p>
</div>
<div class="paragraph">
<p>Below is a list of all merge settings.
They can all be set similarly through configuration properties;
for example, <code>io.merge.factor</code> can be set like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code># To configure the defaults for all indexes:
hibernate.search.backend.io.merge.factor = 10
# To configure a specific index:
hibernate.search.backend.indexes.&lt;index-name&gt;.io.merge.factor = 10</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 14. Configuration properties related to merges</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>[&#8230;&#8203;].io.merge.max_docs</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The maximum number of documents that a segment can have before merging.
Segments with more than this number of documents will not be merged.</p>
</div>
<div class="paragraph">
<p>Smaller values perform better on frequently changing indexes,
larger values provide better search performance if the index does not change often.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>[&#8230;&#8203;].io.merge.factor</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The number of segments that are merged at once.</p>
</div>
<div class="paragraph">
<p>With smaller values, merging happens more often and thus uses more resources,
but the total number of segments will be lower on average, increasing read performance.
Thus, larger values (<code>&gt; 10</code>) are best for <a href="#indexing-massindexer">mass indexing</a>,
and smaller values (<code>&lt; 10</code>) are best for <a href="#architecture-hsearch-indexing">explicit or listener-triggered indexing</a>.</p>
</div>
<div class="paragraph">
<p>The value must not be lower than <code>2</code>.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>[&#8230;&#8203;].io.merge.min_size</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The minimum target size of segments, in MB, for background merges.</p>
</div>
<div class="paragraph">
<p>Segments smaller than this size are merged more aggressively.</p>
</div>
<div class="paragraph">
<p>Setting this too large might result in expensive merge operations, even tough they are less frequent.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>[&#8230;&#8203;].io.merge.max_size</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The maximum size of segments, in MB, for background merges.</p>
</div>
<div class="paragraph">
<p>Segments larger than this size are never merged in the background.</p>
</div>
<div class="paragraph">
<p>Settings this to a lower value helps reduce memory requirements and avoids some merging operations at the
cost of optimal search speed.</p>
</div>
<div class="paragraph">
<p>When <a href="#indexing-workspace-merge">forcefully merging</a> an index, this value is ignored and <code>max_forced_size</code> is used instead (see below).</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>[&#8230;&#8203;].io.merge.max_forced_size</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The maximum size of segments, in MB, for forced merges.</p>
</div>
<div class="paragraph">
<p>This is the equivalent of <code>io.merge.max_size</code> for <a href="#indexing-workspace-merge">forceful merges</a>.
You will generally want to set this to the same value as <code>max_size</code> or lower,
but setting it too low will <a href="#indexing-workspace-merge-segments">degrade search performance as documents are deleted</a>.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>[&#8230;&#8203;].io.merge.calibrate_by_deletes</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Whether the number of deleted documents in an index should be taken into account; <code>true</code> or <code>false</code>.</p>
</div>
<div class="paragraph">
<p>When enabled, Lucene will consider that a segment with 100 documents, 50 of which are deleted,
actually contains 50 documents.
When disabled, Lucene will consider that such a segment contains 100 documents.</p>
</div>
<div class="paragraph">
<p>Setting <code>calibrate_by_deletes</code> to <code>false</code> will lead to more frequent merges caused by <code>io.merge.max_docs</code>,
but will more aggressively merge segments with many deleted documents, improving search performance.</p>
</div></div></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Refer to Lucene&#8217;s documentation, in particular the javadoc and source code of <code>LogByteSizeMergePolicy</code>,
for more information about the settings and their defaults.</p>
</div>
</td>
</tr>
</table>
</div>
<div id="lucene-segment-size" class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The options <code>io.merge.max_size</code> and <code>io.merge.max_forced_size</code>
do not <strong>directly</strong> define the maximum size of all segment files.</p>
</div>
<div class="paragraph">
<p>First, consider that merging a segment is about adding it together with another existing segment to form a larger one.
<code>io.merge.max_size</code> is the maximum size of segments <strong>before</strong> merging,
so newly merged segments can be up to twice that size.</p>
</div>
<div class="paragraph">
<p>Second, merge options do not affect the size of segments initially created by the index writer, before they are merged.
This size can be limited with the setting <code>io.writer.ram_buffer_size</code>,
but Lucene relies on estimates to implement this limit;
when these estimates are off,
it is possible for newly created segments to be slightly larger than <code>io.writer.ram_buffer_size</code>.</p>
</div>
<div class="paragraph">
<p>So, for example, to be fairly confident no file grows larger than 15MB,
use something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>hibernate.search.backend.io.writer.ram_buffer_size = 10
hibernate.search.backend.io.merge.max_size = 7
hibernate.search.backend.io.merge.max_forced_size = 7</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="backend-lucene-search"><a class="anchor" href="#backend-lucene-search"></a>16.10. Searching</h3>
<div class="paragraph">
<p>Searching with the Lucene backend relies on the <a href="#search-dsl">same APIs as any other backend</a>.</p>
</div>
<div class="paragraph">
<p>This section details Lucene-specific configuration related to searching.</p>
</div>
<div class="sect3">
<h4 id="backend-lucene-search-caching"><a class="anchor" href="#backend-lucene-search-caching"></a>16.10.1. Low-level hit caching</h4>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This feature implies that application code rely on Lucene APIs directly.</p>
</div>
<div class="paragraph">
<p>An upgrade of Hibernate Search, even for a bugfix (micro) release,
may require an upgrade of Lucene,
which may lead to breaking API changes in Lucene.</p>
</div>
<div class="paragraph">
<p>If this happens, you will need to change application code to deal with the changes.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Lucene supports caching low-level hits,
i.e. caching the list of documents that match a given <code>org.apache.lucene.search.Query</code>
in a given index segment.</p>
</div>
<div class="paragraph">
<p>This cache can be useful in read-intensive scenarios,
where the same query is executed very often on the same index,
and the index is rarely written to.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This is different from Hibernate ORM caching,
which caches the content of entities or the results of <strong>database</strong> queries.
Hibernate ORM caching can also be leveraged in Hibernate Search, but through a different API:
see <a href="#search-dsl-query-cache-lookup-strategy"> Cache lookup strategy</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To configure caching in a Lucene backend, you will need to:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Define a class that implements the <code>org.hibernate.search.backend.lucene.cache.QueryCachingConfigurer</code> interface.</p>
</li>
<li>
<p>Configure the backend to use that implementation by setting the configuration property
<code>hibernate.search.backend.query.caching.configurer</code>
to a <a href="#configuration-bean-reference-parsing">bean reference</a> pointing to the implementation,
for example <code>class:com.mycompany.MyQueryCachingConfigurer</code>.</p>
</li>
</ol>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
You can pass multiple bean references separated by commas. See <a href="#configuration-property-types">Type of configuration properties</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Hibernate Search will call the <code>configure</code> method of this implementation on startup,
and the configurer will be able to take advantage of a DSL to define
the <code>org.apache.lucene.search.QueryCache</code> and the <code>org.apache.lucene.search.QueryCachingPolicy</code>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="backend-lucene-access-analyzers"><a class="anchor" href="#backend-lucene-access-analyzers"></a>16.11. Retrieving analyzers and normalizers</h3>
<div class="paragraph">
<p>Lucene analyzers and normalizers <a href="#backend-lucene-analysis">defined in Hibernate Search</a>
can be retrieved from the Lucene backend.</p>
</div>
<div class="exampleblock">
<div class="title">Example 407. Retrieving the Lucene analyzers by name from the backend</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">SearchMapping mapping = <span class="comment">/* ... */</span> <i class="conum" data-value="1"></i><b>(1)</b>
Backend backend = mapping.backend(); <i class="conum" data-value="2"></i><b>(2)</b>
LuceneBackend luceneBackend = backend.unwrap( LuceneBackend.class ); <i class="conum" data-value="3"></i><b>(3)</b>
Optional&lt;? <span class="directive">extends</span> Analyzer&gt; analyzer = luceneBackend.analyzer( <span class="string"><span class="delimiter">&quot;</span><span class="content">english</span><span class="delimiter">&quot;</span></span> ); <i class="conum" data-value="4"></i><b>(4)</b>
Optional&lt;? <span class="directive">extends</span> Analyzer&gt; normalizer = luceneBackend.normalizer( <span class="string"><span class="delimiter">&quot;</span><span class="content">isbn</span><span class="delimiter">&quot;</span></span> ); <i class="conum" data-value="5"></i><b>(5)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><a href="#entrypoints-search-mapping">Retrieve the <code>SearchMapping</code></a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Retrieve the <code>Backend</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Narrow down the backend to the <code>LuceneBackend</code> type.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Get an analyzer by name.
The method returns an <code>Optional</code>, which is empty if the analyzer does not exist.
The analyzer must have been <a href="#backend-lucene-analysis">defined in Hibernate Search</a>,
otherwise it won&#8217;t exist.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Get a normalizer by name.
The method returns an <code>Optional</code>, which is empty if the normalizer does not exist.
The normalizer must have been <a href="#backend-lucene-analysis">defined in Hibernate Search</a>,
otherwise it won&#8217;t exist.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>Alternatively, you can also retrieve the (composite) analyzers for a whole index.
These analyzers behave differently for each field,
delegating to the analyzer configured in the mapping for each field.</p>
</div>
<div class="exampleblock">
<div class="title">Example 408. Retrieving the Lucene analyzers for a whole index</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">SearchMapping mapping = <span class="comment">/* ... */</span> <i class="conum" data-value="1"></i><b>(1)</b>
IndexManager indexManager = mapping.indexManager( <span class="string"><span class="delimiter">&quot;</span><span class="content">Book</span><span class="delimiter">&quot;</span></span> ); <i class="conum" data-value="2"></i><b>(2)</b>
LuceneIndexManager luceneIndexManager = indexManager.unwrap( LuceneIndexManager.class ); <i class="conum" data-value="3"></i><b>(3)</b>
Analyzer indexingAnalyzer = luceneIndexManager.indexingAnalyzer(); <i class="conum" data-value="4"></i><b>(4)</b>
Analyzer searchAnalyzer = luceneIndexManager.searchAnalyzer(); <i class="conum" data-value="5"></i><b>(5)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><a href="#entrypoints-search-mapping">Retrieve the <code>SearchMapping</code></a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Retrieve the <code>IndexManager</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Narrow down the index manager to the <code>LuceneIndexManager</code> type.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Get the indexing analyzer.
This is the analyzer used when indexing documents.
It ignores the <a href="#mapping-directfieldmapping-search-analyzer">search analyzer</a> in particular.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Get the search analyzer.
This is the analyzer used when building search queries through the <a href="#search-dsl">Search DSL</a>.
On contrary to the indexing analyzer, it takes into account the <a href="#mapping-directfieldmapping-search-analyzer">search analyzer</a>.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="backend-lucene-access-size"><a class="anchor" href="#backend-lucene-access-size"></a>16.12. Retrieving the index size</h3>
<div class="paragraph">
<p>The size of a Lucene index can be retrieved from the <code>LuceneIndexManager</code>.</p>
</div>
<div class="exampleblock">
<div class="title">Example 409. Retrieving the index size from a Lucene index manager</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">SearchMapping mapping = <span class="comment">/* ... */</span> <i class="conum" data-value="1"></i><b>(1)</b>
IndexManager indexManager = mapping.indexManager( <span class="string"><span class="delimiter">&quot;</span><span class="content">Book</span><span class="delimiter">&quot;</span></span> ); <i class="conum" data-value="2"></i><b>(2)</b>
LuceneIndexManager luceneIndexManager = indexManager.unwrap( LuceneIndexManager.class ); <i class="conum" data-value="3"></i><b>(3)</b>
<span class="type">long</span> size = luceneIndexManager.computeSizeInBytes(); <i class="conum" data-value="4"></i><b>(4)</b>
luceneIndexManager.computeSizeInBytesAsync() <i class="conum" data-value="5"></i><b>(5)</b>
        .thenAccept( sizeInBytes -&gt; {
            <span class="comment">// ...</span>
        } );</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><a href="#entrypoints-search-mapping">Retrieve the <code>SearchMapping</code></a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Retrieve the <code>IndexManager</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Narrow down the index manager to the <code>LuceneIndexManager</code> type.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Compute the index size and get the result.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>An asynchronous version of the method is also available.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="backend-lucene-access-index-reader"><a class="anchor" href="#backend-lucene-access-index-reader"></a>16.13. <a id="_retrieving_a_lucene_indexreader"></a> Retrieving a Lucene <code>IndexReader</code></h3>
<div class="paragraph">
<p>The low-level <code>IndexReader</code> can be retrieved from the <code>LuceneIndexScope</code>.</p>
</div>
<div class="exampleblock">
<div class="title">Example 410. Retrieving the index reader from a Lucene index scope</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">SearchMapping mapping = <span class="comment">/* ... */</span> <i class="conum" data-value="1"></i><b>(1)</b>
LuceneIndexScope indexScope = mapping
        .scope( <span class="predefined-type">Book</span>.class ).extension( LuceneExtension.get() ); <i class="conum" data-value="2"></i><b>(2)</b>
<span class="keyword">try</span> ( IndexReader indexReader = indexScope.openIndexReader() ) { <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="comment">// work with the low-level index reader:</span>
    numDocs = indexReader.numDocs();
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><a href="#entrypoints-search-mapping">Retrieve the <code>SearchMapping</code></a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Retrieve the <code>LuceneIndexScope</code> extending the search scope with the <code>LuceneExtension</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Open an instance of <code>IndexReader</code>. Optionally it is possible to provide the routing keys
to target only some shards of the indexes using the method <code>openIndexReader(Set&lt;String&gt;)</code>.
The IndexReader <strong>must be closed</strong> after use.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Even if multi-tenancy is enabled, the returned reader exposes documents of <strong>all</strong> tenants.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="backend-elasticsearch"><a class="anchor" href="#backend-elasticsearch"></a>17. <a id="elasticsearch-integration"></a> Elasticsearch backend</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="backend-elasticsearch-compatibility"><a class="anchor" href="#backend-elasticsearch-compatibility"></a>17.1. Compatibility</h3>
<div class="sect3">
<h4 id="backend-elasticsearch-compatibility-overview"><a class="anchor" href="#backend-elasticsearch-compatibility-overview"></a>17.1.1. Overview</h4>
<div class="paragraph">
<p>Hibernate Search&#8217;s Elasticsearch backend is compatible with multiple distributions of Elasticsearch:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#backend-elasticsearch-compatibility-elasticsearch">Elasticsearch clusters running version 7.10+ or 8.x</a>,</p>
</li>
<li>
<p><a href="#backend-elasticsearch-compatibility-opensearch">OpenSearch clusters running version 1.3 or 2.x</a></p>
</li>
<li>
<p><a href="#backend-elasticsearch-compatibility-amazon-opensearch-service">Amazon OpenSearch Service clusters running version 1.3 or 2.x</a>
(requires extra configuration)</p>
</li>
<li>
<p><a href="#backend-elasticsearch-compatibility-amazon-opensearch-serverless">Amazon OpenSearch Serverless clusters</a>
(incubating, requires extra configuration)</p>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>For information about which versions of Hibernate Search
are compatible with a given version of Elasticsearch/OpenSearch,
refer to the <a href="https://hibernate.org/search/releases/#compatibility-matrix">compatibility matrix</a>.</p>
</div>
<div class="paragraph">
<p>For information about which future versions of Hibernate Search you can expect
to retain compatibility with currently compatible versions of Elasticsearch/OpenSearch,
refer to the <a href="https://hibernate.org/community/compatibility-policy/#compatibility-third-party-hsearch-elasticsearch">compatibility policy</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Where possible, the distribution and version running on your cluster will be automatically detected on startup,
and Hibernate Search will adapt based on that.</p>
</div>
<div class="paragraph">
<p>With <a href="#backend-elasticsearch-compatibility-amazon-opensearch-serverless">Amazon OpenSearch Serverless</a>,
or when your cluster is not available on startup,
you will have to configure the version Hibernate Search should expect explicitly:
see <a href="#backend-elasticsearch-configuration-version"> Version compatibility</a> for details.</p>
</div>
<div class="paragraph">
<p>The targeted version is mostly transparent to Hibernate Search users,
but there are a few differences in how Hibernate Search behaves depending
on the Elasticsearch distribution and version that may affect you.
The following sections detail those differences.</p>
</div>
</div>
<div class="sect3">
<h4 id="backend-elasticsearch-compatibility-elasticsearch"><a class="anchor" href="#backend-elasticsearch-compatibility-elasticsearch"></a>17.1.2. Elasticsearch</h4>
<div class="paragraph">
<p>Hibernate Search&#8217;s Elasticsearch backend is compatible with
<a href="https://www.elastic.co/elasticsearch">Elasticsearch</a> clusters running version 7.10+ or 8.x
and regularly tested against versions 7.10, 7.17 or 8.13.</p>
</div>
<div class="paragraph">
<p>Using Elasticsearch currently doesn&#8217;t require specific configuration
and doesn&#8217;t imply specific limitations.</p>
</div>
</div>
<div class="sect3">
<h4 id="backend-elasticsearch-compatibility-opensearch"><a class="anchor" href="#backend-elasticsearch-compatibility-opensearch"></a>17.1.3. OpenSearch</h4>
<div class="paragraph">
<p>Hibernate Search&#8217;s Elasticsearch backend is compatible with
<a href="https://www.opensearch.org">OpenSearch</a> clusters running version 1.3 or 2.x
and regularly tested against versions 1.3 or 2.13.</p>
</div>
<div class="paragraph">
<p>Using OpenSearch currently doesn&#8217;t require specific configuration
There are some limitations applied by Hibernate Search when it comes to using a <a href="#search-dsl-predicate-knn">knn predicate</a> with OpenSearch.
These limitations come from OpenSearch&#8217;s feature availability,
see <a href="#mapping-directfieldmapping-vectorSimilarity">this section of the documentation</a> for more details.</p>
</div>
</div>
<div class="sect3">
<h4 id="backend-elasticsearch-compatibility-amazon-opensearch-service"><a class="anchor" href="#backend-elasticsearch-compatibility-amazon-opensearch-service"></a>17.1.4. Amazon OpenSearch Service</h4>
<div class="paragraph">
<p>Hibernate Search&#8217;s Elasticsearch backend is compatible with <a href="https://docs.aws.amazon.com/opensearch-service/latest/developerguide">Amazon OpenSearch Service</a>
and regularly tested against key versions.</p>
</div>
<div class="paragraph">
<p>Using Amazon OpenSearch Service
requires <a href="#backend-elasticsearch-configuration-aws">proprietary authentication</a> that involves extra configuration.</p>
</div>
<div class="paragraph">
<p>Using Amazon OpenSearch Service implies a single limitations:
when running Elasticsearch (not OpenSearch) and only in version 7.1 or older,
<a href="https://docs.aws.amazon.com/opensearch-service/latest/developerguide/supported-operations.html#version_7_1">closing indexes is not possible</a>,
and as a result <a href="#mapper-orm-schema-management-manager-create-or-update">automatic schema updates</a>
(<a href="#schema-management-concepts-update-failure">not recommended in production</a>)
<a href="#schema-management-concepts-index-closing">will fail when trying to update analyzer definitions</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="backend-elasticsearch-compatibility-amazon-opensearch-serverless"><a class="anchor" href="#backend-elasticsearch-compatibility-amazon-opensearch-serverless"></a>17.1.5. Amazon OpenSearch Serverless (incubating)</h4>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Features detailed below are <em>incubating</em>: they are still under active development.</p>
</div>
<div class="paragraph">
<p>The usual <a href="https://hibernate.org/community/compatibility-policy/">compatibility policy</a> does not apply:
the contract of incubating elements (e.g. types, methods, configuration properties, etc.)
may be altered in a backward-incompatible way&#8201;&#8212;&#8201;or even removed&#8201;&#8212;&#8201;in subsequent releases.</p>
</div>
<div class="paragraph">
<p>You are encouraged to use incubating features so the development team can get feedback and improve them,
but you should be prepared to update code which relies on them as needed.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><a href="https://docs.aws.amazon.com/opensearch-service/latest/developerguide/serverless-overview.html">Amazon OpenSearch Serverless</a> compatibility is implemented and incubating;
feel free to provide feedback on <a href="https://hibernate.atlassian.net/browse/HSEARCH-4867">HSEARCH-4867</a>.</p>
</div>
<div class="paragraph">
<p>However, be aware that:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Hibernate Search does not currently get tested against Amazon OpenSearch Serverless;
see <a href="https://hibernate.atlassian.net/browse/HSEARCH-4919">HSEARCH-4919</a>.</p>
</li>
<li>
<p>Connecting to an Amazon OpenSearch Serverless cluster
requires <a href="#backend-elasticsearch-configuration-aws">proprietary authentication</a> that involves extra configuration.</p>
</li>
<li>
<p>Compatibility with Amazon OpenSearch Serverless must be enabled
explicitly by <a href="#backend-elasticsearch-configuration-version-check">setting <code>hibernate.search.backend.version</code> to <code>amazon-opensearch-serverless</code></a>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Also, <a href="https://docs.aws.amazon.com/opensearch-service/latest/developerguide/serverless-overview.html">Amazon OpenSearch Serverless</a> has its own, specific limitations:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://docs.aws.amazon.com/opensearch-service/latest/developerguide/serverless-genref.html#serverless-operations">Closing indexes is not possible</a>,
and as a result <a href="#mapper-orm-schema-management-manager-create-or-update">automatic schema updates</a>
(<a href="#schema-management-concepts-update-failure">not recommended in production</a>)
<a href="#schema-management-concepts-index-closing">will fail when trying to update analyzer definitions</a>.</p>
</li>
<li>
<p><a href="#backend-elasticsearch-configuration-version-check">Distribution/version detection on startup</a>
is not possible, so it is disabled by default and cannot be enabled explicitly.</p>
</li>
<li>
<p><a href="#backend-elasticsearch-index-lifecycle">Minimal index status requirement</a> for schema management
is not possible, so it is disabled by default and cannot be enabled explicitly.</p>
</li>
<li>
<p><a href="#indexing-workspace-purge">Purging</a>, <a href="#indexing-workspace-flush">flushing</a>, <a href="#indexing-workspace-refresh">refreshing</a>, or <a href="#indexing-workspace-merge-segments">merging segments</a>
<a href="https://docs.aws.amazon.com/opensearch-service/latest/developerguide/serverless-genref.html#serverless-operations">is not possible</a>,
so attempts to <a href="#indexing-workspace">perform these operations explicitly</a> will always fail.</p>
</li>
<li>
<p>The <a href="#indexing-massindexer">mass indexer</a> will fail if you attempt a purge on start (the default),
because Amazon OpenSearch Serverless <a href="https://docs.aws.amazon.com/opensearch-service/latest/developerguide/serverless-genref.html#serverless-operations">doesnt support it</a>.
Use <a href="#indexing-massindexer-parameters-drop-and-create-schema"><code>.dropAndCreateSchemaOnStart(&#8230;&#8203;)</code></a>
to drop the indexes on start instead.
See <a href="https://hibernate.atlassian.net/browse/HSEARCH-4930">HSEARCH-4930</a>.</p>
</li>
<li>
<p>The <a href="#indexing-massindexer">mass indexer</a> will skip the flush, refresh and merge-segments operations by default,
and attempting to enable them explicitly will result in failures,
because Amazon OpenSearch Serverless <a href="https://docs.aws.amazon.com/opensearch-service/latest/developerguide/serverless-genref.html#serverless-operations">doesnt support them</a>.</p>
</li>
<li>
<p>The <a href="#mapper-orm-indexing-jakarta-batch">Jakarta Batch integration</a> is not currently supported.
See <a href="https://hibernate.atlassian.net/browse/HSEARCH-4929">HSEARCH-4929</a>,
<a href="https://hibernate.atlassian.net/browse/HSEARCH-4930">HSEARCH-4930</a>.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="backend-elasticsearch-upgrading"><a class="anchor" href="#backend-elasticsearch-upgrading"></a>17.1.6. <a id="_upgrading_elasticsearch"></a> Upgrading Elasticsearch</h4>
<div class="paragraph">
<p>When upgrading your Elasticsearch cluster, some
<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/setup-upgrade.html">administrative tasks</a>
are still required on your cluster: Hibernate Search will not take care of those.</p>
</div>
<div class="paragraph">
<p>On top of that, there might be some fundamental differences between some versions of Elasticsearch.
Please refer to the Elasticsearch documentation and migration guides to identify any incompatible schema changes.</p>
</div>
<div class="paragraph">
<p>In such cases, the easiest way to upgrade is to delete your indexes manually,
make Hibernate Search re-create the indexes along with their schema,
and <a href="#indexing-massindexer">reindex your data</a>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="backend-elasticsearch-configuration"><a class="anchor" href="#backend-elasticsearch-configuration"></a>17.2. <a id="elasticsearch-integration-configuration"></a> Basic configuration</h3>
<div class="paragraph">
<p>All configuration properties of the Elasticsearch backend are optional,
but the defaults might not suit everyone.
In particular your production Elasticsearch cluster is probably not reachable at <code><a href="http://localhost:9200" class="bare">http://localhost:9200</a></code>,
so you will need to set the address of your cluster by <a href="#backend-elasticsearch-configuration-client">configuring the client</a>.</p>
</div>
<div class="paragraph">
<p>Configuration properties are mentioned in the relevant parts of this documentation.
You can find a full reference of available properties in
<a href="#configuration-properties-aggregated-hibernate-search-backend-elasticsearch">the Elasticsearch backend configuration properties appendix</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="backend-elasticsearch-configuration-elasticsearch-cluster"><a class="anchor" href="#backend-elasticsearch-configuration-elasticsearch-cluster"></a>17.3. <a id="elasticsearch-integration-server-configuration"></a> Configuration of the Elasticsearch cluster</h3>
<div class="paragraph">
<p>Most of the time, Hibernate Search does not require any specific configuration
to be applied by hand to the Elasticsearch cluster,
beyond the index mapping (schema)
which <a href="#schema-management">can be automatically generated</a>.</p>
</div>
<div class="paragraph">
<p>The only exception is <a href="#backend-elasticsearch-configuration-sharding">Sharding</a>,
which needs to be enabled explicitly.</p>
</div>
</div>
<div class="sect2">
<h3 id="backend-elasticsearch-configuration-client"><a class="anchor" href="#backend-elasticsearch-configuration-client"></a>17.4. Client configuration</h3>
<div class="paragraph">
<p>An Elasticsearch backend communicates with an Elasticsearch cluster through a REST client.
Below are the options that affect this client.</p>
</div>
<div class="sect3">
<h4 id="backend-elasticsearch-configuration-hosts"><a class="anchor" href="#backend-elasticsearch-configuration-hosts"></a>17.4.1. Target hosts</h4>
<div class="paragraph">
<p>The following property configures the Elasticsearch host (or hosts)
to send indexing requests and search queries to:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>hibernate.search.backend.hosts = localhost:9200</code></pre>
</div>
</div>
<div class="paragraph">
<p>The default for this property is <code>localhost:9200</code>.</p>
</div>
<div class="paragraph">
<p>This property may be set to a String representing a host and port such as <code>localhost</code> or <code>es.mycompany.com:4400</code>,
or a String containing multiple such host-and-port strings separated by commas,
or a <code>Collection&lt;String&gt;</code> containing such host-and-port strings.</p>
</div>
<div class="paragraph">
<p>You may change the protocol used to communicate with the hosts using this configuration property:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>hibernate.search.backend.protocol = http</code></pre>
</div>
</div>
<div class="paragraph">
<p>The default for this property is <code>http</code>.</p>
</div>
<div class="paragraph">
<p>This property may be set to either <code>http</code> or <code>https</code>.</p>
</div>
<div class="paragraph">
<p>Alternatively, it is possible to define both the protocol and hosts as one or more URIs using a single property:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>hibernate.search.backend.uris = http://localhost:9200</code></pre>
</div>
</div>
<div class="paragraph">
<p>This property may be set to a String representing a URI such as <code><a href="http://localhost" class="bare">http://localhost</a></code> or <code><a href="https://es.mycompany.com:4400" class="bare">https://es.mycompany.com:4400</a></code>,
or a String containing multiple such URI strings separated by commas,
or a <code>Collection&lt;String&gt;</code> containing such URI strings.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>There are some constraints regarding the use of this property:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>All the uris must have the same protocol.</p>
</li>
<li>
<p>Cannot be used if <code>hosts</code> or <code>protocol</code> are set.</p>
</li>
<li>
<p>The provided list of URIs must not be empty.</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="backend-elasticsearch-configuration-path-prefix"><a class="anchor" href="#backend-elasticsearch-configuration-path-prefix"></a>17.4.2. Path prefix</h4>
<div class="paragraph">
<p>By default, the REST API is expected to be available to the root path (<code>/</code>).
For example a search query target all indexes will be sent to path <code>/_search</code>.
This is what you need for a standard Elasticsearch setup.</p>
</div>
<div class="paragraph">
<p>If your setup is non-standard, for example because of a non-transparent proxy
between the application and the Elasticsearch cluster,
you can use a configuration similar to this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>hibernate.search.backend.path_prefix = my/path</code></pre>
</div>
</div>
<div class="paragraph">
<p>With the above, a search query targeting all indexes will be sent to path <code>/my/path/_search</code> instead of <code>/_search</code>.
The path will be prefixed similarly for all requests sent to Elasticsearch.</p>
</div>
</div>
<div class="sect3">
<h4 id="backend-elasticsearch-configuration-discovery"><a class="anchor" href="#backend-elasticsearch-configuration-discovery"></a>17.4.3. Node discovery</h4>
<div class="paragraph">
<p>When using automatic discovery, the Elasticsearch client will periodically probe for new nodes in the cluster,
and will add those to the host list (see <code>hosts</code> in <a href="#backend-elasticsearch-configuration-client">Client configuration</a>).</p>
</div>
<div class="paragraph">
<p>Automatic discovery is controlled by the following properties:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>hibernate.search.backend.discovery.enabled = false
hibernate.search.backend.discovery.refresh_interval = 10</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>discovery.enabled</code> defines whether the feature is enabled.
Expects a boolean value. The default for this property is <code>false</code>.</p>
</li>
<li>
<p><code>discovery.refresh_interval</code> defines the interval between two executions of the automatic discovery.
Expects a positive integer, in seconds. The default for this property is <code>10</code>.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="backend-elasticsearch-authentication-http"><a class="anchor" href="#backend-elasticsearch-authentication-http"></a>17.4.4. HTTP authentication</h4>
<div class="paragraph">
<p>HTTP authentication is disabled by default,
but may be enabled by setting the following configuration properties:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>hibernate.search.backend.username = ironman
hibernate.search.backend.password = j@rv1s</code></pre>
</div>
</div>
<div class="paragraph">
<p>The default for these properties is an empty string.</p>
</div>
<div class="paragraph">
<p>The username and password to send when connecting to the Elasticsearch servers.</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you use HTTP instead of HTTPS (see above),
your password will be transmitted in clear text over the network.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="backend-elasticsearch-configuration-aws"><a class="anchor" href="#backend-elasticsearch-configuration-aws"></a>17.4.5. <a id="elasticsearch-integration-configuration-aws"></a> Authentication on Amazon Web Services</h4>
<div class="paragraph">
<p>The Hibernate Search Elasticsearch backend, once configured, will work just fine in most setups.
However, if you need to use
<a href="#backend-elasticsearch-compatibility-amazon-opensearch-service">Amazon OpenSearch Service</a>
or <a href="#backend-elasticsearch-compatibility-amazon-opensearch-serverless">Amazon OpenSearch Serverless</a>,
you will find they require a proprietary authentication method:
<a href="https://docs.aws.amazon.com/opensearch-service/latest/developerguide/request-signing.html">request signing</a>.</p>
</div>
<div class="paragraph">
<p>While request signing is not supported by default,
you can enable it with an additional dependency and a bit of configuration.</p>
</div>
<div class="paragraph">
<p>You will need to add this dependency:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="XML"><span class="tag">&lt;dependency&gt;</span>
   <span class="tag">&lt;groupId&gt;</span>org.hibernate.search<span class="tag">&lt;/groupId&gt;</span>
   <span class="tag">&lt;artifactId&gt;</span>hibernate-search-backend-elasticsearch-aws<span class="tag">&lt;/artifactId&gt;</span>
   <span class="tag">&lt;version&gt;</span>7.1.2.Final<span class="tag">&lt;/version&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>With that dependency in your classpath, you will still need to configure it.</p>
</div>
<div class="paragraph">
<p>The following configuration is mandatory:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>hibernate.search.backend.aws.signing.enabled = true
hibernate.search.backend.aws.region = us-east-1</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>aws.signing.enabled</code> defines whether request signing is enabled.
Expects a boolean value. Defaults to <code>false</code>.</p>
</li>
<li>
<p><code>aws.region</code> defines the <a href="http://docs.aws.amazon.com/general/latest/gr/rande.html">AWS region</a>.
Expects a string value.
This property has no default and must be provided for the AWS authentication to work.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>By default, Hibernate Search will rely on the default credentials provider from the AWS SDK.
This provider will look for credentials in various places
(Java system properties, environment variables, AWS-specific configuration, &#8230;&#8203;).
For more information about how the default credentials provider works,
see
<a href="https://docs.aws.amazon.com/sdk-for-java/latest/developer-guide/credentials.html#credentials-default">its official documentation</a>.</p>
</div>
<div class="paragraph">
<p>Optionally, you can set static credentials with the following options:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>hibernate.search.backend.aws.credentials.type = static
hibernate.search.backend.aws.credentials.access_key_id = AKIDEXAMPLE
hibernate.search.backend.aws.credentials.secret_access_key = wJalrXUtnFEMI/K7MDENG+bPxRfiCYEXAMPLEKEY</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>aws.credentials.type</code> defines the type of credentials.
Set to <code>default</code> to get the default behavior (as explained above),
or to <code>static</code> to provide credentials using the properties below.</p>
</li>
<li>
<p><code>aws.credentials.access_key_id</code> defines the
<a href="http://docs.aws.amazon.com/general/latest/gr/aws-security-credentials.html">access key ID</a>.
Expects a string value.
This property has no default and must be provided when the credentials type is set to <code>static</code>.</p>
</li>
<li>
<p><code>aws.credentials.secret_access_key</code> defines the
<a href="http://docs.aws.amazon.com/general/latest/gr/aws-security-credentials.html">secret access key</a>.
Expects a string value.
This property has no default and must be provided when the credentials type is set to <code>static</code>.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="backend-elasticsearch-configuration-connection-tuning"><a class="anchor" href="#backend-elasticsearch-configuration-connection-tuning"></a>17.4.6. <a id="_connection_tuning"></a> Connection tuning</h4>
<div class="dlist">
<dl>
<dt class="hdlist1">Timeouts</dt>
<dd>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code># hibernate.search.backend.request_timeout = 30000
hibernate.search.backend.connection_timeout = 1000
hibernate.search.backend.read_timeout = 30000</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>request_timeout</code> defines the timeout when executing a request.
This includes the time needed to establish a connection,
send the request and read the response.
This property is not defined by default.</p>
</li>
<li>
<p><code>connection_timeout</code> defines the timeout when establishing a connection.
The default for this property is <code>1000</code>.</p>
</li>
<li>
<p><code>read_timeout</code> defines the timeout when reading a response.
The default for this property is <code>30000</code>.</p>
<div class="paragraph">
<p>These properties expect a positive <a href="#configuration-property-types">Integer value</a> in milliseconds, such as <code>3000</code>.</p>
</div>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Connection pool</dt>
<dd>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>hibernate.search.backend.max_connections = 20
hibernate.search.backend.max_connections_per_route = 10</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>max_connections</code> defines maximum number of simultaneous connections
to the Elasticsearch cluster, all hosts taken together.
The default for this property is <code>20</code>.</p>
</li>
<li>
<p><code>max_connections_per_route</code> defines maximum number of simultaneous connections
to each host of the Elasticsearch cluster.
The default for this property is <code>10</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>These properties expect a positive <a href="#configuration-property-types">Integer value</a>, such as <code>20</code>.</p>
</div>
</dd>
<dt class="hdlist1">Keep Alive</dt>
<dd>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>hibernate.search.backend.max_keep_alive = 10000</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>max_keep_alive</code> defines how long connections to the Elasticsearch cluster can be kept idle.</p>
<div class="paragraph">
<p>Expects a positive <a href="#configuration-property-types">Long value</a> in milliseconds, such as <code>60000</code>.</p>
</div>
<div class="paragraph">
<p>If the response from an Elasticsearch cluster contains a <code>Keep-Alive</code> header,
then the effective max idle time will be whichever is lower:
the duration from the <code>Keep-Alive</code> header or the value of this property (if set).</p>
</div>
<div class="paragraph">
<p>If this property is not set, only the <code>Keep-Alive</code> header is considered,
and if it&#8217;s absent, idle connections will be kept forever.</p>
</div>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="backend-elasticsearch-configuration-http-client"><a class="anchor" href="#backend-elasticsearch-configuration-http-client"></a>17.4.7. <a id="_custom_http_client_configurations"></a> Custom HTTP client configurations</h4>
<div class="paragraph">
<p>It is possible to configure the HTTP client directly
using an instance of <code>org.apache.http.impl.nio.client.HttpAsyncClientBuilder</code>.</p>
</div>
<div class="paragraph">
<p>With this API you can add interceptors, change the keep alive, the max connections,
the SSL key/trust store settings and many other client configurations.</p>
</div>
<div class="paragraph">
<p>Configure the HTTP client directly requires two steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Define a class that implements the <code>org.hibernate.search.backend.elasticsearch.client.ElasticsearchHttpClientConfigurer</code> interface.</p>
</li>
<li>
<p>Configure Hibernate Search to use that implementation by setting the configuration property
<code>hibernate.search.backend.client.configurer</code>
to a <a href="#configuration-bean-reference-parsing">bean reference</a> pointing to the implementation,
for example <code>class:org.hibernate.search.documentation.backend.elasticsearch.client.HttpClientConfigurer</code>.</p>
</li>
</ol>
</div>
<div class="exampleblock">
<div class="title">Example 411. Implementing and using a <code>ElasticsearchHttpClientConfigurer</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="directive">public</span> <span class="type">class</span> <span class="class">HttpClientConfigurer</span> <span class="directive">implements</span> ElasticsearchHttpClientConfigurer { <i class="conum" data-value="1"></i><b>(1)</b>

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> configure(ElasticsearchHttpClientConfigurationContext context) { <i class="conum" data-value="2"></i><b>(2)</b>
        HttpAsyncClientBuilder clientBuilder = context.clientBuilder(); <i class="conum" data-value="3"></i><b>(3)</b>
        clientBuilder.setMaxConnPerRoute( <span class="integer">7</span> ); <i class="conum" data-value="4"></i><b>(4)</b>
        clientBuilder.addInterceptorFirst( (HttpResponseInterceptor) (request, httpContext) -&gt; {
            <span class="type">long</span> contentLength = request.getEntity().getContentLength();
            <span class="comment">// doing some stuff with contentLength</span>
        } );
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The class has to implement the <code>ElasticsearchHttpClientConfigurer</code> interface.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The <code>configure</code> method provides the access to the <code>ElasticsearchHttpClientConfigurationContext</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>From the context it is possible to get the <code>HttpAsyncClientBuilder</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Finally, you can use the builder to configure the client with your custom settings.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 412. Define a custom http client configurer in the properties</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="XML"><i class="conum" data-value="1"></i><b>(1)</b>
hibernate.search.backend.client.configurer = class:org.hibernate.search.documentation.backend.elasticsearch.client.HttpClientConfigurer</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Specify the HTTP client configurer.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Any setting defined by a custom http client configurer will override any other setting defined by Hibernate Search.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="backend-elasticsearch-configuration-version"><a class="anchor" href="#backend-elasticsearch-configuration-version"></a>17.5. <a id="backend-elasticsearch-configuration-dialect"></a> Version compatibility</h3>
<div class="sect3">
<h4 id="backend-elasticsearch-configuration-version-check"><a class="anchor" href="#backend-elasticsearch-configuration-version-check"></a>17.5.1. Version assumed by Hibernate Search</h4>
<div class="paragraph">
<p>Different distributions and versions of Elasticsearch/OpenSearch expose slightly different APIs.
As a result, Hibernate Search needs to be aware of the distribution and version it is talking to
in order to generate correct HTTP requests.</p>
</div>
<div class="paragraph">
<p>By default, Hibernate Search will query the Elasticsearch/OpenSearch cluster at boot time to retrieve this information,
and will infer the correct behavior to adopt.</p>
</div>
<div class="paragraph">
<p>You can force Hibernate Search to expect a specific version of Elasticsearch/OpenSearch by
setting the property <code>hibernate.search.backend.version</code> to a version string
following the format <code>x.y.z-qualifier</code> or <code>&lt;distribution&gt;:x.y.z-qualifier</code>
or just <code>&lt;distribution&gt;</code>, where:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>&lt;distribution&gt;</code> is either <code>elastic</code>, <code>opensearch</code> or <code>amazon-opensearch-serverless</code>. Optional, defaults to <code>elastic</code>.</p>
</li>
<li>
<p><code>x</code>, <code>y</code> and <code>z</code> are integers. <code>x</code> is mandatory, <code>y</code> and <code>z</code> are optional.</p>
</li>
<li>
<p><code>qualifier</code> is a string of word characters (alphanumeric or <code>_</code>). Optional.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For example, <code>8</code>, <code>8.0</code>, <code>8.9</code>, <code>opensearch:2.9</code>, <code>amazon-opensearch-service</code>
are all valid version strings.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p><a href="#backend-elasticsearch-compatibility-amazon-opensearch-serverless">Amazon OpenSearch Serverless</a>
is a special case as it doesn&#8217;t use version numbers.</p>
</div>
<div class="paragraph">
<p>When using that platform, you <strong>must</strong> set the version
and it must be set to simply <code>amazon-opensearch-serverless</code>,
without a trailing <code>:</code> or version number.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Hibernate Search will still query the Elasticsearch/OpenSearch cluster
to detect the actual distribution and version of the cluster
(except where not supported, i.e. <a href="#backend-elasticsearch-compatibility-amazon-opensearch-serverless">Amazon OpenSearch Serverless</a>),
in order to check that the configured distribution and version match the actual ones.</p>
</div>
</div>
<div class="sect3">
<h4 id="backend-elasticsearch-configuration-version-check-disabling"><a class="anchor" href="#backend-elasticsearch-configuration-version-check-disabling"></a>17.5.2. Disabling the version check on startup</h4>
<div class="paragraph">
<p>If necessary, you can disable the call to the Elasticsearch/OpenSearch cluster on startup,
and provide the information manually.</p>
</div>
<div class="paragraph">
<p>To do that, set the property <code>hibernate.search.backend.version_check.enabled</code> to <code>false</code>.</p>
</div>
<div class="paragraph">
<p>You will also have to set the property <code>hibernate.search.backend.version</code> to a version string
as explained in the <a href="#backend-elasticsearch-configuration-version-check">previous section</a>.</p>
</div>
<div class="paragraph">
<p>In this case, both major <strong>and minor</strong> version numbers (<code>x</code> <strong>and <code>y</code></strong> in the formats above)
are mandatory,
but the <code>distribution</code> can be left out if it is the default (<code>elasticsearch</code>),
and all other components (micro, qualifier) remain optional.
For example, <code>8.0</code>, <code>8.9</code>, <code>opensearch:2.9</code> are all valid version strings in this case,
but <code>8</code> is not precise enough.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="backend-elasticsearch-configuration-logging"><a class="anchor" href="#backend-elasticsearch-configuration-logging"></a>17.6. <a id="elasticsearch-log-json-pretty-printing"></a> Request logging</h3>
<div class="paragraph">
<p>The <code>hibernate.search.backend.log.json_pretty_printing</code> <a href="#configuration-property-types">boolean property</a>
defines whether JSON included in <a href="#troubleshooting-logging">request logs</a> should be pretty-printed (indented, with line breaks).
It defaults to <code>false</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="backend-elasticsearch-configuration-sharding"><a class="anchor" href="#backend-elasticsearch-configuration-sharding"></a>17.7. Sharding</h3>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>For a preliminary introduction to sharding,
including how it works in Hibernate Search and what its limitations are,
see <a href="#concepts-sharding-routing">Sharding and routing</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Elasticsearch disables sharding by default.
To enable it,
<a href="https://www.elastic.co/guide/en/elasticsearch/reference/8.13/index-modules.html#_static_index_settings">set the property <code>index.number_of_shards</code> in your cluster</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="backend-elasticsearch-schema-management"><a class="anchor" href="#backend-elasticsearch-schema-management"></a>17.8. <a id="elasticsearch-schema-management-strategy"></a> Schema management</h3>
<div class="paragraph">
<p>Elasticsearch indexes need to be created before they can be used for indexing and searching;
see <a href="#schema-management"> Managing the index schema</a> for more information about how to create indexes and their schema
in Hibernate Search.</p>
</div>
<div id="backend-elasticsearch-index-lifecycle" class="paragraph">
<p>For Elasticsearch specifically, some fine-tuning is available through the following options:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code># To configure the defaults for all indexes:
hibernate.search.backend.schema_management.minimal_required_status = green
hibernate.search.backend.schema_management.minimal_required_status_wait_timeout = 10000
# To configure a specific index:
hibernate.search.backend.indexes.&lt;index-name&gt;.schema_management.minimal_required_status = green
hibernate.search.backend.indexes.&lt;index-name&gt;.schema_management.minimal_required_status_wait_timeout = 10000</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>minimal_required_status</code> defines the minimal required status of an index before creation is considered complete.
The default for this property is <code>yellow</code>,
except on <a href="#backend-elasticsearch-compatibility-amazon-opensearch-serverless">Amazon OpenSearch Serverless</a>
where index status checks are skipped because that platform does not support index status checks.</p>
</li>
<li>
<p><code>minimal_required_status_wait_timeout</code> defines the maximum time to wait for this status,
as an <a href="#configuration-property-types">integer value</a> in milliseconds.
The default for this property is <code>10000</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>These properties are only effective when creating or validating an index as part of schema management.</p>
</div>
</div>
<div class="sect2">
<h3 id="backend-elasticsearch-indexlayout"><a class="anchor" href="#backend-elasticsearch-indexlayout"></a>17.9. Index layout</h3>
<div class="paragraph">
<p>Hibernate Search works with <a href="https://www.elastic.co/guide/en/elasticsearch/reference/8.13/indices-aliases.html">aliased</a> indexes.
This means an index with a given name in Hibernate Search will not directly be mapped
to an index with the same name in Elasticsearch.</p>
</div>
<div class="paragraph">
<p>The index layout is how Hibernate Search index names are mapped to Elasticsearch indexes,
and the strategy controlling that layout is set at the backend level:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>hibernate.search.backend.layout.strategy = simple</code></pre>
</div>
</div>
<div class="paragraph">
<p>The default for this property is <code>simple</code>.</p>
</div>
<div class="paragraph">
<p>See the following subsections for details about available strategies.</p>
</div>
<div class="sect3">
<h4 id="backend-elasticsearch-indexlayout-strategy-simple"><a class="anchor" href="#backend-elasticsearch-indexlayout-strategy-simple"></a>17.9.1. <code>simple</code>: the default, future-proof strategy</h4>
<div class="paragraph">
<p>For an index whose name in Hibernate Search is <code>myIndex</code>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If Hibernate Search <a href="#backend-elasticsearch-schema-management">creates the index automatically</a>,
it will name the index <code>myindex-000001</code> and will automatically create the write and read aliases.</p>
</li>
<li>
<p>Write operations (indexing, purge, &#8230;&#8203;) will target the alias <code>myindex-write</code>.</p>
</li>
<li>
<p>Read operations (searching, explaining, &#8230;&#8203;) will target the alias <code>myindex-read</code>.</p>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The <code>simple</code> layout is a bit more complex than it could be, but it follows the best practices.</p>
</div>
<div class="paragraph">
<p>Using aliases has a significant advantage over directly targeting the index:
it makes full reindexing on a live application possible without downtime,
which is useful in particular when <a href="#listener-triggered-indexing">listener-triggered indexing</a> is disabled
(<a href="#indexing-automatic-configuration">completely</a> or <a href="#mapping-reindexing-reindexonupdate">partially</a>)
and you need to fully reindex periodically (for example on a daily basis).</p>
</div>
<div class="paragraph">
<p>With aliases, you just need to direct the read alias (used by search queries) to an old copy of the index,
while the write alias (used by document writes) is redirected to a new copy of the index.
Without aliases (in particular with the <code>no-alias</code> layout), this is impossible.</p>
</div>
<div class="paragraph">
<p>This "zero-downtime" reindexing,
which shares some characteristics with <a href="https://martinfowler.com/bliki/BlueGreenDeployment.html">"blue/green" deployment</a>,
is not currently provided by Hibernate Search itself.
However, you can implement it in your application
by directly issuing commands to Elasticsearch&#8217;s REST APIs.
The basic sequence of actions is the following:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Create a new index, <code>myindex-000002</code>.</p>
</li>
<li>
<p>Switch the write alias, <code>myindex-write</code>, from <code>myindex-000001</code> to <code>myindex-000002</code>.</p>
</li>
<li>
<p>Reindex, for example using the <a href="#indexing-massindexer">mass indexer</a>.</p>
</li>
<li>
<p>Switch the read alias, <code>myindex-read</code>, from <code>myindex-000001</code> to <code>myindex-000002</code>.</p>
</li>
<li>
<p>Delete <code>myindex-000001</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Note this will only work if the Hibernate Search mapping did not change;
a zero-downtime upgrade with a changing schema would be considerably more complex.
You will find discussions on this topic in <a href="https://hibernate.atlassian.net/browse/HSEARCH-2861">HSEARCH-2861</a>
and <a href="https://hibernate.atlassian.net/browse/HSEARCH-3499">HSEARCH-3499</a>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="backend-elasticsearch-indexlayout-strategy-no-alias"><a class="anchor" href="#backend-elasticsearch-indexlayout-strategy-no-alias"></a>17.9.2. <code>no-alias</code>: a strategy without index aliases</h4>
<div class="paragraph">
<p>This strategy is mostly useful on legacy clusters.</p>
</div>
<div class="paragraph">
<p>For an index whose name in Hibernate Search is <code>myIndex</code>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If Hibernate Search <a href="#backend-elasticsearch-schema-management">creates the index automatically</a>,
it will name the index <code>myindex</code> and will not create any alias.</p>
</li>
<li>
<p>Write operations (indexing, purge, &#8230;&#8203;) will target the index directly by its name, <code>myindex</code>.</p>
</li>
<li>
<p>Read operations (searching, explaining, &#8230;&#8203;) will target the index directly by its name <code>myindex</code>.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="backend-elasticsearch-indexlayout-strategy-custom"><a class="anchor" href="#backend-elasticsearch-indexlayout-strategy-custom"></a>17.9.3. Custom strategy</h4>
<div class="paragraph">
<p>If the built-in layout strategies do not fit your requirements,
you can define a custom layout in two simple steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Define a class that implements the interface <code>org.hibernate.search.backend.elasticsearch.index.layout.IndexLayoutStrategy</code>.</p>
</li>
<li>
<p>Configure the backend to use that implementation by setting the configuration property
<code>hibernate.search.backend.layout.strategy</code>
to a <a href="#configuration-bean-reference-parsing">bean reference</a> pointing to the implementation,
for example <code>class:com.mycompany.MyLayoutStrategy</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>For example, the implementation below will lead to the following layout for an index named <code>myIndex</code>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Write operations (indexing, purge, &#8230;&#8203;) will target the alias <code>myindex-write</code>.</p>
</li>
<li>
<p>Read operations (searching, explaining, &#8230;&#8203;) will target the alias <code>myindex</code> (no suffix).</p>
</li>
<li>
<p>If Hibernate Search <a href="#backend-elasticsearch-schema-management">creates the index automatically</a>
at exactly 19:19:00 on November 6th, 2017,
it will name the index <code>myindex-20171106-191900-000000000</code>.</p>
</li>
</ul>
</div>
<div class="exampleblock">
<div class="title">Example 413. Implementing a custom index layout strategy with the Elasticsearch backend</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="keyword">import</span> <span class="include">java.time.Clock</span>;
<span class="keyword">import</span> <span class="include">java.time.Instant</span>;
<span class="keyword">import</span> <span class="include">java.time.ZoneOffset</span>;
<span class="keyword">import</span> <span class="include">java.time.format.DateTimeFormatter</span>;
<span class="keyword">import</span> <span class="include">java.util.Locale</span>;
<span class="keyword">import</span> <span class="include">java.util.regex.Matcher</span>;
<span class="keyword">import</span> <span class="include">java.util.regex.Pattern</span>;

<span class="keyword">import</span> <span class="include">org.hibernate.search.backend.elasticsearch.index.layout.IndexLayoutStrategy</span>;

<span class="directive">public</span> <span class="type">class</span> <span class="class">CustomLayoutStrategy</span> <span class="directive">implements</span> IndexLayoutStrategy {

    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> DateTimeFormatter INDEX_SUFFIX_FORMATTER =
            DateTimeFormatter.ofPattern( <span class="string"><span class="delimiter">&quot;</span><span class="content">uuuuMMdd-HHmmss-SSSSSSSSS</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">Locale</span>.ROOT )
                    .withZone( ZoneOffset.UTC );
    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">Pattern</span> UNIQUE_KEY_PATTERN =
            <span class="predefined-type">Pattern</span>.compile( <span class="string"><span class="delimiter">&quot;</span><span class="content">(.*)-</span><span class="char">\\</span><span class="content">d+-</span><span class="char">\\</span><span class="content">d+-</span><span class="char">\\</span><span class="content">d+</span><span class="delimiter">&quot;</span></span> );

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="predefined-type">String</span> createInitialElasticsearchIndexName(<span class="predefined-type">String</span> hibernateSearchIndexName) {
        <span class="comment">// Clock is Clock.systemUTC() in production, may be overridden in tests</span>
        Clock clock = MyApplicationClock.get();
        <span class="keyword">return</span> hibernateSearchIndexName + <span class="string"><span class="delimiter">&quot;</span><span class="content">-</span><span class="delimiter">&quot;</span></span>
                + INDEX_SUFFIX_FORMATTER.format( Instant.now( clock ) );
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="predefined-type">String</span> createWriteAlias(<span class="predefined-type">String</span> hibernateSearchIndexName) {
        <span class="keyword">return</span> hibernateSearchIndexName + <span class="string"><span class="delimiter">&quot;</span><span class="content">-write</span><span class="delimiter">&quot;</span></span>;
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="predefined-type">String</span> createReadAlias(<span class="predefined-type">String</span> hibernateSearchIndexName) {
        <span class="keyword">return</span> hibernateSearchIndexName;
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="predefined-type">String</span> extractUniqueKeyFromHibernateSearchIndexName(
            <span class="predefined-type">String</span> hibernateSearchIndexName) {
        <span class="keyword">return</span> hibernateSearchIndexName;
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="predefined-type">String</span> extractUniqueKeyFromElasticsearchIndexName(
            <span class="predefined-type">String</span> elasticsearchIndexName) {
        <span class="predefined-type">Matcher</span> matcher = UNIQUE_KEY_PATTERN.matcher( elasticsearchIndexName );
        <span class="keyword">if</span> ( !matcher.matches() ) {
            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="exception">IllegalArgumentException</span>(
                    <span class="string"><span class="delimiter">&quot;</span><span class="content">Unrecognized index name: </span><span class="delimiter">&quot;</span></span> + elasticsearchIndexName
            );
        }
        <span class="keyword">return</span> matcher.group( <span class="integer">1</span> );
    }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="backend-elasticsearch-indexlayout-metamodel"><a class="anchor" href="#backend-elasticsearch-indexlayout-metamodel"></a>17.9.4. Retrieving index or alias names</h4>
<div class="paragraph">
<p>Index or alias names used to read and write can be retrieved from the <a href="#mapping-inspect">metamodel</a>.</p>
</div>
<div class="exampleblock">
<div class="title">Example 414. Retrieving the index names from an Elasticsearch index manager</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">SearchMapping mapping = <span class="comment">/* ... */</span> <i class="conum" data-value="1"></i><b>(1)</b>
IndexManager indexManager = mapping.indexManager( <span class="string"><span class="delimiter">&quot;</span><span class="content">Book</span><span class="delimiter">&quot;</span></span> ); <i class="conum" data-value="2"></i><b>(2)</b>
ElasticsearchIndexManager esIndexManager = indexManager.unwrap( ElasticsearchIndexManager.class ); <i class="conum" data-value="3"></i><b>(3)</b>
ElasticsearchIndexDescriptor descriptor = esIndexManager.descriptor();<i class="conum" data-value="4"></i><b>(4)</b>
<span class="predefined-type">String</span> readName = descriptor.readName();<i class="conum" data-value="5"></i><b>(5)</b>
<span class="predefined-type">String</span> writeName = descriptor.writeName();<i class="conum" data-value="5"></i><b>(5)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><a href="#entrypoints-search-mapping">Retrieve the <code>SearchMapping</code></a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Retrieve the <code>IndexManager</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Narrow down the index manager to the <code>ElasticsearchIndexManager</code> type.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Get the index descriptor.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Get the index (or alias) read and write names.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="backend-elasticsearch-schema"><a class="anchor" href="#backend-elasticsearch-schema"></a>17.10. Schema ("mapping")</h3>
<div class="paragraph">
<p>What Elasticsearch calls the <a href="https://www.elastic.co/guide/en/elasticsearch/reference/8.13/mapping.html">"mapping"</a>
is the schema assigned to each index,
specifying the data type and capabilities of each "property" (called an "index field" in Hibernate Search).</p>
</div>
<div class="paragraph">
<p>For the most part, the Elasticsearch mapping is inferred from
<a href="#mapping">the mapping configured through Hibernate Search&#8217;s mapping APIs</a>,
which are generic and independent of Elasticsearch.</p>
</div>
<div class="paragraph">
<p>Aspects that are specific to the Elasticsearch backend are explained in this section.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Hibernate Search can be configured to push the mapping to Elasticsearch when creating the indexes
through <a href="#backend-elasticsearch-schema-management">schema management</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="backend-elasticsearch-field-types"><a class="anchor" href="#backend-elasticsearch-field-types"></a>17.10.1. Field types</h4>
<div class="sect4">
<h5 id="backend-elasticsearch-field-types-available"><a class="anchor" href="#backend-elasticsearch-field-types-available"></a>Available field types</h5>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Some types are not supported directly by the Elasticsearch backend,
but will work anyway because they are "bridged" by the mapper.
For example a <code>java.util.Date</code> in your entity model is "bridged" to <code>java.time.Instant</code>,
which is supported by the Elasticsearch backend.
See <a href="#mapping-directfieldmapping-supported-types">  Supported property types</a> for more information.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Field types that are not in this list can still be used with a little bit more work:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If a property in the entity model has an unsupported type,
but can be converted to a supported type, you will need a bridge.
See <a href="#binding">  Binding and bridges</a>.</p>
</li>
<li>
<p>If you need an index field with a specific type that is not supported by Hibernate Search,
you will need a bridge that defines a native field type.
See <a href="#backend-elasticsearch-field-types-extension">Index field type DSL extension</a>.</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 15. Field types supported by the Elasticsearch backend</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field type</th>
<th class="tableblock halign-left valign-top"><a href="https://www.elastic.co/guide/en/elasticsearch/reference/8.13/mapping-types.html">Data type</a> in Elasticsearch</th>
<th class="tableblock halign-left valign-top">Limitations</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.lang.String</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>text</code> if an analyzer is defined, <code>keyword</code> otherwise</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.lang.Byte</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>byte</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.lang.Short</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>short</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.lang.Integer</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>integer</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.lang.Long</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>long</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.lang.Double</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>double</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.lang.Float</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>float</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.lang.Boolean</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>boolean</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.math.BigDecimal</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>scaled_float</code> with a <code>scaling_factor</code> equal to 10^(<code>decimalScale</code>)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.math.BigInteger</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>scaled_float</code> with a <code>scaling_factor</code> equal to 10^(<code>decimalScale</code>)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.time.Instant</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>date</code> with format <code>uuuu-MM-dd&#8217;T&#8217;HH:mm:ss.SSSSSSSSSZZZZZ</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#backend-elasticsearch-field-types-date-time">Lower range/resolution</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.time.LocalDate</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>date</code> with format <code>uuuu-MM-dd</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#backend-elasticsearch-field-types-date-time">Lower range/resolution</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.time.LocalTime</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>date</code> with format <code>HH:mm:ss.SSSSSSSSS</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#backend-elasticsearch-field-types-date-time">Lower range/resolution</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.time.LocalDateTime</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>date</code> with format <code>uuuu-MM-dd&#8217;T&#8217;HH:mm:ss.SSSSSSSSS</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#backend-elasticsearch-field-types-date-time">Lower range/resolution</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.time.ZonedDateTime</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>date</code> with format <code>uuuu-MM-dd&#8217;T&#8217;HH:mm:ss.SSSSSSSSSZZZZZ'['VV']'</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#backend-elasticsearch-field-types-date-time">Lower range/resolution</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.time.OffsetDateTime</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>date</code> with format <code>uuuu-MM-dd&#8217;T&#8217;HH:mm:ss.SSSSSSSSSZZZZZ</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#backend-elasticsearch-field-types-date-time">Lower range/resolution</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.time.OffsetTime</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>date</code> with format <code>HH:mm:ss.SSSSSSSSSZZZZZ</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#backend-elasticsearch-field-types-date-time">Lower range/resolution</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.time.Year</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>date</code> with format <code>uuuu</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#backend-elasticsearch-field-types-date-time">Lower range/resolution</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.time.YearMonth</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>date</code> with format <code>uuuu-MM</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#backend-elasticsearch-field-types-date-time">Lower range/resolution</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.time.MonthDay</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>date</code> with format <code>uuuu-MM-dd</code>.
 <strong>The year is always set to 0</strong>.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><a href="#mapping-geopoint-basics">GeoPoint</a></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>geo_point</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
</tr>
</tbody>
</table>
<div id="backend-elasticsearch-field-types-date-time" class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Range and resolution of date/time fields</div>
<div class="paragraph">
<p>The Elasticsearch <code>date</code> type does not support the whole range of years that can be represented in <code>java.time</code> types:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>java.time</code> can represent years ranging from <code>-999.999.999</code> to <code>999.999.999</code>.</p>
</li>
<li>
<p>Elasticsearch&#8217;s <code>date</code> type supports dates ranging from year <code>-292.275.054</code> to year <code>292.278.993</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Values that are out of range will trigger indexing failures.</p>
</div>
<div class="paragraph">
<p>Resolution is also lower:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>java.time</code> supports nanosecond-resolution.</p>
</li>
<li>
<p>Elasticsearch&#8217;s <code>date</code> type supports millisecond-resolution.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Precision beyond the millisecond will be lost when indexing.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="backend-elasticsearch-field-types-extension"><a class="anchor" href="#backend-elasticsearch-field-types-extension"></a>Index field type DSL extension</h5>
<div class="paragraph">
<p>Not all Elasticsearch field types have built-in support in Hibernate Search.
Unsupported field types can still be used, however,
by taking advantage of the "native" field type.
Using this field type, the Elasticsearch "mapping" can be defined as JSON directly,
giving access to everything Elasticsearch can offer.</p>
</div>
<div class="paragraph">
<p>Below is an example of how to use the Elasticearch "native" type.</p>
</div>
<div class="exampleblock">
<div class="title">Example 415. Using the Elasticearch "native" type</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="directive">public</span> <span class="type">class</span> <span class="class">IpAddressValueBinder</span> <span class="directive">implements</span> ValueBinder { <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> bind(ValueBindingContext&lt;?&gt; context) {
        context.bridge(
                <span class="predefined-type">String</span>.class,
                <span class="keyword">new</span> IpAddressValueBridge(),
                context.typeFactory() <i class="conum" data-value="2"></i><b>(2)</b>
                        .extension( ElasticsearchExtension.get() ) <i class="conum" data-value="3"></i><b>(3)</b>
                        .asNative() <i class="conum" data-value="4"></i><b>(4)</b>
                                .mapping( <span class="string"><span class="delimiter">&quot;</span><span class="content">{</span><span class="char">\&quot;</span><span class="content">type</span><span class="char">\&quot;</span><span class="content">: </span><span class="char">\&quot;</span><span class="content">ip</span><span class="char">\&quot;</span><span class="content">}</span><span class="delimiter">&quot;</span></span> ) <i class="conum" data-value="5"></i><b>(5)</b>
        );
    }

    <span class="directive">private</span> <span class="directive">static</span> <span class="type">class</span> <span class="class">IpAddressValueBridge</span> <span class="directive">implements</span> ValueBridge&lt;<span class="predefined-type">String</span>, JsonElement&gt; {
        <span class="annotation">@Override</span>
        <span class="directive">public</span> JsonElement toIndexedValue(<span class="predefined-type">String</span> value,
                ValueBridgeToIndexedValueContext context) {
            <span class="keyword">return</span> value == <span class="predefined-constant">null</span> ? <span class="predefined-constant">null</span> : <span class="keyword">new</span> JsonPrimitive( value ); <i class="conum" data-value="6"></i><b>(6)</b>
        }

        <span class="annotation">@Override</span>
        <span class="directive">public</span> <span class="predefined-type">String</span> fromIndexedValue(JsonElement value,
                ValueBridgeFromIndexedValueContext context) {
            <span class="keyword">return</span> value == <span class="predefined-constant">null</span> ? <span class="predefined-constant">null</span> : value.getAsString(); <i class="conum" data-value="7"></i><b>(7)</b>
        }
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Define a <a href="#binding">custom binder</a> and its bridge.
The "native" type can only be used from a binder,
it cannot be used directly with annotation mapping.
Here we&#8217;re defining a <a href="#binding-valuebridge">value binder</a>,
but a <a href="#binding-typebridge">type binder</a>,
or a <a href="#binding-propertybridge">property binder</a>
would work as well.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Get the context&#8217;s type factory.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Apply the Elasticsearch extension to the type factory.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Call <code>asNative</code> to start defining a native type.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Pass the Elasticsearch mapping as JSON.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Values of native fields are represented as a <code>JsonElement</code> in Hibernate Search.
<code>JsonElement</code> is a type from the <a href="https://github.com/google/gson">Gson</a> library.
Do not forget to format them correctly before you pass them to the backend.
Here we are creating a <code>JsonPrimitive</code> (a subtype of <code>JsonElement</code>) from a <code>String</code>
because we just need a JSON string,
but it&#8217;s completely possible to handle more complex objects,
or even to convert directly from POJOs to JSON using Gson.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>For nicer projections, you can also implement this method to convert
from <code>JsonElement</code> to the mapped type (here, <code>String</code>).</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="annotation">@Entity</span>
<span class="annotation">@Indexed</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">CompanyServer</span> {

    <span class="annotation">@Id</span>
    <span class="annotation">@GeneratedValue</span>
    <span class="directive">private</span> <span class="predefined-type">Integer</span> id;

    <span class="annotation">@NonStandardField</span>( <i class="conum" data-value="1"></i><b>(1)</b>
            valueBinder = <span class="annotation">@ValueBinderRef</span>(type = IpAddressValueBinder.class) <i class="conum" data-value="2"></i><b>(2)</b>
    )
    <span class="directive">private</span> <span class="predefined-type">String</span> ipAddress;

    <span class="comment">// Getters and setters</span>
    <span class="comment">// ...</span>

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Map the property to an index field.
Note that value bridges using a non-standard type (such as Elasticsearch&#8217;s "native" type)
must be mapped using the <code>@NonStandardField</code> annotation:
other annotations such as <code>@GenericField</code> will fail.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Instruct Hibernate Search to use our custom value binder.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="backend-elasticsearch-type-name"><a class="anchor" href="#backend-elasticsearch-type-name"></a>17.10.2. Entity type name mapping</h4>
<div class="paragraph">
<p>When Hibernate Search performs a search query targeting multiple entity types, and thus multiple indexes,
it needs to determine the <a href="#concepts-entity">entity type</a> of each search hit in order to map it back to an entity.</p>
</div>
<div class="paragraph">
<p>There are multiple strategies to handle this "entity type name resolution",
and each has pros and cons.</p>
</div>
<div class="paragraph">
<p>The strategy is set at the backend level:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>hibernate.search.backend.mapping.type_name.strategy = discriminator</code></pre>
</div>
</div>
<div class="paragraph">
<p>The default for this property is <code>discriminator</code>.</p>
</div>
<div class="paragraph">
<p>See the following subsections for details about available strategies.</p>
</div>
<div class="sect4">
<h5 id="backend-elasticsearch-type-name-discriminator"><a class="anchor" href="#backend-elasticsearch-type-name-discriminator"></a><code>discriminator</code>: type name mapping using a discriminator field</h5>
<div class="paragraph">
<p>With the <code>discriminator</code> strategy, a discriminator field is used to retrieve the entity type name directly from each document.</p>
</div>
<div class="paragraph">
<p>When indexing, the <code>_entity_type</code> field is populated transparently with the name of the <a href="#concepts-entity">entity type</a> for each document.</p>
</div>
<div class="paragraph">
<p>When searching, the docvalues for the <code>_entity_type</code> field are transparently requested from Elasticsearch
and extracted from the response.</p>
</div>
<div class="paragraph">
<p>Pros:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Works correctly when targeting <a href="https://www.elastic.co/guide/en/elasticsearch/reference/8.13/indices-add-alias.html">index aliases</a>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Cons:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Small storage overhead: a few bytes of storage per document.</p>
</li>
<li>
<p>Requires <a href="#indexing-massindexer">full reindexing</a> if an <a href="#concepts-entity">entity</a> name changes,
even if the index name doesn&#8217;t change.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="backend-elasticsearch-type-name-index-name"><a class="anchor" href="#backend-elasticsearch-type-name-index-name"></a><code>index-name</code>: type name mapping using the index name</h5>
<div class="paragraph">
<p>With the <code>index-name</code> strategy, the <code>_index</code> meta-field returned for each search hit
is used to resolve the index name, and from that the <a href="#concepts-entity">entity type</a> name.</p>
</div>
<div class="paragraph">
<p>Pros:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>No storage overhead.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Cons:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Relies on the actual index name, not aliases,
because the <code>_index</code> meta-field returned by Elasticsearch
contains the actual index name (e.g. <code>myindex-000001</code>), not the alias (e.g. <code>myindex-read</code>).
Thus, if indexes do not follow the default naming scheme <code>&lt;hibernateSearchIndexName&gt;-&lt;6 digits&gt;</code>,
a custom <a href="#backend-elasticsearch-indexlayout">index layout</a> must be configured.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="backend-elasticsearch-mapping-dynamic"><a class="anchor" href="#backend-elasticsearch-mapping-dynamic"></a>17.10.3. Dynamic mapping</h4>
<div class="paragraph">
<p>By default, Hibernate Search sets the <a href="https://www.elastic.co/guide/en/elasticsearch/reference/8.13/dynamic.html"><code>dynamic</code></a> property in Elasticsearch index mappings to <code>strict</code>.
This means that attempting to index documents with fields that are not present in the mapping will lead to an indexing failure.</p>
</div>
<div class="paragraph">
<p>If Hibernate Search is the only client, that won&#8217;t be a problem,
since Hibernate Search usually works on declared schema fields only.
For the other cases in which we need to change this setting,
we can use the following index-level property to change the value.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code># To configure the defaults for all indexes:
hibernate.search.backend.dynamic_mapping = strict
# To configure a specific index:
hibernate.search.backend.indexes.&lt;index-name&gt;.dynamic_mapping = strict</code></pre>
</div>
</div>
<div class="paragraph">
<p>The default for this property is <code>strict</code>.</p>
</div>
<div class="paragraph">
<p>We said that Hibernate Search <strong>usually</strong> works on declared schema fields. More precisely, it always does
if no <a href="#binding-index-field-dsl-dynamic"> Dynamic fields with field templates</a> are defined.
When field templates are defined, <code>dynamic</code> will be forced to <code>true</code>, in order to allow for dynamic fields. In that case, the value of the <code>dynamic_mapping</code> property is ignored.</p>
</div>
</div>
<div class="sect3">
<h4 id="backend-elasticsearch-multi-tenancy"><a class="anchor" href="#backend-elasticsearch-multi-tenancy"></a>17.10.4. Multi-tenancy</h4>
<div class="paragraph">
<p>Multi-tenancy is supported and handled transparently,
according to the tenant ID defined in the current session:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>documents will be indexed with the appropriate values, allowing later filtering;</p>
</li>
<li>
<p>queries will filter results appropriately.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The multi-tenancy is automatically enabled in the backend if it is enabled in the mapper,
e.g. if <a href="https://docs.jboss.org/hibernate/orm/6.4/userguide/html_single/Hibernate_User_Guide.html#multitenacy">a multi-tenancy strategy is selected in Hibernate ORM</a>,
or if <a href="#mapper-pojo-standalone-multi-tenancy">multi-tenancy is explicitly configured in the Standalone POJO mapper</a>.</p>
</div>
<div class="paragraph">
<p>However, it is possible to enable multi-tenancy manually.</p>
</div>
<div class="paragraph">
<p>The multi-tenancy strategy is set at the backend level:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>hibernate.search.backend.multi_tenancy.strategy = none</code></pre>
</div>
</div>
<div class="paragraph">
<p>See the following subsections for details about available strategies.</p>
</div>
<div class="sect4">
<h5 id="backend-elasticsearch-multi-tenancy-none"><a class="anchor" href="#backend-elasticsearch-multi-tenancy-none"></a><code>none</code>: single-tenancy</h5>
<div class="paragraph">
<p>The <code>none</code> strategy (the default) disables multi-tenancy completely.</p>
</div>
<div class="paragraph">
<p>Attempting to set a tenant ID will lead to a failure when indexing.</p>
</div>
</div>
<div class="sect4">
<h5 id="backend-elasticsearch-multi-tenancy-discriminator"><a class="anchor" href="#backend-elasticsearch-multi-tenancy-discriminator"></a><code>discriminator</code>: type name mapping using the index name</h5>
<div class="paragraph">
<p>With the <code>discriminator</code> strategy,
all documents from all tenants are stored in the same index.
The Elasticsearch ID of each document is set to the concatenation of the tenant ID and original ID.</p>
</div>
<div class="paragraph">
<p>When indexing, two fields are populated transparently for each document:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>_tenant_id</code>: the "discriminator" field holding the tenant ID.</p>
</li>
<li>
<p><code>_tenant_doc_id</code>: a field holding the original (tenant-scoped) document ID.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>When searching, a filter targeting the tenant ID field is added transparently to the search query
to only return search hits for the current tenant.
The ID field is used to retrieve the original document IDs.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="backend-elasticsearch-mapping-custom"><a class="anchor" href="#backend-elasticsearch-mapping-custom"></a>17.10.5. <a id="_custom_index_mapping"></a> Custom index mapping</h4>
<div class="sect4">
<h5 id="backend-elasticsearch-mapping-custom-basics"><a class="anchor" href="#backend-elasticsearch-mapping-custom-basics"></a>Basics</h5>
<div class="paragraph">
<p>Hibernate Search can <a href="#schema-management">create and validate indexes</a>,
but by default created indexes will only include the bare minimum required to index and search:
the mapping, and the analysis settings.
Should you need to customize some <a href="https://www.elastic.co/guide/en/elasticsearch/reference/8.13/mapping-params.html">mapping parameters</a>,
it is possible to provide a custom mapping to Hibernate Search:
it will include the custom mapping when creating an index.</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The consistency of the custom Elasticsearch mapping with the Hibernate Search mapping will not get checked in any way.
You are responsible for making sure that any override in your mapping can work,
e.g. that you&#8217;re not changing the type of an index field from <code>text</code> to <code>integer</code>,
or disabling <code>doc_values</code> on a field used for sorting.</p>
</div>
<div class="paragraph">
<p>An invalid custom mapping may not trigger any exception on bootstrap, but later while indexing or querying.
In the worst case, it could not trigger any exception, but simply lead to incorrect search results.
Exercise extreme caution.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code># To configure the defaults for all indexes:
hibernate.search.backend.schema_management.mapping_file = custom/index-mapping.json
# To configure a specific index:
hibernate.search.backend.indexes.&lt;index-name&gt;.schema_management.mapping_file = custom/index-mapping.json</code></pre>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 416. Possible content of <code>custom/index-mapping.json</code> file</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JSON">{
  <span class="key"><span class="delimiter">&quot;</span><span class="content">properties</span><span class="delimiter">&quot;</span></span>:{
    <span class="key"><span class="delimiter">&quot;</span><span class="content">userField</span><span class="delimiter">&quot;</span></span>:{
      <span class="key"><span class="delimiter">&quot;</span><span class="content">type</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">keyword</span><span class="delimiter">&quot;</span></span>,
      <span class="key"><span class="delimiter">&quot;</span><span class="content">index</span><span class="delimiter">&quot;</span></span>:<span class="value">true</span>,
      <span class="key"><span class="delimiter">&quot;</span><span class="content">norms</span><span class="delimiter">&quot;</span></span>:<span class="value">true</span>,
      <span class="key"><span class="delimiter">&quot;</span><span class="content">doc_values</span><span class="delimiter">&quot;</span></span>:<span class="value">true</span>
    },
    <span class="key"><span class="delimiter">&quot;</span><span class="content">userObject</span><span class="delimiter">&quot;</span></span>:{
      <span class="key"><span class="delimiter">&quot;</span><span class="content">dynamic</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span>,
      <span class="key"><span class="delimiter">&quot;</span><span class="content">type</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">object</span><span class="delimiter">&quot;</span></span>
    }
  },
  <span class="key"><span class="delimiter">&quot;</span><span class="content">_source</span><span class="delimiter">&quot;</span></span>: {
    <span class="key"><span class="delimiter">&quot;</span><span class="content">enabled</span><span class="delimiter">&quot;</span></span>: <span class="value">false</span>
  }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Properties that are only defined in the custom mappings file but not mapped by Hibernate Search
will not be visible to Hibernate Search.</p>
</div>
<div class="paragraph">
<p>This means Hibernate Search will throw exceptions if you try to reference these properties in the <a href="#search-dsl">Search DSL</a>,
or when <a href="#binding-index-field-dsl-dynamic">writing to a document from a bridge</a></p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The file does not need to contain the full mapping: Hibernate Search will automatically inject
missing properties (index fields) in the given mapping.</p>
</div>
<div class="paragraph">
<p>Conflicts between the given mapping and the mapping generated by Hibernate Search will be handled as follows:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The <code>dynamic_templates</code>/<code>_routing</code>/<code>dynamic</code> mapping parameters
will be those from the given mapping, falling back to the value generated by Hibernate Search (if any).</p>
</li>
<li>
<p>Any other mapping parameters besides the <code>properties</code> at the root of the mapping
will be those from the given mapping; those generated by Hibernate Search will be ignored.</p>
</li>
<li>
<p><code>properties</code> will be merged, using properties defined in both the
given mapping and the mapping generated by Hibernate Search.</p>
</li>
<li>
<p>If a property is defined on both sides, it will be merged recursively, following steps 1-4.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>In the example above, the resulting, merged mapping could look like this:</p>
</div>
<div class="exampleblock">
<div class="title">Example 417. Possible resulting mapping after merging the content of <code>custom/index-mapping.json</code> with the Hibernate Search mapping</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JSON">{
  <span class="key"><span class="delimiter">&quot;</span><span class="content">_source</span><span class="delimiter">&quot;</span></span>:{
    <span class="key"><span class="delimiter">&quot;</span><span class="content">enabled</span><span class="delimiter">&quot;</span></span>:<span class="value">false</span>
  },
  <span class="key"><span class="delimiter">&quot;</span><span class="content">dynamic</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">strict</span><span class="delimiter">&quot;</span></span>,
  <span class="key"><span class="delimiter">&quot;</span><span class="content">properties</span><span class="delimiter">&quot;</span></span>:{
    <span class="key"><span class="delimiter">&quot;</span><span class="content">_entity_type</span><span class="delimiter">&quot;</span></span>:{ <i class="conum" data-value="1"></i><b>(1)</b>
      <span class="key"><span class="delimiter">&quot;</span><span class="content">type</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">keyword</span><span class="delimiter">&quot;</span></span>,
      <span class="key"><span class="delimiter">&quot;</span><span class="content">index</span><span class="delimiter">&quot;</span></span>:<span class="value">false</span>
    },
    <span class="key"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>:{ <i class="conum" data-value="2"></i><b>(2)</b>
      <span class="key"><span class="delimiter">&quot;</span><span class="content">type</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">text</span><span class="delimiter">&quot;</span></span>,
      <span class="key"><span class="delimiter">&quot;</span><span class="content">analyzer</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">english</span><span class="delimiter">&quot;</span></span>
    },
    <span class="key"><span class="delimiter">&quot;</span><span class="content">userField</span><span class="delimiter">&quot;</span></span>:{
      <span class="key"><span class="delimiter">&quot;</span><span class="content">type</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">keyword</span><span class="delimiter">&quot;</span></span>,
      <span class="key"><span class="delimiter">&quot;</span><span class="content">norms</span><span class="delimiter">&quot;</span></span>:<span class="value">true</span>
    },
    <span class="key"><span class="delimiter">&quot;</span><span class="content">userObject</span><span class="delimiter">&quot;</span></span>:{
      <span class="key"><span class="delimiter">&quot;</span><span class="content">type</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">object</span><span class="delimiter">&quot;</span></span>,
      <span class="key"><span class="delimiter">&quot;</span><span class="content">dynamic</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span>
    }
  }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This property is always added by Hibernate Search for internal implementation purposes.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>This is a property generated by Hibernate Search because the indexed entity
has a <code>String name</code> property annotated with <code>@FullTextField</code>.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="backend-elasticsearch-mapping-custom-disabling-source"><a class="anchor" href="#backend-elasticsearch-mapping-custom-disabling-source"></a><a id="_disable_source"></a> Disabling <code>_source</code></h5>
<div class="paragraph">
<p>Using this feature it is possible to <a href="https://www.elastic.co/guide/en/elasticsearch/reference/8.13/mapping-source-field.html">disable the <code>_source</code> field</a>.
For instance, you could pass a <code>custom/index-mapping.json</code> file like the following:</p>
</div>
<div class="exampleblock">
<div class="title">Example 418. Possible content of <code>custom/index-mapping.json</code> file to disable the <code>_source</code> field</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JSON">{
  <span class="key"><span class="delimiter">&quot;</span><span class="content">_source</span><span class="delimiter">&quot;</span></span>: {
    <span class="key"><span class="delimiter">&quot;</span><span class="content">enabled</span><span class="delimiter">&quot;</span></span>: <span class="value">false</span>
  }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Disabling the <code>_source</code> is useful to reduce the size of Elasticsearch indexes on the filesystem, but it comes at a cost.</p>
</div>
<div class="paragraph">
<p>Several <a href="#search-dsl-projection">projections</a> rely on the <code>_source</code> being enabled.
If you try to use projections with <code>_source</code> disabled, behavior is undefined: the search query may return <code>null</code> hits, or it may fail completely with exceptions.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="backend-elasticsearch-analysis"><a class="anchor" href="#backend-elasticsearch-analysis"></a>17.11. <a id="elasticsearch-mapping-analyzer"></a> Analysis</h3>
<div class="sect3">
<h4 id="backend-elasticsearch-analysis-basics"><a class="anchor" href="#backend-elasticsearch-analysis-basics"></a>17.11.1. Basics</h4>
<div class="paragraph">
<p><a href="#concepts-analysis">Analysis</a> is the text processing performed by analyzers,
both when indexing (document processing)
and when searching (query processing).</p>
</div>
<div class="paragraph">
<p>All <a href="#backend-elasticsearch-analysis-builtin">built-in Elasticsearch analyzers</a> can be used transparently,
without any configuration in Hibernate Search:
just use their name wherever Hibernate Search expects an analyzer name.
However, analysis can also be configured explicitly.</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Elasticsearch analysis configuration is not applied immediately on startup:
it needs to be pushed to the Elasticsearch cluster.</p>
</div>
<div class="paragraph">
<p>Hibernate Search will only push the configuration to the cluster if instructed to do so
through <a href="#schema-management">schema management</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To configure analysis in an Elasticsearch backend, you will need to:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Define a class that implements the <code>org.hibernate.search.backend.elasticsearch.analysis.ElasticsearchAnalysisConfigurer</code> interface.</p>
</li>
<li>
<p>Configure the backend to use that implementation by setting the configuration property
<code>hibernate.search.backend.analysis.configurer</code>
to a <a href="#configuration-bean-reference-parsing">bean reference</a> pointing to the implementation,
for example <code>class:com.mycompany.MyAnalysisConfigurer</code>.</p>
</li>
</ol>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
You can pass multiple bean references separated by commas. See <a href="#configuration-property-types">Type of configuration properties</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Hibernate Search will call the <code>configure</code> method of this implementation on startup,
and the configurer will be able to take advantage of a DSL to define
<a href="#backend-elasticsearch-analysis-analyzers">analyzers and normalizers</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>A different analysis configurer can be assigned to each index:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code># To set the default configurer for all indexes:
hibernate.search.backend.analysis.configurer = class:com.mycompany.MyAnalysisConfigurer
# To assign a specific configurer to a specific index:
hibernate.search.backend.indexes.&lt;index-name&gt;.analysis.configurer = class:com.mycompany.MySpecificAnalysisConfigurer</code></pre>
</div>
</div>
<div class="paragraph">
<p>If a specific configurer is assigned to an index,
the default configurer will be ignored for that index:
only definitions from the specific configurer will be taken into account.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="backend-elasticsearch-analysis-builtin"><a class="anchor" href="#backend-elasticsearch-analysis-builtin"></a>17.11.2. Built-in analyzers</h4>
<div class="paragraph">
<p>Built-in analyzers are available out-of-the-box and don&#8217;t require explicit configuration.
If necessary, they can be overridden by defining your own analyzer with the same name.</p>
</div>
<div class="paragraph">
<p>The Elasticsearch backend comes with several built-in analyzers.
The exact list depends on the version of Elasticsearch and can be found
<a href="https://www.elastic.co/guide/en/elasticsearch/reference/8.13/analysis-analyzers.html">here</a>.</p>
</div>
<div class="paragraph">
<p>Regardless of the Elasticsearch version,
analyzers whose name is listed as a constant in <code>org.hibernate.search.engine.backend.analysis.AnalyzerNames</code>
are always available:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>default</code></dt>
<dd>
<p>The analyzer used by default with <a href="#mapping-directfieldmapping-annotations-fulltextfield"><code>@FullTextField</code></a>.</p>
<div class="paragraph">
<p>This is just an alias for <code>standard</code> by default.</p>
</div>
</dd>
<dt class="hdlist1"><code>standard</code></dt>
<dd>
<p>Default behavior: first, tokenize using the standard tokenizer, which follows Word Break rules from the
Unicode Text Segmentation algorithm, as specified in <a href="http://unicode.org/reports/tr29/">Unicode Standard Annex #29</a>.
Then, lowercase each token.</p>
</dd>
<dt class="hdlist1"><code>simple</code></dt>
<dd>
<p>Default behavior: first, split the text at non-letter characters.
Then, lowercase each token.</p>
</dd>
<dt class="hdlist1"><code>whitespace</code></dt>
<dd>
<p>Default behavior: split the text at whitespace characters.
Do not change the tokens.</p>
</dd>
<dt class="hdlist1"><code>stop</code></dt>
<dd>
<p>Default behavior: first, split the text at non-letter characters.
Then, lowercase each token.
Finally, remove English stop words.</p>
</dd>
<dt class="hdlist1"><code>keyword</code></dt>
<dd>
<p>Default behavior: do not change the text in any way.</p>
<div class="paragraph">
<p>With this analyzer a full text field would behave similarly to a keyword field,
but with fewer features: no terms aggregations, for example.</p>
</div>
<div class="paragraph">
<p>Consider using a <a href="#mapping-directfieldmapping-annotations-keywordfield"><code>@KeywordField</code></a> instead.</p>
</div>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="backend-elasticsearch-analysis-builtin-normalizer"><a class="anchor" href="#backend-elasticsearch-analysis-builtin-normalizer"></a>17.11.3. Built-in normalizers</h4>
<div class="paragraph">
<p>The Elasticsearch backend does not provide any built-in normalizer.</p>
</div>
</div>
<div class="sect3">
<h4 id="backend-elasticsearch-analysis-analyzers"><a class="anchor" href="#backend-elasticsearch-analysis-analyzers"></a>17.11.4. Custom analyzers and normalizers</h4>
<div class="paragraph">
<p>The context passed to the configurer exposes a DSL to define analyzers and normalizers:</p>
</div>
<div class="exampleblock">
<div class="title">Example 419. Implementing and using an analysis configurer to define analyzers and normalizers with the Elasticsearch backend</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="keyword">package</span> <span class="namespace">org.hibernate.search.documentation.analysis</span>;

<span class="keyword">import</span> <span class="include">org.hibernate.search.backend.elasticsearch.analysis.ElasticsearchAnalysisConfigurationContext</span>;
<span class="keyword">import</span> <span class="include">org.hibernate.search.backend.elasticsearch.analysis.ElasticsearchAnalysisConfigurer</span>;

<span class="directive">public</span> <span class="type">class</span> <span class="class">MyElasticsearchAnalysisConfigurer</span> <span class="directive">implements</span> ElasticsearchAnalysisConfigurer {
    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> configure(ElasticsearchAnalysisConfigurationContext context) {
        context.analyzer( <span class="string"><span class="delimiter">&quot;</span><span class="content">english</span><span class="delimiter">&quot;</span></span> ).custom() <i class="conum" data-value="1"></i><b>(1)</b>
                .tokenizer( <span class="string"><span class="delimiter">&quot;</span><span class="content">standard</span><span class="delimiter">&quot;</span></span> ) <i class="conum" data-value="2"></i><b>(2)</b>
                .charFilters( <span class="string"><span class="delimiter">&quot;</span><span class="content">html_strip</span><span class="delimiter">&quot;</span></span> ) <i class="conum" data-value="3"></i><b>(3)</b>
                .tokenFilters( <span class="string"><span class="delimiter">&quot;</span><span class="content">lowercase</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">snowball_english</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">asciifolding</span><span class="delimiter">&quot;</span></span> ); <i class="conum" data-value="4"></i><b>(4)</b>

        context.tokenFilter( <span class="string"><span class="delimiter">&quot;</span><span class="content">snowball_english</span><span class="delimiter">&quot;</span></span> ) <i class="conum" data-value="5"></i><b>(5)</b>
                .type( <span class="string"><span class="delimiter">&quot;</span><span class="content">snowball</span><span class="delimiter">&quot;</span></span> )
                .param( <span class="string"><span class="delimiter">&quot;</span><span class="content">language</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">English</span><span class="delimiter">&quot;</span></span> ); <i class="conum" data-value="6"></i><b>(6)</b>

        context.normalizer( <span class="string"><span class="delimiter">&quot;</span><span class="content">lowercase</span><span class="delimiter">&quot;</span></span> ).custom() <i class="conum" data-value="7"></i><b>(7)</b>
                .tokenFilters( <span class="string"><span class="delimiter">&quot;</span><span class="content">lowercase</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">asciifolding</span><span class="delimiter">&quot;</span></span> );

        context.analyzer( <span class="string"><span class="delimiter">&quot;</span><span class="content">french</span><span class="delimiter">&quot;</span></span> ).custom() <i class="conum" data-value="8"></i><b>(8)</b>
                .tokenizer( <span class="string"><span class="delimiter">&quot;</span><span class="content">standard</span><span class="delimiter">&quot;</span></span> )
                .tokenFilters( <span class="string"><span class="delimiter">&quot;</span><span class="content">lowercase</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">snowball_french</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">asciifolding</span><span class="delimiter">&quot;</span></span> );

        context.tokenFilter( <span class="string"><span class="delimiter">&quot;</span><span class="content">snowball_french</span><span class="delimiter">&quot;</span></span> )
                .type( <span class="string"><span class="delimiter">&quot;</span><span class="content">snowball</span><span class="delimiter">&quot;</span></span> )
                .param( <span class="string"><span class="delimiter">&quot;</span><span class="content">language</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">French</span><span class="delimiter">&quot;</span></span> );
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Define a custom analyzer named "english", because it will be used to analyze English text such as book titles.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Set the tokenizer to a standard tokenizer.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Set the char filters. Char filters are applied in the order they are given, before the tokenizer.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Set the token filters. Token filters are applied in the order they are given, after the tokenizer.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Note that, for Elasticsearch, any parameterized char filter, tokenizer or token filter
must be defined separately and assigned a name.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Set the value of a parameter for the char filter/tokenizer/token filter being defined.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Normalizers are defined in a similar way, the only difference being that they cannot use a tokenizer.</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>Multiple analyzers/normalizers can be defined in the same configurer.</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="XML"><i class="conum" data-value="1"></i><b>(1)</b>
hibernate.search.backend.analysis.configurer = class:org.hibernate.search.documentation.analysis.MyElasticsearchAnalysisConfigurer</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Assign the configurer to the backend using a Hibernate Search configuration property.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>It is also possible to assign a name to a parameterized built-in analyzer:</p>
</div>
<div class="exampleblock">
<div class="title">Example 420. Naming a parameterized built-in analyzer in the Elasticsearch backend</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">context.analyzer( <span class="string"><span class="delimiter">&quot;</span><span class="content">english_stopwords</span><span class="delimiter">&quot;</span></span> ).type( <span class="string"><span class="delimiter">&quot;</span><span class="content">standard</span><span class="delimiter">&quot;</span></span> ) <i class="conum" data-value="1"></i><b>(1)</b>
        .param( <span class="string"><span class="delimiter">&quot;</span><span class="content">stopwords</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">_english_</span><span class="delimiter">&quot;</span></span> ); <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Define an analyzer with the given name and type.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Set the value of a parameter for the analyzer being defined.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>To know which analyzers, character filters, tokenizers and token filters are available,
refer to the documentation:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If you want to use a built-in analyzer and not create your own:
<a href="https://www.elastic.co/guide/en/elasticsearch/reference/8.13/analysis-analyzers.html">analyzers</a>;</p>
</li>
<li>
<p>If you want to define your own analyzer:
<a href="https://www.elastic.co/guide/en/elasticsearch/reference/8.13/analysis-charfilters.html">character filters</a>,
<a href="https://www.elastic.co/guide/en/elasticsearch/reference/8.13/analysis-tokenizers.html">tokenizers</a>,
<a href="https://www.elastic.co/guide/en/elasticsearch/reference/8.13/analysis-tokenfilters.html">token filters</a>.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="backend-elasticsearch-analysis-analyzers-default"><a class="anchor" href="#backend-elasticsearch-analysis-analyzers-default"></a>17.11.5. Overriding the default analyzer</h4>
<div class="paragraph">
<p>The default analyzer when using <a href="#mapping-directfieldmapping-annotations-fulltextfield"><code>@FullTextField</code></a>
without specifying an analyzer explicitly, is named <code>default</code>.</p>
</div>
<div class="paragraph">
<p>Like any other <a href="#backend-elasticsearch-analysis-builtin">built-in analyzer</a>, it is possible to override the default analyzer
by defining a <a href="#backend-elasticsearch-analysis-analyzers">custom analyzer</a> with the same name:</p>
</div>
<div class="exampleblock">
<div class="title">Example 421. Overriding the default analyzer in the Elasticsearch backend</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="keyword">package</span> <span class="namespace">org.hibernate.search.documentation.analysis</span>;

<span class="keyword">import</span> <span class="include">org.hibernate.search.backend.elasticsearch.analysis.ElasticsearchAnalysisConfigurationContext</span>;
<span class="keyword">import</span> <span class="include">org.hibernate.search.backend.elasticsearch.analysis.ElasticsearchAnalysisConfigurer</span>;

<span class="directive">public</span> <span class="type">class</span> <span class="class">MyElasticsearchAnalysisConfigurer</span> <span class="directive">implements</span> ElasticsearchAnalysisConfigurer {
    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> configure(ElasticsearchAnalysisConfigurationContext context) {
        context.analyzer( <span class="string"><span class="delimiter">&quot;</span><span class="content">english</span><span class="delimiter">&quot;</span></span> ).custom() <i class="conum" data-value="1"></i><b>(1)</b>
                .tokenizer( <span class="string"><span class="delimiter">&quot;</span><span class="content">standard</span><span class="delimiter">&quot;</span></span> ) <i class="conum" data-value="2"></i><b>(2)</b>
                .charFilters( <span class="string"><span class="delimiter">&quot;</span><span class="content">html_strip</span><span class="delimiter">&quot;</span></span> ) <i class="conum" data-value="3"></i><b>(3)</b>
                .tokenFilters( <span class="string"><span class="delimiter">&quot;</span><span class="content">lowercase</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">snowball_english</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">asciifolding</span><span class="delimiter">&quot;</span></span> ); <i class="conum" data-value="4"></i><b>(4)</b>

        context.tokenFilter( <span class="string"><span class="delimiter">&quot;</span><span class="content">snowball_english</span><span class="delimiter">&quot;</span></span> ) <i class="conum" data-value="5"></i><b>(5)</b>
                .type( <span class="string"><span class="delimiter">&quot;</span><span class="content">snowball</span><span class="delimiter">&quot;</span></span> )
                .param( <span class="string"><span class="delimiter">&quot;</span><span class="content">language</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">English</span><span class="delimiter">&quot;</span></span> ); <i class="conum" data-value="6"></i><b>(6)</b>

        context.normalizer( <span class="string"><span class="delimiter">&quot;</span><span class="content">lowercase</span><span class="delimiter">&quot;</span></span> ).custom() <i class="conum" data-value="7"></i><b>(7)</b>
                .tokenFilters( <span class="string"><span class="delimiter">&quot;</span><span class="content">lowercase</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">asciifolding</span><span class="delimiter">&quot;</span></span> );

        context.analyzer( <span class="string"><span class="delimiter">&quot;</span><span class="content">french</span><span class="delimiter">&quot;</span></span> ).custom() <i class="conum" data-value="8"></i><b>(8)</b>
                .tokenizer( <span class="string"><span class="delimiter">&quot;</span><span class="content">standard</span><span class="delimiter">&quot;</span></span> )
                .tokenFilters( <span class="string"><span class="delimiter">&quot;</span><span class="content">lowercase</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">snowball_french</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">asciifolding</span><span class="delimiter">&quot;</span></span> );

        context.tokenFilter( <span class="string"><span class="delimiter">&quot;</span><span class="content">snowball_french</span><span class="delimiter">&quot;</span></span> )
                .type( <span class="string"><span class="delimiter">&quot;</span><span class="content">snowball</span><span class="delimiter">&quot;</span></span> )
                .param( <span class="string"><span class="delimiter">&quot;</span><span class="content">language</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">French</span><span class="delimiter">&quot;</span></span> );
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Start the definition of a custom analyzer that happens to be named <code>default</code>.
Here we rely on constants from <code>org.hibernate.search.engine.backend.analysis.AnalyzerNames</code> to use the correct name,
but hardcoding <code>"default"</code> would work just as well.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Continue the analyzer definition <a href="#backend-elasticsearch-analysis-analyzers">as we would for any other custom analyzer</a>.</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="XML"><i class="conum" data-value="1"></i><b>(1)</b>
hibernate.search.backend.analysis.configurer = class:org.hibernate.search.documentation.analysis.DefaultOverridingElasticsearchAnalysisConfigurer</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Assign the configurer to the backend using a Hibernate Search configuration property.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="backend-elasticsearch-configuration-index-settings"><a class="anchor" href="#backend-elasticsearch-configuration-index-settings"></a>17.12. <a id="_custom_index_settings"></a> Custom index settings</h3>
<div class="paragraph">
<p>Hibernate Search can <a href="#schema-management">create and validate indexes</a>, but by default created indexes will only include the bare minimum required to index and search: the mapping, and the analysis settings.
Should you need to set some <a href="https://www.elastic.co/guide/en/elasticsearch/reference/8.13/index-modules.html#index-modules-settings">custom index settings</a>, it is possible to provide these settings to Hibernate Search: it will include them when creating an index and take them into account when validating an index.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code># To configure the defaults for all indexes:
hibernate.search.backend.schema_management.settings_file = custom/index-settings.json
# To configure a specific index:
hibernate.search.backend.indexes.&lt;index-name&gt;.schema_management.settings_file = custom/index-settings.json</code></pre>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 422. Possible content of <code>custom/index-settings.json</code> file</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JSON">{
  <span class="key"><span class="delimiter">&quot;</span><span class="content">number_of_shards</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">3</span><span class="delimiter">&quot;</span></span>,
  <span class="key"><span class="delimiter">&quot;</span><span class="content">number_of_replicas</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">3</span><span class="delimiter">&quot;</span></span>,
  <span class="key"><span class="delimiter">&quot;</span><span class="content">analysis</span><span class="delimiter">&quot;</span></span>: {
    <span class="key"><span class="delimiter">&quot;</span><span class="content">analyzer</span><span class="delimiter">&quot;</span></span>: {
      <span class="key"><span class="delimiter">&quot;</span><span class="content">my_standard-english</span><span class="delimiter">&quot;</span></span>: {
        <span class="key"><span class="delimiter">&quot;</span><span class="content">type</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">standard</span><span class="delimiter">&quot;</span></span>,
        <span class="key"><span class="delimiter">&quot;</span><span class="content">stopwords</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">_english_</span><span class="delimiter">&quot;</span></span>
      },
      <span class="key"><span class="delimiter">&quot;</span><span class="content">my_analyzer_ngram</span><span class="delimiter">&quot;</span></span>: {
        <span class="key"><span class="delimiter">&quot;</span><span class="content">type</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">custom</span><span class="delimiter">&quot;</span></span>,
        <span class="key"><span class="delimiter">&quot;</span><span class="content">tokenizer</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">my_analyzer_ngram_tokenizer</span><span class="delimiter">&quot;</span></span>
      }
    },
    <span class="key"><span class="delimiter">&quot;</span><span class="content">tokenizer</span><span class="delimiter">&quot;</span></span>: {
      <span class="key"><span class="delimiter">&quot;</span><span class="content">my_analyzer_ngram_tokenizer</span><span class="delimiter">&quot;</span></span>: {
        <span class="key"><span class="delimiter">&quot;</span><span class="content">type</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">ngram</span><span class="delimiter">&quot;</span></span>,
        <span class="key"><span class="delimiter">&quot;</span><span class="content">min_gram</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">5</span><span class="delimiter">&quot;</span></span>,
        <span class="key"><span class="delimiter">&quot;</span><span class="content">max_gram</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">6</span><span class="delimiter">&quot;</span></span>
      }
    }
  }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The provided settings will be merged with those generated by Hibernate Search, including analyzer definitions.
When analysis is configured both through an <a href="#backend-elasticsearch-analysis-analyzers">analysis configurer</a> and these custom settings, the behavior is undefined; it should not be relied upon.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Custom index setting must be provided in the simplified form, the one without the attribute the <code>index</code> attribute.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="backend-elasticsearch-configuration-index-settings-max-result-window-size"><a class="anchor" href="#backend-elasticsearch-configuration-index-settings-max-result-window-size"></a>17.12.1. <a id="_max_result_window_size"></a> Max result window size</h4>
<div class="paragraph">
<p>If the setting <code>index.max_result_window</code> is used,
Hibernate Search will use this value to limit the returning hits size
if no limit has been defined on the query by the user.
In this case if Hibernate Search notices there are more results, a warning will be logged.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="backend-elasticsearch-threads"><a class="anchor" href="#backend-elasticsearch-threads"></a>17.13. Threads</h3>
<div class="paragraph">
<p>The Elasticsearch backend relies on an internal thread pool to orchestrate indexing requests (add/update/delete)
and to schedule request timeouts.</p>
</div>
<div class="paragraph">
<p>By default, the pool contains exactly as many threads as the number of processors available to the JVM on bootstrap.
That can be changed using a configuration property:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>hibernate.search.backend.thread_pool.size = 4</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This number is <em>per backend</em>, not per index.
Adding more indexes will not add more threads.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>As all operations happening in this thread-pool are non-blocking,
raising its size above the number of processor cores available to the JVM will not bring
noticeable performance benefits.</p>
</div>
<div class="paragraph">
<p>The only reason to alter this setting would be to reduce the number of threads;
for example, in an application with a single index with a single indexing queue,
running on a machine with 64 processor cores,
you might want to bring down the number of threads.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="backend-elasticsearch-indexing-queues"><a class="anchor" href="#backend-elasticsearch-indexing-queues"></a>17.14. Indexing queues</h3>
<div class="paragraph">
<p>Among all the requests sent by Hibernate Search to Elasticsearch,
it is expected that there will be a lot of "indexing" requests to create/update/delete a specific document.
Sending these requests one by one would be inefficient (mainly because of network latency).
Also, we generally want to preserve the relative order of these requests
when they are about the same documents.</p>
</div>
<div class="paragraph">
<p>For these reasons, Hibernate Search pushes these requests to ordered queues
and relies on the <a href="https://www.elastic.co/guide/en/elasticsearch/reference/8.13/docs-bulk.html">Bulk API</a> to send them in batches.
Each index maintains 10 queues holding at most 1000 elements each,
and each queue will send bulk requests of at most 100 indexing requests.
Queues operate independently (in parallel), but each queue sends one bulk request after the other,
so at any given time there can be at most 10 bulk requests being sent for each index.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Indexing operations relative to the same document ID are always pushed to the same queue.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>It is possible to customize the queues in order to reduce the load on the Elasticsearch server,
or on the contrary to improve throughput.
This is done through the following configuration properties:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code># To configure the defaults for all indexes:
hibernate.search.backend.indexing.queue_count = 10
hibernate.search.backend.indexing.queue_size = 1000
hibernate.search.backend.indexing.max_bulk_size = 100
# To configure a specific index:
hibernate.search.backend.indexes.&lt;index-name&gt;.indexing.queue_count = 10
hibernate.search.backend.indexes.&lt;index-name&gt;.indexing.queue_size = 1000
hibernate.search.backend.indexes.&lt;index-name&gt;.indexing.max_bulk_size = 100</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>indexing.queue_count</code> defines the number of queues.
Expects a strictly positive integer value.
The default for this property is <code>10</code>.</p>
<div class="paragraph">
<p>Higher values will lead to more connections being used in parallel,
which may lead to higher indexing throughput,
but incurs a risk of <a href="#backend-elasticsearch-indexing-queues-circuit-breaker">overloading Elasticsearch</a>,
leading to Elasticsearch giving up on some requests and resulting in indexing failures.</p>
</div>
</li>
<li>
<p><code>indexing.queue_size</code> defines the maximum number of elements each queue can hold.
Expects a strictly positive integer value.
The default for this property is <code>1000</code>.</p>
<div class="paragraph">
<p>Lower values may lead to lower memory usage, especially if there are many queues,
but values that are too low will reduce the likeliness of reaching the max bulk size
and increase the likeliness of <a href="#backend-elasticsearch-indexing-queues-blocking">application threads blocking</a>
because the queue is full,
which may lead to lower indexing throughput.</p>
</div>
</li>
<li>
<p><code>indexing.max_bulk_size</code> defines the maximum number of indexing requests in each bulk request.
Expects a strictly positive integer value.
The default for this property is <code>100</code>.</p>
<div class="paragraph">
<p>Higher values will lead to more documents being sent in each HTTP request sent to Elasticsearch,
which may lead to higher indexing throughput,
but incurs a risk of <a href="#backend-elasticsearch-indexing-queues-circuit-breaker">overloading Elasticsearch</a>,
leading to Elasticsearch giving up on some requests and resulting in indexing failures.</p>
</div>
<div class="paragraph">
<p>Note that raising this number above the queue size has no effect,
as bulks cannot include more requests than are contained in the queue.</p>
</div>
</li>
</ul>
</div>
<div id="backend-elasticsearch-indexing-queues-blocking" class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>When a queue is full, any attempt to request indexing will block until the request can be put into the queue.</p>
</div>
<div class="paragraph">
<p>In order to achieve a reasonable level of performance,
be sure to set the size of queues to a high enough number that this kind of blocking only happens
when the application is under very high load.</p>
</div>
</td>
</tr>
</table>
</div>
<div id="backend-elasticsearch-indexing-queues-circuit-breaker" class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Elasticsearch nodes can only handle so many parallel requests,
and in particular they <a href="https://www.elastic.co/guide/en/elasticsearch/reference/8.13/circuit-breaker.html">limit the amount of memory</a>
available to store all pending requests at any given time.</p>
</div>
<div class="paragraph">
<p>In order to avoid indexing failures, avoid using overly large numbers
for the number of queues and the maximum bulk size,
especially if you expect your index to hold large documents.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="backend-elasticsearch-io"><a class="anchor" href="#backend-elasticsearch-io"></a>17.15. Writing and reading</h3>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>For a preliminary introduction to writing to and reading from indexes in Hibernate Search,
including in particular the concepts of <em>commit</em> and <em>refresh</em>,
see <a href="#concepts-commit-refresh">Commit and refresh</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="backend-elasticsearch-io-commit"><a class="anchor" href="#backend-elasticsearch-io-commit"></a>17.15.1. Commit</h4>
<div class="paragraph">
<p>When writing to indexes, Elasticsearch relies on a <a href="https://www.elastic.co/guide/en/elasticsearch/reference/8.13/index-modules-translog.html">transaction log</a>
to make sure that changes, even uncommitted, are always safe as soon as the REST API call returns.</p>
</div>
<div class="paragraph">
<p>For that reason, the concept of "commit" is not as important to the Elasticsearch backend,
and commit requirements are largely irrelevant.</p>
</div>
</div>
<div class="sect3">
<h4 id="backend-elasticsearch-io-refresh"><a class="anchor" href="#backend-elasticsearch-io-refresh"></a>17.15.2. Refresh</h4>
<div class="paragraph">
<p>When reading from indexes, Elasticsearch relies on a periodically refreshed index reader,
meaning that search queries will return slightly out-of-date results,
unless a refresh was forced:
this is called <a href="https://www.elastic.co/guide/en/elasticsearch/reference/8.13/getting-started-concepts.html#_near_realtime_nrt">near-real-time</a> behavior.</p>
</div>
<div class="paragraph">
<p>By default, the index reader is refreshed every second,
but this can be customized on the Elasticsearch side through index settings:
see the <code>refresh_interval</code> setting on <a href="https://www.elastic.co/guide/en/elasticsearch/reference/8.13/index-modules.html">this page</a>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="backend-elasticsearch-search"><a class="anchor" href="#backend-elasticsearch-search"></a>17.16. Searching</h3>
<div class="paragraph">
<p>Searching with the Elasticsearch backend relies on the <a href="#search-dsl">same APIs as any other backend</a>.</p>
</div>
<div class="paragraph">
<p>This section details Elasticsearch-specific configuration related to searching.</p>
</div>
<div class="sect3">
<h4 id="backend-elasticsearch-search-scroll-timeout"><a class="anchor" href="#backend-elasticsearch-search-scroll-timeout"></a>17.16.1. Scroll timeout</h4>
<div class="paragraph">
<p>With the Elasticsearch backend, <a href="#search-dsl-query-fetching-results-scrolling">scrolls</a> are subject to timeout.
If <code>next()</code> is not called for a long period of time (default: 60 seconds),
the scroll will be closed automatically and the next call to <code>next()</code> will fail.</p>
</div>
<div class="paragraph">
<p>Use the following configuration property at the backend level to configure the timeout (in seconds):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>hibernate.search.backend.scroll_timeout = 60</code></pre>
</div>
</div>
<div class="paragraph">
<p>The default for this property is <code>60</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="backend-elasticsearch-search-ignore-partial-shard-failure"><a class="anchor" href="#backend-elasticsearch-search-ignore-partial-shard-failure"></a>17.16.2. Partial shard failure</h4>
<div class="paragraph">
<p>With the Elasticsearch backend, <a href="#search-dsl-query-fetching-results">fetching results</a> may result in partial shard failures,
i.e. some of the shards will fail to produce results while the others will succeed.
In such situations, an Elasticsearch cluster will produce a response with a successful status code, but will contain additional
information on failed shards, and the reason they have failed.</p>
</div>
<div class="paragraph">
<p>By default, Hibernate Search will check if any shards have failed while fetching the results and if so&#8201;&#8212;&#8201;will throw an exception.</p>
</div>
<div class="paragraph">
<p>Use the following configuration property at the backend level to change the default behaviour:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>hibernate.search.backend.query.shard_failure.ignore = true</code></pre>
</div>
</div>
<div class="paragraph">
<p>The default for this property is <code>false</code>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="backend-elasticsearch-access-client"><a class="anchor" href="#backend-elasticsearch-access-client"></a>17.17. <a id="elasticsearch-client-access"></a> Retrieving the REST client</h3>
<div class="paragraph">
<p>When writing complex applications with advanced requirements,
it may be necessary from time to time to send requests to the Elasticsearch cluster directly,
in particular if Hibernate Search does not support this kind of requests out of the box.</p>
</div>
<div class="paragraph">
<p>To that end, you can retrieve the Elasticsearch backend,
then get access the Elasticsearch client used by Hibernate Search internally.
See below for an example.</p>
</div>
<div class="exampleblock">
<div class="title">Example 423. Accessing the low-level REST client</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">SearchMapping mapping = <span class="comment">/* ... */</span> <i class="conum" data-value="1"></i><b>(1)</b>
Backend backend = mapping.backend(); <i class="conum" data-value="2"></i><b>(2)</b>
ElasticsearchBackend elasticsearchBackend = backend.unwrap( ElasticsearchBackend.class ); <i class="conum" data-value="3"></i><b>(3)</b>
RestClient client = elasticsearchBackend.client( RestClient.class ); <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><a href="#entrypoints-search-mapping">Retrieve the <code>SearchMapping</code></a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Retrieve the <code>Backend</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Narrow down the backend to the <code>ElasticsearchBackend</code> type.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Get the client, passing the expected type of the client as an argument.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The client itself is not part of the Hibernate Search API,
but of the
<a href="https://www.elastic.co/guide/en/elasticsearch/reference/8.13/index-modules.html#_static_index_settings">official Elasticsearch REST client API</a>.</p>
</div>
<div class="paragraph">
<p>Hibernate Search may one day switch to another client with a different Java type,
without prior notice.
If that happens, the snippet of code above will throw an exception.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="coordination"><a class="anchor" href="#coordination"></a>18. Coordination</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="coordination-basics"><a class="anchor" href="#coordination-basics"></a>18.1. Basics</h3>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Coordination is a complex topic,
and the problems it solves may appear unclear at first sight.
You may find it easier to approach coordination from a higher level.</p>
</div>
<div class="paragraph">
<p>For a few example architectures involving different coordination strategies
and a summary of the differences between each architecture,
see <a href="#architecture-examples"> Examples of architectures</a>.</p>
</div>
<div class="paragraph">
<p>For a summary of the differences between coordination strategies
specifically in the context of listener-triggered indexing,
see <a href="#listener-triggered-indexing-concepts"> Basics</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>An application using Hibernate Search usually relies on multiple threads,
or even multiple application instances,
which will update the database concurrently.</p>
</div>
<div class="paragraph">
<p>The coordination strategy defines how these threads/nodes will coordinate with each other
in order to update indexes according to these database updates,
in a way that ensures consistency,
prevents data loss,
and optimizes performance.</p>
</div>
<div class="paragraph">
<p>This strategy is set through configuration properties:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>hibernate.search.coordination.strategy = outbox-polling</code></pre>
</div>
</div>
<div class="paragraph">
<p>The default for this property is <code>none</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Coordination strategies are only available for the integration to Hibernate ORM.</p>
</div>
<div class="paragraph">
<p>See <a href="#mapper-pojo-standalone-coordination">this section</a> for information about
coordination in the Standalone POJO mapper.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>See the following subsections for details about available strategies.</p>
</div>
</div>
<div class="sect2">
<h3 id="coordination-none"><a class="anchor" href="#coordination-none"></a>18.2. No coordination</h3>
<div class="sect3">
<h4 id="coordination-none-basics"><a class="anchor" href="#coordination-none-basics"></a>18.2.1. Basics</h4>
<div class="paragraph">
<p>The default strategy is the simplest and does not involve any additional infrastructure
for communication between application nodes.</p>
</div>
<div class="paragraph">
<p>All <a href="#architecture-hsearch-indexing">explicit or listener-triggered indexing</a> operations
are executed directly in application threads,
which gives this strategy the unique ability to provide <a href="#indexing-plan-synchronization">synchronous indexing</a>,
at the cost of a few limitations:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#limitations-parallel-embedded-update">Without coordination, in rare cases, indexing involving <code>@IndexedEmbedded</code> may lead to out-of sync indexes</a></p>
</li>
<li>
<p><a href="#limitations-backend-indexing-error">Without coordination, backend errors during indexing may lead to out-of sync indexes</a></p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Coordination is a complex topic,
and the problems it solves may appear unclear at first sight.
You may find it easier to approach coordination from a higher level.</p>
</div>
<div class="paragraph">
<p>For a few example architectures involving different coordination strategies
and a summary of the differences between each architecture,
see <a href="#architecture-examples"> Examples of architectures</a>.</p>
</div>
<div class="paragraph">
<p>For a summary of the differences between coordination strategies
specifically in the context of listener-triggered indexing,
see <a href="#listener-triggered-indexing-concepts"> Basics</a>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="coordination-none-indexing"><a class="anchor" href="#coordination-none-indexing"></a>18.2.2. How indexing works without coordination</h4>
<div id="coordination-none-indexing-detected-changes" class="dlist">
<dl>
<dt class="hdlist1">Changes have to occur in the ORM session in order to trigger <a href="#listener-triggered-indexing">indexing listeners</a></dt>
<dd>
<p>See <a href="#indexing-automatic-concepts-changes-in-session"> In-session entity change detection and limitations</a> for more details.</p>
</dd>
</dl>
</div>
<div id="coordination-none-indexing-association-consistency" class="dlist">
<dl>
<dt class="hdlist1">Associations must be updated on both sides</dt>
<dd>
<p>See <a href="#limitations-changes-asymmetric-association-updates"> Listener-triggered indexing ignores asymmetric association updates</a> for more details.</p>
</dd>
</dl>
</div>
<div id="coordination-none-indexing-change-filter" class="dlist">
<dl>
<dt class="hdlist1">Only relevant changes trigger indexing</dt>
<dd>
<p>See <a href="#indexing-automatic-concepts-dirty-checking"> Dirty checking</a> for more details.</p>
</dd>
</dl>
</div>
<div id="coordination-none-indexing-on-flush" class="dlist">
<dl>
<dt class="hdlist1">Entity data is extracted from entities upon session flushes or <code>SearchSession.close()</code></dt>
<dd>
<p><a id="mapper-orm-indexing-automatic-concepts-extraction-on-flush"></a> When a Hibernate ORM session is flushed,
or (with the <a href="#mapper-pojo-standalone">Standalone POJO Mapper</a>) when <code>SearchSession.close()</code> is called,
Hibernate Search will extract data from the entities
to build documents to index,
and will put these documents in an internal buffer for
<a href="#coordination-none-indexing-guarantee">later indexing</a>.
This extraction <a href="#coordination-none-indexing-lazy-loading">may involve loading extra data from the database</a>.</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>With the <a href="#mapper-orm">Hibernate ORM integration</a>,
the fact that this internal buffer is populated on Hibernate ORM session flush
means that you can safely <code>clear()</code> the session after a <code>flush()</code>:
entity changes performed up to the flush will be indexed correctly.</p>
</div>
<div class="paragraph">
<p>If you come from Hibernate Search 5 or earlier,
you may see this as a significant improvement:
there is no need to call <code>flushToIndexes()</code> and update indexes in the middle of a transaction anymore,
except for larger volumes of data (see <a href="#mapper-orm-indexing-manual-indexingplan-process-execute"> Hibernate ORM and the periodic "flush-clear" pattern with <code>SearchIndexingPlan</code></a>).</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>However, if you perform a batch process inside a transaction with the <a href="#mapper-orm">Hibernate ORM integration</a>,
and call <code>session.flush()</code>/<code>session.clear()</code> regularly to save memory,
be aware that Hibernate Search&#8217;s internal buffer holding documents to index
will grow on each flush, and will not be cleared until the transaction is committed or rolled back.
If you encounter memory issues because of that,
see <a href="#mapper-orm-indexing-manual-indexingplan-process-execute"> Hibernate ORM and the periodic "flush-clear" pattern with <code>SearchIndexingPlan</code></a> for a few solutions.</p>
</div>
</dd>
</dl>
</div>
<div id="coordination-none-indexing-lazy-loading" class="dlist">
<dl>
<dt class="hdlist1">Extraction of entity data may fetch extra data from the database</dt>
<dd>
<p><a id="mapper-orm-indexing-automatic-concepts-indexing-triggers-lazy-loading"></a> Even when you change only a single property of an indexed entity,
if that property is indexed,
Hibernate Search needs to rebuild the corresponding document <strong>in full</strong>.</p>
<div class="paragraph">
<p>Hibernate Search tries to only load what is necessary for indexing,
but depending on your mapping, this may lead to lazy associations being loaded just to reindex entities,
even if you didn&#8217;t need them in your business code,
which may represent an overhead for your application threads
as well as your database.</p>
</div>
<div class="paragraph">
<p>With the <a href="#mapper-orm">Hibernate ORM integration</a>, this extra cost can be mitigated to some extent by:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>leveraging Hibernate ORM&#8217;s batch fetching:
see <a href="https://docs.jboss.org/hibernate/orm/6.4/userguide/html_single/Hibernate_User_Guide.html#settings-hibernate.default_batch_fetch_size">the <code>batch_fetch_size</code> property</a>
and <a href="https://docs.jboss.org/hibernate/orm/6.4/userguide/html_single/Hibernate_User_Guide.html#fetching-batch">the <code>@BatchSize</code> annotation</a>.</p>
</li>
<li>
<p>leveraging Hibernate ORM&#8217;s <a href="https://docs.jboss.org/hibernate/orm/6.4/userguide/html_single/Hibernate_User_Guide.html#caching">second-level cache</a>,
especially for immutable entities referenced from indexed entities
(e.g. for reference data such as countries, cities, &#8230;&#8203;).</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div id="coordination-none-indexing-guarantee" class="dlist">
<dl>
<dt class="hdlist1">Indexing is not guaranteed on commit, but only after the application thread returns</dt>
<dd>
<p><a id="mapper-orm-indexing-automatic-concepts-transaction-commit"></a> When entity changes happen inside a transaction,
indexes are not updated immediately, but only after the transaction is successfully committed.
That way, if a transaction is rolled back, the indexes will be left in a state consistent with the database,
discarding all the index changes that were planned during the transaction.</p>
<div class="paragraph">
<p>Similarly, when using the <a href="#mapper-pojo-standalone">Standalone POJO Mapper</a>,
indexes are guaranteed to be updated after <code>SearchSession.close()</code> returns.</p>
</div>
<div class="paragraph">
<p>However, if an error occurs in the backend while indexing,
this behavior means that <a href="#limitations-backend-indexing-error">index changes may be lost, leading to out-of-sync indexes</a>.
If this is a problem for you, you should consider switching to <a href="#coordination-outbox-polling">another coordination strategy</a>.</p>
</div>
<div id="mapper-orm-indexing-automatic-concepts-notransaction-flush" class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
With the <a href="#mapper-orm">Hibernate ORM integration</a>,
when entity changes happen outside any transaction (not recommended),
indexes are updated immediately upon session <code>flush()</code>.
Without that flush, indexes will not be updated automatically.
</td>
</tr>
</table>
</div>
</dd>
</dl>
</div>
<div id="coordination-none-indexing-visibility" class="dlist">
<dl>
<dt class="hdlist1">Index changes may not be visible immediately</dt>
<dd>
<p><a id="mapper-orm-indexing-automatic-concepts-nearrealtime"></a> By default, indexing will resume the application thread after index changes are committed to the indexes.
This means index changes are safely stored to disk,
but this does not mean a search query ran immediately after indexing will take the changes into account:
when using the Elasticsearch backend in particular, changes may take some time to be visible from search queries.</p>
<div class="paragraph">
<p>See <a href="#indexing-plan-synchronization">  Synchronization with the indexes</a> for details.</p>
</div>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect2">
<h3 id="coordination-outbox-polling"><a class="anchor" href="#coordination-outbox-polling"></a>18.3. <a id="coordination-database-polling"></a> <code>outbox-polling</code>: additional event tables and polling in background processors</h3>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Features detailed below are <em>incubating</em>: they are still under active development.</p>
</div>
<div class="paragraph">
<p>The usual <a href="https://hibernate.org/community/compatibility-policy/">compatibility policy</a> does not apply:
the contract of incubating elements (e.g. types, methods, configuration properties, etc.)
may be altered in a backward-incompatible way&#8201;&#8212;&#8201;or even removed&#8201;&#8212;&#8201;in subsequent releases.</p>
</div>
<div class="paragraph">
<p>You are encouraged to use incubating features so the development team can get feedback and improve them,
but you should be prepared to update code which relies on them as needed.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="coordination-outbox-polling-basics"><a class="anchor" href="#coordination-outbox-polling-basics"></a>18.3.1. <a id="coordination-database-polling-basics"></a> Basics</h4>
<div class="paragraph">
<p>The <code>outbox-polling</code> strategy implements coordination through
<a href="#coordination-outbox-polling-schema">additional tables</a> in the application database.</p>
</div>
<div class="paragraph">
<p><a href="#architecture-hsearch-indexing">Explicit and listener-triggered indexing</a> are implemented
by pushing events to an outbox table within the same transaction as the entity changes,
and polling this outbox table from background processors which perform indexing.</p>
</div>
<div class="paragraph">
<p>This strategy is able to provide guarantees that entities will be indexed regardless
of temporary I/O errors in backend,
at the cost of being only able to perform this indexing asynchronously.</p>
</div>
<div class="paragraph">
<p>The <code>outbox-polling</code> strategy can be enabled with the following settings:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>hibernate.search.coordination.strategy = outbox-polling</code></pre>
</div>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If <a href="https://docs.jboss.org/hibernate/orm/6.4/userguide/html_single/Hibernate_User_Guide.html#configurations-multi-tenancy">multi-tenancy</a> is enabled,
you will need extra configuration.</p>
</div>
<div class="paragraph">
<p>See <a href="#coordination-outbox-polling-multi-tenancy">Multi-tenancy</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You will also need to add this dependency:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="XML"><span class="tag">&lt;dependency&gt;</span>
   <span class="tag">&lt;groupId&gt;</span>org.hibernate.search<span class="tag">&lt;/groupId&gt;</span>
   <span class="tag">&lt;artifactId&gt;</span>hibernate-search-mapper-orm-outbox-polling<span class="tag">&lt;/artifactId&gt;</span>
   <span class="tag">&lt;version&gt;</span>7.1.2.Final<span class="tag">&lt;/version&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Coordination is a complex topic,
and the problems it solves may appear unclear at first sight.
You may find it easier to approach coordination from a higher level.</p>
</div>
<div class="paragraph">
<p>For a few example architectures involving different coordination strategies
and a summary of the differences between each architecture,
see <a href="#architecture-examples"> Examples of architectures</a>.</p>
</div>
<div class="paragraph">
<p>For a summary of the differences between coordination strategies
specifically in the context of listener-triggered indexing,
see <a href="#listener-triggered-indexing-concepts"> Basics</a>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="coordination-outbox-polling-indexing"><a class="anchor" href="#coordination-outbox-polling-indexing"></a>18.3.2. <a id="coordination-database-polling-indexing"></a> How indexing works with <code>outbox-polling</code> coordination</h4>
<div id="coordination-outbox-polling-indexing-detected-changes" class="dlist">
<dl>
<dt class="hdlist1">Changes have to occur in the ORM session in order to trigger <a href="#listener-triggered-indexing">indexing listeners</a></dt>
<dd>
<p>See <a href="#indexing-automatic-concepts-changes-in-session"> In-session entity change detection and limitations</a> for more details.</p>
</dd>
</dl>
</div>
<div id="coordination-outbox-polling-indexing-association-consistency" class="dlist">
<dl>
<dt class="hdlist1">Associations must be updated on both sides</dt>
<dd>
<p>See <a href="#limitations-changes-asymmetric-association-updates"> Listener-triggered indexing ignores asymmetric association updates</a> for more details.</p>
</dd>
</dl>
</div>
<div id="coordination-outbox-polling-indexing-change-filter" class="dlist">
<dl>
<dt class="hdlist1">Only relevant changes trigger indexing</dt>
<dd>
<p>See <a href="#indexing-automatic-concepts-dirty-checking"> Dirty checking</a> for more details.</p>
</dd>
</dl>
</div>
<div id="coordination-outbox-polling-indexing-background" class="dlist">
<dl>
<dt class="hdlist1">Indexing happens in a background thread</dt>
<dd>
<p>When a Hibernate ORM session is flushed,
Hibernate Search will persist entity change events within the same Hibernate ORM session and the same transaction.</p>
<div class="paragraph">
<p>An <a href="#coordination-outbox-polling-event-processor">event processor</a> polls the database for new entity change events,
and asynchronously performs reindexing of the appropriate entities when it finds new events
(i.e. after the transaction is committed).</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The fact that events are persisted on session flush
means that you can safely <code>clear()</code> the session after a <code>flush()</code>:
entity changes events detected up to the flush will be persisted correctly.</p>
</div>
<div class="paragraph">
<p>If you come from Hibernate Search 5 or earlier,
you may see this as a significant improvement:
there is no need to call <code>flushToIndexes()</code> and update indexes in the middle of a transaction anymore.</p>
</div>
</td>
</tr>
</table>
</div>
</dd>
</dl>
</div>
<div id="coordination-outbox-polling-indexing-full-loading" class="dlist">
<dl>
<dt class="hdlist1">The background processor will completely reload entities from the database</dt>
<dd>
<p>The background processor responsible for reindexing entities
does not have access to the state of the <a href="https://docs.jboss.org/hibernate/orm/6.4/userguide/html_single/Hibernate_User_Guide.html#best-practices-caching">first level cache</a>
when the entity change occurred, because it occurred in a different session.</p>
<div class="paragraph">
<p>This means each time an entity changes and has to be re-indexed,
the background process will load that entity in full.
Depending on your mapping, it may also need to load lazy associations to other entities.</p>
</div>
<div class="paragraph">
<p>This extra cost can be mitigated to some extent by:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>leveraging Hibernate ORM&#8217;s batch fetching;
see <a href="https://docs.jboss.org/hibernate/orm/6.4/userguide/html_single/Hibernate_User_Guide.html#settings-hibernate.default_batch_fetch_size">the <code>batch_fetch_size</code> property</a>
and <a href="https://docs.jboss.org/hibernate/orm/6.4/userguide/html_single/Hibernate_User_Guide.html#fetching-batch">the <code>@BatchSize</code> annotation</a>.</p>
</li>
<li>
<p>leveraging Hibernate ORM&#8217;s <a href="https://docs.jboss.org/hibernate/orm/6.4/userguide/html_single/Hibernate_User_Guide.html#caching">second-level cache</a>,
especially for immutable entities referenced from indexed entities
(e.g. for reference data such as countries, cities, &#8230;&#8203;).</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div id="coordination-outbox-polling-indexing-guarantee" class="dlist">
<dl>
<dt class="hdlist1">Indexing is guaranteed on transaction commit</dt>
<dd>
<p>When entity changes happen inside a transaction,
Hibernate Search will persist entity change events within the same transaction.</p>
<div class="paragraph">
<p>If the transaction is committed, these events will be committed as well;
if it rolls back, the events will be rolled back as well.
This guarantees the events will eventually be processed by a background thread
and that the indexes will be updated accordingly,
but only when (if) the transaction succeeds.</p>
</div>
<div id="coordination-outbox-polling-indexing-guarantee-notransaction" class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
When entity changes happen outside any transaction (not recommended),
events indexes are sent immediately after the session <code>flush()</code>.
Without that flush, indexes will not be updated automatically.
</td>
</tr>
</table>
</div>
</dd>
</dl>
</div>
<div id="coordination-outbox-polling-indexing-visibility" class="dlist">
<dl>
<dt class="hdlist1">Index changes will not be visible immediately</dt>
<dd>
<p>By default, the application thread will resume after entity change events are committed to the database.
This means these changes are safely stored to disk,
but this does not mean a search query ran immediately when the thread resumes will take the changes into account:
<a href="#coordination-outbox-polling-indexing-background">indexing will happen at a later time, asynchronously, in a background processor</a>.</p>
<div class="paragraph">
<p>You can <a href="#coordination-outbox-polling-event-processor">configure this event processor</a> to run more often,
but it will remain asynchronous.</p>
</div>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="coordination-outbox-polling-schema"><a class="anchor" href="#coordination-outbox-polling-schema"></a>18.3.3. <a id="coordination-database-polling-schema"></a> Impact on the database schema</h4>
<div class="sect4">
<h5 id="_basics"><a class="anchor" href="#_basics"></a>Basics</h5>
<div class="paragraph">
<p>The <code>outbox-polling</code> coordination strategy needs to store data in additional tables in the application database,
so that this data can be consumed by background threads.</p>
</div>
<div class="paragraph">
<p>This includes in particular an outbox table, to which one row (representing a change event) is pushed every time an entity is changed
in a way that requires reindexing.</p>
</div>
<div class="paragraph">
<p>This also includes an agent table, where Hibernate Search registers every background event processor
in order to <a href="#coordination-outbox-polling-sharding">dynamically assign shards</a> to each application instance,
or simply to check that <a href="#coordination-outbox-polling-sharding">statically assigned shards</a>
are consistent.</p>
</div>
<div class="paragraph">
<p>These tables are accessed through entities that are automatically added to the Hibernate ORM configuration,
and as such they should be automatically generated when relying on Hibernate ORM&#8217;s
<a href="https://docs.jboss.org/hibernate/orm/6.4/userguide/html_single/Hibernate_User_Guide.html#configurations-hbmddl">automatic schema generation</a>.</p>
</div>
<div class="paragraph">
<p>If you need to integrate the creation/dropping of these tables to your own script,
the easiest solution is to have Hibernate ORM generate DDL scripts for your whole schema
and copy everything related to constructs (tables, sequences, &#8230;&#8203;) prefixed with <code>HSEARCH_</code>.
See <a href="https://docs.jboss.org/hibernate/orm/6.4/userguide/html_single/Hibernate_User_Guide.html#configurations-hbmddl">automatic schema generation</a>,
in particular the Hibernate ORM properties <code>javax.persistence.schema-generation.scripts.action</code>,
<code>javax.persistence.schema-generation.scripts.create-target</code>
and <code>javax.persistence.schema-generation.scripts.drop-target</code>.</p>
</div>
</div>
<div class="sect4">
<h5 id="_custom_schematable_nameetc"><a class="anchor" href="#_custom_schematable_nameetc"></a>Custom schema/table name/etc.</h5>
<div class="paragraph">
<p>By default, outbox and agent tables, mentioned in the previous section, are expected to be found
in the default catalog/schema, and are using uppercased table names prefixed with <code>HSEARCH_</code>.
Identity generator names used for these tables are prefixed with <code>HSEARCH_</code> and suffixed with <code>_GENERATOR</code>.</p>
</div>
<div class="paragraph">
<p>Sometimes there are specific naming conventions for database objects, or a need to separate the domain
and technical tables.
To allow some flexibility in this area, Hibernate Search provides a set of configuration properties
to specify catalog/schema/table names and a custom UUID generator strategy/data type
for outbox event and agent tables:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code># Configure the agent mapping:
hibernate.search.coordination.entity.mapping.agent.catalog=CUSTOM_CATALOG
hibernate.search.coordination.entity.mapping.agent.schema=CUSTOM_SCHEMA
hibernate.search.coordination.entity.mapping.agent.table=CUSTOM_AGENT_TABLE
hibernate.search.coordination.entity.mapping.agent.uuid_gen_strategy=time
hibernate.search.coordination.entity.mapping.agent.uuid_type=BINARY
# Configure the outbox event mapping:
hibernate.search.coordination.entity.mapping.outboxevent.catalog=CUSTOM_CATALOG
hibernate.search.coordination.entity.mapping.outboxevent.schema=CUSTOM_SCHEMA
hibernate.search.coordination.entity.mapping.outboxevent.table=CUSTOM_OUTBOX_TABLE
hibernate.search.coordination.entity.mapping.outboxevent.uuid_gen_strategy=time
hibernate.search.coordination.entity.mapping.outboxevent.uuid_type=BINARY</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>agent.catalog</code> defines the database catalog to use for the agent table.</p>
<div class="paragraph">
<p>Defaults to the default catalog configured in Hibernate ORM.</p>
</div>
</li>
<li>
<p><code>agent.schema</code> defines the database schema to use for the agent table.</p>
<div class="paragraph">
<p>Defaults to the default schema configured in Hibernate ORM.</p>
</div>
</li>
<li>
<p><code>agent.table</code> defines the name of the agent table.</p>
<div class="paragraph">
<p>Defaults to <code>HSEARCH_AGENT</code>.</p>
</div>
</li>
<li>
<p><code>agent.uuid_gen_strategy</code> defines name of the UUID generator strategy used for the agent table. Available
options are <code>auto</code>/<code>random</code>/<code>time</code>. <code>auto</code> is a default and is the same as <code>random</code> which uses <code>UUID#randomUUID()</code>.
<code>time</code> is an IP based strategy consistent with IETF RFC 4122.</p>
<div class="paragraph">
<p>Defaults to <code>auto</code>.</p>
</div>
</li>
<li>
<p><code>agent.uuid_type</code> defines <a href="https://docs.jboss.org/hibernate/orm/6.4/javadocs/org/hibernate/type/SqlTypes.html">the name of the Hibernate <code>SqlType</code></a>
used for representing an UUID in the agent table. Hibernate Search provides a special <code>default</code> option that is going to
be used by default and will result into one of <code>UUID</code>/<code>BINARY</code>/<code>CHAR</code> depending on the database in use.
While currently Hibernate Search will use the dialect&#8217;s default <a href="https://docs.jboss.org/hibernate/orm/6.4/userguide/html_single/Hibernate_User_Guide.html#basic-uuid">representation of the UUID</a> in the database,
it is not a guarantee. If a specific type is required, it is best to provide it explicitly via this property.
Please refer to <a href="https://docs.jboss.org/hibernate/orm/6.4/javadocs/org/hibernate/type/SqlTypes.html">SqlTypes</a> to see
the list of available type codes supported by Hibernate ORM.
The SQL type code can be passed as a name of a corresponding constant in <code>org.hibernate.type.SqlTypes</code> or as an integer value.</p>
<div class="paragraph">
<p>Defaults to <code>default</code>.</p>
</div>
</li>
<li>
<p><code>outboxevent.catalog</code> defines the database catalog to use for the outbox event table.</p>
<div class="paragraph">
<p>Defaults to the default catalog configured in Hibernate ORM.</p>
</div>
</li>
<li>
<p><code>outboxevent.schema</code> defines the database schema to use for the outbox event table.</p>
<div class="paragraph">
<p>Defaults to the default schema configured in Hibernate ORM.</p>
</div>
</li>
<li>
<p><code>outboxevent.table</code> defines the name of the outbox events table.</p>
<div class="paragraph">
<p>Defaults to <code>HSEARCH_OUTBOX_EVENT</code>.</p>
</div>
</li>
<li>
<p><code>outboxevent.uuid_gen_strategy</code> defines name of the UUID generator strategy used for the outbox event table. Available
options are <code>auto</code>/<code>random</code>/<code>time</code>. <code>auto</code> is a default and is the same as <code>random</code> which uses <code>UUID#randomUUID()</code>.
<code>time</code> is an IP based strategy consistent with IETF RFC 4122.</p>
<div class="paragraph">
<p>Defaults to <code>auto</code>.</p>
</div>
</li>
<li>
<p><code>outboxevent.uuid_type</code> defines <a href="https://docs.jboss.org/hibernate/orm/6.4/javadocs/org/hibernate/type/SqlTypes.html">the name of the Hibernate <code>SqlType</code></a>
used for representing an UUID in the outbox event table. Hibernate Search provides a special <code>default</code> option that is going to
be used by default and will result into one of <code>UUID</code>/<code>BINARY</code>/<code>CHAR</code> depending on the database in use.
While currently Hibernate Search will use the dialect&#8217;s default <a href="https://docs.jboss.org/hibernate/orm/6.4/userguide/html_single/Hibernate_User_Guide.html#basic-uuid">representation of the UUID</a> in the database,
it is not a guarantee. If a specific type is required, it is best to provide it explicitly via this property.
Please refer to <a href="https://docs.jboss.org/hibernate/orm/6.4/javadocs/org/hibernate/type/SqlTypes.html">SqlTypes</a> to see
the list of available type codes supported by Hibernate ORM.
The SQL type code can be passed as a name of a corresponding constant in <code>org.hibernate.type.SqlTypes</code> or as an integer value.</p>
<div class="paragraph">
<p>Defaults to <code>default</code>.</p>
</div>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If your application relies on <a href="https://docs.jboss.org/hibernate/orm/6.4/userguide/html_single/Hibernate_User_Guide.html#configurations-hbmddl">automatic database schema generation</a>,
make sure that the underlying database supports catalogs/schemas
when specifying them. Also check if there are any constraints on name length and case sensitivity.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>It is not required to provide all properties at the same time. For example, you can customize the schema only.
Unspecified properties will use their defaults.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="coordination-outbox-polling-sharding"><a class="anchor" href="#coordination-outbox-polling-sharding"></a>18.3.4. <a id="coordination-database-polling-sharding"></a> <a id="coordination-outbox-polling-sharding-static"></a> <a id="coordination-outbox-polling-sharding-basics"></a> Sharding and pulse</h4>
<div class="paragraph">
<p>In order to avoid unnecessarily indexing the same entity multiple times on different application nodes,
Hibernate Search partitions the entities in what it calls "shards":</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Each entity belongs to exactly one shard.</p>
</li>
<li>
<p>Each application node involved in <a href="#coordination-outbox-polling-event-processor">event processing</a>
is uniquely assigned one or more shards, and will only process events related to entities in these shards.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In order to reliably assign shards,
Hibernate Search <a href="#coordination-outbox-polling-schema">adds an agent table to the database</a>,
and uses that table to register agents involved in indexing (most of the time, one application instance = one agent =
the <a href="#coordination-outbox-polling-event-processor">event processor</a>).
The registered agents form a cluster.</p>
</div>
<div class="paragraph">
<p>To make sure that agents are always assigned one shard,
and that one shard is never assigned to more than one agent,
each agent will periodically perform a "pulse",
updating and inspecting the agent table.</p>
</div>
<div class="paragraph">
<p>What happens during a pulse depends on the type of agent.
During a "pulse":</p>
</div>
<div class="ulist">
<ul>
<li>
<p>An <a href="#coordination-outbox-polling-event-processor">event processor</a> will:</p>
<div class="ulist">
<ul>
<li>
<p>update its own entry in the agent table, to let other agents knows it&#8217;s still active;</p>
</li>
<li>
<p>forcibly remove entries from other agents if it detects that these agents expired
(did not update their entry for a long time);</p>
</li>
<li>
<p>detect and report configuration mistakes
if using <a href="#coordination-outbox-polling-sharding">static sharding</a>,
e.g. two agents assigned to the same shard;</p>
</li>
<li>
<p>decide to suspend itself if a <a href="#coordination-outbox-polling-mass-indexer">mass indexer</a> is running;</p>
</li>
<li>
<p>trigger rebalancing as necessary if using <a href="#coordination-outbox-polling-event-processor-sharding">dynamic sharding</a>;
e.g. when it detects that new agents recently joined the cluster,
or that agents left the cluster (voluntarily or forcibly).</p>
</li>
</ul>
</div>
</li>
<li>
<p>A <a href="#coordination-outbox-polling-mass-indexer">mass indexer</a> will:</p>
<div class="ulist">
<ul>
<li>
<p>update its own entry in the agent table, to let other agents knows it&#8217;s still active;</p>
</li>
<li>
<p>forcibly remove entries from other agents if it detects that these agents expired
(did not update their entry for a long time);</p>
</li>
<li>
<p>switch to active waiting mode (frequent polling) if it notices some
<a href="#coordination-outbox-polling-event-processor">event processors</a> are still running;</p>
</li>
<li>
<p>switch to pulse-only mode (infrequent polling) and give the green light for mass indexing to start
if it notices no <a href="#coordination-outbox-polling-event-processor">event processors</a> are running anymore.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>For more details about dynamic and static sharding, see the following sections.</p>
</div>
</div>
<div class="sect3">
<h4 id="coordination-outbox-polling-event-processor"><a class="anchor" href="#coordination-outbox-polling-event-processor"></a>18.3.5. <a id="coordination-database-polling-processors"></a> Event processor</h4>
<div class="sect4">
<h5 id="coordination-outbox-polling-event-processor-basics"><a class="anchor" href="#coordination-outbox-polling-event-processor-basics"></a>Basics</h5>
<div class="paragraph">
<p>Among agents of the <code>outbox-polling</code> coordination strategy executing in the background,
the most important one is the event processor:
it polls the outbox table for events
and then re-indexes the corresponding entities when new events are found.</p>
</div>
<div class="paragraph">
<p>The event processor can be configured using the following configuration properties:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>hibernate.search.coordination.event_processor.enabled = true
hibernate.search.coordination.event_processor.polling_interval = 100
hibernate.search.coordination.event_processor.pulse_interval = 2000
hibernate.search.coordination.event_processor.pulse_expiration = 30000
hibernate.search.coordination.event_processor.batch_size = 50
hibernate.search.coordination.event_processor.transaction_timeout = 10
hibernate.search.coordination.event_processor.retry_delay = 15</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>event_processor.enabled</code> defines whether the event processor is enabled,
as a <a href="#configuration-property-types">boolean value</a>.
The default for this property is <code>true</code>, but it can be set to <code>false</code> to disable event processing on some application nodes,
for example to dedicate some nodes to HTTP request processing and other nodes to event processing.</p>
</li>
<li>
<p><code>event_processor.polling_interval</code> defines how long to wait for another query to the outbox events table
after a query didn&#8217;t return any event,
as an <a href="#configuration-property-types">integer value</a> in milliseconds.
The default for this property is <code>100</code>.</p>
<div class="paragraph">
<p>High values mean higher latency between an entity change and the corresponding update in the index,
but less stress on the database when there are no events to process.</p>
</div>
<div class="paragraph">
<p>Low values mean lower latency between an entity change and the corresponding update in the index,
but more stress on the database when there are no events to process.</p>
</div>
</li>
<li>
<p><code>event_processor.pulse_interval</code> defines how long the event processor can poll for events
before it must perform a "pulse",
as an <a href="#configuration-property-types">integer value</a> in milliseconds.
The default for this property is <code>2000</code>.</p>
<div class="paragraph">
<p>See <a href="#coordination-outbox-polling-sharding">the sharding basics</a> for information about "pulses".</p>
</div>
<div class="paragraph">
<p>The pulse interval must be set to a value between the polling interval (see above) and one third (1/3) of the expiration interval (see below).</p>
</div>
<div class="paragraph">
<p>Low values (closer to the polling interval) mean less time wasted not processing events
when a node joins or leaves the cluster,
and reduced risk of wasting time not processing events
because an event processor is incorrectly considered disconnected,
but more stress on the database because of more frequent checks of the list of agents.</p>
</div>
<div class="paragraph">
<p>High values (closer to the expiration interval) mean more time wasted not processing events
when a node joins or leaves the cluster,
and increased risk of wasting time not processing events
because an event processor is incorrectly considered disconnected,
but less stress on the database because of less frequent checks of the list of agents.</p>
</div>
</li>
<li>
<p><code>event_processor.pulse_expiration</code> defines how long an event processor "pulse" remains valid
before considering the processor disconnected and forcibly removing it from the cluster,
as an <a href="#configuration-property-types">integer value</a> in milliseconds.
The default for this property is <code>30000</code>.</p>
<div class="paragraph">
<p>See <a href="#coordination-outbox-polling-sharding">the sharding basics</a> for information about "pulses".</p>
</div>
<div class="paragraph">
<p>The expiration interval must be set to a value at least 3 times larger than the pulse interval (see above).</p>
</div>
<div class="paragraph">
<p>Low values (closer to the pulse interval) mean less time wasted not processing events
when a node abruptly leaves the cluster due to a crash or network failure,
but increased risk of wasting time not processing events
because an event processor is incorrectly considered disconnected.</p>
</div>
<div class="paragraph">
<p>High values (much larger than the pulse interval) mean more time wasted not processing events
when a node abruptly leaves the cluster due to a crash or network failure,
but reduced risk of wasting time not processing events
because an event processor is incorrectly considered disconnected.</p>
</div>
</li>
<li>
<p><code>event_processor.batch_size</code> defines how many outbox events, at most, are processed in a single transaction
as an <a href="#configuration-property-types">integer value</a>.
The default for this property is <code>50</code>.</p>
<div class="paragraph">
<p>High values mean a lower number of transactions opened by the background process
and may increase performance thanks to the first-level cache (persistence context),
but will increase memory usage and in extreme cases may lead to <code>OutOfMemoryErrors</code>.</p>
</div>
</li>
<li>
<p><code>event_processor.transaction_timeout</code> defines the timeout for transactions processing outbox events
as an <a href="#configuration-property-types">integer value</a> in seconds.</p>
<div class="paragraph">
<p>Only effective when a JTA transaction manager is configured.</p>
</div>
<div class="paragraph">
<p>When using JTA and this property is not set, Hibernate Search will use whatever default transaction timeout is configured in the JTA transaction manager.</p>
</div>
</li>
<li>
<p><code>event_processor.retry_delay</code> defines how long the event processor must wait before re-processing an event after its processing failed,
as a <a href="#configuration-property-types">positive integer value</a> in seconds.
The default for this property is <code>30</code>.</p>
<div class="paragraph">
<p>Use the value <code>0</code> to reprocess failed events as soon as possible, with no delay.</p>
</div>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="coordination-outbox-polling-event-processor-sharding"><a class="anchor" href="#coordination-outbox-polling-event-processor-sharding"></a><a id="coordination-database-polling-sharding-dynamic"></a> <a id="coordination-database-polling-sharding-static"></a> Sharding</h5>
<div class="paragraph">
<p>By default, <a href="#coordination-outbox-polling-sharding">sharding</a> is dynamic:
Hibernate Search registers each application instance in the database,
and uses that information to dynamically assign a single, unique shard to each application instance,
updating assignments as instances start or stop.
Dynamic sharding does not accept any configuration beyond the
<a href="#coordination-outbox-polling-event-processor-basics">basics</a>.</p>
</div>
<div class="paragraph">
<p>If you want to configure sharding explicitly, you can use static sharding
by setting the following configuration properties:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>hibernate.search.coordination.event_processor.shards.total_count = 4
hibernate.search.coordination.event_processor.shards.assigned = 0</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>shards.total_count</code> defines the total number of shards
as an <a href="#configuration-property-types">integer value</a>.
This property has no default and must be set explicitly if you want static sharding.
It must be set to the same value on all application nodes with assigned shards.
When this property is set, <code>shards.assigned</code> must also be set</p>
</li>
<li>
<p><code>shards.assigned</code> defines the shards assigned to the application node
as an <a href="#configuration-property-types">integer value</a>, or multiple comma-separated integer values.
This property has no default and must be set explicitly if you want static sharding.
When this property is set, <code>shards.total_count</code> must also be set.</p>
<div class="paragraph">
<p>Shards are referred to by an index in the range <code>[0, total_count - 1]</code> (see above for <code>total_count</code>).
A given application node must be assigned at least one shard
but may be assigned multiple shards by setting <code>shards.assigned</code> to a comma-separated list,
e.g. <code>0,3</code>.</p>
</div>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Each shard must be assigned to one and only one application node.</p>
</div>
<div class="paragraph">
<p>Event processing simply won&#8217;t start until every shard has exactly one node.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="exampleblock">
<div class="title">Example 424. Example of static sharding settings</div>
<div class="content">
<div class="paragraph">
<p>For example, the following configuration with 4 application nodes
would assign shard <code>0</code> to application node #0, shard <code>1</code> application node #1,
and no shard at all to application nodes #2 and #3:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code># Node #0
hibernate.search.coordination.strategy = outbox-polling
hibernate.search.coordination.event_processor.shards.total_count = 2
hibernate.search.coordination.event_processor.shards.assigned = 0</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code># Node #1
hibernate.search.coordination.strategy = outbox-polling
hibernate.search.coordination.event_processor.shards.total_count = 2
hibernate.search.coordination.event_processor.shards.assigned = 1</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code># Node #2
hibernate.search.coordination.strategy = outbox-polling
hibernate.search.coordination.event_processor.enabled = false</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code># Node #3
hibernate.search.coordination.strategy = outbox-polling
hibernate.search.coordination.event_processor.enabled = false</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="coordination-outbox-polling-event-processor-order"><a class="anchor" href="#coordination-outbox-polling-event-processor-order"></a>Processing order</h5>
<div class="paragraph">
<p>The order in which outbox events are processed can be tuned with a configuration property:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>hibernate.search.coordination.event_processor.order = auto</code></pre>
</div>
</div>
<div class="paragraph">
<p>Available options are:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>auto</code></dt>
<dd>
<p>The default value.</p>
<div class="paragraph">
<p>Picks the safest, most appropriate order based on the dialect and other settings:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>When using time-based UUIDs for outbox events (see <a href="#coordination-outbox-polling-schema"> Impact on the database schema</a>), picks <code>id</code>.</p>
</li>
<li>
<p>Otherwise, if using a Microsoft SQL Server dialect, picks <code>none</code>.</p>
</li>
<li>
<p>Otherwise, picks <code>time</code>.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1"><code>none</code></dt>
<dd>
<p>Process outbox events in no particular order.</p>
<div class="paragraph">
<p>This essentially means events will be consumed in a database-specific, undetermined order.</p>
</div>
<div class="paragraph">
<p>In setups with multiple event processors,
this reduces the rate of background failures caused by transaction deadlocks (in particular with Microsoft SQL Server),
which does not technically "fix" event processing (those failures are handled automatically by trying again anyway),
but may improve performance and reduce unnecessary noise in logs.</p>
</div>
<div class="paragraph">
<p>However, this may lead to situations where the processing of one particular event is continuously postponed
due to newer events being processed before that particular event,
which can be a problem in write-intensive scenarios where the event queue is never empty.</p>
</div>
</dd>
<dt class="hdlist1"><code>time</code></dt>
<dd>
<p>Process outbox events in "time" order, i.e. in the order events are created.</p>
<div class="paragraph">
<p>This ensures events are processed more or less in the order they were created
and avoids situations where the processing of one particular event is continuously postponed
due to newer events being processed before that particular event.</p>
</div>
<div class="paragraph">
<p>However, in setups with multiple event processors,
this may increase the rate of background failures caused by transaction deadlocks (in particular with Microsoft SQL Server),
which does not technically break event processing (those failures are handled automatically by trying again anyway),
but may reduce performance and lead to unnecessary noise in logs.</p>
</div>
</dd>
<dt class="hdlist1"><code>id</code></dt>
<dd>
<p>Process outbox events in identifier order.</p>
<div class="paragraph">
<p>If outbox event identifiers are time-based UUIDs (see <a href="#coordination-outbox-polling-schema"> Impact on the database schema</a>),
this behaves similarly to <code>time</code>, but without the risk of deadlocks.</p>
</div>
<div class="paragraph">
<p>If outbox event identifiers are random UUIDs (see <a href="#coordination-outbox-polling-schema"> Impact on the database schema</a>),
this behaves similarly to <code>none</code>.</p>
</div>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect3">
<h4 id="coordination-outbox-polling-mass-indexer"><a class="anchor" href="#coordination-outbox-polling-mass-indexer"></a>18.3.6. Mass indexer</h4>
<div class="sect4">
<h5 id="coordination-outbox-polling-mass-indexer-basics"><a class="anchor" href="#coordination-outbox-polling-mass-indexer-basics"></a>Basics</h5>
<div class="paragraph">
<p>During <a href="#indexing-massindexer">mass indexing</a>,
an application instance will exceptionally bypass <a href="#coordination-outbox-polling-sharding">sharding</a>
and index entities from any shard.</p>
</div>
<div class="paragraph">
<p>Bypassing sharding can be dangerous,
because indexing the same entity simultaneously from an event processor and the mass indexer
could potentially result in an out-of-sync index in some rare situations.
This is why, to be perfectly safe, event processing gets suspended while mass indexing is in progress.
Events are still produced and persisted, but their processing gets delayed until mass indexing finishes.</p>
</div>
<div class="paragraph">
<p>The suspension of event processing is achieved by registering a mass indexer agent in the agent table,
which event processors will eventually detect and react to by suspending themselves.
When mass indexing finishes, the mass indexer agent is removed from the agent table,
event processors detect that and resume event processing.</p>
</div>
<div class="paragraph">
<p>The mass indexer agent can be configured using the following configuration properties:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>hibernate.search.coordination.mass_indexer.polling_interval = 100
hibernate.search.coordination.mass_indexer.pulse_interval = 2000
hibernate.search.coordination.mass_indexer.pulse_expiration = 30000</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>mass_indexer.polling_interval</code> defines how long to wait for another query to the agent table
when actively waiting for event processors to suspend themselves,
as an <a href="#configuration-property-types">integer value</a> in milliseconds.
The default for this property is <code>100</code>.</p>
<div class="paragraph">
<p>Low values will reduce the time it takes for the mass indexer agent to detect that event processors finally suspended themselves,
but will increase the stress on the database while the mass indexer agent is actively waiting.</p>
</div>
<div class="paragraph">
<p>High values will increase the time it takes for the mass indexer agent to detect that event processors finally suspended themselves,
but will reduce the stress on the database while the mass indexer agent is actively waiting.</p>
</div>
</li>
<li>
<p><code>mass_indexer.pulse_interval</code> defines how long the mass indexer can wait before it must perform a "pulse",
as an <a href="#configuration-property-types">integer value</a> in milliseconds.
The default for this property is <code>2000</code>.</p>
<div class="paragraph">
<p>See <a href="#coordination-outbox-polling-sharding">the sharding basics</a> for information about "pulses".</p>
</div>
<div class="paragraph">
<p>The pulse interval must be set to a value between the polling interval (see above) and one third (1/3) of the expiration interval (see below).</p>
</div>
<div class="paragraph">
<p>Low values (closer to the polling interval) mean reduced risk of
event processors starting to process events again during mass indexing
because a mass indexer agent is incorrectly considered disconnected,
but more stress on the database because of more frequent updates of the mass indexer agent&#8217;s entry in the agent table.</p>
</div>
<div class="paragraph">
<p>High values (closer to the expiration interval) mean increased risk of
event processors starting to process events again during mass indexing
because a mass indexer agent is incorrectly considered disconnected,
but less stress on the database because of less frequent updates of the mass indexer agent&#8217;s entry in the agent table.</p>
</div>
</li>
<li>
<p><code>mass_indexer.pulse_expiration</code> defines how long an event processor "pulse" remains valid
before considering the processor disconnected and forcibly removing it from the cluster,
as an <a href="#configuration-property-types">integer value</a> in milliseconds.
The default for this property is <code>30000</code>.</p>
<div class="paragraph">
<p>See <a href="#coordination-outbox-polling-sharding">the sharding basics</a> for information about "pulses".</p>
</div>
<div class="paragraph">
<p>The expiration interval must be set to a value at least 3 times larger than the pulse interval (see above).</p>
</div>
<div class="paragraph">
<p>Low values (closer to the pulse interval) mean less time wasted with event processors not processing events
when a mass indexer agent terminates due to a crash,
but increased risk of event processors starting to process events again during mass indexing
because a mass indexer agent is incorrectly considered disconnected.</p>
</div>
<div class="paragraph">
<p>High values (much larger than the pulse interval) mean more time wasted with event processors not processing events
when a mass indexer agent terminates due to a crash,
but reduced risk of event processors starting to process events again during mass indexing
because a mass indexer agent is incorrectly considered disconnected.</p>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="coordination-outbox-polling-multi-tenancy"><a class="anchor" href="#coordination-outbox-polling-multi-tenancy"></a>18.3.7. Multi-tenancy</h4>
<div class="paragraph">
<p>If you use <a href="https://docs.jboss.org/hibernate/orm/6.4/userguide/html_single/Hibernate_User_Guide.html#configurations-multi-tenancy">Hibernate ORM&#8217;s multi-tenancy support</a>,
you will need to <a href="#configuration-multi-tenancy">configure the list of all possible tenant identifiers</a>.</p>
</div>
<div class="paragraph">
<p>Failing to mention a tenant identifier in this configuration might result in
events piling up in the outbox table without ever being <a href="#coordination-outbox-polling-event-processor">processed</a>,
or in exceptions being thrown upon <a href="#coordination-outbox-polling-mass-indexer">mass indexing</a>
due to incomplete configuration.</p>
</div>
<div class="paragraph">
<p>Apart from that, multi-tenancy support should be fairly transparent:
Hibernate Search will simply duplicate event processors for each tenant identifiers.</p>
</div>
<div class="paragraph">
<p>You can use different configuration for different tenants by using a different root for configuration properties:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>hibernate.search.coordination</code> is the default root, whose properties will be used as a default for all tenants.</p>
</li>
<li>
<p><code>hibernate.search.coordination.tenants.&lt;tenant-identifier&gt;</code> is the tenant-specific root.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>See below for an example.</p>
</div>
<div class="exampleblock">
<div class="title">Example 425. Configuration of coordination in a multi-tenant application with a node dedicated to a single tenant</div>
<div class="content">
<div class="paragraph">
<p>Node 1:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>hibernate.search.multi_tenancy.tenant_ids=tenant1,tenant2,tenant3,tenant4
hibernate.search.coordination.strategy = outbox-polling
hibernate.search.coordination.tenants.tenant1.event_processor.enabled = false <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This node will process events for all tenants <strong>except</strong> <code>tenant1</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Node 2:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>hibernate.search.multi_tenancy.tenant_ids=tenant1,tenant2,tenant3,tenant4
hibernate.search.coordination.strategy = outbox-polling
hibernate.search.coordination.event_processor.enabled = false <i class="conum" data-value="1"></i><b>(1)</b>
hibernate.search.coordination.tenants.tenant1.event_processor.enabled = true <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This node will not process events for any tenant&#8230;&#8203;</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>&#8230;&#8203; <strong>except</strong> <code>tenant1</code>.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="coordination-outbox-polling-aborted-events"><a class="anchor" href="#coordination-outbox-polling-aborted-events"></a>18.3.8. <a id="_aborted_events"></a> Aborted events</h4>
<div class="paragraph">
<p>If something goes wrong when an outbox event is processed, the event processor will try to re-process the events
two times, after that the event will be marked as aborted.
Aborted events won&#8217;t be processed by the processor.</p>
</div>
<div class="paragraph">
<p>Hibernate Search exposes some APIs to work on aborted events.</p>
</div>
<div class="exampleblock">
<div class="title">Example 426. Use the API for the aborted events</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA">OutboxPollingSearchMapping searchMapping = Search.mapping( sessionFactory ).extension( OutboxPollingExtension.get() ); <i class="conum" data-value="1"></i><b>(1)</b>
<span class="type">long</span> count = searchMapping.countAbortedEvents(); <i class="conum" data-value="2"></i><b>(2)</b>
searchMapping.reprocessAbortedEvents(); <i class="conum" data-value="3"></i><b>(3)</b>
searchMapping.clearAllAbortedEvents(); <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>To have the access to the API we need to pass the <code>OutboxPollingExtension</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Count aborted events</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Re-process aborted events</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Clear all the aborted events</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>If multi-tenancy is enabled, it will be necessary to pass
the tenant id to target the tenant operations are performed on.</p>
</div>
<div class="exampleblock">
<div class="title">Example 427. Use the API for the aborted events with multi-tenancy</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="JAVA"><span class="type">long</span> count = searchMapping.countAbortedEvents( tenantId ); <i class="conum" data-value="1"></i><b>(1)</b>
searchMapping.reprocessAbortedEvents( tenantId ); <i class="conum" data-value="2"></i><b>(2)</b>
searchMapping.clearAllAbortedEvents( tenantId ); <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Count aborted events for the given tenantId</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Re-process aborted events for the given tenantId</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Clear all the aborted events for the given tenantId</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="integrations"><a class="anchor" href="#integrations"></a>19. Standards and integrations</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="other-integrations-jakarta"><a class="anchor" href="#other-integrations-jakarta"></a>19.1. Jakarta EE</h3>
<div class="paragraph">
<p>Hibernate Search targets <a href="https://jakarta.ee/">Jakarta EE</a> where relevant,
in particular Jakarta Persistence 3.1 with the <a href="#mapper-orm">Hibernate ORM Mapper</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="other-integrations-javaee"><a class="anchor" href="#other-integrations-javaee"></a>19.2. Java EE</h3>
<div class="paragraph">
<p>Hibernate Search no longer supports <a href="https://www.oracle.com/java/technologies/java-ee-glance.html">Java EE</a>.</p>
</div>
<div class="paragraph">
<p>Use <a href="#other-integrations-jakarta">Jakarta EE</a> instead.</p>
</div>
</div>
<div class="sect2">
<h3 id="other-integrations-orm6"><a class="anchor" href="#other-integrations-orm6"></a>19.3. Hibernate ORM 6</h3>
<div class="paragraph">
<p>In previous versions, Hibernate Search&#8217;s main Maven artifacts used to target Hibernate ORM 5,
while separate, dedicated Maven artifacts targeted Hibernate ORM 6.</p>
</div>
<div class="paragraph">
<p>This is no longer the case: the main Maven artifacts now target Hibernate ORM 6,
and Hibernate ORM 5 is no longer compatible.</p>
</div>
<div class="paragraph">
<p>If your dependencies include references to artifacts ending with <code>-orm6</code>
(e.g. <code>hibernate-search-mapper-orm-orm6</code>)
just remove the <code>-orm6</code> (e.g. use <code>hibernate-search-mapper-orm</code> instead)
when you upgrade to this version of Hibernate Search.</p>
</div>
</div>
<div class="sect2">
<h3 id="other-integrations-orm5"><a class="anchor" href="#other-integrations-orm5"></a>19.4. Hibernate ORM 5</h3>
<div class="paragraph">
<p>Hibernate Search no longer supports Hibernate ORM 5.</p>
</div>
<div class="paragraph">
<p>Use <a href="#other-integrations-jakarta">Hibernate ORM 6</a> instead.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="limitations"><a class="anchor" href="#limitations"></a>20. <a id="elasticsearch-limitations"></a> Known issues and limitations</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="limitations-parallel-embedded-update"><a class="anchor" href="#limitations-parallel-embedded-update"></a>20.1. Without coordination, in rare cases, indexing involving <code>@IndexedEmbedded</code> may lead to out-of sync indexes</h3>
<div class="sect3">
<h4 id="limitations-parallel-embedded-update-description"><a class="anchor" href="#limitations-parallel-embedded-update-description"></a>20.1.1. Description</h4>
<div class="paragraph">
<p>With the default settings (<a href="#coordination-none">no coordination</a>),
if two entity instances are <a href="#mapping-indexedembedded">indexed-embedded</a> in the same "index-embedding" entity,
and these two entity instance are updated in parallel transactions,
there is a small risk that the transaction commits happen in just the wrong way,
leading to the index-embedding entity being re-indexed with only part of the updates.</p>
</div>
<div class="paragraph">
<p>For example, consider indexed entity A, which index-embeds B and C.
The following course of events involving two parallel transactions (T1 and T2)
will lead to an out of date index:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>T1: Load B.</p>
</li>
<li>
<p>T1: Change B in a way that will require reindexing A.</p>
</li>
<li>
<p>T2: Load C.</p>
</li>
<li>
<p>T2: Change C in a way that will require reindexing A.</p>
</li>
<li>
<p>T2: Request the transaction commit.
Hibernate Search builds the document for A.
While doing so, it automatically loads B. B appears unmodified, as T1 wasn&#8217;t committed yet.</p>
</li>
<li>
<p>T1: Request the transaction commit.
Hibernate Search builds documents to index.
While doing so, it automatically loads C. C appears unmodified, as T2 wasn&#8217;t committed yet.</p>
</li>
<li>
<p>T1: Transaction is committed.
Hibernate Search automatically sends the updated A to the index.
In this version, B is updated, but C is not.</p>
</li>
<li>
<p>T2: Transaction is committed.
Hibernate Search automatically sends the updated A to the index.
In this version, C is updated, but B is not.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This chain of events ends with the index containing a version of A where C is updated, but B is not.</p>
</div>
</div>
<div class="sect3">
<h4 id="limitations-parallel-embedded-update-solution"><a class="anchor" href="#limitations-parallel-embedded-update-solution"></a>20.1.2. Solutions and workarounds</h4>
<div class="paragraph">
<p>The following solutions can help circumvent this limitation:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Use a safer <a href="#coordination">coordination strategy</a>,
e.g. the <a href="#coordination-outbox-polling"><code>outbox-polling</code> coordination strategy</a>.
See in particular <a href="#architecture-examples"> Examples of architectures</a>.</p>
</li>
<li>
<p>OR avoid parallel updates to entities that are indexed-embedded in the same indexed entity.
This is only possible in very specific setups.</p>
</li>
<li>
<p>OR schedule a <a href="#indexing-massindexer">full reindexing</a> of your database periodically (e.g. every night)
to get the index back in sync with the database.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="limitations-parallel-embedded-update-roadmap"><a class="anchor" href="#limitations-parallel-embedded-update-roadmap"></a>20.1.3. Roadmap</h4>
<div class="paragraph">
<p>This limitation is caused directly by the lack of coordination between threads or application nodes,
so it can only be addressed completely by configuring <a href="#coordination">coordination</a>.</p>
</div>
<div class="paragraph">
<p>There are no other solutions currently on the roadmap.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="limitations-backend-indexing-error"><a class="anchor" href="#limitations-backend-indexing-error"></a>20.2. Without coordination, backend errors during indexing may lead to out-of sync indexes</h3>
<div class="sect3">
<h4 id="limitations-backend-indexing-error-description"><a class="anchor" href="#limitations-backend-indexing-error-description"></a>20.2.1. Description</h4>
<div class="paragraph">
<p>With the default settings (<a href="#coordination-none">no coordination</a>),
<a href="#architecture-hsearch-indexing">indexing</a>
will actually apply index changes in the backend <strong>just after</strong> the transaction commit,
without any kind of transaction log for the index changes.</p>
</div>
<div class="paragraph">
<p>Consequently, should an error occur in the backend while indexing (i.e. an I/O error),
this indexing will be cancelled, with no way to cancel the corresponding database transaction:
the index will thus become out of sync.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The risk is exclusively related to errors in the backend, mostly to filesystem or network issues.
Errors occurring in user code (getters, custom <a href="#binding">bridges</a>, &#8230;&#8203;)
will safely cancel the whole database transaction without indexing anything,
ensuring that indexes are still in sync with the database.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="limitations-backend-indexing-error-solution"><a class="anchor" href="#limitations-backend-indexing-error-solution"></a>20.2.2. Solutions and workarounds</h4>
<div class="paragraph">
<p>The following solutions can help circumvent this limitation:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Use a safer <a href="#coordination">coordination strategy</a>,
e.g. the <a href="#coordination-outbox-polling"><code>outbox-polling</code> coordination strategy</a>.
See in particular <a href="#architecture-examples"> Examples of architectures</a>.</p>
</li>
<li>
<p>OR schedule a <a href="#indexing-massindexer">full reindexing</a> of your database periodically (e.g. every night)
to get the index back in sync with the database.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="limitations-backend-indexing-error-roadmap"><a class="anchor" href="#limitations-backend-indexing-error-roadmap"></a>20.2.3. Roadmap</h4>
<div class="paragraph">
<p>This limitation is caused directly by the lack of persistence of entity change events,
so it can only be addressed completely by persisting those events,
e.g. by switching to the <a href="#coordination-outbox-polling"><code>outbox-polling</code> coordination strategy</a>.</p>
</div>
<div class="paragraph">
<p>Some incomplete countermeasures may be considered in future versions,
such as automatic in-thread retries,
but they will never solve the problem completely,
and they are not currently on the roadmap.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="limitations-changes-in-session"><a class="anchor" href="#limitations-changes-in-session"></a>20.3. Listener-triggered indexing only considers changes applied directly to entity instances in Hibernate ORM sessions</h3>
<div class="sect3">
<h4 id="limitations-changes-in-session-description"><a class="anchor" href="#limitations-changes-in-session-description"></a>20.3.1. Description</h4>
<div class="paragraph">
<p>Due to <a href="#indexing-automatic-concepts-changes-in-session">how Hibernate Search uses internal events of Hibernate ORM</a>
in order to detect changes,
it will not detect changes resulting from <code>insert</code>/<code>delete</code>/<code>update</code> queries,
be it SQL or JPQL/HQL queries.</p>
</div>
<div class="paragraph">
<p>This is because queries are executed on the database side,
without Hibernate ORM or Search having any knowledge of which entities are actually created, deleted or updated.</p>
</div>
</div>
<div class="sect3">
<h4 id="limitations-changes-in-session-solution"><a class="anchor" href="#limitations-changes-in-session-solution"></a>20.3.2. Solutions and workarounds</h4>
<div class="paragraph">
<p>One workaround is to reindex explicitly after you run JPQL/SQL queries,
either using the <a href="#indexing-massindexer"><code>MassIndexer</code></a>,
using the <a href="#mapper-orm-indexing-jakarta-batch">Jakarta Batch mass indexing job</a>,
or <a href="#indexing-explicit">explicitly</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="limitations-changes-in-session-roadmap"><a class="anchor" href="#limitations-changes-in-session-roadmap"></a>20.3.3. Roadmap</h4>
<div class="paragraph">
<p>One solution to actually detect these changes would be to source entity change events
directly from the database, using for example Debezium.</p>
</div>
<div class="paragraph">
<p>This is tracked as <a href="https://hibernate.atlassian.net/browse/HSEARCH-3513">HSEARCH-3513</a>,
but is long-term goal.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="limitations-changes-asymmetric-association-updates"><a class="anchor" href="#limitations-changes-asymmetric-association-updates"></a>20.4. <a id="mapper-orm-indexing-automatic-concepts-session-consistency"></a> Listener-triggered indexing ignores asymmetric association updates</h3>
<div class="sect3">
<h4 id="limitations-changes-asymmetric-association-updates-description"><a class="anchor" href="#limitations-changes-asymmetric-association-updates-description"></a>20.4.1. Description</h4>
<div class="paragraph">
<p>Hibernate ORM is able to handle asymmetric updates of associations,
where only the owning side of association is updated and the other side is ignored.
The entities in the session will be inconsistent for the duration of the session,
but upon reloading they will be consistent once again,
due to how entity loading works.</p>
</div>
<div class="paragraph">
<p>This practice of asymmetric updates of associations
can cause problems in applications in general,
but also in Hibernate Search specifically,
where it may lead to out-of-sync indexes.
Thus, it must be avoided.</p>
</div>
<div class="paragraph">
<p>For example, let&#8217;s assume an indexed entity <code>A</code> has an <code>@IndexedEmbedded</code> association <code>A.b</code> to entity <code>B</code>,
and that <code>B</code> owns that association on its side, <code>B.a</code>.
One can just set <code>B.a</code> to <code>null</code> in order to remove the association between <code>A</code> and <code>B</code>,
and the effect on the database will be exactly what we want.</p>
</div>
<div class="paragraph">
<p>However, Hibernate Search will only be able to detect that <code>B.a</code> changed,
and by the time it tries to infer which entities need to be re-indexed,
it will no longer be able to know what <code>B.a</code> used to refer to.
That change in itself is useless to Hibernate Search:
Hibernate Search will not know that <code>A</code>, specifically, needs to be re-indexed.
It will "forget" to reindex <code>A</code>, leading to an out-of-sync index where <code>A.b</code> still contains <code>B</code>.</p>
</div>
<div class="paragraph">
<p>In the end, the only way for Hibernate Search to know that <code>A</code> needs to be re-indexed
is to also set <code>A.b</code> to <code>null</code>, which will cause Hibernate Search to detect that <code>A.b</code> changed,
and thus that <code>A</code> changed too.</p>
</div>
</div>
<div class="sect3">
<h4 id="limitations-changes-asymmetric-association-updates-solution"><a class="anchor" href="#limitations-changes-asymmetric-association-updates-solution"></a>20.4.2. Solutions and workarounds</h4>
<div class="paragraph">
<p>The following solutions can help circumvent this limitation:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>When you update one side of an association,
always update the other side consistently.</p>
</li>
<li>
<p>When the above is not possible,
reindex affected entities explicitly after the association update,
either using the <a href="#indexing-massindexer"><code>MassIndexer</code></a>,
using the <a href="#mapper-orm-indexing-jakarta-batch">Jakarta Batch mass indexing job</a>,
or <a href="#indexing-explicit">explicitly</a>.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="limitations-changes-asymmetric-association-updates-roadmap"><a class="anchor" href="#limitations-changes-asymmetric-association-updates-roadmap"></a>20.4.3. Roadmap</h4>
<div class="paragraph">
<p>Hibernate Search may handle asymmetric association updates in the future,
by keeping tracks of entities added to / removed from an association.
However, this will only solve the problem completely if indexing happens asynchronously in a background thread,
such as with the <a href="#coordination-outbox-polling"><code>outbox-polling</code> coordination strategy</a>.
This is tracked as <a href="https://hibernate.atlassian.net/browse/HSEARCH-3567">HSEARCH-3567</a>.</p>
</div>
<div class="paragraph">
<p>Alternatively, sourcing entity change events directly from the database, using for example Debezium,
would also solve the problem.
This is tracked as <a href="https://hibernate.atlassian.net/browse/HSEARCH-3513">HSEARCH-3513</a>,
but is long-term goal.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="limitations-indexing-plan-serialization"><a class="anchor" href="#limitations-indexing-plan-serialization"></a>20.5. Listener-triggered indexing is not compatible with <code>Session</code> serialization</h3>
<div class="sect3">
<h4 id="limitations-indexing-plan-serialization-description"><a class="anchor" href="#limitations-indexing-plan-serialization-description"></a>20.5.1. Description</h4>
<div class="paragraph">
<p>When <a href="#listener-triggered-indexing">listener-triggered indexing</a> is enabled,
Hibernate Search collects entity change events
to build an "indexing plan" inside the ORM <code>EntityManager</code>/<code>Session</code>.
The indexing plan holds information relative to which entities need to be re-indexed,
and sometimes documents that have not been indexed yet.</p>
</div>
<div class="paragraph">
<p>The indexing plan cannot be serialized.</p>
</div>
<div class="paragraph">
<p>If the ORM <code>Session</code> gets serialized,
all collected change events will be lost upon deserializing the session,
and Hibernate Search will likely "forget" to reindex some entities.</p>
</div>
<div class="paragraph">
<p>This is fine in most applications, since they do not rely on serializing the session,
but it might be a problem with some JEE applications relying on Bean Passivation.</p>
</div>
</div>
<div class="sect3">
<h4 id="limitations-indexing-plan-serialization-solution"><a class="anchor" href="#limitations-indexing-plan-serialization-solution"></a>20.5.2. Solutions and workarounds</h4>
<div class="paragraph">
<p>Avoid serializing an ORM <code>EntityManager</code>/<code>Session</code> after changing entities.</p>
</div>
</div>
<div class="sect3">
<h4 id="limitations-indexing-plan-serialization-roadmap"><a class="anchor" href="#limitations-indexing-plan-serialization-roadmap"></a>20.5.3. Roadmap</h4>
<div class="paragraph">
<p>There are no plans to address this limitation.
We do not intend to support <code>Session</code> serialization when Hibernate Search is enabled.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="troubleshooting"><a class="anchor" href="#troubleshooting"></a>21. Troubleshooting</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="troubleshooting-under-the-hood"><a class="anchor" href="#troubleshooting-under-the-hood"></a>21.1. Finding out what is executed under the hood</h3>
<div class="paragraph">
<p>For search queries, you can get a human-readable representation of a <a href="#search-dsl-query-object"><code>SearchQuery</code> object</a>
by calling <code>toString()</code> or <code>queryString()</code>.
Alternatively, rely on the logs:
<a href="#troubleshooting-logging-query"><code>org.hibernate.search.query</code></a> will log every query at the <code>TRACE</code> level
before it is executed.</p>
</div>
<div class="paragraph">
<p>For more general information about what is being executed, rely on loggers:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#troubleshooting-logging-lucene-infostream"><code>org.hibernate.search.backend.lucene.infostream</code></a>
for Lucene.</p>
</li>
<li>
<p><a href="#troubleshooting-logging-elasticsearch-request"><code>org.hibernate.search.elasticsearch.request</code></a>
for Elasticsearch.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="troubleshooting-logging"><a class="anchor" href="#troubleshooting-logging"></a>21.2. Loggers</h3>
<div class="paragraph">
<p>Here are a few loggers that can be useful when debugging an application that uses Hibernate Search:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><a id="troubleshooting-logging-query"></a><code>org.hibernate.search.query</code></dt>
<dd>
<p>Available for all backends.</p>
<div class="paragraph">
<p>Logs every single search query at the <code>TRACE</code> level, before its execution.</p>
</div>
</dd>
<dt class="hdlist1"><a id="troubleshooting-logging-elasticsearch-request"></a><code>org.hibernate.search.elasticsearch.request</code></dt>
<dd>
<p>Available for Elasticsearch backends only.</p>
<div class="paragraph">
<p>Logs requests sent to Elasticsearch at the <code>DEBUG</code> or <code>TRACE</code> level after their execution.
All available request and response information is logged:
method, path, execution time, status code, but also the full request and response.</p>
</div>
<div class="paragraph">
<p>Use the <code>DEBUG</code> level to only log non-success requests (status code different from <code>2xx</code>),
or the <code>TRACE</code> level to log every single request.</p>
</div>
<div class="paragraph">
<p>You can enable pretty-printing (line breaks and indentation) for the request and response
using a <a href="#backend-elasticsearch-configuration-logging">configuration property</a>.</p>
</div>
</dd>
<dt class="hdlist1"><a id="troubleshooting-logging-lucene-infostream"></a><code>org.hibernate.search.backend.lucene.infostream</code></dt>
<dd>
<p>Available for Lucene backends only.</p>
<div class="paragraph">
<p>Logs low level trace information about Lucene&#8217;s internal components, at the <code>TRACE</code> level.</p>
</div>
<div class="paragraph">
<p>Enabling the <code>TRACE</code> level on this logger is not enough:
you must also enable the infostream using a <a href="#backend-lucene-io-writer-infostream">configuration property</a>.</p>
</div>
</dd>
</dl>
</div>
</div>
<div class="sect2">
<h3 id="troubleshooting-faq"><a class="anchor" href="#troubleshooting-faq"></a>21.3. Frequently asked questions</h3>
<div class="sect3">
<h4 id="troubleshooting-faq-search-matches"><a class="anchor" href="#troubleshooting-faq-search-matches"></a>21.3.1. <a id="search-dsl-query-debugging-matches"></a> Unexpected or missing documents in search hits</h4>
<div class="paragraph">
<p>When some documents unexpectedly match or don&#8217;t match a query,
you will need information about the exact query being executed,
and about the index content.</p>
</div>
<div class="paragraph">
<p>To find out what the query being executed looks like exactly,
see <a href="#troubleshooting-under-the-hood">Finding out what is executed under the hood</a>.</p>
</div>
<div class="paragraph">
<p>To inspect the content of the index:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>With the Elasticsearch backend, run simpler queries using either Hibernate Search or the REST APIs directly.</p>
</li>
<li>
<p>With the Lucene backend, run simpler queries using Hibernate Search or
<a href="https://medium.com/@mocobeta/luke-become-an-apache-lucene-module-as-of-lucene-8-1-7d139c998b2">use the Luke tool</a>
distributed as part of the <a href="https://lucene.apache.org/core/downloads.html">Lucene binary packages</a>.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="troubleshooting-faq-search-score"><a class="anchor" href="#troubleshooting-faq-search-score"></a>21.3.2. <a id="_understanding_results"></a> Unsatisfying order of search hits when sorting by score</h4>
<div id="search-dsl-query-debugging-score" class="paragraph">
<p>When sorting by score, if the documents don&#8217;t appear in the order you expect,
it means some documents have a score that is higher or lower than what you want.</p>
</div>
<div class="paragraph">
<p>The best way to gain insight into these scores
is to just ask the backend to explain how the score was computed.
The returned explanation will include a human-readable description of
how the score of a specific document was computed.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Regardless of the API used, explanations are rather costly performance-wise:
only use them for debugging purposes.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>There are two ways to retrieve explanations:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If you are interested in a particular entity and know its identifier: use the <code>explain(&#8230;&#8203;)</code> method on the query.
See <a href="#search-dsl-query-explain"><code>explain(&#8230;&#8203;)</code>: Explaining scores</a>.</p>
</li>
<li>
<p>If you just want an explanation for all the top hits: use an <code>explanation</code> projection.
See <a href="#search-dsl-projection-extensions-lucene-explanation">here for Lucene</a>
and <a href="#search-dsl-projection-extensions-elasticsearch-explanation">here for Elasticsearch</a>.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="troubleshooting-faq-search-time"><a class="anchor" href="#troubleshooting-faq-search-time"></a>21.3.3. Search query execution takes too long</h4>
<div class="paragraph">
<p>When the execution of a search query is too long,
you may need more information about how long it took exactly,
and what was executed exactly.</p>
</div>
<div class="paragraph">
<p>To find out how long a query execution took,
use the <a href="#search-dsl-query-took-timedout"><code>took()</code> method</a> on the search result.</p>
</div>
<div class="paragraph">
<p>To find out what the query being executed looks like exactly,
see <a href="#troubleshooting-under-the-hood">Finding out what is executed under the hood</a>.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="further-reading"><a class="anchor" href="#further-reading"></a>22. <a id="_further_reading"></a> Further reading</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="further-reading-hibernate-search"><a class="anchor" href="#further-reading-hibernate-search"></a>22.1. Hibernate Search</h3>
<div class="paragraph">
<p>The <a href="https://hibernate.org/search">Hibernate Search website</a> is a good first stop when looking
for information about Hibernate Search,
be it to know more about <a href="https://hibernate.org/search/releases/">releases</a>,
<a href="https://hibernate.org/search/documentation/">documentation for all versions</a>,
<a href="https://hibernate.org/search/documentation/migrate/">migration guides</a>,
<a href="https://hibernate.org/search/roadmap/">the roadmap</a>,
or simply getting links to the source code and issue tracker.</p>
</div>
<div class="paragraph">
<p>The Hibernate Search website also includes links to <a href="https://hibernate.org/search/more-resources/">various external resources</a>
such as blog posts and talks.</p>
</div>
<div class="paragraph">
<p>To contribute to, or ask questions about, Hibernate Search or any Hibernate projects,
start from the <a href="https://hibernate.org/community/">community</a> page on the same website.</p>
</div>
<div class="paragraph">
<p>Finally, for examples of using Hibernate Search in applications, see:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The <a href="https://github.com/quarkusio/quarkus-quickstarts/tree/main/hibernate-search-orm-elasticsearch-quickstart">Quarkus quickstart</a>,
a sample application using Hibernate Search with the <a href="#compatibility-framework-quarkus">Quarkus</a> framework.</p>
</li>
<li>
<p>The <a href="https://github.com/hibernate/hibernate-search/tree/main/integrationtest/showcase/library">"Library" showcase</a>,
a sample application using Hibernate Search with the <a href="#compatibility-framework-spring-boot">Spring Boot</a> framework.</p>
</li>
<li>
<p>The <a href="https://hibernate.org/search/more-resources/">blog posts and talks</a> mentioned above,
most of which include tutorials and/or simple applications.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="further-reading-elasticsearch"><a class="anchor" href="#further-reading-elasticsearch"></a>22.2. Elasticsearch</h3>
<div class="paragraph">
<p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/8.13">Elasticsearch&#8217;s reference documentation</a> is an excellent starting point
to learn more about Elasticsearch.</p>
</div>
</div>
<div class="sect2">
<h3 id="further-reading-lucene"><a class="anchor" href="#further-reading-lucene"></a>22.3. Lucene</h3>
<div class="paragraph">
<p>To learn more about Lucene,
you can get a copy to <a href="http://www.manning.com/hatcher3/">Lucene in Action (Second Edition)</a>,
though it covers an older version of Lucene.</p>
</div>
<div class="paragraph">
<p>Otherwise, you can always try your luck with <a href="https://lucene.apache.org/core/9_9_2/core/">Lucene&#8217;s Javadoc</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="further-reading-hibernate-orm"><a class="anchor" href="#further-reading-hibernate-orm"></a>22.4. <a id="_hibernate_orm"></a> Hibernate ORM</h3>
<div class="paragraph">
<p>If you want to deepen your knowledge of Hibernate ORM,
start with the <a href="http://hibernate.org/orm/documentation/">online documentation</a> or get hold
of a copy of <a href="http://www.manning.com/bauer3/">Java Persistence with Hibernate, Second Edition</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="further-reading-other"><a class="anchor" href="#further-reading-other"></a>22.5. Other</h3>
<div class="paragraph">
<p>If you have any further questions or feedback regarding Hibernate Search,
reach out to the <a href="https://hibernate.org/community/">Hibernate community</a>.
We are looking forward to hearing from you.</p>
</div>
<div class="paragraph">
<p>In case you would like to report a bug use the
<a href="https://hibernate.atlassian.net/browse/HSEARCH">Hibernate Search JIRA</a> instance.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="credits"><a class="anchor" href="#credits"></a>23. Credits</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The full list of contributors to Hibernate Search can be found in the <code>copyright.txt</code> file in the Hibernate Search sources,
available in particular in our <a href="https://github.com/hibernate/hibernate-search/blob/main/copyright.txt">git repository</a>.</p>
</div>
<div class="paragraph">
<p>The following contributors have been involved in this documentation:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Marko Bekhta</p>
</li>
<li>
<p>Emmanuel Bernard</p>
</li>
<li>
<p>Hardy Ferentschik</p>
</li>
<li>
<p>Gustavo Fernandes</p>
</li>
<li>
<p>Fabio Massimo Ercoli</p>
</li>
<li>
<p>Sanne Grinovero</p>
</li>
<li>
<p>Mincong Huang</p>
</li>
<li>
<p>Nabeel Ali Memon</p>
</li>
<li>
<p>Gunnar Morling</p>
</li>
<li>
<p>Yoann Rodire</p>
</li>
<li>
<p>Guillaume Smet</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="configuration-properties-aggregated"><a class="anchor" href="#configuration-properties-aggregated"></a>Appendix A: List of all available configuration properties</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="configuration-properties-aggregated-hibernate-search-engine"><a class="anchor" href="#configuration-properties-aggregated-hibernate-search-engine"></a>A.1. Hibernate Search Engine</h3>
<div class="dlist">
<dl>
<dt class="hdlist1"><a id="configuration-properties-aggregated-hibernate-search-enginehibernate.search.background_failure_handler"></a> <code>hibernate.search.background_failure_handler</code></dt>
<dd>
<p>The <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/engine/cfg/../reporting/FailureHandler.html"><code>FailureHandler</code></a> instance that should be notified of any failure occurring in a background process (mainly index operations).</p>
<div class="paragraph">
<p>Expects a reference to a bean of type <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/engine/cfg/../reporting/FailureHandler.html"><code>FailureHandler</code></a>.</p>
</div>
<div class="paragraph">
<p>Defaults to <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/engine/cfg/EngineSettings.Defaults.html#BACKGROUND_FAILURE_HANDLER"><code>EngineSettings.Defaults.BACKGROUND_FAILURE_HANDLER</code></a>, a logging handler.</p>
</div>
</dd>
<dt class="hdlist1"><a id="configuration-properties-aggregated-hibernate-search-enginehibernate.search.configuration_property_checking.strategy"></a> <code>hibernate.search.configuration_property_checking.strategy</code></dt>
<dd>
<p>How to report the results of configuration property checking.</p>
<div class="paragraph">
<p>Configuration property checking will detect an configuration property that is never used, which might indicate a configuration issue.</p>
</div>
<div class="paragraph">
<p>Expects a <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/engine/cfg/ConfigurationPropertyCheckingStrategyName.html"><code>ConfigurationPropertyCheckingStrategyName</code></a> value, or a String representation of such value.</p>
</div>
<div class="paragraph">
<p>Defaults to <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/engine/cfg/EngineSettings.Defaults.html#CONFIGURATION_PROPERTY_CHECKING_STRATEGY"><code>EngineSettings.Defaults.CONFIGURATION_PROPERTY_CHECKING_STRATEGY</code></a>.</p>
</div>
</dd>
<dt class="hdlist1"><a id="configuration-properties-aggregated-hibernate-search-enginehibernate.search.backend.type"></a> <code>hibernate.search.backend.type</code></dt>
<dd>
<p>The type of the backend.</p>
<div class="paragraph">
<p>Only useful if you have more than one backend technology in the classpath; otherwise the backend type is automatically detected.</p>
</div>
<div class="paragraph">
<p>Expects a String, such as "lucene" or "elasticsearch". See the documentation of your backend to find the appropriate value.</p>
</div>
<div class="paragraph">
<p>Defaults:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If there is only one backend type in the classpath, defaults to that backend.</p>
</li>
<li>
<p>Otherwise, no default: this property must be set.</p>
</li>
</ul>
</div>
<details>
<summary class="title">Variants of this configuration property (click to open)</summary>
<div class="content">
<div class="ulist">
<ul>
<li>
<p><code>hibernate.search.backends.&lt;backend-name&gt;.type</code></p>
</li>
</ul>
</div>
</div>
</details>
</dd>
</dl>
</div>
</div>
<div class="sect2">
<h3 id="configuration-properties-aggregated-hibernate-search-backend-lucene"><a class="anchor" href="#configuration-properties-aggregated-hibernate-search-backend-lucene"></a>A.2. Hibernate Search Backend - Lucene</h3>
<div class="dlist">
<dl>
<dt class="hdlist1"><a id="configuration-properties-aggregated-hibernate-search-backend-lucenehibernate.search.backend.analysis.configurer"></a> <code>hibernate.search.backend.analysis.configurer</code></dt>
<dd>
<p>The configurer for analysis.</p>
<div class="paragraph">
<p>Expects a single-valued or multi-valued reference to beans of type <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/backend/lucene/cfg/../analysis/LuceneAnalysisConfigurer.html"><code>LuceneAnalysisConfigurer</code></a>.</p>
</div>
<div class="paragraph">
<p>Defaults to no value.</p>
</div>
<details>
<summary class="title">Variants of this configuration property (click to open)</summary>
<div class="content">
<div class="ulist">
<ul>
<li>
<p><code>hibernate.search.backends.&lt;backend-name&gt;.analysis.configurer</code></p>
</li>
</ul>
</div>
</div>
</details>
</dd>
<dt class="hdlist1"><a id="configuration-properties-aggregated-hibernate-search-backend-lucenehibernate.search.backend.directory.filesystem_access.strategy"></a> <code>hibernate.search.backend.directory.filesystem_access.strategy</code></dt>
<dd>
<p>How to access the filesystem in the directory.</p>
<div class="paragraph">
<p>Only available for the "local-filesystem" directory type.</p>
</div>
<div class="paragraph">
<p>Expects a <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/backend/lucene/cfg/../lowlevel/directory/FileSystemAccessStrategyName.html"><code>FileSystemAccessStrategyName</code></a> value, or a String representation of such value.</p>
</div>
<div class="paragraph">
<p>Defaults to <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/backend/lucene/cfg/LuceneIndexSettings.Defaults.html#DIRECTORY_FILESYSTEM_ACCESS_STRATEGY"><code>LuceneIndexSettings.Defaults.DIRECTORY_FILESYSTEM_ACCESS_STRATEGY</code></a>.</p>
</div>
<details>
<summary class="title">Variants of this configuration property (click to open)</summary>
<div class="content">
<div class="ulist">
<ul>
<li>
<p><code>hibernate.search.backend.indexes.&lt;index-name&gt;.directory.filesystem_access.strategy</code></p>
</li>
<li>
<p><code>hibernate.search.backends.&lt;backend-name&gt;.directory.filesystem_access.strategy</code></p>
</li>
<li>
<p><code>hibernate.search.backends.&lt;backend-name&gt;.indexes.&lt;index-name&gt;.directory.filesystem_access.strategy</code></p>
</li>
</ul>
</div>
</div>
</details>
</dd>
<dt class="hdlist1"><a id="configuration-properties-aggregated-hibernate-search-backend-lucenehibernate.search.backend.directory.locking.strategy"></a> <code>hibernate.search.backend.directory.locking.strategy</code></dt>
<dd>
<p>How to lock on the directory.</p>
<div class="paragraph">
<p>Expects a <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/backend/lucene/cfg/../lowlevel/directory/LockingStrategyName.html"><code>LockingStrategyName</code></a> value, or a String representation of such value.</p>
</div>
<div class="paragraph">
<p>Defaults are specific to each directory type.</p>
</div>
<details>
<summary class="title">Variants of this configuration property (click to open)</summary>
<div class="content">
<div class="ulist">
<ul>
<li>
<p><code>hibernate.search.backend.indexes.&lt;index-name&gt;.directory.locking.strategy</code></p>
</li>
<li>
<p><code>hibernate.search.backends.&lt;backend-name&gt;.directory.locking.strategy</code></p>
</li>
<li>
<p><code>hibernate.search.backends.&lt;backend-name&gt;.indexes.&lt;index-name&gt;.directory.locking.strategy</code></p>
</li>
</ul>
</div>
</div>
</details>
</dd>
<dt class="hdlist1"><a id="configuration-properties-aggregated-hibernate-search-backend-lucenehibernate.search.backend.directory.root"></a> <code>hibernate.search.backend.directory.root</code></dt>
<dd>
<p>The filesystem root for the directory.</p>
<div class="paragraph">
<p>Only available for the "local-filesystem" directory type.</p>
</div>
<div class="paragraph">
<p>Expects a String representing a path to an existing directory accessible in read and write mode, such as "local-filesystem".</p>
</div>
<div class="paragraph">
<p>The actual index files will be created in directory <code>&lt;root&gt;/&lt;index-name&gt;</code>.</p>
</div>
<div class="paragraph">
<p>Defaults to the JVM&#8217;s working directory.</p>
</div>
<div class="paragraph">
<p>Default value: <code>"."</code></p>
</div>
<details>
<summary class="title">Variants of this configuration property (click to open)</summary>
<div class="content">
<div class="ulist">
<ul>
<li>
<p><code>hibernate.search.backend.indexes.&lt;index-name&gt;.directory.root</code></p>
</li>
<li>
<p><code>hibernate.search.backends.&lt;backend-name&gt;.directory.root</code></p>
</li>
<li>
<p><code>hibernate.search.backends.&lt;backend-name&gt;.indexes.&lt;index-name&gt;.directory.root</code></p>
</li>
</ul>
</div>
</div>
</details>
</dd>
<dt class="hdlist1"><a id="configuration-properties-aggregated-hibernate-search-backend-lucenehibernate.search.backend.directory.type"></a> <code>hibernate.search.backend.directory.type</code></dt>
<dd>
<p>The type of directory to use when reading from or writing to the index.</p>
<div class="paragraph">
<p>Expects a String, such as "local-filesystem". See the reference documentation for a list of available values.</p>
</div>
<div class="paragraph">
<p>Defaults to <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/backend/lucene/cfg/LuceneIndexSettings.Defaults.html#DIRECTORY_TYPE"><code>LuceneIndexSettings.Defaults.DIRECTORY_TYPE</code></a>.</p>
</div>
<div class="paragraph">
<p>Default value: <code>"local-filesystem"</code></p>
</div>
<details>
<summary class="title">Variants of this configuration property (click to open)</summary>
<div class="content">
<div class="ulist">
<ul>
<li>
<p><code>hibernate.search.backend.indexes.&lt;index-name&gt;.directory.type</code></p>
</li>
<li>
<p><code>hibernate.search.backends.&lt;backend-name&gt;.directory.type</code></p>
</li>
<li>
<p><code>hibernate.search.backends.&lt;backend-name&gt;.indexes.&lt;index-name&gt;.directory.type</code></p>
</li>
</ul>
</div>
</div>
</details>
</dd>
<dt class="hdlist1"><a id="configuration-properties-aggregated-hibernate-search-backend-lucenehibernate.search.backend.indexing.queue_count"></a> <code>hibernate.search.backend.indexing.queue_count</code></dt>
<dd>
<p>The number of indexing queues assigned to each index (or each shard of each index, when sharding is enabled).</p>
<div class="paragraph">
<p>Expects a strictly positive integer value, or a string that can be parsed into an integer value.</p>
</div>
<div class="paragraph">
<p>See the reference documentation, section "Lucene backend - Indexing", for more information about this setting and its implications.</p>
</div>
<div class="paragraph">
<p>Defaults to <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/backend/lucene/cfg/LuceneIndexSettings.Defaults.html#INDEXING_QUEUE_COUNT"><code>LuceneIndexSettings.Defaults.INDEXING_QUEUE_COUNT</code></a>.</p>
</div>
<div class="paragraph">
<p>Default value: <code>10</code></p>
</div>
<details>
<summary class="title">Variants of this configuration property (click to open)</summary>
<div class="content">
<div class="ulist">
<ul>
<li>
<p><code>hibernate.search.backend.indexes.&lt;index-name&gt;.indexing.queue_count</code></p>
</li>
<li>
<p><code>hibernate.search.backends.&lt;backend-name&gt;.indexing.queue_count</code></p>
</li>
<li>
<p><code>hibernate.search.backends.&lt;backend-name&gt;.indexes.&lt;index-name&gt;.indexing.queue_count</code></p>
</li>
</ul>
</div>
</div>
</details>
</dd>
<dt class="hdlist1"><a id="configuration-properties-aggregated-hibernate-search-backend-lucenehibernate.search.backend.indexing.queue_size"></a> <code>hibernate.search.backend.indexing.queue_size</code></dt>
<dd>
<p>The size of indexing queues.</p>
<div class="paragraph">
<p>Expects a strictly positive integer value, or a string that can be parsed into an integer value.</p>
</div>
<div class="paragraph">
<p>See the reference documentation, section "Lucene backend - Indexing", for more information about this setting and its implications.</p>
</div>
<div class="paragraph">
<p>Defaults to <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/backend/lucene/cfg/LuceneIndexSettings.Defaults.html#INDEXING_QUEUE_SIZE"><code>LuceneIndexSettings.Defaults.INDEXING_QUEUE_SIZE</code></a>.</p>
</div>
<div class="paragraph">
<p>Default value: <code>1000</code></p>
</div>
<details>
<summary class="title">Variants of this configuration property (click to open)</summary>
<div class="content">
<div class="ulist">
<ul>
<li>
<p><code>hibernate.search.backend.indexes.&lt;index-name&gt;.indexing.queue_size</code></p>
</li>
<li>
<p><code>hibernate.search.backends.&lt;backend-name&gt;.indexing.queue_size</code></p>
</li>
<li>
<p><code>hibernate.search.backends.&lt;backend-name&gt;.indexes.&lt;index-name&gt;.indexing.queue_size</code></p>
</li>
</ul>
</div>
</div>
</details>
</dd>
<dt class="hdlist1"><a id="configuration-properties-aggregated-hibernate-search-backend-lucenehibernate.search.backend.io.commit_interval"></a> <code>hibernate.search.backend.io.commit_interval</code></dt>
<dd>
<p>How much time may pass after an index change until the change is committed.</p>
<div class="paragraph">
<p>Only available for the "near-real-time" I/O strategy.</p>
</div>
<div class="paragraph">
<p>This effectively defines how long changes may be in an "unsafe" state, where a crash or power loss will result in data loss. For example:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>if set to 0, changes are safe as soon as the background process finishes treating a batch of changes.</p>
</li>
<li>
<p>if set to 1000, changes may not be safe for an additional 1 second after the background process finishes treating a batch. There is a benefit, though: index changes occurring less than 1 second after another change may execute faster.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Note that individual write operations may trigger a forced commit (for example with the <code>write-sync</code> and <code>sync</code> indexing plan synchronization strategies in the ORM mapper), in which case you will only benefit from a non-zero commit interval during intensive indexing (mass indexer, &#8230;&#8203;).</p>
</div>
<div class="paragraph">
<p>Note that committing is <strong>not</strong> necessary to make changes visible to search queries: the two concepts are unrelated. See <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/backend/lucene/cfg/LuceneIndexSettings.html#IO_REFRESH_INTERVAL"><code>IO_REFRESH_INTERVAL</code></a>.</p>
</div>
<div class="paragraph">
<p>Expects a positive Integer value in milliseconds, such as <code>1000</code>, or a String that can be parsed into such Integer value.</p>
</div>
<div class="paragraph">
<p>Defaults to <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/backend/lucene/cfg/LuceneIndexSettings.Defaults.html#IO_COMMIT_INTERVAL"><code>LuceneIndexSettings.Defaults.IO_COMMIT_INTERVAL</code></a>.</p>
</div>
<div class="paragraph">
<p>Default value: <code>1000</code></p>
</div>
<details>
<summary class="title">Variants of this configuration property (click to open)</summary>
<div class="content">
<div class="ulist">
<ul>
<li>
<p><code>hibernate.search.backend.indexes.&lt;index-name&gt;.io.commit_interval</code></p>
</li>
<li>
<p><code>hibernate.search.backends.&lt;backend-name&gt;.io.commit_interval</code></p>
</li>
<li>
<p><code>hibernate.search.backends.&lt;backend-name&gt;.indexes.&lt;index-name&gt;.io.commit_interval</code></p>
</li>
</ul>
</div>
</div>
</details>
</dd>
<dt class="hdlist1"><a id="configuration-properties-aggregated-hibernate-search-backend-lucenehibernate.search.backend.io.merge.calibrate_by_deletes"></a> <code>hibernate.search.backend.io.merge.calibrate_by_deletes</code></dt>
<dd>
<p>The value to pass to <a href="https://lucene.apache.org/core/9_9_2/core/org/apache/lucene/index/LogMergePolicy.html#setCalibrateSizeByDeletes(boolean)"><code>LogMergePolicy.setCalibrateSizeByDeletes(boolean)</code></a>.</p>
<div class="paragraph">
<p>Expects a Boolean value such as <code>true</code> or <code>false</code>, or a String that can be parsed into such Boolean value.</p>
</div>
<div class="paragraph">
<p>The default for this setting is defined by Lucene.</p>
</div>
<details>
<summary class="title">Variants of this configuration property (click to open)</summary>
<div class="content">
<div class="ulist">
<ul>
<li>
<p><code>hibernate.search.backend.indexes.&lt;index-name&gt;.io.merge.calibrate_by_deletes</code></p>
</li>
<li>
<p><code>hibernate.search.backends.&lt;backend-name&gt;.io.merge.calibrate_by_deletes</code></p>
</li>
<li>
<p><code>hibernate.search.backends.&lt;backend-name&gt;.indexes.&lt;index-name&gt;.io.merge.calibrate_by_deletes</code></p>
</li>
</ul>
</div>
</div>
</details>
</dd>
<dt class="hdlist1"><a id="configuration-properties-aggregated-hibernate-search-backend-lucenehibernate.search.backend.io.merge.factor"></a> <code>hibernate.search.backend.io.merge.factor</code></dt>
<dd>
<p>The value to pass to <a href="https://lucene.apache.org/core/9_9_2/core/org/apache/lucene/index/LogMergePolicy.html#setMergeFactor(int)"><code>LogMergePolicy.setMergeFactor(int)</code></a>.</p>
<div class="paragraph">
<p>Expects a positive Integer value, or a String that can be parsed into such Integer value.</p>
</div>
<div class="paragraph">
<p>The default for this setting is defined by Lucene.</p>
</div>
<details>
<summary class="title">Variants of this configuration property (click to open)</summary>
<div class="content">
<div class="ulist">
<ul>
<li>
<p><code>hibernate.search.backend.indexes.&lt;index-name&gt;.io.merge.factor</code></p>
</li>
<li>
<p><code>hibernate.search.backends.&lt;backend-name&gt;.io.merge.factor</code></p>
</li>
<li>
<p><code>hibernate.search.backends.&lt;backend-name&gt;.indexes.&lt;index-name&gt;.io.merge.factor</code></p>
</li>
</ul>
</div>
</div>
</details>
</dd>
<dt class="hdlist1"><a id="configuration-properties-aggregated-hibernate-search-backend-lucenehibernate.search.backend.io.merge.max_docs"></a> <code>hibernate.search.backend.io.merge.max_docs</code></dt>
<dd>
<p>The value to pass to <a href="https://lucene.apache.org/core/9_9_2/core/org/apache/lucene/index/LogMergePolicy.html#setMaxMergeDocs(int)"><code>LogMergePolicy.setMaxMergeDocs(int)</code></a>.</p>
<div class="paragraph">
<p>Expects a positive Integer value, or a String that can be parsed into such Integer value.</p>
</div>
<div class="paragraph">
<p>The default for this setting is defined by Lucene.</p>
</div>
<details>
<summary class="title">Variants of this configuration property (click to open)</summary>
<div class="content">
<div class="ulist">
<ul>
<li>
<p><code>hibernate.search.backend.indexes.&lt;index-name&gt;.io.merge.max_docs</code></p>
</li>
<li>
<p><code>hibernate.search.backends.&lt;backend-name&gt;.io.merge.max_docs</code></p>
</li>
<li>
<p><code>hibernate.search.backends.&lt;backend-name&gt;.indexes.&lt;index-name&gt;.io.merge.max_docs</code></p>
</li>
</ul>
</div>
</div>
</details>
</dd>
<dt class="hdlist1"><a id="configuration-properties-aggregated-hibernate-search-backend-lucenehibernate.search.backend.io.merge.max_forced_size"></a> <code>hibernate.search.backend.io.merge.max_forced_size</code></dt>
<dd>
<p>The value to pass to <a href="https://lucene.apache.org/core/9_9_2/core/org/apache/lucene/index/LogByteSizeMergePolicy.html#setMaxMergeMBForForcedMerge(double)"><code>LogByteSizeMergePolicy.setMaxMergeMBForForcedMerge(double)</code></a>.</p>
<div class="paragraph">
<p>Expects a positive Integer value in megabytes, or a String that can be parsed into such Integer value.</p>
</div>
<div class="paragraph">
<p>The default for this setting is defined by Lucene.</p>
</div>
<details>
<summary class="title">Variants of this configuration property (click to open)</summary>
<div class="content">
<div class="ulist">
<ul>
<li>
<p><code>hibernate.search.backend.indexes.&lt;index-name&gt;.io.merge.max_forced_size</code></p>
</li>
<li>
<p><code>hibernate.search.backends.&lt;backend-name&gt;.io.merge.max_forced_size</code></p>
</li>
<li>
<p><code>hibernate.search.backends.&lt;backend-name&gt;.indexes.&lt;index-name&gt;.io.merge.max_forced_size</code></p>
</li>
</ul>
</div>
</div>
</details>
</dd>
<dt class="hdlist1"><a id="configuration-properties-aggregated-hibernate-search-backend-lucenehibernate.search.backend.io.merge.max_size"></a> <code>hibernate.search.backend.io.merge.max_size</code></dt>
<dd>
<p>The value to pass to <a href="https://lucene.apache.org/core/9_9_2/core/org/apache/lucene/index/LogByteSizeMergePolicy.html#setMaxMergeMB(double)"><code>LogByteSizeMergePolicy.setMaxMergeMB(double)</code></a>.</p>
<div class="paragraph">
<p>Expects a positive Integer value in megabytes, or a String that can be parsed into such Integer value.</p>
</div>
<div class="paragraph">
<p>The default for this setting is defined by Lucene.</p>
</div>
<details>
<summary class="title">Variants of this configuration property (click to open)</summary>
<div class="content">
<div class="ulist">
<ul>
<li>
<p><code>hibernate.search.backend.indexes.&lt;index-name&gt;.io.merge.max_size</code></p>
</li>
<li>
<p><code>hibernate.search.backends.&lt;backend-name&gt;.io.merge.max_size</code></p>
</li>
<li>
<p><code>hibernate.search.backends.&lt;backend-name&gt;.indexes.&lt;index-name&gt;.io.merge.max_size</code></p>
</li>
</ul>
</div>
</div>
</details>
</dd>
<dt class="hdlist1"><a id="configuration-properties-aggregated-hibernate-search-backend-lucenehibernate.search.backend.io.merge.min_size"></a> <code>hibernate.search.backend.io.merge.min_size</code></dt>
<dd>
<p>The value to pass to <a href="https://lucene.apache.org/core/9_9_2/core/org/apache/lucene/index/LogByteSizeMergePolicy.html#setMinMergeMB(double)"><code>LogByteSizeMergePolicy.setMinMergeMB(double)</code></a>.</p>
<div class="paragraph">
<p>Expects a positive Integer value in megabytes, or a String that can be parsed into such Integer value.</p>
</div>
<div class="paragraph">
<p>The default for this setting is defined by Lucene.</p>
</div>
<details>
<summary class="title">Variants of this configuration property (click to open)</summary>
<div class="content">
<div class="ulist">
<ul>
<li>
<p><code>hibernate.search.backend.indexes.&lt;index-name&gt;.io.merge.min_size</code></p>
</li>
<li>
<p><code>hibernate.search.backends.&lt;backend-name&gt;.io.merge.min_size</code></p>
</li>
<li>
<p><code>hibernate.search.backends.&lt;backend-name&gt;.indexes.&lt;index-name&gt;.io.merge.min_size</code></p>
</li>
</ul>
</div>
</div>
</details>
</dd>
<dt class="hdlist1"><a id="configuration-properties-aggregated-hibernate-search-backend-lucenehibernate.search.backend.io.refresh_interval"></a> <code>hibernate.search.backend.io.refresh_interval</code></dt>
<dd>
<p>How much time may pass after an index write until the index reader is considered stale and re-created.</p>
<div class="paragraph">
<p>Only available for the "near-real-time" I/O strategy.</p>
</div>
<div class="paragraph">
<p>This effectively defines how out-of-date search query results may be. For example:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If set to 0, search results will always be completely in sync with the index writes.</p>
</li>
<li>
<p>If set to 1000, search results may reflect the state of the index at most 1 second ago. There is a benefit, though: in situations where the index is being frequently written to, search queries executed less than 1 second after another query may execute faster.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Note that individual write operations may trigger a forced refresh (for example with the <code>read-sync</code> and <code>sync</code> indexing plan synchronization strategies in the ORM mapper), in which case you will only benefit from a non-zero refresh interval during intensive indexing (mass indexer, &#8230;&#8203;).</p>
</div>
<div class="paragraph">
<p>Expects a positive Integer value in milliseconds, such as <code>1000</code>, or a String that can be parsed into such Integer value.</p>
</div>
<div class="paragraph">
<p>Defaults to <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/backend/lucene/cfg/LuceneIndexSettings.Defaults.html#IO_REFRESH_INTERVAL"><code>LuceneIndexSettings.Defaults.IO_REFRESH_INTERVAL</code></a>.</p>
</div>
<div class="paragraph">
<p>Default value: <code>0</code></p>
</div>
<details>
<summary class="title">Variants of this configuration property (click to open)</summary>
<div class="content">
<div class="ulist">
<ul>
<li>
<p><code>hibernate.search.backend.indexes.&lt;index-name&gt;.io.refresh_interval</code></p>
</li>
<li>
<p><code>hibernate.search.backends.&lt;backend-name&gt;.io.refresh_interval</code></p>
</li>
<li>
<p><code>hibernate.search.backends.&lt;backend-name&gt;.indexes.&lt;index-name&gt;.io.refresh_interval</code></p>
</li>
</ul>
</div>
</div>
</details>
</dd>
<dt class="hdlist1"><a id="configuration-properties-aggregated-hibernate-search-backend-lucenehibernate.search.backend.io.strategy"></a> <code>hibernate.search.backend.io.strategy</code></dt>
<dd>
<p>How to handle input/output, i.e. how to write to and read from indexes.</p>
<div class="paragraph">
<p>Expects a <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/backend/lucene/cfg/../lowlevel/index/IOStrategyName.html"><code>IOStrategyName</code></a> value, or a String representation of such value.</p>
</div>
<div class="paragraph">
<p>Defaults to <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/backend/lucene/cfg/LuceneIndexSettings.Defaults.html#IO_STRATEGY"><code>LuceneIndexSettings.Defaults.IO_STRATEGY</code></a>.</p>
</div>
<details>
<summary class="title">Variants of this configuration property (click to open)</summary>
<div class="content">
<div class="ulist">
<ul>
<li>
<p><code>hibernate.search.backend.indexes.&lt;index-name&gt;.io.strategy</code></p>
</li>
<li>
<p><code>hibernate.search.backends.&lt;backend-name&gt;.io.strategy</code></p>
</li>
<li>
<p><code>hibernate.search.backends.&lt;backend-name&gt;.indexes.&lt;index-name&gt;.io.strategy</code></p>
</li>
</ul>
</div>
</div>
</details>
</dd>
<dt class="hdlist1"><a id="configuration-properties-aggregated-hibernate-search-backend-lucenehibernate.search.backend.io.writer.infostream"></a> <code>hibernate.search.backend.io.writer.infostream</code></dt>
<dd>
<p>Whether to log the <a href="https://lucene.apache.org/core/9_9_2/core/org/apache/lucene/index/IndexWriterConfig.html#setInfoStream(org.apache.lucene.util.InfoStream)"><code>IndexWriterConfig.setInfoStream(InfoStream)</code></a> (at the trace level) or not.</p>
<div class="paragraph">
<p>Logs are appended to the logger "org.hibernate.search.backend.lucene.infostream".</p>
</div>
<div class="paragraph">
<p>Expects a Boolean value such as <code>true</code> or <code>false</code>, or a String that can be parsed into such Boolean value.</p>
</div>
<div class="paragraph">
<p>Default is <code>false</code>.</p>
</div>
<details>
<summary class="title">Variants of this configuration property (click to open)</summary>
<div class="content">
<div class="ulist">
<ul>
<li>
<p><code>hibernate.search.backend.indexes.&lt;index-name&gt;.io.writer.infostream</code></p>
</li>
<li>
<p><code>hibernate.search.backends.&lt;backend-name&gt;.io.writer.infostream</code></p>
</li>
<li>
<p><code>hibernate.search.backends.&lt;backend-name&gt;.indexes.&lt;index-name&gt;.io.writer.infostream</code></p>
</li>
</ul>
</div>
</div>
</details>
</dd>
<dt class="hdlist1"><a id="configuration-properties-aggregated-hibernate-search-backend-lucenehibernate.search.backend.io.writer.max_buffered_docs"></a> <code>hibernate.search.backend.io.writer.max_buffered_docs</code></dt>
<dd>
<p>The value to pass to <a href="https://lucene.apache.org/core/9_9_2/core/org/apache/lucene/index/IndexWriterConfig.html#setMaxBufferedDocs(int)"><code>IndexWriterConfig.setMaxBufferedDocs(int)</code></a>.</p>
<div class="paragraph">
<p>Expects a positive Integer value, or a String that can be parsed into such Integer value.</p>
</div>
<div class="paragraph">
<p>The default for this setting is defined by Lucene.</p>
</div>
<details>
<summary class="title">Variants of this configuration property (click to open)</summary>
<div class="content">
<div class="ulist">
<ul>
<li>
<p><code>hibernate.search.backend.indexes.&lt;index-name&gt;.io.writer.max_buffered_docs</code></p>
</li>
<li>
<p><code>hibernate.search.backends.&lt;backend-name&gt;.io.writer.max_buffered_docs</code></p>
</li>
<li>
<p><code>hibernate.search.backends.&lt;backend-name&gt;.indexes.&lt;index-name&gt;.io.writer.max_buffered_docs</code></p>
</li>
</ul>
</div>
</div>
</details>
</dd>
<dt class="hdlist1"><a id="configuration-properties-aggregated-hibernate-search-backend-lucenehibernate.search.backend.io.writer.ram_buffer_size"></a> <code>hibernate.search.backend.io.writer.ram_buffer_size</code></dt>
<dd>
<p>The value to pass to <a href="https://lucene.apache.org/core/9_9_2/core/org/apache/lucene/index/IndexWriterConfig.html#setRAMBufferSizeMB(double)"><code>IndexWriterConfig.setRAMBufferSizeMB(double)</code></a>.</p>
<div class="paragraph">
<p>Expects a positive Integer value in megabytes, or a String that can be parsed into such Integer value.</p>
</div>
<div class="paragraph">
<p>The default for this setting is defined by Lucene.</p>
</div>
<details>
<summary class="title">Variants of this configuration property (click to open)</summary>
<div class="content">
<div class="ulist">
<ul>
<li>
<p><code>hibernate.search.backend.indexes.&lt;index-name&gt;.io.writer.ram_buffer_size</code></p>
</li>
<li>
<p><code>hibernate.search.backends.&lt;backend-name&gt;.io.writer.ram_buffer_size</code></p>
</li>
<li>
<p><code>hibernate.search.backends.&lt;backend-name&gt;.indexes.&lt;index-name&gt;.io.writer.ram_buffer_size</code></p>
</li>
</ul>
</div>
</div>
</details>
</dd>
<dt class="hdlist1"><a id="configuration-properties-aggregated-hibernate-search-backend-lucenehibernate.search.backend.lucene_version"></a> <code>hibernate.search.backend.lucene_version</code></dt>
<dd>
<p>The Lucene version to passed to analyzers when they are created.</p>
<div class="paragraph">
<p>This should be set in order to get consistent behavior when Lucene is upgraded.</p>
</div>
<div class="paragraph">
<p>Expects a Lucene <a href="https://lucene.apache.org/core/9_9_2/core/org/apache/lucene/util/Version.html"><code>Version</code></a> object, or a String accepted by <a href="https://lucene.apache.org/core/9_9_2/core/org/apache/lucene/util/Version.html#parseLeniently(java.lang.String)"><code>Version.parseLeniently(java.lang.String)</code></a></p>
</div>
<div class="paragraph">
<p>Defaults to <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/backend/lucene/cfg/LuceneBackendSettings.Defaults.html#LUCENE_VERSION"><code>LuceneBackendSettings.Defaults.LUCENE_VERSION</code></a>, which may change when Hibernate Search or Lucene is upgraded, and therefore does not offer any backwards-compatibility guarantees. The recommended approach is to set this property explicitly to the version of Lucene you want to target.</p>
</div>
<details>
<summary class="title">Variants of this configuration property (click to open)</summary>
<div class="content">
<div class="ulist">
<ul>
<li>
<p><code>hibernate.search.backends.&lt;backend-name&gt;.lucene_version</code></p>
</li>
</ul>
</div>
</div>
</details>
</dd>
<dt class="hdlist1"><a id="configuration-properties-aggregated-hibernate-search-backend-lucenehibernate.search.backend.multi_tenancy.strategy"></a> <code>hibernate.search.backend.multi_tenancy.strategy</code></dt>
<dd>
<p>How to implement multi-tenancy.</p>
<div class="paragraph">
<p>Expects a <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/backend/lucene/cfg/../multitenancy/MultiTenancyStrategyName.html"><code>MultiTenancyStrategyName</code></a> value, or a String representation of such value.</p>
</div>
<div class="paragraph">
<p>Defaults to <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/backend/lucene/cfg/LuceneBackendSettings.Defaults.html#MULTI_TENANCY_STRATEGY"><code>LuceneBackendSettings.Defaults.MULTI_TENANCY_STRATEGY</code></a>.</p>
</div>
<details>
<summary class="title">Variants of this configuration property (click to open)</summary>
<div class="content">
<div class="ulist">
<ul>
<li>
<p><code>hibernate.search.backends.&lt;backend-name&gt;.multi_tenancy.strategy</code></p>
</li>
</ul>
</div>
</div>
</details>
</dd>
<dt class="hdlist1"><a id="configuration-properties-aggregated-hibernate-search-backend-lucenehibernate.search.backend.query.caching.configurer"></a> <code>hibernate.search.backend.query.caching.configurer</code></dt>
<dd>
<p>The configurer for query caching.</p>
<div class="paragraph">
<p>Expects a single-valued or multi-valued reference to beans of type <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/backend/lucene/cfg/../cache/QueryCachingConfigurer.html"><code>QueryCachingConfigurer</code></a>.</p>
</div>
<div class="paragraph">
<p>Defaults to no value.</p>
</div>
<details>
<summary class="title">Variants of this configuration property (click to open)</summary>
<div class="content">
<div class="ulist">
<ul>
<li>
<p><code>hibernate.search.backends.&lt;backend-name&gt;.query.caching.configurer</code></p>
</li>
</ul>
</div>
</div>
</details>
</dd>
<dt class="hdlist1"><a id="configuration-properties-aggregated-hibernate-search-backend-lucenehibernate.search.backend.sharding.number_of_shards"></a> <code>hibernate.search.backend.sharding.number_of_shards</code></dt>
<dd>
<p>The number of shards to create for the index, i.e. the number of "physical" indexes, each holding a part of the index data.</p>
<div class="paragraph">
<p>Only available for the <code>hash</code> <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/backend/lucene/cfg/LuceneIndexSettings.html#SHARDING_STRATEGY"><code>sharding strategy</code></a>.</p>
</div>
<div class="paragraph">
<p>Expects a strictly positive Integer value, such as 4, or a String that can be parsed into such Integer value.</p>
</div>
<div class="paragraph">
<p>No default: this property must be set when using the <code>hash</code> sharding strategy.</p>
</div>
<details>
<summary class="title">Variants of this configuration property (click to open)</summary>
<div class="content">
<div class="ulist">
<ul>
<li>
<p><code>hibernate.search.backend.indexes.&lt;index-name&gt;.sharding.number_of_shards</code></p>
</li>
<li>
<p><code>hibernate.search.backends.&lt;backend-name&gt;.sharding.number_of_shards</code></p>
</li>
<li>
<p><code>hibernate.search.backends.&lt;backend-name&gt;.indexes.&lt;index-name&gt;.sharding.number_of_shards</code></p>
</li>
</ul>
</div>
</div>
</details>
</dd>
<dt class="hdlist1"><a id="configuration-properties-aggregated-hibernate-search-backend-lucenehibernate.search.backend.sharding.shard_identifiers"></a> <code>hibernate.search.backend.sharding.shard_identifiers</code></dt>
<dd>
<p>The list of shard identifiers to accept for the index.</p>
<div class="paragraph">
<p>Only available for the <code>explicit</code> <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/backend/lucene/cfg/LuceneIndexSettings.html#SHARDING_STRATEGY"><code>sharding strategy</code></a>.</p>
</div>
<div class="paragraph">
<p>Expects either a String containing multiple shard identifiers separated by commas (','), or a <code>Collection&lt;String&gt;</code> containing such shard identifiers.</p>
</div>
<div class="paragraph">
<p>No default: this property must be set when using the <code>explicit</code> sharding strategy.</p>
</div>
<details>
<summary class="title">Variants of this configuration property (click to open)</summary>
<div class="content">
<div class="ulist">
<ul>
<li>
<p><code>hibernate.search.backend.indexes.&lt;index-name&gt;.sharding.shard_identifiers</code></p>
</li>
<li>
<p><code>hibernate.search.backends.&lt;backend-name&gt;.sharding.shard_identifiers</code></p>
</li>
<li>
<p><code>hibernate.search.backends.&lt;backend-name&gt;.indexes.&lt;index-name&gt;.sharding.shard_identifiers</code></p>
</li>
</ul>
</div>
</div>
</details>
</dd>
<dt class="hdlist1"><a id="configuration-properties-aggregated-hibernate-search-backend-lucenehibernate.search.backend.sharding.strategy"></a> <code>hibernate.search.backend.sharding.strategy</code></dt>
<dd>
<p>The sharding strategy, deciding the number of shards, their identifiers, and how to translate a routing key into a shard identifier.</p>
<div class="paragraph">
<p>Expects a String, such as "hash". See the reference documentation for a list of available values.</p>
</div>
<div class="paragraph">
<p>Defaults to <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/backend/lucene/cfg/LuceneIndexSettings.Defaults.html#SHARDING_STRATEGY"><code>LuceneIndexSettings.Defaults.SHARDING_STRATEGY</code></a> (no sharding).</p>
</div>
<div class="paragraph">
<p>Default value: <code>"none"</code></p>
</div>
<details>
<summary class="title">Variants of this configuration property (click to open)</summary>
<div class="content">
<div class="ulist">
<ul>
<li>
<p><code>hibernate.search.backend.indexes.&lt;index-name&gt;.sharding.strategy</code></p>
</li>
<li>
<p><code>hibernate.search.backends.&lt;backend-name&gt;.sharding.strategy</code></p>
</li>
<li>
<p><code>hibernate.search.backends.&lt;backend-name&gt;.indexes.&lt;index-name&gt;.sharding.strategy</code></p>
</li>
</ul>
</div>
</div>
</details>
</dd>
<dt class="hdlist1"><a id="configuration-properties-aggregated-hibernate-search-backend-lucenehibernate.search.backend.thread_pool.size"></a> <code>hibernate.search.backend.thread_pool.size</code></dt>
<dd>
<p>The size of the thread pool assigned to the backend.</p>
<div class="paragraph">
<p>Expects a strictly positive integer value, or a string that can be parsed into an integer value.</p>
</div>
<div class="paragraph">
<p>See the reference documentation, section "Lucene backend - Threads", for more information about this setting and its implications.</p>
</div>
<div class="paragraph">
<p>Defaults to the number of processor cores available to the JVM on startup.</p>
</div>
<details>
<summary class="title">Variants of this configuration property (click to open)</summary>
<div class="content">
<div class="ulist">
<ul>
<li>
<p><code>hibernate.search.backends.&lt;backend-name&gt;.thread_pool.size</code></p>
</li>
</ul>
</div>
</div>
</details>
</dd>
</dl>
</div>
</div>
<div class="sect2">
<h3 id="configuration-properties-aggregated-hibernate-search-backend-elasticsearch"><a class="anchor" href="#configuration-properties-aggregated-hibernate-search-backend-elasticsearch"></a>A.3. Hibernate Search Backend - Elasticsearch</h3>
<div class="dlist">
<dl>
<dt class="hdlist1"><a id="configuration-properties-aggregated-hibernate-search-backend-elasticsearchhibernate.search.backend.analysis.configurer"></a> <code>hibernate.search.backend.analysis.configurer</code></dt>
<dd>
<p>The analysis configurer applied to this index.</p>
<div class="paragraph">
<p>Expects a single-valued or multi-valued reference to beans of type <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/backend/elasticsearch/cfg/../analysis/ElasticsearchAnalysisConfigurer.html"><code>ElasticsearchAnalysisConfigurer</code></a>.</p>
</div>
<div class="paragraph">
<p>Defaults to no value.</p>
</div>
<details>
<summary class="title">Variants of this configuration property (click to open)</summary>
<div class="content">
<div class="ulist">
<ul>
<li>
<p><code>hibernate.search.backend.indexes.&lt;index-name&gt;.analysis.configurer</code></p>
</li>
<li>
<p><code>hibernate.search.backends.&lt;backend-name&gt;.analysis.configurer</code></p>
</li>
<li>
<p><code>hibernate.search.backends.&lt;backend-name&gt;.indexes.&lt;index-name&gt;.analysis.configurer</code></p>
</li>
</ul>
</div>
</div>
</details>
</dd>
<dt class="hdlist1"><a id="configuration-properties-aggregated-hibernate-search-backend-elasticsearchhibernate.search.backend.client.configurer"></a> <code>hibernate.search.backend.client.configurer</code></dt>
<dd>
<p>A <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/backend/elasticsearch/cfg/../client/ElasticsearchHttpClientConfigurer.html"><code>ElasticsearchHttpClientConfigurer</code></a> that defines custom HTTP client configuration.</p>
<div class="paragraph">
<p>It can be used for example to tune the SSL context to accept self-signed certificates. It allows overriding other HTTP client settings, such as <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/backend/elasticsearch/cfg/ElasticsearchBackendSettings.html#USERNAME"><code>USERNAME</code></a> or <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/backend/elasticsearch/cfg/ElasticsearchBackendSettings.html#MAX_CONNECTIONS_PER_ROUTE"><code>MAX_CONNECTIONS_PER_ROUTE</code></a>.</p>
</div>
<div class="paragraph">
<p>Expects a reference to a bean of type <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/backend/elasticsearch/cfg/../client/ElasticsearchHttpClientConfigurer.html"><code>ElasticsearchHttpClientConfigurer</code></a>.</p>
</div>
<div class="paragraph">
<p>Defaults to no value.</p>
</div>
<details>
<summary class="title">Variants of this configuration property (click to open)</summary>
<div class="content">
<div class="ulist">
<ul>
<li>
<p><code>hibernate.search.backends.&lt;backend-name&gt;.client.configurer</code></p>
</li>
</ul>
</div>
</div>
</details>
</dd>
<dt class="hdlist1"><a id="configuration-properties-aggregated-hibernate-search-backend-elasticsearchhibernate.search.backend.connection_timeout"></a> <code>hibernate.search.backend.connection_timeout</code></dt>
<dd>
<p>The timeout when establishing a connection to an Elasticsearch server.</p>
<div class="paragraph">
<p>Expects a positive Integer value in milliseconds, such as <code>3000</code>, or a String that can be parsed into such Integer value.</p>
</div>
<div class="paragraph">
<p>Defaults to <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/backend/elasticsearch/cfg/ElasticsearchBackendSettings.Defaults.html#CONNECTION_TIMEOUT"><code>ElasticsearchBackendSettings.Defaults.CONNECTION_TIMEOUT</code></a>.</p>
</div>
<div class="paragraph">
<p>Default value: <code>1000</code></p>
</div>
<details>
<summary class="title">Variants of this configuration property (click to open)</summary>
<div class="content">
<div class="ulist">
<ul>
<li>
<p><code>hibernate.search.backends.&lt;backend-name&gt;.connection_timeout</code></p>
</li>
</ul>
</div>
</div>
</details>
</dd>
<dt class="hdlist1"><a id="configuration-properties-aggregated-hibernate-search-backend-elasticsearchhibernate.search.backend.discovery.enabled"></a> <code>hibernate.search.backend.discovery.enabled</code></dt>
<dd>
<p>Whether automatic discovery of nodes in the Elasticsearch cluster is enabled.</p>
<div class="paragraph">
<p>Expects a Boolean value such as <code>true</code> or <code>false</code>, or a string that can be parsed into a Boolean value.</p>
</div>
<div class="paragraph">
<p>Defaults to <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/backend/elasticsearch/cfg/ElasticsearchBackendSettings.Defaults.html#DISCOVERY_ENABLED"><code>ElasticsearchBackendSettings.Defaults.DISCOVERY_ENABLED</code></a>.</p>
</div>
<div class="paragraph">
<p>Default value: <code>false</code></p>
</div>
<details>
<summary class="title">Variants of this configuration property (click to open)</summary>
<div class="content">
<div class="ulist">
<ul>
<li>
<p><code>hibernate.search.backends.&lt;backend-name&gt;.discovery.enabled</code></p>
</li>
</ul>
</div>
</div>
</details>
</dd>
<dt class="hdlist1"><a id="configuration-properties-aggregated-hibernate-search-backend-elasticsearchhibernate.search.backend.discovery.refresh_interval"></a> <code>hibernate.search.backend.discovery.refresh_interval</code></dt>
<dd>
<p>The time interval between two executions of the automatic discovery, if enabled.</p>
<div class="paragraph">
<p>Expects a positive Integer value in seconds, such as <code>2</code>, or a String that can be parsed into such Integer value.</p>
</div>
<div class="paragraph">
<p>Defaults to <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/backend/elasticsearch/cfg/ElasticsearchBackendSettings.Defaults.html#DISCOVERY_REFRESH_INTERVAL"><code>ElasticsearchBackendSettings.Defaults.DISCOVERY_REFRESH_INTERVAL</code></a>.</p>
</div>
<div class="paragraph">
<p>Default value: <code>10</code></p>
</div>
<details>
<summary class="title">Variants of this configuration property (click to open)</summary>
<div class="content">
<div class="ulist">
<ul>
<li>
<p><code>hibernate.search.backends.&lt;backend-name&gt;.discovery.refresh_interval</code></p>
</li>
</ul>
</div>
</div>
</details>
</dd>
<dt class="hdlist1"><a id="configuration-properties-aggregated-hibernate-search-backend-elasticsearchhibernate.search.backend.dynamic_mapping"></a> <code>hibernate.search.backend.dynamic_mapping</code></dt>
<dd>
<p>The default for the <code>dynamic_mapping</code> attribute in the Elasticsearch mapping.</p>
<div class="paragraph">
<p>In case of dynamic fields with field templates, this setting will be ignored, since field templates force <code>dynamic_mapping</code> to <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/backend/elasticsearch/cfg/../index/DynamicMapping.html#TRUE"><code>DynamicMapping.TRUE</code></a>.</p>
</div>
<div class="paragraph">
<p>Defaults to <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/backend/elasticsearch/cfg/ElasticsearchIndexSettings.Defaults.html#DYNAMIC_MAPPING"><code>ElasticsearchIndexSettings.Defaults.DYNAMIC_MAPPING</code></a>.</p>
</div>
<details>
<summary class="title">Variants of this configuration property (click to open)</summary>
<div class="content">
<div class="ulist">
<ul>
<li>
<p><code>hibernate.search.backend.indexes.&lt;index-name&gt;.dynamic_mapping</code></p>
</li>
<li>
<p><code>hibernate.search.backends.&lt;backend-name&gt;.dynamic_mapping</code></p>
</li>
<li>
<p><code>hibernate.search.backends.&lt;backend-name&gt;.indexes.&lt;index-name&gt;.dynamic_mapping</code></p>
</li>
</ul>
</div>
</div>
</details>
</dd>
<dt class="hdlist1"><a id="configuration-properties-aggregated-hibernate-search-backend-elasticsearchhibernate.search.backend.hosts"></a> <code>hibernate.search.backend.hosts</code></dt>
<dd>
<p>The hostname and ports of the Elasticsearch servers to connect to.</p>
<div class="paragraph">
<p>Expects a String representing a hostname and port such as <code>localhost</code> or <code>es.mycompany.com:4400</code>, or a String containing multiple such hostname-and-port strings separated by commas, or a <code>Collection&lt;String&gt;</code> containing such hostname-and-port strings.</p>
</div>
<div class="paragraph">
<p>Multiple servers may be specified for load-balancing: requests will be assigned to each host in turns.</p>
</div>
<div class="paragraph">
<p>Setting this property at the same time as <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/backend/elasticsearch/cfg/ElasticsearchBackendSettings.html#URIS"><code>URIS</code></a> will lead to an exception being thrown on startup.</p>
</div>
<div class="paragraph">
<p>Defaults to <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/backend/elasticsearch/cfg/ElasticsearchBackendSettings.Defaults.html#HOSTS"><code>ElasticsearchBackendSettings.Defaults.HOSTS</code></a>.</p>
</div>
<details>
<summary class="title">Variants of this configuration property (click to open)</summary>
<div class="content">
<div class="ulist">
<ul>
<li>
<p><code>hibernate.search.backends.&lt;backend-name&gt;.hosts</code></p>
</li>
</ul>
</div>
</div>
</details>
</dd>
<dt class="hdlist1"><a id="configuration-properties-aggregated-hibernate-search-backend-elasticsearchhibernate.search.backend.indexing.max_bulk_size"></a> <code>hibernate.search.backend.indexing.max_bulk_size</code></dt>
<dd>
<p>The maximum size of bulk requests created when processing indexing queues.</p>
<div class="paragraph">
<p>Expects a strictly positive integer value, or a string that can be parsed into an integer value.</p>
</div>
<div class="paragraph">
<p>See the reference documentation, section "Elasticsearch backend - Indexing", for more information about this setting and its implications.</p>
</div>
<div class="paragraph">
<p>Defaults to <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/backend/elasticsearch/cfg/ElasticsearchIndexSettings.Defaults.html#INDEXING_MAX_BULK_SIZE"><code>ElasticsearchIndexSettings.Defaults.INDEXING_MAX_BULK_SIZE</code></a>.</p>
</div>
<div class="paragraph">
<p>Default value: <code>100</code></p>
</div>
<details>
<summary class="title">Variants of this configuration property (click to open)</summary>
<div class="content">
<div class="ulist">
<ul>
<li>
<p><code>hibernate.search.backend.indexes.&lt;index-name&gt;.indexing.max_bulk_size</code></p>
</li>
<li>
<p><code>hibernate.search.backends.&lt;backend-name&gt;.indexing.max_bulk_size</code></p>
</li>
<li>
<p><code>hibernate.search.backends.&lt;backend-name&gt;.indexes.&lt;index-name&gt;.indexing.max_bulk_size</code></p>
</li>
</ul>
</div>
</div>
</details>
</dd>
<dt class="hdlist1"><a id="configuration-properties-aggregated-hibernate-search-backend-elasticsearchhibernate.search.backend.indexing.queue_count"></a> <code>hibernate.search.backend.indexing.queue_count</code></dt>
<dd>
<p>The number of indexing queues assigned to each index.</p>
<div class="paragraph">
<p>Expects a strictly positive integer value, or a string that can be parsed into an integer value.</p>
</div>
<div class="paragraph">
<p>Defaults to <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/backend/elasticsearch/cfg/ElasticsearchIndexSettings.Defaults.html#INDEXING_QUEUE_COUNT"><code>ElasticsearchIndexSettings.Defaults.INDEXING_QUEUE_COUNT</code></a>.</p>
</div>
<div class="paragraph">
<p>See the reference documentation, section "Elasticsearch backend - Indexing", for more information about this setting and its implications.</p>
</div>
<div class="paragraph">
<p>Default value: <code>10</code></p>
</div>
<details>
<summary class="title">Variants of this configuration property (click to open)</summary>
<div class="content">
<div class="ulist">
<ul>
<li>
<p><code>hibernate.search.backend.indexes.&lt;index-name&gt;.indexing.queue_count</code></p>
</li>
<li>
<p><code>hibernate.search.backends.&lt;backend-name&gt;.indexing.queue_count</code></p>
</li>
<li>
<p><code>hibernate.search.backends.&lt;backend-name&gt;.indexes.&lt;index-name&gt;.indexing.queue_count</code></p>
</li>
</ul>
</div>
</div>
</details>
</dd>
<dt class="hdlist1"><a id="configuration-properties-aggregated-hibernate-search-backend-elasticsearchhibernate.search.backend.indexing.queue_size"></a> <code>hibernate.search.backend.indexing.queue_size</code></dt>
<dd>
<p>The size of indexing queues.</p>
<div class="paragraph">
<p>Expects a strictly positive integer value, or a string that can be parsed into an integer value.</p>
</div>
<div class="paragraph">
<p>See the reference documentation, section "Elasticsearch backend - Indexing", for more information about this setting and its implications.</p>
</div>
<div class="paragraph">
<p>Defaults to <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/backend/elasticsearch/cfg/ElasticsearchIndexSettings.Defaults.html#INDEXING_QUEUE_SIZE"><code>ElasticsearchIndexSettings.Defaults.INDEXING_QUEUE_SIZE</code></a>.</p>
</div>
<div class="paragraph">
<p>Default value: <code>1000</code></p>
</div>
<details>
<summary class="title">Variants of this configuration property (click to open)</summary>
<div class="content">
<div class="ulist">
<ul>
<li>
<p><code>hibernate.search.backend.indexes.&lt;index-name&gt;.indexing.queue_size</code></p>
</li>
<li>
<p><code>hibernate.search.backends.&lt;backend-name&gt;.indexing.queue_size</code></p>
</li>
<li>
<p><code>hibernate.search.backends.&lt;backend-name&gt;.indexes.&lt;index-name&gt;.indexing.queue_size</code></p>
</li>
</ul>
</div>
</div>
</details>
</dd>
<dt class="hdlist1"><a id="configuration-properties-aggregated-hibernate-search-backend-elasticsearchhibernate.search.backend.layout.strategy"></a> <code>hibernate.search.backend.layout.strategy</code></dt>
<dd>
<p>How to determine index names and aliases.</p>
<div class="paragraph">
<p>Expects a reference to a bean of type <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/backend/elasticsearch/cfg/../index/layout/IndexLayoutStrategy.html"><code>IndexLayoutStrategy</code></a>.</p>
</div>
<div class="paragraph">
<p>Defaults to the <code>simple</code> strategy:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The non-alias name follows the format <code>&lt;hibernateSearchIndexName&gt;-&lt;6 digits&gt;</code></p>
</li>
<li>
<p>The write alias follows the format <code>&lt;hibernateSearchIndexName&gt;-write</code></p>
</li>
<li>
<p>The read alias follows the format <code>&lt;hibernateSearchIndexName&gt;-read</code></p>
</li>
</ul>
</div>
<details>
<summary class="title">Variants of this configuration property (click to open)</summary>
<div class="content">
<div class="ulist">
<ul>
<li>
<p><code>hibernate.search.backends.&lt;backend-name&gt;.layout.strategy</code></p>
</li>
</ul>
</div>
</div>
</details>
</dd>
<dt class="hdlist1"><a id="configuration-properties-aggregated-hibernate-search-backend-elasticsearchhibernate.search.backend.log.json_pretty_printing"></a> <code>hibernate.search.backend.log.json_pretty_printing</code></dt>
<dd>
<p>Whether JSON included in logs should be pretty-printed (indented, with line breaks).</p>
<div class="paragraph">
<p>Expects a Boolean value such as <code>true</code> or <code>false</code>, or a string that can be parsed into a Boolean value.</p>
</div>
<div class="paragraph">
<p>Defaults to <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/backend/elasticsearch/cfg/ElasticsearchBackendSettings.Defaults.html#LOG_JSON_PRETTY_PRINTING"><code>ElasticsearchBackendSettings.Defaults.LOG_JSON_PRETTY_PRINTING</code></a>.</p>
</div>
<div class="paragraph">
<p>Default value: <code>false</code></p>
</div>
<details>
<summary class="title">Variants of this configuration property (click to open)</summary>
<div class="content">
<div class="ulist">
<ul>
<li>
<p><code>hibernate.search.backends.&lt;backend-name&gt;.log.json_pretty_printing</code></p>
</li>
</ul>
</div>
</div>
</details>
</dd>
<dt class="hdlist1"><a id="configuration-properties-aggregated-hibernate-search-backend-elasticsearchhibernate.search.backend.mapping.type_name.strategy"></a> <code>hibernate.search.backend.mapping.type_name.strategy</code></dt>
<dd>
<p>How to map documents to their type name, i.e. how to determine the type name of a document in search hits.</p>
<div class="paragraph">
<p>Expects a <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/backend/elasticsearch/cfg/../mapping/TypeNameMappingStrategyName.html"><code>TypeNameMappingStrategyName</code></a> value, or a String representation of such value.</p>
</div>
<div class="paragraph">
<p>Defaults to <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/backend/elasticsearch/cfg/ElasticsearchBackendSettings.Defaults.html#MAPPING_TYPE_NAME_STRATEGY"><code>ElasticsearchBackendSettings.Defaults.MAPPING_TYPE_NAME_STRATEGY</code></a>.</p>
</div>
<details>
<summary class="title">Variants of this configuration property (click to open)</summary>
<div class="content">
<div class="ulist">
<ul>
<li>
<p><code>hibernate.search.backends.&lt;backend-name&gt;.mapping.type_name.strategy</code></p>
</li>
</ul>
</div>
</div>
</details>
</dd>
<dt class="hdlist1"><a id="configuration-properties-aggregated-hibernate-search-backend-elasticsearchhibernate.search.backend.max_connections"></a> <code>hibernate.search.backend.max_connections</code></dt>
<dd>
<p>The maximum number of simultaneous connections to the Elasticsearch cluster, all hosts taken together.</p>
<div class="paragraph">
<p>Expects a positive Integer value, such as <code>20</code>, or a String that can be parsed into such Integer value.</p>
</div>
<div class="paragraph">
<p>Defaults to <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/backend/elasticsearch/cfg/ElasticsearchBackendSettings.Defaults.html#MAX_CONNECTIONS"><code>ElasticsearchBackendSettings.Defaults.MAX_CONNECTIONS</code></a>.</p>
</div>
<div class="paragraph">
<p>Default value: <code>20</code></p>
</div>
<details>
<summary class="title">Variants of this configuration property (click to open)</summary>
<div class="content">
<div class="ulist">
<ul>
<li>
<p><code>hibernate.search.backends.&lt;backend-name&gt;.max_connections</code></p>
</li>
</ul>
</div>
</div>
</details>
</dd>
<dt class="hdlist1"><a id="configuration-properties-aggregated-hibernate-search-backend-elasticsearchhibernate.search.backend.max_connections_per_route"></a> <code>hibernate.search.backend.max_connections_per_route</code></dt>
<dd>
<p>The maximum number of simultaneous connections to each host of the Elasticsearch cluster.</p>
<div class="paragraph">
<p>Expects a positive Integer value, such as <code>10</code>, or a String that can be parsed into such Integer value.</p>
</div>
<div class="paragraph">
<p>Defaults to <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/backend/elasticsearch/cfg/ElasticsearchBackendSettings.Defaults.html#MAX_CONNECTIONS_PER_ROUTE"><code>ElasticsearchBackendSettings.Defaults.MAX_CONNECTIONS_PER_ROUTE</code></a>.</p>
</div>
<div class="paragraph">
<p>Default value: <code>10</code></p>
</div>
<details>
<summary class="title">Variants of this configuration property (click to open)</summary>
<div class="content">
<div class="ulist">
<ul>
<li>
<p><code>hibernate.search.backends.&lt;backend-name&gt;.max_connections_per_route</code></p>
</li>
</ul>
</div>
</div>
</details>
</dd>
<dt class="hdlist1"><a id="configuration-properties-aggregated-hibernate-search-backend-elasticsearchhibernate.search.backend.max_keep_alive"></a> <code>hibernate.search.backend.max_keep_alive</code></dt>
<dd>
<p>How long connections to the Elasticsearch cluster can be kept idle.</p>
<div class="paragraph">
<p>Expects a positive Long value of milliseconds, such as 60000, or a String that can be parsed into such Integer value.</p>
</div>
<div class="paragraph">
<p>If the response from an Elasticsearch cluster contains a <code>Keep-Alive</code> header, then the effective max idle time will be whichever is lower: the duration from the <code>Keep-Alive</code> header or the value of this property (if set).</p>
</div>
<div class="paragraph">
<p>If this property is not set, only the <code>Keep-Alive</code> header is considered, and if it&#8217;s absent, idle connections will be kept forever.</p>
</div>
<details>
<summary class="title">Variants of this configuration property (click to open)</summary>
<div class="content">
<div class="ulist">
<ul>
<li>
<p><code>hibernate.search.backends.&lt;backend-name&gt;.max_keep_alive</code></p>
</li>
</ul>
</div>
</div>
</details>
</dd>
<dt class="hdlist1"><a id="configuration-properties-aggregated-hibernate-search-backend-elasticsearchhibernate.search.backend.multi_tenancy.strategy"></a> <code>hibernate.search.backend.multi_tenancy.strategy</code></dt>
<dd>
<p>How to implement multi-tenancy.</p>
<div class="paragraph">
<p>Expects a <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/backend/elasticsearch/cfg/../multitenancy/MultiTenancyStrategyName.html"><code>MultiTenancyStrategyName</code></a> value, or a String representation of such value.</p>
</div>
<div class="paragraph">
<p>Defaults to <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/backend/elasticsearch/cfg/ElasticsearchBackendSettings.Defaults.html#MULTI_TENANCY_STRATEGY"><code>ElasticsearchBackendSettings.Defaults.MULTI_TENANCY_STRATEGY</code></a>.</p>
</div>
<details>
<summary class="title">Variants of this configuration property (click to open)</summary>
<div class="content">
<div class="ulist">
<ul>
<li>
<p><code>hibernate.search.backends.&lt;backend-name&gt;.multi_tenancy.strategy</code></p>
</li>
</ul>
</div>
</div>
</details>
</dd>
<dt class="hdlist1"><a id="configuration-properties-aggregated-hibernate-search-backend-elasticsearchhibernate.search.backend.password"></a> <code>hibernate.search.backend.password</code></dt>
<dd>
<p>The password to send when connecting to the Elasticsearch servers (HTTP authentication).</p>
<div class="paragraph">
<p>Expects a String.</p>
</div>
<div class="paragraph">
<p>Defaults to no username (anonymous access).</p>
</div>
<details>
<summary class="title">Variants of this configuration property (click to open)</summary>
<div class="content">
<div class="ulist">
<ul>
<li>
<p><code>hibernate.search.backends.&lt;backend-name&gt;.password</code></p>
</li>
</ul>
</div>
</div>
</details>
</dd>
<dt class="hdlist1"><a id="configuration-properties-aggregated-hibernate-search-backend-elasticsearchhibernate.search.backend.path_prefix"></a> <code>hibernate.search.backend.path_prefix</code></dt>
<dd>
<p>Property for specifying the path prefix prepended to the request end point. Use the path prefix if your Elasticsearch instance is located at a specific context path.</p>
<div class="paragraph">
<p>Defaults to <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/backend/elasticsearch/cfg/ElasticsearchBackendSettings.Defaults.html#PATH_PREFIX"><code>ElasticsearchBackendSettings.Defaults.PATH_PREFIX</code></a>.</p>
</div>
<div class="paragraph">
<p>Default value: <code>""</code></p>
</div>
<details>
<summary class="title">Variants of this configuration property (click to open)</summary>
<div class="content">
<div class="ulist">
<ul>
<li>
<p><code>hibernate.search.backends.&lt;backend-name&gt;.path_prefix</code></p>
</li>
</ul>
</div>
</div>
</details>
</dd>
<dt class="hdlist1"><a id="configuration-properties-aggregated-hibernate-search-backend-elasticsearchhibernate.search.backend.protocol"></a> <code>hibernate.search.backend.protocol</code></dt>
<dd>
<p>The protocol to use when connecting to the Elasticsearch servers.</p>
<div class="paragraph">
<p>Expects a String: either <code>http</code> or <code>https</code>.</p>
</div>
<div class="paragraph">
<p>Setting this property at the same time as <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/backend/elasticsearch/cfg/ElasticsearchBackendSettings.html#URIS"><code>URIS</code></a> will lead to an exception being thrown on startup.</p>
</div>
<div class="paragraph">
<p>Defaults to <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/backend/elasticsearch/cfg/ElasticsearchBackendSettings.Defaults.html#PROTOCOL"><code>ElasticsearchBackendSettings.Defaults.PROTOCOL</code></a>.</p>
</div>
<div class="paragraph">
<p>Default value: <code>"http"</code></p>
</div>
<details>
<summary class="title">Variants of this configuration property (click to open)</summary>
<div class="content">
<div class="ulist">
<ul>
<li>
<p><code>hibernate.search.backends.&lt;backend-name&gt;.protocol</code></p>
</li>
</ul>
</div>
</div>
</details>
</dd>
<dt class="hdlist1"><a id="configuration-properties-aggregated-hibernate-search-backend-elasticsearchhibernate.search.backend.query.shard_failure.ignore"></a> <code>hibernate.search.backend.query.shard_failure.ignore</code></dt>
<dd>
<p>This property defines if partial shard failures are ignored.</p>
<div class="paragraph">
<p>In case all shards fail, Elasticsearch cluster will return a 400 status code itself, but if only some of the shards fail, then the client will receive a successful partial response from the shards that were successful.</p>
</div>
<div class="paragraph">
<p>To prevent getting any partial results this setting can be set to <code>false</code>. While if the partial failures should be ignored and considered as valid results then the value should be set to <code>true</code>.</p>
</div>
<div class="paragraph">
<p>Expects a Boolean value such as <code>true</code> or <code>false</code>, or a string that can be parsed into a Boolean value.</p>
</div>
<div class="paragraph">
<p>Defaults to <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/backend/elasticsearch/cfg/ElasticsearchBackendSettings.Defaults.html#QUERY_SHARD_FAILURE_IGNORE"><code>ElasticsearchBackendSettings.Defaults.QUERY_SHARD_FAILURE_IGNORE</code></a>.</p>
</div>
<div class="paragraph">
<p>Default value: <code>false</code></p>
</div>
<details>
<summary class="title">Variants of this configuration property (click to open)</summary>
<div class="content">
<div class="ulist">
<ul>
<li>
<p><code>hibernate.search.backends.&lt;backend-name&gt;.query.shard_failure.ignore</code></p>
</li>
</ul>
</div>
</div>
</details>
</dd>
<dt class="hdlist1"><a id="configuration-properties-aggregated-hibernate-search-backend-elasticsearchhibernate.search.backend.read_timeout"></a> <code>hibernate.search.backend.read_timeout</code></dt>
<dd>
<p>The timeout when reading responses from an Elasticsearch server.</p>
<div class="paragraph">
<p>Expects a positive Integer value in milliseconds, such as <code>60000</code>, or a String that can be parsed into such Integer value.</p>
</div>
<div class="paragraph">
<p>Defaults to <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/backend/elasticsearch/cfg/ElasticsearchBackendSettings.Defaults.html#READ_TIMEOUT"><code>ElasticsearchBackendSettings.Defaults.READ_TIMEOUT</code></a>.</p>
</div>
<div class="paragraph">
<p>Default value: <code>30000</code></p>
</div>
<details>
<summary class="title">Variants of this configuration property (click to open)</summary>
<div class="content">
<div class="ulist">
<ul>
<li>
<p><code>hibernate.search.backends.&lt;backend-name&gt;.read_timeout</code></p>
</li>
</ul>
</div>
</div>
</details>
</dd>
<dt class="hdlist1"><a id="configuration-properties-aggregated-hibernate-search-backend-elasticsearchhibernate.search.backend.request_timeout"></a> <code>hibernate.search.backend.request_timeout</code></dt>
<dd>
<p>The timeout when executing a request to an Elasticsearch server.</p>
<div class="paragraph">
<p>This includes the time needed to establish a connection, send the request and read the response.</p>
</div>
<div class="paragraph">
<p>Expects a positive Integer value in milliseconds, such as 60000, or a String that can be parsed into such Integer value.</p>
</div>
<div class="paragraph">
<p>Defaults to no request timeout.</p>
</div>
<details>
<summary class="title">Variants of this configuration property (click to open)</summary>
<div class="content">
<div class="ulist">
<ul>
<li>
<p><code>hibernate.search.backends.&lt;backend-name&gt;.request_timeout</code></p>
</li>
</ul>
</div>
</div>
</details>
</dd>
<dt class="hdlist1"><a id="configuration-properties-aggregated-hibernate-search-backend-elasticsearchhibernate.search.backend.schema_management.mapping_file"></a> <code>hibernate.search.backend.schema_management.mapping_file</code></dt>
<dd>
<p>The path to a mappings file, allowing custom mappings for indexes created by Hibernate Search as part of schema management.</p>
<div class="paragraph">
<p>Expects a string representing the path to a UTF-8-encoded file in the classpath. The file must contain index settings expressed in JSON format, with the exact same syntax as expected by the Elasticsearch server under the "mappings" property <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/mapping.html">when defining the mapping for an index</a>.</p>
</div>
<div class="paragraph">
<p>The file does not need to contain the full mapping: Hibernate Search will automatically inject missing properties (index fields) in the given mapping.</p>
</div>
<div class="paragraph">
<p>Conflicts between the given mapping and the mapping generated by Hibernate Search will be handled as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Mapping parameters other than <code>properties</code> at the mapping root will be those from the given mapping; those generated by Hibernate Search will be ignored.</p>
</li>
<li>
<p><code>properties</code> will be merged, using properties defined in both the given mapping and the mapping generated by Hibernate Search. If a property is defined on both sides, mapping parameters from the given mapping will be used, except for <code>properties</code>, which will be merged recursively in the same way.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Defaults to no value, meaning only index mappings generated by Hibernate Search will be used.</p>
</div>
<details>
<summary class="title">Variants of this configuration property (click to open)</summary>
<div class="content">
<div class="ulist">
<ul>
<li>
<p><code>hibernate.search.backend.indexes.&lt;index-name&gt;.schema_management.mapping_file</code></p>
</li>
<li>
<p><code>hibernate.search.backends.&lt;backend-name&gt;.schema_management.mapping_file</code></p>
</li>
<li>
<p><code>hibernate.search.backends.&lt;backend-name&gt;.indexes.&lt;index-name&gt;.schema_management.mapping_file</code></p>
</li>
</ul>
</div>
</div>
</details>
</dd>
<dt class="hdlist1"><a id="configuration-properties-aggregated-hibernate-search-backend-elasticsearchhibernate.search.backend.schema_management.minimal_required_status"></a> <code>hibernate.search.backend.schema_management.minimal_required_status</code></dt>
<dd>
<p>The minimal required status of an index on startup, before Hibernate Search can start using it.</p>
<div class="paragraph">
<p>Expects an <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/backend/elasticsearch/cfg/../index/IndexStatus.html"><code>IndexStatus</code></a> value, or a String representation of such value.</p>
</div>
<div class="paragraph">
<p>Defaults to <code>yellow</code> when targeting an Elasticsearch distribution that supports index status checking, and to no value (no requirement) when targeting an Elasticsearch distribution that does not support index status checking (like Amazon OpenSearch Serverless).</p>
</div>
<details>
<summary class="title">Variants of this configuration property (click to open)</summary>
<div class="content">
<div class="ulist">
<ul>
<li>
<p><code>hibernate.search.backend.indexes.&lt;index-name&gt;.schema_management.minimal_required_status</code></p>
</li>
<li>
<p><code>hibernate.search.backends.&lt;backend-name&gt;.schema_management.minimal_required_status</code></p>
</li>
<li>
<p><code>hibernate.search.backends.&lt;backend-name&gt;.indexes.&lt;index-name&gt;.schema_management.minimal_required_status</code></p>
</li>
</ul>
</div>
</div>
</details>
</dd>
<dt class="hdlist1"><a id="configuration-properties-aggregated-hibernate-search-backend-elasticsearchhibernate.search.backend.schema_management.minimal_required_status_wait_timeout"></a> <code>hibernate.search.backend.schema_management.minimal_required_status_wait_timeout</code></dt>
<dd>
<p>The timeout when waiting for the <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/backend/elasticsearch/cfg/ElasticsearchIndexSettings.html#SCHEMA_MANAGEMENT_MINIMAL_REQUIRED_STATUS"><code>required status</code></a>.</p>
<div class="paragraph">
<p>Expects a positive Integer value in milliseconds, such as <code>60000</code>, or a String that can be parsed into such Integer value.</p>
</div>
<div class="paragraph">
<p>Defaults to <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/backend/elasticsearch/cfg/ElasticsearchIndexSettings.Defaults.html#SCHEMA_MANAGEMENT_MINIMAL_REQUIRED_STATUS_WAIT_TIMEOUT"><code>ElasticsearchIndexSettings.Defaults.SCHEMA_MANAGEMENT_MINIMAL_REQUIRED_STATUS_WAIT_TIMEOUT</code></a>.</p>
</div>
<div class="paragraph">
<p>Default value: <code>10000</code></p>
</div>
<details>
<summary class="title">Variants of this configuration property (click to open)</summary>
<div class="content">
<div class="ulist">
<ul>
<li>
<p><code>hibernate.search.backend.indexes.&lt;index-name&gt;.schema_management.minimal_required_status_wait_timeout</code></p>
</li>
<li>
<p><code>hibernate.search.backends.&lt;backend-name&gt;.schema_management.minimal_required_status_wait_timeout</code></p>
</li>
<li>
<p><code>hibernate.search.backends.&lt;backend-name&gt;.indexes.&lt;index-name&gt;.schema_management.minimal_required_status_wait_timeout</code></p>
</li>
</ul>
</div>
</div>
</details>
</dd>
<dt class="hdlist1"><a id="configuration-properties-aggregated-hibernate-search-backend-elasticsearchhibernate.search.backend.schema_management.settings_file"></a> <code>hibernate.search.backend.schema_management.settings_file</code></dt>
<dd>
<p>The path to a settings file, allowing custom settings for indexes created by Hibernate Search as part of schema management.</p>
<div class="paragraph">
<p>Expects a string representing the path to a UTF-8-encoded file in the classpath. The file must contain index settings expressed in JSON format, with the exact same syntax as expected by the Elasticsearch server under the "settings" property <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/indices-create-index.html#create-index-settings">when creating an index</a>. For example, if the file content is <code>{"index.codec": "best_compression"}</code>, it will set <code>index.codec</code> to <code>best_compression</code>.</p>
</div>
<div class="paragraph">
<p>Note that the settings generated by Hibernate Search will be overridden in case of conflict of some definitions. For instance, if an analyzer "myAnalyzer" is defined by the <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/backend/elasticsearch/cfg/ElasticsearchIndexSettings.html#ANALYSIS_CONFIGURER"><code>ANALYSIS_CONFIGURER</code></a> <strong>and</strong> this settings file, the definition from the settings file will take precedence. If it is only defined in either the analysis configurer or the settings file, but not both, it will be preserved as-is.</p>
</div>
<div class="paragraph">
<p>Defaults to no value, meaning only index settings generated by Hibernate Search will be used.</p>
</div>
<details>
<summary class="title">Variants of this configuration property (click to open)</summary>
<div class="content">
<div class="ulist">
<ul>
<li>
<p><code>hibernate.search.backend.indexes.&lt;index-name&gt;.schema_management.settings_file</code></p>
</li>
<li>
<p><code>hibernate.search.backends.&lt;backend-name&gt;.schema_management.settings_file</code></p>
</li>
<li>
<p><code>hibernate.search.backends.&lt;backend-name&gt;.indexes.&lt;index-name&gt;.schema_management.settings_file</code></p>
</li>
</ul>
</div>
</div>
</details>
</dd>
<dt class="hdlist1"><a id="configuration-properties-aggregated-hibernate-search-backend-elasticsearchhibernate.search.backend.scroll_timeout"></a> <code>hibernate.search.backend.scroll_timeout</code></dt>
<dd>
<p>Property for specifying the maximum duration a <a href="http://hibernate.org/search/apidocs/org/hibernate/search/engine/search/query/SearchFetchable.html#scroll(int)"><code>scroll</code></a> will be usable if no other results are fetched from Elasticsearch.</p>
<div class="paragraph">
<p>Expects a positive Integer value in seconds, such as 60, or a String that can be parsed into such Integer value.</p>
</div>
<div class="paragraph">
<p>Defaults to <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/backend/elasticsearch/cfg/ElasticsearchBackendSettings.Defaults.html#SCROLL_TIMEOUT"><code>ElasticsearchBackendSettings.Defaults.SCROLL_TIMEOUT</code></a>.</p>
</div>
<div class="paragraph">
<p>Default value: <code>60</code></p>
</div>
<details>
<summary class="title">Variants of this configuration property (click to open)</summary>
<div class="content">
<div class="ulist">
<ul>
<li>
<p><code>hibernate.search.backends.&lt;backend-name&gt;.scroll_timeout</code></p>
</li>
</ul>
</div>
</div>
</details>
</dd>
<dt class="hdlist1"><a id="configuration-properties-aggregated-hibernate-search-backend-elasticsearchhibernate.search.backend.thread_pool.size"></a> <code>hibernate.search.backend.thread_pool.size</code></dt>
<dd>
<p>The size of the thread pool assigned to the backend.</p>
<div class="paragraph">
<p>Expects a strictly positive integer value, or a string that can be parsed into an integer value.</p>
</div>
<div class="paragraph">
<p>See the reference documentation, section "Elasticsearch backend - Threads", for more information about this setting and its implications.</p>
</div>
<div class="paragraph">
<p>Defaults to the number of processor cores available to the JVM on startup.</p>
</div>
<details>
<summary class="title">Variants of this configuration property (click to open)</summary>
<div class="content">
<div class="ulist">
<ul>
<li>
<p><code>hibernate.search.backends.&lt;backend-name&gt;.thread_pool.size</code></p>
</li>
</ul>
</div>
</div>
</details>
</dd>
<dt class="hdlist1"><a id="configuration-properties-aggregated-hibernate-search-backend-elasticsearchhibernate.search.backend.uris"></a> <code>hibernate.search.backend.uris</code></dt>
<dd>
<p>The protocol, hostname and ports of the Elasticsearch servers to connect to.</p>
<div class="paragraph">
<p>Expects either a String representing an URI such as <code><a href="http://localhost" class="bare">http://localhost</a></code> or <code><a href="https://es.mycompany.com:4400" class="bare">https://es.mycompany.com:4400</a></code>, or a String containing multiple such URIs separated by commas, or a <code>Collection&lt;String&gt;</code> containing such URIs.</p>
</div>
<div class="paragraph">
<p>All the URIs must specify the same protocol.</p>
</div>
<div class="paragraph">
<p>Setting this property at the same time as <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/backend/elasticsearch/cfg/ElasticsearchBackendSettings.html#HOSTS"><code>HOSTS</code></a> or <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/backend/elasticsearch/cfg/ElasticsearchBackendSettings.html#PROTOCOL"><code>PROTOCOL</code></a> will lead to an exception being thrown on startup.</p>
</div>
<div class="paragraph">
<p>Defaults to <code><a href="http://localhost:9200" class="bare">http://localhost:9200</a></code>, unless <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/backend/elasticsearch/cfg/ElasticsearchBackendSettings.html#HOSTS"><code>HOSTS</code></a> or <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/backend/elasticsearch/cfg/ElasticsearchBackendSettings.html#PROTOCOL"><code>PROTOCOL</code></a> are set, in which case they take precedence.</p>
</div>
<details>
<summary class="title">Variants of this configuration property (click to open)</summary>
<div class="content">
<div class="ulist">
<ul>
<li>
<p><code>hibernate.search.backends.&lt;backend-name&gt;.uris</code></p>
</li>
</ul>
</div>
</div>
</details>
</dd>
<dt class="hdlist1"><a id="configuration-properties-aggregated-hibernate-search-backend-elasticsearchhibernate.search.backend.username"></a> <code>hibernate.search.backend.username</code></dt>
<dd>
<p>The username to send when connecting to the Elasticsearch servers (HTTP authentication).</p>
<div class="paragraph">
<p>Expects a String.</p>
</div>
<div class="paragraph">
<p>Defaults to no username (anonymous access).</p>
</div>
<details>
<summary class="title">Variants of this configuration property (click to open)</summary>
<div class="content">
<div class="ulist">
<ul>
<li>
<p><code>hibernate.search.backends.&lt;backend-name&gt;.username</code></p>
</li>
</ul>
</div>
</div>
</details>
</dd>
<dt class="hdlist1"><a id="configuration-properties-aggregated-hibernate-search-backend-elasticsearchhibernate.search.backend.version"></a> <code>hibernate.search.backend.version</code></dt>
<dd>
<p>The version of Elasticsearch running on the Elasticsearch cluster.</p>
<div class="paragraph">
<p>Expects either an <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/backend/elasticsearch/cfg/../ElasticsearchVersion.html"><code>ElasticsearchVersion</code></a> object, or a String that can be <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/backend/elasticsearch/cfg/../ElasticsearchVersion.html#of(java.lang.String)"><code>parsed</code></a> in such an object.</p>
</div>
<div class="paragraph">
<p>No default: if not provided, the version will be resolved automatically by sending a request to the Elasticsearch cluster on startup.</p>
</div>
<details>
<summary class="title">Variants of this configuration property (click to open)</summary>
<div class="content">
<div class="ulist">
<ul>
<li>
<p><code>hibernate.search.backends.&lt;backend-name&gt;.version</code></p>
</li>
</ul>
</div>
</div>
</details>
</dd>
<dt class="hdlist1"><a id="configuration-properties-aggregated-hibernate-search-backend-elasticsearchhibernate.search.backend.version_check.enabled"></a> <code>hibernate.search.backend.version_check.enabled</code></dt>
<dd>
<p>Whether check version of the Elasticsearch cluster is enabled.</p>
<div class="paragraph">
<p>Expects a Boolean value such as <code>true</code> or <code>false</code>, or a string that can be parsed into a Boolean value.</p>
</div>
<div class="paragraph">
<p>Defaults to <code>true</code> when the <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/backend/elasticsearch/cfg/ElasticsearchBackendSettings.html#VERSION"><code>VERSION</code></a> is unconfigured or set to a distribution that supports version checking, and to <code>false</code> when the <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/backend/elasticsearch/cfg/ElasticsearchBackendSettings.html#VERSION"><code>VERSION</code></a> is set to a distribution that does not support version checking (like Amazon OpenSearch Serverless).</p>
</div>
<div class="paragraph">
<p>Default value: <code>true</code></p>
</div>
<details>
<summary class="title">Variants of this configuration property (click to open)</summary>
<div class="content">
<div class="ulist">
<ul>
<li>
<p><code>hibernate.search.backends.&lt;backend-name&gt;.version_check.enabled</code></p>
</li>
</ul>
</div>
</div>
</details>
</dd>
</dl>
</div>
</div>
<div class="sect2">
<h3 id="configuration-properties-aggregated-hibernate-search-backend-elasticsearch-aws"><a class="anchor" href="#configuration-properties-aggregated-hibernate-search-backend-elasticsearch-aws"></a>A.4. Hibernate Search Backend - Elasticsearch - AWS integration</h3>
<div class="dlist">
<dl>
<dt class="hdlist1"><a id="configuration-properties-aggregated-hibernate-search-backend-elasticsearch-awshibernate.search.backend.aws.credentials.access_key_id"></a> <code>hibernate.search.backend.aws.credentials.access_key_id</code></dt>
<dd>
<p>The AWS access key ID when using <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/backend/elasticsearch/aws/cfg/ElasticsearchAwsCredentialsTypeNames.html#STATIC"><code>static credentials</code></a>.</p>
<div class="paragraph">
<p>Expects a String value such as <code>AKIDEXAMPLE</code>.</p>
</div>
<div class="paragraph">
<p>No default: must be provided when signing is enabled and the credentials type is set to <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/backend/elasticsearch/aws/cfg/ElasticsearchAwsCredentialsTypeNames.html#STATIC"><code>ElasticsearchAwsCredentialsTypeNames.STATIC</code></a>.</p>
</div>
<details>
<summary class="title">Variants of this configuration property (click to open)</summary>
<div class="content">
<div class="ulist">
<ul>
<li>
<p><code>hibernate.search.backends.&lt;backend-name&gt;.aws.credentials.access_key_id</code></p>
</li>
</ul>
</div>
</div>
</details>
</dd>
<dt class="hdlist1"><a id="configuration-properties-aggregated-hibernate-search-backend-elasticsearch-awshibernate.search.backend.aws.credentials.secret_access_key"></a> <code>hibernate.search.backend.aws.credentials.secret_access_key</code></dt>
<dd>
<p>The AWS secret access key when using <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/backend/elasticsearch/aws/cfg/ElasticsearchAwsCredentialsTypeNames.html#STATIC"><code>static credentials</code></a>.</p>
<div class="paragraph">
<p>Expects a String value such as <code>wJalrXUtnFEMI/K7MDENG+bPxRfiCYEXAMPLEKEY</code></p>
</div>
<div class="paragraph">
<p>No default: must be provided when signing is enabled and the credentials type is set to <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/backend/elasticsearch/aws/cfg/ElasticsearchAwsCredentialsTypeNames.html#STATIC"><code>ElasticsearchAwsCredentialsTypeNames.STATIC</code></a>.</p>
</div>
<details>
<summary class="title">Variants of this configuration property (click to open)</summary>
<div class="content">
<div class="ulist">
<ul>
<li>
<p><code>hibernate.search.backends.&lt;backend-name&gt;.aws.credentials.secret_access_key</code></p>
</li>
</ul>
</div>
</div>
</details>
</dd>
<dt class="hdlist1"><a id="configuration-properties-aggregated-hibernate-search-backend-elasticsearch-awshibernate.search.backend.aws.credentials.type"></a> <code>hibernate.search.backend.aws.credentials.type</code></dt>
<dd>
<p>The type of credentials to use when signing is <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/backend/elasticsearch/aws/cfg/ElasticsearchAwsBackendSettings.html#SIGNING_ENABLED"><code>enabled</code></a>.</p>
<div class="paragraph">
<p>Expects one of the names listed as constants in <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/backend/elasticsearch/aws/cfg/ElasticsearchAwsCredentialsTypeNames.html"><code>ElasticsearchAwsCredentialsTypeNames</code></a>.</p>
</div>
<div class="paragraph">
<p>Defaults to <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/backend/elasticsearch/aws/cfg/ElasticsearchAwsBackendSettings.Defaults.html#CREDENTIALS_TYPE"><code>ElasticsearchAwsBackendSettings.Defaults.CREDENTIALS_TYPE</code></a>.</p>
</div>
<div class="paragraph">
<p>Default value: <code>"default"</code></p>
</div>
<details>
<summary class="title">Variants of this configuration property (click to open)</summary>
<div class="content">
<div class="ulist">
<ul>
<li>
<p><code>hibernate.search.backends.&lt;backend-name&gt;.aws.credentials.type</code></p>
</li>
</ul>
</div>
</div>
</details>
</dd>
<dt class="hdlist1"><a id="configuration-properties-aggregated-hibernate-search-backend-elasticsearch-awshibernate.search.backend.aws.region"></a> <code>hibernate.search.backend.aws.region</code></dt>
<dd>
<p>The AWS region.</p>
<div class="paragraph">
<p>Expects a String value such as <code>us-east-1</code>.</p>
</div>
<div class="paragraph">
<p>No default: must be provided when signing is enabled.</p>
</div>
<details>
<summary class="title">Variants of this configuration property (click to open)</summary>
<div class="content">
<div class="ulist">
<ul>
<li>
<p><code>hibernate.search.backends.&lt;backend-name&gt;.aws.region</code></p>
</li>
</ul>
</div>
</div>
</details>
</dd>
<dt class="hdlist1"><a id="configuration-properties-aggregated-hibernate-search-backend-elasticsearch-awshibernate.search.backend.aws.signing.enabled"></a> <code>hibernate.search.backend.aws.signing.enabled</code></dt>
<dd>
<p>Whether requests should be signed using the AWS credentials.</p>
<div class="paragraph">
<p>Expects a Boolean value such as <code>true</code> or <code>false</code>, or a string that can be parsed into a Boolean value.</p>
</div>
<div class="paragraph">
<p>Defaults to <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/backend/elasticsearch/aws/cfg/ElasticsearchAwsBackendSettings.Defaults.html#SIGNING_ENABLED"><code>ElasticsearchAwsBackendSettings.Defaults.SIGNING_ENABLED</code></a>.</p>
</div>
<div class="paragraph">
<p>Default value: <code>false</code></p>
</div>
<details>
<summary class="title">Variants of this configuration property (click to open)</summary>
<div class="content">
<div class="ulist">
<ul>
<li>
<p><code>hibernate.search.backends.&lt;backend-name&gt;.aws.signing.enabled</code></p>
</li>
</ul>
</div>
</div>
</details>
</dd>
</dl>
</div>
</div>
<div class="sect2">
<h3 id="configuration-properties-aggregated-hibernate-search-mapper-orm"><a class="anchor" href="#configuration-properties-aggregated-hibernate-search-mapper-orm"></a>A.5. Hibernate Search ORM Integration</h3>
<div class="dlist">
<dl>
<dt class="hdlist1"><a id="configuration-properties-aggregated-hibernate-search-mapper-ormhibernate.search.automatic_indexing.enable_dirty_check"></a> <code>hibernate.search.automatic_indexing.enable_dirty_check</code></dt>
<dd>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Deprecated.</p>
</div>
<div class="paragraph">
<p>This setting will be removed in a future version. There will be no alternative provided to replace it. After the removal of this property in a future version, a dirty check will always be performed when considering whether to trigger reindexing.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Whether to check if dirty properties are relevant to indexing before actually reindexing an entity.</p>
</div>
<div class="paragraph">
<p>When enabled, re-indexing of an entity is skipped if the only changes are on properties that are not used when indexing. This feature is considered safe and thus enabled by default.</p>
</div>
<div class="paragraph">
<p>Expects a Boolean value such as <code>true</code> or <code>false</code>, or a string that can be parsed into a Boolean value.</p>
</div>
<div class="paragraph">
<p>Defaults to <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/mapper/orm/cfg/HibernateOrmMapperSettings.Defaults.html#AUTOMATIC_INDEXING_ENABLE_DIRTY_CHECK"><code>HibernateOrmMapperSettings.Defaults.AUTOMATIC_INDEXING_ENABLE_DIRTY_CHECK</code></a>.</p>
</div>
<div class="paragraph">
<p>Default value: <code>true</code></p>
</div>
</dd>
<dt class="hdlist1"><a id="configuration-properties-aggregated-hibernate-search-mapper-ormhibernate.search.automatic_indexing.enabled"></a> <code>hibernate.search.automatic_indexing.enabled</code></dt>
<dd>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Deprecated.</p>
</div>
<div class="paragraph">
<p>Use <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/mapper/orm/cfg/HibernateOrmMapperSettings.html#INDEXING_LISTENERS_ENABLED"><code>INDEXING_LISTENERS_ENABLED</code></a> instead.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Whether listener-triggered indexing is enabled, i.e. whether changes to entities in a Hibernate ORM session are detected automatically and lead to reindexing.</p>
</div>
<div class="paragraph">
<p>Expects a Boolean value such as <code>true</code> or <code>false</code>, or a string that can be parsed into a Boolean value.</p>
</div>
<div class="paragraph">
<p>Defaults to <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/mapper/orm/cfg/HibernateOrmMapperSettings.Defaults.html#AUTOMATIC_INDEXING_ENABLED"><code>HibernateOrmMapperSettings.Defaults.AUTOMATIC_INDEXING_ENABLED</code></a>.</p>
</div>
<div class="paragraph">
<p>Default value: <code>true</code></p>
</div>
</dd>
<dt class="hdlist1"><a id="configuration-properties-aggregated-hibernate-search-mapper-ormhibernate.search.automatic_indexing.strategy"></a> <code>hibernate.search.automatic_indexing.strategy</code></dt>
<dd>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Deprecated.</p>
</div>
<div class="paragraph">
<p>Use <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/mapper/orm/cfg/HibernateOrmMapperSettings.html#INDEXING_LISTENERS_ENABLED"><code>INDEXING_LISTENERS_ENABLED</code></a> instead (caution: it expects a boolean value).</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>How to enable or disable listener-triggered indexing.</p>
</div>
<div class="paragraph">
<p>Expects a <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/mapper/orm/cfg/../automaticindexing/AutomaticIndexingStrategyName.html"><code>AutomaticIndexingStrategyName</code></a> value, or a String representation of such value.</p>
</div>
<div class="paragraph">
<p>Defaults to <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/mapper/orm/cfg/HibernateOrmMapperSettings.Defaults.html#AUTOMATIC_INDEXING_STRATEGY"><code>HibernateOrmMapperSettings.Defaults.AUTOMATIC_INDEXING_STRATEGY</code></a>.</p>
</div>
</dd>
<dt class="hdlist1"><a id="configuration-properties-aggregated-hibernate-search-mapper-ormhibernate.search.automatic_indexing.synchronization.strategy"></a> <code>hibernate.search.automatic_indexing.synchronization.strategy</code></dt>
<dd>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Deprecated.</p>
</div>
<div class="paragraph">
<p>Use <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/mapper/orm/cfg/HibernateOrmMapperSettings.html#INDEXING_PLAN_SYNCHRONIZATION_STRATEGY"><code>INDEXING_PLAN_SYNCHRONIZATION_STRATEGY</code></a> instead.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>How to synchronize between application threads and indexing triggered by the <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/mapper/orm/cfg/../work/SearchIndexingPlan.html"><code>SearchIndexingPlan</code></a>.</p>
</div>
<div class="paragraph">
<p>Expects one of the strings defined in <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/mapper/orm/cfg/../automaticindexing/session/AutomaticIndexingSynchronizationStrategyNames.html"><code>AutomaticIndexingSynchronizationStrategyNames</code></a>, or a reference to a bean of type <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/mapper/orm/cfg/../automaticindexing/session/AutomaticIndexingSynchronizationStrategy.html"><code>AutomaticIndexingSynchronizationStrategy</code></a>.</p>
</div>
<div class="paragraph">
<p>Defaults to <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/mapper/orm/cfg/HibernateOrmMapperSettings.Defaults.html#AUTOMATIC_INDEXING_SYNCHRONIZATION_STRATEGY"><code>HibernateOrmMapperSettings.Defaults.AUTOMATIC_INDEXING_SYNCHRONIZATION_STRATEGY</code></a>.</p>
</div>
</dd>
<dt class="hdlist1"><a id="configuration-properties-aggregated-hibernate-search-mapper-ormhibernate.search.coordination.strategy"></a> <code>hibernate.search.coordination.strategy</code></dt>
<dd>
<p>How to coordinate between nodes of a distributed application.</p>
<div class="paragraph">
<p>Expects a reference to a coordination strategy; see the reference documentation for available strategies and the relevant Maven dependencies.</p>
</div>
<div class="paragraph">
<p>Defaults to <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/mapper/orm/cfg/HibernateOrmMapperSettings.Defaults.html#COORDINATION_STRATEGY"><code>HibernateOrmMapperSettings.Defaults.COORDINATION_STRATEGY</code></a>.</p>
</div>
</dd>
<dt class="hdlist1"><a id="configuration-properties-aggregated-hibernate-search-mapper-ormhibernate.search.enabled"></a> <code>hibernate.search.enabled</code></dt>
<dd>
<p>Whether Hibernate Search is enabled or disabled.</p>
<div class="paragraph">
<p>Expects a Boolean value such as <code>true</code> or <code>false</code>, or a string that can be parsed into a Boolean value.</p>
</div>
<div class="paragraph">
<p>Defaults to <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/mapper/orm/cfg/HibernateOrmMapperSettings.Defaults.html#ENABLED"><code>HibernateOrmMapperSettings.Defaults.ENABLED</code></a>.</p>
</div>
<div class="paragraph">
<p>Default value: <code>true</code></p>
</div>
</dd>
<dt class="hdlist1"><a id="configuration-properties-aggregated-hibernate-search-mapper-ormhibernate.search.indexing.listeners.enabled"></a> <code>hibernate.search.indexing.listeners.enabled</code></dt>
<dd>
<p>Whether Hibernate ORM listeners that detect entity changes and automatically trigger indexing operations are enabled.</p>
<div class="paragraph">
<p>Expects a Boolean value such as <code>true</code> or <code>false</code>, or a string that can be parsed into a Boolean value.</p>
</div>
<div class="paragraph">
<p>Defaults to <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/mapper/orm/cfg/HibernateOrmMapperSettings.Defaults.html#INDEXING_LISTENERS_ENABLED"><code>HibernateOrmMapperSettings.Defaults.INDEXING_LISTENERS_ENABLED</code></a>.</p>
</div>
<div class="paragraph">
<p>Default value: <code>true</code></p>
</div>
</dd>
<dt class="hdlist1"><a id="configuration-properties-aggregated-hibernate-search-mapper-ormhibernate.search.indexing.plan.synchronization.strategy"></a> <code>hibernate.search.indexing.plan.synchronization.strategy</code></dt>
<dd>
<p>How to synchronize between application threads and indexing triggered by the <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/mapper/orm/cfg/../work/SearchIndexingPlan.html"><code>SearchIndexingPlan</code></a>.</p>
<div class="paragraph">
<p>Expects one of the strings defined in <a href="http://hibernate.org/search/apidocs/org/hibernate/search/mapper/pojo/work/IndexingPlanSynchronizationStrategyNames.html"><code>IndexingPlanSynchronizationStrategyNames</code></a>, or a reference to a bean of type <a href="http://hibernate.org/search/apidocs/org/hibernate/search/mapper/pojo/work/IndexingPlanSynchronizationStrategy.html"><code>IndexingPlanSynchronizationStrategy</code></a>.</p>
</div>
<div class="paragraph">
<p>Defaults to <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/mapper/orm/cfg/HibernateOrmMapperSettings.Defaults.html#INDEXING_PLAN_SYNCHRONIZATION_STRATEGY"><code>HibernateOrmMapperSettings.Defaults.INDEXING_PLAN_SYNCHRONIZATION_STRATEGY</code></a>.</p>
</div>
</dd>
<dt class="hdlist1"><a id="configuration-properties-aggregated-hibernate-search-mapper-ormhibernate.search.mapping.build_missing_discovered_jandex_indexes"></a> <code>hibernate.search.mapping.build_missing_discovered_jandex_indexes</code></dt>
<dd>
<p>When <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/mapper/orm/cfg/HibernateOrmMapperSettings.html#MAPPING_PROCESS_ANNOTATIONS"><code>annotation processing is enabled</code></a> (the default), whether Hibernate Search should automatically build Jandex indexes for types registered for annotation processing (entities in particular), to ensure that all "root mapping" annotations in those JARs (e.g. <a href="http://hibernate.org/search/apidocs/org/hibernate/search/mapper/pojo/mapping/definition/annotation/ProjectionConstructor.html"><code>ProjectionConstructor</code></a>) are taken into account.</p>
<div class="paragraph">
<p>Expects a Boolean value such as <code>true</code> or <code>false</code>, or a string that can be parsed into a Boolean value.</p>
</div>
<div class="paragraph">
<p>Defaults to <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/mapper/orm/cfg/HibernateOrmMapperSettings.Defaults.html#MAPPING_BUILD_MISSING_DISCOVERED_JANDEX_INDEXES"><code>HibernateOrmMapperSettings.Defaults.MAPPING_BUILD_MISSING_DISCOVERED_JANDEX_INDEXES</code></a>.</p>
</div>
<div class="paragraph">
<p>Default value: <code>true</code></p>
</div>
</dd>
<dt class="hdlist1"><a id="configuration-properties-aggregated-hibernate-search-mapper-ormhibernate.search.mapping.configurer"></a> <code>hibernate.search.mapping.configurer</code></dt>
<dd>
<p>A configurer for the Hibernate Search mapping.</p>
<div class="paragraph">
<p>Expects a single-valued or multi-valued reference to beans of type <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/mapper/orm/cfg/../mapping/HibernateOrmSearchMappingConfigurer.html"><code>HibernateOrmSearchMappingConfigurer</code></a>.</p>
</div>
<div class="paragraph">
<p>Defaults to no value.</p>
</div>
</dd>
<dt class="hdlist1"><a id="configuration-properties-aggregated-hibernate-search-mapper-ormhibernate.search.mapping.process_annotations"></a> <code>hibernate.search.mapping.process_annotations</code></dt>
<dd>
<p>Whether annotations should be automatically processed for entity types, as well as nested types in those entity types, for instance <a href="http://hibernate.org/search/apidocs/org/hibernate/search/mapper/pojo/mapping/definition/annotation/IndexedEmbedded.html"><code>index-embedded</code></a> types.</p>
<div class="paragraph">
<p>Expects a Boolean value such as <code>true</code> or <code>false</code>, or a string that can be parsed into a Boolean value.</p>
</div>
<div class="paragraph">
<p>Defaults to <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/mapper/orm/cfg/HibernateOrmMapperSettings.Defaults.html#MAPPING_PROCESS_ANNOTATIONS"><code>HibernateOrmMapperSettings.Defaults.MAPPING_PROCESS_ANNOTATIONS</code></a>.</p>
</div>
<div class="paragraph">
<p>Default value: <code>true</code></p>
</div>
</dd>
<dt class="hdlist1"><a id="configuration-properties-aggregated-hibernate-search-mapper-ormhibernate.search.multi_tenancy.tenant_ids"></a> <code>hibernate.search.multi_tenancy.tenant_ids</code></dt>
<dd>
<p>An exhaustive list of all tenant identifiers that can be used by the application when multi-tenancy is enabled.</p>
<div class="paragraph">
<p>Expects either a String representing multiple tenant IDs separated by commas, or a <code>Collection&lt;String&gt;</code> containing tenant IDs.</p>
</div>
<div class="paragraph">
<p>No default; this property may have to be set explicitly depending on the <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/mapper/orm/cfg/HibernateOrmMapperSettings.html#COORDINATION_STRATEGY"><code>coordination strategy</code></a>.</p>
</div>
</dd>
<dt class="hdlist1"><a id="configuration-properties-aggregated-hibernate-search-mapper-ormhibernate.search.query.loading.cache_lookup.strategy"></a> <code>hibernate.search.query.loading.cache_lookup.strategy</code></dt>
<dd>
<p>How to look up entities in the second-level cache when loading entities for a search query.</p>
<div class="paragraph">
<p>Expects a <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/mapper/orm/cfg/../search/loading/EntityLoadingCacheLookupStrategy.html"><code>EntityLoadingCacheLookupStrategy</code></a> value, or a String representation of such value.</p>
</div>
<div class="paragraph">
<p>Defaults to <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/mapper/orm/cfg/HibernateOrmMapperSettings.Defaults.html#QUERY_LOADING_CACHE_LOOKUP_STRATEGY"><code>HibernateOrmMapperSettings.Defaults.QUERY_LOADING_CACHE_LOOKUP_STRATEGY</code></a>.</p>
</div>
</dd>
<dt class="hdlist1"><a id="configuration-properties-aggregated-hibernate-search-mapper-ormhibernate.search.query.loading.fetch_size"></a> <code>hibernate.search.query.loading.fetch_size</code></dt>
<dd>
<p>How many entities to load per database query when loading entities for a search query.</p>
<div class="paragraph">
<p>Expects a strictly positive Integer value, such as <code>100</code>, or a String that can be parsed into such Integer value.</p>
</div>
<div class="paragraph">
<p>Defaults to <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/mapper/orm/cfg/HibernateOrmMapperSettings.Defaults.html#QUERY_LOADING_FETCH_SIZE"><code>HibernateOrmMapperSettings.Defaults.QUERY_LOADING_FETCH_SIZE</code></a>.</p>
</div>
<div class="paragraph">
<p>Default value: <code>100</code></p>
</div>
</dd>
<dt class="hdlist1"><a id="configuration-properties-aggregated-hibernate-search-mapper-ormhibernate.search.schema_management.strategy"></a> <code>hibernate.search.schema_management.strategy</code></dt>
<dd>
<p>How indexes and their schema are created, updated, validated or dropped on startup and shutdown.</p>
<div class="paragraph">
<p>Expects a <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/mapper/orm/cfg/../schema/management/SchemaManagementStrategyName.html"><code>SchemaManagementStrategyName</code></a> value, or a String representation of such value.</p>
</div>
<div class="paragraph">
<p>Defaults to <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/mapper/orm/cfg/HibernateOrmMapperSettings.Defaults.html#SCHEMA_MANAGEMENT_STRATEGY"><code>HibernateOrmMapperSettings.Defaults.SCHEMA_MANAGEMENT_STRATEGY</code></a>.</p>
</div>
</dd>
</dl>
</div>
</div>
<div class="sect2">
<h3 id="configuration-properties-aggregated-hibernate-search-mapper-orm-outbox-polling"><a class="anchor" href="#configuration-properties-aggregated-hibernate-search-mapper-orm-outbox-polling"></a>A.6. Hibernate Search ORM Integration - Coordination - Outbox Polling</h3>
<div class="dlist">
<dl>
<dt class="hdlist1"><a id="configuration-properties-aggregated-hibernate-search-mapper-orm-outbox-pollinghibernate.search.coordination.entity.mapping.agent.catalog"></a> <code>hibernate.search.coordination.entity.mapping.agent.catalog</code></dt>
<dd>
<p>The database catalog to use for the agent table.</p>
<div class="paragraph">
<p>Only available when <a href="http://hibernate.org/search/apidocs/org/hibernate/search/mapper/orm/cfg/HibernateOrmMapperSettings.html#COORDINATION_STRATEGY">"hibernate.search.coordination.strategy"</a> is <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/mapper/orm/outboxpolling/cfg/HibernateOrmMapperOutboxPollingSettings.html#COORDINATION_STRATEGY_NAME">"outbox-polling"</a>.</p>
</div>
<div class="paragraph">
<p>Defaults to the default catalog configured in Hibernate ORM. See <a href="https://docs.jboss.org/hibernate/orm/6.4/javadocs/org/hibernate/cfg/MappingSettings.html#DEFAULT_CATALOG"><code>MappingSettings.DEFAULT_CATALOG</code></a>.</p>
</div>
</dd>
<dt class="hdlist1"><a id="configuration-properties-aggregated-hibernate-search-mapper-orm-outbox-pollinghibernate.search.coordination.entity.mapping.agent.schema"></a> <code>hibernate.search.coordination.entity.mapping.agent.schema</code></dt>
<dd>
<p>The database schema to use for the agent table.</p>
<div class="paragraph">
<p>Only available when <a href="http://hibernate.org/search/apidocs/org/hibernate/search/mapper/orm/cfg/HibernateOrmMapperSettings.html#COORDINATION_STRATEGY">"hibernate.search.coordination.strategy"</a> is <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/mapper/orm/outboxpolling/cfg/HibernateOrmMapperOutboxPollingSettings.html#COORDINATION_STRATEGY_NAME">"outbox-polling"</a>.</p>
</div>
<div class="paragraph">
<p>Defaults to the default schema configured in Hibernate ORM. See <a href="https://docs.jboss.org/hibernate/orm/6.4/javadocs/org/hibernate/cfg/MappingSettings.html#DEFAULT_SCHEMA"><code>MappingSettings.DEFAULT_SCHEMA</code></a>.</p>
</div>
</dd>
<dt class="hdlist1"><a id="configuration-properties-aggregated-hibernate-search-mapper-orm-outbox-pollinghibernate.search.coordination.entity.mapping.agent.table"></a> <code>hibernate.search.coordination.entity.mapping.agent.table</code></dt>
<dd>
<p>The name of the agent table.</p>
<div class="paragraph">
<p>Only available when <a href="http://hibernate.org/search/apidocs/org/hibernate/search/mapper/orm/cfg/HibernateOrmMapperSettings.html#COORDINATION_STRATEGY">"hibernate.search.coordination.strategy"</a> is <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/mapper/orm/outboxpolling/cfg/HibernateOrmMapperOutboxPollingSettings.html#COORDINATION_STRATEGY_NAME">"outbox-polling"</a>.</p>
</div>
<div class="paragraph">
<p>The default for this value is <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/mapper/orm/outboxpolling/cfg/HibernateOrmMapperOutboxPollingSettings.Defaults.html#COORDINATION_ENTITY_MAPPING_AGENT_TABLE">"HSEARCH_AGENT"</a>.</p>
</div>
<div class="paragraph">
<p>Default value: <code>"HSEARCH_AGENT"</code></p>
</div>
</dd>
<dt class="hdlist1"><a id="configuration-properties-aggregated-hibernate-search-mapper-orm-outbox-pollinghibernate.search.coordination.entity.mapping.agent.uuid_gen_strategy"></a> <code>hibernate.search.coordination.entity.mapping.agent.uuid_gen_strategy</code></dt>
<dd>
<p>The name of UUID generator strategy to be used by <a href="https://docs.jboss.org/hibernate/orm/6.4/javadocs/org/hibernate/id/uuid/UuidGenerator.html"><code>UuidGenerator</code></a> for the agent table.</p>
<div class="paragraph">
<p>Only available when <a href="http://hibernate.org/search/apidocs/org/hibernate/search/mapper/orm/cfg/HibernateOrmMapperSettings.html#COORDINATION_STRATEGY">"hibernate.search.coordination.strategy"</a> is <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/mapper/orm/outboxpolling/cfg/HibernateOrmMapperOutboxPollingSettings.html#COORDINATION_STRATEGY_NAME">"outbox-polling"</a>.</p>
</div>
<div class="paragraph">
<p>The default for this value is <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/mapper/orm/outboxpolling/cfg/HibernateOrmMapperOutboxPollingSettings.Defaults.html#COORDINATION_ENTITY_MAPPING_AGENT_UUID_GEN_STRATEGY"><code>HibernateOrmMapperOutboxPollingSettings.Defaults.COORDINATION_ENTITY_MAPPING_AGENT_UUID_GEN_STRATEGY</code></a>.</p>
</div>
</dd>
<dt class="hdlist1"><a id="configuration-properties-aggregated-hibernate-search-mapper-orm-outbox-pollinghibernate.search.coordination.entity.mapping.agent.uuid_type"></a> <code>hibernate.search.coordination.entity.mapping.agent.uuid_type</code></dt>
<dd>
<p>The name of the <a href="https://docs.jboss.org/hibernate/orm/6.4/javadocs/org/hibernate/type/SqlTypes.html"><code>Hibernate ORM constant type code used to identify a generic SQL type</code></a> used for representing an UUID in the agent table.</p>
<div class="paragraph">
<p>Only available when <a href="http://hibernate.org/search/apidocs/org/hibernate/search/mapper/orm/cfg/HibernateOrmMapperSettings.html#COORDINATION_STRATEGY">"hibernate.search.coordination.strategy"</a> is <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/mapper/orm/outboxpolling/cfg/HibernateOrmMapperOutboxPollingSettings.html#COORDINATION_STRATEGY_NAME">"outbox-polling"</a>.</p>
</div>
<div class="paragraph">
<p>The default for this value is <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/mapper/orm/outboxpolling/cfg/HibernateOrmMapperOutboxPollingSettings.Defaults.html#COORDINATION_ENTITY_MAPPING_AGENT_UUID_TYPE"><code>HibernateOrmMapperOutboxPollingSettings.Defaults.COORDINATION_ENTITY_MAPPING_AGENT_UUID_TYPE</code></a>.</p>
</div>
<div class="paragraph">
<p>Default value: <code>"default"</code></p>
</div>
</dd>
<dt class="hdlist1"><a id="configuration-properties-aggregated-hibernate-search-mapper-orm-outbox-pollinghibernate.search.coordination.entity.mapping.outboxevent.catalog"></a> <code>hibernate.search.coordination.entity.mapping.outboxevent.catalog</code></dt>
<dd>
<p>The database catalog to use for the outbox event table.</p>
<div class="paragraph">
<p>Only available when <a href="http://hibernate.org/search/apidocs/org/hibernate/search/mapper/orm/cfg/HibernateOrmMapperSettings.html#COORDINATION_STRATEGY">"hibernate.search.coordination.strategy"</a> is <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/mapper/orm/outboxpolling/cfg/HibernateOrmMapperOutboxPollingSettings.html#COORDINATION_STRATEGY_NAME">"outbox-polling"</a>.</p>
</div>
<div class="paragraph">
<p>Defaults to the default catalog configured in Hibernate ORM. See <a href="https://docs.jboss.org/hibernate/orm/6.4/javadocs/org/hibernate/cfg/MappingSettings.html#DEFAULT_CATALOG"><code>MappingSettings.DEFAULT_CATALOG</code></a>.</p>
</div>
</dd>
<dt class="hdlist1"><a id="configuration-properties-aggregated-hibernate-search-mapper-orm-outbox-pollinghibernate.search.coordination.entity.mapping.outboxevent.schema"></a> <code>hibernate.search.coordination.entity.mapping.outboxevent.schema</code></dt>
<dd>
<p>The database schema to use for the outbox event table.</p>
<div class="paragraph">
<p>Only available when <a href="http://hibernate.org/search/apidocs/org/hibernate/search/mapper/orm/cfg/HibernateOrmMapperSettings.html#COORDINATION_STRATEGY">"hibernate.search.coordination.strategy"</a> is <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/mapper/orm/outboxpolling/cfg/HibernateOrmMapperOutboxPollingSettings.html#COORDINATION_STRATEGY_NAME">"outbox-polling"</a>.</p>
</div>
<div class="paragraph">
<p>Defaults to the default schema configured in Hibernate ORM. See <a href="https://docs.jboss.org/hibernate/orm/6.4/javadocs/org/hibernate/cfg/MappingSettings.html#DEFAULT_SCHEMA"><code>MappingSettings.DEFAULT_SCHEMA</code></a>.</p>
</div>
</dd>
<dt class="hdlist1"><a id="configuration-properties-aggregated-hibernate-search-mapper-orm-outbox-pollinghibernate.search.coordination.entity.mapping.outboxevent.table"></a> <code>hibernate.search.coordination.entity.mapping.outboxevent.table</code></dt>
<dd>
<p>The name of the outbox event table.</p>
<div class="paragraph">
<p>Only available when <a href="http://hibernate.org/search/apidocs/org/hibernate/search/mapper/orm/cfg/HibernateOrmMapperSettings.html#COORDINATION_STRATEGY">"hibernate.search.coordination.strategy"</a> is <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/mapper/orm/outboxpolling/cfg/HibernateOrmMapperOutboxPollingSettings.html#COORDINATION_STRATEGY_NAME">"outbox-polling"</a>.</p>
</div>
<div class="paragraph">
<p>The default for this value is <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/mapper/orm/outboxpolling/cfg/HibernateOrmMapperOutboxPollingSettings.Defaults.html#COORDINATION_ENTITY_MAPPING_OUTBOX_EVENT_TABLE">"HSEARCH_OUTBOX_EVENT"</a>.</p>
</div>
</dd>
<dt class="hdlist1"><a id="configuration-properties-aggregated-hibernate-search-mapper-orm-outbox-pollinghibernate.search.coordination.entity.mapping.outboxevent.uuid_gen_strategy"></a> <code>hibernate.search.coordination.entity.mapping.outboxevent.uuid_gen_strategy</code></dt>
<dd>
<p>The name of UUID generator strategy to be used by <a href="https://docs.jboss.org/hibernate/orm/6.4/javadocs/org/hibernate/id/uuid/UuidGenerator.html"><code>UuidGenerator</code></a> for the outbox event table.</p>
<div class="paragraph">
<p>Only available when <a href="http://hibernate.org/search/apidocs/org/hibernate/search/mapper/orm/cfg/HibernateOrmMapperSettings.html#COORDINATION_STRATEGY">"hibernate.search.coordination.strategy"</a> is <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/mapper/orm/outboxpolling/cfg/HibernateOrmMapperOutboxPollingSettings.html#COORDINATION_STRATEGY_NAME">"outbox-polling"</a>.</p>
</div>
<div class="paragraph">
<p>The default for this value is <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/mapper/orm/outboxpolling/cfg/HibernateOrmMapperOutboxPollingSettings.Defaults.html#COORDINATION_ENTITY_MAPPING_OUTBOX_EVENT_UUID_GEN_STRATEGY"><code>HibernateOrmMapperOutboxPollingSettings.Defaults.COORDINATION_ENTITY_MAPPING_OUTBOX_EVENT_UUID_GEN_STRATEGY</code></a>.</p>
</div>
</dd>
<dt class="hdlist1"><a id="configuration-properties-aggregated-hibernate-search-mapper-orm-outbox-pollinghibernate.search.coordination.entity.mapping.outboxevent.uuid_type"></a> <code>hibernate.search.coordination.entity.mapping.outboxevent.uuid_type</code></dt>
<dd>
<p>The name of the <a href="https://docs.jboss.org/hibernate/orm/6.4/javadocs/org/hibernate/type/SqlTypes.html"><code>Hibernate ORM constant type code used to identify a generic SQL type</code></a> used for representing an UUID in the outbox event table.</p>
<div class="paragraph">
<p>Only available when <a href="http://hibernate.org/search/apidocs/org/hibernate/search/mapper/orm/cfg/HibernateOrmMapperSettings.html#COORDINATION_STRATEGY">"hibernate.search.coordination.strategy"</a> is <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/mapper/orm/outboxpolling/cfg/HibernateOrmMapperOutboxPollingSettings.html#COORDINATION_STRATEGY_NAME">"outbox-polling"</a>.</p>
</div>
<div class="paragraph">
<p>The default for this value is <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/mapper/orm/outboxpolling/cfg/HibernateOrmMapperOutboxPollingSettings.Defaults.html#COORDINATION_ENTITY_MAPPING_OUTBOX_EVENT_UUID_TYPE"><code>HibernateOrmMapperOutboxPollingSettings.Defaults.COORDINATION_ENTITY_MAPPING_OUTBOX_EVENT_UUID_TYPE</code></a>.</p>
</div>
</dd>
<dt class="hdlist1"><a id="configuration-properties-aggregated-hibernate-search-mapper-orm-outbox-pollinghibernate.search.coordination.event_processor.batch_size"></a> <code>hibernate.search.coordination.event_processor.batch_size</code></dt>
<dd>
<p>In the event processor, how many outbox events, at most, are processed in a single transaction.</p>
<div class="paragraph">
<p>Only available when <a href="http://hibernate.org/search/apidocs/org/hibernate/search/mapper/orm/cfg/HibernateOrmMapperSettings.html#COORDINATION_STRATEGY">"hibernate.search.coordination.strategy"</a> is <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/mapper/orm/outboxpolling/cfg/HibernateOrmMapperOutboxPollingSettings.html#COORDINATION_STRATEGY_NAME">"outbox-polling"</a>.</p>
</div>
<div class="paragraph">
<p>Expects a positive Integer value, such as <code>50</code>, or a String that can be parsed into such Integer value.</p>
</div>
<div class="paragraph">
<p>Defaults to <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/mapper/orm/outboxpolling/cfg/HibernateOrmMapperOutboxPollingSettings.Defaults.html#COORDINATION_EVENT_PROCESSOR_BATCH_SIZE"><code>HibernateOrmMapperOutboxPollingSettings.Defaults.COORDINATION_EVENT_PROCESSOR_BATCH_SIZE</code></a>.</p>
</div>
<div class="paragraph">
<p>Default value: <code>50</code></p>
</div>
</dd>
<dt class="hdlist1"><a id="configuration-properties-aggregated-hibernate-search-mapper-orm-outbox-pollinghibernate.search.coordination.event_processor.enabled"></a> <code>hibernate.search.coordination.event_processor.enabled</code></dt>
<dd>
<p>Whether the application will process entity change events.</p>
<div class="paragraph">
<p>Only available when <a href="http://hibernate.org/search/apidocs/org/hibernate/search/mapper/orm/cfg/HibernateOrmMapperSettings.html#COORDINATION_STRATEGY">"hibernate.search.coordination.strategy"</a> is <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/mapper/orm/outboxpolling/cfg/HibernateOrmMapperOutboxPollingSettings.html#COORDINATION_STRATEGY_NAME">"outbox-polling"</a>.</p>
</div>
<div class="paragraph">
<p>Expects a Boolean value such as <code>true</code> or <code>false</code>, or a string that can be parsed into a Boolean value.</p>
</div>
<div class="paragraph">
<p>Defaults to <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/mapper/orm/outboxpolling/cfg/HibernateOrmMapperOutboxPollingSettings.Defaults.html#COORDINATION_EVENT_PROCESSOR_ENABLED"><code>HibernateOrmMapperOutboxPollingSettings.Defaults.COORDINATION_EVENT_PROCESSOR_ENABLED</code></a>.</p>
</div>
<div class="paragraph">
<p>When the event processor is disabled, events will still be produced by this application node whenever an entity changes, but indexing will not happen on this application node and is assumed to happen on another node.</p>
</div>
<div class="paragraph">
<p>Default value: <code>true</code></p>
</div>
</dd>
<dt class="hdlist1"><a id="configuration-properties-aggregated-hibernate-search-mapper-orm-outbox-pollinghibernate.search.coordination.event_processor.order"></a> <code>hibernate.search.coordination.event_processor.order</code></dt>
<dd>
<p>In the event processor, the order in which outbox events are processed.</p>
<div class="paragraph">
<p>Only available when <a href="http://hibernate.org/search/apidocs/org/hibernate/search/mapper/orm/cfg/HibernateOrmMapperSettings.html#COORDINATION_STRATEGY">"hibernate.search.coordination.strategy"</a> is <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/mapper/orm/outboxpolling/cfg/HibernateOrmMapperOutboxPollingSettings.html#COORDINATION_STRATEGY_NAME">"outbox-polling"</a>.</p>
</div>
<div class="paragraph">
<p>Expects one of the "external representation" strings defined in <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/mapper/orm/outboxpolling/cfg/OutboxEventProcessingOrder.html"><code>OutboxEventProcessingOrder</code></a>.</p>
</div>
<div class="paragraph">
<p>Defaults to <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/mapper/orm/outboxpolling/cfg/HibernateOrmMapperOutboxPollingSettings.Defaults.html#COORDINATION_EVENT_PROCESSOR_ORDER"><code>HibernateOrmMapperOutboxPollingSettings.Defaults.COORDINATION_EVENT_PROCESSOR_ORDER</code></a>.</p>
</div>
</dd>
<dt class="hdlist1"><a id="configuration-properties-aggregated-hibernate-search-mapper-orm-outbox-pollinghibernate.search.coordination.event_processor.polling_interval"></a> <code>hibernate.search.coordination.event_processor.polling_interval</code></dt>
<dd>
<p>In the event processor, how long to wait for another query to the outbox events table after a query didn&#8217;t return any event, in milliseconds.</p>
<div class="paragraph">
<p>Only available when <a href="http://hibernate.org/search/apidocs/org/hibernate/search/mapper/orm/cfg/HibernateOrmMapperSettings.html#COORDINATION_STRATEGY">"hibernate.search.coordination.strategy"</a> is <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/mapper/orm/outboxpolling/cfg/HibernateOrmMapperOutboxPollingSettings.html#COORDINATION_STRATEGY_NAME">"outbox-polling"</a>.</p>
</div>
<div class="paragraph">
<p>Hibernate Search will wait that long before polling again if the last polling didn&#8217;t return any event:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>High values mean higher latency between an entity change and the corresponding update in the index, but less stress on the database when there are no events to process.</p>
</li>
<li>
<p>Low values mean lower latency between an entity change and the corresponding update in the index, but more stress on the database when there are no events to process.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Expects a positive Integer value in milliseconds, such as <code>1000</code>, or a String that can be parsed into such Integer value.</p>
</div>
<div class="paragraph">
<p>Defaults to <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/mapper/orm/outboxpolling/cfg/HibernateOrmMapperOutboxPollingSettings.Defaults.html#COORDINATION_EVENT_PROCESSOR_POLLING_INTERVAL"><code>HibernateOrmMapperOutboxPollingSettings.Defaults.COORDINATION_EVENT_PROCESSOR_POLLING_INTERVAL</code></a>.</p>
</div>
<div class="paragraph">
<p>Default value: <code>100</code></p>
</div>
</dd>
<dt class="hdlist1"><a id="configuration-properties-aggregated-hibernate-search-mapper-orm-outbox-pollinghibernate.search.coordination.event_processor.pulse_expiration"></a> <code>hibernate.search.coordination.event_processor.pulse_expiration</code></dt>
<dd>
<p>How long, in milliseconds, an event processor "pulse" remains valid before considering the agent disconnected and forcibly removing it from the cluster.</p>
<div class="paragraph">
<p>Only available when <a href="http://hibernate.org/search/apidocs/org/hibernate/search/mapper/orm/cfg/HibernateOrmMapperSettings.html#COORDINATION_STRATEGY">"hibernate.search.coordination.strategy"</a> is <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/mapper/orm/outboxpolling/cfg/HibernateOrmMapperOutboxPollingSettings.html#COORDINATION_STRATEGY_NAME">"outbox-polling"</a>.</p>
</div>
<div class="paragraph">
<p>Every agent registers itself in a database table. Regularly, while polling for events to process, mass indexer agent performs a <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/mapper/orm/outboxpolling/cfg/HibernateOrmMapperOutboxPollingSettings.html#COORDINATION_EVENT_PROCESSOR_PULSE_INTERVAL"><code>"pulse"</code></a>: it pauses what it was doing and (among other things) updates its entry in the table, to let other agents know it&#8217;s still alive and prevent an expiration. If an agent fails to update its entry for longer than the value of the expiration interval, it will be considered disconnected: other agents will forcibly remove its entry from the table, and will perform rebalancing (reassign shards) as necessary.</p>
</div>
<div class="paragraph">
<p>The expiration interval must be set to a value at least 3 times larger than the <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/mapper/orm/outboxpolling/cfg/HibernateOrmMapperOutboxPollingSettings.html#COORDINATION_EVENT_PROCESSOR_PULSE_INTERVAL"><code>pulse interval</code></a>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Low values (closer to the pulse interval) mean less time wasted not processing events when a node abruptly leaves the cluster due to a crash or network failure, but increased risk of wasting time not processing events because an event processor is incorrectly considered disconnected.</p>
</li>
<li>
<p>High values (much larger than the pulse interval) mean more time wasted not processing events when a node abruptly leaves the cluster due to a crash or network failure, but reduced risk of wasting time not processing events because an event processor is incorrectly considered disconnected.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Expects a positive Integer value in milliseconds, such as <code>30000</code>, or a String that can be parsed into such Integer value.</p>
</div>
<div class="paragraph">
<p>Defaults to <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/mapper/orm/outboxpolling/cfg/HibernateOrmMapperOutboxPollingSettings.Defaults.html#COORDINATION_EVENT_PROCESSOR_PULSE_EXPIRATION"><code>HibernateOrmMapperOutboxPollingSettings.Defaults.COORDINATION_EVENT_PROCESSOR_PULSE_EXPIRATION</code></a>.</p>
</div>
<div class="paragraph">
<p>Default value: <code>30000</code></p>
</div>
</dd>
<dt class="hdlist1"><a id="configuration-properties-aggregated-hibernate-search-mapper-orm-outbox-pollinghibernate.search.coordination.event_processor.pulse_interval"></a> <code>hibernate.search.coordination.event_processor.pulse_interval</code></dt>
<dd>
<p>How long, in milliseconds, the event processor can poll for events before it must perform a "pulse".</p>
<div class="paragraph">
<p>Only available when <a href="http://hibernate.org/search/apidocs/org/hibernate/search/mapper/orm/cfg/HibernateOrmMapperSettings.html#COORDINATION_STRATEGY">"hibernate.search.coordination.strategy"</a> is <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/mapper/orm/outboxpolling/cfg/HibernateOrmMapperOutboxPollingSettings.html#COORDINATION_STRATEGY_NAME">"outbox-polling"</a>.</p>
</div>
<div class="paragraph">
<p>Every agent registers itself in a database table. Regularly, while polling for events to process, the event processor performs a "pulse": it pauses indexing and:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>It updates its own entry in the table, to let other agents know it&#8217;s still alive and prevent an expiration</p>
</li>
<li>
<p>It removes any other agents that expired from the table</p>
</li>
<li>
<p>It suspends itself if it notices a mass indexer is running</p>
</li>
<li>
<p>It performs rebalancing (reassignment of shards) if the number of agents participating in background indexing changed since the last pulse</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The pulse interval must be set to a value between the <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/mapper/orm/outboxpolling/cfg/HibernateOrmMapperOutboxPollingSettings.html#COORDINATION_EVENT_PROCESSOR_POLLING_INTERVAL"><code>polling interval</code></a> and one third (1/3) of the <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/mapper/orm/outboxpolling/cfg/HibernateOrmMapperOutboxPollingSettings.html#COORDINATION_EVENT_PROCESSOR_PULSE_EXPIRATION"><code>expiration interval</code></a>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Low values (closer to the polling interval) mean less time wasted not processing events when a node joins or leaves the cluster, and reduced risk of wasting time not processing events because an event processor is incorrectly considered disconnected, but more stress on the database because of more frequent checks of the list of agents.</p>
</li>
<li>
<p>High values (closer to the expiration interval) mean more time wasted not processing events when a node joins or leaves the cluster, and increased risk of wasting time not processing events because an event processor is incorrectly considered disconnected, but less stress on the database because of less frequent checks of the list of agents.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Expects a positive Integer value in milliseconds, such as <code>2000</code>, or a String that can be parsed into such Integer value.</p>
</div>
<div class="paragraph">
<p>Defaults to <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/mapper/orm/outboxpolling/cfg/HibernateOrmMapperOutboxPollingSettings.Defaults.html#COORDINATION_EVENT_PROCESSOR_PULSE_INTERVAL"><code>HibernateOrmMapperOutboxPollingSettings.Defaults.COORDINATION_EVENT_PROCESSOR_PULSE_INTERVAL</code></a>.</p>
</div>
<div class="paragraph">
<p>Default value: <code>2000</code></p>
</div>
</dd>
<dt class="hdlist1"><a id="configuration-properties-aggregated-hibernate-search-mapper-orm-outbox-pollinghibernate.search.coordination.event_processor.retry_delay"></a> <code>hibernate.search.coordination.event_processor.retry_delay</code></dt>
<dd>
<p>How long the event processor must wait before re-processing an event after its processing failed.</p>
<div class="paragraph">
<p>Only available when <a href="http://hibernate.org/search/apidocs/org/hibernate/search/mapper/orm/cfg/HibernateOrmMapperSettings.html#COORDINATION_STRATEGY">"hibernate.search.coordination.strategy"</a> is <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/mapper/orm/outboxpolling/cfg/HibernateOrmMapperOutboxPollingSettings.html#COORDINATION_STRATEGY_NAME">"outbox-polling"</a>.</p>
</div>
<div class="paragraph">
<p>Expects a positive integer value in seconds, such as <code>10</code>, or a String that can be parsed into such Integer value.</p>
</div>
<div class="paragraph">
<p>Use the value <code>0</code> to reprocess the failed events as soon as possible, with no delay.</p>
</div>
<div class="paragraph">
<p>Defaults to <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/mapper/orm/outboxpolling/cfg/HibernateOrmMapperOutboxPollingSettings.Defaults.html#COORDINATION_EVENT_PROCESSOR_RETRY_DELAY"><code>HibernateOrmMapperOutboxPollingSettings.Defaults.COORDINATION_EVENT_PROCESSOR_RETRY_DELAY</code></a>.</p>
</div>
<div class="paragraph">
<p>Default value: <code>30</code></p>
</div>
</dd>
<dt class="hdlist1"><a id="configuration-properties-aggregated-hibernate-search-mapper-orm-outbox-pollinghibernate.search.coordination.event_processor.shards.assigned"></a> <code>hibernate.search.coordination.event_processor.shards.assigned</code></dt>
<dd>
<p>The indices of shards assigned to this application node for event processing.</p>
<div class="paragraph">
<p><strong>WARNING:</strong> shards must be uniquely assigned to one and only one application nodes. Failing that, some events may not be processed or may be processed twice or in the wrong order, resulting in errors and/or out-of-sync indexes.</p>
</div>
<div class="paragraph">
<p>Only available when <a href="http://hibernate.org/search/apidocs/org/hibernate/search/mapper/orm/cfg/HibernateOrmMapperSettings.html#COORDINATION_STRATEGY">"hibernate.search.coordination.strategy"</a> is <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/mapper/orm/outboxpolling/cfg/HibernateOrmMapperOutboxPollingSettings.html#COORDINATION_STRATEGY_NAME">"outbox-polling"</a>.</p>
</div>
<div class="paragraph">
<p>When this property is set, <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/mapper/orm/outboxpolling/cfg/HibernateOrmMapperOutboxPollingSettings.html#COORDINATION_EVENT_PROCESSOR_SHARDS_TOTAL_COUNT">"hibernate.search.coordination.event_processor.shards.total_count"</a> must also be set.</p>
</div>
<div class="paragraph">
<p>Expects a shard index, i.e. an Integer value between <code>0</code> (inclusive) and the <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/mapper/orm/outboxpolling/cfg/HibernateOrmMapperOutboxPollingSettings.html#COORDINATION_EVENT_PROCESSOR_SHARDS_TOTAL_COUNT"><code>total shard count</code></a> (exclusive), or a String that can be parsed into such shard index, or a String containing multiple such shard index strings separated by commas, or a <code>Collection&lt;Integer&gt;</code> containing such shard indices.</p>
</div>
<div class="paragraph">
<p>No default: must be provided explicitly if you want static sharding.</p>
</div>
</dd>
<dt class="hdlist1"><a id="configuration-properties-aggregated-hibernate-search-mapper-orm-outbox-pollinghibernate.search.coordination.event_processor.shards.total_count"></a> <code>hibernate.search.coordination.event_processor.shards.total_count</code></dt>
<dd>
<p>The total number of shards across all application nodes for event processing.</p>
<div class="paragraph">
<p><strong>WARNING:</strong> This property must have the same value for all application nodes, and must never change unless all application nodes are stopped, then restarted. Failing that, some events may not be processed or may be processed twice or in the wrong order, resulting in errors and/or out-of-sync indexes.</p>
</div>
<div class="paragraph">
<p>Only available when <a href="http://hibernate.org/search/apidocs/org/hibernate/search/mapper/orm/cfg/HibernateOrmMapperSettings.html#COORDINATION_STRATEGY">"hibernate.search.coordination.strategy"</a> is <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/mapper/orm/outboxpolling/cfg/HibernateOrmMapperOutboxPollingSettings.html#COORDINATION_STRATEGY_NAME">"outbox-polling"</a>.</p>
</div>
<div class="paragraph">
<p>When this property is set, <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/mapper/orm/outboxpolling/cfg/HibernateOrmMapperOutboxPollingSettings.html#COORDINATION_EVENT_PROCESSOR_SHARDS_ASSIGNED">"hibernate.search.coordination.event_processor.shards.assigned"</a> must also be set.</p>
</div>
<div class="paragraph">
<p>Expects an Integer value of at least <code>2</code>, or a String that can be parsed into such Integer value.</p>
</div>
<div class="paragraph">
<p>No default: must be provided explicitly if you want static sharding.</p>
</div>
</dd>
<dt class="hdlist1"><a id="configuration-properties-aggregated-hibernate-search-mapper-orm-outbox-pollinghibernate.search.coordination.event_processor.transaction_timeout"></a> <code>hibernate.search.coordination.event_processor.transaction_timeout</code></dt>
<dd>
<p>In the event processor, the timeout for transactions processing outbox events.</p>
<div class="paragraph">
<p>Only available when <a href="http://hibernate.org/search/apidocs/org/hibernate/search/mapper/orm/cfg/HibernateOrmMapperSettings.html#COORDINATION_STRATEGY">"hibernate.search.coordination.strategy"</a> is <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/mapper/orm/outboxpolling/cfg/HibernateOrmMapperOutboxPollingSettings.html#COORDINATION_STRATEGY_NAME">"outbox-polling"</a>.</p>
</div>
<div class="paragraph">
<p>Only effective when a JTA transaction manager is configured.</p>
</div>
<div class="paragraph">
<p>Expects a positive Integer value in seconds, such as <code>10</code>, or a String that can be parsed into such Integer value.</p>
</div>
<div class="paragraph">
<p>When using JTA and this property is not set, Hibernate Search will use whatever default transaction timeout is configured in the JTA transaction manager.</p>
</div>
</dd>
<dt class="hdlist1"><a id="configuration-properties-aggregated-hibernate-search-mapper-orm-outbox-pollinghibernate.search.coordination.mass_indexer.polling_interval"></a> <code>hibernate.search.coordination.mass_indexer.polling_interval</code></dt>
<dd>
<p>In the mass indexer, how long to wait for another query to the agent table when actively waiting for event processors to suspend themselves, in milliseconds.</p>
<div class="paragraph">
<p>Only available when <a href="http://hibernate.org/search/apidocs/org/hibernate/search/mapper/orm/cfg/HibernateOrmMapperSettings.html#COORDINATION_STRATEGY">"hibernate.search.coordination.strategy"</a> is <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/mapper/orm/outboxpolling/cfg/HibernateOrmMapperOutboxPollingSettings.html#COORDINATION_STRATEGY_NAME">"outbox-polling"</a>.</p>
</div>
<div class="paragraph">
<p>Hibernate Search will wait that long before polling again when it finds other agents haven&#8217;t suspended yet:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Low values will reduce the time it takes for the mass indexer agent to detect that event processors finally suspended themselves, but will increase the stress on the database while the mass indexer agent is actively waiting.</p>
</li>
<li>
<p>High values will increase the time it takes for the mass indexer agent to detect that event processors finally suspended themselves, but will reduce the stress on the database while the mass indexer agent is actively waiting.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Expects a positive Integer value in milliseconds, such as <code>1000</code>, or a String that can be parsed into such Integer value.</p>
</div>
<div class="paragraph">
<p>Defaults to <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/mapper/orm/outboxpolling/cfg/HibernateOrmMapperOutboxPollingSettings.Defaults.html#COORDINATION_MASS_INDEXER_POLLING_INTERVAL"><code>HibernateOrmMapperOutboxPollingSettings.Defaults.COORDINATION_MASS_INDEXER_POLLING_INTERVAL</code></a>.</p>
</div>
<div class="paragraph">
<p>Default value: <code>100</code></p>
</div>
</dd>
<dt class="hdlist1"><a id="configuration-properties-aggregated-hibernate-search-mapper-orm-outbox-pollinghibernate.search.coordination.mass_indexer.pulse_expiration"></a> <code>hibernate.search.coordination.mass_indexer.pulse_expiration</code></dt>
<dd>
<p>How long, in milliseconds, a mass indexer agent "pulse" remains valid before considering the agent disconnected and forcibly removing it from the cluster.</p>
<div class="paragraph">
<p>Only available when <a href="http://hibernate.org/search/apidocs/org/hibernate/search/mapper/orm/cfg/HibernateOrmMapperSettings.html#COORDINATION_STRATEGY">"hibernate.search.coordination.strategy"</a> is <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/mapper/orm/outboxpolling/cfg/HibernateOrmMapperOutboxPollingSettings.html#COORDINATION_STRATEGY_NAME">"outbox-polling"</a>.</p>
</div>
<div class="paragraph">
<p>Every agent registers itself in a database table. Regularly, while polling for events to process, each agent performs a <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/mapper/orm/outboxpolling/cfg/HibernateOrmMapperOutboxPollingSettings.html#COORDINATION_MASS_INDEXER_PULSE_INTERVAL"><code>"pulse"</code></a>: it pauses what it was doing and (among other things) updates its entry in the table, to let other agents know it&#8217;s still alive and prevent an expiration. If an agent fails to update its entry for longer than the value of the expiration interval, it will be considered disconnected: other agents will forcibly remove its entry from the table, and will resume their work as if the expired agent didn&#8217;t exist.</p>
</div>
<div class="paragraph">
<p>The expiration interval must be set to a value at least 3 times larger than the <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/mapper/orm/outboxpolling/cfg/HibernateOrmMapperOutboxPollingSettings.html#COORDINATION_MASS_INDEXER_PULSE_INTERVAL"><code>pulse interval</code></a>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Low values (closer to the pulse interval) mean less time wasted with event processors not processing events when a mass indexer agent terminates due to a crash, but increased risk of event processors starting to process events again during mass indexing because a mass indexer agent is incorrectly considered disconnected.</p>
</li>
<li>
<p>High values (much larger than the pulse interval) mean more time wasted with event processors not processing events when a mass indexer agent terminates due to a crash, but reduced risk of event processors starting to process events again during mass indexing because a mass indexer agent is incorrectly considered disconnected.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Expects a positive Integer value in milliseconds, such as <code>30000</code>, or a String that can be parsed into such Integer value.</p>
</div>
<div class="paragraph">
<p>Defaults to <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/mapper/orm/outboxpolling/cfg/HibernateOrmMapperOutboxPollingSettings.Defaults.html#COORDINATION_MASS_INDEXER_PULSE_EXPIRATION"><code>HibernateOrmMapperOutboxPollingSettings.Defaults.COORDINATION_MASS_INDEXER_PULSE_EXPIRATION</code></a>.</p>
</div>
<div class="paragraph">
<p>Default value: <code>30000</code></p>
</div>
</dd>
<dt class="hdlist1"><a id="configuration-properties-aggregated-hibernate-search-mapper-orm-outbox-pollinghibernate.search.coordination.mass_indexer.pulse_interval"></a> <code>hibernate.search.coordination.mass_indexer.pulse_interval</code></dt>
<dd>
<p>How long, in milliseconds, the mass indexer can wait before it must perform a "pulse".</p>
<div class="paragraph">
<p>Only available when <a href="http://hibernate.org/search/apidocs/org/hibernate/search/mapper/orm/cfg/HibernateOrmMapperSettings.html#COORDINATION_STRATEGY">"hibernate.search.coordination.strategy"</a> is <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/mapper/orm/outboxpolling/cfg/HibernateOrmMapperOutboxPollingSettings.html#COORDINATION_STRATEGY_NAME">"outbox-polling"</a>.</p>
</div>
<div class="paragraph">
<p>Every agent registers itself in a database table. Regularly, the mass indexer performs a "pulse":</p>
</div>
<div class="ulist">
<ul>
<li>
<p>It updates its owm entry in the table, to let other agents know it&#8217;s still alive and prevent an expiration</p>
</li>
<li>
<p>It removes any other agents that expired from the table</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The pulse interval must be set to a value between the <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/mapper/orm/outboxpolling/cfg/HibernateOrmMapperOutboxPollingSettings.html#COORDINATION_MASS_INDEXER_POLLING_INTERVAL"><code>polling interval</code></a> and one third (1/3) of the <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/mapper/orm/outboxpolling/cfg/HibernateOrmMapperOutboxPollingSettings.html#COORDINATION_MASS_INDEXER_PULSE_EXPIRATION"><code>expiration interval</code></a>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Low values (closer to the polling interval) mean reduced risk of event processors starting to process events again during mass indexing because a mass indexer agent is incorrectly considered disconnected, but more stress on the database because of more frequent updates of the mass indexer agent&#8217;s entry in the agent table.</p>
</li>
<li>
<p>High values (closer to the expiration interval) mean increased risk of event processors starting to process events again during mass indexing because a mass indexer agent is incorrectly considered disconnected, but less stress on the database because of less frequent updates of the mass indexer agent&#8217;s entry in the agent table.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Expects a positive Integer value in milliseconds, such as <code>2000</code>, or a String that can be parsed into such Integer value.</p>
</div>
<div class="paragraph">
<p>Defaults to <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/mapper/orm/outboxpolling/cfg/HibernateOrmMapperOutboxPollingSettings.Defaults.html#COORDINATION_MASS_INDEXER_PULSE_INTERVAL"><code>HibernateOrmMapperOutboxPollingSettings.Defaults.COORDINATION_MASS_INDEXER_PULSE_INTERVAL</code></a>.</p>
</div>
<div class="paragraph">
<p>Default value: <code>2000</code></p>
</div>
</dd>
<dt class="hdlist1"><a id="configuration-properties-aggregated-hibernate-search-mapper-orm-outbox-pollinghibernate.search.coordination.tenants"></a> <code>hibernate.search.coordination.tenants</code></dt>
<dd>
<p>The root property for coordination properties specific to a tenant, e.g. "hibernate.search.coordination.tenants.tenant1.something = somevalue".</p>
</dd>
</dl>
</div>
</div>
<div class="sect2">
<h3 id="configuration-properties-aggregated-hibernate-search-mapper-pojo-standalone"><a class="anchor" href="#configuration-properties-aggregated-hibernate-search-mapper-pojo-standalone"></a>A.7. Hibernate Search Mapper - POJO Standalone</h3>
<div class="dlist">
<dl>
<dt class="hdlist1"><a id="configuration-properties-aggregated-hibernate-search-mapper-pojo-standalonehibernate.search.indexing.plan.synchronization.strategy"></a> <code>hibernate.search.indexing.plan.synchronization.strategy</code></dt>
<dd>
<p>How to synchronize between application threads and indexing triggered by the <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/mapper/pojo/standalone/cfg/../session/SearchSession.html"><code>SearchSession</code></a>'s <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/mapper/pojo/standalone/cfg/../session/SearchSession.html#indexingPlan()"><code>indexing plan</code></a>.</p>
<div class="paragraph">
<p>Expects one of the strings defined in <a href="http://hibernate.org/search/apidocs/org/hibernate/search/mapper/pojo/work/IndexingPlanSynchronizationStrategy.html"><code>IndexingPlanSynchronizationStrategy</code></a>, or a reference to a bean of type <a href="http://hibernate.org/search/apidocs/org/hibernate/search/mapper/pojo/work/IndexingPlanSynchronizationStrategy.html"><code>IndexingPlanSynchronizationStrategy</code></a>.</p>
</div>
<div class="paragraph">
<p>Defaults to <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/mapper/pojo/standalone/cfg/StandalonePojoMapperSettings.Defaults.html#INDEXING_PLAN_SYNCHRONIZATION_STRATEGY"><code>StandalonePojoMapperSettings.Defaults.INDEXING_PLAN_SYNCHRONIZATION_STRATEGY</code></a>.</p>
</div>
</dd>
<dt class="hdlist1"><a id="configuration-properties-aggregated-hibernate-search-mapper-pojo-standalonehibernate.search.mapping.configurer"></a> <code>hibernate.search.mapping.configurer</code></dt>
<dd>
<p>A configurer for the Hibernate Search mapping.</p>
<div class="paragraph">
<p>Expects a single-valued or multi-valued reference to beans of type <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/mapper/pojo/standalone/cfg/../mapping/StandalonePojoMappingConfigurer.html"><code>StandalonePojoMappingConfigurer</code></a>.</p>
</div>
<div class="paragraph">
<p>Defaults to no value.</p>
</div>
</dd>
<dt class="hdlist1"><a id="configuration-properties-aggregated-hibernate-search-mapper-pojo-standalonehibernate.search.mapping.multi_tenancy.enabled"></a> <code>hibernate.search.mapping.multi_tenancy.enabled</code></dt>
<dd>
<p>Enables or disables multi-tenancy.</p>
<div class="paragraph">
<p>If multi-tenancy is enabled, every <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/mapper/pojo/standalone/cfg/../mapping/SearchMapping.html#createSession()"><code>session</code></a> will need to be assigned a tenant identifier.</p>
</div>
<div class="paragraph">
<p>Expects a boolean value.</p>
</div>
<div class="paragraph">
<p>Defaults to <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/mapper/pojo/standalone/cfg/StandalonePojoMapperSettings.Defaults.html#MULTI_TENANCY_ENABLED"><code>StandalonePojoMapperSettings.Defaults.MULTI_TENANCY_ENABLED</code></a>.</p>
</div>
<div class="paragraph">
<p>Default value: <code>false</code></p>
</div>
</dd>
<dt class="hdlist1"><a id="configuration-properties-aggregated-hibernate-search-mapper-pojo-standalonehibernate.search.schema_management.strategy"></a> <code>hibernate.search.schema_management.strategy</code></dt>
<dd>
<p>The schema management strategy, controlling how indexes and their schema are created, updated, validated or dropped on startup and shutdown.</p>
<div class="paragraph">
<p>Expects a <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/mapper/pojo/standalone/cfg/../schema/management/SchemaManagementStrategyName.html"><code>SchemaManagementStrategyName</code></a> value, or a String representation of such value.</p>
</div>
<div class="paragraph">
<p>Defaults to <a href="https://docs.jboss.org/hibernate/search/7.1/api/org/hibernate/search/mapper/pojo/standalone/cfg/StandalonePojoMapperSettings.Defaults.html#SCHEMA_MANAGEMENT_STRATEGY"><code>StandalonePojoMapperSettings.Defaults.SCHEMA_MANAGEMENT_STRATEGY</code></a>.</p>
</div>
</dd>
</dl>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2024-08-30 19:29:26 UTC
</div>
</div>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  messageStyle: "none",
  tex2jax: {
    inlineMath: [["\\(", "\\)"]],
    displayMath: [["\\[", "\\]"]],
    ignoreClass: "nostem|nolatexmath"
  },
  asciimath2jax: {
    delimiters: [["\\$", "\\$"]],
    ignoreClass: "nostem|noasciimath"
  },
  TeX: { equationNumbers: { autoNumber: "none" } }
})
MathJax.Hub.Register.StartupHook("AsciiMath Jax Ready", function () {
  MathJax.InputJax.AsciiMath.postfilterHooks.Add(function (data, node) {
    if ((node = data.script.parentNode) && (node = node.parentNode) && node.classList.contains("stemblock")) {
      data.math.root.display = "block"
    }
    return data
  })
})
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/MathJax.js?config=TeX-MML-AM_HTMLorMML"></script>
<!-- HibernateDoc.OutdatedContent -->
<script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha256-cCueBR6CsyA4/9szpPfrX3s49M9vUU5BgtiJj06wt/s=" crossorigin="anonymous"></script>
<script src="/hibernate/_outdated-content/outdated-content.js" type="text/javascript"></script>
<script type="text/javascript">var jQuery_3_1 = $.noConflict(true); jQuery_3_1(document).ready(function() { HibernateDoc.OutdatedContent.install('search'); });</script>
<!-- /HibernateDoc.OutdatedContent -->

<!-- Dynamic TOC -->
<!-- Source: https://github.com/asciidoctor/asciidoctor/issues/699#issuecomment-321066006 -->
<script src="script/tocbot-3.0.2/tocbot.min.js"></script>
<script>
    /* Tocbot dynamic TOC, works with tocbot 3.0.2 */
    /* Source: https://github.com/asciidoctor/asciidoctor/issues/699#issuecomment-321066006
     * Adapted to auto-detect the heading selector.
     */
    var oldtoc = document.getElementById('toctitle').nextElementSibling;

    var headingSelectorVal;
    if (oldtoc.querySelector('.sectlevel5')) {
        headingSelectorVal = 'h1, h2, h3, h4, h5, h6'
    }
    else if (oldtoc.querySelector('.sectlevel4')) {
        headingSelectorVal = 'h1, h2, h3, h4, h5'
    }
    else if (oldtoc.querySelector('.sectlevel3')) {
        headingSelectorVal = 'h1, h2, h3, h4'
    }
    else if (oldtoc.querySelector('.sectlevel2')) {
        headingSelectorVal = 'h1, h2, h3'
    }
    else if (oldtoc.querySelector('.sectlevel1')) {
        headingSelectorVal = 'h1, h2'
    }
    else {
        // In case something went wrong
        headingSelectorVal = 'h1, h2, h3, h4'
    }

    var newtoc = document.createElement('div');
    newtoc.setAttribute('id', 'tocbot');
    newtoc.setAttribute('class', 'js-toc');
    oldtoc.parentNode.replaceChild(newtoc, oldtoc);
    tocbot.init({ contentSelector: '#content',
        headingSelector: headingSelectorVal,
        smoothScroll: false });
    var handleTocOnResize = function() {
        var width = window.innerWidth
                    || document.documentElement.clientWidth
                    || document.body.clientWidth;
        if (width < 768) {
            tocbot.refresh({ contentSelector: '#content',
                headingSelector: headingSelectorVal,
                collapseDepth: 6,
                activeLinkClass: 'ignoreactive',
                throttleTimeout: 1000,
                smoothScroll: false });
        }
        else {
            tocbot.refresh({ contentSelector: '#content',
                headingSelector: headingSelectorVal,
                smoothScroll: false });
        }
    };
    window.addEventListener('resize', handleTocOnResize);
    handleTocOnResize();
</script>
<!-- /Dynamic TOC -->
</body>
</html>