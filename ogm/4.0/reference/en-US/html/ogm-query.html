<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"><head><title xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory">Chapter 7. Query your entities</title><!-- HibernateDoc.Meta --><meta name="description" content="Hibernate OGM, JPA for NoSQL datastores - Reference Documentation" /><meta name="keywords" content="hibernate, ogm, hibernate ogm, nosql, jpa, infinispan, mongodb, neo4j, cassandra, couchdb, ehcache, redis" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><link rel="canonical" href="https://docs.jboss.org/hibernate/stable/ogm/reference/en-US/html_single/" /><!-- /HibernateDoc.Meta --><link rel="stylesheet" href="css/hibernate.css" type="text/css"/><meta xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" name="generator" content="DocBook XSL Stylesheets V1.74.0"/><meta xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" http-equiv="Content-Type" content="text/html; charset=UTF-8"/><link rel="home" href="index.html" title="Hibernate OGM Reference Guide"/><link rel="up" href="index.html" title="Hibernate OGM Reference Guide"/><link rel="prev" href="ogm-mapping.html" title="Chapter 6. Map your entities"/></head><body><p id="title"><a href="http://www.hibernate.org" class="site_href"><strong>Hibernate.org</strong></a><a href="http://hibernate.org/Documentation/DocumentationOverview" class="doc_href"><strong>Community Documentation</strong></a></p><ul class="docnav"><li class="previous"><a accesskey="p" href="ogm-mapping.html"><strong>Prev</strong></a></li><li class="next"/></ul><div class="chapter" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="ogm-query"/>Chapter 7. Query your entities</h2></div></div></div><div class="toc"><dl><dt><span class="section"><a href="ogm-query.html#_using_jp_ql">7.1. Using JP-QL</a></span></dt><dt><span class="section"><a href="ogm-query.html#_using_hibernate_search">7.2. Using Hibernate Search</a></span></dt><dt><span class="section"><a href="ogm-query.html#_using_the_criteria_api">7.3. Using the Criteria API</a></span></dt></dl></div><p>To query a NoSQL database is a complex feat,
especially as not all NoSQL solutions support all forms of query.
One of the goals of Hibernate OGM is to deal with this complexity
so that users don’t have to.
However, that’s not yet all implemented
and depending on your use case
there might be better approaches you can take advantage of.</p><p>If you skipped to this section without reading <a class="xref" href="ogm-architecture.html" title="Chapter 3. Architecture">Chapter 3, <i>Architecture</i></a>,
I’d suggest to read at least <a class="xref" href="ogm-architecture.html#ogm-architecture-dataqueried" title="3.3. How is data queried">Section 3.3, “How is data queried”</a>
as it will greatly help you choosing a query approach.</p><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="_using_jp_ql"/>7.1. Using JP-QL</h2></div></div></div><p>For Hibernate OGM we developed a brand new JP-QL parser
which is already able to convert simple queries
using Hibernate Search under the precondition that:</p><div class="itemizedlist"><ul><li>no join, aggregation, or other relational operations are implied</li><li>you are using the Hibernate Session API (JPA integration is coming)</li><li>the target entities and properties are indexed by Hibernate Search
(no validation is happening today)</li></ul></div><p>We do realize these are strong limitations,
so while it might be interesting to try it out,
for real usage we suggest for now to use either Hibernate Search full-text queries
or the native query technology of the NoSQL storage you are using.</p><p>To provide an example of what kind of queries would work:</p><div class="example"><a id="d0e2605"/><p class="title"><b>Example 7.1. Example of trivial Hibernate Query remapped on Hibernate Search</b></p><div class="example-contents"><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">Query</span><!-- <br/> --><span class="java_plain">&nbsp;query&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;session</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">createQuery</span><span class="java_separator">(</span><span class="java_literal">&quot;from&nbsp;Hypothesis&nbsp;h&nbsp;where&nbsp;h.description&nbsp;=&nbsp;:desc&quot;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">setString</span><span class="java_separator">(</span><span class="java_literal">&quot;desc&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;tomorrow&nbsp;it's&nbsp;going&nbsp;to&nbsp;rain&quot;</span><span class="java_separator">);</span></pre><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_plain">@</span><!-- <br/> --><span class="java_type">Entity</span><!-- <br/> --><span class="java_plain">&nbsp;@</span><!-- <br/> --><span class="java_type">Indexed</span>
<!--  --><br/><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_keyword">class</span><span class="java_plain">&nbsp;</span><span class="java_type">Hypothesis</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">Id</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;getId</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span><span class="java_plain">&nbsp;</span><span class="java_keyword">return</span><span class="java_plain">&nbsp;id</span><span class="java_separator">;</span><span class="java_plain">&nbsp;</span><span class="java_separator">}</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">void</span><span class="java_plain">&nbsp;setId</span><span class="java_separator">(</span><span class="java_type">String</span><span class="java_plain">&nbsp;id</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span><span class="java_plain">&nbsp;</span><span class="java_keyword">this</span><span class="java_separator">.</span><span class="java_plain">id&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;id</span><span class="java_separator">;</span><span class="java_plain">&nbsp;</span><span class="java_separator">}</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;id</span><span class="java_separator">;</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">Field</span><span class="java_separator">(</span><span class="java_plain">analyze</span><span class="java_operator">=</span><span class="java_type">Analyze</span><span class="java_separator">.</span><span class="java_plain">NO</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;getDescription</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span><span class="java_plain">&nbsp;</span><span class="java_keyword">return</span><span class="java_plain">&nbsp;description</span><span class="java_separator">;</span><span class="java_plain">&nbsp;</span><span class="java_separator">}</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">void</span><span class="java_plain">&nbsp;setDescription</span><span class="java_separator">(</span><span class="java_type">String</span><span class="java_plain">&nbsp;description</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span><span class="java_plain">&nbsp;</span><span class="java_keyword">this</span><span class="java_separator">.</span><span class="java_plain">description&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;description</span><span class="java_separator">;</span><span class="java_plain">&nbsp;</span><span class="java_separator">}</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;description</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_separator">}</span></pre></div></div><br class="example-break"/></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="_using_hibernate_search"/>7.2. Using Hibernate Search</h2></div></div></div><p>We actually did use Hibernate Search already in the previous example;
specifically the annotations <code class="literal"><span class="classname">@Indexed</span></code>
and <code class="literal"><span class="classname">@Field</span></code> are Hibernate Search specific.
In this example the query was defined using a JP-QL string
and then defining parameters;
that’s useful if all you have a is a JP-QL Query, but it is limiting.</p><p>Hibernate Search remaps the properties annotated with <code class="literal"><span class="classname">@Field</span></code>
in Lucene Documents, and manages the Lucene indexes
so that you can then perform Lucene Queries.</p><p>To be extremely short, Apache Lucene is a full-text indexing and query engine
with excellent query performance.
Featurewise, <span class="emphasis"><em>full-text</em></span> means
you can do much more than a simple equality match
as we did in the previous example.</p><p>Let’s show another example, now creating a Lucene Query instead:</p><div class="example"><a id="d0e2638"/><p class="title"><b>Example 7.2. Using Hibernate Search for fulltext matching</b></p><div class="example-contents"><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">EntityManager</span><!-- <br/> --><span class="java_plain">&nbsp;entityManager&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_separator">...</span>
<!--  --><br/><span class="java_operator">//</span><span class="java_type">Add</span><span class="java_plain">&nbsp;full</span><span class="java_operator">-</span><span class="java_plain">text&nbsp;superpowers&nbsp;to&nbsp;any&nbsp;</span><span class="java_type">EntityManager</span><span class="java_operator">:</span>
<!--  --><br/><span class="java_type">FullTextEntityManager</span><span class="java_plain">&nbsp;ftem&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_type">Search</span><span class="java_separator">.</span><span class="java_plain">getFullTextEntityManager</span><span class="java_separator">(</span><span class="java_plain">entityManager</span><span class="java_separator">);</span>
</span>
<!--  --><br/><span class="java_operator">//</span><span class="java_type">Optionally</span><span class="java_plain">&nbsp;use&nbsp;the&nbsp;</span><span class="java_type">QueryBuilder</span><span class="java_plain">&nbsp;to&nbsp;simplify&nbsp;</span><span class="java_type">Query</span><span class="java_plain">&nbsp;definition</span><span class="java_operator">:</span>
<!--  --><br/><span class="java_type">QueryBuilder</span><span class="java_plain">&nbsp;b&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;ftem</span><span class="java_separator">.</span><span class="java_plain">getSearchFactory</span><span class="java_separator">()</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">buildQueryBuilder</span><span class="java_separator">()</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">forEntity</span><span class="java_separator">(</span><span class="java_type">Hypothesis</span><span class="java_separator">.</span><span class="java_keyword">class</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">get</span><span class="java_separator">();</span>
</span>
<!--  --><br/><span class="java_operator">//</span><span class="java_type">Create</span><span class="java_plain">&nbsp;a&nbsp;</span><span class="java_type">Lucene</span><span class="java_plain">&nbsp;</span><span class="java_type">Query</span><span class="java_operator">:</span>
<!--  --><br/><span class="java_type">Query</span><span class="java_plain">&nbsp;lq&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;b</span><span class="java_separator">.</span><span class="java_plain">keyword</span><span class="java_separator">().</span><span class="java_plain">onField</span><span class="java_separator">(</span><span class="java_literal">&quot;description&quot;</span><span class="java_separator">).</span><span class="java_plain">matching</span><span class="java_separator">(</span><span class="java_literal">&quot;tomorrow&quot;</span><span class="java_separator">).</span><span class="java_plain">createQuery</span><span class="java_separator">();</span>
</span>
<!--  --><br/><span class="java_operator">//</span><span class="java_type">Transform</span><span class="java_plain">&nbsp;the&nbsp;</span><span class="java_type">Lucene</span><span class="java_plain">&nbsp;</span><span class="java_type">Query</span><span class="java_plain">&nbsp;in&nbsp;a&nbsp;JPA&nbsp;</span><span class="java_type">Query</span><span class="java_operator">:</span>
<!--  --><br/><span class="java_type">FullTextQuery</span><span class="java_plain">&nbsp;ftQuery&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;ftem</span><span class="java_separator">.</span><span class="java_plain">createFullTextQuery</span><span class="java_separator">(</span><span class="java_plain">lq</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">Hypothesis</span><span class="java_separator">.</span><span class="java_keyword">class</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_operator">//</span><span class="java_type">This</span><span class="java_plain">&nbsp;is&nbsp;a&nbsp;requirement&nbsp;when&nbsp;using&nbsp;</span><span class="java_type">Hibernate</span><span class="java_plain">&nbsp;OGM&nbsp;instead&nbsp;of&nbsp;ORM</span><span class="java_operator">:</span>
<!--  --><br/><span class="java_plain">ftQuery</span><span class="java_separator">.</span><span class="java_plain">initializeObjectsWith</span><span class="java_separator">(</span><span class="java_type">ObjectLookupMethod</span><span class="java_separator">.</span><span class="java_plain">SKIP</span><span class="java_separator">,</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">DatabaseRetrievalMethod</span><span class="java_separator">.</span><span class="java_plain">FIND_BY_ID</span><span class="java_separator">);</span>
</span>
<!--  --><br/><span class="java_operator">//</span><span class="java_type">List</span><span class="java_plain">&nbsp;all&nbsp;matching&nbsp;</span><span class="java_type">Hypothesis</span><span class="java_operator">:</span>
<!--  --><br/><span class="java_type">List</span><span class="java_operator">&lt;</span><span class="java_type">Hypothesis</span><span class="java_operator">&gt;</span><span class="java_plain">&nbsp;resultList&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;ftQuery</span><span class="java_separator">.</span><span class="java_plain">getResultList</span><span class="java_separator">();</span></pre></div></div><br class="example-break"/><p>Assuming our database contains an <code class="literal"><span class="classname">Hypothesis</span></code> instance
having description "tomorrow we release",
the query above will not find the entity
because we disabled text analysis in the previous mapping.</p><p>If we enable text analysis (which is the default):</p><div class="example"><a id="d0e2651"/><p class="title"><b>Example 7.3. Entity enabling text analysis</b></p><div class="example-contents"><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_plain">@</span><!-- <br/> --><span class="java_type">Entity</span><!-- <br/> --><span class="java_plain">&nbsp;@</span><!-- <br/> --><span class="java_type">Indexed</span>
<!--  --><br/><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_keyword">class</span><span class="java_plain">&nbsp;</span><span class="java_type">Hypothesis</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">Id</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;getId</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span><span class="java_plain">&nbsp;</span><span class="java_keyword">return</span><span class="java_plain">&nbsp;id</span><span class="java_separator">;</span><span class="java_plain">&nbsp;</span><span class="java_separator">}</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">void</span><span class="java_plain">&nbsp;setId</span><span class="java_separator">(</span><span class="java_type">String</span><span class="java_plain">&nbsp;id</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span><span class="java_plain">&nbsp;</span><span class="java_keyword">this</span><span class="java_separator">.</span><span class="java_plain">id&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;id</span><span class="java_separator">;</span><span class="java_plain">&nbsp;</span><span class="java_separator">}</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;id</span><span class="java_separator">;</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">Field</span><span class="java_separator">(</span><span class="java_plain">analyze</span><span class="java_operator">=</span><span class="java_type">Analyze</span><span class="java_separator">.</span><span class="java_plain">YES</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;getDescription</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span><span class="java_plain">&nbsp;</span><span class="java_keyword">return</span><span class="java_plain">&nbsp;description</span><span class="java_separator">;</span><span class="java_plain">&nbsp;</span><span class="java_separator">}</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">void</span><span class="java_plain">&nbsp;setDescription</span><span class="java_separator">(</span><span class="java_type">String</span><span class="java_plain">&nbsp;description</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span><span class="java_plain">&nbsp;</span><span class="java_keyword">this</span><span class="java_separator">.</span><span class="java_plain">description&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;description</span><span class="java_separator">;</span><span class="java_plain">&nbsp;</span><span class="java_separator">}</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;description</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_separator">}</span></pre></div></div><br class="example-break"/><p>Now the entity would match a query on "tomorrow"
as we’re unlocking text similarity queries!</p><p>Text similarity can be very powerful as it can be configured for specific languages
or domain specific terminology;
it can deal with typos and synonyms,
and above all it can return results by <span class="emphasis"><em>relevance</em></span>.</p><p>Worth noting the Lucene index is a vectorial space of term occurrence statistics:
so extracting tags from text, frequencies of strings
and correlate this data makes it very easy to build efficient data analysis applications.</p><p>For a full explanation of all its capabilities and configuration options,
see the <a class="ulink" href="http://docs.jboss.org/hibernate/stable/search/reference/en-US/html_single/">Hibernate Search reference documentation</a>.</p><p>While the potential of Lucene queries is very high,
it’s not suited for all use cases
 Let’s see some of the limitations of Lucene Queries as our main query engine:</p><div class="itemizedlist"><ul><li>Lucene doesn’t support Joins.
Any <code class="literal">to-One</code> relations can be mapped fine,
and the Lucene community is making progress on other forms,
but restrictions on <code class="literal">OneToMany</code> or <code class="literal">ManyToMany</code> can’t be implemented today.</li><li>Since we apply changes to the index at commit time,
your updates won’t affect queries until you commit
(we might improve on this).</li><li>While queries are extremely fast, write operations are not as fast
(but we can make it scale).</li></ul></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="_using_the_criteria_api"/>7.3. Using the Criteria API</h2></div></div></div><p>This is not implemented yet.</p></div></div><HR xmlns=""/><a xmlns="" href=""/><ul class="docnav"><li class="previous"><a accesskey="p" href="ogm-mapping.html"><strong>Prev</strong>Chapter 6. Map your entities</a></li><li class="up"><a accesskey="u" href="#"><strong>Top of page</strong></a></li><li class="home"><a accesskey="h" href="index.html"><strong>Front page</strong></a></li></ul><!-- HibernateDoc.OutdatedContent --><script src="//code.jquery.com/jquery-3.1.0.min.js" integrity="sha256-cCueBR6CsyA4/9szpPfrX3s49M9vUU5BgtiJj06wt/s=" crossorigin="anonymous"></script><script src="/hibernate/_outdated-content/outdated-content.js" type="text/javascript"></script><script type="text/javascript">var jQuery_3_1 = $.noConflict(true); jQuery_3_1(document).ready(function() { HibernateDoc.OutdatedContent.install("ogm"); });</script><!-- /HibernateDoc.OutdatedContent --></body></html>