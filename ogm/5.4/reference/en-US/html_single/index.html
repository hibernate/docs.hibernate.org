<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.6.1">
<meta name="author" content="Emmanuel Bernard, Sanne Grinovero, Gunnar Morling, Davide D'Alto, Guillaume Scheibel, Mark Paluch, Guillaume Smet, Fabio Massimo Ercoli">
<title>Hibernate OGM 5.4.1.Final: Reference Guide</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | http://asciidoctor.org */
/* Remove comment around @import statement below when using as a custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section,summary{display:block}
audio,canvas,video{display:inline-block}
audio:not([controls]){display:none;height:0}
[hidden],template{display:none}
script{display:none!important}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:transparent}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
input[type="search"]{-webkit-appearance:textfield;-moz-box-sizing:content-box;-webkit-box-sizing:content-box;box-sizing:content-box}
input[type="search"]::-webkit-search-cancel-button,input[type="search"]::-webkit-search-decoration{-webkit-appearance:none}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*:before,*:after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.spread{width:100%}
p.lead,.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{font-size:1.21875em;line-height:1.6}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:none}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #ddddd8;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite:before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media only screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7;font-weight:bold}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt,table tr:nth-of-type(even){background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix:before,.clearfix:after,.float-group:before,.float-group:after{content:" ";display:table}
.clearfix:after,.float-group:after{clear:both}
*:not(pre)>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background-color:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
*:not(pre)>code.nobreak{word-wrap:normal}
*:not(pre)>code.nowrap{white-space:nowrap}
pre,pre>code{line-height:1.45;color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;text-rendering:optimizeSpeed}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background-color:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button:before,b.button:after{position:relative;top:-1px;font-weight:400}
b.button:before{content:"[";padding:0 3px 0 2px}
b.button:after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header:before,#header:after,#content:before,#content:after,#footnotes:before,#footnotes:after,#footer:before,#footer:after{content:" ";display:table}
#header:after,#content:after,#footnotes:after,#footer:after{clear:both}
#content{margin-top:1.25em}
#content:before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #ddddd8}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #ddddd8;padding-bottom:8px}
#header .details{border-bottom:1px solid #ddddd8;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span:before{content:"\00a0\2013\00a0"}
#header .details br+span.author:before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark:before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber:after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #ddddd8;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #efefed;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media only screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background-color:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #efefed;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #efefed;left:auto;right:0}}
@media only screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background-color:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
.sect1{padding-bottom:.625em}
@media only screen and (min-width:768px){.sect1{padding-bottom:1.25em}}
.sect1+.sect1{border-top:1px solid #efefed}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor:before,h2>a.anchor:before,h3>a.anchor:before,#toctitle>a.anchor:before,.sidebarblock>.content>.title>a.anchor:before,h4>a.anchor:before,h5>a.anchor:before,h6>a.anchor:before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock>caption.title{white-space:nowrap;overflow:visible;max-width:0}
.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>.paragraph:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:initial}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #ddddd8;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock pre:not(.highlight),.listingblock pre[class="highlight"],.listingblock pre[class^="highlight "],.listingblock pre.CodeRay,.listingblock pre.prettyprint{background:#f7f7f8}
.sidebarblock .literalblock pre,.sidebarblock .listingblock pre:not(.highlight),.sidebarblock .listingblock pre[class="highlight"],.sidebarblock .listingblock pre[class^="highlight "],.sidebarblock .listingblock pre.CodeRay,.sidebarblock .listingblock pre.prettyprint{background:#f2f1f1}
.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;padding:1em;font-size:.8125em}
.literalblock pre.nowrap,.literalblock pre[class].nowrap,.listingblock pre.nowrap,.listingblock pre[class].nowrap{overflow-x:auto;white-space:pre;word-wrap:normal}
@media only screen and (min-width:768px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:.90625em}}
@media only screen and (min-width:1280px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:1em}}
.literalblock.output pre{color:#f7f7f8;background-color:rgba(0,0,0,.9)}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.listingblock>.content{position:relative}
.listingblock code[data-lang]:before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:#999}
.listingblock:hover code[data-lang]:before{display:block}
.listingblock.terminal pre .command:before{content:attr(data-prompt);padding-right:.5em;color:#999}
.listingblock.terminal pre .command:not([data-prompt]):before{content:"$"}
table.pyhltable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.pyhltable td{vertical-align:top;padding-top:0;padding-bottom:0;line-height:1.45}
table.pyhltable td.code{padding-left:.75em;padding-right:0}
pre.pygments .lineno,table.pyhltable td:not(.code){color:#999;padding-left:0;padding-right:.5em;border-right:1px solid #ddddd8}
pre.pygments .lineno{display:inline-block;margin-right:.25em}
table.pyhltable .linenodiv{background:none!important;padding-right:0!important}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock blockquote p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote:before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.5em;margin-right:.5ex;text-align:right}
.quoteblock .quoteblock{margin-left:0;margin-right:0;padding:.5em 0;border-left:3px solid rgba(0,0,0,.6)}
.quoteblock .quoteblock blockquote{padding:0 0 0 .75em}
.quoteblock .quoteblock blockquote:before{display:none}
.verseblock{margin:0 1em 1.25em 1em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract{margin:0 0 1.25em 0;display:block}
.quoteblock.abstract blockquote,.quoteblock.abstract blockquote p{text-align:left;word-spacing:0}
.quoteblock.abstract blockquote:before,.quoteblock.abstract blockquote p:first-of-type:before{display:none}
table.tableblock{max-width:100%;border-collapse:separate}
table.tableblock td>.paragraph:last-child p>p:last-child,table.tableblock th>p:last-child,table.tableblock td>p:last-child{margin-bottom:0}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>thead>tr>.tableblock,table.grid-all>tbody>tr>.tableblock{border-width:0 1px 1px 0}
table.grid-all>tfoot>tr>.tableblock{border-width:1px 1px 0 0}
table.grid-cols>*>tr>.tableblock{border-width:0 1px 0 0}
table.grid-rows>thead>tr>.tableblock,table.grid-rows>tbody>tr>.tableblock{border-width:0 0 1px 0}
table.grid-rows>tfoot>tr>.tableblock{border-width:1px 0 0 0}
table.grid-all>*>tr>.tableblock:last-child,table.grid-cols>*>tr>.tableblock:last-child{border-right-width:0}
table.grid-all>tbody>tr:last-child>.tableblock,table.grid-all>thead:last-child>tr>.tableblock,table.grid-rows>tbody>tr:last-child>.tableblock,table.grid-rows>thead:last-child>tr>.tableblock{border-bottom-width:0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot{border-width:1px 0}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
td>div.verse{white-space:pre}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{margin:0 auto .625em auto;margin-left:-1.375em;margin-right:0;padding:0;list-style:none;overflow:hidden}
ul.inline>li{list-style:none;float:left;margin-left:1.375em;display:block}
ul.inline>li>*{display:block}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist>table tr>td:first-of-type{padding:.4em .75em 0 .75em;line-height:1;vertical-align:top}
.colist>table tr>td:first-of-type img{max-width:initial}
.colist>table tr>td:last-of-type{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left,.imageblock[style*="float: left"]{margin:.25em .625em 1.25em 0}
.imageblock.right,.imageblock[style*="float: right"]{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em 0;border-width:1px 0 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;text-indent:-1.05em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background-color:#00fafa}
.black{color:#000}
.black-background{background-color:#000}
.blue{color:#0000bf}
.blue-background{background-color:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background-color:#fa00fa}
.gray{color:#606060}
.gray-background{background-color:#7d7d7d}
.green{color:#006000}
.green-background{background-color:#007d00}
.lime{color:#00bf00}
.lime-background{background-color:#00fa00}
.maroon{color:#600000}
.maroon-background{background-color:#7d0000}
.navy{color:#000060}
.navy-background{background-color:#00007d}
.olive{color:#606000}
.olive-background{background-color:#7d7d00}
.purple{color:#600060}
.purple-background{background-color:#7d007d}
.red{color:#bf0000}
.red-background{background-color:#fa0000}
.silver{color:#909090}
.silver-background{background-color:#bcbcbc}
.teal{color:#006060}
.teal-background{background-color:#007d7d}
.white{color:#bfbfbf}
.white-background{background-color:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background-color:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note:before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip:before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning:before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution:before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important:before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background-color:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]:after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background-color:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@media print{@page{margin:1.25cm .75cm}
*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare):after,a[href^="https:"]:not(.bare):after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]:after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #ddddd8!important;padding-bottom:0!important}
.sect1{padding-bottom:0!important}
.sect1+.sect1{border:0!important}
#header>h1:first-child{margin-top:1.25rem}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em 0}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span:before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]:before{display:block}
#footer{background:none!important;padding:0 .9375em}
#footer-text{color:rgba(0,0,0,.6)!important;font-size:.9em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
</style>
<link rel="stylesheet" href="css/font-awesome/css/font-awesome.min.css">
<!-- HibernateDoc.Meta -->
<meta name="description" content="Hibernate OGM, JPA for NoSQL datastores - Reference Documentation" />
<meta name="keywords" content="hibernate, ogm, hibernate ogm, nosql, jpa, infinispan, mongodb, neo4j, cassandra, couchdb, ehcache, redis" />
<link rel="canonical" href="https://docs.jboss.org/hibernate/stable/ogm/reference/en-US/html_single/" />
<!-- /HibernateDoc.Meta -->

<link rel="stylesheet" href="css/hibernate.css" type="text/css" />
</head>
<body class="book toc2 toc-left">
<div id="header">
<h1>Hibernate OGM 5.4.1.Final: Reference Guide</h1>
<div class="details">
<span id="author" class="author">Emmanuel Bernard</span><br>
<span id="author2" class="author">Sanne Grinovero</span><br>
<span id="author3" class="author">Gunnar Morling</span><br>
<span id="author4" class="author">Davide D'Alto</span><br>
<span id="author5" class="author">Guillaume Scheibel</span><br>
<span id="author6" class="author">Mark Paluch</span><br>
<span id="author7" class="author">Guillaume Smet</span><br>
<span id="author8" class="author">Fabio Massimo Ercoli</span><br>
<span id="revdate">2018-12-18</span>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#preface">Preface</a>
<ul class="sectlevel2">
<li><a href="#_goals">Goals</a></li>
<li><a href="#_what_we_have_today">What we have today</a></li>
<li><a href="#_experimental_features">Experimental features</a></li>
<li><a href="#_use_cases">Use cases</a></li>
</ul>
</li>
<li><a href="#ogm-howtocontribute">1. How to get help and contribute on Hibernate OGM</a>
<ul class="sectlevel2">
<li><a href="#ogm-howtocontribute-help">1.1. How to get help</a></li>
<li><a href="#ogm-howtocontribute-contribute">1.2. How to contribute</a>
<ul class="sectlevel3">
<li><a href="#_how_to_build_hibernate_ogm">1.2.1. How to build Hibernate OGM</a></li>
<li><a href="#_how_to_contribute_code_effectively">1.2.2. How to contribute code effectively</a></li>
</ul>
</li>
<li><a href="#_how_to_build_support_for_a_data_store">1.3. How to build support for a data store</a>
<ul class="sectlevel3">
<li><a href="#_datastore_providers">1.3.1. DataStore providers</a></li>
<li><a href="#_dialects">1.3.2. Dialects</a></li>
<li><a href="#_entities">1.3.3. Entities</a></li>
<li><a href="#_associations">1.3.4. Associations</a></li>
<li><a href="#_configuration">1.3.5. Configuration</a></li>
<li><a href="#_types">1.3.6. Types</a></li>
<li><a href="#_tests">1.3.7. Tests</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#ogm-gettingstarted">2. Getting started with Hibernate OGM</a></li>
<li><a href="#ogm-architecture">3. Architecture</a>
<ul class="sectlevel2">
<li><a href="#_general_architecture">3.1. General architecture</a></li>
<li><a href="#ogm-architecture-datapersisted">3.2. How is data persisted</a></li>
<li><a href="#ogm-architecture-sequences">3.3. Id generation using sequences</a></li>
<li><a href="#ogm-architecture-dataqueried">3.4. How is data queried</a></li>
</ul>
</li>
<li><a href="#ogm-configuration">4. Configure and start Hibernate OGM</a>
<ul class="sectlevel2">
<li><a href="#_bootstrapping_hibernate_ogm">4.1. Bootstrapping Hibernate OGM</a>
<ul class="sectlevel3">
<li><a href="#_using_jpa">4.1.1. Using JPA</a></li>
<li><a href="#_using_hibernate_orm_native_apis">4.1.2. Using Hibernate ORM native APIs</a></li>
</ul>
</li>
<li><a href="#ogm-configuration-environments">4.2. Environments</a>
<ul class="sectlevel3">
<li><a href="#ogm-configuration-environments-javaee">4.2.1. In a Java EE container</a></li>
<li><a href="#ogm-configuration-environments-standalonejta">4.2.2. In a standalone JTA environment</a></li>
<li><a href="#_without_jta">4.2.3. Without JTA</a></li>
</ul>
</li>
<li><a href="#ogm-configuration-optionsogm-configuration-options">4.3. Configuration options</a></li>
<li><a href="#_configuring_hibernate_search">4.4. Configuring Hibernate Search</a></li>
<li><a href="#ogm-configuration-jbossmodule">4.5. How to package Hibernate OGM applications for WildFly 14.0</a>
<ul class="sectlevel3">
<li><a href="#_packaging_hibernate_ogm_applications_for_wildfly_14_0">4.5.1. Packaging Hibernate OGM applications for WildFly 14.0</a></li>
<li><a href="#hibernate-ogm-jboss-modules-feature-packs">4.5.2. List of the Hibernate OGM WildFly/JBoss feature packs</a></li>
<li><a href="#_configure_your_persistence_xml_to_use_your_choice_of_persistence_provider">4.5.3. Configure your persistence.xml to use your choice of persistence provider</a></li>
<li><a href="#_enable_support_for_ee_8">4.5.4. Enable support for EE 8</a></li>
<li><a href="#_using_the_hibernate_ogm_modules_with_infinispan">4.5.5. Using the Hibernate OGM modules with Infinispan</a></li>
</ul>
</li>
<li><a href="#integration-with-wildfly-nosql">4.6. Integration with WildFly NoSQL</a>
<ul class="sectlevel3">
<li><a href="#_how_to_use_wildfly_nosql_with_hibernate_ogm">4.6.1. How to use WildFly NoSQL with Hibernate OGM</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#ogm-mapping">5. Map your entities</a>
<ul class="sectlevel2">
<li><a href="#_supported_entity_mapping">5.1. Supported entity mapping</a></li>
<li><a href="#ogm-mapping-supported-types">5.2. Supported Types</a></li>
<li><a href="#_supported_association_mapping">5.3. Supported association mapping</a>
<ul class="sectlevel3">
<li><a href="#_elements_order_in_associations">5.3.1. Elements order in associations</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#ogm-api">6. Hibernate OGM APIs</a>
<ul class="sectlevel2">
<li><a href="#_bootstrap_hibernate_ogm">6.1. Bootstrap Hibernate OGM</a></li>
<li><a href="#_jpa_and_native_hibernate_orm_apis">6.2. JPA and native Hibernate ORM APIs</a>
<ul class="sectlevel3">
<li><a href="#_accessing_the_code_ogmsession_code_api">6.2.1. Accessing the <code>OgmSession</code> API</a></li>
</ul>
</li>
<li><a href="#_on_flush_and_transactions">6.3. On flush and transactions</a>
<ul class="sectlevel3">
<li><a href="#ogm-api-error-handler">6.3.1. Acting upon errors during application of changes</a></li>
</ul>
</li>
<li><a href="#_spis">6.4. SPIs</a></li>
</ul>
</li>
<li><a href="#ogm-query">7. Query your entities</a>
<ul class="sectlevel2">
<li><a href="#ogm-jpql-query">7.1. Using JPQL</a></li>
<li><a href="#ogm-query-native">7.2. Using the native query language of your NoSQL</a></li>
<li><a href="#ogm-query-using-hibernate-search">7.3. Using Hibernate Search</a></li>
<li><a href="#_using_the_criteria_api">7.4. Using the Criteria API</a></li>
<li><a href="#_using_stored_procedures">7.5. Using stored procedures</a></li>
</ul>
</li>
<li><a href="#ogm-datastore-providers">8. NoSQL datastores</a>
<ul class="sectlevel2">
<li><a href="#_using_a_specific_nosql_datastore">8.1. Using a specific NoSQL datastore</a></li>
</ul>
</li>
<li><a href="#ogm-infinispan">9. Infinispan</a>
<ul class="sectlevel2">
<li><a href="#_why_use_hibernate_ogm_with_infinispan">9.1. Why use Hibernate OGM with Infinispan?</a></li>
<li><a href="#_infinispan_choosing_between_embedded_mode_and_hot_rod">9.2. Infinispan: Choosing between Embedded Mode and Hot Rod</a></li>
<li><a href="#ogm-infinispan-embedded">9.3. Hibernate OGM &amp; Infinispan Embedded</a>
<ul class="sectlevel3">
<li><a href="#ogm-infinispan-configuration">9.3.1. Configure Hibernate OGM for Infinispan Embedded</a></li>
<li><a href="#ogm-infinispan-add-dependencies">9.3.2. Adding Infinispan dependencies</a></li>
<li><a href="#ogm-infinispan-configuration-properties">9.3.3. Infinispan specific configuration properties</a></li>
<li><a href="#_cache_names_used_by_hibernate_ogm">9.3.4. Cache names used by Hibernate OGM</a></li>
<li><a href="#ogm-infinispan-storage">9.3.5. Manage data size</a></li>
<li><a href="#ogm-infinispan-clustering">9.3.6. Clustering: store data on multiple Infinispan nodes</a></li>
<li><a href="#ogm-infinispan-transactions">9.3.7. Transactions</a></li>
<li><a href="#_infinispan_embedded_stored_procedures">9.3.8. Infinispan Embedded Stored Procedures</a></li>
<li><a href="#ogm-infinispan-indexstorage">9.3.9. Storing a Lucene index in Infinispan</a></li>
</ul>
</li>
<li><a href="#ogm-infinispan-remote">9.4. Hibernate OGM &amp; Infinispan Server over Hot Rod</a>
<ul class="sectlevel3">
<li><a href="#_adding_infinispan_remote_dependencies">9.4.1. Adding Infinispan Remote dependencies</a></li>
<li><a href="#_configuration_properties_for_infinispan_remote">9.4.2. Configuration properties for Infinispan Remote</a></li>
<li><a href="#_data_encoding_protobuf_schema">9.4.3. Data encoding: Protobuf Schema</a></li>
<li><a href="#storage-principles-of-infinispan-dataprovider">9.4.4. Storage Principles of the Infinispan Remote dataprovider</a></li>
<li><a href="#infinispan-remote-cache-configuration">9.4.5. Caches creation and configuration</a></li>
<li><a href="#_remote_query_capabilities">9.4.6. Remote Query Capabilities</a></li>
<li><a href="#infinispan-remote-transaction">9.4.7. Infinispan Remote Transaction</a></li>
<li><a href="#_infinispan_remote_stored_procedures">9.4.8. Infinispan Remote Stored Procedures</a></li>
<li><a href="#_known_limitations_future_improvements">9.4.9. Known Limitations &amp; Future improvements</a></li>
</ul>
</li>
<li><a href="#ogm-infinispan-storage-principles">9.5. Storage principles</a>
<ul class="sectlevel3">
<li><a href="#ogm-infinispan-built-in-types">9.5.1. Properties and built-in types</a></li>
<li><a href="#_identifiers">9.5.2. Identifiers</a></li>
<li><a href="#_entities_2">9.5.3. Entities</a></li>
<li><a href="#_associations_2">9.5.4. Associations</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#ogm-mongodb">10. MongoDB</a>
<ul class="sectlevel2">
<li><a href="#_why_should_i_use_hibernate_ogm_with_mongodb">10.1. Why should I use Hibernate OGM with MongoDB</a></li>
<li><a href="#_configuring_mongodb">10.2. Configuring MongoDB</a>
<ul class="sectlevel3">
<li><a href="#_adding_mongodb_dependencies">10.2.1. Adding MongoDB dependencies</a></li>
<li><a href="#_mongodb_specific_configuration_properties">10.2.2. MongoDB specific configuration properties</a></li>
<li><a href="#ogm-mongodb-annotation-configuration">10.2.3. Annotation based configuration</a></li>
<li><a href="#ogm-mongodb-programmatic-configuration">10.2.4. Programmatic configuration</a></li>
</ul>
</li>
<li><a href="#ogm-mongodb-storage-principles">10.3. Storage principles</a>
<ul class="sectlevel3">
<li><a href="#mongodb-built-in-types">10.3.1. Properties and built-in types</a></li>
<li><a href="#mongodb-gridfs-support">10.3.2. GridFS Support</a></li>
<li><a href="#_entities_3">10.3.3. Entities</a></li>
<li><a href="#mongodb-associations">10.3.4. Associations</a></li>
</ul>
</li>
<li><a href="#ogm-mongodb-indexes-unique-constraints">10.4. Indexes and unique constraints</a>
<ul class="sectlevel3">
<li><a href="#_standard_indexes_and_unique_constraints">10.4.1. Standard indexes and unique constraints</a></li>
<li><a href="#_using_mongodb_specific_index_options">10.4.2. Using MongoDB specific index options</a></li>
<li><a href="#_full_text_indexes">10.4.3. Full text indexes</a></li>
</ul>
</li>
<li><a href="#_transactions">10.5. Transactions</a></li>
<li><a href="#ogm-mongodb-optimisticlocking">10.6. Optimistic Locking</a></li>
<li><a href="#ogm-mongodb-queries">10.7. Queries</a>
<ul class="sectlevel3">
<li><a href="#_jpql_queries">10.7.1. JPQL queries</a></li>
<li><a href="#ogm-mongodb-queries-native">10.7.2. Native MongoDB queries</a></li>
<li><a href="#ogm-mongodb-stored-proc-native">10.7.3. Server-side JavaScript and stored procedures</a></li>
<li><a href="#_hibernate_search">10.7.4. Hibernate Search</a></li>
</ul>
</li>
<li><a href="#_geospatial_support">10.8. Geospatial support</a>
<ul class="sectlevel3">
<li><a href="#_geospatial_fields">10.8.1. Geospatial fields</a></li>
<li><a href="#_geospatial_indexes_and_queries">10.8.2. Geospatial indexes and queries</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#ogm-neo4j">11. Neo4j</a>
<ul class="sectlevel2">
<li><a href="#_how_to_add_neo4j_integration">11.1. How to add Neo4j integration</a></li>
<li><a href="#_configuring_neo4j">11.2. Configuring Neo4j</a></li>
<li><a href="#ogm-neo4j-storage-principles">11.3. Storage principles</a>
<ul class="sectlevel3">
<li><a href="#ogm-neo4j-built-in-types">11.3.1. Properties and built-in types</a></li>
<li><a href="#_entities_4">11.3.2. Entities</a></li>
<li><a href="#_associations_3">11.3.3. Associations</a></li>
<li><a href="#_auto_generated_values">11.3.4. Auto-generated Values</a></li>
<li><a href="#_labels_summary">11.3.5. Labels summary</a></li>
</ul>
</li>
<li><a href="#ogm-neo4j-transactions">11.4. Transactions</a></li>
<li><a href="#ogm-neo4j-queries">11.5. Queries</a>
<ul class="sectlevel3">
<li><a href="#_jpql_queries_2">11.5.1. JPQL queries</a></li>
<li><a href="#ogm-neo4j-queries-native">11.5.2. Cypher queries</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="preface"><a class="anchor" href="#preface"></a>Preface</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Hibernate OGM is a persistence engine
providing Java Persistence (JPA) support for NoSQL datastores.
It reuses Hibernate ORM&#8217;s object life cycle management and (de)hydration engine
but persists entities into a NoSQL store (key/value, document, column-oriented, etc)
instead of a relational database.</p>
</div>
<div class="paragraph">
<p>It allows using the Java Persistence Query Language (JPQL) as an interface to querying stored data,
in addition to using native queries of the specific NoSQL database.</p>
</div>
<div class="paragraph">
<p>The project is now fairly mature when it comes to the storage strategies,
and the feature set is sufficient to be used in your projects.
We do have however much bigger ambitions than a simple object mapper.
Many things are on the roadmap (more NoSQL, query, denormalization engine, etc).
If you feel a feature is missing, <a href="#ogm-howtocontribute-contribute">report it to us</a>.
If you want to contribute, <a href="#ogm-howtocontribute">even better</a>!</p>
</div>
<div class="paragraph">
<p>Hibernate OGM is released under the LGPL open source license.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The future of this project is being shaped by the requests from our users.
Please give us feedback on</p>
</div>
<div class="ulist">
<ul>
<li>
<p>what you like</p>
</li>
<li>
<p>what you don&#8217;t like</p>
</li>
<li>
<p>what is confusing</p>
</li>
<li>
<p>what you are missing as a feature</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Check <a href="#ogm-howtocontribute-contribute">How to contribute</a> on how to contact us.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>We worked hard on this documentation but we know it is far from perfect.
If you find something confusing or feel that an explanation is missing,
please let us know.
Getting in touch is easy: see <a href="http://hibernate.org/community/">contacting the developer community</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_goals"><a class="anchor" href="#_goals"></a>Goals</h3>
<div class="paragraph">
<p>Hibernate OGM:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>offers a familiar programming paradigm (JPA) to deal with NoSQL stores</p>
</li>
<li>
<p>moves model denormalization from a manual imperative work
to a declarative approach handled by the engine</p>
</li>
<li>
<p>encourages new data usage patterns
and NoSQL exploration in more "traditional" enterprises</p>
</li>
<li>
<p>helps scale existing applications with a NoSQL front end
to a traditional database</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>NoSQL can be very disconcerting as it is composed of many disparate solutions
with different benefits and drawbacks.
NoSQL databases can be loosely classified in four families:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>graph oriented databases</p>
</li>
<li>
<p>key/value stores: essentially Maps
but with different behaviors and ideas behind various products
(data grids, persistent with strong or eventual consistency, etc)</p>
</li>
<li>
<p>document based datastores:
maps which contain semi-structured documents (think JSON)</p>
</li>
<li>
<p>column based datastores</p>
</li>
</ul>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/nosql.png" alt="nosql">
</div>
<div class="title">Figure 1. Various NoSQL families</div>
</div>
<div class="paragraph">
<p>Each have different benefits and drawbacks
and one solution might fit a use case better than an other.
However access patterns and APIs are different from one product to the other.</p>
</div>
<div class="paragraph">
<p>Hibernate OGM is not expected to be the Rosetta stone
used to interact with <em>all</em> NoSQL solution in <em>all</em> use cases.
But for people modeling their data as a domain model,
it provides distinctive advantages over raw APIs
and has the benefit of providing an API and semantic known to Java developers.
Reusing the same programmatic model and trying different (No)SQL engines
will hopefully help people to explore alternative datastores.</p>
</div>
<div class="paragraph">
<p>Hibernate OGM also aims at helping people scale traditional relational databases
by providing a NoSQL front-end and keeping the same JPA APIs and domain model.
It could for example help to migrate a selection of your model from an RDBMS
to a particular NoSQL solution which better fits the typical use case.</p>
</div>
</div>
<div class="sect2">
<h3 id="_what_we_have_today"><a class="anchor" href="#_what_we_have_today"></a>What we have today</h3>
<div class="paragraph">
<p>Today, Hibernate OGM does not support all of these goals.
Here is a list of what we have:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>store data in key/value stores (Infinispan and Ehcache)</p>
</li>
<li>
<p>store data in document stores (MongoDB and CouchDB - the latter in preview)</p>
</li>
<li>
<p>store data in graph databases (Neo4J)</p>
</li>
<li>
<p>Create, Read, Update and Delete operations (CRUD) for entities</p>
</li>
<li>
<p>polymorphic entities (support for superclasses, subclasses etc).</p>
</li>
<li>
<p>embeddable objects (aka components)</p>
</li>
<li>
<p>support for basic types (numbers, String, URL, Date, enums, etc)</p>
</li>
<li>
<p>support for associations</p>
</li>
<li>
<p>support for collections (Set, List, Map, etc)</p>
</li>
<li>
<p>support for JPQL queries (not arbitrary joins though)</p>
</li>
<li>
<p>support for mapping native queries results to managed entities</p>
</li>
<li>
<p>support for Hibernate Search&#8217;s full-text queries</p>
</li>
<li>
<p>and generally, support for JPA and native Hibernate ORM API support</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In short, a perfectly capable Object Mapper for multiple popular NoSQL datastores.</p>
</div>
</div>
<div class="sect2">
<h3 id="_experimental_features"><a class="anchor" href="#_experimental_features"></a>Experimental features</h3>
<div class="paragraph">
<p>As Hibernate OGM is a rather young project, some parts of it may be marked as experimental.
This may affect specific APIs or SPIs (e.g. the case for the <code>SchemaInitializer</code> SPI contract at the moment),
entire dialects (this is the case for the CouchDB dialect at the moment)
or deliverables.</p>
</div>
<div class="paragraph">
<p>Experimental APIs/SPIs are marked via the <code>@Experimental</code> annotation.
Experimental dialects make that fact apparent through their datastore name (e.g. "COUCHDB_EXPERIMENTAL")
and experimental deliverables use the "experimental" artifact classifier.</p>
</div>
<div class="paragraph">
<p>If a certain part is marked as experimental it may undergo backwards-incompatible changes in future releases.
E.g. API/SPI methods may be altered, so that code using them needs to be adapted as well.
For experimental dialects the persistent format of data may be changed,
so that a future version of such dialect may not be able to read back data written by previous versions.
A manual update of the affected data may be thus required.
Experimental deliverables should be used with special care, as they are work in progress.
You should use them for testing but not production use cases.</p>
</div>
<div class="paragraph">
<p>But most of our dialects are mature, so don&#8217;t worry ;)</p>
</div>
</div>
<div class="sect2">
<h3 id="_use_cases"><a class="anchor" href="#_use_cases"></a>Use cases</h3>
<div class="paragraph">
<p>Here are a few areas where Hibernate OGM can be beneficial:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>need to scale your datastore up and down rapidly
(via the underlying NoSQL datastore capability)</p>
</li>
<li>
<p>keep your domain model independent of the underlying datastore technology
(RDBMS, Infinispan, NoSQL)</p>
</li>
<li>
<p>explore the best tool for the use case</p>
</li>
<li>
<p>use a familiar JPA front end to your datastore</p>
</li>
<li>
<p>use Hibernate Search full-text search / text analysis capabilities
and store the data set in an scalable datastore</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>These are a few ideas and the list will grow as we add more capabilities to Hibernate OGM.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="ogm-howtocontribute"><a class="anchor" href="#ogm-howtocontribute"></a>1. How to get help and contribute on Hibernate OGM</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Hibernate OGM is a young project.
Join and help us shape it!</p>
</div>
<div class="sect2">
<h3 id="ogm-howtocontribute-help"><a class="anchor" href="#ogm-howtocontribute-help"></a>1.1. How to get help</h3>
<div class="paragraph">
<p>First of all, make sure to read this reference documentation.
This is the most comprehensive formal source of information.
Of course, it is not perfect:
feel free to come and ask for help,
comment or propose improvements in our
<a href="https://discourse.hibernate.org/c/hibernate-ogm">Hibernate OGM forum</a>.</p>
</div>
<div class="paragraph">
<p>You can also:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>open bug reports in <a href="https://hibernate.atlassian.net/browse/OGM">JIRA</a></p>
</li>
<li>
<p>propose improvements on the
<a href="http://www.hibernate.org/community/mailinglists">development mailing list</a></p>
</li>
<li>
<p>join us on IRC to discuss developments and improvements
(<code>#hibernate-dev</code> on <code>freenode.net</code>;
you need to be registered on freenode:
the room does not accept "anonymous" users).</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="ogm-howtocontribute-contribute"><a class="anchor" href="#ogm-howtocontribute-contribute"></a>1.2. How to contribute</h3>
<div class="paragraph">
<p>Welcome!</p>
</div>
<div class="paragraph">
<p>There are many ways to contribute:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>report bugs in <a href="https://hibernate.atlassian.net/browse/OGM">JIRA</a></p>
</li>
<li>
<p>give feedback in the forum, IRC or the development mailing list</p>
</li>
<li>
<p>improve the documentation</p>
</li>
<li>
<p>fix bugs or contribute new features</p>
</li>
<li>
<p>propose and code a datastore dialect for your favorite NoSQL engine</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Hibernate OGM&#8217;s code is available on GitHub at
<a href="https://github.com/hibernate/hibernate-ogm" class="bare">https://github.com/hibernate/hibernate-ogm</a>.</p>
</div>
<div class="sect3">
<h4 id="_how_to_build_hibernate_ogm"><a class="anchor" href="#_how_to_build_hibernate_ogm"></a>1.2.1. How to build Hibernate OGM</h4>
<div class="paragraph">
<p>Hibernate OGM uses Git and Maven 3,
make sure to have both installed on your system.</p>
</div>
<div class="paragraph">
<p>Clone the git repository from GitHub:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">#get the sources
git clone https://github.com/hibernate/hibernate-ogm
cd hibernate-ogm</code></pre>
</div>
</div>
<div class="paragraph">
<p>Run maven</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">#build project
mvn clean install -s settings-example.xml</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Note that Hibernate OGM uses artifacts from the Maven repository hosted by JBoss.
Make sure to either use the <code class="code">-s settings-example.xml</code> option
or adjust your <code class="filename">~/.m2/settings.xml</code>
according to the descriptions available
<a href="http://community.jboss.org/wiki/MavenGettingStarted-Users">on this jboss.org wiki page</a>.</p>
</div>
<div class="paragraph">
<p>These settings are required for development of Hibernate OGM but should not be needed to use it.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To skip building the documentation, set the <code>skipDocs</code> property to true:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">mvn clean install -DskipDocs=true -s settings-example.xml</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you just want to build the documentation only,
run it from the <code class="filename">hibernate-ogm-documentation/manual</code> subdirectory.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_how_to_contribute_code_effectively"><a class="anchor" href="#_how_to_contribute_code_effectively"></a>1.2.2. How to contribute code effectively</h4>
<div class="paragraph">
<p>The best way to share code is to fork the Hibernate OGM repository on GitHub,
create a branch and open a pull request when you are ready.
Make sure to rebase your pull request
on the latest version of the master branch before offering it.</p>
</div>
<div class="paragraph">
<p>Here are a couple of approaches the team follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>We do small independent commits for each code change.
In particular, we do not mix stylistic code changes (import, typos, etc)
and new features in the same commit.</p>
</li>
<li>
<p>Commit messages follow this convention:
the JIRA issue number, a short commit summary, an empty line,
a longer description if needed.
Make sure to limit line length to 80 characters, even at this day and age
it makes for more readable commit comments.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>OGM-123 Summary of commit operation

Optional details on the commit
and a longer description can be
added here.</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>A pull request can contain several commits but should be self contained:
include the implementation, its unit tests, its documentation
and javadoc changes if needed.</p>
</li>
<li>
<p>All commits are proposed via pull requests
and reviewed by another member of the team
before being pushed to the reference repository.
That&#8217;s right, we never commit directly upstream without code review.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_how_to_build_support_for_a_data_store"><a class="anchor" href="#_how_to_build_support_for_a_data_store"></a>1.3. How to build support for a data store</h3>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">Advanced section</div>
<div class="paragraph">
<p>This is an advanced subject, feel free to skip this section if you are not building a data store.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Hibernate OGM supports various data stores by abstracting them
with <code>DatastoreProvider</code> and <code>GridDialect</code>. The supported features vary between data stores,
and dialects do not have to implement all features. Hibernate OGM implements a TCK
(Technology Compatibility Kit) to verify interoperability and features of the dialect.
Hibernate OGM supports a variety of document- and key-value-stores and ships
with some abstraction and utility classes for document- and key-value-stores
(like <code>KeyValueStoreProperties</code> and <code>DocumentStoreProperties</code>).</p>
</div>
<div class="sect3">
<h4 id="_datastore_providers"><a class="anchor" href="#_datastore_providers"></a>1.3.1. DataStore providers</h4>
<div class="paragraph">
<p>Supporting a data store usually begins with a <code>DatastoreProvider</code>. Providers can
implement a lifecycle (<code>start</code>, <code>stop</code>) to initialize, configure and shutdown
resources. Taking a look at existing data store support such as MongoDB
(see <code>org.hibernate.ogm.datastore.mongodb.impl.MongoDBDatastoreProvider</code>)
is a good idea to get an impression of how to boot the data store support.
Providers are seen as services, they can implement various service interfaces
to activate certain features (see the <code>org.hibernate.service.spi</code> package for details).</p>
</div>
<div class="paragraph">
<p>A common issue to face then implementing new data stores is transactionality.
Some data stores provide transactional support that can be used in the context of Hibernate OGM wrapped by JTA.
If your data store does not support transactions, you
can enable transaction emulation within the <code>DatastoreProvider</code>.</p>
</div>
<div class="paragraph">
<p>Features of a <code>DatastoreProvider</code>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Resource lifecycle</p>
</li>
<li>
<p>Managing connection resources</p>
</li>
<li>
<p>Configuration</p>
</li>
<li>
<p>Access to query parsers</p>
</li>
<li>
<p>Define/Validate a schema</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_dialects"><a class="anchor" href="#_dialects"></a>1.3.2. Dialects</h4>
<div class="paragraph">
<p>A data store can have one or more dialects. Dialects describe the style
how data is mapped to a particular data store. NoSQL data stores imply a
certain nature, how to map data. Document-oriented data stores encourage
an entity-as-document pattern where embedded data structures could be
stored within the document itself. Key-value data stores allow different
approaches, e.g. storing an entity as JSON document or event storing
individual key-value pairs that map the entity within a hash table
data structure. Hibernate OGM allows multiple dialects per data store
and users may choose the most appropriate one.</p>
</div>
<div class="paragraph">
<p>The most basic support is provided by implementing the <code>GridDialect</code>
interface. Implementing that interface is mandatory to support a
specific data store.</p>
</div>
<div class="paragraph">
<p>A <code>GridDialect</code> usually supports:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Create/Read/Update/Delete for entities</p>
</li>
<li>
<p>Create/Read/Update/Delete for associations</p>
</li>
<li>
<p>Id/Sequence generator</p>
</li>
<li>
<p>Provides locking strategies</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>A dialect <em>may</em> optionally implement one or more additional facet
interfaces to provide a broader support for certain features:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>QueryableGridDialect</code></p>
</li>
<li>
<p><code>BatchableGridDialect</code></p>
</li>
<li>
<p><code>IdentityColumnAwareGridDialect</code></p>
</li>
<li>
<p><code>OptimisticLockingAwareGridDialect</code></p>
</li>
<li>
<p><code>MultigetGridDialect</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Features of a <code>QueryableGridDialect</code></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Query execution</p>
</li>
<li>
<p>Support for native queries</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Features of a <code>BatchableGridDialect</code></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Operation queueing</p>
</li>
<li>
<p>Execution of queued Create/Update/Delete as a batch</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Features of a <code>IdentityColumnAwareGridDialect</code></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Supports the generation of identity values upon data insertion</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Features of an <code>OptimisticLockingAwareGridDialect</code></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Finding and altering versioned records in an atomic fashion</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Features of a <code>MultigetGridDialect</code></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Retrieve multiple tuples within one operation</p>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Before starting make a clear plan of how you think entities, relations and nested structures
are best represented in the NoSQL store you plan to implement.
It helps to have a clear picture about that, and this will require some experience with the
NoSQL database you plan to support.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Start with a small feature set to get a feeling for Hibernate OGM,
for example aim at implementing CRUD operations only and ignore relations and queries.
You can always extend the features as you proceed.</p>
</div>
<div class="paragraph">
<p>Starting from or studying existing dialects is also an interesting strategy.
It can be intimidating with complex dialects though.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Hibernate OGM is not opinionated by which means data is stored/loaded
for a particular data store, but the particular dialect is.
Hibernate OGM strives for the most natural mapping style.
The idea is to facilitate integration with other applications
of that database by sticking to established patterns and idioms of that store.</p>
</div>
</div>
<div class="sect3">
<h4 id="_entities"><a class="anchor" href="#_entities"></a>1.3.3. Entities</h4>
<div class="paragraph">
<p>Entities are seen by a dialect as <code>Tuple</code>. A <code>Tuple</code> contains:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>a snapshot (that&#8217;s the view of the data as loaded from your database),</p>
</li>
<li>
<p>a set of key-value pairs that carry the actual data,</p>
</li>
<li>
<p>and a list of operations to apply onto the original snapshot.
Tuple keys use dot-path
property identifiers to indicate nesting. That comes handy when working
with document stores because you can build a document structure based on that details.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_associations"><a class="anchor" href="#_associations"></a>1.3.4. Associations</h4>
<div class="paragraph">
<p>Most NoSQL data stores have no built-in support for associations
between entities (unless you&#8217;re using a graph database).</p>
</div>
<div class="paragraph">
<p>Hibernate OGM simulates associations for datastore with no support
by storing the navigational information to go from a given entity
to its (list of) associated entity.
This of it as query materialisation.
This navigational information data can be stored within the
entity itself or externally (as own documents or relation items).</p>
</div>
</div>
<div class="sect3">
<h4 id="_configuration"><a class="anchor" href="#_configuration"></a>1.3.5. Configuration</h4>
<div class="paragraph">
<p>Hibernate OGM can read its configuration properties from various sources.
Most common configuration sources are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>hibernate.properties</code> file</p>
</li>
<li>
<p><code>persistence.xml</code> file</p>
</li>
<li>
<p>environment variables override or integrate properties set in the above configuration files</p>
</li>
<li>
<p>annotation configuration (entity classes)</p>
</li>
<li>
<p>programmatic configuration</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The <code>org.hibernate.ogm.options</code> package provides the configuration infrastructure.</p>
</div>
<div class="paragraph">
<p>You might want to look at <code>MongoDBConfiguration</code> or <code>InfinispanConfiguration</code>
to get an idea how configuration works. Configuration is usually read
when starting a data store provider or while operating. A good example
of accessing configuration during runtime is the association storage
option, where users can define, how to store a particular association
(within the entity or as a separate collection/key/document/node).</p>
</div>
<div class="paragraph">
<p>The configuration and options context infrastructure allows to support
data store-specific options such as <code>ReadPreference</code> for MongoDB or <code>TTL</code> for Redis.</p>
</div>
<div class="sect4">
<h5 id="_programmatic_configuration"><a class="anchor" href="#_programmatic_configuration"></a>Programmatic configuration</h5>
<div class="paragraph">
<p>Data store support can implement programmatic configuration. The
configuration splits into three parts:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Global configuration</p>
</li>
<li>
<p>Entity configuration</p>
</li>
<li>
<p>Property configuration</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Programmatic configuration consists of two parts: configuration
interfaces (see <code>org.hibernate.ogm.options.navigation</code>) and partial (abstract)
implementation classes. These parts are merged at runtime using ASM class generation.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_types"><a class="anchor" href="#_types"></a>1.3.6. Types</h4>
<div class="paragraph">
<p>Every data store supports a unique set of data types. Some stores support
floating point types and date types, others just strings. Hibernate OGM allows
users to utility a variety of data types (see JPA spec) for their data models.
On the other hand, that data needs to be stored within the data store and mapped back.</p>
</div>
<div class="paragraph">
<p>A dialect can provide a <code>GridType</code> to describe the handling of a particular
data type, meaning you can specify how dates, floating point types or even
byte arrays are handled. Whether they are mapped to other data types (e. g. use
<code>double</code> for <code>float</code> or use base64-encoded strings for byte arrays) or wrapped within strings.</p>
</div>
<div class="paragraph">
<p>Data store-specific types can be handled the same way, check out <code>StringAsObjectIdType</code>
 for the String-mapping of MongoDB&#8217;s <code>ObjectId</code> type.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Type-mapping can be an exhausting task. The whole type handling is in flux and is subject
to change as Hibernate OGM progresses. Ask, if you&#8217;re not sure about it.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_tests"><a class="anchor" href="#_tests"></a>1.3.7. Tests</h4>
<div class="paragraph">
<p>Hibernate OGM brings a well suited infrastructure for tests. The test
infrastructure consists of generic base classes (<code>OgmTestCase</code> for OGM and
<code>JpaTestCase</code> for JPA) for tests and a test helper (see <code>GridDialectTestHelper</code>).
That classes are used to get a different view on data than the frontend-view
by the <code>Session</code> and the <code>EntityManager</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>It is always helpful to create a set of own test cases for different
scenarios to validate the data is mapped in the way it&#8217;s intended or
to verify data store-specific options such as <code>TTL</code>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Another bunch of tests is called the backend TCK. That test classes test nearly
all aspects of Hibernate OGM viewed from a users' perspective. Tests contain
cases for simple/complex entities, associations, list- and map data types,
queries using Hibernate Search, and tests for data type support.</p>
</div>
<div class="paragraph">
<p>The backend TCK is included using classpath filters, just check one of the
current implementations (like <code>RedisBackendTckHelper</code>). When you&#8217;re developing a
core module, that is included in the distribution, you will have to add your
dialect to the <code>@SkipByGridDialect</code> annotation of some tests.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Running even 20% of the tests successfully is a great achievement. Proceed step-by-step.
Large numbers of tests can fail just because of one thing that is handled differently.
Don&#8217;t hesitate to ask for help.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="ogm-gettingstarted"><a class="anchor" href="#ogm-gettingstarted"></a>2. Getting started with Hibernate OGM</h2>
<div class="sectionbody">
<div class="paragraph">
<p>If you are familiar with JPA, you are almost good to go.
We will nevertheless walk you through the first few steps of persisting
and retrieving an entity using Hibernate OGM.</p>
</div>
<div class="paragraph">
<p>Before we can start, make sure you have the following tools configured:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Java JDK 8</p>
</li>
<li>
<p>Maven 3.2.3 or above</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Hibernate OGM is published in the Maven central repository.</p>
</div>
<div class="paragraph">
<p>Add <code>org.hibernate.ogm:hibernate-ogm-bom:5.4.1.Final</code> to your dependency management block
and <code>org.hibernate.ogm:hibernate-ogm-infinispan-embedded:5.4.1.Final</code>
to your project dependencies:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-XML" data-lang="XML">&lt;dependencyManagement&gt;
    &lt;dependencies&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.hibernate.ogm&lt;/groupId&gt;
            &lt;artifactId&gt;hibernate-ogm-bom&lt;/artifactId&gt;
            &lt;version&gt;5.4.1.Final&lt;/version&gt;
            &lt;type&gt;pom&lt;/type&gt;
            &lt;scope&gt;import&lt;/scope&gt;
        &lt;/dependency&gt;
    &lt;/dependencies&gt;
&lt;dependencyManagement&gt;

&lt;dependencies&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.hibernate.ogm&lt;/groupId&gt;
        &lt;artifactId&gt;hibernate-ogm-infinispan-embedded&lt;/artifactId&gt;
    &lt;/dependency&gt;
&lt;/dependencies&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The former is a so-called "bill of materials" POM
which specifies a matching set of versions for Hibernate OGM and its dependencies.
That way you never need to specify a version explicitly within your dependencies block,
you will rather get the versions from the BOM automatically.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you&#8217;re deploying your application onto WildFly 14.0,
you don&#8217;t need to add the Hibernate OGM modules to your deployment unit
but you can rather add them as modules to the application server.
Refer to <a href="#ogm-configuration-jbossmodule">How to package Hibernate OGM applications for WildFly 14.0</a> to learn more.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We will use the JPA APIs in this tutorial.
While Hibernate OGM depends on JPA 2.1,
it is marked as provided in the Maven POM file.
If you run outside a Java EE container,
make sure to explicitly add the dependency:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-XML" data-lang="XML">&lt;dependency&gt;
    &lt;groupId&gt;org.hibernate.javax.persistence&lt;/groupId&gt;
    &lt;artifactId&gt;hibernate-jpa-2.1-api&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s now map our first Hibernate OGM entity.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">@Entity
public class Dog {
   @Id @GeneratedValue(strategy = GenerationType.TABLE, generator = "dog")
   @TableGenerator(
      name = "dog",
      table = "sequences",
      pkColumnName = "key",
      pkColumnValue = "dog",
      valueColumnName = "seed"
   )
   public Long getId() { return id; }
   public void setId(Long id) { this.id = id; }
   private Long id;

   public String getName() { return name; }
   public void setName(String name) { this.name = name; }
   private String name;

   @ManyToOne
   public Breed getBreed() { return breed; }
   public void setBreed(Breed breed) { this.breed = breed; }
   private Breed breed;
}

@Entity
public class Breed {

   @Id @GeneratedValue(generator = "uuid")
   @GenericGenerator(name="uuid", strategy="uuid2")
   public String getId() { return id; }
   public void setId(String id) { this.id = id; }
   private String id;

   public String getName() { return name; }
   public void setName(String name) { this.name = name; }
   private String name;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>I lied to you, we have already mapped two entities!</p>
</div>
<div class="paragraph">
<p>If you are familiar with JPA,
you can see that there is nothing specific to Hibernate OGM in our mapping.</p>
</div>
<div class="paragraph">
<p>In this tutorial, we will use JBoss Transactions for our JTA transaction manager.
So let&#8217;s add the JTA API and JBoss Transactions to our POM as well.</p>
</div>
<div class="paragraph">
<p>We will also add Hibernate Search because the Infinispan dialect needs it to run
JPQL queries, but we will leave the details for another time
(<a href="#ogm-query-using-hibernate-search">Using Hibernate Search</a>).</p>
</div>
<div class="paragraph">
<p>The final list of dependencies should look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-XML" data-lang="XML">&lt;dependencies&gt;
    &lt;!-- Hibernate OGM Infinispan module; pulls in the OGM core module --&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.hibernate.ogm&lt;/groupId&gt;
        &lt;artifactId&gt;hibernate-ogm-infinispan-embedded&lt;/artifactId&gt;
    &lt;/dependency&gt;

    &lt;1-- Optional, needed to run JPQL queries on some datastores --&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.hibernate.search&lt;/groupId&gt;
        &lt;artifactId&gt;hibernate-search-orm&lt;/artifactId&gt;
    &lt;/dependency&gt;

    &lt;!-- Standard APIs dependencies - provided in a Java EE container --&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.hibernate.javax.persistence&lt;/groupId&gt;
        &lt;artifactId&gt;hibernate-jpa-2.1-api&lt;/artifactId&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.jboss.spec.javax.transaction&lt;/groupId&gt;
        &lt;artifactId&gt;jboss-transaction-api_1.2_spec&lt;/artifactId&gt;
    &lt;/dependency&gt;

    &lt;!-- Add the Narayana Transactions Manager
         an implementation would be provided in a Java EE container,
         but this works nicely in Java SE as well --&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.jboss.narayana.jta&lt;/groupId&gt;
        &lt;artifactId&gt;narayana-jta&lt;/artifactId&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.jboss&lt;/groupId&gt;
        &lt;artifactId&gt;jboss-transaction-spi&lt;/artifactId&gt;
    &lt;/dependency&gt;
&lt;/dependencies&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Next we need to define the persistence unit.
Create a <code>META-INF/persistence.xml</code> file.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-XML" data-lang="XML">&lt;?xml version="1.0"?&gt;
&lt;persistence xmlns="http://java.sun.com/xml/ns/persistence"
             xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
             xsi:schemaLocation="http://java.sun.com/xml/ns/persistence http://java.sun.com/xml/ns/persistence/persistence_2_0.xsd"
             version="2.0"&gt;

    &lt;persistence-unit name="ogm-jpa-tutorial" transaction-type="JTA"&gt;
        &lt;!-- Use the Hibernate OGM provider: configuration will be transparent --&gt;
        &lt;provider&gt;org.hibernate.ogm.jpa.HibernateOgmPersistence&lt;/provider&gt;
        &lt;properties&gt;
            &lt;!-- Here you will pick which NoSQL technology to use, and configure it;
                 in this example we start a local in-memory Infinispan node. --&gt;
            &lt;property name="hibernate.ogm.datastore.provider" value="infinispan_embedded"/&gt;
        &lt;/properties&gt;
    &lt;/persistence-unit&gt;
&lt;/persistence&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s now persist a set of entities and retrieve them.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">//accessing JBoss's Transaction can be done differently but this one works nicely
TransactionManager tm = com.arjuna.ats.jta.TransactionManager.transactionManager();

//build the EntityManagerFactory as you would build in in Hibernate ORM
EntityManagerFactory emf = Persistence.createEntityManagerFactory(
    "ogm-jpa-tutorial");

final Logger logger = LoggerFactory.getLogger(DogBreedRunner.class);

[..]

//Persist entities the way you are used to in plain JPA
tm.begin();
logger.infof("About to store dog and breed");
EntityManager em = emf.createEntityManager();
Breed collie = new Breed();
collie.setName("Collie");
em.persist(collie);
Dog dina = new Dog();
dina.setName("Dina");
dina.setBreed(collie);
em.persist(dina);
Long dinaId = dina.getId();
em.flush();
em.close();
tm.commit();

[..]

//Retrieve your entities the way you are used to in plain JPA
tm.begin();
logger.infof("About to retrieve dog and breed");
em = emf.createEntityManager();
dina = em.find(Dog.class, dinaId);
logger.infof("Found dog %s of breed %s", dina.getName(), dina.getBreed().getName());
em.flush();
em.close();
tm.commit();

[..]

emf.close();</code></pre>
</div>
</div>
<div class="paragraph">
<p>A working example can be found in Hibernate OGM&#8217;s distribution under
<code>hibernate-ogm-documentation/examples/gettingstarted</code>.</p>
</div>
<div class="paragraph">
<p>What have we seen?</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Hibernate OGM is a JPA implementation
and is used as such both for mapping and in API usage</p>
</li>
<li>
<p>It is configured as a specific JPA provider:
<code>org.hibernate.ogm.jpa.HibernateOgmPersistence</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Let&#8217;s explore more in the next chapters.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Hibernate OGM might also require <a href="http://hibernate.org/search/">Hibernate Search</a> on the classpath.
This depends on the dialect or features you want to use with you project and you will find more
details about it in the next chapters.</p>
</div>
<div class="paragraph">
<p>If you want to use Hibernate OGM with <a href="http://wildfly.org/">WildFly 14.0</a> you will need some
additional configuration and you can find all the details
in the <a href="#ogm-configuration-jbossmodule">How to package Hibernate OGM applications for WildFly 14.0</a> paragraph.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="ogm-architecture"><a class="anchor" href="#ogm-architecture"></a>3. Architecture</h2>
<div class="sectionbody">
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Hibernate OGM defines an abstraction layer
represented by <code>DatastoreProvider</code> and <code>GridDialect</code>
to separate the OGM engine from the datastores interaction.
It has successfully abstracted various key/value stores, document stores and graph databases.
We are working on testing it on other NoSQL families.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In this chapter we will explore:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the general architecture</p>
</li>
<li>
<p>how the data is persisted in the NoSQL datastore</p>
</li>
<li>
<p>how we support JPQL queries</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Let&#8217;s start with the general architecture.</p>
</div>
<div class="sect2">
<h3 id="_general_architecture"><a class="anchor" href="#_general_architecture"></a>3.1. General architecture</h3>
<div class="paragraph">
<p>Hibernate OGM is made possible by the reuse of a few key components:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Hibernate ORM for JPA support</p>
</li>
<li>
<p>the NoSQL drivers to interact with the underlying datastore</p>
</li>
<li>
<p>optionally Hibernate Search for indexing and query purposes</p>
</li>
<li>
<p>optionally Infinispan&#8217;s Lucene Directory to store indexes in Infinispan itself,
or in many other NoSQL using Infinispan&#8217;s write-through cachestores</p>
</li>
<li>
<p>Hibernate OGM itself</p>
</li>
</ul>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/ogm-architecture.png" alt="ogm architecture">
</div>
<div class="title">Figure 2. General architecture</div>
</div>
<div class="paragraph">
<p>Hibernate OGM reuses as much as possible from the Hibernate ORM infrastructure.
There is no need to rewrite a new JPA engine.
The <code>Persister</code>s and the <code>Loader</code>s
(two interfaces used by Hibernate ORM)
have been rewritten to persist data in the NoSQL store.
These implementations are the core of Hibernate OGM.
We will see in <a href="#ogm-architecture-datapersisted">How is data persisted</a> how the data is structured.</p>
</div>
<div class="paragraph">
<p>The particularities between NoSQL stores are abstracted
by the notion of a <code>DatastoreProvider</code> and a <code>GridDialect</code>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>DatastoreProvider</code> abstracts how to start
and maintain a connection between Hibernate OGM and the datastore.</p>
</li>
<li>
<p><code>GridDialect</code> abstracts how data itself including associations
are persisted.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Think of them as the JDBC layer for our NoSQL stores.</p>
</div>
<div class="paragraph">
<p>Other than these, all the Create/Read/Update/Delete (CRUD) operations
are implemented by the Hibernate ORM engine
(object hydration and dehydration, cascading, lifecycle etc).</p>
</div>
<div class="paragraph">
<p>As of today, we have implemented the following datastore providers:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>a HashMap based datastore provider (for testing)</p>
</li>
<li>
<p>an Infinispan Embedded datastore provider to persist your entities in an Infinispan instance running within the same JVM</p>
</li>
<li>
<p>an Infinispan Remote datastore provider to persist your entities in Infinispan over a remote Hot Rod client</p>
</li>
<li>
<p>an Ehcache based datastore provider to persist your entities in Ehcache</p>
</li>
<li>
<p>a MongoDB based datastore provider to persist data in a MongoDB database</p>
</li>
<li>
<p>a Neo4j based datastore provider to persist data in the Neo4j graph database</p>
</li>
<li>
<p>a CouchDB based datastore provider to persist data in the CouchDB document store (experimental)</p>
</li>
<li>
<p>a Cassandra based datastore provider to persist data in Apache Cassandra (experimental)</p>
</li>
<li>
<p>a Redis based datastore provider to persist data in the Redis key/value store (experimental)</p>
</li>
<li>
<p>an Ignite based datastore provider to persist data in Apache Ignite (experimental)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To implement JPQL queries, Hibernate OGM parses the JPQL string
and calls the appropriate translator functions to build a native query.
Since not all NoSQL technologies support querying, when lacking we can
use Hibernate Search as an external query engine.</p>
</div>
<div class="paragraph">
<p>We will discuss the subject of querying
in more details in <a href="#ogm-architecture-dataqueried">How is data queried</a>.</p>
</div>
<div class="paragraph">
<p>Hibernate OGM best works in a JTA environment.
The easiest solution is to deploy it on a Java EE container.
Alternatively, you can use a standalone JTA <code>TransactionManager</code>.
We explain how to in <a href="#ogm-configuration-environments-standalonejta">In a standalone JTA environment</a>.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s now see how and in which structure data is persisted in the NoSQL data store.</p>
</div>
</div>
<div class="sect2">
<h3 id="ogm-architecture-datapersisted"><a class="anchor" href="#ogm-architecture-datapersisted"></a>3.2. How is data persisted</h3>
<div class="paragraph">
<p>Hibernate OGM tries to reuse as much as possible the relational model concepts,
at least when they are practical and make sense in OGM&#8217;s case.
For very good reasons, the relational model brought peace
in the database landscape over 30 years ago.
In particular, Hibernate OGM inherits the following traits:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>abstraction between the application object model
and the persistent data model</p>
</li>
<li>
<p>persist data as basic types</p>
</li>
<li>
<p>keep the notion of primary key to address an entity</p>
</li>
<li>
<p>keep the notion of foreign key to link two entities (not enforced)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If the application data model is too tightly coupled
with your persistent data model, a few issues arise:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>any change in the application object hierarchy / composition
must be reflected in the persistent data</p>
</li>
<li>
<p>any change in the application object model
will require a migration at the data level</p>
</li>
<li>
<p>any access to the data by another application
ties both applications losing flexibility</p>
</li>
<li>
<p>any access to the data from another platform become somewhat more challenging</p>
</li>
<li>
<p>serializing entities leads to many additional problems (see note below)</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Why aren&#8217;t entities serialized in the key/value entry</div>
<div class="paragraph">
<p>There are a couple of reasons why serializing the entity
directly in the datastore - key/value in particular - can lead to problems:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>When entities are pointing to other entities are you storing the whole graph?
Hint: this can be quite big!</p>
</li>
<li>
<p>If doing so, how do you guarantee object identity or even consistency
amongst duplicated objects?
It might make sense to store the same object graph from different root objects.</p>
</li>
<li>
<p>What happens in case of class schema change?
If you add or remove a property or include a superclass,
you must migrate all entities in your datastore to avoid deserialization issues.</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Entities are stored as tuples of values by Hibernate OGM.
More specifically, each entity is conceptually represented by a <code>Map&lt;String,Object&gt;</code>
where the key represents the column name (often the property name but not always)
and the value represents the column value as a basic type.
We favor basic types over complex ones to increase portability
(across platforms and across type / class schema evolution over time).
For example a <code>URL</code> object is stored as its String representation.</p>
</div>
<div class="paragraph">
<p>The key identifying a given entity instance is composed of:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the table name</p>
</li>
<li>
<p>the primary key column name(s)</p>
</li>
<li>
<p>the primary key column value(s)</p>
</li>
</ul>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/data-entity.png" alt="data entity">
</div>
<div class="title">Figure 3. Storing entities</div>
</div>
<div class="paragraph">
<p>The <code>GridDialect</code> specific to the NoSQL datastore you target
is then responsible to convert this map into the most natural model:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>for a key/value store or a data grid,
we use the logical key as the key in the grid and we store the map as the value.
Note that it&#8217;s an approximation
and some key/value providers will use more tailored approaches.</p>
</li>
<li>
<p>for a document oriented store, the map is represented by a document
and each entry in the map corresponds to a property in a document.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Associations are also stored as tuples.
Hibernate OGM stores the information necessary
to navigate from an entity to its associations.
This is a departure from the pure relational model
but it ensures that association data is reachable via key lookups
based on the information contained in the entity tuple we want to navigate from.
Note that this leads to some level of duplication
as information has to be stored for both sides of the association.</p>
</div>
<div class="paragraph">
<p>The key in which association data are stored is composed of:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the table name</p>
</li>
<li>
<p>the column name(s) representing the foreign key to the entity we come from</p>
</li>
<li>
<p>the column value(s) representing the foreign key to the entity we come from</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Using this approach, we favor fast read and (slightly) slower writes.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/data-association.png" alt="data association">
</div>
<div class="title">Figure 4. Storing associations</div>
</div>
<div class="paragraph">
<p>Note that this approach has benefits and drawbacks:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>it ensures that all CRUD operations are doable via key lookups</p>
</li>
<li>
<p>it favors reads over writes (for associations)</p>
</li>
<li>
<p>but it duplicates data</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Again, there are specificities in how data is inherently stored
in the specific NoSQL store.
For example, in document oriented stores,
the association information including the identifier to the associated entities
can be stored in the entity owning the association.
This is a more natural model for documents.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/data-association-document.png" alt="data association document">
</div>
<div class="title">Figure 5. Storing associations in a document store</div>
</div>
<div class="paragraph">
<p>Some identifiers require to store a seed in the datastore
(like sequences for examples).
The seed is stored in the value whose key is composed of:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the table name</p>
</li>
<li>
<p>the column name representing the segment</p>
</li>
<li>
<p>the column value representing the segment</p>
</li>
</ul>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This description is how conceptually Hibernate OGM asks the datastore provider to store data.
Depending on the family and even the specific datastore, the storage is optimized to be as natural as possible.
In other words as you would have stored the specific structure naturally.
Make sure to check the chapter dedicated to the NoSQL store you target
to find the specificities.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Many NoSQL stores have no notion of schema.
Likewise, the tuple stored by Hibernate OGM is not tied to a particular schema:
the tuple is represented by a <code>Map</code>,
not a typed <code>Map</code> specific to a given entity type.
Nevertheless, JPA does describe a schema thanks to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the class schema</p>
</li>
<li>
<p>the JPA physical annotations like <code>@Table</code> and <code>@Column</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>While tied to the application, it offers some robustness and explicit understanding
when the schema is changed as the schema is right in front of the developers' eyes.
This is an intermediary model between the strictly typed relational model
and the totally schema-less approach pushed by some NoSQL families.</p>
</div>
</div>
<div class="sect2">
<h3 id="ogm-architecture-sequences"><a class="anchor" href="#ogm-architecture-sequences"></a>3.3. Id generation using sequences</h3>
<div class="paragraph">
<p>You can use sequences with the following annotations:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>@SequenceGenerator</code>:
it will use native sequences if available</p>
</li>
<li>
<p><code>@TableGenerator</code>:
it will emulate sequences storing the value in the most appropriate data structure;
for example a document in MongoDB or a node in Neo4j.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Here&#8217;s some things to keep in mind when dealing with sequence generation:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>@TableGenerator</code> is the fallback approach used when the underlying datastore does not
support native sequences generation.</p>
</li>
<li>
<p>If the datastore does not support atomic operations and does not support native sequences,
Hibernate OGM will throw an exception at bootstrap and suggest alternatives.</p>
</li>
<li>
<p>The mapping of the sequence might change based on the annotation used, you should check the
mapping paragraph in the documentation related to the dialect you are using.</p>
</li>
<li>
<p>The value saved in the the datastore might not be the next value in the sequence.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="ogm-architecture-dataqueried"><a class="anchor" href="#ogm-architecture-dataqueried"></a>3.4. How is data queried</h3>
<div class="paragraph">
<p>Since Hibernate OGM wants to offer all of JPA, it needs to support JPQL queries.
Hibernate OGM parses the JPQL query string and extracts its meaning.
From there, several options are available
depending of the capabilities of the NoSQL store you target:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>it directly delegates the native query generation
to the datastore specific query translator implementation</p>
</li>
<li>
<p>it uses Hibernate Search as a query engine to execute the query</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If the NoSQL datastore has some query capabilities
and if the JPQL query is simple enough to be executed by the datastore,
then the JPQL parser directly pushes the query generation
to the NoSQL specific query translator.
The query returns the list of matching entity columns or projections
and Hibernate OGM returns managed entities.</p>
</div>
<div class="paragraph">
<p>Some NoSQL stores have poor query support, or none at all.
In this case Hibernate OGM can use Hibernate Search as its indexing and query engine.
Hibernate Search is able to index and query objects - entities -
and run full-text queries.
It uses the well known Apache Lucene to do this
but adds a few interesting characteristics like clustering support
and an object oriented abstraction including an object oriented query DSL.
Let&#8217;s have a look at the architecture of Hibernate OGM
when using Hibernate Search:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/ogm-architecture-with-hsearch.png" alt="ogm architecture with hsearch">
</div>
<div class="title">Figure 6. Using Hibernate Search as query engine - greyed areas are blocks already present in Hibernate OGM&#8217;s architecture</div>
</div>
<div class="paragraph">
<p>In this situation, Hibernate ORM Core pushes change events
to Hibernate Search which will index entities accordingly
and keep the index and the datastore in sync.
The JPQL query parser delegates the query translation to the Hibernate Search query translator
and executes the query on top of the Lucene indexes.
Indexes can be stored in various fashions:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>on a file system (the default in Lucene)</p>
</li>
<li>
<p>in Infinispan via the Infinispan Lucene directory implementation:
the index is then distributed across several servers transparently</p>
</li>
<li>
<p>in NoSQL stores that can natively store Lucene indexes</p>
</li>
<li>
<p>in NoSQL stores that can be used as overflow to Infinispan:
in this case Infinispan is used as an intermediary layer
to serve the index efficiently but persists the index in another NoSQL store.</p>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>You can use Hibernate Search
even if you do plan to use the NoSQL datastore query capabilities.
Hibernate Search offers a few interesting options:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>clusterability</p>
</li>
<li>
<p>full-text queries - ie Google for your entities</p>
</li>
<li>
<p>geospatial queries</p>
</li>
<li>
<p>query faceting (ie dynamic categorization of the query results by price,
brand etc)</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="ogm-configuration"><a class="anchor" href="#ogm-configuration"></a>4. Configure and start Hibernate OGM</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Hibernate OGM favors ease of use and convention over configuration.
This makes its configuration quite simple by default.</p>
</div>
<div class="sect2">
<h3 id="_bootstrapping_hibernate_ogm"><a class="anchor" href="#_bootstrapping_hibernate_ogm"></a>4.1. Bootstrapping Hibernate OGM</h3>
<div class="paragraph">
<p>Hibernate OGM can be used via the Hibernate native APIs (<code>Session</code>)
or via the JPA APIs (<code>EntityManager</code>).
Depending on your choice, the bootstrapping strategy is slightly different.</p>
</div>
<div class="sect3">
<h4 id="_using_jpa"><a class="anchor" href="#_using_jpa"></a>4.1.1. Using JPA</h4>
<div class="paragraph">
<p>If you use JPA as your primary API, the configuration is extremely simple.
Hibernate OGM is seen as a persistence provider
which you need to configure in your <code class="filename">persistence.xml</code>.
That&#8217;s it!
The provider name is <code>org.hibernate.ogm.jpa.HibernateOgmPersistence</code>.</p>
</div>
<div class="exampleblock">
<div class="title">Example 1. persistence.xml file</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-XML" data-lang="XML">&lt;?xml version="1.0"?&gt;
&lt;persistence xmlns="http://java.sun.com/xml/ns/persistence"
             xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
             xsi:schemaLocation="http://java.sun.com/xml/ns/persistence http://java.sun.com/xml/ns/persistence/persistence_2_0.xsd"
             version="2.0"&gt;

    &lt;persistence-unit name="org.hibernate.ogm.tutorial.jpa" transaction-type="JTA"&gt;
        &lt;!-- Use Hibernate OGM provider: configuration will be transparent --&gt;
        &lt;provider&gt;org.hibernate.ogm.jpa.HibernateOgmPersistence&lt;/provider&gt;
        &lt;properties&gt;
            &lt;property name="hibernate.transaction.jta.platform"
                      value="JBossTS" /&gt;
            &lt;property name="hibernate.ogm.datastore.provider"
                      value="infinispan_embedded" /&gt;
        &lt;/properties&gt;
    &lt;/persistence-unit&gt;
&lt;/persistence&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>There are a couple of things to notice:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>there is no JDBC dialect setting</p>
</li>
<li>
<p>there is no JDBC setting except sometimes a <code>jta-data-source</code>
(check <a href="#ogm-configuration-environments-javaee">In a Java EE container</a> for more info)</p>
</li>
<li>
<p>most NoSQL databases do not require a schema, in which case schema generation options (<code>hbm2ddl</code>)
do not apply</p>
</li>
<li>
<p>if you use JTA (which we recommend), you will need to set the JTA platform</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You also need to configure which NoSQL datastore you want to use
and how to connect to it.
We will detail how to do that later in <a href="#ogm-datastore-providers">NoSQL datastores</a>.</p>
</div>
<div class="paragraph">
<p>In this case, we have used the default settings for Infinispan:
this will start a local, in-memory Infinispan instance which is useful for testing
but the stored data will be lost on shutdown.
You might think of this configuration as similar to storing your data in an hashmap,
but you could of course change the Infinispan configuration to enable clustering
(for both scalability and failover) and to enable permanent persistence strategies.</p>
</div>
<div class="paragraph">
<p>From there, simply bootstrap JPA the way you are used to with Hibernate ORM:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>via <code>Persistence.createEntityManagerFactory</code></p>
</li>
<li>
<p>by injecting the <code>EntityManager</code> / <code>EntityManagerFactory</code> in a Java EE container</p>
</li>
<li>
<p>by using your favorite injection framework (CDI - Weld, Spring, Guice)</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Note that what you&#8217;re starting is not an exotic new JPA implementation but is in all effects
an instance of Hibernate ORM, although using some alternative internal components to deal
with the NoSQL stores.
This means that any framework and tool integrating with Hibernate ORM can integrate with
Hibernate OGM - of course as long as it&#8217;s not making assumptions such as that a JDBC
datasource will be used.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_using_hibernate_orm_native_apis"><a class="anchor" href="#_using_hibernate_orm_native_apis"></a>4.1.2. Using Hibernate ORM native APIs</h4>
<div class="paragraph">
<p>If you want to bootstrap Hibernate OGM using the native Hibernate APIs,
use the new bootstrap API from Hibernate ORM 5.
By setting <code>OgmProperties.ENABLED</code> to true, the Hibernate OGM components will be activated.
Note that unwrapping into <code>OgmSessionFactoryBuilder</code> is not strictly needed,
but it will allow you to set Hibernate OGM specific options in the future and also gives you a reference
to <code>OgmSessionFactory</code> instead of <code>SessionFactory</code>.</p>
</div>
<div class="exampleblock">
<div class="title">Example 2. Bootstrap Hibernate OGM with Hibernate ORM native APIs</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">StandardServiceRegistry registry = new StandardServiceRegistryBuilder()
    .applySetting( OgmProperties.ENABLED, true )
    //assuming you are using JTA in a non container environment
    .applySetting( AvailableSettings.TRANSACTION_COORDINATOR_STRATEGY, "jta" )
    //assuming JBoss TransactionManager in standalone mode
    .applySetting( AvailableSettings.JTA_PLATFORM, "JBossTS" )
    //assuming Infinispan as the backend, using the default settings
    .applySetting( OgmProperties.DATASTORE_PROVIDER, InfinispanEmbedded.DATASTORE_PROVIDER_NAME );
    .build();

//build the SessionFactory
OgmSessionFactory sessionFactory = new MetadataSources( registry )
    .addAnnotatedClass( Order.class )
    .addAnnotatedClass( Item.class )
    .buildMetadata()
    .getSessionFactoryBuilder()
    .unwrap( OgmSessionFactoryBuilder.class )
    .build();</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>There are a couple of things to notice:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>there is no DDL schema generation options (<code>hbm2ddl</code>)
as Infinispan does not require schemas when running in embedded mode</p>
</li>
<li>
<p>you need to set the right transaction strategy
and the right transaction manager lookup strategy
if you use a JTA based transaction strategy
(see <a href="#ogm-configuration-environments">Environments</a>)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You also need to configure which NoSQL datastore you want to use
and how to connect to it.
We will detail how to do that later in <a href="#ogm-datastore-providers">NoSQL datastores</a>.
In this case, we have used the defaults settings for Infinispan.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="ogm-configuration-environments"><a class="anchor" href="#ogm-configuration-environments"></a>4.2. Environments</h3>
<div class="paragraph">
<p>Hibernate OGM runs in various environments: it should work pretty much in all environments in which Hibernate ORM runs.
There are however some selected environments in which it was tested more thoroughly than others.
The current version is being tested regularly in Java SE (without a container) and within the WildFly 14.0 application server;
at time of writing this there&#8217;s no known reason for it to not work in different containers as long as you remember that it requires a
specific version of Hibernate ORM: some containers might package a conflicting version.</p>
</div>
<div class="sect3">
<h4 id="ogm-configuration-environments-javaee"><a class="anchor" href="#ogm-configuration-environments-javaee"></a>4.2.1. In a Java EE container</h4>
<div class="paragraph">
<p>You don&#8217;t have to do much in this case. You need three specific settings:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the transaction coordinator type</p>
</li>
<li>
<p>the JTA platform</p>
</li>
<li>
<p>a JTA datasource</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If you use JPA, simply set the <code>transaction-type</code> to <code>JTA</code>
and the transaction factory will be set for you.</p>
</div>
<div class="paragraph">
<p>If you use Hibernate ORM native APIs only,
then set <code>hibernate.transaction.coordinator_class</code> to "jta".</p>
</div>
<div class="paragraph">
<p>Set the JTA platform to the right Java EE container.
The property is <code>hibernate.transaction.jta.platform</code>
and must contain the fully qualified class name of the lookup implementation.
The list of available values are listed in
<a href="https://docs.jboss.org/hibernate/orm/5.3/userguide/html_single/Hibernate_User_Guide.html#transactions-physical-jtaplatform">Hibernate ORM&#8217;s configuration section</a>.
For example in WildFly 14.0 you would pick <code>JBossAS</code>, although in WildFly these settings are automatically injected so you could skip this.</p>
</div>
<div class="paragraph">
<p>In your <code class="filename">persistence.xml</code> you usually need to define an existing datasource.
This is not needed by Hibernate OGM: it will ignore the datasource, but JPA specification mandates the setting.</p>
</div>
<div class="exampleblock">
<div class="title">Example 3. persistence.xml file</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-XML" data-lang="XML">&lt;?xml version="1.0"?&gt;
&lt;persistence xmlns="http://java.sun.com/xml/ns/persistence"
             xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
             xsi:schemaLocation="http://java.sun.com/xml/ns/persistence http://java.sun.com/xml/ns/persistence/persistence_2_0.xsd"
             version="2.0"&gt;

    &lt;persistence-unit name="org.hibernate.ogm.tutorial.jpa" transaction-type="JTA"&gt;
        &lt;!-- Use Hibernate OGM provider: configuration will be transparent --&gt;
        &lt;provider&gt;org.hibernate.ogm.jpa.HibernateOgmPersistence&lt;/provider&gt;
        &lt;jta-data-source&gt;java:/DefaultDS&lt;/jta-data-source&gt;
        &lt;properties&gt;
            &lt;property name="hibernate.transaction.jta.platform" value="JBossAS" /&gt;
            &lt;property name="hibernate.ogm.datastore.provider" value="infinispan_embedded" /&gt;
        &lt;/properties&gt;
    &lt;/persistence-unit&gt;
&lt;/persistence&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p><code>java:DefaultDS</code> will work for out of the box WildFly deployments.</p>
</div>
</div>
<div class="sect3">
<h4 id="ogm-configuration-environments-standalonejta"><a class="anchor" href="#ogm-configuration-environments-standalonejta"></a>4.2.2. In a standalone JTA environment</h4>
<div class="paragraph">
<p>There is a set of common misconceptions in the Java community about JTA:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>JTA is hard to use</p>
</li>
<li>
<p>JTA is only needed when you need transactions spanning several databases</p>
</li>
<li>
<p>JTA works in Java EE only</p>
</li>
<li>
<p>JTA is slower than "simple" transactions</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>None of these are true: let me show you how to use the Narayana Transactions Manager in a standalone environment with Hibernate OGM.</p>
</div>
<div class="paragraph">
<p>In Hibernate OGM, make sure to set the following properties:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>transaction-type</code> to <code>JTA</code> in your persistence.xml if you use JPA</p>
</li>
<li>
<p>or <code>hibernate.transaction.coordinator_class</code> to "jta"
if you use <code>StandardServiceRegistryBuilder</code>/<code>OgmConfiguration</code> to bootstrap Hibernate OGM.</p>
</li>
<li>
<p><code>hibernate.transaction.jta.platform</code> to <code>JBossTS</code> in both cases.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Add the Narayana Transactions Manager to your classpath.
If you use maven, it should look like this:</p>
</div>
<div class="exampleblock">
<div class="title">Example 4. Narayana Transactions Manager dependency declaration</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-XML" data-lang="XML">&lt;dependency&gt;
    &lt;groupId&gt;org.jboss.narayana.jta&lt;/groupId&gt;
    &lt;artifactId&gt;narayana-jta&lt;/artifactId&gt;
    &lt;version&gt;5.5.30.Final&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The next step is you get access to the transaction manager.
The easiest solution is to do as the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">TransactionManager transactionManager =
   com.arjuna.ats.jta.TransactionManager.transactionmanager();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then use the standard JTA APIs to demarcate your transaction and you are done!</p>
</div>
<div class="exampleblock">
<div class="title">Example 5. Demarcate your transaction with standalone JTA</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">//note that you must start the transaction before creating the EntityManager
//or else call entityManager.joinTransaction()
transactionManager.begin();

final EntityManager em = emf.createEntityManager();

Poem poem = new Poem();
poem.setName("L'albatros");
em.persist(poem);

transactionManager.commit();

em.clear();

transactionManager.begin();

poem = em.find(Poem.class, poem.getId());
assertThat(poem).isNotNull();
assertThat(poem.getName()).isEqualTo("L'albatros");
em.remove(poem );

transactionManager.commit();

em.close();</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>That was not too hard, was it?
Note that application frameworks like the Spring Framework should be able to initialize the transaction manager
and call it to demarcate transactions for you.
Check their respective documentation.</p>
</div>
</div>
<div class="sect3">
<h4 id="_without_jta"><a class="anchor" href="#_without_jta"></a>4.2.3. Without JTA</h4>
<div class="paragraph">
<p>While this approach works today, it does not ensure that operations are done transactionally
and hence won&#8217;t be able to rollback your work.
This will change in the future but in the mean time,
such an environment is not recommended.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>For NoSQL datastores not supporting transactions, this is less of a concern.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="ogm-configuration-optionsogm-configuration-options"><a class="anchor" href="#ogm-configuration-optionsogm-configuration-options"></a>4.3. Configuration options</h3>
<div class="paragraph">
<p>The most important options when configuring Hibernate OGM are related to the datastore.
They are explained in <a href="#ogm-datastore-providers">NoSQL datastores</a>.</p>
</div>
<div class="paragraph">
<p>Otherwise, most options from Hibernate ORM and Hibernate Search are applicable
when using Hibernate OGM.
You can pass them as you are used to do
either in your <code class="filename">persistence.xml</code> file, your <code class="filename">hibernate.cfg.xml</code> file
or programmatically.</p>
</div>
<div class="paragraph">
<p>More interesting is a list of options that do <em>not</em> apply to Hibernate OGM
and that should not be set:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>hibernate.dialect</code></p>
</li>
<li>
<p><code>hibernate.connection.*</code> and in particular <code>hibernate.connection.provider_class</code></p>
</li>
<li>
<p><code>hibernate.show_sql</code> and <code>hibernate.format_sql</code></p>
</li>
<li>
<p><code>hibernate.default_schema</code> and <code>hibernate.default_catalog</code></p>
</li>
<li>
<p><code>hibernate.use_sql_comments</code></p>
</li>
<li>
<p><code>hibernate.jdbc.*</code></p>
</li>
<li>
<p><code>hibernate.hbm2ddl.auto</code> and <code>hibernate.hbm2ddl.import_file</code></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_configuring_hibernate_search"><a class="anchor" href="#_configuring_hibernate_search"></a>4.4. Configuring Hibernate Search</h3>
<div class="paragraph">
<p>Hibernate Search integrates with Hibernate OGM just like it does with Hibernate ORM.
The Hibernate Search version tested is 5.10.4.Final.
Add the dependency to your project - the group id is <code>org.hibernate</code> and artifact id <code>hibernate-search-orm</code>.</p>
</div>
<div class="paragraph">
<p>Then configure where you want to store your indexes,
map your entities with the relevant index annotations and you are good to go.
For more information, simply check the
<a href="https://docs.jboss.org/hibernate/search/5.10/reference/en-US/html_single/">Hibernate Search reference documentation</a>.</p>
</div>
<div class="paragraph">
<p>In <a href="#ogm-infinispan-indexstorage">Storing a Lucene index in Infinispan</a> we&#8217;ll discuss how to store your Lucene indexes in Infinispan.
This is useful even if you don&#8217;t plan to use Infinispan as your primary data store.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Hibernate OGM requires Hibernate Search on the classpath only when you need to run JPQL or HQL
queries with some datastores. This is because some datastores don&#8217;t have a query language or
we don&#8217;t support it yet. In this situation you need to index the entities that you want to query
and Hibernate OGM will convert the queries in Lucene queries. Check the paragraph related
to the datastore of your choice to see if it requires Hibernate Search or not.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="ogm-configuration-jbossmodule"><a class="anchor" href="#ogm-configuration-jbossmodule"></a>4.5. How to package Hibernate OGM applications for WildFly 14.0</h3>
<div class="paragraph">
<p>Provided you&#8217;re deploying on WildFly,
there is an additional way to add the OGM dependencies to your application.</p>
</div>
<div class="paragraph">
<p>In WildFly, class loading is based on modules; this system defines explicit, non-transitive dependencies on other modules.</p>
</div>
<div class="paragraph">
<p>Modules allow to share the same artifacts across multiple applications,
making deployments smaller and quicker, and also making it possible to deploy multiple different versions of any library.</p>
</div>
<div class="paragraph">
<p>More details about modules are described in
<a href="https://docs.jboss.org/author/display/WFLY10/Class+Loading+in+WildFly">Class Loading in WildFly</a>.</p>
</div>
<div class="paragraph">
<p>When deploying a JPA application on WildFly, you should be aware that there are some additional useful configuration properties defined by the WildFly JPA subsystem.
These are documented in <a href="https://docs.jboss.org/author/display/WFLY10/JPA+Reference+Guide">WildFly JPA Reference Guide</a>.</p>
</div>
<div class="paragraph">
<p>If you apply the following instructions you can create small and efficient deployments which do not include any dependency,
as you can include your favourite version of Hibernate OGM directly to the collection of container provided libraries.</p>
</div>
<div class="sect3">
<h4 id="_packaging_hibernate_ogm_applications_for_wildfly_14_0"><a class="anchor" href="#_packaging_hibernate_ogm_applications_for_wildfly_14_0"></a>4.5.1. Packaging Hibernate OGM applications for WildFly 14.0</h4>
<div class="paragraph">
<p>When using WildFly several of the technologies it includes are automatically enabled.
For example Hibernate ORM is made available to your applications if your <code>persistence.xml</code>
defines a persistence unit using Hibernate as persistence provider
(or is not specifying any provider, as Hibernate is the default one).</p>
</div>
<div class="paragraph">
<p>Similarly, Hibernate Search is automatically activated and made available on the user&#8217;s application
classpath if and when the application server detects the need for it.
This is the default behaviour, but you are in control and can override this all;
see the <a href="https://docs.jboss.org/author/display/WFLY10/JPA+Reference+Guide">WildFly JPA Reference Guide</a>
for a full list of properties you can explicitly set.</p>
</div>
<div class="paragraph">
<p>WildFly 14.0 however does not include Hibernate OGM and it will require some configuration to make everything works.</p>
</div>
<div class="paragraph">
<p>Hibernate OGM 5.4.1.Final requires Hibernate ORM 5.3.6.Final and Hibernate Search 5.10.4.Final.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Unlike other versions, WildFly 14.0 includes the compatible versions of Hibernate ORM and Hibernate Search.
So that, it will no longer necessary to install extra Hibrnate Search modules.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="_server_provisioning_via_maven"><a class="anchor" href="#_server_provisioning_via_maven"></a>Server provisioning via Maven</h5>
<div class="paragraph">
<p>Maven users can use the <code>wildfly-server-provisioning-maven-plugin</code>
to create a custom WildFly server including the Hibernate OGM modules:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-XML" data-lang="XML">&lt;plugins&gt;
    &lt;plugin&gt;
        &lt;groupId&gt;org.wildfly.build&lt;/groupId&gt;
        &lt;artifactId&gt;wildfly-server-provisioning-maven-plugin&lt;/artifactId&gt;
        &lt;version&gt;1.2.10.Final&lt;/version&gt;
        &lt;executions&gt;
            &lt;execution&gt;
            &lt;id&gt;server-provisioning&lt;/id&gt;
            &lt;goals&gt;
                &lt;goal&gt;build&lt;/goal&gt;
            &lt;/goals&gt;
            &lt;phase&gt;compile&lt;/phase&gt;
            &lt;configuration&gt;
                &lt;config-file&gt;server-provisioning.xml&lt;/config-file&gt;
                &lt;server-name&gt;wildfly-with-hibernate-ogm&lt;/server-name&gt;
            &lt;/configuration&gt;
            &lt;/execution&gt;
        &lt;/executions&gt;
    &lt;/plugin&gt;
&lt;/plugins&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>You will also need a <code>server-provisioning.xml</code> in the root of your project:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-XML" data-lang="XML">&lt;server-provisioning xmlns="urn:wildfly:server-provisioning:1.1"&gt;
    &lt;feature-packs&gt;

        &lt;feature-pack
            groupId="org.hibernate.ogm"
            artifactId="hibernate-ogm-featurepack-infinispan-remote"
            version="5.4.1.Final" /&gt; <i class="conum" data-value="1"></i><b>(1)</b>

        &lt;feature-pack
            groupId="org.hibernate.ogm"
            artifactId="hibernate-ogm-featurepack-infinispan-embedded"
            version="5.4.1.Final" /&gt; <i class="conum" data-value="1"></i><b>(1)</b>

        &lt;feature-pack
            groupId="org.hibernate.ogm"
            artifactId="hibernate-ogm-featurepack-mongodb"
            version="5.4.1.Final" /&gt; <i class="conum" data-value="1"></i><b>(1)</b>

        &lt;feature-pack
            groupId="org.hibernate.ogm"
            artifactId="hibernate-ogm-featurepack-neo4j"
            version="5.4.1.Final" /&gt; <i class="conum" data-value="1"></i><b>(1)</b>

    &lt;/feature-packs&gt;
&lt;/server-provisioning&gt;</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Add one or more Hibernate OGM feature packs, it depends on which dialects your application needs.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>See <a href="#hibernate-ogm-jboss-modules-feature-packs">list of available Hibernate OGM feature packs</a>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Once you have the archives, you need to
unpack them into the <code>modules</code> folder of your WildFly 14.0 installation.
The modules included are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>org.hibernate.ogm</em>, the core Hibernate OGM library.</p>
</li>
<li>
<p><em>org.hibernate.ogm.&lt;%DATASTORE%&gt;</em>, one module for each datastore, with <em>&lt;%DATASTORE%&gt;</em> being one of <em>infinispan</em>, <em>mongodb</em> etc.</p>
</li>
<li>
<p><em>org.hibernate.orm</em>, the Hibernate ORM libraries.</p>
</li>
<li>
<p>Several shared dependencies such as <em>org.hibernate.hql:&lt;%VERSION%&gt;</em> (containing the query parser) and others</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The module slot to use for Hibernate OGM 5.4.1.Final is <code>5.4</code>
as the format of the slot name does not include the "micro" part of the project version.</p>
</div>
<div class="paragraph">
<p>Now that WildFly is ready, you can include the dependencies in your application in two ways:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Include dependencies using the manifest</dt>
<dd>
<p>Add this entry to the MANIFEST.MF in your archive (replace <em>&lt;%DATASTORE%&gt;</em> with the right value for your chosen datastore):</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code>Dependencies: org.hibernate.ogm:5.4 services, org.hibernate.ogm.&lt;%DATASTORE%&gt;:5.4 services</code></pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Include dependencies using jboss-deployment-structure.xml</dt>
<dd>
<p>This is a JBoss-specific descriptor.
Add a <code>WEB-INF/jboss-deployment-structure.xml</code> in your archive with the following content (replace <em>&lt;%DATASTORE%&gt;</em> with the right value for your chosen datastore):</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-XML" data-lang="XML">&lt;jboss-deployment-structure&gt;
    &lt;deployment&gt;
        &lt;dependencies&gt;
            &lt;module name="org.hibernate.ogm" slot="5.4" services="export" /&gt;
            &lt;module name="org.hibernate.ogm.&lt;%DATASTORE%&gt;" slot="5.4" services="export" /&gt;
        &lt;/dependencies&gt;
    &lt;/deployment&gt;
&lt;/jboss-deployment-structure&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>More information about the descriptor can be found in the
<a href="https://docs.jboss.org/author/display/WFLY10/Class+Loading+in+WildFly">WildFly documentation</a>.</p>
</div>
<div class="paragraph">
<p>More information about Maven Wildfly provisioning plugin can be found in the
<a href="https://github.com/wildfly/wildfly-build-tools">WildFly provisioning build tools</a>.</p>
</div>
<div class="paragraph">
<p>If you are not using Maven in your project, there is also a Gradle plugin
<a href="https://plugins.gradle.org/plugin/org.wildfly.build.provision">org.wildfly.build.provision</a>
available on the official portal.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="hibernate-ogm-jboss-modules-feature-packs"><a class="anchor" href="#hibernate-ogm-jboss-modules-feature-packs"></a>4.5.2. List of the Hibernate OGM WildFly/JBoss feature packs</h4>
<div class="sect4">
<h5 id="_core_feature_pack"><a class="anchor" href="#_core_feature_pack"></a>Core feature pack</h5>
<div class="paragraph">
<p>It contains the core of Hibernate OGM and all the dialects feature packs extend it.</p>
</div>
<div class="paragraph">
<p>It extends the base WildFly feature pack distribution.
It includes Hibernate ORM 5.3.6.Final modules, required by Hibernate OGM 5.4.1.Final.</p>
</div>
<div class="paragraph">
<p>The feature pack is published on the JBoss Nexus repository and Maven Central as
<a href="https://repository.jboss.org/nexus/index.html#nexus-search;gav~org.hibernate.ogm~hibernate-ogm-featurepack-core~{hibernate-ogm-version}~~">org.hibernate.ogm:hibernate-ogm-featurepack-core:5.4.1.Final:zip</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="_infinispan_remote_feature_pack"><a class="anchor" href="#_infinispan_remote_feature_pack"></a>Infinispan Remote feature pack</h5>
<div class="paragraph">
<p>This is the Infinispan Remote dialect feature pack.
It includes the main module:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>org.hibernate.ogm.infinispan-remote</em>, containing Hibernate OGM Infinispan Remote module</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>It includes Hibernate OGM core feature pack and Infinispan client Wildfly modules.
The feature pack is published on the JBoss Nexus repository and Maven Central as
<a href="https://repository.jboss.org/nexus/index.html#nexus-search;gav~org.hibernate.ogm~hibernate-ogm-featurepack-infinispan-remote~{hibernate-ogm-version}~~">org.hibernate.ogm:hibernate-ogm-featurepack-infinispan-remote:5.4.1.Final:zip</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="_infinispan_embedded_feature_pack"><a class="anchor" href="#_infinispan_embedded_feature_pack"></a>Infinispan Embedded feature pack</h5>
<div class="paragraph">
<p>This is the Infinispan Embedded dialect feature pack.
It includes the main module:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>org.hibernate.ogm.infinispan-embedded</em>, containing Hibernate OGM Infinispan Embedded module</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>It includes Hibernate OGM core feature pack and Infinispan client Wildfly modules.
The feature pack is published on the JBoss Nexus repository and Maven Central as
<a href="https://repository.jboss.org/nexus/index.html#nexus-search;gav~org.hibernate.ogm~hibernate-ogm-featurepack-infinispan-embedded~{hibernate-ogm-version}~~">org.hibernate.ogm:hibernate-ogm-featurepack-infinispan-embedded:5.4.1.Final:zip</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="_mongodb_feature_pack"><a class="anchor" href="#_mongodb_feature_pack"></a>MongoDB feature pack</h5>
<div class="paragraph">
<p>This is the MongoDB dialect feature pack.
It includes the main module:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>org.hibernate.ogm.mongodb</em>, containing Hibernate OGM MongoDB module</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>It includes Hibernate OGM core feature pack and MongoDB Java client.
The feature pack is published on the JBoss Nexus repository and Maven Central as
<a href="https://repository.jboss.org/nexus/index.html#nexus-search;gav~org.hibernate.ogm~hibernate-ogm-featurepack-mongodb~{hibernate-ogm-version}~~">org.hibernate.ogm:hibernate-ogm-featurepack-mongodb:5.4.1.Final:zip</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="_neo4j_feature_pack"><a class="anchor" href="#_neo4j_feature_pack"></a>Neo4j feature pack</h5>
<div class="paragraph">
<p>This is the Neo4j dialect feature pack.
It includes the main module:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>org.hibernate.ogm.neo4j</em>, containing Hibernate OGM Neo4j module</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>It includes Hibernate OGM core feature pack and Neo4j client libraries.
The feature pack is published on the JBoss Nexus repository and Maven Central as
<a href="https://repository.jboss.org/nexus/index.html#nexus-search;gav~org.hibernate.ogm~hibernate-ogm-featurepack-neo4j~{hibernate-ogm-version}~~">org.hibernate.ogm:hibernate-ogm-featurepack-neo4j:5.4.1.Final:zip</a>.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_configure_your_persistence_xml_to_use_your_choice_of_persistence_provider"><a class="anchor" href="#_configure_your_persistence_xml_to_use_your_choice_of_persistence_provider"></a>4.5.3. Configure your persistence.xml to use your choice of persistence provider</h4>
<div class="paragraph">
<p>WildFly will by default attempt to guess which Persistence Provider you need by having a look at the <code>provider</code> section of the <code>persistence.xml</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_enable_support_for_ee_8"><a class="anchor" href="#_enable_support_for_ee_8"></a>4.5.4. Enable support for EE 8</h4>
<div class="paragraph">
<p>Hibernate OGM 5.4.1.Final requires <strong>CDI 2.0</strong> and <strong>JPA 2.2</strong>, that belong to <strong>EE 8</strong> specification.
WildFly 13 has support for JavaEE 8.</p>
</div>
<div class="paragraph">
<p>But in order to enable required CDI and JPA versions we need to start the server with <em>ee8.preview.mode</em> Java system property set to <strong>true</strong> :</p>
</div>
<div class="listingblock">
<div class="content">
<pre>-Dee8.preview.mode=true</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_using_the_hibernate_ogm_modules_with_infinispan"><a class="anchor" href="#_using_the_hibernate_ogm_modules_with_infinispan"></a>4.5.5. Using the Hibernate OGM modules with Infinispan</h4>
<div class="paragraph">
<p>The Infinispan project also provides custom modules for WildFly 14.0.
Hibernate OGM modules require these modules if you&#8217;re planning to use the Hibernate OGM / Infinispan combination on WildFly.</p>
</div>
<div class="paragraph">
<p>This release of Hibernate OGM was tested exclusively with Infinispan version 9.4.0.Final;
the Infinispan project generally attempts to maintain the same API and integration points within the same major.minor version,
so a micro version update should be safe but is untested.</p>
</div>
<div class="paragraph">
<p>In case you want to experiment with a more significant version upgrade, you will need to edit the modules of Hibernate OGM:
the module identifiers are hardcoded in the XML files representing the module.</p>
</div>
<div class="paragraph">
<p>Download the Infinispan modules pack for WildFly 14.0 from here:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://repo1.maven.org/maven2/org/infinispan/infinispan-as-embedded-modules/9.4.0.Final/infinispan-as-embedded-modules-9.4.0.Final.zip">Infinispan WildFly modules version 9.4.0.Final from the Maven repository</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Then similarly to what you did with the Hibernate OGM modules zip, unpack this one too in your <code>modules</code> directory within the application server.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you are using the Hibernate OGM Infinispan feature packs, you don&#8217;t have to worry about this. Infinispan client is already included in them.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="integration-with-wildfly-nosql"><a class="anchor" href="#integration-with-wildfly-nosql"></a>4.6. Integration with WildFly NoSQL</h3>
<div class="paragraph">
<p><em>WildFly NoSQL</em> project allows to configure a NoSQL datastore client within a WildFly subsystem.
See <a href="https://github.com/wildfly/wildfly-nosql/tree/master/doc">WildFly NoSQL Documentation</a>.
In a nutshell it provides the analogous concept of a <em>SQL DataSource</em> for a NoSQL datastore.</p>
</div>
<div class="paragraph">
<p>It is possible to configure Hibernate OGM to use the connections provided by WildFly NoSQL,
using a special Hibernate property: <code>hibernate.connection.resource</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>At the time of writing the feature and its property are supported only for <em>MongoDB</em> and <em>Neo4j Bolt</em> clients.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_how_to_use_wildfly_nosql_with_hibernate_ogm"><a class="anchor" href="#_how_to_use_wildfly_nosql_with_hibernate_ogm"></a>4.6.1. How to use WildFly NoSQL with Hibernate OGM</h4>
<div class="paragraph">
<p>A typical Hibernate OGM persistence configuration, without the support of WildFly NoSQL, looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-XML" data-lang="XML">&lt;persistence version="2.1"
             xmlns="http://xmlns.jcp.org/xml/ns/persistence" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
             xsi:schemaLocation="http://xmlns.jcp.org/xml/ns/persistence http://xmlns.jcp.org/xml/ns/persistence/persistence_2_1.xsd"&gt;
  &lt;persistence-unit name="primary" transaction-type="JTA"&gt;
    &lt;provider&gt;org.hibernate.ogm.jpa.HibernateOgmPersistence&lt;/provider&gt;
    &lt;properties&gt;
      &lt;property name="hibernate.ogm.datastore.provider" value="mongodb" /&gt;
      &lt;property name="hibernate.ogm.datastore.create_database" value="true"/&gt;
      &lt;property name="hibernate.ogm.datastore.host" value="localhost:27018"/&gt;
      &lt;property name="hibernate.ogm.datastore.database" value="mongodb"/&gt;
      &lt;property name="hibernate.ogm.mongodb.write_concern" value="JOURNALED"/&gt;
      &lt;property name="hibernate.ogm.mongodb.read_preference" value="NEAREST"/&gt;
    &lt;/properties&gt;
  &lt;/persistence-unit&gt;
&lt;/persistence&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Some configurations, like the hostname, port, name of the database
and other datastore specific properties can be refactored/moved to a WildFly NoSQL subsystem, like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-XML" data-lang="XML">&lt;subsystem xmlns="urn:jboss:domain:mongodb:1.0"&gt;
    &lt;mongo name="default" id="mongodb" jndi-name="java:jboss/mongodb/client" database="mongodb" module="org.hibernate.ogm.mongodb"&gt;
        &lt;host name="default" outbound-socket-binding-ref="mongodb"/&gt;
        &lt;properties name="default"&gt;
            &lt;property name="writeConcern" value="JOURNALED"/&gt;
            &lt;property name="readConcern" value="LOCAL"/&gt;
        &lt;/properties&gt;
    &lt;/mongo&gt;
&lt;/subsystem&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice that here the <strong>jndi-name</strong> attribute defines the String for the external lookup,
it will be used later in this chapter.
While <strong>module</strong> attribute indicates the static module from which to load client driver.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you have provisioned your WildFly with Hibernate OGM featurepack(s),
which is also the recommanded practice if you use WildFly,
module attribute will be <strong>org.hibernate.ogm.mongodb</strong> for MongoDB driver
or <strong>org.hibernate.ogm.neo4j</strong> for Neo4j driver.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Moreover you should have a WildFly socket binding like this one:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-XML" data-lang="XML">&lt;socket-binding-group ...
    &lt;outbound-socket-binding name="mongodb"&gt;
        &lt;remote-destination host="localhost" port="27018"/&gt;
    &lt;/outbound-socket-binding&gt;
&lt;/socket-binding-group&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>At this point you can use the Hibernate property <code>hibernate.connection.resource</code> in your <em>persistence.xml</em>,
to integrate WildFly NoSQL with your Hibernate OGM.</p>
</div>
<div class="paragraph">
<p>In our case we will have:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-XML" data-lang="XML">&lt;persistence version="2.1"
             xmlns="http://xmlns.jcp.org/xml/ns/persistence" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
             xsi:schemaLocation="http://xmlns.jcp.org/xml/ns/persistence http://xmlns.jcp.org/xml/ns/persistence/persistence_2_1.xsd"&gt;
  &lt;persistence-unit name="primary" transaction-type="JTA"&gt;
    &lt;provider&gt;org.hibernate.ogm.jpa.HibernateOgmPersistence&lt;/provider&gt;
    &lt;properties&gt;
      &lt;property name="hibernate.ogm.datastore.provider" value="mongodb" /&gt;
      &lt;property name="hibernate.connection.resource" value="java:jboss/mongodb/client"/&gt;
      &lt;property name="hibernate.ogm.datastore.create_database" value="true"/&gt;
    &lt;/properties&gt;
  &lt;/persistence-unit&gt;
&lt;/persistence&gt;</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="ogm-mapping"><a class="anchor" href="#ogm-mapping"></a>5. Map your entities</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This section mainly describes the specificities of Hibernate OGM mappings.
It&#8217;s not meant to be a comprehensive guide to entity mappings,
the complete guide is
<a href="https://docs.jboss.org/hibernate/orm/5.3/userguide/html_single/Hibernate_User_Guide.html#domain-model">Hibernate ORM&#8217;s documentation</a>:
after all Hibernate OGM <em>is</em> Hibernate ORM.</p>
</div>
<div class="sect2">
<h3 id="_supported_entity_mapping"><a class="anchor" href="#_supported_entity_mapping"></a>5.1. Supported entity mapping</h3>
<div class="paragraph">
<p>Pretty much all entity related constructs should work out of the box in Hibernate OGM.
<code>@Entity</code>, <code>@Table</code>, <code>@Column</code>,
<code>@Enumerated</code>, <code>@Temporal</code>, <code>@Cacheable</code>
and the like will work as expected.
If you want an example,
check out <a href="#ogm-gettingstarted">Getting started with Hibernate OGM</a> or the documentation of Hibernate ORM.
Let&#8217;s concentrate of the features that differ
or are simply not supported by Hibernate OGM.</p>
</div>
<div class="paragraph">
<p>Hibernate OGM supports the following inheritance strategies:
* <code>InheritanceType.TABLE_PER_CLASS</code>
* <code>InheritanceType.SINGLE_TABLE</code></p>
</div>
<div class="paragraph">
<p>If you feel the need to support other strategies,
let us know (see <a href="#ogm-howtocontribute-contribute">How to contribute</a>).</p>
</div>
<div class="paragraph">
<p>JPA annotations refer to tables but the kind of abstraction the database will use depends on the
nature of the NoSQL datastore you are dealing with. For example, in MongoDB a table is mapped as
a document.</p>
</div>
<div class="paragraph">
<p>You can find more details about the way entities are stored in the corresponding
mapping section of the datastore you are using.</p>
</div>
<div class="paragraph">
<p>Secondary tables are not supported by Hibernate OGM at the moment.
If you have needs for this feature, let us know (see <a href="#ogm-howtocontribute-contribute">How to contribute</a>).</p>
</div>
<div class="paragraph">
<p>Queries are partially supported, you will find more information in the <a href="#ogm-query">query chapter</a>.</p>
</div>
<div class="paragraph">
<p>All standard JPA id generators are supported: IDENTITY, SEQUENCE, TABLE and AUTO.
If you need support for additional generators,
let us know (see <a href="#ogm-howtocontribute-contribute">How to contribute</a>).</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Some NoSQL databases can not provide an efficient implementation for IDENTITY or SEQUENCE,
for these cases we recommend you use a UUID based generator.
For example on Infinispan (in embedded mode) using IDENTITY is possible but it will require using cluster
wide coordination to maintain the counters, which is not going to perform very well.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">@Entity
public class Breed {

    @Id @GeneratedValue(generator = "uuid")
    @GenericGenerator(name="uuid", strategy="uuid2")
    public String getId() { return id; }
    public void setId(String id) { this.id = id; }
    private String id;

    public String getName() { return name; }
    public void setName(String name) { this.name = name; }
    private String name;
}</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="ogm-mapping-supported-types"><a class="anchor" href="#ogm-mapping-supported-types"></a>5.2. Supported Types</h3>
<div class="paragraph">
<p>Most Java built-in types are supported at this stage.
However, custom types (<code>@Type</code>) are not supported.</p>
</div>
<div class="paragraph">
<p>Here is a list of supported Java types:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Boolean</p>
</li>
<li>
<p>Byte</p>
</li>
<li>
<p>Byte Array</p>
</li>
<li>
<p>Calendar</p>
</li>
<li>
<p>Class</p>
</li>
<li>
<p>Date</p>
</li>
<li>
<p>Double</p>
</li>
<li>
<p>Integer</p>
</li>
<li>
<p>Long</p>
</li>
<li>
<p>Short</p>
</li>
<li>
<p>Float</p>
</li>
<li>
<p>Character</p>
</li>
<li>
<p>String</p>
</li>
<li>
<p>BigDecimal (mapped as scientific notation)</p>
</li>
<li>
<p>BigInteger</p>
</li>
<li>
<p>Url (as described by RFC 1738 and returned by toString of the Java URL type)</p>
</li>
<li>
<p>UUID stored as described by RFC 4122</p>
</li>
<li>
<p>Enums</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Let us know if you need more type support <a href="#ogm-howtocontribute-contribute">How to contribute</a></p>
</div>
</div>
<div class="sect2">
<h3 id="_supported_association_mapping"><a class="anchor" href="#_supported_association_mapping"></a>5.3. Supported association mapping</h3>
<div class="paragraph">
<p>All association types are supported (<code>@OneToOne</code>,
<code>@OneToMany</code>, <code>@ManyToOne</code>, <code>@ManyToMany</code>).
Likewise, all collection types are supported (<code>Set</code>, <code>Map</code>,
<code>List</code>).
The way Hibernate OGM stores association information is however quite different
than the traditional RDBMS representation.
Each chapter dedicated to a datastore describes how associations are persisted,
make sure to check them out.</p>
</div>
<div class="paragraph">
<p>Not all types of associations can be mapped efficiently on all datastores:
this will depend on the specific capabilities of the NoSQL technology being used.
For example the key/value stores will have all of the association navigation for
a given entity stored in a single key.
If your collection is made of 1 million elements, Hibernate OGM will have to
store 1 million tuples in the association key.
For example the Infinispan Embedded dialect suffers from this limitation as it&#8217;s
treated as a pure key/value store, while the Infinispan Remote dialect does not
as it is more similar to a document store.</p>
</div>
<div class="sect3">
<h4 id="_elements_order_in_associations"><a class="anchor" href="#_elements_order_in_associations"></a>5.3.1. Elements order in associations</h4>
<div class="paragraph">
<p>Hibernate OGM, by default, does not guarantee that elements in an association will
be retrieved in the same order each time you load the association from the datastore.</p>
</div>
<div class="paragraph">
<p>If the order is important, you can enforce it using the following annotations:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>@javax.persistence.OrderColumn</code>: the collection uses a dedicated order column
in the collection link table</p>
</li>
<li>
<p><code>@javax.persistence.OrderBy</code>: the collection is ordered upon retrieval using
a child entity property</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You can find more details and examples in the
<a href="http://docs.jboss.org/hibernate/orm/5.3/userguide/html_single/Hibernate_User_Guide.html#collections-list">Hibernate ORM documentation</a>.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>At the moment, Hibernate OGM doesn&#8217;t support duplicates in an association.
Which means that even if an entity or on embeddable appear in an association twice,
Hibernate OGM will only save or read the element once. This only happens for elements with
the same id.</p>
</div>
<div class="paragraph">
<p>A work-around for this issue is to use the annotation <code>@javax.persistence.OrderColumn</code>.</p>
</div>
<div class="paragraph">
<p>For more details you can check the issues
<a href="https://hibernate.atlassian.net/browse/OGM-1237">OGM-1237</a> or
<a href="https://hibernate.atlassian.net/browse/OGM-1537">OGM-1537</a>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="ogm-api"><a class="anchor" href="#ogm-api"></a>6. Hibernate OGM APIs</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Hibernate OGM has very few specific APIs.
For the most part, you will interact with it via either:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the JPA APIs</p>
</li>
<li>
<p>the native Hibernate ORM APIs</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This chapter will only discuss the Hibernate OGM specific behaviors regarding these APIs.
If you need to learn JPA or the native Hibernate APIs,
check out <a href="http://hibernate.org/orm/documentation/">the Hibernate ORM documentation</a>.</p>
</div>
<div class="sect2">
<h3 id="_bootstrap_hibernate_ogm"><a class="anchor" href="#_bootstrap_hibernate_ogm"></a>6.1. Bootstrap Hibernate OGM</h3>
<div class="paragraph">
<p>We already discussed this subject earlier, have a look at <a href="#ogm-configuration">Configure and start Hibernate OGM</a> for all the details.</p>
</div>
<div class="paragraph">
<p>As a reminder, it basically boils down to either:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>set the right persistence provider in your <code>persistence.xml</code> file
and create an <code>EntityManagerFactory</code> the usual way</p>
</li>
<li>
<p>start via the Hibernate ORM native APIs using <code>StandardServiceRegistryBuilder</code> and <code>MetadataSources</code>
to boot a <code>SessionFactory</code></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_jpa_and_native_hibernate_orm_apis"><a class="anchor" href="#_jpa_and_native_hibernate_orm_apis"></a>6.2. JPA and native Hibernate ORM APIs</h3>
<div class="paragraph">
<p>You know of the Java Persistence and Hibernate ORM native APIs?
You are pretty much good to go.
If you need a refresher, make sure you read the <a href="http://hibernate.org/orm/documentation/">Hibernate ORM documentation</a>.</p>
</div>
<div class="paragraph">
<p>A few things are a bit different though, let&#8217;s discuss them.</p>
</div>
<div class="paragraph">
<p>Most of the <code>EntityManager</code> and <code>Session</code> contracts are supported.
Here are the few exceptions:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>Session.createCriteria</code>: criteria queries are not yet supported in Hibernate OGM</p>
</li>
<li>
<p><code>Session.createFilter</code>: queries on collections are not supported yet</p>
</li>
<li>
<p><code>Session</code> 's <code>enableFilter</code>, <code>disableFilter</code> etc: query filters are not supported at the moment</p>
</li>
<li>
<p><code>doWork</code> and <code>doReturningWork</code> are not implemented as they rely on JDBC connections - see
<a href="https://hibernate.atlassian.net/browse/OGM-694">OGM-694</a></p>
</li>
<li>
<p><code>Session</code> 's stored procedure APIs are not supported</p>
</li>
<li>
<p><code>Session</code> 's natural id APIs are not yet supported</p>
</li>
<li>
<p><code>Session.lock</code> is not fully supported at this time</p>
</li>
<li>
<p><code>EntityManager</code> 's criteria query APIs are not supported</p>
</li>
<li>
<p><code>EntityManager</code> 's stored procedure APIs are not supported - see
<a href="https://hibernate.atlassian.net/browse/OGM-695">OGM-695</a></p>
</li>
<li>
<p><code>EntityManager.lock</code> is not fully supported at this time</p>
</li>
<li>
<p>see <a href="#ogm-query">Query your entities</a> to know what is supported for JPQL and native queries</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_accessing_the_code_ogmsession_code_api"><a class="anchor" href="#_accessing_the_code_ogmsession_code_api"></a>6.2.1. Accessing the <code>OgmSession</code> API</h4>
<div class="paragraph">
<p>To execute NoSQL native queries, one approach is to use <code>OgmSession#createNativeQuery</code>.
You can read more about it in <a href="#ogm-query-native">Using the native query language of your NoSQL</a>.
But let&#8217;s see how to access an <code>OgmSession</code> instance.</p>
</div>
<div class="paragraph">
<p>From JPA, use the <code>unwrap</code> method of <code>EntityManager</code></p>
</div>
<div class="exampleblock">
<div class="title">Example 6. Get to an <code>OgmSession</code> from an <code>EntityManager</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">EntityManager entityManager = ...
OgmSession ogmSession = entityManager.unwrap(OgmSession.class);
NativeQuery query = ogmSession.createNativeQuery(...);</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>In the Hibernate native API case, you should already have access to an <code>OgmSession</code>.
The <code>OgmConfiguration</code> you used returns an <code>OgmSessionFactory</code>.
This factory in turns produces <code>OgmSession</code>.</p>
</div>
<div class="exampleblock">
<div class="title">Example 7. Get to an <code>OgmSession</code> with Hibernate ORM native APIs</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">StandardServiceRegistry registry = new StandardServiceRegistryBuilder()
    .applySetting( OgmProperties.ENABLED, true )
    .build();

OgmSessionFactory ogmSessionFactory = new MetadataSources( registry )
    .buildMetadata()
    .getSessionFactoryBuilder()
    .unwrap( OgmSessionFactoryBuilder.class )
    .build();
OgmSession ogmSession = ogmSessionFactory.openSession();
NativeQuery query = ogmSession.createNativeQuery(...);</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_on_flush_and_transactions"><a class="anchor" href="#_on_flush_and_transactions"></a>6.3. On flush and transactions</h3>
<div class="paragraph">
<p>Even though some underlying NoSQL datastores do not support transaction,
it is important to demarcate transaction via the Hibernate OGM APIs.
Let&#8217;s see why.</p>
</div>
<div class="paragraph">
<p>Hibernate does pile up changes for as long as it can before pushing them down to the datastore.
This opens up the doors to huge optimizations (avoiding duplication, batching operations etc).
You can force changes to be sent to the datastore by calling <code>Session.flush</code> or <code>EntityManager.flush</code>.
In some situations - for example before some queries are executed -, Hibernate will flush automatically.
It will also flush when the transaction demarcation happens (whether there is a real transaction or not).</p>
</div>
<div class="paragraph">
<p>The best approach is to always demarcate the transaction as shown below.
This avoids the needs to manually call flush and will offer future opportunities for Hibernate OGM.</p>
</div>
<div class="exampleblock">
<div class="title">Example 8. Explicitly demarcating transactions</div>
<div class="content">
<div class="paragraph">
<p>Here is how you do outside of a JTA environment.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">Session session = ...

Transaction transaction = session.beginTransaction();
try {
    // do your work
    transaction.commit(); // will flush changes to the datastore
catch (Exception e) {
    transaction.rollback();
}

// or in JPA
EntityManager entityManager = ...
EntityTransaction transaction = entityManager.getTransaction();
try {
    // do your work
    transaction.commit(); // will flush changes to the datastore
}
catch (Exception e) {
    transaction.rollback();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Inside a JTA environment, either the container demarcates the transaction for you
and Hibernate OGM will transparently join that transaction and flush at commit time.
Or you need to manually demarcate the transaction.
In the latter case,
it is best to start / stop the transaction before retrieving the <code>Session</code> or <code>EntityManager</code>
as shown below.
The alternative is to call the <code>EntityManager.joinTransaction()</code> once the transaction has started.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">transactionManager.begin();
Session session = sessionFactory.openSession();
// do your work
transactionManager.commit(); // will flush changes to the datastore

// or in JPA
transactionManager.begin();
EntityManager entityManager = entityManagerFactory.createEntityManager();
// do your work
transactionManager.commit(); // will flush changes to the datastore</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="ogm-api-error-handler"><a class="anchor" href="#ogm-api-error-handler"></a>6.3.1. Acting upon errors during application of changes</h4>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The error compensation API described in the following section is an experimental feature.
It will be enriched with additional features over time.
This might require changes to existing method signatures
and thus may break code using a previous version of the API.</p>
</div>
<div class="paragraph">
<p>Please let us know about your usage of the API and your wishes regarding futher capabilities!</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If an error occurs during flushing a set of changes,
some data changes may already have been applied in the datastore.
If the store is non-transactional, there is no way to rollback (undo) these changes if they
were already flushed.
In this case it is desirable to know which changes have been applied and which ones failed
in order to take appropriate action.</p>
</div>
<div class="paragraph">
<p>Hibernate OGM provides an error compensation API for this purpose.
By implementing the <code>org.hibernate.ogm.failure.ErrorHandler</code> interface, you will be notified if</p>
</div>
<div class="ulist">
<ul>
<li>
<p>an interaction between the Hibernate OGM engine and the grid dialect failed</p>
</li>
<li>
<p>a rollback of the current transaction was triggered</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Use cases for the error compensation API include:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Logging all applied operations</p>
</li>
<li>
<p>Retrying a failed operation e.g. after timeouts</p>
</li>
<li>
<p>Making an attempt to compensate (apply an inverse operation) applied changes</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In its current form the API lays the ground for manually performing these and similar tasks,
but we envision a more automated approach in future versions,
e.g. for automatic retries of failed operations or the automatic application of compensating operations.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s take a look at an example:</p>
</div>
<div class="exampleblock">
<div class="title">Example 9. Custom <code>ErrorHandler</code> implementation</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">public class ExampleErrorHandler extends BaseErrorHandler {

    @Override
    public void onRollback(RollbackContext context) {
        // write all applied operations to a log file
        for ( GridDialectOperation appliedOperation : context.getAppliedGridDialectOperations() ) {
            switch ( appliedOperation.getType() ) {
                case INSERT_TUPLE:
                    EntityKeyMetadata entityKeyMetadata = appliedOperation.as( InsertTuple.class ).getEntityKeyMetadata();
                    Tuple tuple = appliedOperation.as( InsertTuple.class ).getTuple();

                    // write EKM and tuple to log file...
                    break;
                case REMOVE_TUPLE:
                    // ...
                    break;
                case ...
                    // ...
                    break;
            }
        }
    }

    @Override
    public ErrorHandlingStrategy onFailedGridDialectOperation(FailedGridDialectOperationContext context) {
        // Ignore this exception and continue
        if ( context.getException() instanceof TupleAlreadyExistsException ) {
            GridDialectOperation failedOperation = context.getFailedOperation();
            // write to log ...

            return ErrorHandlingStrategy.CONTINUE;
        }
        // But abort on all others
        else {
            return ErrorHandlingStrategy.ABORT;
        }
    }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The <code>onRollback()</code> method - which is called when the transaction is rolled back (either by the user or by the container) - shows how to iterate over all methods applied prior to the rollback, examine their specific type and e.g. write them to a log file.</p>
</div>
<div class="paragraph">
<p>The <code>onFailedGridDialectOperation()</code> method is called for each specific datastore operation failing.
It lets you decide whether to continue ignoring the failure, retry or abort the operation.
If <code>ABORT</code> is returned, the causing exception will be re-thrown, eventually causing the current transaction to be rolled back.
If <code>CONTINUE</code> is returned, that exception will be ignored, causing the current transaction to continue.</p>
</div>
<div class="paragraph">
<p>The decision whether to abort or continue can be based on the specific exception type or on the grid dialect operation which caused the failure.
In the example all exceptions of type <code>TupleAlreadyExistsException</code> are ignored, whereas all other exceptions cause the current flush cycle to be aborted. You also could react to datastore-specific exceptions such as MongoDB&#8217;s <code>MongoTimeoutException</code>, if needed.</p>
</div>
<div class="paragraph">
<p>Note that by extending the provided base class <code>BaseErrorHandler</code> rather than implementing the interface directly,
you only need to implement those callback methods you are actually interested in.
The implementation will also not break if further callback methods are added to the <code>ErrorHandler</code> interface in future releases.</p>
</div>
<div class="paragraph">
<p>Having implemented the error handler, it needs to be registered with Hibernate OGM.
To do so, specify it using the property <code>hibernate.ogm.error_handler</code>,
e.g. as a persistence unit property in <code class="filename">META-INF/persistence.xml</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-XML" data-lang="XML">&lt;property name="hibernate.ogm.error_handler" value="com.example.ExampleErrorHandler"/&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_spis"><a class="anchor" href="#_spis"></a>6.4. SPIs</h3>
<div class="paragraph">
<p>Some of the Hibernate OGM public contracts are geared towards either integrators
or implementors of datastore providers.
They should not be used by a regular application.
These contracts are named SPIs and are in a <code>.spi</code> package.</p>
</div>
<div class="paragraph">
<p>To keep improving Hibernate OGM, we might break these SPIs between versions.
If you plan on writing a datastore, come and talk to us.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Non public contracts are stored within a <code>.impl</code> package.
If you see yourself using one of these classes,
beware that we can break these without notice.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="ogm-query"><a class="anchor" href="#ogm-query"></a>7. Query your entities</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Once your data is in the datastore, it&#8217;s time for some query fun!
With Hibernate OGM, you have a few alternatives that should get you covered:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Use JPQL - only for simple queries for now</p>
</li>
<li>
<p>Use the NoSQL native query mapping the result as managed entities</p>
</li>
<li>
<p>Use Hibernate Search queries - primarily full-text queries</p>
</li>
<li>
<p>Use stored procedures mapping the result as managed entities</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="ogm-jpql-query"><a class="anchor" href="#ogm-jpql-query"></a>7.1. Using JPQL</h3>
<div class="paragraph">
<p>For Hibernate OGM, we developed a brand new JPQL parser
which is already able to convert simple queries into the native underlying datastore query language
(e.g. MongoQL for MongoDB, CypherQL for Neo4J, etc).
This parser can also generate Hibernate Search queries
for datastores that do not support a query language.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>For datastores like Infinispan that require Hibernate Search to execute JPQL queries,
the following preconditions must be met:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>no join, aggregation, or other relational operations are implied</p>
</li>
<li>
<p>the entity involved in the query must be indexed</p>
</li>
<li>
<p>the properties involved in the predicates must be indexed</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Here is an example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">@Entity @Indexed
public class Hypothesis {

    @Id
    public String getId() { return id; }
    public void setId(String id) { this.id = id; }
    private String id;

    @Field(analyze=Analyze.NO)
    public String getDescription() { return description; }
    public void setDescription(String description) { this.description = description; }
    private String description;
}

Query query = session
    .createQuery("from Hypothesis h where h.description = :desc")
    .setParameter("desc", "tomorrow it's going to rain");</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that the <code>description</code> field is marked as not analysed.
This is necessary to support field equality and comparison as defined by JPQL.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can make use of the following JPQL constructs:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>simple comparisons using "&lt;", "&lt;=", "=", "&gt;=" and "&gt;"</p>
</li>
<li>
<p><code>IS NULL</code> and <code>IS NOT NULL</code></p>
</li>
<li>
<p>the boolean operators <code>AND</code>, <code>OR</code>, <code>NOT</code></p>
</li>
<li>
<p><code>LIKE</code>, <code>IN</code> and <code>BETWEEN</code></p>
</li>
<li>
<p><code>ORDER BY</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In particular and of notice, what is not supported is:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>cross entity joins</p>
</li>
<li>
<p>JPQL functions in particular aggregation functions like <code>count</code></p>
</li>
<li>
<p>JPQL update and delete queries</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>That may sound rather limiting for your use cases so bear with us.
This is a hot area we want to improve, please tell us what feature you miss
<a href="#ogm-howtocontribute-contribute">by opening a JIRA or via email</a>.
Also read the next section, you will see other alternatives to implement your queries.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s look at some of the queries you can express in JPQL:</p>
</div>
<div class="exampleblock">
<div class="title">Example 10. Some JPQL queries</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code>// query returning an entity based on a simple predicate
select h from Hypothesis h where id = 16

// projection of the entity property
select id, description from Hypothesis h where id = 16

// projection of the embedded properties
select h.author.address.street from Hypothesis h where h.id = 16

// predicate comparing a property value and a literal
from Hypothesis h where h.position = '2'

// negation
from Hypothesis h where not h.id = '13'
from Hypothesis h where h.position &lt;&gt; 4

// conjunction
from Hypothesis h where h.position = 2 and not h.id = '13'

// named parameters
from Hypothesis h where h.description = :myParam

// range query
from Hypothesis h where h.description BETWEEN :start and :end

// comparisons
from Hypothesis h where h.position &lt; 3

// in
from Hypothesis h where h.position IN (2, 3, 4)

// like
from Hypothesis h where h.description LIKE '%dimensions%'

// comparison with null
from Hypothesis h where h.description IS null

// order by
from Hypothesis h where h.description IS NOT null ORDER BY id
from Helicopter h order by h.make desc, h.name</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>There are also features that are partially supported:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Inner <code>JOIN</code> on an embedded association:
works as expected with Neo4j and MongoDB;
doesn&#8217;t work if your datastore provider implements JPQL queries using Hibernate Search.</p>
</li>
<li>
<p>Projections or filters on properties of an embedded identifier:
works as expected with Neo4j and MongoDB;
doesn&#8217;t work if your datastore provider implements JPQL queries using Hibernate Search.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>These are better illustrated by the following example:</p>
</div>
<div class="exampleblock">
<div class="title">Example 11. Entity with embedded collection and supported JPQL queries</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">@Indexed
@Entity
public class StoryGame {

    @DocumentId
    @EmbeddedId
    @FieldBridge(impl = NewsIdFieldBridge.class)
    private StoryID storyId;

    @ElementCollection
    @IndexedEmbedded
    private List&lt;OptionalStoryBranch&gt; optionalEndings;

    ...

}

@Embeddable
public class StoryID implements Serializable {

    private String title;
    private String author;

    ...
}

@Embeddable
public class OptionalStoryBranch {

    // Analyze.NO for filtering in query
    // Store.YES for projection in query
    @Field(store = Store.YES, analyze = Analyze.NO)
    private String text;

    ...

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Filter the results using the supported operators will work for all the datastores:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">String query =
    "SELECT sg" +
    "FROM StoryGame sg JOIN sg.optionalEndings ending WHERE ending.text = 'Happy ending'"
List&lt;StoryGame&gt; stories = session.createQuery( query ).list();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Projection of properties of an embedded association works with Neo4j and MongoDB,
but the other datastores will only return one element from the association.
This is due to the fact that Hibernate Search is currently not supporting projection
of associations.
Here&#8217;s an example of a query affected by this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">String query =
     "SELECT ending.text " +
     "FROM StoryGame sg JOIN sg.optionalEndings ending WHERE ending.text LIKE 'Happy%'";
List&lt;String&gt; endings = session.createQuery( query ).list();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Projecting and filtering on embedded id properties works with Neo4j and MongoDB
but throws an exception with the other datastores:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">String query =
     "SELECT sg.storyId.title FROM StoryGame sg WHERE sg.storyId.title = 'Best Story Ever'";
List&lt;String&gt; title = session.createQuery( query ).list();</code></pre>
</div>
</div>
<div class="paragraph">
<p>It will cause the following exception if the datastore uses Hibernate Search
to execute JPQL queries:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">org.hibernate.hql.ParsingException: HQL100002: The type [storyId] has no indexed property named title.</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>In order to reflect changes performed in the current session,
all entities affected by a given query are flushed to the datastore prior to query execution
(that’s the case for Hibernate ORM as well as Hibernate OGM).</p>
</div>
<div class="paragraph">
<p>For not fully transactional stores,
this can cause changes to be written as a side-effect of running queries
which cannot be reverted by a possible later rollback.</p>
</div>
<div class="paragraph">
<p>Depending on your specific use cases and requirements you may prefer to disable auto-flushing,
e.g. by invoking <code>query.setFlushMode(FlushMode.MANUAL)</code>.
Bear in mind though that query results will then not reflect changes applied within the current session.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="ogm-query-native"><a class="anchor" href="#ogm-query-native"></a>7.2. Using the native query language of your NoSQL</h3>
<div class="paragraph">
<p>Often you want the raw power of the underlying NoSQL query engine.
Even if that costs you portability.</p>
</div>
<div class="paragraph">
<p>Hibernate OGM addresses that problem by letting you express native queries (e.g. in MongoQL or CypherQL)
and map the result of these queries as mapped entities.</p>
</div>
<div class="paragraph">
<p>In JPA, use <code>EntityManager.createNativeQuery</code>.
The first form accepts a result class if your result set maps the mapping definition of the entity.
The second form accepts the name of a resultSetMapping
and lets you customize how properties are mapped to columns by the query.
You can also used a predefined named query which defines its result set mapping.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s take a look at how it is done for Neo4J:</p>
</div>
<div class="exampleblock">
<div class="title">Example 12. Various ways to create a native query in JPA</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">@Entity
@NamedNativeQuery(
   name = "AthanasiaPoem",
   query = "{ $and: [ { name : 'Athanasia' }, { author : 'Oscar Wilde' } ] }",
   resultClass = Poem.class )
public class Poem {

    @Id
    private Long id;

    private String name;

    private String author;

   // getters, setters ...

}

...

javax.persistence.EntityManager em = ...

// a single result query
String query1 = "MATCH ( n:Poem { name:'Portia', author:'Oscar Wilde' } ) RETURN n";
Poem poem = (Poem) em.createNativeQuery( query1, Poem.class ).getSingleResult();

// query with order by
String query2 = "MATCH ( n:Poem { name:'Portia', author:'Oscar Wilde' } ) " +
                "RETURN n ORDER BY n.name";
List&lt;Poem&gt; poems = em.createNativeQuery( query2, Poem.class ).getResultList();

// query with projections
String query3 = MATCH ( n:Poem ) RETURN n.name, n.author ORDER BY n.name";
List&lt;Object[]&gt; poemNames = (List&lt;Object[]&gt;)em.createNativeQuery( query3 )
                               .getResultList();

// named query
Poem poem = (Poem) em.createNamedQuery( "AthanasiaPoem" ).getSingleResult();</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>In the native Hibernate API, use <code>OgmSession.createNativeQuery</code> or <code>Session.getNamedQuery</code>.
The former form lets you define the result set mapping programmatically.
The latter is receiving the name of a predefined query already describing its result set mapping.</p>
</div>
<div class="exampleblock">
<div class="title">Example 13. Hibernate API defining a result set mapping</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">OgmSession session = ...
String query1 = "{ $and: [ { name : 'Portia' }, { author : 'Oscar Wilde' } ] }";
Poem poem = session.createNativeQuery( query1 )
                      .addEntity( "Poem", Poem.class )
                      .uniqueResult();</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Check out each individual datastore chapter for more info
on the specifics of the native query language mapping.
In particular <a href="#ogm-neo4j-queries-native">Neo4J</a> and <a href="#ogm-mongodb-queries-native">MongoDB</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="ogm-query-using-hibernate-search"><a class="anchor" href="#ogm-query-using-hibernate-search"></a>7.3. Using Hibernate Search</h3>
<div class="paragraph">
<p>Hibernate Search offers a way to index Java objects into Lucene indexes
and to execute full-text queries on them.
The indexes do live outside your datastore.
This offers a few interesting properties in terms of feature set and scalability.</p>
</div>
<div class="paragraph">
<p>Apache Lucene is a full-text indexing and query engine with excellent query performance.
Feature wise, <em>full-text</em> means
you can do much more than a simple equality match.</p>
</div>
<div class="paragraph">
<p>Hibernate Search natively integrates with Hibernate ORM.
And Hibernate OGM of course!</p>
</div>
<div class="exampleblock">
<div class="title">Example 14. Adding Hibernate Search artifact to your project via Maven</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-XML" data-lang="XML">&lt;dependency&gt;
    &lt;groupId&gt;org.hibernate&lt;/groupId&gt;
    &lt;artifactId&gt;hibernate-search-orm&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 15. Using Hibernate Search for full-text matching</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">@Entity @Indexed
public class Hypothesis {

    @Id
    public String getId() { return id; }
    public void setId(String id) { this.id = id; }
    private String id;

    @Field(analyze=Analyze.YES)
    public String getDescription() { return description; }
    public void setDescription(String description) { this.description = description; }
    private String description;
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">EntityManager entityManager = ...
//Add full-text superpowers to any EntityManager:
FullTextEntityManager ftem = Search.getFullTextEntityManager(entityManager);

//Optionally use the QueryBuilder to simplify Query definition:
QueryBuilder b = ftem.getSearchFactory()
   .buildQueryBuilder()
   .forEntity(Hypothesis.class)
   .get();

//Create a Lucene Query:
Query lq = b.keyword().onField("description").matching("tomorrow").createQuery();

//Transform the Lucene Query in a JPA Query:
FullTextQuery ftQuery = ftem.createFullTextQuery(lq, Hypothesis.class);

//List all matching Hypothesis:
List&lt;Hypothesis&gt; resultList = ftQuery.getResultList();</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Assuming our database contains an <code>Hypothesis</code> instance
having description "Sometimes tomorrow we release",
that instance will be returned by our full-text query.</p>
</div>
<div class="paragraph">
<p>Text similarity can be very powerful as it can be configured for specific languages
or domain specific terminology;
it can deal with typos and synonyms,
and above all it can return results by <em>relevance</em>.</p>
</div>
<div class="paragraph">
<p>Worth noting the Lucene index is a vectorial space of term occurrence statistics:
so extracting tags from text, frequencies of strings
and correlate this data makes it very easy to build efficient data analysis applications.</p>
</div>
<div class="paragraph">
<p>While the potential of Lucene queries is very high,
it&#8217;s not suited for all use cases
 Let&#8217;s see some of the limitations of Lucene Queries as our main query engine:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Lucene doesn&#8217;t support Joins.
Any <code>to-One</code> relations can be mapped fine,
and the Lucene community is making progress on other forms,
but restrictions on <code>OneToMany</code> or <code>ManyToMany</code> can&#8217;t be implemented today.</p>
</li>
<li>
<p>Since we apply changes to the index at commit time,
your updates won&#8217;t affect queries until you commit
(we might improve on this).</p>
</li>
<li>
<p>While queries are extremely fast, write operations are not as fast
(but we can make it scale).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For a complete understanding of what Hibernate Search can do for you
and how to use it,
go check the <a href="https://docs.jboss.org/hibernate/search/5.10/reference/en-US/html_single/">Hibernate Search reference documentation</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_using_the_criteria_api"><a class="anchor" href="#_using_the_criteria_api"></a>7.4. Using the Criteria API</h3>
<div class="paragraph">
<p>At this time, we have not implemented support for the Criteria APIs (neither Hibernate native nor JPA).</p>
</div>
</div>
<div class="sect2">
<h3 id="_using_stored_procedures"><a class="anchor" href="#_using_stored_procedures"></a>7.5. Using stored procedures</h3>
<div class="paragraph">
<p>Often you want the raw power of the underlying NoSQL query engine.
Even if that costs you portability.</p>
</div>
<div class="paragraph">
<p>Hibernate OGM addresses that requirement by letting you express stored procedures (e.g. in server-side JavaScript for MongoDB)
and map the result of these queries as mapped entities or return primitive results.</p>
</div>
<div class="paragraph">
<p>In JPA, use <code>EntityManager.createStoredProcedureQuery</code> or <code>EntityManager.createNamedStoredProcedureQuery</code>.
The first form accepts a result class if your result set maps the mapping definition of the entity.
The second form accepts the name of a resultSetMapping
and lets you customize how properties are mapped to columns by the query.
You can also use a predefined named query which defines its result set mapping.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s take a look at how it is done:</p>
</div>
<div class="exampleblock">
<div class="title">Example 16. Various ways to create a stored procedure query in JPA</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">@Entity
@NamedStoredProcedureQueries({
        @NamedStoredProcedureQuery(name = "find_cars_by_brand", procedureName = "resultSetResultProc", parameters = {
                @StoredProcedureParameter(mode = ParameterMode.REF_CURSOR, type = Void.class),
                @StoredProcedureParameter(mode = ParameterMode.IN, type = String.class)
        }, resultSetMappings = "carMapping")
})

@SqlResultSetMapping(name = "carMapping", entities = { @EntityResult(entityClass = Car.class) })
public class Car {

    @Id
    private Long id;

    private String brand;

   // getters, setters ...

}

...

javax.persistence.EntityManager em = ...

StoredProcedureQuery storedProcedureQuery = em.createStoredProcedureQuery( "mostExpensiveCarsPerYear", Car.class );
storedProcedureQuery.registerStoredProcedureParameter( 0, Void.class, ParameterMode.REF_CURSOR );
storedProcedureQuery.registerStoredProcedureParameter( 1, Integer.class, ParameterMode.IN );
storedProcedureQuery.setParameter( 1, 1995 );
List&lt;Car&gt; cars = storedProcedureQuery.getResultList();

// named stored procedure query
StoredProcedureQuery storedProcedureQuery = em.createNamedStoredProcedureQuery( "find_cars_by_brand" );
storedProcedureQuery.setParameter( 1, "Bentley" );
List&lt;Car&gt; cars = storedProcedureQuery.getResultList();</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>You can also use named parameters and <code>StoredProcedureQuery#getSingleResult()</code>.</p>
</div>
<div class="paragraph">
<p>Check out each individual datastore chapter for more info
on the specifics of the native query language mapping.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>'OUT' and 'IN_OUT' parameters of stored procedures are not supported yet.
Main reason of it is supported data storages support 'IN' parameters only.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="ogm-datastore-providers"><a class="anchor" href="#ogm-datastore-providers"></a>8. NoSQL datastores</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Currently Hibernate OGM supports the following NoSQL datastores:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Map: stores data in an in-memory Java map to store data.
Use it only for unit tests.</p>
</li>
<li>
<p>Infinispan Embedded: stores data into <a href="http://infinispan.org/">Infinispan</a> (data grid) participating directly in the cluster</p>
</li>
<li>
<p>Infinispan Remote: (also called Hot Rod, the name of the Infinispan client) stores data into <a href="http://infinispan.org/">Infinispan</a> by connecting as an Hot Rod client</p>
<div class="ulist">
<ul>
<li>
<p>at this stage, this datastore is experimental</p>
</li>
</ul>
</div>
</li>
<li>
<p>Ehcache: stores data into <a href="http://ehcache.org/">Ehcache</a> (cache)</p>
</li>
<li>
<p>MongoDB: stores data into <a href="http://www.mongodb.org/">MongoDB</a> (document store)</p>
</li>
<li>
<p>Neo4j: stores data into <a href="http://www.neo4j.org/">Neo4j</a> (graph database)</p>
</li>
<li>
<p>CouchDB: stores data into <a href="https://couchdb.apache.org/">CouchDB</a> (document store)</p>
<div class="ulist">
<ul>
<li>
<p>at this stage, this datastore is experimental</p>
</li>
</ul>
</div>
</li>
<li>
<p>Redis: stores data into <a href="http://redis.io/">Redis</a> (key-value store)</p>
<div class="ulist">
<ul>
<li>
<p>at this stage, this datastore is experimental</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>More are planned, if you are interested,
come talk to us (see <a href="#ogm-howtocontribute">How to get help and contribute on Hibernate OGM</a>).</p>
</div>
<div class="paragraph">
<p>For each datastore, Hibernate OGM has specific integration code called a datastore provider.
All are in a dedicated maven module, you simply need to depend on the one you use.</p>
</div>
<div class="paragraph">
<p>Hibernate OGM interacts with NoSQL datastores via two contracts:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>a <code>DatastoreProvider</code> which is responsible for
starting and stopping the connection(s) with the datastore
and prop up the datastore if needed</p>
</li>
<li>
<p>a <code>GridDialect</code> which is responsible for
converting an Hibernate OGM operation into a datastore specific operation</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_using_a_specific_nosql_datastore"><a class="anchor" href="#_using_a_specific_nosql_datastore"></a>8.1. Using a specific NoSQL datastore</h3>
<div class="paragraph">
<p>Only a few steps are necessary:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>add the datastore provider module to your classpath</p>
</li>
<li>
<p>ask Hibernate OGM to use that datastore provider</p>
</li>
<li>
<p>configure the URL or configuration to reach the datastore</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Adding the relevant Hibernate OGM module in your classpath looks like this in Maven:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-XML" data-lang="XML">&lt;dependency&gt;
    &lt;groupId&gt;org.hibernate.ogm&lt;/groupId&gt;
    &lt;artifactId&gt;hibernate-ogm-infinispan-embedded&lt;/artifactId&gt;
    &lt;version&gt;5.4.1.Final&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The module names are
<code>hibernate-ogm-infinispan</code>, <code>hibernate-ogm-infinispan-remote</code>, <code>hibernate-ogm-ehcache</code>,
<code>hibernate-ogm-mongodb</code>, <code>hibernate-ogm-neo4j</code>, <code>hibernate-ogm-couchdb</code>, <code>hibernate-ogm-redis</code>
and <code>hibernate-ogm-cassandra</code>.
The map datastore is included in the Hibernate OGM engine module.</p>
</div>
<div class="paragraph">
<p>Next, configure which datastore provider you want to use.
This is done via the <code>hibernate.ogm.datastore.provider</code> option.
Possible values are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>specific shortcuts (preferable): <code>map</code> (only to be used for unit tests),
<code>infinispan_embedded</code>, <code>infinispan_remote</code>, <code>ehcache</code>, <code>mongodb</code>, <code>neo4j_embedded</code>,
<code>neo4j_http</code>, <code>neo4j_bolt</code>.</p>
</li>
<li>
<p>the fully qualified class name of a <code>DatastoreProvider</code> implementation</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>When bootstrapping a session factory or entity manager factory programmatically,
you should use the constants declared on <code>org.hibernate.ogm.cfg.OgmProperties</code> to specify configuration properties
such as <code>hibernate.ogm.datastore.provider</code>.</p>
</div>
<div class="paragraph">
<p>In this case you also can specify the provider in form of a class object of a datastore provider type
or pass an instance of a datastore provider type:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">Map&lt;String, Object&gt; properties = new HashMap&lt;String, Object&gt;();

// pass the type
properties.put( OgmProperties.DATASTORE_PROVIDER, MongoDBDatastoreProvider.class );

EntityManagerFactory emf = Persistence.createEntityManagerFactory( "my-pu", properties );</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>By default, a datastore provider chooses the grid dialect transparently
but you can override this setting with the <code>hibernate.ogm.datastore.grid_dialect</code> option.
Use the fully qualified class name of the <code>GridDialect</code> implementation.
Most users should ignore this setting entirely.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s now look at the specifics of each datastore provider.
How to configure it further, what mapping structure is used and more.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="ogm-infinispan"><a class="anchor" href="#ogm-infinispan"></a>9. Infinispan</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Infinispan is an open source in-memory data grid focusing on high performance.
As a data grid, you can deploy it on multiple servers - referred to as nodes -
and connect to it as if it were a single storage engine:
it will cleverly distribute both the computation effort and the data storage.</p>
</div>
<div class="paragraph">
<p>It is trivial to setup on a single node and Hibernate OGM knows how to boot one,
so you can easily try it out.
But Infinispan really shines in multiple node deployments:
you will need to configure some networking details
but nothing changes in terms of application behaviour,
while performance and data size can scale linearly.</p>
</div>
<div class="paragraph">
<p>From all its features we will only describe those relevant to Hibernate OGM;
for a complete description of all its capabilities and configuration options,
refer to the Infinispan project documentation at
<a href="http://infinispan.org/documentation/">infinispan.org</a>.</p>
</div>
<div class="sect2">
<h3 id="_why_use_hibernate_ogm_with_infinispan"><a class="anchor" href="#_why_use_hibernate_ogm_with_infinispan"></a>9.1. Why use Hibernate OGM with Infinispan?</h3>
<div class="paragraph">
<p>Infinispan provides great scalability and elasticity features but
it can have a steep learning curve.</p>
</div>
<div class="paragraph">
<p>If you are already familiar with the JPA API you will
be able to store your data in Infinispan quickly and you will also benefit
from the optimizations that a framework like Hibernate OGM can
apply under the hood.</p>
</div>
<div class="paragraph">
<p>In particular:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>you can get started without having to learn <code>Protobuf</code> first</p>
</li>
<li>
<p>no need to learn the Infinispan API</p>
</li>
<li>
<p>Hibernate OGM will setup and manage the <code>Hot Rod client</code> for you</p>
</li>
<li>
<p>same API as Hibernate ORM, meaning that you can use the same tools</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You will still need to learn about Infinispan, all its capabilities and how to configure
them to reach your application top performance, but you can get a proof of concept
done quickly with the example configuration.</p>
</div>
</div>
<div class="sect2">
<h3 id="_infinispan_choosing_between_embedded_mode_and_hot_rod"><a class="anchor" href="#_infinispan_choosing_between_embedded_mode_and_hot_rod"></a>9.2. Infinispan: Choosing between Embedded Mode and Hot Rod</h3>
<div class="paragraph">
<p>Java applications can use Infinispan in two fundamentally different ways:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Run Infinispan in <em>Embedded Mode</em>.</p>
</li>
<li>
<p>Connect to an <em>Infinispan Server</em> using an <em>Hot Rod client</em>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Hibernate OGM supports connecting in either mode, but since the APIs and capabilities
are different in the two modes, it provides two different modules
each having its own set of configuration options and features.</p>
</div>
<div class="paragraph">
<p>Running Infinispan in <em>Embedded Mode</em> implies that the Infinispan node is running
in the same JVM as the code using it.
The benefit is that some data (or all data) will be stored on the same JVM, making reads
of this data extremely fast and efficient as there won&#8217;t be RPCs to other systems.
Write operations will still need to issue some coordination RPCs but they also
benefit from a reduction of necessary operations.</p>
</div>
<div class="paragraph">
<p>However the very fact that some data is stored in the same JVM is also the drawback
of this choice: this typically implies having to configure your JVM for larger
heap sizes, which are harder to tune for optimal performance. Other system
parameters might also need to be configured as this JVM node is now to be treated
as a "data holding node" rather than a stateless app node.
Some architects and system administrators will not like that.</p>
</div>
<div class="paragraph">
<p>When connecting to an <em>Infinispan Server</em> over the <em>Hot Rod client</em>, the architecture
is similar to having Hibernate connect to traditional database: the data is stored
on the <em>Infinispan Server</em> nodes, and Hibernate OGM uses a client with a pool of
TCP connections to talk to the server.
But the Hot Rod client is not transactional, see the limitation described here:
(<a href="#storage-principles-of-infinispan-dataprovider">Storage Principles of the Infinispan Remote dataprovider</a>).</p>
</div>
<div class="paragraph">
<p>Another important difference, is that when connecting to <em>Infinispan Server</em> via
<em>Hot Rod</em> the data is encoded using <em>Google Protobuf</em>, which requires a schema.
This schema is auto-generated by Hibernate OGM.</p>
</div>
<div class="paragraph">
<p>Having a <em>Protobuf Schema</em> makes it possible to evolve the schema in non-destructive
ways, and makes it possible for other clients to access the data - even clients written
in other programming languages.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Most introductory tutorials of Hibernate OGM focus on Infinispan in <em>Embedded Mode</em>
because in this mode OGM can start its own embedded Infinispan node, using
a simple, local only Infinispan configuration.</p>
</div>
<div class="paragraph">
<p>When using <em>Infinispan Server</em> instead, you&#8217;ll need to <a href="http://infinispan.org/download/">download
the server distribution</a>, unpack and start it, then set the Hibernate OGM configuration
properties so that the integrated Hot Rod client knows how to connect to it.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph lead">
<p>Advanced performance options &amp; interaction with Hibernate 2nd level caching</p>
</div>
<div class="paragraph">
<p>When using Infinispan in Embedded Mode, and it&#8217;s caches are configured in <code>REPLICATION</code> Mode,
all nodes will contain a full replica of the database: write performance won&#8217;t scale but
your reads will be very fast and scale up linearly with the size of the cluster,
making usage of Hibernate&#8217;s 2nd level cache redundant.</p>
</div>
<div class="paragraph">
<p>When configuring Infinispan in <code>DISTRIBUTED</code> cache mode, each of your nodes will have a
local copy of a slice of your data; remember you can tune how large the section
should be with various Infinispan configuration options (such as <em>numOwners</em>), and you
could combine this with Hibernate&#8217;s 2nd level caching and/or enable Infinispan&#8217;s
1st level caching.</p>
</div>
<div class="paragraph">
<p>You can even combine Infinispan with having it passivate to other storage systems
such as a RDBMs or another NoSQL engine; such storage can be configured to be asynchronous.
This option is available to both Infinispan Embedded and Infinispan Server; it&#8217;s even possible
to use a light layer of Infinispan Embedded - containing a small data set - and have it
backed by an Infinispan Server cluster to expand its storage capabilities without
having to enlarge heap size too much on the embedded, application nodes.</p>
</div>
<div class="paragraph">
<p>Finally, remember that options such as replication vs distribution (<code>CacheMode</code>) and passivation
to additional storage (<code>CacheStore</code>s) can be configured differently for each of Infinispan caches.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="ogm-infinispan-embedded"><a class="anchor" href="#ogm-infinispan-embedded"></a>9.3. Hibernate OGM &amp; Infinispan Embedded</h3>
<div class="paragraph">
<p>Let&#8217;s see how to configure and use Hibernate OGM with Infinispan in Embedded Mode.</p>
</div>
<div class="paragraph">
<p>For usage of Infinispan Server over Hot Rod, skip to <a href="#ogm-infinispan-remote">Hibernate OGM &amp; Infinispan Server over Hot Rod</a>.</p>
</div>
<div class="sect3">
<h4 id="ogm-infinispan-configuration"><a class="anchor" href="#ogm-infinispan-configuration"></a>9.3.1. Configure Hibernate OGM for Infinispan Embedded</h4>
<div class="paragraph">
<p>You configure Hibernate OGM and Infinispan in two steps basically:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Add the dependencies to your classpath</p>
</li>
<li>
<p>And then choose one of:</p>
<div class="ulist">
<ul>
<li>
<p>Use the default Infinispan configuration (no action needed)</p>
</li>
<li>
<p>Point to your own configuration resource file</p>
</li>
<li>
<p>Point to a <code class="acronym">JNDI</code> name of an existing instance of an Infinispan <code>CacheManager</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>If you need to run JPQL or HQL queries, add Hibernate Search on the classpath
(<a href="#ogm-query-using-hibernate-search">Using Hibernate Search</a>)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Note that, except when using <code class="acronym">JNDI</code>, Hibernate OGM will bootstrap Infinispan Embedded
in the same JVM and terminate it on shutdown of the Hibernate OGM session factory.</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Hibernate OGM will start Infinispan Embedded in automatic discovery.
If you are using a clustered configuration, it might automatically join an existing
Infinispan cluster on the network.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="ogm-infinispan-add-dependencies"><a class="anchor" href="#ogm-infinispan-add-dependencies"></a>9.3.2. Adding Infinispan dependencies</h4>
<div class="paragraph">
<p>You can add the Infinispan Embedded dialect to your project using the following Maven GAV:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-XML" data-lang="XML">&lt;dependency&gt;
    &lt;groupId&gt;org.hibernate.ogm&lt;/groupId&gt;
    &lt;artifactId&gt;hibernate-ogm-infinispan-embedded&lt;/artifactId&gt;
    &lt;version&gt;5.4.1.Final&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you&#8217;re not using a dependency management tool,
copy all the dependencies from the distribution in the directories:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>/lib/required</code></p>
</li>
<li>
<p><code>/lib/infinispan</code></p>
</li>
<li>
<p>Optionally - depending on your container - you might need some of the jars from <code>/lib/provided</code></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="ogm-infinispan-configuration-properties"><a class="anchor" href="#ogm-infinispan-configuration-properties"></a>9.3.3. Infinispan specific configuration properties</h4>
<div class="paragraph">
<p>The advanced configuration details of an Infinispan Cache
are defined in an Infinispan specific XML configuration file;
the Hibernate OGM properties are simple
and usually just point to this external resource.</p>
</div>
<div class="paragraph">
<p>To use the default configuration provided by Hibernate OGM -
which is a good starting point for new users - you don&#8217;t have to set any property.</p>
</div>
<div class="dlist">
<div class="title">Hibernate OGM properties for Infinispan dialect</div>
<dl>
<dt class="hdlist1"><code>hibernate.ogm.datastore.provider</code></dt>
<dd>
<p>Set it to <code>infinispan_embedded</code> to use Infinispan as the datastore provider in embedded mode.</p>
</dd>
<dt class="hdlist1"><code>hibernate.ogm.infinispan.cachemanager_jndi_name</code></dt>
<dd>
<p>If you have an Infinispan <code>EmbeddedCacheManager</code> registered in JNDI,
provide the JNDI name and Hibernate OGM will use this instance
instead of starting a new <code>CacheManager</code>.
This will ignore any further configuration properties
as Infinispan is assumed being already configured.
Infinispan can typically be pushed to JNDI via WildFly, Spring or Seam.</p>
</dd>
<dt class="hdlist1"><code>hibernate.ogm.infinispan_remote.configuration_resource_name</code></dt>
<dd>
<p>Should point to the resource name of an Infinispan configuration file.
This is ignored in case <code class="acronym">JNDI</code>  lookup is set.
Defaults to <code>org/hibernate/ogm/datastore/infinispan/default-config.xml</code>.</p>
</dd>
<dt class="hdlist1"><code>hibernate.ogm.datastore.keyvalue.cache_storage</code></dt>
<dd>
<p>The strategy for persisting data in Infinispan.
The following two strategies exist (values of the <code>org.hibernate.ogm.datastore.keyvalue.options.CacheMappingType</code> enum):</p>
<div class="ulist">
<ul>
<li>
<p><code>CACHE_PER_TABLE</code>: A dedicated cache will be used for each entity type, association type and id source table.</p>
</li>
<li>
<p><code>CACHE_PER_KIND</code>: Three caches will be used: one cache for all entities, one cache for all associations and one cache for all id sources.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Defaults to <code>CACHE_PER_TABLE</code>. It is the recommended strategy as it makes it easier to target a specific cache for a given entity.</p>
</div>
</dd>
</dl>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>When bootstrapping a session factory or entity manager factory programmatically,
you should use the constants accessible via <code>org.hibernate.ogm.datastore.infinispan.InfinispanProperties</code>
when specifying the configuration properties listed above.</p>
</div>
<div class="paragraph">
<p>Common properties shared between stores are declared on <code>OgmProperties</code>
(a super interface of <code>InfinispanProperties</code>).</p>
</div>
<div class="paragraph">
<p>For maximum portability between stores, use the most generic interface possible.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_cache_names_used_by_hibernate_ogm"><a class="anchor" href="#_cache_names_used_by_hibernate_ogm"></a>9.3.4. Cache names used by Hibernate OGM</h4>
<div class="paragraph">
<p>Depending on the cache mapping approach, Hibernate OGM will either:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>store each entity type, association type and id source table in a dedicated cache
very much like what Hibernate ORM would do. This is the <code>CACHE_PER_TABLE</code> approach.</p>
</li>
<li>
<p>store data in three different caches when using the <code>CACHE_PER_KIND</code> approach:</p>
<div class="ulist">
<ul>
<li>
<p><code>ENTITIES</code>: is going to be used to store the main attributes of all your entities.</p>
</li>
<li>
<p><code>ASSOCIATIONS</code>: stores the association information representing the links between entities.</p>
</li>
<li>
<p><code>IDENTIFIER_STORE</code>: contains internal metadata that Hibernate OGM needs
to provide sequences and auto-incremental numbers for primary key generation.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>The preferred strategy is <code>CACHE_PER_TABLE</code> as it offers both more fine grained configuration options
and the ability to work on specific entities in a more simple fashion.</p>
</div>
<div class="paragraph">
<p>In the following paragraphs, we will explain which aspects of Infinispan
you&#8217;re likely to want to reconfigure from their defaults.
All attributes and elements from Infinispan which we don&#8217;t mention are safe to ignore.
Refer to the <a href="http://infinispan.org/documentation/">Infinispan User Guide</a>
for the guru level performance tuning and customizations.</p>
</div>
<div class="paragraph">
<p>An Infinispan configuration file is an XML file complying with the Infinispan schema;
the basic structure is shown in the following example:</p>
</div>
<div class="exampleblock">
<div class="title">Example 17. Simple example of an Infinispan configuration file</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-XML" data-lang="XML">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;infinispan
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="urn:infinispan:config:9.1 http://www.infinispan.org/schemas/infinispan-config-9.1.xsd"
    xmlns="urn:infinispan:config:9.1"&gt;

    &lt;cache-container name="HibernateOGM" default-cache="DEFAULT"&gt;

        &lt;!-- Default cache settings --&gt;
        &lt;local-cache name="DEFAULT"&gt;
            &lt;transaction mode="NON_DURABLE_XA" /&gt;
        &lt;/local-cache&gt;

        &lt;local-cache name="User"/&gt;

        &lt;local-cache name="Order"/&gt;

        &lt;local-cache name="associations_User_Order"/&gt;

    &lt;/cache-container&gt;
&lt;/infinispan&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>There are global settings that can be set before the <code>cache_container</code> section.
These settings will affect the whole instance;
mainly of interest for Hibernate OGM users is the <code>jgroups</code> element
in which we will set JGroups configuration overrides.</p>
</div>
<div class="paragraph">
<p>Inside the <code>cache-container</code> section are defined explicit named caches and their configurations
as well as the default cache (named <code>DEFAULT</code> here) if we want to affect all named caches.
This is where we will likely want to configure clustering modes, eviction policies and <code>CacheStore</code>s.</p>
</div>
</div>
<div class="sect3">
<h4 id="ogm-infinispan-storage"><a class="anchor" href="#ogm-infinispan-storage"></a>9.3.5. Manage data size</h4>
<div class="paragraph">
<p>In its default configuration Infinispan stores all data in the heap of the JVM;
in this barebone mode it is conceptually not very different than using a HashMap:
the size of the data should fit in the heap of your VM,
and stopping/killing/crashing your application will get all data lost
with no way to recover it.</p>
</div>
<div class="paragraph">
<p>To store data permanently (out of the JVM memory) a <code>CacheStore</code> should be enabled.
The Infinispan project provides many <code>CacheStore</code> implementations;
a simple one is the <a href="http://infinispan.org/docs/stable/user_guide/user_guide.html#single_file_store">"Single File Store"</a>
which is able to store data in simple binary files, on any read/write mounted filesystem;
You can find many more implementations to store your data in anything
from JDBC connected relational databases, other NoSQL engines such as MongoDB and Cassandra,
or even delegate to other Infinispan clusters.
Finally, implementing a custom <code>CacheStore</code> is quite easy.</p>
</div>
<div class="paragraph">
<p>To limit the memory consumption of the precious heap space,
you can activate a <code>passivation</code> or an <code>eviction</code> policy;
again there are several strategies to play with,
for now let&#8217;s just consider you&#8217;ll likely need one to avoid running out of memory
when storing too many entries in the bounded JVM memory space;
of course you don&#8217;t need to choose one while experimenting with limited data sizes:
enabling such a strategy doesn&#8217;t have any other impact
in the functionality of your Hibernate OGM application
(other than performance: entries stored in the Infinispan in-memory space
is accessed much quicker than from any CacheStore).</p>
</div>
<div class="paragraph">
<p>A <code>CacheStore</code> can be configured as write-through,
committing all changes to the <code>CacheStore</code> before returning (and in the same transaction)
or as write-behind.
A write-behind configuration is normally not encouraged in storage engines,
as a failure of the node implies some data might be lost
without receiving any notification about it,
but this problem is mitigated in Infinispan because of its capability
to combine CacheStore write-behind
with a synchronous replication to other Infinispan nodes.</p>
</div>
<div class="exampleblock">
<div class="title">Example 18. Enabling a FileCacheStore and eviction</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-XML" data-lang="XML">&lt;local-cache name="User"&gt;
    &lt;transaction mode="NON_DURABLE_XA" /&gt;
    &lt;eviction strategy="LIRS" max-entries="2000"/&gt;
    &lt;persistence passivation="true"&gt;
        &lt;file-store
           shared="false"
           path="/var/infinispan/myapp/users"&gt;
            &lt;write-behind flush-lock-timeout="15000" thread-pool-size="5" /&gt;
        &lt;/file-store&gt;
    &lt;/persistence&gt;
&lt;/local-cache&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>In this example we enabled both <code>eviction</code> and a <code>CacheStore</code> (the <code>persistence</code> element).
<code>LIRS</code> is one of the choices we have for eviction strategies.
Here it is configured to keep (approximately) 2000 entries in live memory
and evict the remaining as a memory usage control strategy.</p>
</div>
<div class="paragraph">
<p>The <code>CacheStore</code> is enabling <code>passivation</code>,
which means that the entries which are evicted are stored on the filesystem.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>You could configure an eviction strategy while not configuring a passivating CacheStore!
That is a valid configuration for Infinispan but will have the evictor permanently remove entries.
Hibernate OGM will break in such a configuration.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="ogm-infinispan-clustering"><a class="anchor" href="#ogm-infinispan-clustering"></a>9.3.6. Clustering: store data on multiple Infinispan nodes</h4>
<div class="paragraph">
<p>The best thing about Infinispan is that all nodes are treated equally
and it requires almost no beforehand capacity planning:
to add more nodes to the cluster you just have to start new JVMs,
on the same or different physical servers,
having your same Infinispan configuration and your same application.</p>
</div>
<div class="paragraph">
<p>Infinispan supports several clustering <em>cache modes</em>;
each mode provides the same API and functionality
but with different performance, scalability and availability options:</p>
</div>
<div class="dlist">
<div class="title">Infinispan cache modes</div>
<dl>
<dt class="hdlist1">local</dt>
<dd>
<p>Useful for a single VM: networking stack is disabled</p>
</dd>
<dt class="hdlist1">replication</dt>
<dd>
<p>All data is replicated to each node;
each node contains a full copy of all entries.
Consequentially reads are faster but writes don&#8217;t scale as well.
Not suited for very large datasets.</p>
</dd>
<dt class="hdlist1">distribution</dt>
<dd>
<p>Each entry is distributed on multiple nodes for redundancy and failure recovery,
but not to all the nodes.
Provides linear scalability for both write and read operations.
distribution is the default mode.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>To use the <code>replication</code> or <code>distribution</code> cache modes
Infinispan will use JGroups to discover and connect to the other nodes.</p>
</div>
<div class="paragraph">
<p>In the default configuration,
JGroups will attempt to autodetect peer nodes using a multicast socket;
this works out of the box in the most network environments
but will require some extra configuration in cloud environments
(which often block multicast packets) or in case of strict firewalls.
See the <a href="http://www.jgroups.org/manual/html_single/">JGroups reference documentation</a>,
specifically look for <em>Discovery Protocols</em> to customize the detection of peer nodes.</p>
</div>
<div class="paragraph">
<p>Nowadays, the <code class="acronym">JVM</code> defaults to use <code class="acronym">IPv6</code> network stack;
this will work fine with JGroups, but only if you configured <code class="acronym">IPv6</code> correctly.
It is often useful to force the <code class="acronym">JVM</code> to use <code class="acronym">IPv4</code>.</p>
</div>
<div class="paragraph">
<p>It is also important to let JGroups know which networking interface you want to use;
it will bind to one interface by default, but if you have multiple network interfaces
that might not be the one you expect.</p>
</div>
<div class="exampleblock">
<div class="title">Example 19. JVM properties to set for clustering</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code>#192.168.122.1 is an example IPv4 address
-Djava.net.preferIPv4Stack=true -Djgroups.bind_addr=192.168.122.1</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>You don&#8217;t need to use <code class="acronym">IPv4</code>: JGroups is compatible with <code class="acronym">IPv6</code>
provided you have routing properly configured and valid addresses assigned.</p>
</div>
<div class="paragraph">
<p>The <code>jgroups.bind_addr</code> needs to match a placeholder name
in your JGroups configuration in case you don&#8217;t use the default one.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The default configuration uses <code>distribution</code> as cache mode
and uses the <code>jgroups-tcp.xml</code> configuration for JGroups,
which is contained in the Infinispan jar
as the default configuration for Infinispan users.
Let&#8217;s see how to reconfigure this:</p>
</div>
<div class="exampleblock">
<div class="title">Example 20. Reconfiguring cache mode and override JGroups configuration</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-XML" data-lang="XML">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;infinispan
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="urn:infinispan:config:9.1 http://www.infinispan.org/schemas/infinispan-config-9.1.xsd"
    xmlns="urn:infinispan:config:9.1"&gt;

    &lt;jgroups&gt;
        &lt;stack-file name="custom-stack" path="my-jgroups-conf.xml" /&gt;
    &lt;/jgroups&gt;

    &lt;cache-container name="HibernateOGM" default-cache="DEFAULT"&gt;
        &lt;transport stack="custom-stack" /&gt;

        &lt;!-- *************************************** --&gt;
        &lt;!--     Default cache used as template      --&gt;
        &lt;!-- *************************************** --&gt;
        &lt;distributed-cache name="DEFAULT" mode="SYNC"&gt;
            &lt;locking striping="false" acquire-timeout="10000"
                concurrency-level="500" write-skew="false" /&gt;
            &lt;transaction mode="NON_DURABLE_XA" /&gt;
            &lt;state-transfer enabled="true" timeout="480000"
                await-initial-transfer="true" /&gt;
        &lt;/distributed-cache&gt;

        &lt;!-- Override the cache mode: --&gt;
        &lt;replicated-cache name="User" mode="SYNC"&gt;
            &lt;locking striping="false" acquire-timeout="10000"
                concurrency-level="500" write-skew="false" /&gt;
            &lt;transaction mode="NON_DURABLE_XA" /&gt;
            &lt;state-transfer enabled="true" timeout="480000"
                await-initial-transfer="true" /&gt;
        &lt;/replicated-cache&gt;

        &lt;distributed-cache name="Order" mode="SYNC"&gt;
            &lt;locking striping="false" acquire-timeout="10000"
                concurrency-level="500" write-skew="false" /&gt;
            &lt;transaction mode="NON_DURABLE_XA" /&gt;
            &lt;state-transfer enabled="true" timeout="480000"
                await-initial-transfer="true" /&gt;
        &lt;/distributed-cache&gt;

        &lt;distributed-cache name="associations_User_Order" mode="SYNC"&gt;
            &lt;locking striping="false" acquire-timeout="10000"
                concurrency-level="500" write-skew="false" /&gt;
            &lt;transaction mode="NON_DURABLE_XA" /&gt;
            &lt;state-transfer enabled="true" timeout="480000"
                await-initial-transfer="true" /&gt;
        &lt;/distributed-cache&gt;

    &lt;/cache-container&gt;

&lt;/infinispan&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>In the example above we specify a custom JGroups configuration file
and set the cache mode for the default cache to <code>distribution</code>;
this is going to be inherited by the <code>Order</code> and the <code>associations_User_Order</code> caches.
But for <code>User</code> we have chosen (for the sake of this example) to use <code>replication</code>.</p>
</div>
<div class="paragraph">
<p>Now that you have clustering configured, start the service on multiple nodes.
Each node will need the same configuration and jars.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>We have just shown how to override the clustering mode
and the networking stack for the sake of completeness, but you don&#8217;t have to!</p>
</div>
<div class="paragraph">
<p>Start with the default configuration and see if that fits you.
You can fine tune these setting when you are closer to going in production.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="ogm-infinispan-transactions"><a class="anchor" href="#ogm-infinispan-transactions"></a>9.3.7. Transactions</h4>
<div class="paragraph">
<p>Infinispan supports transactions and integrates with any standard JTA <code>TransactionManager</code>;
this is a great advantage for JPA users as it allows to experience a <em>similar</em> behaviour
to the one we are used to when we work with RDBMS databases.</p>
</div>
<div class="paragraph">
<p>This capability is now available for both Infinispan Embedded and Hot Rod client users.</p>
</div>
<div class="paragraph">
<p>If you&#8217;re having Hibernate OGM start and manage Infinispan,
you can skip this as it will inject the same <code>TransactionManager</code> instance
which you already have set up in the Hibernate / JPA configuration.</p>
</div>
<div class="paragraph">
<p>If you are providing an already started Infinispan CacheManager instance
by using the <code class="acronym">JNDI</code> lookup approach,
then you have to make sure the CacheManager is using the same <code>TransactionManager</code>
as Hibernate:</p>
</div>
<div class="exampleblock">
<div class="title">Example 21. Configuring a JBoss Standalone TransactionManager lookup in Infinispan configuration</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-XML" data-lang="XML">&lt;default&gt;
   &lt;transaction
      transactionMode="TRANSACTIONAL"
      transactionManagerLookupClass=
    "org.infinispan.transaction.lookup.JBossStandaloneJTAManagerLookup" /&gt;
&lt;/default&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Infinispan Embedded supports different transaction modes like <code>PESSIMISTIC</code> and <code>OPTIMISTIC</code>,
supports <code class="acronym">XA</code> recovery and provides many more configuration options;
see the <a href="http://infinispan.org/documentation/">Infinispan User Guide</a>
for more advanced configuration options.</p>
</div>
</div>
<div class="sect3">
<h4 id="_infinispan_embedded_stored_procedures"><a class="anchor" href="#_infinispan_embedded_stored_procedures"></a>9.3.8. Infinispan Embedded Stored Procedures</h4>
<div class="paragraph">
<p>A stored procedure for Infinispan embedded dialect is just a Java <code>Runnable</code> or <code>Callable</code> class.
The class must be defined on application classpath, then the JPA stored procedure API can be used to execute it.</p>
</div>
<div class="paragraph">
<p>To invoke it there are two ways:
* Using directly the name of class as a procedure name
* Map an arbitrary name to a special cache named <code>___stored_procedures</code>. Each mapping needs an entry with the procedure name as key and full class name as a value.</p>
</div>
<div class="paragraph">
<p>Parameters are filled automatically by Hibernate OGM. At the moment only named parameters are supported.</p>
</div>
</div>
<div class="sect3">
<h4 id="ogm-infinispan-indexstorage"><a class="anchor" href="#ogm-infinispan-indexstorage"></a>9.3.9. Storing a Lucene index in Infinispan</h4>
<div class="paragraph">
<p>Hibernate Search, which can be used for advanced query capabilities (see <a href="#ogm-query">Query your entities</a>),
needs some place to store the indexes for its embedded <code>Apache Lucene</code> engine.</p>
</div>
<div class="paragraph">
<p>A common place to store these indexes is the filesystem
which is the default for Hibernate Search;
however if your goal is to scale your NoSQL engine on multiple nodes
you need to share this index.
Network sharing file systems are a possibility but we don&#8217;t recommended that.
Often the best option is to store the index
in whatever NoSQL database you are using (or a different dedicated one).</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>You might find this section useful even if you don&#8217;t intend to store your data in Infinispan.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The Infinispan project provides an adaptor to plug into Apache Lucene,
so that it writes the indexes in Infinispan and searches data in it.
Since Infinispan can be used as an application cache to other NoSQL storage engines
by using a CacheStore (see <a href="#ogm-infinispan-storage">Manage data size</a>)
you can use this adaptor to store the Lucene indexes
in any NoSQL store supported by Infinispan:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>JDBC databases</p>
</li>
<li>
<p>Cassandra</p>
</li>
<li>
<p>Filesystem (but locked correctly at the Infinispan level)</p>
</li>
<li>
<p>MongoDB</p>
</li>
<li>
<p>HBase</p>
</li>
<li>
<p>LevelDB</p>
</li>
<li>
<p>A secondary (independent) Infinispan grid</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>How to configure it? Here is a simple cheat sheet to get you started with this type of setup:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Add <code>org.infinispan:infinispan-directory-provider:9.4.0.Final</code> to your dependencies</p>
</li>
<li>
<p>set these configuration properties:</p>
<div class="ulist">
<ul>
<li>
<p><code>hibernate.search.default.directory_provider = infinispan</code></p>
</li>
<li>
<p><code>hibernate.search.default.exclusive_index_use = false</code></p>
</li>
<li>
<p><code>hibernate.search.infinispan.configuration_resourcename =</code> [infinispan configuration filename]</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>This configuration is simple and will work fine in most scenarios, but keep in mind that using
'exclusive_index_use' will be neither fast nor scalable.
For high performance, high concurrency or production use please refer to the
<a href="http://infinispan.org/documentation/">Infinispan documentation</a> for more advanced configuration options and tuning.</p>
</div>
<div class="paragraph">
<p>The referenced Infinispan configuration should define a <code>CacheStore</code>
to load/store the index in the NoSQL engine of choice.
It should also define three cache names:</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 1. Infinispan caches used to store indexes</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 50%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Cache name</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Suggested cluster mode</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">LuceneIndexesLocking</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Transfers locking information. Does not need a cache
            store.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">replication</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">LuceneIndexesData</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Contains the bulk of Lucene data. Needs a cache
            store.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">distribution + L1</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">LuceneIndexesMetadata</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Stores metadata on the index segments. Needs a cache
            store.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">replication</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>This configuration is not going to scale well on write operations:
to do that you should read about the master/slave and sharding options in Hibernate Search.
The complete explanation and configuration options can be found in the
<a href="https://docs.jboss.org/hibernate/search/5.10/reference/en-US/html_single/#infinispan-directories">Hibernate Search Reference Guide</a></p>
</div>
<div class="paragraph">
<p>Some NoSQL support storage of Lucene indexes directly,
in which case you might skip the Infinispan Lucene integration
by implementing a custom <code>DirectoryProvider</code> for Hibernate Search.
You&#8217;re very welcome to share the code
and have it merged in Hibernate Search for others to use, inspect, improve and maintain.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="ogm-infinispan-remote"><a class="anchor" href="#ogm-infinispan-remote"></a>9.4. Hibernate OGM &amp; Infinispan Server over Hot Rod</h3>
<div class="paragraph">
<p>In this section we&#8217;ll see how to configure Hibernate OGM to connect to
"Infinispan Server using the Hot Rod protocol", which we will call "Infinispan Remote"
for brevity and to differentiate it from "Infinispan Embedded".</p>
</div>
<div class="paragraph">
<p>In this mode Hibernate OGM can not boostrap or otherwise control the lifecycle
of Infinispan, so we will assume that you already have a cluster of Infinispan Server
nodes running.
For instructions on setting one up, see the <a href="http://infinispan.org/docs/stable/server_guide/server_guide.html">Infinispan Server Guide</a>.</p>
</div>
<div class="paragraph">
<p>The good news is that - since it&#8217;s a separate service - there won&#8217;t be much to configure
in Hibernate OGM.</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The Hibernate OGM support for Infinispan Remote is considered experimental.
In particular, the storage format is not set in stone.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_adding_infinispan_remote_dependencies"><a class="anchor" href="#_adding_infinispan_remote_dependencies"></a>9.4.1. Adding Infinispan Remote dependencies</h4>
<div class="paragraph">
<p>To use Hibernate OGM to connect to an Infinispan Server using the Hot Rod protocol, you will need the following extension
and its transitive dependencies (which include, among others, the Hot Rod client):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-XML" data-lang="XML">&lt;dependency&gt;
    &lt;groupId&gt;org.hibernate.ogm&lt;/groupId&gt;
    &lt;artifactId&gt;hibernate-ogm-infinispan-remote&lt;/artifactId&gt;
    &lt;version&gt;5.4.1.Final&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_configuration_properties_for_infinispan_remote"><a class="anchor" href="#_configuration_properties_for_infinispan_remote"></a>9.4.2. Configuration properties for Infinispan Remote</h4>
<div class="paragraph">
<p>First, let Hibernate know that you want to use the OGM Infinispan Remote datastore by setting the
<code>hibernate.ogm.datastore.provider</code> property to <code>infinispan_remote</code>.</p>
</div>
<div class="paragraph">
<p>The next step is to configure the Hot Rod client.
You have two alternatives:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>provide a resource file containing all Hot Rod client configuration properties</p>
</li>
<li>
<p>include all the Hot Rod client configuration properties with a custom prefix, as explained below.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To use an external configuration resource, set the <code>hibernate.ogm.infinispan_remote.configuration_resource_name</code>
configuration property to the resource name.</p>
</div>
<div class="exampleblock">
<div class="title">Example 22. Using a separate resource to configure the Hot Rod client</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-XML" data-lang="XML">&lt;?xml version="1.0"?&gt;
&lt;persistence xmlns="http://java.sun.com/xml/ns/persistence"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://java.sun.com/xml/ns/persistence http://java.sun.com/xml/ns/persistence/persistence_2_0.xsd"
    version="2.0"&gt;

    &lt;persistence-unit name="ogm-with-hotrod"&gt;
        &lt;provider&gt;org.hibernate.ogm.jpa.HibernateOgmPersistence&lt;/provider&gt; <i class="conum" data-value="1"></i><b>(1)</b>
        &lt;properties&gt;
            &lt;property name="hibernate.ogm.datastore.provider"
                value="infinispan_remote" /&gt; <i class="conum" data-value="2"></i><b>(2)</b>
            &lt;property name="hibernate.ogm.infinispan_remote.configuration_resource_name"
                value="hotrodclient.properties" /&gt; <i class="conum" data-value="3"></i><b>(3)</b>
        &lt;/properties&gt;
    &lt;/persistence-unit&gt;
&lt;/persistence&gt;</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Choose Hibernate OGM as JPA Provider</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>pick <code>infinispan_remote</code> as datastore</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>point to the Hot Rod configuration file</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code>infinispan.client.hotrod.server_list = 127.0.0.1:11222
infinispan.client.hotrod.tcp_no_delay = true
infinispan.client.hotrod.tcp_keep_alive = false

## below is connection pooling config
maxActive=-1
maxTotal = -1
maxIdle = -1
whenExhaustedAction = 1
timeBetweenEvictionRunsMillis = 120000
minEvictableIdleTimeMillis = 300000
testWhileIdle = true
minIdle = 1</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The <code>hotrodclient.properties</code> is optional, in this case Hibernate OGM will use the following:</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">HotRod client property</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Hibernate OGM mandatory value</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">infinispan.client.hotrod.marshaller</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">org.hibernate.ogm.datastore.infinispanremote.impl.protostream.OgmProtoStreamMarshaller</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">infinispan.client.hotrod.force_return_values</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Every other property will use the default values defined by <a href="http://infinispan.org/docs/stable/user_guide/user_guide.html#hotrod:java-client">Infinispan - Java Hot Rod client</a>.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>These values for <code>infinispan.client.hotrod.marshaller</code> and <code>infinispan.client.hotrod.force_return_values</code> are mandatory in order to keep the expected behaviour of the dialect.
If you change them, an exception will be thrown.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Alternatively you can embed the Hot Rod properties in your Hibernate (or JPA) configuration
file, but you&#8217;ll have to replace the <code>infinispan.client.hotrod.</code> prefix with the custom
prefix <code>hibernate.ogm.infinispan_remote.client.</code>.</p>
</div>
<div class="paragraph">
<p>Some of the Hot Rod client configuration properties don&#8217;t normally use a prefix - specifically
all properties relating to connection pooling as in the previous example - these will also
need to use the <code>hibernate.ogm.infinispan_remote.client.</code> prefix.</p>
</div>
<div class="paragraph">
<p>Properties set with the <code>hibernate.ogm.infinispan_remote.client.</code> prefix will override the same
properties configured using an external resource file.</p>
</div>
<div class="exampleblock">
<div class="title">Example 23. Embedding the Hot Rod client configuration properties in the Hibernate configuration</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-XML" data-lang="XML">&lt;?xml version="1.0"?&gt;
&lt;persistence xmlns="http://java.sun.com/xml/ns/persistence"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://java.sun.com/xml/ns/persistence http://java.sun.com/xml/ns/persistence/persistence_2_0.xsd"
    version="2.0"&gt;

    &lt;persistence-unit name="ogm-with-hotrod"&gt;
        &lt;provider&gt;org.hibernate.ogm.jpa.HibernateOgmPersistence&lt;/provider&gt; <i class="conum" data-value="1"></i><b>(1)</b>
        &lt;properties&gt;
            &lt;property name="hibernate.ogm.datastore.provider"
                value="infinispan_remote" /&gt; <i class="conum" data-value="2"></i><b>(2)</b>
            &lt;property name="hibernate.ogm.infinispan_remote.client.server_list"
                value="127.0.0.1:11222" /&gt; <i class="conum" data-value="3"></i><b>(3)</b>
            &lt;property name="hibernate.ogm.infinispan_remote.client.tcp_no_delay"
                value="true" /&gt;
            &lt;property name="hibernate.ogm.infinispan_remote.client.tcp_keep_alive"
                value="false" /&gt;
            &lt;property name="hibernate.ogm.infinispan_remote.client.maxActive"
                value="-1" /&gt;
            &lt;property name="hibernate.ogm.infinispan_remote.client.maxTotal"
                value="-1" /&gt;
            &lt;property name="hibernate.ogm.infinispan_remote.client.maxIdle"
                value="-1" /&gt;
            &lt;property name="hibernate.ogm.infinispan_remote.client.whenExhaustedAction"
                value="1" /&gt;
            &lt;property name="hibernate.ogm.infinispan_remote.client.timeBetweenEvictionRunsMillis"
                value="120000" /&gt;
            &lt;property name="hibernate.ogm.infinispan_remote.client.minEvictableIdleTimeMillis"
                value="300000" /&gt;
            &lt;property name="hibernate.ogm.infinispan_remote.client.testWhileIdle"
                value="true" /&gt;
            &lt;property name="hibernate.ogm.infinispan_remote.client.minIdle"
                value="1" /&gt;
        &lt;/properties&gt;
    &lt;/persistence-unit&gt;
&lt;/persistence&gt;</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Choose Hibernate OGM as JPA Provider</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>pick <code>infinispan_remote</code> as datastore</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>include Hot Rod configuration properties, just replacing/adding the OGM prefix.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>In the next section we&#8217;ll see a couple more advanced properties which might be of interest.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">hibernate.ogm.datastore.create_database</dt>
<dd>
<p>If set to <code>true</code> Hibernate OGM will create any missing Cache definitions on the Infinispan Server.
This requires the Infinispan Server configuration to have a default configuration defined, as this will be copied to the newly defined caches.
If set to <code>false</code> an exception is thrown when a Cache is expected but not explicitly configured on the server.
Defaults to <code>false</code>.</p>
</dd>
<dt class="hdlist1">hibernate.ogm.infinispan_remote.cache_configuration</dt>
<dd>
<p>The name of the default cache configuration that Hibernate OGM will use for the creation of new caches
on the Infinispan Server
This is only used if <code>hibernate.ogm.datastore.create_database</code> is set to true.
For more details about cache configuration, check the section <a href="#infinispan-remote-cache-configuration">Caches creation and configuration</a></p>
</dd>
<dt class="hdlist1">hibernate.ogm.infinispan_remote.schema_capture_service</dt>
<dd>
<p>If you set this to an implementation of <code>org.hibernate.ogm.datastore.infinispanremote.schema.spi.SchemaCapture</code> you
can collect any generated Protobuf Schema. Could be useful for integrations with other tools.
You can either provide a fully qualified classname or a <code>SchemaCapture</code>, or pass an instance of a <code>SchemaCapture</code>
in the configuration properties, if you&#8217;re booting Hibernate programmatically.</p>
</dd>
<dt class="hdlist1">hibernate.ogm.infinispan_remote.schema_package_name</dt>
<dd>
<p>Defines the package name of the generated Protobuf schema. Defaults to <code>HibernateOGMGenerated</code>.
Useful to isolate different applications using the same Infinispan Server instance.</p>
</dd>
<dt class="hdlist1">hibernate.ogm.infinispan_remote.schema_file_name</dt>
<dd>
<p>Defines the file name of the generated Protobuf schema. Defaults to 'Hibernate_OGM_Generated_schema.proto'.
The file name must have a valid <em>*.proto</em> extension.</p>
</dd>
<dt class="hdlist1">hibernate.ogm.infinispan_remote.schema_override_resource</dt>
<dd>
<p>It is possible to override the generated Protobuf schema, providing a user defined Protobuf schema resource.
Property value is of string type and it can either represent a <strong>class path element</strong>, an <strong>URL</strong> or a <strong>file system path</strong>.
Hibernate OGM will use the specified Protobuf Schema instead of the generated one.
This doesn&#8217;t affect how entities are encoded so the specified schema is expected to be compatible with the generated one.
This can be used to defined server side indexes on caches used by JPQL and native Ickle queries.</p>
</dd>
<dt class="hdlist1">hibernate.ogm.cache.transaction.mode</dt>
<dd>
<p>Property is used to configure the transaction mode of Infinispan caches.
Possible values are: <code>XA</code>, <code>NON_DURABLE_XA</code> (the default), <code>NON_XA</code> and <code>NONE</code> (the one to disable transaction).
For more information see the chapter <a href="#infinispan-remote-transaction">Infinispan Remote Transaction</a>.</p>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="_data_encoding_protobuf_schema"><a class="anchor" href="#_data_encoding_protobuf_schema"></a>9.4.3. Data encoding: Protobuf Schema</h4>
<div class="paragraph">
<p>Using the <em>Infinispan Remote</em> backend your data will be encoded using Protocol Buffers,
also known as Protobuf.</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Protocol Buffers are a language-neutral, platform-neutral
extensible mechanism for serializing structured data</p>
</div>
</blockquote>
<div class="attribution">
&#8212; https://developers.google.com/protocol-buffers/
</div>
</div>
<div class="paragraph">
<p>This encoding strategy will be used both during <em>transmission</em> to and from the datagrid, and
as a <em>storage format</em> on the Infinispan Server.</p>
</div>
<div class="paragraph">
<p>Typical usage of Google&#8217;s developer tools for Java would require you to download the <code>protoc</code>
compiler to generate Java stubs; you won&#8217;t need that when using Hibernate OGM as the backend
will generate the encoding and decoding functions on the fly from your entities.</p>
</div>
<div class="paragraph">
<p>The benefit of having Hibernate OGM generate the schema for you will make it easier to get
started, but there&#8217;s a drawback: you are not directly in control of the protobuf schema
It will deploy this schema - or expect a compatible schema to be deployed - as it will use
its generated codecs to read and write data to the Infinispan Server.</p>
</div>
<div class="paragraph">
<p>The protobuf technology is designed to allow evolution of your schema: you can deploy a
different schema on the Infinispan Server than the one OGM expects, but this is an advanced
topic and you&#8217;ll have to make sure the deployed schema is compatible with the one OGM is
generating and using.</p>
</div>
<div class="paragraph">
<p>Another reason to make sure the deployed protobuf schema is a <em>compatible evolution</em> of
a previous schema, is to make sure you can still read data which is already stored in
the datagrid.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Remember that the Protobuf schema is used both during <em>transmission</em> and <em>storage</em>.
The fact that it&#8217;s used also during <em>transmission</em> of your data is a key difference to the
schema of a SQL database.</p>
</div>
<div class="paragraph">
<p>For example even if a property "A" is not nullable in terms of storage, you will still
want it to be flagged as <code>optional</code> in a protobuf schema to allow, for example, retrieving
a subset of data properties without having to always retrieve the property "A".</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You don&#8217;t need to do anything regarding the schema: Hibernate OGM will automatically
deploy it to the Infinispan datagrid at boostrap of Hibernate.
You might want to keep this in mind though, both to be able to evolve your schema
without data loss, and to be able to generate decoders for other Infinispan clients not
using Hibernate OGM.</p>
</div>
<div class="paragraph">
<p>The deployed schemas can be fetched from the Infinispan Server; Hibernate OGM also
logs the generated schemas at <code>INFO</code> level in the logging category
<code>org.hibernate.ogm.datastore.infinispanremote.impl.protobuf.schema</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="storage-principles-of-infinispan-dataprovider"><a class="anchor" href="#storage-principles-of-infinispan-dataprovider"></a>9.4.4. Storage Principles of the Infinispan Remote dataprovider</h4>
<div class="paragraph">
<p>This is actually very simple.</p>
</div>
<div class="paragraph">
<p>Imagine you were mapping your entities to a traditional, table based <code class="acronym">RDBMS</code>;
now instead of tables, you have caches. Each cache has a name, and a consistent schema,
and for each cache we define a key with some properties (the id, aka the primary key).</p>
</div>
<div class="paragraph">
<p>Relations are mapped by encoding a "foreign key"; these are used either as keys perform
a key lookup on another table, or can be used in queries on other tables to identify
relations which have a higher than one cardinality.</p>
</div>
<div class="paragraph">
<p>So let&#8217;s highlight the differences with the relational world:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Referential integrity</dt>
<dd>
<p>While we can use relations based on foreign keys, Infinispan has no notion of referential integrity.
Hibernate is able to maintain the integrity as it won&#8217;t "forget" stale references,
but it is possible to interrupt Hibernate OGM
during such maintenance and then introduce breaks of integrity.</p>
</dd>
<dt class="hdlist1">When integrity could be broken</dt>
<dd>
<p>Using transactions, that are enabled by default, we can reduce the risk.
In contrast, without transactions,
when the unit of work involves several operations we might risk to have a partial writes
(updates, deletes, inserts); some operation would be flushed to data store, other not.
For instance let&#8217;s imagine you create a new entity, remove an old one and update an association
from the old to the new one in a single interaction,
this would correspond to three different remote invocations: an Entity insert, an Entity delete
and an Association update.
If there were network problems during the third invocation,
we could have a partial write in which only the first and the second operations
would be actually stored on the remote storage and this could lead to a breaking referential
integrity of the association. Because, like we said, Infinispan has no acquaintance
of referential integrity constraints.</p>
</dd>
<dt class="hdlist1">How to detect broken integrity</dt>
<dd>
<p>Unfortunately, at the moment the only way to detect a referential integrity error is to
inspect the logs for error messages or periodically monitor the associations cache and join column values.
Our advice is to keep the default transactional configuration and rely on it.</p>
</dd>
<dt class="hdlist1">A key. And a Value.</dt>
<dd>
<p>In a key/value store the two elements <em>key</em> and <em>value</em> are different, separate objects.
The schema - and consequentially all operations - generated by Hibernate OGM will treat
and encode these two objects separately. You will notice that the attributes of the key
are encoded in the value <strong>as well</strong>, as it is not possible to run e.g. range queries
on attributes of keys.</p>
</dd>
<dt class="hdlist1">Sequences and auto-incrementing values</dt>
<dd>
<p>Infinispan now support sequences, they are created by the dialect where a <code>@SequenceGenerator</code> annotation is present.
On the other hand <code>@TableGenerator</code> still use the old Hibernate OGM "compare and set" implementation;
Hibernate OGM makes use of such CAS operations to emulate the need of sequences or auto-incrementing
primary keys if your entity mapping uses them, however this solution might not work
under high load: make sure to use a different strategy, such as assigning IDs explicitly,
or using the <code>org.hibernate.id.UUIDGenerator</code> generator.
Hibernate OGM will log a warning if it detects excessive spinning on such CAS operations.</p>
</dd>
<dt class="hdlist1">Not mapped to JDBC types, but to Protobuf types</dt>
<dd>
<p>Rather than mapping your Java properties to corresponding JDBC (SQL) types, your Java
properties are mapped to Protobuf types.
See the <a href="https://developers.google.com/protocol-buffers/docs/proto#scalar">protobuf documentation</a>
for an overview of protocol buffer "primitive" types.</p>
</dd>
</dl>
</div>
<div class="exampleblock">
<div class="title">Example 24. Example auto-generated Protobuf Schema for a simple entity</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">import javax.persistence.Column;
import javax.persistence.Entity;
import javax.persistence.Id;

@Entity
public class Hypothesis {

    @Id String id;

    String description;

    @Column(name = "pos")
    int position;

}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code>package HibernateOGMGenerated; <i class="conum" data-value="1"></i><b>(1)</b>

message Hypothesis_id { <i class="conum" data-value="2"></i><b>(2)</b>
    required string id = 1;
}

message Hypothesis {
    required string id = 1;
    optional string description = 2;
    optional int32 pos = 3;  <i class="conum" data-value="3"></i><b>(3)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The default Protobuf package name.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>A dedicated message type for the Key of the Key/Value pair</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The <code>pos</code> attribute name respects the option of the <code>@Column</code> annotation</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>The above example shows how a Protobuf schema looks like, as automatically generated from a mapped entity.
Any property type supported by Hibernate ORM will be converted to a matching Protobuf type.</p>
</div>
<div class="sect4">
<h5 id="_each_table_requires_a_cache_with_the_same_name"><a class="anchor" href="#_each_table_requires_a_cache_with_the_same_name"></a>Each Table requires a Cache with the same name</h5>
<div class="paragraph">
<p>In a relational database world, when Hibernate defines the schema this implicitly creates the tables;
this is not the case on Infinispan.</p>
</div>
<div class="paragraph">
<p>With Infinispan, the <em>Protobuf Schema</em> just unlocks the capability to transmit messages with
such payloads (read/write), and allows the remote servers to process the fields, for example
to execute queries and extract projections out of the stored entries.
So this establishes a transmission and storage encoding contract, but doesn&#8217;t actually
start or allocate any storing Cache.</p>
</div>
<div class="paragraph">
<p>Hibernate OGM by convention will write to several named <code>Cache</code>s, mapping each "table name"
to a "cache name". In the above example, when having an <code>Hypothesis</code> entity this will
write to a Cache named <code>Hypothesis</code>.</p>
</div>
<div class="paragraph">
<p>The benefit is that you can tune, or query, each cache (each "table") independently; for example you could
configure the caches for the most important data to have a synchronous CacheStore which replicates
data to a relational database, and have less important entries use an asynchronous CacheStore,
or none at all, to favour performance over redundancy.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="infinispan-remote-cache-configuration"><a class="anchor" href="#infinispan-remote-cache-configuration"></a>9.4.5. Caches creation and configuration</h4>
<div class="paragraph">
<p>Hibernate OGM can create a cache on the remote Infinispan cluster if it doesn&#8217;t exist.
You can enable this behavior by setting the property
<code>hibernate.ogm.datastore.create_database=true</code>.</p>
</div>
<div class="paragraph">
<p>By default, the creation of a new cache is done using the following <em>default configuration</em>:</p>
</div>
<div class="exampleblock">
<div class="title">Example 25. Hibernate OGM default configuration for new Infinispan caches</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-XML" data-lang="XML">&lt;infinispan&gt;
  &lt;cache-container&gt;
    &lt;distributed-cache-configuration name="configuration"&gt;
      &lt;locking striping="false" acquire-timeout="10000" concurrency-level="50" isolation="REPEATABLE_READ"/&gt;
      &lt;transaction locking="PESSIMISTIC" mode="%s" /&gt; <i class="conum" data-value="1"></i><b>(1)</b>
      &lt;expiration max-idle="-1" /&gt;
      &lt;indexing index="NONE" /&gt;
      &lt;state-transfer timeout="480000" await-initial-transfer="true" /&gt;
    &lt;/distributed-cache-configuration&gt;
  &lt;/cache-container&gt;
&lt;/infinispan&gt;</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Transaction mode attribute will be filled with the value of the property <code>hibernate.ogm.cache.transaction.mode</code></td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>If a different default configuration is defined on the Infinispan server, it&#8217;s possible to use
the property <code>hibernate.ogm.datastore.cache_configuration</code> to refer to it.
This means that Hibernate OGM will create new caches using the selected configuration.</p>
</div>
<div class="paragraph">
<p>If some of your entities need a different configuration, you can use the annotation
<code>@CacheConfiguration</code>. This annotation will override the behavior of the global property using
instead the configuration defined for the annotated entity.</p>
</div>
<div class="paragraph">
<p>Note that Hibernate OGM will create the caches only if they don&#8217;t exist already and it doesn&#8217;t
update the configuration of existing caches.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The cache configurations referred to by the annotation and the property must exist on
the Infinispan cluster. An exception will be thrown otherwise.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Let&#8217;s suppose we have two entities: <em>Sheep</em> and <em>BlackSheep</em>:</p>
</div>
<div class="exampleblock">
<div class="title">Example 26. Example of entities having different cache configurations</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">import javax.persistence.Entity;
import javax.persistence.Id;

@Entity
public class Sheep {

    @Id
    String name;

    // ...

}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">import javax.persistence.Entity;
import javax.persistence.Id;
import org.hibernate.ogm.datastore.infinispanremote.options.cache.CacheConfiguration;

@Entity
@CacheConfiguration("black_sheep")
public class BlackSheep {

    @Id
    String name;

    // ...

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Bundled with a <em>persistence.xml</em> such that:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-XML" data-lang="XML">&lt;?xml version="1.0"?&gt;
&lt;persistence xmlns="http://java.sun.com/xml/ns/persistence"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://java.sun.com/xml/ns/persistence http://java.sun.com/xml/ns/persistence/persistence_2_0.xsd"
    version="2.0"&gt;

    &lt;persistence-unit name="ogm-with-hotrod"&gt;
        &lt;provider&gt;org.hibernate.ogm.jpa.HibernateOgmPersistence&lt;/provider&gt;
        &lt;properties&gt;
            &lt;property name="hibernate.ogm.datastore.provider"
                value="infinispan_remote" /&gt;

            &lt;property name="hibernate.ogm.infinispan_remote.configuration_resource_name"
                value="hotrodclient.properties" /&gt;

            &lt;property name="hibernate.ogm.datastore.create_database"
                value="true" /&gt; <i class="conum" data-value="1"></i><b>(1)</b>

            &lt;property name="hibernate.ogm.infinispan_remote.cache_configuration"
                value="sheep" /&gt; <i class="conum" data-value="2"></i><b>(2)</b>

        &lt;/properties&gt;
    &lt;/persistence-unit&gt;
&lt;/persistence&gt;</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Enable cache creation</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Select <em>sheep</em> as default cache configuration</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>In this scenario, Hibernate OGM will create the  <em>Sheep</em> cache using the configuration
<em>sheep</em> and the <em>BlackSheep</em>  cache using the <em>black_sheep</em> cache configuration.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p><em>Hibernate OGM default configuration</em> is transactional.</p>
</div>
<div class="paragraph">
<p>We generally recommend using transactional caches unless you are confident that data consistency
is not important for your use case.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_remote_query_capabilities"><a class="anchor" href="#_remote_query_capabilities"></a>9.4.6. Remote Query Capabilities</h4>
<div class="paragraph">
<p>Hibernate OGM backend can translate JPQL queries to the <strong>corresponding</strong> Infinispan remote
native queries, or it can execute native queries directly.
There are some limitations, though:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>queries on polymorphic entities using TABLE_PER_CLASS inheritance strategy are not supported</p>
</li>
<li>
<p>projection from associations is not yet implemented (example: select h.author.name from Hypothesis h where author is a one-to-one association)</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="infinispan-remote-transaction"><a class="anchor" href="#infinispan-remote-transaction"></a>9.4.7. Infinispan Remote Transaction</h4>
<div class="paragraph">
<p>Since version <em>5.4.0.CR1</em>, transactions over HotRot client are finally available.
In order to fallback to the previous behavior will be necessary just to set property 'hibernate.ogm.cache.transaction.mode' property to <code>NONE</code> value.
With mode set to NONE transactions are disabled, then the client will be able to handle both transactional and no transactional caches.
In contrast, if transactions are enabled, by default they are, <em>all cache should be defined transactional</em>.
In other word, at the moment, a transactional client cannot handle non transactional caches.
For this reason, the default configuration for client side defined caches uses the same transaction mode of the client.</p>
</div>
<div class="paragraph">
<p>Transaction are implemented by Infinispan HotRod client mimicking the embedded <code>Repeatable Read</code>
and the <code>Optimistic Locking</code> semantics.
Even if it is mandatory, with current Infinispan version, define them with:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Pessimistic locking</p>
</li>
<li>
<p>REPEATABLE_READ as isolation level</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>In fact, these ones are now also the current values of the default configuration for client side defined caches.</p>
</div>
<div class="paragraph">
<p>Is important to stress the fact that even if the caches must be defined with a pessimistic lock,
the behavior seen by the client it is the same that we would have with an optimistic lock.</p>
</div>
<div class="paragraph">
<p>For more information about HotRod transaction see the <a href="http://infinispan.org/docs/dev/user_guide/user_guide.html#hot_rod_transaction">Infinispan user guide</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_infinispan_remote_stored_procedures"><a class="anchor" href="#_infinispan_remote_stored_procedures"></a>9.4.8. Infinispan Remote Stored Procedures</h4>
<div class="paragraph">
<p>Stored procedures are now supported by the remote dialect.
There are two ways to execute code in the remote grid: <em>server task</em> and <em>remote script</em>.</p>
</div>
<div class="paragraph">
<p>Hibernate OGM is capable to execute both, using the standard JPA storing procedure syntax.
In order to be executed, the scripts or tasks <strong>must first be defined</strong> server side by the user.
Such as a stored procedure, of a SQL data store, that should first be defined on database before it could be executed.</p>
</div>
<div class="paragraph">
<p>To run a <em>remote script</em>, the script entry must first be in the Infinispan remote cache.
The name of the procedure is the key of the corresponding entry script.
The parameter names are instead defined in the first line of the script itself.
For more information see <a href="http://infinispan.org/docs/dev/user_guide/user_guide.html#scripting">Infinispan Guide - Remote Script</a></p>
</div>
<div class="paragraph">
<p>Whereas to run a <em>server task</em> you need first to deploy the java task as jar on Infinispan server.
In this case the name of the procedure is defined by <code>getName</code> method of the task service class.
The input parameters are extracted instead from the <code>TaskContext</code> in the same task service class.
For more information see <a href="http://infinispan.org/docs/dev/user_guide/user_guide.html#server_tasks">Infinispan Guide - Server Task</a></p>
</div>
<div class="paragraph">
<p>In both cases only named parameters are supported, while positional parameters are not supported yet.</p>
</div>
</div>
<div class="sect3">
<h4 id="_known_limitations_future_improvements"><a class="anchor" href="#_known_limitations_future_improvements"></a>9.4.9. Known Limitations &amp; Future improvements</h4>
<div class="paragraph">
<p>The Infinispan Remote dataprovider has some known limitations, some of which are
unsolvable without further development of Infinispan itself.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Indexing</dt>
<dd>
<p>Infinispan supports Hibernate Search annotations directly embedded within its protobuf
schema definitions; this would enable the queries on them to use indexes.
Hibernate OGM doesn&#8217;t generate these annotations in the schemas it generates yet.</p>
</dd>
<dt class="hdlist1">Native support for write skew checks</dt>
<dd>
<p>The Hot Rod client has native support for versioning of datagrid entries, yet this is
not supported on all of the client APIs. For Hibernate OGM to be able to consistently
use versioning requires enhancements to the Hot Rod client API.</p>
</dd>
<dt class="hdlist1">Enums</dt>
<dd>
<p>Protobuf has native support for Enum types, yet the JPA annotations force to choose
between ordinal or string encoding. We might have to introduce a "native" encoding,
probably via a novel mapping annotation.
Hibernate OGM supports the native protobuf Encoding but the JPA metadata will always
force the ordinal or string representations.</p>
</dd>
<dt class="hdlist1">Nesting and embedding</dt>
<dd>
<p>The Protobuf schema could allow us to embed objects, including series of objects,
as nested elements. This could allow mappings similar to the document based NoSQL
stores, such as our MongoDB dialect, but is not supported yet.</p>
</dd>
<dt class="hdlist1">Automatic creating of <code>Cache</code>s</dt>
<dd>
<p>When deploying the <em>Protobuf Schema</em>, we should also automatically define and start
the needed Caches if they are not defined.
This is currently not allowed over the Hot Rod protocol.</p>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect2">
<h3 id="ogm-infinispan-storage-principles"><a class="anchor" href="#ogm-infinispan-storage-principles"></a>9.5. Storage principles</h3>
<div class="paragraph">
<p>To describe things simply, each entity is stored under a single key.
The value itself is a map containing the columns / values pair.</p>
</div>
<div class="paragraph">
<p>Each association from one entity instance to (a set of) another is stored under a single key.
The value contains the navigational information to the (set of) entity.</p>
</div>
<div class="sect3">
<h4 id="ogm-infinispan-built-in-types"><a class="anchor" href="#ogm-infinispan-built-in-types"></a>9.5.1. Properties and built-in types</h4>
<div class="paragraph">
<p>Each entity is represented by a map.
Each property or more precisely column is represented by an entry in this map,
the key being the column name.</p>
</div>
<div class="paragraph">
<p>Hibernate OGM support by default the following property types:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>java.lang.String</code></p>
</li>
<li>
<p><code>java.lang.Character</code> (or char primitive)</p>
</li>
<li>
<p><code>java.lang.Boolean</code> (or boolean primitive); Optionally the annotations <code>@Type(type = "true_false")</code>, <code>@Type(type = "yes_no")</code> and <code>@Type(type = "numeric_boolean")</code> can be used to map boolean properties to the characters 'T'/'F', 'Y'/'N' or the int values 0/1, respectively.</p>
</li>
<li>
<p><code>java.lang.Byte</code> (or byte primitive)</p>
</li>
<li>
<p><code>java.lang.Short</code> (or short primitive)</p>
</li>
<li>
<p><code>java.lang.Integer</code> (or integer primitive)</p>
</li>
<li>
<p><code>java.lang.Long</code> (or long primitive)</p>
</li>
<li>
<p><code>java.lang.Integer</code> (or integer primitive)</p>
</li>
<li>
<p><code>java.lang.Float</code> (or float primitive)</p>
</li>
<li>
<p><code>java.lang.Double</code> (or double primitive)</p>
</li>
<li>
<p><code>java.math.BigDecimal</code></p>
</li>
<li>
<p><code>java.math.BigInteger</code></p>
</li>
<li>
<p><code>java.util.Calendar</code></p>
</li>
<li>
<p><code>java.util.Date</code></p>
</li>
<li>
<p><code>java.util.UUID</code></p>
</li>
<li>
<p><code>java.util.URL</code></p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Hibernate OGM doesn&#8217;t store null values in Infinispan,
setting a value to null is the same as removing the corresponding entry
from Infinispan.</p>
</div>
<div class="paragraph">
<p>This can have consequences when it comes to queries on null value.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_identifiers"><a class="anchor" href="#_identifiers"></a>9.5.2. Identifiers</h4>
<div class="paragraph">
<p>Entity identifiers are used to build the key in which the entity is stored in the cache.</p>
</div>
<div class="paragraph">
<p>The key is comprised of the following information:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the identifier column names</p>
</li>
<li>
<p>the identifier column values</p>
</li>
<li>
<p>the entity table (for the <code>CACHE_PER_KIND</code> strategy)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In <code>CACHE_PER_TABLE</code>, the table name is inferred from the cache name.
In <code>CACHE_PER_KIND</code>, the table name is necessary to identify the entity in the generic cache.</p>
</div>
<div class="exampleblock">
<div class="title">Example 27. Define an identifier as a primitive type</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">@Entity
public class Bookmark {

    @Id
    private Long id;

    private String title;

    // getters, setters ...
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 2. Content of the <code>Bookmark</code> cache in <code>CACHE_PER_TABLE</code></caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-top">KEY</th>
<th class="tableblock halign-center valign-top" colspan="2">MAP ENTRIES</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-center valign-middle" rowspan="2"><p class="tableblock">["id"], [42]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">42</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">title</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"Hibernate OGM documentation"</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 3. Content of the <code>ENTITIES</code> cache in <code>CACHE_PER_KIND</code></caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-top">KEY</th>
<th class="tableblock halign-center valign-top" colspan="2">MAP ENTRIES</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-center valign-middle" rowspan="2"><p class="tableblock">"Bookmark", ["id"], [42]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">42</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">title</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"Hibernate OGM documentation"</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 28. Define an identifier using @EmbeddedId</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">@Embeddable
public class NewsID implements Serializable {

    private String title;
    private String author;

    // getters, setters ...
}

@Entity
public class News {

    @EmbeddedId
    private NewsID newsId;
    private String content;

    // getters, setters ...
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 4. Content of the <code>News</code> cache in <code>CACHE_PER_TABLE</code></caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-top">KEY</th>
<th class="tableblock halign-center valign-top" colspan="2">MAP ENTRIES</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-center valign-middle" rowspan="3"><p class="tableblock">[newsId.author, newsId.title], ["Guillaume", "How to use Hibernate OGM ?"]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">newsId.author</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"Guillaume"</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">newsId.title</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"How to use Hibernate OGM ?"</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">content</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"Simple, just like ORM but with a NoSQL database"</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 5. Content of the <code>ENTITIES</code> cache in <code>CACHE_PER_KIND</code></caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-top">KEY</th>
<th class="tableblock halign-center valign-top" colspan="2">MAP ENTRIES</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-center valign-middle" rowspan="3"><p class="tableblock">"News", [newsId.author, newsId.title], ["Guillaume", "How to use Hibernate OGM ?"]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">newsId.author</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"Guillaume"</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">newsId.title</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"How to use Hibernate OGM ?"</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">content</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"Simple, just like ORM but with a NoSQL database"</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect4">
<h5 id="infinispan-embedded-id-generation-strategies"><a class="anchor" href="#infinispan-embedded-id-generation-strategies"></a>Identifier generation strategies for Infinispan Embedded</h5>
<div class="paragraph">
<p>The Infinispan Embedded dialect will use
<a href="http://infinispan.org/docs/stable/user_guide/user_guide.html#clustered_counters">Infinispan clustered counters</a>
for the generation of ids and sequences.</p>
</div>
<div class="paragraph">
<p>If the clusterd counter is not already defined, Hibernate OGM will create it using a default
configuration. The following is probably the simplest case for which a counter is created:</p>
</div>
<div class="exampleblock">
<div class="title">Example 29. Example of the default counter</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">@Entity
public class GuitarPlayer {

    @Id
    @GeneratedValue
    private long id;

    // getters, setters ...
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>In this case Hibernate OGM will create a strong persitent counter with name <code>hibernate_sequence</code>
and initial value of 0.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The default configuration will create <code>PERSISTENT</code> Infinispan counters.
You need to define in the infinispan configuration a location where to store these counters
using the following property:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-XML" data-lang="XML">&lt;infinispan&gt;
    ...
    &lt;cache-container&gt;

        &lt;global-state&gt;
            &lt;persistent-location path="/counters"/&gt;
        &lt;/global-state&gt;

        ...
    &lt;/cache-container&gt;
&lt;/infinispan&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>An exception is thrown if the property is missing.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can ovveride some of this properties with <code>@SequenceGenerator</code> or <code>@TableGenerator</code>.</p>
</div>
<div class="exampleblock">
<div class="title">Example 30. Counter defined using <code>@SequenceGenerator</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">@Entity
public class GuitarPlayer {

    @Id
    @GeneratedValue(strategy = GenerationType.SEQUENCE, generator = "gen1")
    @SequenceGenerator( name = "gen1",
                        sequenceName = "GuitarPlayerCounter",
                        initialValue = 5 )
    private long id;

    // getters, setters ...
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>This will create a counter with name <code>GuitarPlayerCounter</code> and initial value of 5.</p>
</div>
<div class="paragraph">
<p>There is no real difference if you use <code>@TableGenerator</code>, except that the counter name
is defined using the attribute <code>pkColumnValue</code>.</p>
</div>
<div class="paragraph">
<p>Note that if you need more control over a counter you can still redefine it in the Infinispan
configuration file. The following is an example of how you can define a <code>VOLATILE</code> counter:</p>
</div>
<div class="exampleblock">
<div class="title">Example 31. Create a VOLATILE counter</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-XML" data-lang="XML">&lt;infinispan&gt;
...
    &lt;cache-container&gt;

    ...

        &lt;!-- Clustered Counters are defined at runtime by InfinispanDialect --&gt;
        &lt;counters xmlns="urn:infinispan:config:counters:9.1"
            num-owners="4" reliability="CONSISTENT"&gt;

            &lt;strong-counter name="GuitarPlayerCounter"
                initial-value="0" storage="VOLATILE"&gt;

                &lt;lower-bound value="0" /&gt;
            &lt;/strong-counter&gt;
        &lt;/counters&gt;
    &lt;/cache-container&gt;
&lt;/infinispan</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>In this last case Hibernate OGM won&#8217;t create a counter but it will use the one defined in the
Infinispan configuration.</p>
</div>
<div class="paragraph">
<p>I will leave the details about counters configuration to the
<a href="http://infinispan.org/docs/stable/user_guide/user_guide.html#clustered_counters">Infinispan documentation</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="infinispan-remote-id-generation-strategies"><a class="anchor" href="#infinispan-remote-id-generation-strategies"></a>Identifier generation strategies for Infinispan Remote via Hot Rod</h5>
<div class="paragraph">
<p>Since Infinispan has not native sequence nor identity column support,
these are simulated using the table strategy, however their default values vary.
We highly recommend you explicitly use a <code>TABLE</code> strategy if you want to generate a monotonic identifier.</p>
</div>
<div class="paragraph">
<p>But if you can, use a pure in-memory and scalable strategy like a UUID generator.</p>
</div>
<div class="exampleblock">
<div class="title">Example 32. Id generation strategy TABLE using default values</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">@Entity
public class GuitarPlayer {

    @Id
    @GeneratedValue(strategy = GenerationType.TABLE)
    private long id;

    private String name;

    // getters, setters ...
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 6. Content of the <code>hibernate_sequences</code> cache in <code>CACHE_PER_TABLE</code></caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-top">KEY</th>
<th class="tableblock halign-center valign-top">NEXT VALUE</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">["sequence_name"], ["default"]</p></td>
<td class="tableblock halign-center valign-middle"><p class="tableblock">2</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 7. Content of the IDENTIFIERS cache in <code>CACHE_PER_KIND</code></caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-top">KEY</th>
<th class="tableblock halign-center valign-top">NEXT VALUE</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">"hibernate_sequences", ["sequence_name"], ["default"]</p></td>
<td class="tableblock halign-center valign-middle"><p class="tableblock">2</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="paragraph">
<p>As you can see, in <code>CACHE_PER_TABLE</code>, the key does not contain the id source table name.
It is inferred by the cache name hosting that key.</p>
</div>
<div class="exampleblock">
<div class="title">Example 33. Id generation strategy TABLE using a custom table</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">@Entity
public class GuitarPlayer {

    @Id
    @GeneratedValue(strategy = GenerationType.TABLE, generator = "guitarGen")
    @TableGenerator(
        name = "guitarGen",
        table = "GuitarPlayerSequence",
        pkColumnName = "seq"
        pkColumnValue = "guitarPlayer",
    )
    private long id;

    // getters, setters ...
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 8. Content of the <code>GuitarPlayerSequence</code> cache in <code>CACHE_PER_TABLE</code></caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-top">KEY</th>
<th class="tableblock halign-center valign-top">NEXT VALUE</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">["seq"], ["guitarPlayer"]</p></td>
<td class="tableblock halign-center valign-middle"><p class="tableblock">2</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 9. Content of the IDENTIFIERS cache in <code>CACHE_PER_KIND</code></caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-top">KEY</th>
<th class="tableblock halign-center valign-top">NEXT VALUE</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">"GuitarPlayerSequence", ["seq"], ["guitarPlayer"]</p></td>
<td class="tableblock halign-center valign-middle"><p class="tableblock">2</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 34. SEQUENCE id generation strategy</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">@Entity
public class Song {

  @Id
  @GeneratedValue(strategy = GenerationType.SEQUENCE, generator = "songSequenceGenerator")
  @SequenceGenerator(
      name = "songSequenceGenerator",
      sequenceName = "song_sequence",
      initialValue = 2,
      allocationSize = 20
  )
  private Long id;

  private String title;

  // getters, setters ...
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 10. Content of the <code>hibernate_sequences</code> cache in <code>CACHE_PER_TABLE</code></caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-top">KEY</th>
<th class="tableblock halign-center valign-top">NEXT VALUE</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">["sequence_name"], ["song_sequence"]</p></td>
<td class="tableblock halign-center valign-middle"><p class="tableblock">11</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 11. Content of the <code>IDENTIFIERS</code> cache in <code>CACHE_PER_KIND</code></caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-top">KEY</th>
<th class="tableblock halign-center valign-top">NEXT VALUE</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">"hibernate_sequences", "["sequence_name"], ["song_sequence"]</p></td>
<td class="tableblock halign-center valign-middle"><p class="tableblock">11</p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_entities_2"><a class="anchor" href="#_entities_2"></a>9.5.3. Entities</h4>
<div class="paragraph">
<p>Entities are stored in the cache named after the entity name when using the <code>CACHE_PER_TABLE</code> strategy.
In the <code>CACHE_PER_KIND</code> strategy, entities are stored in a single cache named <code>ENTITIES</code>.</p>
</div>
<div class="paragraph">
<p>The key is comprised of the following information:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the identifier column names</p>
</li>
<li>
<p>the identifier column values</p>
</li>
<li>
<p>the entity table (for the <code>CACHE_PER_KIND</code> strategy)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In <code>CACHE_PER_TABLE</code>, the table name is inferred from the cache name.
In <code>CACHE_PER_KIND</code>, the table name is necessary to identify the entity in the generic cache.</p>
</div>
<div class="paragraph">
<p>The entry value is an instance of <code>org.infinispan.atomic.FineGrainedMap</code>
which contains all the entity properties -
or to be specific columns.
Each column name and value is stored as a key / value pair in the map.
We use this specialized map as Infinispan is able to transport changes
in a much more efficient way.</p>
</div>
<div class="exampleblock">
<div class="title">Example 35. Default JPA mapping for an entity</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">@Entity
public class News {

    @Id
    private String id;
    private String title;

    // getters, setters ...
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 12. Content of the <code>News</code> cache in <code>CACHE_PER_TYPE</code></caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-top">KEY</th>
<th class="tableblock halign-center valign-top" colspan="2">MAP ENTRIES</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-center valign-middle" rowspan="2"><p class="tableblock">["id"], ["1234-5678"]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"1234-5678"</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">title</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"On the merits of NoSQL"</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 13. Content of the <code>ENTITIES</code> cache in <code>CACHE_PER_KIND</code></caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-top">KEY</th>
<th class="tableblock halign-center valign-top" colspan="2">MAP ENTRIES</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-center valign-middle" rowspan="2"><p class="tableblock">"News", ["id"], ["1234-5678"]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"1234-5678"</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">title</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"On the merits of NoSQL"</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="paragraph">
<p>As you can see, the table name is not part of the key for <code>CACHE_PER_TYPE</code>.
In the rest of this section we will no longer show the <code>CACHE_PER_KIND</code> strategy.</p>
</div>
<div class="exampleblock">
<div class="title">Example 36. Rename field and collection using @Table and @Column</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">@Entity
@Table(name = "Article")
public class News {

    @Id
    private String id;

    @Column(name = "headline")
    private String title;

    // getters, setters ...
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 14. Content of the <code>Article</code> cache</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-top">KEY</th>
<th class="tableblock halign-center valign-top" colspan="2">MAP ENTRIES</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-center valign-middle" rowspan="2"><p class="tableblock">["id"], ["1234-5678"]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"1234-5678"</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">headline</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"On the merits of NoSQL"</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_embedded_objects_and_collections"><a class="anchor" href="#_embedded_objects_and_collections"></a>Embedded objects and collections</h5>
<div class="exampleblock">
<div class="title">Example 37. Embedded object</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">@Entity
public class News {

    @Id
    private String id;
    private String title;

    @Embedded
    private NewsPaper paper;

    // getters, setters ...
}

@Embeddable
public class NewsPaper {

    private String name;
    private String owner;

    // getters, setters ...
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 15. Content of the <code>News</code> cache</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-top">KEY</th>
<th class="tableblock halign-center valign-top" colspan="2">MAP ENTRIES</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-center valign-middle" rowspan="4"><p class="tableblock">["id"], ["1234-5678"]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"1234-5678"</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">title</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"On the merits of NoSQL"</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">paper.name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"NoSQL journal of prophecies"</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">paper.owner</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"Delphy"</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 38. @ElementCollection with one attribute</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">@Entity
public class GrandMother {

    @Id
    private String id;

    @ElementCollection
    private List&lt;GrandChild&gt; grandChildren = new ArrayList&lt;GrandChild&gt;();

    // getters, setters ...
}

@Embeddable
public class GrandChild {

    private String name;

    // getters, setters ...
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 16. Content of the <code>GrandMother</code> cache</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-top">KEY</th>
<th class="tableblock halign-center valign-top" colspan="2">MAP ENTRIES</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-center valign-middle"><p class="tableblock">["id"], ["granny"]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"granny"</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 17. Content of the <code>associations_GrandMother_grandChildren</code> cache in <code>CACHE_PER_TYPE</code></caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-top">KEY</th>
<th class="tableblock halign-center valign-top">ROW KEY</th>
<th class="tableblock halign-center valign-top" colspan="2">ROW MAP ENTRIES</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-center valign-middle" rowspan="4"><p class="tableblock">["GrandMother_id"], ["granny"]</p></td>
<td class="tableblock halign-center valign-middle" rowspan="2"><p class="tableblock">["GrandMother_id", "name"], ["granny", "Leia"]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">GrandMother_id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"granny"</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"Leia"</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle" rowspan="2"><p class="tableblock">["GrandMother_id", "name"], ["granny", "Luke"]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">GrandMother_id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"granny"</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"Luke"</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 18. Content of the <code>ASSOCIATIONS</code> cache in <code>CACHE_PER_KIND</code></caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-top">KEY</th>
<th class="tableblock halign-center valign-top">ROW KEY</th>
<th class="tableblock halign-center valign-top" colspan="2">ROW MAP ENTRIES</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-center valign-middle" rowspan="4"><p class="tableblock">"GrandMother_grandChildren", ["GrandMother_id"], ["granny"]</p></td>
<td class="tableblock halign-center valign-middle" rowspan="2"><p class="tableblock">["GrandMother_id", "name"], ["granny", "Leia"]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">GrandMother_id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"granny"</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"Leia"</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle" rowspan="2"><p class="tableblock">["GrandMother_id", "name"], ["granny", "Luke"]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">GrandMother_id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"granny"</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"Luke"</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="paragraph">
<p>Here, we see that the collection of elements is stored in a separate cache and entry.
The association key is made of:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the foreign key column names pointing to the owner of this association</p>
</li>
<li>
<p>the foreign key column values pointing to the owner of this association</p>
</li>
<li>
<p>the association table name in the <code>CACHE_PER_KIND</code> approach where all associations share the same cache</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The association entry is a map containing the representation of each entry in the collection.
The keys of that map are made of:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the names of the columns uniquely identifying that specific collection entry
(e.g. for a <code>Set</code> this is all of the columns)</p>
</li>
<li>
<p>the values of the columns uniquely identifying that specific collection entry</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The value attack to that collection entry key is a Map containing the key value pairs column name / column value.</p>
</div>
<div class="exampleblock">
<div class="title">Example 39. @ElementCollection with @OrderColumn</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">@Entity
public class GrandMother {

    @Id
    private String id;

    @ElementCollection
    @OrderColumn( name = "birth_order" )
    private List&lt;GrandChild&gt; grandChildren = new ArrayList&lt;GrandChild&gt;();

    // getters, setters ...
}

@Embeddable
public class GrandChild {

    private String name;

    // getters, setters ...
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 19. Content of the <code>GrandMother</code> cache</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-top">KEY</th>
<th class="tableblock halign-center valign-top" colspan="2">MAP ENTRIES</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-center valign-middle"><p class="tableblock">["id"], ["granny"]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"granny"</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 20. Content of the <code>GrandMother_grandChildren</code> cache</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-top">KEY</th>
<th class="tableblock halign-center valign-top">ROW KEY</th>
<th class="tableblock halign-center valign-top" colspan="2">ROW MAP ENTRIES</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-center valign-middle" rowspan="6"><p class="tableblock">["GrandMother_id"], ["granny"]</p></td>
<td class="tableblock halign-center valign-middle" rowspan="3"><p class="tableblock">["GrandMother_id", "birth_order"], ["granny", 0]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">GrandMother_id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"granny"</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">birth_order</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"Leia"</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle" rowspan="3"><p class="tableblock">["GrandMother_id", "birth_order"], ["granny", 1]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">GrandMother_id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"granny"</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">birth_order</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"Luke"</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="paragraph">
<p>Here we used an indexed collection and to identify the entry in the collection,
only the owning entity id and the index value is enough.</p>
</div>
<div class="exampleblock">
<div class="title">Example 40. @ElementCollection with Map of @Embeddable</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">@Entity
public class ForumUser {

    @Id
    private String name;

    @ElementCollection
    private Map&lt;String, JiraIssue&gt; issues = new HashMap&lt;&gt;();

    // getters, setters ...
}

@Embeddable
public class JiraIssue {

    private Integer number;
    private String project;

    // getters, setters ...
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 21. Content of the <code>ForumUser</code> cache</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-top">KEY</th>
<th class="tableblock halign-center valign-top" colspan="2">MAP ENTRIES</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-center valign-middle"><p class="tableblock">["id"], ["Jane Doe"]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"Jane Doe"</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 22. Content of the <code>ForumUser_issues</code> cache</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-top">KEY</th>
<th class="tableblock halign-center valign-top">ROW KEY</th>
<th class="tableblock halign-center valign-top" colspan="2">ROW MAP ENTRIES</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-center valign-middle" rowspan="12"><p class="tableblock">["ForumUser_id"], ["Jane Doe"]</p></td>
<td class="tableblock halign-center valign-middle" rowspan="4"><p class="tableblock">["ForumUser_id", "issues_KEY"], ["Jane Doe", "issueWithNull"]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ForumUser_id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Jane Doe</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">issue_KEY</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"issueWithNull"</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">issues.value.project</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">&lt;null&gt;</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">issues.value.number</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">&lt;null&gt;</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle" rowspan="4"><p class="tableblock">["ForumUser_id", "issues_KEY"], ["Jane Doe", "issue1"]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ForumUser_id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"Jane Doe"</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">issue_KEY</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"issue1"</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">issues.value.project</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"OGM"</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">issues.value.number</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1253</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle" rowspan="4"><p class="tableblock">["ForumUser_id", "issues_KEY"], ["Jane Doe", "issue2"]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ForumUser_id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"Jane Doe"</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">issue_KEY</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"issue2"</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">issues.value.project</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"HSEARCH"</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">issues.value.number</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2000</p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_associations_2"><a class="anchor" href="#_associations_2"></a>9.5.4. Associations</h4>
<div class="paragraph">
<p>Associations between entities are mapped like (collection of) embeddables
except that the target entity is represented by its identifier(s).</p>
</div>
<div class="exampleblock">
<div class="title">Example 41. Unidirectional one-to-one</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">@Entity
public class Vehicle {

    @Id
    private String id;
    private String brand;

    // getters, setters ...
}

@Entity
public class Wheel {

    @Id
    private String id;
    private double diameter;

    @OneToOne
    private Vehicle vehicle;

    // getters, setters ...
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 23. Content of the <code>Vehicle</code> cache</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-top">KEY</th>
<th class="tableblock halign-center valign-top" colspan="2">MAP ENTRIES</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-center valign-middle" rowspan="2"><p class="tableblock">["id"], ["V_01"]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"V_01"</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">brand</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"Mercedes"</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 24. Content of the <code>Wheel</code> cache</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-top">KEY</th>
<th class="tableblock halign-center valign-top" colspan="2">MAP ENTRIES</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-center valign-middle" rowspan="3"><p class="tableblock">["id"], ["W001"]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"W001"</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">diameter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.0</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">vehicle_id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"V_01"</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="infinispan-in-entity-one-to-one-join-column" class="exampleblock">
<div class="title">Example 42. Unidirectional one-to-one with @JoinColumn</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">@Entity
public class Vehicle {

    @Id
    private String id;
    private String brand;

    // getters, setters ...
}


@Entity
public class Wheel {

    @Id
    private String id;
    private double diameter;

    @OneToOne
    @JoinColumn( name = "part_of" )
    private Vehicle vehicle;

    // getters, setters ...
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 25. Content of the <code>Vehicle</code> cache</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-top">KEY</th>
<th class="tableblock halign-center valign-top" colspan="2">MAP ENTRIES</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-center valign-middle" rowspan="2"><p class="tableblock">["id"], ["V_01"]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"V_01"</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">brand</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"Mercedes"</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 26. Content of the <code>Wheel</code> cache</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-top">KEY</th>
<th class="tableblock halign-center valign-top" colspan="2">MAP ENTRIES</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-center valign-middle" rowspan="3"><p class="tableblock">"Wheel", ["id"], ["W001"]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"W001"</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">diameter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.0</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">part_of</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"V_01"</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 43. Unidirectional one-to-one with @MapsId and @PrimaryKeyJoinColumn</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">@Entity
public class Vehicle {

    @Id
    private String id;
    private String brand;

    // getters, setters ...
}

@Entity
public class Wheel {

    @Id
    private String id;
    private double diameter;

    @OneToOne
    @PrimaryKeyJoinColumn
    @MapsId
    private Vehicle vehicle;

    // getters, setters ...
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 27. Content of the <code>Vehicle</code> cache</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-top">KEY</th>
<th class="tableblock halign-center valign-top" colspan="2">MAP ENTRIES</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-center valign-middle" rowspan="2"><p class="tableblock">["id"], ["V_01"]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"V_01"</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">brand</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"Mercedes"</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 28. Content of the <code>Wheel</code> cache</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-top">KEY</th>
<th class="tableblock halign-center valign-top" colspan="2">MAP ENTRIES</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-center valign-middle" rowspan="2"><p class="tableblock">["vehicle_id"], ["V_01"]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">vehicle_id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"V_01"</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">diameter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.0</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 44. Bidirectional one-to-one</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">@Entity
public class Husband {

    @Id
    private String id;
    private String name;

    @OneToOne
    private Wife wife;

    // getters, setters ...
}

@Entity
public class Wife {

    @Id
    private String id;
    private String name;

    @OneToOne(mappedBy="wife")
    private Husband husband;

    // getters, setters ...
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 29. Content of the <code>Husband</code> cache</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-top">KEY</th>
<th class="tableblock halign-center valign-top" colspan="2">MAP ENTRIES</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-center valign-middle" rowspan="3"><p class="tableblock">["id"], ["alex"]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"alex"</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"Alex"</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">wife</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"bea"</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 30. Content of the <code>Wife</code> cache</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-top">KEY</th>
<th class="tableblock halign-center valign-top" colspan="2">MAP ENTRIES</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-center valign-middle" rowspan="2"><p class="tableblock">["id"], ["bea"]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"bea"</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"Bea"</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 31. Content of the <code>associations_Husband</code> cache</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-top">KEY</th>
<th class="tableblock halign-center valign-top">ROW KEY</th>
<th class="tableblock halign-center valign-top" colspan="2">MAP ENTRIES</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-center valign-middle" rowspan="2"><p class="tableblock">["wife"], ["bea"]</p></td>
<td class="tableblock halign-center valign-middle" rowspan="2"><p class="tableblock">["id", "wife"], ["alex", "bea"]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"alex"</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">wife</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"bea"</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 45. Unidirectional one-to-many</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">@Entity
public class Basket {

    @Id
    private String id;

    private String owner;

    @OneToMany
    private List&lt;Product&gt; products = new ArrayList&lt;Product&gt;();

    // getters, setters ...
}

@Entity
public class Product {

    @Id
    private String name;

    private String description;

    // getters, setters ...
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 32. Content of the <code>Basket</code> cache</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-top">KEY</th>
<th class="tableblock halign-center valign-top" colspan="2">MAP ENTRIES</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-center valign-middle" rowspan="2"><p class="tableblock">["id"], ["davide_basket"]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"davide_basket"</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">owner</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"Davide"</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 33. Content of the <code>Product</code> cache</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-top">KEY</th>
<th class="tableblock halign-center valign-top" colspan="2">MAP ENTRIES</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-center valign-middle" rowspan="2"><p class="tableblock">["name"], ["Beer"]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"Beer"</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">description</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"Tactical Nuclear Penguin"</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle" rowspan="2"><p class="tableblock">["name"], ["Pretzel"]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"Pretzel"</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">description</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"Glutino Pretzel Sticks"</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 34. Content of the <code>associations_Basket_Product</code> cache</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-top">KEY</th>
<th class="tableblock halign-center valign-top">ROW KEY</th>
<th class="tableblock halign-center valign-top" colspan="2">MAP ENTRIES</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-center valign-middle" rowspan="4"><p class="tableblock">["Basket_id"], ["davide_basket"]</p></td>
<td class="tableblock halign-center valign-middle" rowspan="2"><p class="tableblock">["Basket_id", "products_name"], ["davide_basket", "Beer"]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Basket_id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"davide_basket"</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">products_name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"Beer"</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle" rowspan="2"><p class="tableblock">["Basket_id", "products_name"], ["davide_basket", "Pretzel"]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Basket_id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"davide_basket"</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">products_name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"Pretzel"</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 46. Unidirectional one-to-many with <code>@JoinTable</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">@Entity
public class Basket {

    @Id
    private String id;

    private String owner;

    @OneToMany
    @JoinTable( name = "BasketContent" )
    private List&lt;Product&gt; products = new ArrayList&lt;Product&gt;();

    // getters, setters ...
}

@Entity
public class Product {

    @Id
    private String name;

    private String description;

    // getters, setters ...
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 35. Content of the <code>Basket</code> cache</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-top">KEY</th>
<th class="tableblock halign-center valign-top" colspan="2">MAP ENTRIES</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-center valign-middle" rowspan="2"><p class="tableblock">["id"], ["davide_basket"]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"davide_basket"</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">owner</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"Davide"</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 36. Content of the <code>Basket</code> cache</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-top">KEY</th>
<th class="tableblock halign-center valign-top" colspan="2">MAP ENTRIES</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-center valign-middle" rowspan="2"><p class="tableblock">["name"], ["Beer"]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"Beer"</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">description</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"Tactical Nuclear Penguin"</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle" rowspan="2"><p class="tableblock">["name"], ["Pretzel"]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"Pretzel"</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">description</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"Glutino Pretzel Sticks"</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 37. Content of the <code>associations_BasketContent</code> cache</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-top">KEY</th>
<th class="tableblock halign-center valign-top">ROW KEY</th>
<th class="tableblock halign-center valign-top" colspan="2">MAP ENTRIES</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-center valign-middle" rowspan="4"><p class="tableblock">["Basket_id"], ["davide_basket"]</p></td>
<td class="tableblock halign-center valign-middle" rowspan="2"><p class="tableblock">["Basket_id", "products_name"], ["davide_basket", "Beer"]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Basket_id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"davide_basket"</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">products_name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"Beer"</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle" rowspan="2"><p class="tableblock">["Basket_id", "products_name"], ["davide_basket", "Pretzel"]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Basket_id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"davide_basket"</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">products_name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"Pretzel"</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 47. Unidirectional one-to-many using maps with defaults</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">@Entity
public class User {

    @Id
    private String id;

    @OneToMany
    private Map&lt;String, Address&gt; addresses = new HashMap&lt;String, Address&gt;();

    // getters, setters ...
}

@Entity
public class Address {

    @Id
    private String id;
    private String city;

    // getters, setters ...
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 38. Content of the <code>User</code> cache</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-top">KEY</th>
<th class="tableblock halign-center valign-top" colspan="2">MAP ENTRIES</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-center valign-middle"><p class="tableblock">["id"], ["user_001"]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"user_001"</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 39. Content of the <code>Address</code> cache</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-top">KEY</th>
<th class="tableblock halign-center valign-top" colspan="2">MAP ENTRIES</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-center valign-middle" rowspan="2"><p class="tableblock">["id"], ["address_001"]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"address_001"</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">city</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"Rome"</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle" rowspan="2"><p class="tableblock">["id"], ["address_002"]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"address_002"</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">city</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"Paris"</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 40. Content of the <code>associations_User_address</code> cache</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-top">KEY</th>
<th class="tableblock halign-center valign-top">ROW KEY</th>
<th class="tableblock halign-center valign-top" colspan="2">MAP ENTRIES</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-center valign-middle" rowspan="6"><p class="tableblock">["User_id"], "user_001"]</p></td>
<td class="tableblock halign-center valign-middle" rowspan="3"><p class="tableblock">["User_id", "addresses_KEY"], ["user_001", "home"]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">User_id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"user_001"</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">addresses_KEY</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"home"</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">addresses_id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"address_001"</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle" rowspan="3"><p class="tableblock">["User_id", "addresses_KEY"], ["user_001", "work"]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">User_id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"user_002"</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">addresses_KEY</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"work"</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">addresses_id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"address_002"</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 48. Unidirectional one-to-many using maps with @MapKeyColumn</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">@Entity
public class User {

    @Id
    private String id;

    @OneToMany
    @MapKeyColumn(name = "addressType")
    private Map&lt;String, Address&gt; addresses = new HashMap&lt;String, Address&gt;();

    // getters, setters ...
}

@Entity
public class Address {

    @Id
    private String id;
    private String city;

    // getters, setters ...
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 41. Content of the <code>User</code> cache</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-top">KEY</th>
<th class="tableblock halign-center valign-top" colspan="2">MAP ENTRIES</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-center valign-middle"><p class="tableblock">["id"], ["user_001"]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"user_001"</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 42. Content of the <code>Address</code> cache</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-top">KEY</th>
<th class="tableblock halign-center valign-top" colspan="2">MAP ENTRIES</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-center valign-middle" rowspan="2"><p class="tableblock">["id"], ["address_001"]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"address_001"</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">city</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"Rome"</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle" rowspan="2"><p class="tableblock">["id"], ["address_002"]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"address_002"</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">city</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"Paris"</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 43. Content of the <code>associations_User_address</code> cache</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-top">KEY</th>
<th class="tableblock halign-center valign-top">ROW KEY</th>
<th class="tableblock halign-center valign-top" colspan="2">MAP ENTRIES</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-center valign-middle" rowspan="6"><p class="tableblock">["User_id"], "user_001"]</p></td>
<td class="tableblock halign-center valign-middle" rowspan="3"><p class="tableblock">["User_id", "addressType"], ["user_001", "home"]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">User_id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"user_001"</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">addressesType</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"home"</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">addresses_id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"address_001"</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle" rowspan="3"><p class="tableblock">["User_id", "addressType"], ["user_001", "work"]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">User_id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"user_002"</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">addressesType</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"work"</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">addresses_id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"address_002"</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 49. Unidirectional many-to-one</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">@Entity
public class JavaUserGroup {

    @Id
    private String jugId;
    private String name;

    // getters, setters ...
}

@Entity
public class Member {

    @Id
    private String id;
    private String name;

    @ManyToOne
    private JavaUserGroup memberOf;

    // getters, setters ...
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 44. Content of the <code>JavaUserGroup</code> cache</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-top">KEY</th>
<th class="tableblock halign-center valign-top" colspan="2">MAP ENTRIES</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-center valign-middle" rowspan="2"><p class="tableblock">["jugId"], ["summer_camp"]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">jugId</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"summer_camp"</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"JUG Summer Camp"</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 45. Content of the <code>Member</code> cache</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-top">KEY</th>
<th class="tableblock halign-center valign-top" colspan="2">MAP ENTRIES</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-center valign-middle" rowspan="3"><p class="tableblock">["member_id"], ["emmanuel"]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">member_id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"emmanuel"</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"Emmanuel Bernard"</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">memberOf_jug_id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"summer_camp"</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle" rowspan="3"><p class="tableblock">["member_id"], ["jerome"]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">member_id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"jerome"</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"Jerome"</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">memberOf_jug_id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"summer_camp"</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 50. Bidirectional many-to-one</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">@Entity
public class SalesForce {

    @Id
    private String id;
    private String corporation;

    @OneToMany(mappedBy = "salesForce")
    private Set&lt;SalesGuy&gt; salesGuys = new HashSet&lt;SalesGuy&gt;();

    // getters, setters ...
}

@Entity
public class SalesGuy {
    private String id;
    private String name;

    @ManyToOne
    private SalesForce salesForce;

    // getters, setters ...
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 46. Content of the <code>SalesForce</code> cache</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-top">KEY</th>
<th class="tableblock halign-center valign-top" colspan="2">MAP ENTRIES</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-center valign-middle" rowspan="2"><p class="tableblock">["id"], ["red_hat"]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"red_hat"</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">corporation</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"Red Hat"</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 47. Content of the <code>SalesGuy</code> cache</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-top">KEY</th>
<th class="tableblock halign-center valign-top" colspan="2">MAP ENTRIES</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-center valign-middle" rowspan="3"><p class="tableblock">["id"], ["eric"]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"eric"</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"Eric"</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">salesForce_id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"red_hat"</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle" rowspan="3"><p class="tableblock">["id"], ["simon"]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"simon"</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"Simon"</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">salesForce_id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"red_hat"</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 48. Content of the <code>associations_SalesGuy</code> cache</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-top">KEY</th>
<th class="tableblock halign-center valign-top">ROW KEY</th>
<th class="tableblock halign-center valign-top" colspan="2">MAP ENTRIES</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-center valign-middle" rowspan="4"><p class="tableblock">["salesForce_id"], ["red_hat"]</p></td>
<td class="tableblock halign-center valign-middle" rowspan="2"><p class="tableblock">["salesForce_id", "id"], ["red_hat", "eric"]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">salesForce_id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"red_hat"</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"eric"</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle" rowspan="2"><p class="tableblock">["salesForce_id", "id"], ["red_hat", "simon"]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">salesForce_id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"red_hat"</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"simon"</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 51. Unidirectional many-to-many</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">@Entity
public class Student {

    @Id
    private String id;
    private String name;

    // getters, setters ...
}

@Entity
public class ClassRoom {

    @Id
    private long id;
    private String lesson;

    @ManyToMany
    private List&lt;Student&gt; students = new ArrayList&lt;Student&gt;();

    // getters, setters ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The "Math" class has 2 students: John Doe and Mario Rossi</p>
</div>
<div class="paragraph">
<p>The "English" class has 2 students: Kate Doe and Mario Rossi</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 49. Content of the <code>ClassRoom</code> cache</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-top">KEY</th>
<th class="tableblock halign-center valign-top" colspan="2">MAP ENTRIES</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-center valign-middle" rowspan="2"><p class="tableblock">["id"], [1]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"Math"</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle" rowspan="2"><p class="tableblock">["id"], [2]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"English"</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 50. Content of the <code>Student</code> cache</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-top">KEY</th>
<th class="tableblock halign-center valign-top" colspan="2">MAP ENTRIES</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-center valign-middle" rowspan="2"><p class="tableblock">["id"], ["john"]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"john"</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"John Doe"</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle" rowspan="2"><p class="tableblock">["id"], ["mario"]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"mario"</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"Mario Rossi"</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle" rowspan="2"><p class="tableblock">["id"], ["kate"]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"kate"</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"Kate Doe"</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 51. Content of the <code>associations_ClassRoom_Student</code> cache</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-top">KEY</th>
<th class="tableblock halign-center valign-top">ROW KEY</th>
<th class="tableblock halign-center valign-top" colspan="2">MAP ENTRIES</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-center valign-middle" rowspan="4"><p class="tableblock">["ClassRoom_id"], [1]</p></td>
<td class="tableblock halign-center valign-middle" rowspan="2"><p class="tableblock">["ClassRoom_id", "students_id"], [1, "mario"]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ClassRoom_id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">students_id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"mario"</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle" rowspan="2"><p class="tableblock">["ClassRoom_id", "students_id"], [1, "john"]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ClassRoom_id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">students_id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"john"</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle" rowspan="4"><p class="tableblock">["ClassRoom_id"], [2]</p></td>
<td class="tableblock halign-center valign-middle" rowspan="2"><p class="tableblock">["ClassRoom_id", "students_id"], [2, "kate"]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ClassRoom_id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">students_id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"kate"</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle" rowspan="2"><p class="tableblock">["ClassRoom_id", "students_id"], [2, "mario"]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ClassRoom_id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">students_id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"mario"</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 52. Bidirectional many-to-many</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">@Entity
public class AccountOwner {

    @Id
    private String id;

    private String SSN;

    @ManyToMany
    private Set&lt;BankAccount&gt; bankAccounts;

    // getters, setters ...
}

@Entity
public class BankAccount {

    @Id
    private String id;

    private String accountNumber;

    @ManyToMany( mappedBy = "bankAccounts" )
    private Set&lt;AccountOwner&gt; owners = new HashSet&lt;AccountOwner&gt;();

    // getters, setters ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>David owns 2 accounts: "012345" and "ZZZ-009"</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 52. Content of the <code>AccountOwner</code> cache</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-top">KEY</th>
<th class="tableblock halign-center valign-top" colspan="2">MAP ENTRIES</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-center valign-middle" rowspan="2"><p class="tableblock">["id"], ["David"]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"David"</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">SSN</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"0123456"</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 53. Content of the <code>BankAccount</code> cache</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-top">KEY</th>
<th class="tableblock halign-center valign-top" colspan="2">MAP ENTRIES</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-center valign-middle" rowspan="2"><p class="tableblock">["id"], ["account_1"]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"account_1"</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">accountNumber</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"X2345000"</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle" rowspan="2"><p class="tableblock">["id"], ["account_2"]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"account_2"</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">accountNumber</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"ZZZ-009"</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 54. Content of the <code>AccountOwner_BankAccount</code> cache</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-top">KEY</th>
<th class="tableblock halign-center valign-top">ROW KEY</th>
<th class="tableblock halign-center valign-top" colspan="2">MAP ENTRIES</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-center valign-middle" rowspan="2"><p class="tableblock">["bankAccounts_id"], ["account_1"]</p></td>
<td class="tableblock halign-center valign-middle" rowspan="2"><p class="tableblock">["bankAccounts_id", "owners_id"], ["account_1", "David"]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">bankAccounts_id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"account_1"</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">owners_id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"David"</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle" rowspan="2"><p class="tableblock">["bankAccounts_id"], ["account_2"]</p></td>
<td class="tableblock halign-center valign-middle" rowspan="2"><p class="tableblock">["bankAccounts_id", "owners_id"], ["account_2", "David"]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">bankAccounts_id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"account_2"</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">owners_id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"David"</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle" rowspan="4"><p class="tableblock">["owners_id"], ["David"]</p></td>
<td class="tableblock halign-center valign-middle" rowspan="2"><p class="tableblock">["owners_id", "banksAccounts_id"], ["David", "account_1"]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">bankAccounts_id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"account_1"</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">owners_id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"David"</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle" rowspan="2"><p class="tableblock">["owners_id", "banksAccounts_id"], ["David", "account_2"]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">bankAccounts_id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"account_2"</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">owners_id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"David"</p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="ogm-mongodb"><a class="anchor" href="#ogm-mongodb"></a>10. MongoDB</h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="http://www.mongodb.org">MongoDB</a> is a document oriented datastore
written in C++ with strong emphasis on ease of use.
The nested nature of documents make it a particularly natural fit for most object representations.</p>
</div>
<div class="paragraph">
<p>This implementation is based upon the MongoDB Java driver.
The currently supported version is 3.6.</p>
</div>
<div class="sect2">
<h3 id="_why_should_i_use_hibernate_ogm_with_mongodb"><a class="anchor" href="#_why_should_i_use_hibernate_ogm_with_mongodb"></a>10.1. Why should I use Hibernate OGM with MongoDB</h3>
<div class="paragraph">
<p>It is possible that in your project you have some entities that might benefit from MongoDB
dynamic schema, but having a schema makes it possible to obtain better performance because
the datastore can use the information of the schema to apply some optimizations that
wouldn&#8217;t be otherwise possible.</p>
</div>
<div class="paragraph">
<p>JPA already has ways to define constraints and indexes and via Hibernate OGM you can
use the same annotations for both your relational and not relational needs.</p>
</div>
<div class="paragraph">
<p>Hibernate OGM cannot make MongoDB transactional but by using the JPA transaction demarcation
mechanism it can group the operations and flush them to the datastore to
minimize the number of requests.</p>
</div>
<div class="paragraph">
<p>Another benefit of using Hibernate OGM with MongoDB is that it will also make it possible
to use Hibernate Search out of the box. Hibernate Search brings the power of Lucene
to your project, giving you the ability to run fast google-like searches.</p>
</div>
<div class="paragraph">
<p>This means that you can query the datastore using:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>JPQL queries (see <a href="#ogm-jpql-query">Using JPQL</a>)</p>
</li>
<li>
<p>MongoDB native queries (see <a href="#ogm-mongodb-queries-native">Native MongoDB queries</a>)</p>
</li>
<li>
<p>Full-text queries (see <a href="#ogm-query-using-hibernate-search">Using Hibernate Search</a>)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>One of Hibernate OGM main goal is to map entities in a "natural" way, this means that your
datastore will still be accessible in case you need to use other tools or want to run
native queries occasionally.</p>
</div>
</div>
<div class="sect2">
<h3 id="_configuring_mongodb"><a class="anchor" href="#_configuring_mongodb"></a>10.2. Configuring MongoDB</h3>
<div class="paragraph">
<p>Configuring Hibernate OGM to use MongoDb is easy:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Add the MongoDB module and driver to the classpath</p>
</li>
<li>
<p>provide the MongoDB URL to Hibernate OGM</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_adding_mongodb_dependencies"><a class="anchor" href="#_adding_mongodb_dependencies"></a>10.2.1. Adding MongoDB dependencies</h4>
<div class="paragraph">
<p>To add the dependencies via Maven, add the following module:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-XML" data-lang="XML">&lt;dependency&gt;
    &lt;groupId&gt;org.hibernate.ogm&lt;/groupId&gt;
    &lt;artifactId&gt;hibernate-ogm-mongodb&lt;/artifactId&gt;
    &lt;version&gt;5.4.1.Final&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will pull the MongoDB driver transparently.</p>
</div>
<div class="paragraph">
<p>If you&#8217;re not using a dependency management tool,
copy all the dependencies from the distribution in the directories:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>/lib/required</code></p>
</li>
<li>
<p><code>/lib/mongodb</code></p>
</li>
<li>
<p>Optionally - depending on your container - you might need some of the jars from <code>/lib/provided</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>MongoDB does not require Hibernate Search for the execution of JPQL or HQL queries.</p>
</div>
</div>
<div class="sect3">
<h4 id="_mongodb_specific_configuration_properties"><a class="anchor" href="#_mongodb_specific_configuration_properties"></a>10.2.2. MongoDB specific configuration properties</h4>
<div class="paragraph">
<p>To get started quickly, pay attention to the following options:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>hibernate.ogm.datastore.provider</code></p>
</li>
<li>
<p><code>hibernate.ogm.datastore.host</code></p>
</li>
<li>
<p><code>hibernate.ogm.datastore.database</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>And we should have you running.
The following properties are available to configure MongoDB support:</p>
</div>
<div class="dlist">
<div class="title">MongoDB datastore configuration properties</div>
<dl>
<dt class="hdlist1">hibernate.ogm.datastore.provider</dt>
<dd>
<p>To use MongoDB as a datastore provider, this property must be set to <code>mongodb</code></p>
</dd>
<dt class="hdlist1">hibernate.ogm.option.configurator</dt>
<dd>
<p>The fully-qualified class name or an instance of a programmatic option configurator (see <a href="#ogm-mongodb-programmatic-configuration">Programmatic configuration</a>)</p>
</dd>
<dt class="hdlist1">hibernate.ogm.datastore.host</dt>
<dd>
<p>The hostname and port of the MongoDB instance.
The optional port is concatenated to the host and separated by a colon.
When using replica sets, you can define the various servers in a comma separated list of hosts and ports.
Let&#8217;s see a few valid examples:</p>
<div class="ulist">
<ul>
<li>
<p><code>mongodb.example.com</code></p>
</li>
<li>
<p><code>mongodb.example.com:27018</code></p>
</li>
<li>
<p><code>2001:db8::ff00:42:8329</code> (IPv6)</p>
</li>
<li>
<p><code>[2001:db8::ff00:42:8329]:27018</code> (IPv6 with port requires the IPv6 to be surrounded by square brackets)</p>
</li>
<li>
<p><code>www.example.com, www2.example.com:123, 192.0.2.1, 192.0.2.2:123, 2001:db8::ff00:42:8329, [2001:db8::ff00:42:8329]:123</code> (replica set)</p>
<div class="paragraph">
<p>The default value is <code>127.0.0.1:27017</code>. If left undefined, the default port is <code>27017</code>.</p>
</div>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">hibernate.ogm.datastore.port</dt>
<dd>
<p>Deprecated: use <code>hibernate.ogm.datastore.host</code>.
The port used by the MongoDB instance.
Ignored when multiple hosts are defined.
The default value is <code>27017</code>.</p>
</dd>
<dt class="hdlist1">hibernate.ogm.datastore.database</dt>
<dd>
<p>The database to connect to. This property has no default value.</p>
</dd>
<dt class="hdlist1">hibernate.connection.resource</dt>
<dd>
<p>Alternatively you can lookup datastore client. See <a href="#integration-with-wildfly-nosql">Integration with WildFly NoSQL</a>.</p>
</dd>
<dt class="hdlist1">hibernate.ogm.datastore.create_database</dt>
<dd>
<p>If set to true, the database will be created if it doesn&#8217;t exist.
This property default value is false.</p>
</dd>
<dt class="hdlist1">hibernate.ogm.datastore.username</dt>
<dd>
<p>The username used when connecting to the MongoDB server.
This property has no default value.</p>
</dd>
<dt class="hdlist1">hibernate.ogm.datastore.password</dt>
<dd>
<p>The password used to connect to the MongoDB server.
This property has no default value.
This property is ignored if the username isn&#8217;t specified.</p>
</dd>
<dt class="hdlist1">hibernate.ogm.error_handler</dt>
<dd>
<p>The fully-qualified class name, class object or an instance of <code>ErrorHandler</code> to get notified upon errors during flushes (see <a href="#ogm-api-error-handler">Acting upon errors during application of changes</a>)</p>
</dd>
<dt class="hdlist1">hibernate.ogm.mongodb.driver.*</dt>
<dd>
<p>Defines a prefix for all options which should be passed through to the MongoDB driver.
For available options refer to the JavaDocs of <a href="http://api.mongodb.org/java/3.0/com/mongodb/MongoClientOptions.Builder.html">MongoClientOptions.Builder</a>. All <code>String</code>, <code>int</code> and <code>boolean</code> properties
can be set, eg <code>hibernate.ogm.mongodb.driver.serverSelectionTimeout</code>.</p>
</dd>
<dt class="hdlist1">hibernate.ogm.mongodb.authentication_database</dt>
<dd>
<p>Defines the name of the authentication database, default value is <em>admin</em>.</p>
</dd>
<dt class="hdlist1">hibernate.ogm.mongodb.authentication_mechanism</dt>
<dd>
<p>Defines the authentication mechanism to use. Possible values are:</p>
<div class="ulist">
<ul>
<li>
<p><code>BEST</code>: Handshakes with the server to find the best authentication mechanism.</p>
</li>
<li>
<p><code>SCRAM_SHA_1</code>: The SCRAM SHA 1 Challenge Response mechanism as described in this <a href="http://tools.ietf.org/html/rfc5802">RFC</a>.</p>
</li>
<li>
<p><code>MONGODB_CR</code>: The MongoDB Challenge Response mechanism (deprecated since MongoDB 3)</p>
</li>
<li>
<p><code>GSSAPI</code>: The GSSAPI mechanism. See the <a href="http://tools.ietf.org/html/rfc4752">RFC</a></p>
</li>
<li>
<p><code>MONGODB_X509</code>: The MongoDB X.509</p>
</li>
<li>
<p><code>PLAIN</code>: The PLAIN mechanism.  See the <a href="http://www.ietf.org/rfc/rfc4616.txt">RFC</a></p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">hibernate.ogm.datastore.document.association_storage</dt>
<dd>
<p>Defines the way OGM stores association information in MongoDB.
The following two strategies exist (values of the <code>org.hibernate.ogm.datastore.document.options.AssociationStorageType</code> enum):</p>
<div class="ulist">
<ul>
<li>
<p><code>IN_ENTITY</code>: store association information within the entity</p>
</li>
<li>
<p><code>ASSOCIATION_DOCUMENT</code>: store association information in a dedicated document per association</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><code>IN_ENTITY</code> is the default and recommended option
unless the association navigation data is much bigger than the core of the document and leads to performance degradation.</p>
</div>
</dd>
<dt class="hdlist1">hibernate.ogm.mongodb.association_document_storage</dt>
<dd>
<p>Defines how to store assocation documents (applies only if the <code>ASSOCIATION_DOCUMENT</code>
association storage strategy is used).
Possible strategies are (values of the <code>org.hibernate.ogm.datastore.mongodb.options.AssociationDocumentStorageType</code> enum):</p>
<div class="ulist">
<ul>
<li>
<p><code>GLOBAL_COLLECTION</code> (default): stores the association information in a unique MongoDB collection for all associations</p>
</li>
<li>
<p><code>COLLECTION_PER_ASSOCIATION</code> stores the association in a dedicated MongoDB collection per association</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">hibernate.ogm.datastore.document.map_storage</dt>
<dd>
<p>Defines the way OGM stores the contents of map-typed associations in MongoDB.
The following two strategies exist (values of the <code>org.hibernate.ogm.datastore.document.options.MapStorageType</code> enum):</p>
<div class="ulist">
<ul>
<li>
<p><code>BY_KEY</code>: map-typed associations with a single key column which is of type <code>String</code> will be stored as a sub-document,
organized by the given key; Not applicable for other types of key columns, in which case always <code>AS_LIST</code> will be used</p>
</li>
<li>
<p><code>AS_LIST</code>: map-typed associations will be stored as an array containing a sub-document for each map entry.
All key and value columns will be contained within the array elements</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">hibernate.ogm.mongodb.write_concern</dt>
<dd>
<p>Defines the write concern setting to be applied when issuing writes against the MongoDB datastore.
Possible settings are (values of the <code>WriteConcernType</code> enum):
<code>ACKNOWLEDGED</code>, <code>UNACKNOWLEDGED</code>, <code>FSYNCED</code>, <code>JOURNALED</code>, <code>REPLICA_ACKNOWLEDGED</code>, <code>MAJORITY</code> and <code>CUSTOM</code>.
When set to <code>CUSTOM</code>, a custom <code>WriteConcern</code> implementation type has to be specified.</p>
<div class="paragraph">
<p>This option is case insensitive and the default value is <code>ACKNOWLEDGED</code>.</p>
</div>
</dd>
<dt class="hdlist1">hibernate.ogm.mongodb.write_concern_type</dt>
<dd>
<p>Specifies a custom <code>WriteConcern</code> implementation type (fully-qualified name, class object or instance).
This is useful in cases where the pre-defined configurations are not sufficient,
e.g. if you want to ensure that writes are propagated to a specific number of replicas or given "tag set".
Only takes effect if <code>hibernate.ogm.mongodb.write_concern</code> is set to <code>CUSTOM</code>.</p>
</dd>
<dt class="hdlist1">hibernate.ogm.mongodb.read_preference</dt>
<dd>
<p>Specifies the <code>ReadPreference</code> to be applied when issuing reads against the MongoDB datastore.
Possible settings are (values of the <code>ReadPreferenceType</code> enum):
<code>PRIMARY</code>, <code>PRIMARY_PREFERRED</code>, <code>SECONDARY</code>, <code>SECONDARY_PREFERRED</code> and <code>NEAREST</code>.
It&#8217;s currently not possible to plug in custom read preference types.
If you&#8217;re interested in such a feature, please let us know.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>For more information, please refer to the
<a href="http://api.mongodb.org/java/current/com/mongodb/WriteConcern.html">official documentation</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>When bootstrapping a session factory or entity manager factory programmatically,
you should use the constants accessible via <code>org.hibernate.ogm.datastore.mongodb.MongoDBProperties</code>
when specifying the configuration properties listed above.</p>
</div>
<div class="paragraph">
<p>Common properties shared between stores are declared on <code>OgmProperties</code>
(a super interface of <code>MongoDBProperties</code>).</p>
</div>
<div class="paragraph">
<p>For maximum portability between stores, use the most generic interface possible.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="ogm-mongodb-annotation-configuration"><a class="anchor" href="#ogm-mongodb-annotation-configuration"></a>10.2.3. Annotation based configuration</h4>
<div class="paragraph">
<p>Hibernate OGM allows to configure store-specific options via Java annotations.
You can override global configurations for a specific entity or even a specify property
by virtue of the location where you place that annotation.</p>
</div>
<div class="paragraph">
<p>When working with the MongoDB backend, you can specify the following settings:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the write concern for entities and associations using the <code>@WriteConcern</code> annotation</p>
</li>
<li>
<p>the read preference for entities and associations using the <code>@ReadPreference</code> annotation</p>
</li>
<li>
<p>a strategy for storing associations using the <code>@AssociationStorage</code> and <code>@AssociationDocumentStorage</code> annotations</p>
</li>
<li>
<p>a strategy for storing the contents of map-typed associations using the <code>@MapStorage</code> annotation</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Refer to &lt;&lt;mongodb-associations&gt; to learn more about the options related to storing associations.</p>
</div>
<div class="paragraph">
<p>The following shows an example:</p>
</div>
<div class="exampleblock">
<div class="title">Example 53. Configuring the association storage strategy using annotations</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">@Entity
@WriteConcern(WriteConcernType.JOURNALED)
@ReadPreference(ReadPreferenceType.PRIMARY_PREFERRED)
@AssociationStorage(AssociationStorageType.ASSOCIATION_DOCUMENT)
@AssociationDocumentStorage(AssociationDocumentStorageType.COLLECTION_PER_ASSOCIATION)
@MapStorage(MapStorageType.AS_LIST)
public class Zoo {

    @OneToMany
    private Set&lt;Animal&gt; animals;

    @OneToMany
    private Set&lt;Person&gt; employees;

    @OneToMany
    @AssociationStorage(AssociationStorageType.IN_ENTITY)
    private Set&lt;Person&gt; visitors;

    // getters, setters ...
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The <code>@WriteConcern</code> annotation on the entity level expresses that all writes should be done using the <code>JOURNALED</code> setting.
Similarly, the <code>@ReadPreference</code> annotation advices the engine to preferably read that entity from the primary node if possible.
The other two annotations on the type-level specify that all associations of the <code>Zoo</code>
class should be stored in separate assocation documents, using a dedicated collection per association.
This setting applies to the <code>animals</code> and <code>employees</code> associations.
Only the elements of the <code>visitors</code> association will be stored in the document of the corresponding <code>Zoo</code> entity
as per the configuration of that specific property which takes precedence over the entity-level configuration.</p>
</div>
</div>
<div class="sect3">
<h4 id="ogm-mongodb-programmatic-configuration"><a class="anchor" href="#ogm-mongodb-programmatic-configuration"></a>10.2.4. Programmatic configuration</h4>
<div class="paragraph">
<p>In addition to the annotation mechanism,
Hibernate OGM also provides a programmatic API for applying store-specific configuration options.
This can be useful if you can&#8217;t modify certain entity types or
don&#8217;t want to add store-specific configuration annotations to them.
The API allows set options in a type-safe fashion on the global, entity and property levels.</p>
</div>
<div class="paragraph">
<p>When working with MongoDB, you can currently configure the following options using the API:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>write concern</p>
</li>
<li>
<p>read preference</p>
</li>
<li>
<p>association storage strategy</p>
</li>
<li>
<p>association document storage strategy</p>
</li>
<li>
<p>strategy for storing the contents of map-typed associations</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To set these options via the API, you need to create an <code>OptionConfigurator</code> implementation
as shown in the following example:</p>
</div>
<div class="exampleblock">
<div class="title">Example 54. Example of an option configurator</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">public class MyOptionConfigurator extends OptionConfigurator {

    @Override
    public void configure(Configurable configurable) {
        configurable.configureOptionsFor( MongoDB.class )
            .writeConcern( WriteConcernType.REPLICA_ACKNOWLEDGED )
            .readPreference( ReadPreferenceType.NEAREST )
            .entity( Zoo.class )
                .associationStorage( AssociationStorageType.ASSOCIATION_DOCUMENT )
                .associationDocumentStorage( AssociationDocumentStorageType.COLLECTION_PER_ASSOCIATION )
                .mapStorage( MapStorageType.ASLIST )
                .property( "animals", ElementType.FIELD )
                    .associationStorage( AssociationStorageType.IN_ENTITY )
            .entity( Animal.class )
                .writeConcern( new RequiringReplicaCountOf( 3 ) )
                .associationStorage( AssociationStorageType.ASSOCIATION_DOCUMENT );
    }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The call to <code>configureOptionsFor()</code>, passing the store-specific identifier type <code>MongoDB</code>,
provides the entry point into the API. Following the fluent API pattern, you then can configure
global options (<code>writeConcern()</code>, <code>readPreference()</code>) and navigate to single entities or properties to apply options
specific to these (<code>associationStorage()</code> etc.).
The call to <code>writeConcern()</code>  for the <code>Animal</code>  entity shows how a specific write concern type can be used.
Here <code>RequiringReplicaCountOf</code> is a custom implementation of <code>WriteConcern</code> which ensures
that writes are propagated to a given number of replicas before a write is acknowledged.</p>
</div>
<div class="paragraph">
<p>Options given on the property level precede entity-level options. So e.g. the <code>animals</code> association of the <code>Zoo</code>
class would be stored using the in entity strategy, while all other associations of the <code>Zoo</code> entity would
be stored using separate association documents.</p>
</div>
<div class="paragraph">
<p>Similarly, entity-level options take precedence over options given on the global level.
Global-level options specified via the API complement the settings given via configuration properties.
In case a setting is given via a configuration property and the API at the same time,
the latter takes precedence.</p>
</div>
<div class="paragraph">
<p>Note that for a given level (property, entity, global),
an option set via annotations is overridden by the same option set programmatically.
This allows you to change settings in a more flexible way if required.</p>
</div>
<div class="paragraph">
<p>To register an option configurator, specify its class name using the <code>hibernate.ogm.option.configurator</code> property.
When bootstrapping a session factory or entity manager factory programmatically,
you also can pass in an <code>OptionConfigurator</code> instance or the class object representing the configurator type.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="ogm-mongodb-storage-principles"><a class="anchor" href="#ogm-mongodb-storage-principles"></a>10.3. Storage principles</h3>
<div class="paragraph">
<p>Hibernate OGM tries to make the mapping to the underlying datastore as natural as possible
so that third party applications not using Hibernate OGM can still read
and update the same datastore.
We worked particularly hard on the MongoDB model
to offer various classic mappings between your object model
and the MongoDB documents.</p>
</div>
<div class="paragraph">
<p>To describe things simply, each entity is stored as a MongoDB document.
This document is stored in a MongoDB collection named after the entity type.
The navigational information for each association from one entity to (a set of) entity
is stored in the document representing the entity we are departing from.</p>
</div>
<div class="sect3">
<h4 id="mongodb-built-in-types"><a class="anchor" href="#mongodb-built-in-types"></a>10.3.1. Properties and built-in types</h4>
<div class="paragraph">
<p>Each entity is represented by a document.
Each property or more precisely column is represented by a field in this document,
the field name being the column name.</p>
</div>
<div class="paragraph">
<p>Hibernate OGM supports by default the following property types:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>java.lang.String</code></p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JSON" data-lang="JSON">  { "text" : "Hello world!" }</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>java.lang.Character</code> (or char primitive)</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JSON" data-lang="JSON">  { "delimiter" : "/" }</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>java.lang.Boolean</code> (or boolean primitive)</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JSON" data-lang="JSON">  { "favorite" : true } # default mapping
  { "favorite" : "T" } # if @Type(type = "true_false") is given
  { "favorite" : "Y" } # if @Type(type = "yes_no") is given
  { "favorite" : 1 } # if @Type(type = "numeric_boolean") is given</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>java.lang.Byte</code> (or byte primitive)</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JSON" data-lang="JSON">  { "display_mask" : "70" }</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>java.lang.Byte[]</code> (or byte[])</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JSON" data-lang="JSON">  { "pdfAsBytes" : BinData(0,"MTIzNDU=") }</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>java.lang.Short</code> (or short primitive)</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JSON" data-lang="JSON">  { "urlPort" : 80 }</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>java.lang.Integer</code> (or integer primitive)</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JSON" data-lang="JSON">  { "stockCount" : 12309 }</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>java.lang.Long</code> (or long primitive)</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JSON" data-lang="JSON">  { "userId" : NumberLong("-6718902786625749549") }</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>java.lang.Float</code> (or float primitive)</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JSON" data-lang="JSON">  { "visitRatio" : 10.39 }</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>java.lang.Double</code> (or double primitive)</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JSON" data-lang="JSON">  { "tax_percentage" : 12.34 }</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>java.math.BigDecimal</code></p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JSON" data-lang="JSON">  { "site_weight" : "21.77" }</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>java.math.BigInteger</code></p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JSON" data-lang="JSON">  { "site_weight" : "444" }</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>java.util.Calendar</code></p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JSON" data-lang="JSON">  { "creation" : "2014/11/03 16:19:49:283 +0000" }</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>java.util.Date</code></p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JSON" data-lang="JSON">  { "last_update" : ISODate("2014-11-03T16:19:49.283Z") }</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>java.util.UUID</code></p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JSON" data-lang="JSON">  { "serialNumber" : "71f5713d-69c4-4b62-ad15-aed8ce8d10e0" }</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>java.util.URL</code></p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JSON" data-lang="JSON">  { "url" : "http://www.hibernate.org/" }</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>org.bson.types.ObjectId</code></p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JSON" data-lang="JSON">  { "object_id" : ObjectId("547d9b40e62048750f25ef77") }</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Hibernate OGM doesn&#8217;t store null values in MongoDB,
setting a value to null is the same as removing the field
in the corresponding object in the db.</p>
</div>
<div class="paragraph">
<p>This can have consequences when it comes to queries on null value.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="mongodb-gridfs-support"><a class="anchor" href="#mongodb-gridfs-support"></a>10.3.2. GridFS Support</h4>
<div class="paragraph">
<p>This feature is experimental.</p>
</div>
<div class="paragraph">
<p>GridFS is a specification for storing and retrieving files that
exceed the BSON-document size limit of 16 MB.</p>
</div>
<div class="paragraph">
<p>You can find more details about it in
the <a href="https://docs.mongodb.com/manual/core/gridfs/">official MongoDB documentation</a>.</p>
</div>
<div class="paragraph">
<p>It&#8217;s possible to store a value as GridFS using the type
<code>org.hibernate.ogm.datastore.mongodb.type.GridFS</code>.</p>
</div>
<div class="exampleblock">
<div class="title">Example 55. Field mapped using GridFS</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">import org.hibernate.ogm.datastore.mongodb.type.GridFS;

@Entity
public class Photo {

    @Id
    String name;

    GridFS image;

    // ...
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre>&gt; db.Photo.find()
{ "_id" : "photo.jpg", "image" : ObjectId("5bce7202826ce81d7fe7ebe5") }

&gt; db.Photo_bucket.files.find().pretty()
{
        "_id" : ObjectId("5bce7202826ce81d7fe7ebe5"),
        "filename" : "image_photo.jpg",
        "length" : NumberLong(30000000),
        "chunkSize" : 261120,
        "uploadDate" : ISODate("2018-10-22T20:57:37.047Z"),
        "md5" : "a08988fc1e3da0e80d2ba7b55599d1f7"
}</pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The default bucket name is the name of the class with the suffix <code>_bucket</code> while the name
of the filename is the combination of the field name with the id of the document.</p>
</div>
<div class="paragraph">
<p>It&#8217;s possible to select a different bucket name using the annotation <code>@GridFSBucket</code>.</p>
</div>
<div class="exampleblock">
<div class="title">Example 56. Field mapped using GridFS with custom bucket name</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">import org.hibernate.ogm.datastore.mongodb.type.GridFS;
import org.hibernate.ogm.datastore.mongodb.options.GridFSBucket;

@Entity
public class Photo {

    @Id
    String name;

    @GridFSBucket("PhotoGallery")
    GridFS image;

    // ...
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre>&gt; db.Photo.find()
{ "_id" : "photo.jpg", "image" : ObjectId("5bce7202826ce81d7fe7ebe5") }

&gt; db.PhotoGallery.files.find().pretty()
{
        "_id" : ObjectId("5bce7202826ce81d7fe7ebe5"),
        "filename" : "image_photo.jpg",
        "length" : NumberLong(30000000),
        "chunkSize" : 261120,
        "uploadDate" : ISODate("2018-10-22T20:57:37.047Z"),
        "md5" : "a08988fc1e3da0e80d2ba7b55599d1f7"
}</pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_entities_3"><a class="anchor" href="#_entities_3"></a>10.3.3. Entities</h4>
<div class="paragraph">
<p>Entities are stored as MongoDB documents and not as BLOBs:
each entity property will be translated into a document field.
You can use <code>@Table</code> and <code>@Column</code> annotations
to rename respectively the collection the document is stored in
and the document&#8217;s field a property is persisted in.</p>
</div>
<div class="exampleblock">
<div class="title">Example 57. Default JPA mapping for an entity</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">@Entity
public class News {

    @Id
    private String id;
    private String title;

    // getters, setters ...
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JSON" data-lang="JSON">// Stored in the Collection "News"
{
    "_id" : "1234-5678-0123-4567",
    "title": "On the merits of NoSQL",
}</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 58. Rename field and collection using @Table and @Column</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">@Entity
// Overrides the collection name
@Table(name = "News_Collection")
public class News {

    @Id
    private String id;

    // Overrides the field name
    @Column(name = "headline")
    private String title;

    // getters, setters ...
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JSON" data-lang="JSON">// Stored in the Collection "News"
{
    "_id" : "1234-5678-0123-4567",
    "headline": "On the merits of NoSQL",
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_identifiers_2"><a class="anchor" href="#_identifiers_2"></a>Identifiers</h5>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Hibernate OGM always store identifiers using the <code>_id</code> field of a MongoDB document ignoring
the name of the property in the entity.</p>
</div>
<div class="paragraph">
<p>That&#8217;s a good thing as MongoDB has special treatment and expectation of the property <code>_id</code>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>An identifier type may be one of the <a href="#mongodb-built-in-types">built-in types</a>
or a more complex type represented by an embedded class.
When you use a built-in type, the identifier is mapped like a regular property.
When you use an embedded class, then the <code>_id</code> is representing a nested document
containing the embedded class properties.</p>
</div>
<div class="exampleblock">
<div class="title">Example 59. Define an identifier as a primitive type</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">@Entity
public class Bookmark {

    @Id
    private String id;

    private String title;

    // getters, setters ...
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JSON" data-lang="JSON">{
  "_id" : "bookmark_1"
  "title" : "Hibernate OGM documentation"
}</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 60. Define an identifier using @EmbeddedId</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">@Embeddable
public class NewsID implements Serializable {

    private String title;
    private String author;

    // getters, setters ...
}

@Entity
public class News {

    @EmbeddedId
    private NewsID newsId;
    private String content;

    // getters, setters ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>News collection as JSON in MongoDB</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JSON" data-lang="JSON">{
  "_id" : {
      "author" : "Guillaume",
      "title" : "How to use Hibernate OGM ?"
  },
  "content" : "Simple, just like ORM but with a NoSQL database"
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Generally, it is recommended though to work with MongoDB&#8217;s object id data type.
This will facilitate the integration with other applications expecting that common MongoDB id type.
To do so, you have two options:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Define your id property as <code>org.bson.types.ObjectId</code></p>
</li>
<li>
<p>Define your id property as <code>String</code> and annotate it with <code>@Type(type="objectid")</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In both cases the id will be stored as native <code>ObjectId</code> in the datastore.</p>
</div>
<div class="exampleblock">
<div class="title">Example 61. Define an id as ObjectId</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">@Entity
public class News {

    @Id
    private ObjectId id;

    private String title;

    // getters, setters ...
}</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 62. Define an id of type String as ObjectId</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">@Entity
public class News {

    @Id
    @Type(type = "objectid")
    private String id;

    private String title;

    // getters, setters ...
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_identifier_generation_strategies"><a class="anchor" href="#_identifier_generation_strategies"></a>Identifier generation strategies</h5>
<div class="paragraph">
<p>You can assign id values yourself or let Hibernate OGM generate the value using the
<code>@GeneratedValue</code> annotation.</p>
</div>
<div class="paragraph">
<p>There are 4 different strategies:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#mongodb-identity-id-generation-strategy">IDENTITY</a> (suggested)</p>
</li>
<li>
<p><a href="#mongodb-table-id-generation-strategy">TABLE</a></p>
</li>
<li>
<p><a href="#mongodb-sequence-id-generation-strategy">SEQUENCE</a></p>
</li>
<li>
<p><a href="#mongodb-auto-id-generation-strategy">AUTO</a></p>
</li>
</ol>
</div>
<div id="mongodb-identity-id-generation-strategy" class="paragraph">
<p><strong>1) IDENTITY generation strategy</strong></p>
</div>
<div class="paragraph">
<p>The preferable strategy, Hibernate OGM will create the identifier upon insertion.
To apply this strategy the id must be one of the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>annotated with <code>@Type(type="objectid")</code></p>
</li>
<li>
<p><code>org.bson.types.ObjectId</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>like in the following examples:</p>
</div>
<div class="exampleblock">
<div class="title">Example 63. Define an id of type String as ObjectId</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">@Entity
public class News {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    @Type(type = "objectid")
    private String id;

    private String title;

    // getters, setters ...
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JSON" data-lang="JSON">{
    "_id" : ObjectId("5425448830048b67064d40b1"),
    "title" : "Exciting News"
}</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 64. Define an id as ObjectId</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">@Entity
public class News {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private ObjectId id;

    private String title;

    // getters, setters ...
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JSON" data-lang="JSON">{
    "_id" : ObjectId("5425448830048b67064d40b1"),
    "title" : "Exciting News"
}</code></pre>
</div>
</div>
</div>
</div>
<div id="mongodb-table-id-generation-strategy" class="paragraph">
<p><strong>2) TABLE generation strategy</strong></p>
</div>
<div class="exampleblock">
<div class="title">Example 65. Id generation strategy TABLE using default values</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">@Entity
public class GuitarPlayer {

    @Id
    @GeneratedValue(strategy = GenerationType.TABLE)
    private Long id;

    private String name;

    // getters, setters ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>GuitarPlayer collection</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JSON" data-lang="JSON">{
    "_id" : NumberLong(1),
    "name" : "Buck Cherry"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>hibernate_sequences collection</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JSON" data-lang="JSON">{
    "_id" : "GuitarPlayer",
    "next_val" : 101
}</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 66. Id generation strategy TABLE using a custom table</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">@Entity
public class GuitarPlayer {

    @Id
    @GeneratedValue(strategy = GenerationType.TABLE, generator = "guitarGen")
    @TableGenerator(
        name = "guitarGen",
        table = "GuitarPlayerSequence",
        pkColumnValue = "guitarPlayer",
        valueColumnName = "nextGuitarPlayerId"
    )
    private long id;

    // getters, setters ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>GuitarPlayer collection</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JSON" data-lang="JSON">{
    "_id" : NumberLong(1),
    "name" : "Buck Cherry"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>GuitarPlayerSequence collection</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JSON" data-lang="JSON">{
    "_id" : "guitarPlayer",
    "nextGuitarPlayerId" : 2
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p><strong>3) SEQUENCE generation strategy</strong></p>
</div>
<div id="mongodb-sequence-id-generation-strategy" class="exampleblock">
<div class="title">Example 67. SEQUENCE id generation strategy using default values</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">@Entity
public class Song {

  @Id
  @GeneratedValue(strategy = GenerationType.SEQUENCE)
  private Long id;

  private String title;

  // getters, setters ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Song collection</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JSON" data-lang="JSON">{
  "_id" : NumberLong(2),
  "title" : "Flower Duet"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>hibernate_sequences collection</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JSON" data-lang="JSON">{ "_id" : "song_sequence_name", "next_val" : 21 }</code></pre>
</div>
</div>
</div>
</div>
<div id="mongodb-sequence-id-generation-strategy-custom" class="exampleblock">
<div class="title">Example 68. SEQUENCE id generation strategy using custom values</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">@Entity
public class Song {

  @Id
  @GeneratedValue(strategy = GenerationType.SEQUENCE, generator = "songSequenceGenerator")
  @SequenceGenerator(
      name = "songSequenceGenerator",
      sequenceName = "song_seq",
      initialValue = 2,
      allocationSize = 20
  )
  private Long id;

  private String title;

  // getters, setters ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Song collection</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JSON" data-lang="JSON">{
  "_id" : NumberLong(2),
  "title" : "Flower Duet"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>hibernate_sequences collection</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JSON" data-lang="JSON">{ "_id" : "song_seq", "next_val" : 42 }</code></pre>
</div>
</div>
</div>
</div>
<div id="mongodb-auto-id-generation-strategy" class="paragraph">
<p><strong>4) AUTO generation strategy</strong></p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Care must be taken when using the <code>GenerationType.AUTO</code> strategy.
When the property <code>hibernate.id.new_generator_mappings</code> is set to <code>false</code> (default),
it will map to the <code>IDENTITY</code> strategy.
As described before, this requires your ids to be of type <code>ObjectId</code> or <code>@Type(type = "objectid") String</code>.
If <code>hibernate.id.new_generator_mappings</code> is set to true, <code>AUTO</code> will be mapped to the <code>TABLE</code> strategy.
This requires your id to be of a numeric type.</p>
</div>
<div class="paragraph">
<p>We recommend to not use <code>AUTO</code> but one of the explicit strategies (<code>IDENTITY</code> or <code>TABLE</code>) to avoid
potential misconfigurations.</p>
</div>
<div class="paragraph">
<p>For more details you can check the issue <a href="https://hibernate.atlassian.net/browse/OGM-663">OGM-663</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If the property <code>hibernate.id.new_generator_mappings</code>  is set to <code>false</code>,
<code>AUTO</code> will behave as the <code>IDENTITY</code> strategy.</p>
</div>
<div class="paragraph">
<p>If the property <code>hibernate.id.new_generator_mappings</code>  is set to <code>true</code>,
<code>AUTO</code> will behave as the <code>SEQUENCE</code> strategy.</p>
</div>
<div class="exampleblock">
<div class="title">Example 69. AUTO id generation strategy using default values</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">@Entity
public class DistributedRevisionControl {

  @Id
  @GeneratedValue(strategy = GenerationType.AUTO)
  private Long id;

  private String name;

  // getters, setters ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>DistributedRevisionControl collection</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JSON" data-lang="JSON">{ "_id" : NumberLong(1), "name" : "Git" }</code></pre>
</div>
</div>
<div class="paragraph">
<p>hibernate_sequences collection</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JSON" data-lang="JSON">{ "_id" : "hibernate_sequence", "next_val" : 2 }</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 70. AUTO id generation strategy wih <code>hibernate.id.new_generator_mappings</code> set to false and ObjectId</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">@Entity
public class Comedian {

  @Id
  @GeneratedValue(strategy = GenerationType.AUTO)
  private ObjectId id;

  private String name;

  // getters, setters ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Comedian collection</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JSON" data-lang="JSON">{ "_id" : ObjectId("5458b11693f4add0f90519c5"), "name" : "Louis C.K." }</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 71. Entity with @EmbeddedId</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">@Entity
public class News {

    @EmbeddedId
    private NewsID newsId;

    // getters, setters ...
}

@Embeddable
public class NewsID implements Serializable {

    private String title;
    private String author;

    // getters, setters ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Rendered as JSON in MongoDB</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JSON" data-lang="JSON">{
    "_id" :{
        "title": "How does Hibernate OGM MongoDB work?",
        "author": "Guillaume"
    }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_embedded_objects_and_collections_2"><a class="anchor" href="#_embedded_objects_and_collections_2"></a>Embedded objects and collections</h5>
<div class="paragraph">
<p>Hibernate OGM stores elements annotated with <code>@Embedded</code> or <code>@ElementCollection</code> as nested documents of the owning entity.</p>
</div>
<div class="exampleblock">
<div class="title">Example 72. Embedded object</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">@Entity
public class News {

    @Id
    private String id;
    private String title;

    @Embedded
    private NewsPaper paper;

    // getters, setters ...
}

@Embeddable
public class NewsPaper {

    private String name;
    private String owner;

    // getters, setters ...
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JSON" data-lang="JSON">{
    "_id" : "1234-5678-0123-4567",
    "title": "On the merits of NoSQL",
    "paper": {
        "name": "NoSQL journal of prophecies",
        "owner": "Delphy"
    }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 73. @ElementCollection with primitive types</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">@Entity
public class AccountWithPhone {

    @Id
    private String id;

    @ElementCollection
    private List&lt;String&gt; mobileNumbers;

    // getters, setters ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>AccountWithPhone collection</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JSON" data-lang="JSON">{
    "_id" : "john_account",
    "mobileNumbers" : [ "+1-222-555-0222", "+1-202-555-0333" ]
}</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 74. @ElementCollection with one attribute</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">@Entity
public class GrandMother {

    @Id
    private String id;

    @ElementCollection
    private List&lt;GrandChild&gt; grandChildren = new ArrayList&lt;GrandChild&gt;();

    // getters, setters ...
}

@Embeddable
public class GrandChild {

    private String name;

    // getters, setters ...
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JSON" data-lang="JSON">{
    "_id" : "df153180-c6b3-4a4c-a7da-d5de47cf6f00",
    "grandChildren" : [ "Luke", "Leia" ]
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The class <code>GrandChild</code> has only one attribute <code>name</code>,
this means that Hibernate OGM doesn&#8217;t need to store the name of the attribute.</p>
</div>
<div class="paragraph">
<p>If the nested document has two or more fields, like in the following example,
Hibernate OGM will store the name of the fields as well.</p>
</div>
<div class="exampleblock">
<div class="title">Example 75. @ElementCollection with @OrderColumn</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">@Entity
public class GrandMother {

    @Id
    private String id;

    @ElementCollection
    @OrderColumn( name = "birth_order" )
    private List&lt;GrandChild&gt; grandChildren = new ArrayList&lt;GrandChild&gt;();

    // getters, setters ...
}

@Embeddable
public class GrandChild {

    private String name;

    // getters, setters ...
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JSON" data-lang="JSON">{
    "_id" : "e3e1ed4e-c685-4c3f-9a67-a5aeec6ff3ba",
    "grandChildren" :
        [
            {
                "name" : "Luke",
                "birth_order" : 0
            },
            {
                "name" : "Leia",
                "birthorder" : 1
            }
        ]
}</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 76. @ElementCollection with Map of @Embeddable</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">@Entity
public class ForumUser {

    @Id
    private String name;

    @ElementCollection
    private Map&lt;String, JiraIssue&gt; issues = new HashMap&lt;&gt;();

    // getters, setters ...
}

@Embeddable
public class JiraIssue {

    private Integer number;
    private String project;

    // getters, setters ...
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JSON" data-lang="JSON">{
        "_id" : "Jane Doe",
        "issues" : {
                "issueWithNull" : {
                },
                "issue2" : {
                    "number" : 2000,
                    "project" : "OGM"
                },
                "issue1" : {
                    "number" : 1253,
                    "project" : "HSEARCH"
                }
        }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>You can override the column name used for a property of an embedded object.
But you need to know that the default column name is the concatenation of the embedding property,
a <code>.</code> (dot) and the embedded property (recursively for several levels of embedded objects).</p>
</div>
<div class="paragraph">
<p>The MongoDB datastore treats dots specifically as it transforms them into nested documents.
If you want to override one column name and still keep the nested structure, don&#8217;t forget the dots.</p>
</div>
<div class="paragraph">
<p>That&#8217;s a bit abstract, so let&#8217;s use an example.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">@Entity
class Order {
    @Id String number;
    User user;
    Address shipping;
    @AttributeOverrides({
        @AttributeOverride(name="name", column=@Column(name="delivery.provider"),
        @AttributeOverride(name="expectedDelaysInDays", column=@Column(name="delivery.delays")
    })
    DeliveryProvider deliveryProvider;
    CreditCardType cardType;
}

// default columns
@Embedded
class User {
    String firstname;
    String lastname;
}

// override one column
@Embeddable
public Address {
    String street;
    @Column(name="shipping.dest_city")
    String city;
}

// both columns overridden from the embedding side
@Embeddable
public DeliveryProvider {
    String name;
    Integer expectedDelaysInDays;
}

// do not use dots in the overriding
// and mix levels (bad form)
@Embedded
class CreditCardType {
    String merchant;
    @Column(name="network")
    String network;
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JSON" data-lang="JSON">{
    "_id": "123RF33",
    "user": {
        "firstname": "Emmanuel",
        "lastname": "Bernard"
    },
    "shipping": {
        "street": "1 av des Champs Elysées",
        "dest_city": "Paris"
    },
    "delivery": {
        "provider": "Santa Claus Inc.",
        "delays": "1"
    }
    "network": "VISA",
    "cardType: {
        "merchant": "Amazon"
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you share the same embeddable in different places, you can use JPA&#8217;s <code>@AttributeOverride</code>
to override columns from the embedding side.
This is the case of <code>DeliveryProvider</code> in our example.</p>
</div>
<div class="paragraph">
<p>If you omit the dot in one of the columns, this column will not be part of the nested document.
This is demonstrated by the <code>CreditCardType</code>.
We advise you against it.
Like crossing streams, it is bad form.
This approach might not be supported in the future.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="mongodb-associations"><a class="anchor" href="#mongodb-associations"></a>10.3.4. Associations</h4>
<div class="paragraph">
<p>Hibernate OGM MongoDB proposes three strategies to store navigation information for associations.
The three possible strategies are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#mongodb-in-entity-strategy">IN_ENTITY</a> (default)</p>
</li>
<li>
<p><a href="#mongodb-association-document-strategy">ASSOCIATION_DOCUMENT</a>, using a global collection for all associations</p>
</li>
<li>
<p><a href="#mongodb-collection-per-association-strategy">COLLECTION_PER_ASSOCIATION</a>, using a dedicated collection for each association</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To switch between these strategies, use of the three approaches to options:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>annotate your entity with <code>@AssocationStorage</code> and <code>@AssociationDocumentStorage</code> annotations (see <a href="#ogm-mongodb-annotation-configuration">Annotation based configuration</a>),</p>
</li>
<li>
<p>use the API for programmatic configuration (see <a href="#ogm-mongodb-programmatic-configuration">Programmatic configuration</a>)</p>
</li>
<li>
<p>or specify a default strategy via the <code>hibernate.ogm.datastore.document.association_storage</code> and
<code>hibernate.ogm.mongodb.association_document_storage</code> configuration properties.</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="mongodb-in-entity-strategy"><a class="anchor" href="#mongodb-in-entity-strategy"></a>In Entity strategy</h5>
<div class="ulist">
<ul>
<li>
<p><a href="#mongodb-in-entity-to-one-associations">*-to-one associations</a></p>
</li>
<li>
<p><a href="#mongodb-in-entity-to-many-associations">*-to-many associations</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In this strategy, Hibernate OGM stores the id(s) of the associated entity(ies)
into the entity document itself.
This field stores the id value for to-one associations and an array of id values for to-many associations.
An embedded id will be represented by a nested document.
For indexed collections (i.e. <code>List</code> or <code>Map</code>), the index will be stored along the id.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>When using this strategy the annotations <code>@JoinTable</code> will be ignored because no collection is created
for associations.</p>
</div>
<div class="paragraph">
<p>You can use <code>@JoinColumn</code> to change the name of the field that stores the foreign key (as an example, see
<a href="#mongodb-in-entity-one-to-one-join-column">Unidirectional one-to-one with @JoinColumn</a>).</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="mongodb-in-entity-to-one-associations"><a class="anchor" href="#mongodb-in-entity-to-one-associations"></a>To-one associations</h5>
<div class="exampleblock">
<div class="title">Example 77. Unidirectional one-to-one</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">@Entity
public class Vehicle {

    @Id
    private String id;
    private String brand;

    // getters, setters ...
}


@Entity
public class Wheel {

    @Id
    private String id;
    private double diameter;

    @OneToOne
    private Vehicle vehicle;

    // getters, setters ...
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JSON" data-lang="JSON">{
  "_id" : "V_01",
  "brand" : "Mercedes"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Wheel collection as JSON in MongoDB</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JSON" data-lang="JSON">{
  "_id" : "W001",
  "diameter" : 0,
  "vehicle_id" : "V_01"
}</code></pre>
</div>
</div>
</div>
</div>
<div id="mongodb-in-entity-one-to-one-join-column" class="exampleblock">
<div class="title">Example 78. Unidirectional one-to-one with @JoinColumn</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">@Entity
public class Vehicle {

    @Id
    private String id;
    private String brand;

    // getters, setters ...
}


@Entity
public class Wheel {

    @Id
    private String id;
    private double diameter;

    @OneToOne
    @JoinColumn( name = "part_of" )
    private Vehicle vehicle;

    // getters, setters ...
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JSON" data-lang="JSON">{
  "_id" : "V_01",
  "brand" : "Mercedes"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Wheel collection as JSON in MongoDB</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JSON" data-lang="JSON">{
  "_id" : "W001",
  "diameter" : 0,
  "part_of" : "V_01"
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>In a true one-to-one association, it is possible to share the same id between the two entities
and therefore a foreign key is not required. You can see how to map this type of association in
the following example:</p>
</div>
<div class="exampleblock">
<div class="title">Example 79. Unidirectional one-to-one with @MapsId and @PrimaryKeyJoinColumn</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">@Entity
public class Vehicle {

    @Id
    private String id;
    private String brand;

    // getters, setters ...
}

@Entity
public class Wheel {

    @Id
    private String id;
    private double diameter;

    @OneToOne
    @PrimaryKeyJoinColumn
    @MapsId
    private Vehicle vehicle;

    // getters, setters ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Vehicle collection as JSON in MongoDB</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JSON" data-lang="JSON">{
  "_id" : "V_01",
  "brand" : "Mercedes"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Wheel collection as JSON in MongoDB</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JSON" data-lang="JSON">{
  "_id" : "V_01",
  "diameter" : 0,
}</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 80. Bidirectional one-to-one</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">@Entity
public class Husband {

    @Id
    private String id;
    private String name;

    @OneToOne
    private Wife wife;

    // getters, setters ...
}

@Entity
public class Wife {

    @Id
    private String id;
    private String name;

    @OneToOne
    private Husband husband;

    // getters, setters ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Husband collection as JSON in MongoDB</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JSON" data-lang="JSON">{
  "_id" : "alex",
  "name" : "Alex",
  "wife" : "bea"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Wife collection as JSON in MongoDB</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JSON" data-lang="JSON">{
  "_id" : "bea",
  "name" : "Bea",
  "husband" : "alex"
}</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 81. Bidirectional one-to-one, one-to-many (Mapping to the same Entity)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">@Entity
public class Person {

    @Id
    private String name;
    @OneToOne
    private Person spouse;
    @OneToMany
    private List&lt;Person&gt; children;

    // getters, setters ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Person  collection as JSON in MongoDB</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JSON" data-lang="JSON">{ "_id" : "Nick", "spouse_name" : "Kate", "children" : [ "Louis", "Tom", "Alex" ] }
{ "_id" : "Tom", "spouse_name" : "Mary" }
{ "_id" : "Louis" }
{ "_id" : "Kate", "spouse_name" : "Nick", "children" : [ "Louis", "Tom", "Alex" ] }
{ "_id" : "Mary", "spouse_name" : "Tom" }
{ "_id" : "Alex" }</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 82. Unidirectional many-to-one</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">@Entity
public class JavaUserGroup {

    @Id
    private String jugId;
    private String name;

    // getters, setters ...
}

@Entity
public class Member {

    @Id
    private String id;
    private String name;

    @ManyToOne
    private JavaUserGroup memberOf;

    // getters, setters ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>JavaUserGroup collection as JSON in MongoDB</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JSON" data-lang="JSON">{
    "_id" : "summer_camp",
    "name" : "JUG Summer Camp"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Member collection as JSON in MongoDB</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JSON" data-lang="JSON">{
    "_id" : "jerome",
    "name" : "Jerome"
    "memberOf_jugId" : "summer_camp"
}
{
    "_id" : "emmanuel",
    "name" : "Emmanuel Bernard"
    "memberOf_jugId" : "summer_camp"
}</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 83. Bidirectional many-to-one</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">@Entity
public class SalesForce {

    @Id
    private String id;
    private String corporation;

    @OneToMany(mappedBy = "salesForce")
    private Set&lt;SalesGuy&gt; salesGuys = new HashSet&lt;SalesGuy&gt;();

    // getters, setters ...
}

@Entity
public class SalesGuy {
    private String id;
    private String name;

    @ManyToOne
    private SalesForce salesForce;

    // getters, setters ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>SalesForce collection</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JSON" data-lang="JSON">{
    "_id" : "red_hat",
    "corporation" : "Red Hat",
    "salesGuys" : [ "eric", "simon" ]
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>SalesGuy collection</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JSON" data-lang="JSON">{
    "_id" : "eric",
    "name" : "Eric"
    "salesForce_id" : "red_hat",
}
{
    "_id" : "simon",
    "name" : "Simon",
    "salesForce_id" : "red_hat"
}</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 84. Bidirectional many-to-one between entities with embedded ids</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">@Entity
public class Game {

    @EmbeddedId
    private GameId id;

    private String name;

    @ManyToOne
    private Court playedOn;

    // getters, setters ...
}


public class GameId implements Serializable {

    private String category;

    @Column(name = "id.gameSequenceNo")
    private int sequenceNo;

    // getters, setters ...
    // equals / hashCode
}

@Entity
public class Court {

    @EmbeddedId
    private CourtId id;

    private String name;

    @OneToMany(mappedBy = "playedOn")
    private Set&lt;Game&gt; games = new HashSet&lt;Game&gt;();

    // getters, setters ...
}

public class CourtId implements Serializable {

    private String countryCode;
    private int sequenceNo;

    // getters, setters ...
    // equals / hashCode
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Court collection</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-JSON" data-lang="JSON">{
    "_id" : {
        "countryCode" : "DE",
        "sequenceNo" : 123
    },
    "name" : "Hamburg Court",
    "games" : [
        { "gameSequenceNo" : 457, "category" : "primary" },
        { "gameSequenceNo" : 456, "category" : "primary" }
    ]
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Game collection</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-JSON" data-lang="JSON">{
    "_id" : {
        "category" : "primary",
        "gameSequenceNo" : 456
    },
    "name" : "The game",
    "playedOn_id" : {
        "countryCode" : "DE",
        "sequenceNo" : 123
    }
}
{
    "_id" : {
        "category" : "primary",
        "gameSequenceNo" : 457
    },
    "name" : "The other game",
    "playedOn_id" : {
        "countryCode" : "DE",
        "sequenceNo" : 123
    }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Here we see that the embedded id is represented as a nested document
and directly referenced by the associations.</p>
</div>
</div>
<div class="sect4">
<h5 id="mongodb-in-entity-to-many-associations"><a class="anchor" href="#mongodb-in-entity-to-many-associations"></a>To-many associations</h5>
<div class="exampleblock">
<div class="title">Example 85. Unidirectional one-to-many</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">@Entity
public class Basket {

    @Id
    private String id;

    private String owner;

    @OneToMany
    private List&lt;Product&gt; products = new ArrayList&lt;Product&gt;();

    // getters, setters ...
}

@Entity
public class Product {

    @Id
    private String name;

    private String description;

    // getters, setters ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Basket collection</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JSON" data-lang="JSON">{
  "_id" : "davide_basket",
  "owner" : "Davide",
  "products" : [ "Beer", "Pretzel" ]
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Product collection</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JSON" data-lang="JSON">{
  "_id" : "Pretzel",
  "description" : "Glutino Pretzel Sticks"
}
{
  "_id" : "Beer",
  "description" : "Tactical nuclear penguin"
}</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 86. Unidirectional one-to-many with @OrderColumn</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">@Entity
public class Basket {

    @Id
    private String id;

    private String owner;

    @OneToMany
    private List&lt;Product&gt; products = new ArrayList&lt;Product&gt;();

    // getters, setters ...
}

@Entity
public class Product {

    @Id
    private String name;

    private String description;

    // getters, setters ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Basket collection</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JSON" data-lang="JSON">{
  "_id" : "davide_basket",
  "owner" : "Davide",
  "products" : [
    {
      "products_name" : "Pretzel",
      "products_ORDER" : 1
    },
    {
      "products_name" : "Beer",
      "products_ORDER" : 0
    }
  ]
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Product collection</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JSON" data-lang="JSON">{
  "_id" : "Pretzel",
  "description" : "Glutino Pretzel Sticks"
}
{
  "_id" : "Beer",
  "description" : "Tactical nuclear penguin"
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>A map can be used to represent an association,
in this case Hibernate OGM will store the key of the map
and the associated id.</p>
</div>
<div class="exampleblock">
<div class="title">Example 87. Unidirectional one-to-many using maps with defaults</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">@Entity
public class User {

    @Id
    private String id;

    @OneToMany
    private Map&lt;String, Address&gt; addresses = new HashMap&lt;String, Address&gt;();

    // getters, setters ...
}

@Entity
public class Address {

    @Id
    private String id;
    private String city;

    // getters, setters ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>User collection as JSON in MongoDB</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JSON" data-lang="JSON">{
  "_id" : "user_001",
  "addresses" : [
    {
      "work" : "address_001",
      "home" : "address_002"
    }
  ]
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Address collection as JSON in MongoDB</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JSON" data-lang="JSON">{ "_id" : "address_001", "city" : "Rome" }
{ "_id" : "address_002", "city" : "Paris" }</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>If the map value cannot be represented by a single field (e.g. when referencing a type with a composite id
or using an embeddable type as map value type),
a sub-document containing all the required fields will be stored as value.</p>
</div>
<div class="paragraph">
<p>If the map key either is not of type <code>String</code> or it is made up of several columns (composite map key),
the optimized structure shown in the example above cannot be used as MongoDB only allows for Strings as field names.
In that case the association will be represented by a list of sub-documents, also containing the map key column(s).
You can use <code>@MapKeyColumn</code> to rename the field containing the key of the map,
otherwise it will default to "&lt;%COLLECTION_ROLE%&gt;_KEY", e.g. "addresses_KEY".</p>
</div>
<div class="exampleblock">
<div class="title">Example 88. Unidirectional one-to-many using maps with @MapKeyColumn</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">@Entity
public class User {

    @Id
    private String id;

    @OneToMany
    @MapKeyColumn(name = "addressType")
    private Map&lt;Long, Address&gt; addresses = new HashMap&lt;Long, Address&gt;();

    // getters, setters ...
}

@Entity
public class Address {

    @Id
    private String id;
    private String city;

    // getters, setters ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>User collection as JSON in MongoDB</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JSON" data-lang="JSON">{
  "_id" : "user_001",
  "addresses" : [
    {
      "addressType" : 1,
      "addresses_id" : "address_001"
    },
    {
      "addressType" : 2,
      "addresses_id" : "address_002"
    }
  ]
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Address collection as JSON in MongoDB</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JSON" data-lang="JSON">{ "_id" : "address_001", "city" : "Rome" }
{ "_id" : "address_002", "city" : "Paris" }</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>In case you want to enforce the list-style represention also for maps with a single key column of type <code>String</code>
(e.g. when reading back data persisted by earlier versions of Hibernate OGM),
you can do so by setting the option <code>hibernate.ogm.datastore.document.map_storage</code> to the value <code>AS_LIST</code>.</p>
</div>
<div class="exampleblock">
<div class="title">Example 89. Unidirectional many-to-many using in entity strategy</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">@Entity
public class Student {

    @Id
    private String id;
    private String name;

    // getters, setters ...
}

@Entity
public class ClassRoom {

    @Id
    private long id;
    private String lesson;

    @ManyToMany
    private List&lt;Student&gt; students = new ArrayList&lt;Student&gt;();

    // getters, setters ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Student collection</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JSON" data-lang="JSON">{
  "_id" : "john",
  "name" :"John Doe" }
{
  "_id" : "mario",
  "name" : "Mario Rossi"
}
{
  "_id" : "kate",
  "name" : "Kate Doe"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>ClassRoom collection</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JSON" data-lang="JSON">{
  "_id" : NumberLong(1),
  "lesson" : "Math"
  "students" : [
     "mario",
     "john"
  ]
}
{
  "_id" : NumberLong(2),
  "lesson" : "English"
  "students" : [
     "mario",
     "kate"
  ]
}</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 90. Bidirectional many-to-many</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">@Entity
public class AccountOwner {

    @Id
    private String id;

    private String SSN;

    @ManyToMany
    private Set&lt;BankAccount&gt; bankAccounts;

    // getters, setters ...
}

@Entity
public class BankAccount {

    @Id
    private String id;

    private String accountNumber;

    @ManyToMany( mappedBy = "bankAccounts" )
    private Set&lt;AccountOwner&gt; owners = new HashSet&lt;AccountOwner&gt;();

    // getters, setters ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>AccountOwner collection</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JSON" data-lang="JSON">{
    "_id" : "owner_1",
    "SSN" : "0123456"
    "bankAccounts" : [ "account_1" ]
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>BankAccount collection</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JSON" data-lang="JSON">{
    "_id" : "account_1",
    "accountNumber" : "X2345000"
    "owners" : [ "owner_1", "owner2222" ]
}</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 91. Ordered list with embedded id</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">@Entity
public class Race {
    @EmbeddedId
    private RaceId raceId;

    @OrderColumn(name = "ranking")
    @OneToMany @JoinTable(name = "Race_Runners")
    private List&lt;Runner&gt; runnersByArrival = new ArrayList&lt;Runner&gt;();

    // getters, setters ...
}

public class RaceId implements Serializable {
    private int federationSequence;
    private int federationDepartment;

    // getters, setters, equals, hashCode
}

@Entity
public class Runner {
    @EmbeddedId
    private RunnerId runnerId;
    private int age;

    // getters, setters ...
}

public class RunnerId implements Serializable {
    private String firstname;
    private String lastname;

    // getters, setters, equals, hashCode
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Race collection</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-JSON" data-lang="JSON">{
    "_id": {
        "federationDepartment": 75,
        "federationSequence": 23
    },
    "runnersByArrival": [{
        "firstname": "Pere",
        "lastname": "Noel",
        "ranking": 1
    }, {
        "firstname": "Emmanuel",
        "lastname": "Bernard",
        "ranking": 0
    }]
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Runner collection</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-JSON" data-lang="JSON">{
    "_id": {
        "firstname": "Pere",
        "lastname": "Noel"
    },
    "age": 105
} {
    "_id": {
        "firstname": "Emmanuel",
        "lastname": "Bernard"
    },
    "age": 37
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="mongodb-collection-per-association-strategy"><a class="anchor" href="#mongodb-collection-per-association-strategy"></a>One collection per association strategy</h5>
<div class="paragraph">
<p>In this strategy, Hibernate OGM creates a MongoDB collection per association
in which it will store all navigation information for that particular association.</p>
</div>
<div class="paragraph">
<p>This is the strategy closest to the relational model.
If an entity A is related to B and C, 2 collections will be created.
The name of this collection is made of the association table concatenated with <code>associations_</code>.</p>
</div>
<div class="paragraph">
<p>For example, if the <code>BankAccount</code> and <code>Owner</code> are related,
the collection used to store will be named <code>associations_Owner_BankAccount</code>. You can rename
The prefix is useful to quickly identify the association collections from the entity collections.
You can also decide to rename the collection representing the association using <code>@JoinTable</code>
(see <a href="#mongodb-one-collection-strategy-join-table">an example</a>)</p>
</div>
<div class="paragraph">
<p>Each document of an association collection has the following structure:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>_id</code> contains the id of the owner of relationship</p>
</li>
<li>
<p><code>rows</code> contains all the id of the related entities</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The preferred approach is to use the <a href="#mongodb-in-entity-strategy">in-entity strategy</a>
but this approach can alleviate the problem of having documents that are too big.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="exampleblock">
<div class="title">Example 92. Unidirectional relationship</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JSON" data-lang="JSON">{
    "_id" : { "owners_id" : "owner0001" },
    "rows" : [
        "accountABC",
        "accountXYZ"
    ]
}</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 93. Bidirectional relationship</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JSON" data-lang="JSON">{
    "_id" : { "owners_id" : "owner0001" },
    "rows" : [ "accountABC", "accountXYZ" ]
}
{
    "_id" : { "bankAccounts_id" : "accountXYZ" },
    "rows" : [ "owner0001" ]
}</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This strategy won&#8217;t affect *-to-one associations or embedded collections.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="exampleblock">
<div class="title">Example 94. Unidirectional one-to-many using one collection per strategy</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">@Entity
public class Basket {

    @Id
    private String id;

    private String owner;

    @OneToMany
    private List&lt;Product&gt; products = new ArrayList&lt;Product&gt;();

    // getters, setters ...
}

@Entity
public class Product {

    @Id
    private String name;

    private String description;

    // getters, setters ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Basket collection</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JSON" data-lang="JSON">{
  "_id" : "davide_basket",
  "owner" : "Davide"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Product collection</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JSON" data-lang="JSON">{
  "_id" : "Pretzel",
  "description" : "Glutino Pretzel Sticks"
}
{
  "_id" : "Beer",
  "description" : "Tactical nuclear penguin"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>associations_Basket_Product collection</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JSON" data-lang="JSON">{
  "_id" : { "Basket_id" : "davide_basket" },
  "rows" : [ "Beer", "Pretzel" ]
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The order of the element in the list might be preserved using @OrderColumn.
Hibernate OGM will store the order adding an additional fieldd to the document
containing the association.</p>
</div>
<div class="exampleblock">
<div class="title">Example 95. Unidirectional one-to-many using one collection per strategy with @OrderColumn</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">@Entity
public class Basket {

    @Id
    private String id;

    private String owner;

    @OneToMany
    @OrderColumn
    private List&lt;Product&gt; products = new ArrayList&lt;Product&gt;();

    // getters, setters ...
}

@Entity
public class Product {

    @Id
    private String name;

    private String description;

    // getters, setters ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Basket collection</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JSON" data-lang="JSON">{
  "_id" : "davide_basket",
  "owner" : "Davide"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Product collection</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JSON" data-lang="JSON">{
  "_id" : "Pretzel",
  "description" : "Glutino Pretzel Sticks"
}
{
  "_id" : "Beer",
  "description" : "Tactical nuclear penguin"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>associations_Basket_Product collection</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JSON" data-lang="JSON">{
  "_id" : { "Basket_id" : "davide_basket" },
  "rows" : [
    {
      "products_name" : "Pretzel",
      "products_ORDER" : 1
    },
    {
      "products_name" : "Beer",
      "products_ORDER" : 0
    }
  ]
}</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 96. Unidirectional many-to-many using one collection per association strategy</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">@Entity
public class Student {

    @Id
    private String id;
    private String name;

    // getters, setters ...
}

@Entity
public class ClassRoom {

    @Id
    private long id;
    private String lesson;

    @ManyToMany
    private List&lt;Student&gt; students = new ArrayList&lt;Student&gt;();

    // getters, setters ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Student collection</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JSON" data-lang="JSON">{
  "_id" : "john",
  "name" : "John Doe"
}
{
  "_id" : "mario",
  "name" : "Mario Rossi"
}
{
  "_id" : "kate",
  "name" : "Kate Doe"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>ClassRoom collection</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JSON" data-lang="JSON">{
  "_id" : NumberLong(1),
  "lesson" : "Math"
}
{
  "_id" : NumberLong(2),
  "lesson" : "English"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>associations_ClassRoom_Student</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JSON" data-lang="JSON">{
  "_id" : {
    "ClassRoom_id" : NumberLong(1),
  },
  "rows" : [ "john", "mario" ]
}
{
  "_id" : {
    "ClassRoom_id" : NumberLong(2),
  },
  "rows" : [ "mario", "kate" ]
}</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 97. Bidirectional many-to-many using one collection per association strategy</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">@Entity
public class AccountOwner {

    @Id
    private String id;

    private String SSN;

    @ManyToMany
    private Set&lt;BankAccount&gt; bankAccounts;

    // getters, setters ...
}

@Entity
public class BankAccount {

    @Id
    private String id;

    private String accountNumber;

    @ManyToMany(mappedBy = "bankAccounts")
    private Set&lt;AccountOwner&gt; owners = new HashSet&lt;AccountOwner&gt;();

    // getters, setters ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>AccountOwner collection</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JSON" data-lang="JSON">{
  "_id" : "owner_1",
  "SSN" : "0123456"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>BankAccount collection</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JSON" data-lang="JSON">{
  "_id" : "account_1",
  "accountNumber" : "X2345000"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>associations_AccountOwner_BankAccount collection</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JSON" data-lang="JSON">{
  "_id" : {
    "bankAccounts_id" : "account_1"
  },
  "rows" : [ "owner_1" ]
}
{
  "_id" : {
    "owners_id" : "owner_1"
  },
  "rows" : [ "account_1" ]
}</code></pre>
</div>
</div>
</div>
</div>
<div id="mongodb-one-collection-strategy-join-table" class="paragraph">
<p>You can change the name of the collection containing the association using the <code>@JoinTable</code> annotation.
In the following example, the name of the collection containing the association is <code>OwnerBankAccounts</code>
(instead of the default <code>associations_AccountOwner_BankAccount</code>)</p>
</div>
<div class="exampleblock">
<div class="title">Example 98. Bidirectional many-to-many using one collection per association strategy and @JoinTable</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">@Entity
public class AccountOwner {

    @Id
    private String id;

    private String SSN;

    @ManyToMany
    @JoinTable( name = "OwnerBankAccounts" )
    private Set&lt;BankAccount&gt; bankAccounts;

    // getters, setters ...
}

@Entity
public class BankAccount {

    @Id
    private String id;

    private String accountNumber;

    @ManyToMany(mappedBy = "bankAccounts")
    private Set&lt;AccountOwner&gt; owners = new HashSet&lt;AccountOwner&gt;();

    // getters, setters ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>AccountOwner collection</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JSON" data-lang="JSON">{
  "_id" : "owner_1",
  "SSN" : "0123456"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>BankAccount collection</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JSON" data-lang="JSON">{
  "_id" : "account_1",
  "accountNumber" : "X2345000"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>OwnerBankAccount</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JSON" data-lang="JSON">{
  "_id" : {
    "bankAccounts_id" : "account_1"
  },
  "rows" : [ "owner_1" ]
}
{
  "_id" : {
    "owners_id" : "owner_1"
  },
  "rows" : [ "account_1" ]
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="mongodb-association-document-strategy"><a class="anchor" href="#mongodb-association-document-strategy"></a>Global collection strategy</h5>
<div class="paragraph">
<p>With this strategy, Hibernate OGM creates a single collection named <code>Associations</code>
in which it will store all navigation information for all associations.
Each document of this collection is structured in 2 parts.
The first is the <code>_id</code> field which contains the identifier information
of the association owner and the name of the association table.
The second part is the <code>rows</code> field which stores (into an embedded collection) all ids
that the current instance is related to.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This strategy won&#8217;t affect *-to-one associations or embedded collections.</p>
</div>
<div class="paragraph">
<p>Generally, you should not make use of this strategy
unless embedding the association information proves to be too big for your document
and you wish to separate them.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="exampleblock">
<div class="title">Example 99. Associations collection containing unidirectional association</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JSON" data-lang="JSON">{
    "_id": {
        "owners_id": "owner0001",
        "table": "AccountOwner_BankAccount"
    },
    "rows": [ "accountABC", "accountXYZ" ]
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>For a bidirectional relationship, another document is created where ids are reversed.
Don&#8217;t worry, Hibernate OGM takes care of keeping them in sync:</p>
</div>
<div class="exampleblock">
<div class="title">Example 100. Associations collection containing a bidirectional association</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JSON" data-lang="JSON">{
    "_id": {
        "owners_id": "owner0001",
        "table": "AccountOwner_BankAccount"
    },
    "rows": [ "accountABC", "accountXYZ" ]
}
{
    "_id": {
        "bankAccounts_id": "accountXYZ",
        "table": "AccountOwner_BankAccount"
    },
    "rows": [ "owner0001" ]
}</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 101. Unidirectional one-to-many using global collection strategy</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">@Entity
public class Basket {

    @Id
    private String id;

    private String owner;

    @OneToMany
    private List&lt;Product&gt; products = new ArrayList&lt;Product&gt;();

    // getters, setters ...
}

@Entity
public class Product {

    @Id
    private String name;

    private String description;

    // getters, setters ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Basket collection</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JSON" data-lang="JSON">{
  "_id" : "davide_basket",
  "owner" : "Davide"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Product collection</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JSON" data-lang="JSON">{
  "_id" : "Pretzel",
  "description" : "Glutino Pretzel Sticks"
}
{
  "_id" : "Beer",
  "description" : "Tactical nuclear penguin"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Associations collection</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JSON" data-lang="JSON">{
  "_id" : {
    "Basket_id" : "davide_basket",
    "table" : "Basket_Product"
  },
  "rows" : [
    {
      "products_name" : "Pretzel",
      "products_ORDER" : 1
    },
    {
      "products_name" : "Beer",
    "products_ORDER" : 0
    }
  ]
}</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 102. Unidirectional one-to-many using global collection strategy with <code>@JoinTable</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">@Entity
public class Basket {

    @Id
    private String id;

    private String owner;

    @OneToMany
    // It will change the value stored in the field table in the Associations collection
    @JoinTable( name = "BasketContent" )
    private List&lt;Product&gt; products = new ArrayList&lt;Product&gt;();

    // getters, setters ...
}

@Entity
public class Product {

    @Id
    private String name;

    private String description;

    // getters, setters ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Basket collection</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JSON" data-lang="JSON">{
  "_id" : "davide_basket",
  "owner" : "Davide"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Product collection</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JSON" data-lang="JSON">{
  "_id" : "Pretzel",
  "description" : "Glutino Pretzel Sticks"
}
{
  "_id" : "Beer",
  "description" : "Tactical nuclear penguin"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Associations collection</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JSON" data-lang="JSON">{
  "_id" : {
    "Basket_id" : "davide_basket",
    "table" : "BasketContent"
  },
  "rows" : [ "Beer", "Pretzel" ]
}</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 103. Unidirectional many-to-many using global collection strategy</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">@Entity
public class Student {

    @Id
    private String id;
    private String name;

    // getters, setters ...
}

@Entity
public class ClassRoom {

    @Id
    private long id;
    private String lesson;

    @ManyToMany
    private List&lt;Student&gt; students = new ArrayList&lt;Student&gt;();

    // getters, setters ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Student collection</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JSON" data-lang="JSON">{
  "_id" : "john",
  "name" : "John Doe"
}
{
  "_id" : "mario",
  "name" : "Mario Rossi"
}
{
  "_id" : "kate",
  "name" : "Kate Doe"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>ClassRoom collection</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JSON" data-lang="JSON">{
  "_id" : NumberLong(1),
  "lesson" : "Math"
}
{
  "_id" : NumberLong(2),
  "lesson" : "English"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Associations collection</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JSON" data-lang="JSON">{
  "_id" : {
    "ClassRoom_id" : NumberLong(1),
    "table" : "ClassRoom_Student"
  },
  "rows" : [ "john", "mario" ]
}
{
  "_id" : {
    "ClassRoom_id" : NumberLong(2),
    "table" : "ClassRoom_Student"
  },
  "rows" : [ "mario", "kate" ]
}</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 104. Bidirectional many-to-many using global collection strategy</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">@Entity
public class AccountOwner {

    @Id
    private String id;

    private String SSN;

    @ManyToMany
    private Set&lt;BankAccount&gt; bankAccounts;

    // getters, setters ...
}

@Entity
public class BankAccount {

    @Id
    private String id;

    private String accountNumber;

    @ManyToMany(mappedBy = "bankAccounts")
    private Set&lt;AccountOwner&gt; owners = new HashSet&lt;AccountOwner&gt;();

    // getters, setters ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>AccountOwner collection</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JSON" data-lang="JSON">{
  "_id" : "owner0001",
  "SSN" : "0123456"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>BankAccount collection</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JSON" data-lang="JSON">{
  "_id" : "account_1",
  "accountNumber" : "X2345000"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Associations collection</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JSON" data-lang="JSON">{
  "_id" : {
    "bankAccounts_id" : "account_1",
    "table" : "AccountOwner_BankAccount"
    },

  "rows" : [ "owner0001" ]
}
{
  "_id" : {
    "owners_id" : "owner0001",
    "table" : "AccountOwner_BankAccount"
  },

  "rows" : [ "account_1" ]
}</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="ogm-mongodb-indexes-unique-constraints"><a class="anchor" href="#ogm-mongodb-indexes-unique-constraints"></a>10.4. Indexes and unique constraints</h3>
<div class="sect3">
<h4 id="_standard_indexes_and_unique_constraints"><a class="anchor" href="#_standard_indexes_and_unique_constraints"></a>10.4.1. Standard indexes and unique constraints</h4>
<div class="paragraph">
<p>You can create your index and unique constraints in MongoDB using the standard JPA annotations.</p>
</div>
<div class="exampleblock">
<div class="title">Example 105. Creating indexes and unique constraints using JPA annotations</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">@Entity
@Table(indexes = {
    @Index(columnList = "author, name", name = "author_name_idx", unique = true),
    @Index(columnList = "name DESC", name = "name_desc_idx")
})
public class Poem {

    @Id
    private String id;
    private String name;
    private String author;

    @Column(unique = true)
    private String url;

   // getters, setters ...
}</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>MongoDB supports unique constraints via unique indexes. It considers <code>null</code> as a value to be unique: you can only
have one <code>null</code> value per unique index. This is not what is commonly accepted as the definition of a unique constraint in
the JPA world. Thus, by default, we create the unique indexes as <code>sparse</code>: it only indexes defined values so that the
unique constraints accept multiple <code>null</code> values.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_using_mongodb_specific_index_options"><a class="anchor" href="#_using_mongodb_specific_index_options"></a>10.4.2. Using MongoDB specific index options</h4>
<div class="paragraph">
<p>MongoDB supports <a href="https://docs.mongodb.com/manual/reference/method/db.collection.createIndex/">a number of options for
index creation</a>.</p>
</div>
<div class="paragraph">
<p>It is possible to define them using the <code>@IndexOption</code> annotation.</p>
</div>
<div class="exampleblock">
<div class="title">Example 106. Creating indexes with MongoDB specific options</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">@Entity
@Table(indexes = {
    @Index(columnList = "author", name = "author_idx")
})
@IndexOptions(
    @IndexOption(forIndex = "author_idx", options = "{ background : true, sparse : true, partialFilterExpression : { author: 'Verlaine' } }")
)
public class Poem {

    @Id
    private String id;
    private String name;
    private String author;

   // getters, setters ...
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p><code>@IndexOption</code> simply passes the options to MongoDB at index creation: you can use every option available in MongoDB.</p>
</div>
</div>
<div class="sect3">
<h4 id="_full_text_indexes"><a class="anchor" href="#_full_text_indexes"></a>10.4.3. Full text indexes</h4>
<div class="paragraph">
<p>MongoDB supports the ability to create one (and only one) full text index per collection.</p>
</div>
<div class="paragraph">
<p>As JPA does not support the ability to define <code>text</code> as an order in the <code>@Index</code> annotation (only <code>ASC</code> and <code>DESC</code>
are supported), this ability has been included inside the <code>@IndexOption</code> mechanism. You simply need to add <code>text: true</code>
to the options passed to MongoDB, Hibernate OGM interprets it and translates the index to a full text index.</p>
</div>
<div class="exampleblock">
<div class="title">Example 107. Creating a full text index</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">@Entity
@Table(indexes = {
    @Index(columnList = "author, name", name = "author_name_text_idx")
})
@IndexOptions(
    @IndexOption(forIndex = "author_name_text_idx", options = "{ text: true, default_language : 'fr', weights : { author: 2, name: 5 } }")
)
public class Poem {

    @Id
    private String id;
    private String name;
    private String author;

   // getters, setters ...
}</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_transactions"><a class="anchor" href="#_transactions"></a>10.5. Transactions</h3>
<div class="paragraph">
<p>MongoDB does not support transactions.
Only changes applied to the same document are done atomically.
A change applied to more than one document will not be applied atomically.
This problem is slightly mitigated by the fact that Hibernate OGM queues all changes
before applying them during flush time.
So the window of time used to write to MongoDB is smaller than what you would have done manually.</p>
</div>
<div class="paragraph">
<p>We recommend that you still use transaction demarcations with Hibernate OGM
to trigger the flush operation transparently (on commit).
But do not consider rollback as a possibility, this won&#8217;t work.</p>
</div>
</div>
<div class="sect2">
<h3 id="ogm-mongodb-optimisticlocking"><a class="anchor" href="#ogm-mongodb-optimisticlocking"></a>10.6. Optimistic Locking</h3>
<div class="paragraph">
<p>MongoDB does not provide a built-in mechanism for detecting concurrent updates to the same document
but it provides a way to execute atomic find and update operations.
By exploiting this commands Hibernate OGM can detect concurrent modifications to the same document.</p>
</div>
<div class="paragraph">
<p>You can enable optimistic locking detection using the annotation <code>@Version</code>:</p>
</div>
<div class="exampleblock">
<div class="title">Example 108. Optimistic locking detection via <code>@Version</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">@Entity
public class Planet implements Nameable {

    @Id
    private String id;
    private String name;

    @Version
    private int version;

   // getters, setters ...
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre>{
  "_id" : "planet-1",
  "name" : "Pluto",
  "version" : 0
}</pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The <code>@Version</code> annotation define which attribute will keep track of the version of the document,
Hibernate OGM will update the field when required and if two changes from two different sessions (for example)
are applied to the same document a <code>org.hibernate.StaleObjectStateException</code> is thrown.</p>
</div>
<div class="paragraph">
<p>You can use <code>@Column</code> to change the name of the field created on MongoDB:</p>
</div>
<div class="exampleblock">
<div class="title">Example 109. Optimistic locking detection via <code>@Version</code> using <code>@Column</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">@Entity
public class Planet implements Nameable {

    @Id
    private String id;
    private String name;

    @Version
    @Column(name="OPTLOCK")
    private int version;

   // getters, setters ...
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre>{
  "_id" : "planet-1",
  "name" : "Pluto",
  "OPTLOCK" : 0
}</pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="ogm-mongodb-queries"><a class="anchor" href="#ogm-mongodb-queries"></a>10.7. Queries</h3>
<div class="paragraph">
<p>You can express queries in a few different ways:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>using JPQL</p>
</li>
<li>
<p>using a native MongoQL query</p>
</li>
<li>
<p>using a Hibernate Search query (brings advanced full-text and geospatial queries)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>While you can use JPQL for simple queries, you might hit limitations.
The current recommended approach is to use native MongoQL
if your query involves nested (list of) elements.</p>
</div>
<div class="paragraph">
<p>MongoDB doesn&#8217;t require Hibernate Search to run queries.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>In order to reflect changes performed in the current session,
all entities affected by a given query are flushed to the datastore prior to query execution
(that&#8217;s the case for Hibernate ORM as well as Hibernate OGM).</p>
</div>
<div class="paragraph">
<p>For not fully transactional stores such as MongoDB
this can cause changes to be written as a side-effect of running queries
which cannot be reverted by a possible later rollback.</p>
</div>
<div class="paragraph">
<p>Depending on your specific use cases and requirements you may prefer to disable auto-flushing,
e.g. by invoking <code>query.setFlushMode( FlushMode.MANUAL )</code>.
Bear in mind though that query results will then not reflect changes applied within the current session.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_jpql_queries"><a class="anchor" href="#_jpql_queries"></a>10.7.1. JPQL queries</h4>
<div class="paragraph">
<p>Hibernate OGM is a work in progress, so only a sub-set of JPQL constructs is available
when using the JPQL query support. This includes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>simple comparisons using "&lt;", "&lt;=", "=", "&gt;=" and "&gt;"</p>
</li>
<li>
<p><code>IS NULL</code> and <code>IS NOT NULL</code></p>
</li>
<li>
<p>the boolean operators <code>AND</code>, <code>OR</code>, <code>NOT</code></p>
</li>
<li>
<p><code>LIKE</code>, <code>IN</code> and <code>BETWEEN</code></p>
</li>
<li>
<p><code>ORDER BY</code></p>
</li>
<li>
<p>inner <code>JOIN</code> on embedded collections</p>
</li>
<li>
<p>projections of regular and embedded properties</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Queries using these constructs will be transformed into equivalent native MongoDB queries.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Let us know <a href="#ogm-howtocontribute">by opening an issue or sending an email</a>
what query you wish to execute.
Expanding our support in this area is high on our priority list.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="ogm-mongodb-queries-native"><a class="anchor" href="#ogm-mongodb-queries-native"></a>10.7.2. Native MongoDB queries</h4>
<div class="paragraph">
<p>Hibernate OGM also supports certain forms of native queries for MongoDB.
Currently two forms of native queries are available via the MongoDB backend:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>find queries specifying the search criteria only</p>
</li>
<li>
<p>queries specified using the MongoDB CLI syntax (<a href="#ogm-mongodb-cli-syntax">CLI Syntax</a>)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The former always maps results to entity types.
The latter either maps results to entity types or to certain supported forms of projection.
Note that parameterized queries are not supported by MongoDB, so don&#8217;t expect <code>Query#setParameter()</code> to work.</p>
</div>
<div class="paragraph">
<p>You can execute native queries as shown in the following example:</p>
</div>
<div class="exampleblock">
<div class="title">Example 110. Using the JPA API</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">@Entity
public class Poem {

    @Id
    private Long id;

    private String name;

    private String author;

   // getters, setters ...
}

...

javax.persistence.EntityManager em = ...

// criteria-only find syntax
String query1 = "{ $and: [ { name : 'Portia' }, { author : 'Oscar Wilde' } ] }";
Poem poem = (Poem) em.createNativeQuery( query1, Poem.class ).getSingleResult();

// criteria-only find syntax with order-by
String query2 = "{ $query : { author : 'Oscar Wilde' }, $orderby : { name : 1 } }";
List&lt;Poem&gt; poems = em.createNativeQuery( query2, Poem.class ).getResultList();

// projection via CLI-syntax
String query3 = "db.WILDE_POEM.find(" +
    "{ '$query' : { 'name' : 'Athanasia' }, '$orderby' : { 'name' : 1 } }" +
    "{ 'name' : 1 }" +
    ")";

// will contain name and id as MongoDB always returns the id for projections
List&lt;Object[]&gt; poemNames = (List&lt;Object[]&gt;)em.createNativeQuery( query3 ).getResultList();

// projection via CLI-syntax
String query4 = "db.WILDE_POEM.count({ 'name' : 'Athanasia' })";

Object[] count = (Object[])em.createNativeQuery( query4 ).getSingleResult();</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The result of a query is a managed entity (or a list thereof) or a projection of attributes in form of an object array,
just like you would get from a JPQL query.</p>
</div>
<div class="exampleblock">
<div class="title">Example 111. Using the Hibernate native API</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">OgmSession session = ...

String query1 = "{ $and: [ { name : 'Portia' }, { author : 'Oscar Wilde' } ] }";
Poem poem = session.createNativeQuery( query1 )
                      .addEntity( "Poem", Poem.class )
                      .uniqueResult();

String query2 = "{ $query : { author : 'Oscar Wilde' }, $orderby : { name : 1 } }";
List&lt;Poem&gt; poems = session.createNativeQuery( query2 )
                      .addEntity( "Poem", Poem.class )
                      .list();</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Native queries can also be created using the <code>@NamedNativeQuery</code> annotation:</p>
</div>
<div class="exampleblock">
<div class="title">Example 112. Using @NamedNativeQuery</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">@Entity
@NamedNativeQuery(
   name = "AthanasiaPoem",
   query = "{ $and: [ { name : 'Athanasia' }, { author : 'Oscar Wilde' } ] }",
   resultClass = Poem.class )
public class Poem { ... }

...

// Using the EntityManager
Poem poem1 = (Poem) em.createNamedQuery( "AthanasiaPoem" )
                     .getSingleResult();

// Using the Session
Poem poem2 = (Poem) session.getNamedQuery( "AthanasiaPoem" )
                     .uniqueResult();</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Hibernate OGM stores data in a natural way so you can still execute queries using the
MongoDB driver, the main drawback is that the results are going to be raw MongoDB
documents and not managed entities.</p>
</div>
<div class="sect4">
<h5 id="ogm-mongodb-cli-syntax"><a class="anchor" href="#ogm-mongodb-cli-syntax"></a>CLI Syntax</h5>
<div class="paragraph">
<p>Hibernate OGM can execute native queries expressed using the MongoDB CLI syntax with some limitations.
Currently <code>find()</code>, <code>findOne()</code>, <code>findAndModify()</code>, and <code>count()</code> queries are supported. Furthermore, three
types of write queries are supported via the CLI syntax: <code>insert()</code>, <code>remove()</code>, and <code>update()</code>. Other query
types may be supported in future versions.</p>
</div>
<div class="paragraph">
<p>As one would expect, <code>find()</code>, <code>findOne()</code>, <code>findAndModify()</code>, <code>aggregate</code>,
<code>distinct()</code>, and <code>count()</code> can be executed using
<code>javax.persistence.Query.getSingleResult()</code> or <code>javax.persistence.Query.getResultList()</code>, while <code>insert()</code>,
<code>remove()</code>, and <code>update()</code> require using <code>javax.persistence.Query.executeUpdate()</code>. Also note that,
<code>javax.persistence.Query.executeUpdate()</code> may return <code>-1</code> in case execution of a query was not acknowledged
relative to the write concern used.
Via <code>javax.persistence.Query.executeUpdate()</code> it is also possible to run <code>db.Collection.drop()</code>
queries.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p><code>db.Collection.drop()</code> will always return 1. This is because the underlying driver we are
using doesn&#8217;t return any value after the execution of the operation.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The following functions can be used in the provided JSON:
<code>BinData</code>, <code>Date</code>, <code>HexData</code>, <code>ISODate</code>, <code>NumberLong</code>, <code>ObjectId</code>, <code>Timestamp</code>,
<code>RegExp</code>, <code>DBPointer</code>, <code>UUID</code>, <code>GUID</code>, <code>CSUUID</code>, <code>CSGUID</code>, <code>JUUID</code>, <code>JGUID</code>, <code>PYUUID</code>, <code>PYGUID</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p><code>NumberInt</code> is not supported as it is currently not supported by the MongoDB Java driver.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>No cursor operations such as <code>sort()</code> are supported.
Instead use the corresponding MongoDB <a href="http://docs.mongodb.org/manual/reference/operator/query-modifier/">query modifiers</a>
such as <code>$orderby</code> within the criteria parameter.</p>
</div>
<div class="paragraph">
<p>You can limit the results of a query using the <code>setMaxResults(&#8230;&#8203;)</code> method.</p>
</div>
<div class="paragraph">
<p>JSON parameters passed via the CLI syntax must be specified using the
<a href="http://docs.mongodb.org/manual/reference/mongodb-extended-json/">strict mode</a>.
Specifically, keys need to be given within quotes; the only relaxation of this is that single quotes
may be used when specifying attribute names/values to facilitate embedding queries within
Java strings.</p>
</div>
<div class="paragraph">
<p>Note that results of projections are returned as retrieved from the MongoDB driver at the moment and
are not (yet) converted using suitable Hibernate OGM type implementations.
This requirement is tracked under <a href="https://hibernate.atlassian.net/browse/OGM-1031">OGM-1031</a>.</p>
</div>
<div class="exampleblock">
<div class="title">Example 113. CLI syntax examples</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">// Valid syntax
String valid = "db.Poem.find({ \"name\" : \"Athanasia\" })";

String alsoValid = "db.Poem.find({ '$or' : [{'name': 'Athanasia' }, {'name': 'Portia' }]})";

String validAggregation = "db.Poem.aggregate([{ '$match': {'author': { '$regex': 'oscar.*', '$options': 'i' } } }, { '$sort': {'name': -1 } } ])";

// NOT Valid syntax, it will throw an exception: com.mongodb.util.JSONParseException
String notValid =  "db.Poem.find({ name : \"Athanasia\" })";

String alsoNotValid = "db.Poem.find({ $or : [{name: 'Athanasia' }, {name: 'Portia' }]})";</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 114. CLI syntax sort and limit results alternatives</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">String nativeQuery = "db.Poem.find({ '$query': { 'author': 'Oscar Wilde' }, '$orderby' : { 'name' : 1 } })";

// Using hibernate session
List&lt;Poem&gt; result = session.createNativeQuery( nativeQuery )
    .addEntity( Poem.class )
    .setMaxResults( 2 )
    .list();

// Using JPA entity manager
List&lt;Poem&gt; results = em.createNativeQuery( nativeQuery, Poem.class )
    .setMaxResults( 2 )
    .getResultList();</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 115. CLI syntax update examples</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">String updateQuery = "db.Poem.findAndModify({ 'query': {'_id': 1}, 'update': { '$set': { 'author': 'Oscar Wilde' } }, 'new': true })";
List&lt;Poem&gt; updated = session.createNativeQuery( updateQuery ).addEntity( Poem.class ).list();

String insertQuery = "db.Poem.insert({ '_id': { '$numberLong': '11' }, 'author': 'Oscar Wilder', 'name': 'The one and wildest', 'rating': '1' } )";
int inserted = session.createNativeQuery( insertQuery ).executeUpdate();

String removeQuery = "db.Poem.remove({ '_id': { '$numberLong': '11' } })";
int removed = session.createNativeQuery( removeQuery ).executeUpdate();</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Support for the <code>$regexp</code> operator is limited to the string syntax. We do not support the <code>/pattern/</code> syntax as it is not
currently supported by the MongoDB Java driver.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">// Valid syntax
String nativeQuery = "{ $query : { author : { $regex : '^Oscar' } }, $orderby : { name : 1 } }";
List&lt;Poem&gt; result = session.createNativeQuery( nativeQuery ).addEntity( Poem.class ).list();</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="ogm-mongodb-stored-proc-native"><a class="anchor" href="#ogm-mongodb-stored-proc-native"></a>10.7.3. Server-side JavaScript and stored procedures</h4>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This is an experimental feature.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In MongoDB, it is possible to call server-side JavaScript as if it is a stored procedure.
You can use the existing methods in JPA:</p>
</div>
<div class="exampleblock">
<div class="title">Example 116. Calling server-side JavaScript with positional parameters</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">  @Entity
  public class Car {
    @Id
    private Integer id;

    private String brand;

    ...
  }

  EntityManager em = ...
  StoredProcedureQuery storedProcedureQuery = em.createStoredProcedureQuery( "findMostExpensiveCars", Car.class );
  storedProcedureQuery.registerStoredProcedureParameter( "year", Integer.class, ParameterMode.IN );
  storedProcedureQuery.setParameter( "year", 1995 );
  List&lt;Car&gt; cars = storedProcedureQuery.getResultList();</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>This example will work assuming that there is a <code>findMostExpensiveCars</code> JavaScript function in MongoDB
and that the result of the function is a list of cars that can be mapped to the <code>Car</code> entity.</p>
</div>
<div class="exampleblock">
<div class="title">Example 117. Calling server-side JavaScript with Hibernate OGM with positional parameters</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JSON" data-lang="JSON">{
  "result" : [
    { "id":1, "brand":"Bentley" },
    { "id":2, "brand":"Maserati" },
  ]
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>More details about server-side functions can be found in
<a href="https://docs.mongodb.com/manual/core/server-side-JavaScript">the MongoDB reference documentation</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_hibernate_search"><a class="anchor" href="#_hibernate_search"></a>10.7.4. Hibernate Search</h4>
<div class="paragraph">
<p>You can index your entities using Hibernate Search.
That way, a set of secondary indexes independent of MongoDB is maintained by Hibernate Search
and you can run Lucene queries on top of them.
The benefit of this approach is a nice integration at the JPA / Hibernate API level
(managed entities are returned by the queries).
The drawback is that you need to store the Lucene indexes somewhere
(file system, infinispan grid, etc).
Have a look at the Infinispan section (<a href="#ogm-infinispan-indexstorage">Storing a Lucene index in Infinispan</a>)
for more info on how to use Hibernate Search.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_geospatial_support"><a class="anchor" href="#_geospatial_support"></a>10.8. Geospatial support</h3>
<div class="sect3">
<h4 id="_geospatial_fields"><a class="anchor" href="#_geospatial_fields"></a>10.8.1. Geospatial fields</h4>
<div class="paragraph">
<p>Our MongoDB integration supports the ability to declare geospatial fields by using specific Java types that will be
automatically converted to GeoJSON objects stored in MongoDB.</p>
</div>
<div class="paragraph">
<p>We currently support the following types:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>GeoPoint</code>, stored as a GeoJSON Point</p>
</li>
<li>
<p><code>GeoMultiPoint</code>, stored as a GeoJSON MultiPoint</p>
</li>
<li>
<p><code>GeoLineString</code>, stored as a GeoJSON LineString</p>
</li>
<li>
<p><code>GeoMultiLineString</code>, stored as a GeoJSON MultiLineString</p>
</li>
<li>
<p><code>GeoPolygon</code>, stored as a GeoJSON Polygon</p>
</li>
<li>
<p><code>GeoMultiPolygon</code>, stored as a GeoJSON MultiPolygon</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You can find more information about these types and their constraints in the
<a href="https://docs.mongodb.com/manual/reference/geojson/">MongoDB documentation</a>.</p>
</div>
<div class="exampleblock">
<div class="title">Example 118. Declaring a geospatial field</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">@Entity
public class Restaurant {

    // [...]

    private GeoPoint location;
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>These Java types come with handy constructors and helpers to help manipulate them.</p>
</div>
<div class="exampleblock">
<div class="title">Example 119. Instantiating a polygon</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">GeoPolygon polygon = new GeoPolygon(
        new GeoPoint( 4.814922, 45.7753612 ),
        new GeoPoint( 4.8160825, 45.7327172 ),
        new GeoPoint( 4.9281299, 45.7211302 ),
        new GeoPoint( 4.8706127, 45.786724 ),
        new GeoPoint( 4.814922, 45.7753612 )
);</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_geospatial_indexes_and_queries"><a class="anchor" href="#_geospatial_indexes_and_queries"></a>10.8.2. Geospatial indexes and queries</h4>
<div class="paragraph">
<p>To be able to run optimized queries on geospatial fields, you need to declare spatial indexes.</p>
</div>
<div class="paragraph">
<p>You can leverage your usual annotations to declare the indexes directly on your entities.</p>
</div>
<div class="exampleblock">
<div class="title">Example 120. Declaring a geospatial index</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">@Entity
@Table(indexes = {
        @Index(columnList = "location", name = "location_spatial_idx")
})
@IndexOptions(
        @IndexOption(forIndex = "location_spatial_idx", options = "{ _type: '2dsphere' }")
)
public class Restaurant {

    // [...]

    private GeoPoint location;
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Note that you need to precise the type of the index using an <code>@IndexOption</code> annotation.</p>
</div>
<div class="paragraph">
<p>The next step is to execute a geospatial query using a native query.</p>
</div>
<div class="exampleblock">
<div class="title">Example 121. Finding entities around a point</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">GeoPoint geoPoint = new GeoPoint( 4.8520035, 45.7498209 );

Query query = session
        .createNativeQuery( "{ location: { $near: { $geometry: " + geoPoint.toBsonDocument() + ", $maxDistance: 500 } } }" )
        .addEntity( Restaurant.class );
List&lt;Restaurant&gt; result = query.list();</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 122. Finding entities within a polygon</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">GeoPolygon geoPolygon = new GeoPolygon(
        new GeoPoint( 4.814922, 45.7753612 ),
        new GeoPoint( 4.8160825, 45.7327172 ),
        new GeoPoint( 4.9281299, 45.7211302 ),
        new GeoPoint( 4.8706127, 45.786724 ),
        new GeoPoint( 4.814922, 45.7753612 )
);

Query query = session
        .createNativeQuery( "{ location: { $geoWithin: { $geometry: " + geoPolygon.toBsonDocument() + " } } }" )
        .addEntity( Restaurant.class );
List&lt;Restaurant&gt; result = query.list();</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>To learn more about MongoDB spatial indexes and queries, please refer to the
<a href="https://docs.mongodb.com/manual/geospatial-queries/">MongoDB documentation</a>.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="ogm-neo4j"><a class="anchor" href="#ogm-neo4j"></a>11. Neo4j</h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="http://www.neo4j.org">Neo4j</a> is a robust (fully ACID) transactional property graph database.
This kind of databases are suited for those type of problems that can be represented with a graph
like social relationships or road maps for example.</p>
</div>
<div class="paragraph">
<p>Hibernate OGM can connect to an embedded Neo4j or a remote server.
The connection to the remote server can occur via the Bolt protocol or the HTTP API.</p>
</div>
<div class="sect2">
<h3 id="_how_to_add_neo4j_integration"><a class="anchor" href="#_how_to_add_neo4j_integration"></a>11.1. How to add Neo4j integration</h3>
<div class="paragraph">
<div class="title">1. Add the dependencies to your project</div>
<p>If your project uses Maven you can add this to the pom.xml:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-XML" data-lang="XML">&lt;dependency&gt;
    &lt;groupId&gt;org.hibernate.ogm&lt;/groupId&gt;
    &lt;artifactId&gt;hibernate-ogm-neo4j&lt;/artifactId&gt;
    &lt;version&gt;5.4.1.Final&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Alternatively you can find the required libraries in the distribution package on
<a href="https://downloads.sourceforge.net/project/hibernate/hibernate-ogm/5.4.1.Final/hibernate-ogm-5.4.1.Final-dist.zip">SourceForge</a></p>
</div>
<div class="paragraph">
<div class="title">2. Use the following properties</div>
<p>If you want to use Neo4j in embedded mode:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-properties" data-lang="properties">hibernate.ogm.datastore.provider = neo4j_embedded
hibernate.ogm.neo4j.database_path = C:\example\mydb</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>If you want to connect to a remote server without authentication on localhost, you can use:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-properties" data-lang="properties">hibernate.ogm.datastore.provider = neo4j_bolt</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>or</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-properties" data-lang="properties">hibernate.ogm.datastore.provider = neo4j_http</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The difference between <code>neo4j_bolt</code> and <code>neo4j_http</code> is that in the first case Hibernate OGM
will connect to the server using the Bolt protocol, in the second case it will use the HTTP interface.</p>
</div>
<div class="paragraph">
<p>You can select a different host, port and enable authentication with the following additional properties:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-properties" data-lang="properties">hibernate.ogm.datastore.provider = neo4j_bolt # or neo4j_http
hibernate.ogm.datastore.host = example.com:8989
hibernate.ogm.datastore.username = example_username
hibernate.ogm.datastore.password = example_password</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The Neo4j dialects don&#8217;t require Hibernate Search to run JPQL or HQL queries.</p>
</div>
</div>
<div class="sect2">
<h3 id="_configuring_neo4j"><a class="anchor" href="#_configuring_neo4j"></a>11.2. Configuring Neo4j</h3>
<div class="paragraph">
<p>The following properties are available to configure Neo4j support:</p>
</div>
<div class="dlist">
<div class="title">Neo4j datastore configuration properties</div>
<dl>
<dt class="hdlist1">hibernate.ogm.neo4j.database_path</dt>
<dd>
<p>The absolute path representing the location of the Neo4j database. Example: <code>C:\neo4jdb\mydb</code></p>
</dd>
<dt class="hdlist1">hibernate.ogm.neo4j.configuration_resource_name (optional)</dt>
<dd>
<p>Location of the Neo4j embedded properties file. It can be an URL, name of a classpath resource or file system path.</p>
</dd>
<dt class="hdlist1">hibernate.schema_update.unique_constraint_strategy (optional)</dt>
<dd>
<p>If set to <code>SKIP</code>, Hibernate OGM won&#8217;t create any unique constraints on the nodes representing the entities.
This property won&#8217;t affect the unique constraints generated for sequences.
Other possible values (defined on the <code>org.hibernate.tool.hbm2ddl.UniqueConstraintSchemaUpdateStrategy</code> enum) are <code>DROP_RECREATE_QUIETLY</code> and <code>RECREATE_QUIETLY</code>
but the effect will be the same (since Neo4j constraints don&#8217;t have a name):
keep the existing constraints and create the missing one.
Default value is <code>DROP_RECREATE_QUIETLY</code>.</p>
</dd>
<dt class="hdlist1">hibernate.ogm.datastore.host (optional)</dt>
<dd>
<p>The host name and the port to use when connecting to a remote server.
Default value for HTTP is <code>localhost:7474</code>.
Default value for Bolt is <code>localhost:7687</code>.</p>
</dd>
<dt class="hdlist1">hibernate.ogm.datastore.username (optional)</dt>
<dd>
<p>The authentication username for the remote server.
Hibernate OGM will try to authenticate only if this property is set.</p>
</dd>
<dt class="hdlist1">hibernate.ogm.datastore.password (optional)</dt>
<dd>
<p>The password to use when connecting remotely.</p>
</dd>
<dt class="hdlist1">hibernate.ogm.neo4j.client.connection_pool_size (optional)</dt>
<dd>
<p>The size of the client connection pool when using the http protocol.
Default value is 10.</p>
</dd>
<dt class="hdlist1">hibernate.connection.resource</dt>
<dd>
<p>If you use Bolt interface you can lookup datastore client. See <a href="#integration-with-wildfly-nosql">Integration with WildFly NoSQL</a>.</p>
</dd>
</dl>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>When bootstrapping a session factory or entity manager factory programmatically,
you should use the constants defined on <code>org.hibernate.ogm.datastore.neo4j.Neo4jProperties</code>
when specifying the configuration properties listed above.</p>
</div>
<div class="paragraph">
<p>Common properties shared between stores are declared on <code>OgmProperties</code>
(a super interface of <code>Neo4jProperties</code>).</p>
</div>
<div class="paragraph">
<p>For maximum portability between stores, use the most generic interface possible.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="ogm-neo4j-storage-principles"><a class="anchor" href="#ogm-neo4j-storage-principles"></a>11.3. Storage principles</h3>
<div class="paragraph">
<p>Hibernate OGM tries to make the mapping to the underlying datastore as natural as possible
so that third party applications not using Hibernate OGM can still read
and update the same datastore.</p>
</div>
<div class="paragraph">
<p>To make things simple, each entity is represented by a node,
each embedded object is also represented by a node.
Links between entities (whether to-one to to-many associations)
are represented by relationships between nodes.
Entity and embedded nodes are labelled <code>ENTITY</code> and <code>EMBEDDED</code> respectively.</p>
</div>
<div class="sect3">
<h4 id="ogm-neo4j-built-in-types"><a class="anchor" href="#ogm-neo4j-built-in-types"></a>11.3.1. Properties and built-in types</h4>
<div class="paragraph">
<p>Each entity is represented by a node.
Each property or more precisely column is represented by an attribute of this node.</p>
</div>
<div class="paragraph">
<p>The following types (and corresponding primitives) get passed to Neo4j without any conversion:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>java.lang.Boolean</code>; Optionally the annotations <code>@Type(type = "true_false")</code>, <code>@Type(type = "yes_no")</code> and <code>@Type(type = "numeric_boolean")</code> can be used to map boolean properties to the characters 'T'/'F', 'Y'/'N' or the int values 0/1, respectively.</p>
</li>
<li>
<p><code>java.lang.Character</code></p>
</li>
<li>
<p><code>java.lang.Byte</code></p>
</li>
<li>
<p><code>java.lang.Short</code></p>
</li>
<li>
<p><code>java.lang.Integer</code></p>
</li>
<li>
<p><code>java.lang.Long</code></p>
</li>
<li>
<p><code>java.lang.Float</code></p>
</li>
<li>
<p><code>java.lang.Double</code></p>
</li>
<li>
<p><code>java.lang.String</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The following types get converted into <code>java.lang.String</code>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>java.math.BigDecimal</code></p>
</li>
<li>
<p><code>java.math.BigInteger</code></p>
</li>
<li>
<p><code>java.util.Calendar</code></p>
<div class="literalblock">
<div class="content">
<pre>stored as `String` with the format "yyyy/MM/dd HH:mm:ss:SSS Z"</pre>
</div>
</div>
</li>
<li>
<p><code>java.util.Date</code></p>
<div class="literalblock">
<div class="content">
<pre>stored as `String` with the format "yyyy/MM/dd HH:mm:ss:SSS Z"</pre>
</div>
</div>
</li>
<li>
<p><code>java.util.UUID</code></p>
</li>
<li>
<p><code>java.util.URL</code></p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Hibernate OGM doesn&#8217;t store null values in Neo4J,
setting a value to null is the same as removing the corresponding entry
from Neo4J.</p>
</div>
<div class="paragraph">
<p>This can have consequences when it comes to queries on null value.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_entities_4"><a class="anchor" href="#_entities_4"></a>11.3.2. Entities</h4>
<div class="paragraph">
<p>Entities are stored as Neo4j nodes,
which means each entity property will be translated into a property of the node.
The name of the table mapping the entity is used as label.</p>
</div>
<div class="paragraph">
<p>You can use the name property of the <code>@Table</code> and <code>@Column</code> annotations
to rename the label and the node&#8217;s properties.</p>
</div>
<div class="paragraph">
<p>An additional label <code>ENTITY</code> is added to the node.</p>
</div>
<div class="exampleblock">
<div class="title">Example 123. Default JPA mapping for an entity</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">@Entity
public class News {

    @Id
    private String id;
    private String title;

    // getters, setters ...
}</code></pre>
</div>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/neo4j-single-node-example.png" alt="neo4j single node example">
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 124. Rename node label and properties using @Table and @Column</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">@Entity
@Table(name="ARTICLE")
public class News {

    @Id
    private String id;

    @Column(name = "headline")
    private String title;

    // getters, setters ...
}</code></pre>
</div>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/neo4j-@Column-@Table-example.png" alt="neo4j @Column @Table example">
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_identifiers_and_unique_constraints"><a class="anchor" href="#_identifiers_and_unique_constraints"></a>Identifiers and unique constraints</h5>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Neo4j does not support constraints on more than one property.
For this reason, Hibernate OGM will create a unique constraint ONLY when it spans
a single property and it will ignore the ones spanning multiple properties.</p>
</div>
<div class="paragraph">
<p>The lack of unique constraints on node properties might result in the creation of multiple
nodes with the same identifier.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Hibernate OGM will create unique constraints for the identifier of entities and for the properties
annotated with:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>@Id</code></p>
</li>
<li>
<p><code>@EmbeddedId</code></p>
</li>
<li>
<p><code>@NaturalId</code></p>
</li>
<li>
<p><code>@Column( unique = true )</code></p>
</li>
<li>
<p><code>@Table( uniqueConstraints = @UniqueConstraint(columnNames = { "column_name" } ) )</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Embedded identifiers are currently stored as dot separated properties.</p>
</div>
<div class="exampleblock">
<div class="title">Example 125. Entity with @EmbeddedId</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">@Entity
public class News {

    @EmbeddedId
    private NewsID newsId;

    private String content

    // getters, setters ...
}

@Embeddable
public class NewsID implements Serializable {

    private String title;
    private String author;

    // getters, setters ...
}</code></pre>
</div>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/neo4j-@EmbeddedId-example.png" alt="neo4j @EmbeddedId example">
</div>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_embedded_objects_and_collections_3"><a class="anchor" href="#_embedded_objects_and_collections_3"></a>Embedded objects and collections</h5>
<div class="paragraph">
<p>Embedded elements are stored as separate nodes labeled with <code>EMBEDDED</code>.</p>
</div>
<div class="paragraph">
<p>The type of the relationship that connects the entity node to the embedded node is
the attribute name representing the embedded in the java class.</p>
</div>
<div class="exampleblock">
<div class="title">Example 126. Embedded object</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">@Entity
public class News {

    @EmbeddedId
    private NewsID newsId;

    @Embedded
    private NewsPaper paper;

    // getters, setters ...
}

@Embeddable
public class NewsID implements Serializable {

    private String title;
    private String author;

    // getters, setters ...
}

@Embeddable
public class NewsPaper {

    private String name;
    private String owner;

    // getters, setters ...
}</code></pre>
</div>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/neo4j-@Embedded-example.png" alt="neo4j @Embedded example">
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 127. @ElementCollection</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">@Entity
public class GrandMother {

    @Id
    private String id;

    @ElementCollection
    private List&lt;GrandChild&gt; grandChildren = new ArrayList&lt;GrandChild&gt;();

    // getters, setters ...
}

@Embeddable
public class GrandChild {

    private String name;

    // getters, setters ...
}</code></pre>
</div>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/neo4j-@ElementCollection-example.png" alt="neo4j @ElementCollection example">
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Note that in the previous examples no property is added to the relationships;
in the following one, one property is added to keep track of the order of the elements in the list.</p>
</div>
<div class="exampleblock">
<div class="title">Example 128. @ElementCollection with @OrderColumn</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">@Entity
public class GrandMother {

    @Id
    private String id;

    @ElementCollection
    @OrderColumn( name = "birth_order" )
    private List&lt;GrandChild&gt; grandChildren = new ArrayList&lt;GrandChild&gt;();

    // getters, setters ...
}

@Embeddable
public class GrandChild {

    private String name;

    // getters, setters ...
}</code></pre>
</div>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/neo4j-@ElementCollection-@OrderColumn-example.png" alt="neo4j @ElementCollection @OrderColumn example">
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>It&#8217;s also possible to use embeddeds in a Map like in the following example:</p>
</div>
<div class="exampleblock">
<div class="title">Example 129. @ElementCollection with Map of Embedded</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">@Entity
public class ForumUser {

    @Id
    private String name;

    @ElementCollection
    private Map&lt;String, JiraIssue&gt; issues = new HashMap&lt;&gt;();

    // getters, setters ...
}

@Embeddable
public class JiraIssue {

    private String project;

    private Integer number;

    // getters, setters ...
}</code></pre>
</div>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/neo4j-@ElementCollection-map-example.png" alt="neo4j @ElementCollection map example">
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>This mapping has some problems, though. It will create an additional node for each element in the
map and the embedded values will be stored in a node with only the <code>EMBEDDED</code> label.
We don&#8217;t think this is a natural mapping and expect it to change in the upcoming releases.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_associations_3"><a class="anchor" href="#_associations_3"></a>11.3.3. Associations</h4>
<div class="paragraph">
<p>An association, bidirectional or unidirectional, is always mapped using one relationship,
beginning at the owning side of the association.
This is possible because in Neo4j relationships can be navigated in both directions.</p>
</div>
<div class="paragraph">
<p>The type of the relationships depends on the type of the association,
but in general it is the role of the association on the main side.
The only property stored on the relationship is going to be the index of the association when required,
for example when the association is annotated with <code>@OrderColumn</code> or when a <code>java.util.Map</code> is used.</p>
</div>
<div class="paragraph">
<p>In Neo4j nodes are connected via relationship, this means that we don&#8217;t need to create properties
which store foreign column keys. This means that annotation like <code>@JoinColumn</code> won&#8217;t have any effect.</p>
</div>
<div class="exampleblock">
<div class="title">Example 130. Unidirectional one-to-one</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">@Entity
public class Vehicle {

    @Id
    private String id;
    private String brand;

    // getters, setters ...
}


@Entity
public class Wheel {

    @Id
    private String id;
    private String company;
    private double diameter;

    @OneToOne
    private Vehicle vehicle;

    // getters, setters ...
}</code></pre>
</div>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/neo4j-uni-one-to-one-example.png" alt="neo4j uni one to one example">
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 131. Bidirectional one-to-one</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">@Entity
public class Husband {

    @Id
    private String id;
    private String name;

    @OneToOne
    private Wife wife;

    // getters, setters ...
}

@Entity
public class Wife {

    @Id
    private String id;
    private String name;

    @OneToOne(mappedBy = "wife")
    private Husband husband;

    // getters, setters ...
}</code></pre>
</div>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/neo4j-bi-one-to-one-example.png" alt="neo4j bi one to one example">
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 132. Unidirectional one-to-many</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">@Entity
public class Basket {

    @Id
    private String id;

    private String owner;

    @OneToMany
    private List&lt;Product&gt; products = new ArrayList&lt;Product&gt;();

    // getters, setters ...
}

@Entity
public class Product {

    @Id
    private String name;

    private String description;

    // getters, setters ...
}</code></pre>
</div>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/neo4j-uni-one-to-many-example.png" alt="neo4j uni one to many example">
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 133. Unidirectional one-to-many using maps with defaults</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">@Entity
public class User {

    @Id
    private String id;

    @OneToMany
    private Map&lt;String, Address&gt; addresses = new HashMap&lt;String, Address&gt;();

    // getters, setters ...
}

@Entity
public class Address {

    @Id
    private String id;
    private String city;

    // getters, setters ...
}</code></pre>
</div>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/neo4j-uni-one-to-many-with-map-example.png" alt="neo4j uni one to many with map example">
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 134. Unidirectional one-to-many using maps with @MapKeyColumn</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">@Entity
public class User {

    @Id
    private String id;

    @OneToMany
    @MapKeyColumn(name = "addressType")
    private Map&lt;String, Address&gt; addresses = new HashMap&lt;String, Address&gt;();

    // getters, setters ...
}

@Entity
public class Address {

    @Id
    private String id;
    private String city;

    // getters, setters ...
}</code></pre>
</div>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/neo4j-uni-one-to-many-with-@MapKeyColumn-example.png" alt="neo4j uni one to many with @MapKeyColumn example">
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 135. Unidirectional many-to-one</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">@Entity
public class JavaUserGroup {

    @Id
    private String jug_id;
    private String name;

    // getters, setters ...
}

@Entity
public class Member {

    @Id
    private String id;
    private String name;

    @ManyToOne
    private JavaUserGroup memberOf;

    // getters, setters ...
}</code></pre>
</div>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/neo4j-uni-many-to-one-example.png" alt="neo4j uni many to one example">
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 136. Bidirectional many-to-one</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">@Entity
public class SalesForce {

    @Id
    private String id;
    private String corporation;

    @OneToMany(mappedBy = "salesForce")
    private Set&lt;SalesGuy&gt; salesGuys = new HashSet&lt;SalesGuy&gt;();

    // getters, setters ...
}

@Entity
public class SalesGuy {
    private String id;
    private String name;

    @ManyToOne
    private SalesForce salesForce;

    // getters, setters ...
}</code></pre>
</div>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/neo4j-bi-many-to-one-example.png" alt="neo4j bi many to one example">
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 137. Unidirectional many-to-many</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">@Entity
public class Student {

    @Id
    private String id;
    private String name;

    // getters, setters ...
}

@Entity
public class ClassRoom {

    @Id
    private long id;
    private String lesson;

    @ManyToMany
    private List&lt;Student&gt; students = new ArrayList&lt;Student&gt;();

    // getters, setters ...
}</code></pre>
</div>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/neo4j-uni-many-to-many-example.png" alt="neo4j uni many to many example">
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 138. Bidirectional many-to-many</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">@Entity
public class AccountOwner {

    @Id
    private String id;

    private String SSN;

    @ManyToMany
    private Set&lt;BankAccount&gt; bankAccounts;

    // getters, setters ...
}

@Entity
public class BankAccount {

    @Id
    private String id;

    private String accountNumber;

    @ManyToMany( mappedBy = "bankAccounts" )
    private Set&lt;AccountOwner&gt; owners = new HashSet&lt;AccountOwner&gt;();

    // getters, setters ...
}</code></pre>
</div>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/neo4j-bi-many-to-many-example.png" alt="neo4j bi many to many example">
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 139. Bidirectional one-to-one, one-to-many (Mapping to the same Entity)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">@Entity
public class Person {

    @Id
    private String name;
    @OneToOne
    private Person spouse;
    @OneToMany
    private List&lt;Person&gt; children;

    // getters, setters ...
}</code></pre>
</div>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/neo4j-bi-one-to-one-many-to-many-same-entity-example.png" alt="neo4j bi one to one many to many same entity example">
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_auto_generated_values"><a class="anchor" href="#_auto_generated_values"></a>11.3.4. Auto-generated Values</h4>
<div class="paragraph">
<p>Hibernate OGM supports the table generation strategy as well as the sequence generation strategy with Neo4j.
It is generally recommended to work with the latter,
as it allows a slightly more efficient querying for the next sequence value.</p>
</div>
<div class="paragraph">
<p>Sequence-based generators are represented by nodes in the following form:</p>
</div>
<div class="exampleblock">
<div class="title">Example 140. GenerationType.SEQUENCE</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">@Entity
public class Song {

    ...

    @Id
    @GeneratedValue( strategy = GenerationType.SEQUENCE, generator = "songSequenceGenerator" )
    @SequenceGenerator(
            name = "songSequenceGenerator",
            sequenceName = "song_sequence",
            initialValue = INITIAL_VALUE,
            allocationSize = 10)
    public Long getId() {
        return id;
    }

    ...</code></pre>
</div>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/neo4j-sequence-example.png" alt="neo4j sequence example">
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Each sequence generator node is labelled with <code>SEQUENCE</code>.
The sequence name can be specified via <code>@SequenceGenerator#sequenceName()</code>.
A unique constraint is applied to the property <code>sequence_name</code> in order to ensure uniqueness of sequences.</p>
</div>
<div class="paragraph">
<p>If required, you can set the initial value of a sequence and the increment size via
<code>@SequenceGenerator#initialValue()</code> and <code>@SequenceGenerator#allocationSize()</code>, respectively.
The options <code>@SequenceGenerator#catalog()</code> and <code>@SequenceGenerator#schema()</code> are not supported.</p>
</div>
<div class="paragraph">
<p>Table-based generators are represented by nodes in the following form:</p>
</div>
<div class="exampleblock">
<div class="title">Example 141. GenerationType.TABLE</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">@Entity
public class Video {

    ...

    @Id
    @GeneratedValue( strategy = GenerationType.TABLE, generator = "video" )
    @TableGenerator(
         name = "video",
         table = "Sequences",
         pkColumnName = "key",
         pkColumnValue = "video",
         valueColumnName = "seed"
    )
    public Integer getId() {
        return id;
    }

    ...</code></pre>
</div>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/neo4j-table-based-sequence-example.png" alt="neo4j table based sequence example">
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Each table generator node is labelled with <code>TABLE_BASED_SEQUENCE</code>
and the table name as specified via <code>@TableGenerator#table()</code>.
The sequence name is to be given via <code>@TableGenerator#pkColumnValue()</code>.
The node properties holding the sequence name and value can be configured via
<code>@TableGenerator#pkColumnName()</code> and <code>@TableGenerator#valueColumnName()</code>, respectively.
A unique constraint is applied to the property <code>sequence_name</code> to avoid the same sequence name is used twice within the same "table".</p>
</div>
<div class="paragraph">
<p>If required, you can set the initial value of a sequence and the increment size via
<code>@TableGenerator#initialValue()</code> and <code>@TableGenerator#allocationSize()</code>, respectively.
The options <code>@TableGenerator#catalog()</code>, <code>@TableGenerator#schema()</code>, <code>@TableGenerator#uniqueConstraints()</code> and <code>@TableGenerator#indexes()</code>  are not supported.</p>
</div>
</div>
<div class="sect3">
<h4 id="_labels_summary"><a class="anchor" href="#_labels_summary"></a>11.3.5. Labels summary</h4>
<div class="paragraph">
<p>The maximum number of labels the database can contain is roughly 2 billion.</p>
</div>
<div class="paragraph">
<p>The following summary will help you to keep track of the labels assigned to a new node:</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 55. Summary of the labels assigned to a new node</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-top">NODE TYPE</th>
<th class="tableblock halign-center valign-top">LABELS</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Entity</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ENTITY, &lt;Entity class name&gt;</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Embeddable</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">EMBEDDED, &lt;Embeddable class name&gt;</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">GenerationType.SEQUENCE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SEQUENCE</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">GenerationType.TABLE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TABLE_BASED_SEQUENCE, &lt;Table name&gt;</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect2">
<h3 id="ogm-neo4j-transactions"><a class="anchor" href="#ogm-neo4j-transactions"></a>11.4. Transactions</h3>
<div class="paragraph">
<p>In Neo4j, operations must be executed inside a transaction.
Make sure your interactions with Hibernate OGM are within a transaction when you target Neo4J.</p>
</div>
<div class="exampleblock">
<div class="title">Example 142. Example of starting and committing transactions</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">Session session = factory.openSession();
Transaction tx = session.beginTransaction();

Account account = new Account();
account.setLogin( "myAccount" );
session.persist( account );

tx.commit();

...

tx = session.beginTransaction();
Account savedAccount =  (Account) session.get( Account.class, account.getId() );
tx.commit();</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>In the case of JTA, Hibernate OGM attaches the Neo4J internal transaction to the JTA
transaction lifecycle.
That way when the JTA transaction is committed or rollbacked (for example by an EJB CMT or
explicitly), the Neo4J transaction is also committed or rollbacked.
This makes for a nice integration in a Java EE container.</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This is NOT a true JTA/XA integration but more a lifecycle alignment:
changes on more than one datasource won&#8217;t be executed as a single atomic transaction.</p>
</div>
<div class="paragraph">
<p>In particular, if the JTA transaction involves multiple resources, Neo4j might commit
before a failure of another resource. In this case, Neo4j won&#8217;t be able to rollback even
if the JTA transaction will.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="ogm-neo4j-queries"><a class="anchor" href="#ogm-neo4j-queries"></a>11.5. Queries</h3>
<div class="paragraph">
<p>You can express queries in a few different ways:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>using JPQL</p>
</li>
<li>
<p>using the Cypher query language</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>While you can use JPQL for simple queries, you might hit limitations.
The current recommended approach is to use native Cypher queries
if your query involves nested (list of) elements.</p>
</div>
<div class="paragraph">
<p>You don&#8217;t need Hibernate Search on the classpath to run queries.</p>
</div>
<div class="sect3">
<h4 id="_jpql_queries_2"><a class="anchor" href="#_jpql_queries_2"></a>11.5.1. JPQL queries</h4>
<div class="paragraph">
<p>Hibernate OGM is a work in progress, so only a sub-set of JPQL constructs is available
when using the JPQL query support. This includes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>simple comparisons using "&lt;", "&lt;=", "=", "&gt;=" and "&gt;"</p>
</li>
<li>
<p><code>IS NULL</code> and <code>IS NOT NULL</code></p>
</li>
<li>
<p>the boolean operators <code>AND</code>, <code>OR</code>, <code>NOT</code></p>
</li>
<li>
<p><code>LIKE</code>, <code>IN</code> and <code>BETWEEN</code></p>
</li>
<li>
<p><code>ORDER BY</code></p>
</li>
<li>
<p>inner <code>JOIN</code> on embedded collections</p>
</li>
<li>
<p>projections of regular and embedded properties</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Queries using these constructs will be transformed into equivalent <a href="http://docs.neo4j.org/chunked/stable/cypher-query-lang.html">Cypher queries</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Let us know <a href="#ogm-howtocontribute">by opening an issue or sending an email</a>
what query you wish to execute.
Expanding our support in this area is high on our priority list.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="ogm-neo4j-queries-native"><a class="anchor" href="#ogm-neo4j-queries-native"></a>11.5.2. Cypher queries</h4>
<div class="paragraph">
<p>Hibernate OGM also supports <a href="http://docs.neo4j.org/chunked/stable/cypher-query-lang.html">Cypher queries</a> for Neo4j.
You can execute Cypher queries as shown in the following example:</p>
</div>
<div class="exampleblock">
<div class="title">Example 143. Using the JPA API</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">@Entity
public class Poem {

    @Id
    private Long id;

    private String name;

    private String author;

   // getters, setters ...

}

...

javax.persistence.EntityManager em = ...

// a single result query
String query1 = "MATCH ( n:Poem { name:'Portia', author:'Oscar Wilde' } ) RETURN n";
Poem poem = (Poem) em.createNativeQuery( query1, Poem.class ).getSingleResult();

// query with order by
String query2 = "MATCH ( n:Poem { name:'Portia', author:'Oscar Wilde' } ) " +
                "RETURN n ORDER BY n.name";
List&lt;Poem&gt; poems = em.createNativeQuery( query2, Poem.class ).getResultList();

// query with projections
String query3 = MATCH ( n:Poem ) RETURN n.name, n.author ORDER BY n.name";
List&lt;Object[]&gt; poemNames = (List&lt;Object[]&gt;) em.createNativeQuery( query3 )
                               .getResultList();</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The result of a query is a managed entity (or a list thereof) or a projection of attributes in form of an object array,
just like you would get from a JPQL query.</p>
</div>
<div class="exampleblock">
<div class="title">Example 144. Using the Hibernate native API</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">OgmSession session = ...

String query1 = "MATCH ( n:Poem { name:'Portia', author:'Oscar Wilde' } ) " +
                "RETURN n";
Poem poem = session.createNativeQuery( query1 )
                      .addEntity( "Poem", Poem.class )
                      .uniqueResult();

String query2 = "MATCH ( n:Poem { name:'Portia', author:'Oscar Wilde' } ) " +
                "RETURN n ORDER BY n.name";
List&lt;Poem&gt; poems = session.createNativeQuery( query2 )
                      .addEntity( "Poem", Poem.class )
                      .list();</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Native queries can also be created using the <code>@NamedNativeQuery</code> annotation:</p>
</div>
<div class="exampleblock">
<div class="title">Example 145. Using @NamedNativeQuery</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JAVA" data-lang="JAVA">@Entity
@NamedNativeQuery(
   name = "AthanasiaPoem",
   query = "MATCH ( n:Poem { name:'Athanasia', author:'Oscar Wilde' } ) RETURN n",
   resultClass = Poem.class )
public class Poem { ... }

...

// Using the EntityManager
Poem poem1 = (Poem) em.createNamedQuery( "AthanasiaPoem" )
                     .getSingleResult();

// Using the Session
Poem poem2 = (Poem) session.getNamedQuery( "AthanasiaPoem" )
                     .uniqueResult();</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Hibernate OGM stores data in a natural way so you can still execute queries using your favorite tool,
the main drawback is that the results are going to be raw Neo4j elements and not managed entities.</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2018-12-18 12:13:28 UTC
</div>
</div>
<!-- Google Analytics -->
<script type="text/javascript">
	dataLayer = [{'channel' : 'Hibernate', 'additional_tracking_code' : 'UA-45270411-3'}];
	(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
		new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
		j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
	})(window,document,'script','dataLayer','GTM-NJWS5L');
</script>
<noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-NJWS5L" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- /Google Analytics -->

<!-- HibernateDoc.OutdatedContent -->
<script src="//code.jquery.com/jquery-3.1.0.min.js" integrity="sha256-cCueBR6CsyA4/9szpPfrX3s49M9vUU5BgtiJj06wt/s=" crossorigin="anonymous"></script>
<script src="/hibernate/_outdated-content/outdated-content.js" type="text/javascript"></script>
<script type="text/javascript">var jQuery_3_1 = $.noConflict(true); jQuery_3_1(document).ready(function() { HibernateDoc.OutdatedContent.install('ogm'); });</script>
<!-- /HibernateDoc.OutdatedContent -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prettify/r298/prettify.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/prettify/r298/prettify.min.js"></script>
<script>prettyPrint()</script>
</body>
</html>