<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.10">
<title>An Introduction to Hibernate 6</title>
<link rel="stylesheet" href="./css/hibernate.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
</head>
<body class="book">
<div id="header">
<h1>An Introduction to Hibernate 6</h1>
<div class="details">
<span id="revnumber">version 6.3.2.Final</span>
</div>
<div id="toc" class="toc">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#preface">Preface</a></li>
<li><a href="#introduction">1. Introduction</a>
<ul class="sectlevel2">
<li><a href="#hibernate-and-jpa">1.1. Hibernate and JPA</a></li>
<li><a href="#java-code">1.2. Writing Java code with Hibernate</a></li>
<li><a href="#hello-hibernate">1.3. Hello, Hibernate</a></li>
<li><a href="#hello-jpa">1.4. Hello, JPA</a></li>
<li><a href="#organizing-persistence">1.5. Organizing persistence logic</a></li>
<li><a href="#testing">1.6. Testing persistence logic</a></li>
<li><a href="#architecture">1.7. Architecture and the persistence layer</a></li>
<li><a href="#overview">1.8. Overview</a></li>
</ul>
</li>
<li><a href="#configuration">2. Configuration and bootstrap</a>
<ul class="sectlevel2">
<li><a href="#required-dependencies">2.1. Including Hibernate in your project build</a></li>
<li><a href="#optional-dependencies">2.2. Optional dependencies</a></li>
<li><a href="#configuration-jpa">2.3. Configuration using JPA XML</a></li>
<li><a href="#configuration-api">2.4. Configuration using Hibernate API</a></li>
<li><a href="#configuration-properties">2.5. Configuration using Hibernate properties file</a></li>
<li><a href="#basic-configuration-settings">2.6. Basic configuration settings</a></li>
<li><a href="#automatic-schema-export">2.7. Automatic schema export</a></li>
<li><a href="#logging-generated-sql">2.8. Logging the generated SQL</a></li>
<li><a href="#minimizing">2.9. Minimizing repetitive mapping information</a></li>
<li><a href="#nationalized-chars">2.10. Nationalized character data in SQL Server</a></li>
</ul>
</li>
<li><a href="#entities">3. Entities</a>
<ul class="sectlevel2">
<li><a href="#entity-clases">3.1. Entity classes</a></li>
<li><a href="#access-type">3.2. Access types</a></li>
<li><a href="#entity-inheritance">3.3. Entity class inheritance</a></li>
<li><a href="#identifier-attributes">3.4. Identifier attributes</a></li>
<li><a href="#generated-identifiers">3.5. Generated identifiers</a></li>
<li><a href="#natural-identifiers">3.6. Natural keys as identifiers</a></li>
<li><a href="#composite-identifiers">3.7. Composite identifiers</a></li>
<li><a href="#version-attributes">3.8. Version attributes</a></li>
<li><a href="#natural-id-attributes">3.9. Natural id attributes</a></li>
<li><a href="#basic-attributes">3.10. Basic attributes</a></li>
<li><a href="#enums">3.11. Enumerated types</a></li>
<li><a href="#converters">3.12. Converters</a></li>
<li><a href="#compositional-basic-types">3.13. Compositional basic types</a></li>
<li><a href="#embeddable-objects">3.14. Embeddable objects</a></li>
<li><a href="#associations">3.15. Associations</a></li>
<li><a href="#many-to-one">3.16. Many-to-one</a></li>
<li><a href="#one-to-one-fk">3.17. One-to-one (first way)</a></li>
<li><a href="#one-to-one-pk">3.18. One-to-one (second way)</a></li>
<li><a href="#many-to-many">3.19. Many-to-many</a></li>
<li><a href="#collections">3.20. Collections of basic values and embeddable objects</a></li>
<li><a href="#arrays">3.21. Collections mapped to SQL arrays</a></li>
<li><a href="#element-collections">3.22. Collections mapped to a separate table</a></li>
<li><a href="#entities-summary">3.23. Summary of annotations</a></li>
<li><a href="#equals-and-hash">3.24. <code>equals()</code> and <code>hashCode()</code></a></li>
</ul>
</li>
<li><a href="#object-relational-mapping">4. Object/relational mapping</a>
<ul class="sectlevel2">
<li><a href="#mapping-inheritance">4.1. Mapping entity inheritance hierarchies</a></li>
<li><a href="#table-mappings">4.2. Mapping to tables</a></li>
<li><a href="#entity-table-mappings">4.3. Mapping entities to tables</a></li>
<li><a href="#join-table-mappings">4.4. Mapping associations to tables</a></li>
<li><a href="#column-mappings">4.5. Mapping to columns</a></li>
<li><a href="#regular-column-mappings">4.6. Mapping basic attributes to columns</a></li>
<li><a href="#join-column-mappings">4.7. Mapping associations to foreign key columns</a></li>
<li><a href="#primary-key-column-mappings">4.8. Mapping primary key joins between tables</a></li>
<li><a href="#column-lengths">4.9. Column lengths and adaptive column types</a></li>
<li><a href="#lobs">4.10. LOBs</a></li>
<li><a href="#mapping-embeddables">4.11. Mapping embeddable types to UDTs or to JSON</a></li>
<li><a href="#miscellaneous-mappings">4.12. Summary of SQL column type mappings</a></li>
<li><a href="#mapping-formulas">4.13. Mapping to formulas</a></li>
<li><a href="#derived-identity">4.14. Derived Identity</a></li>
<li><a href="#constraints">4.15. Adding constraints</a></li>
</ul>
</li>
<li><a href="#interacting">5. Interacting with the database</a>
<ul class="sectlevel2">
<li><a href="#persistence-contexts">5.1. Persistence Contexts</a></li>
<li><a href="#creating-session">5.2. Creating a session</a></li>
<li><a href="#managing-transactions">5.3. Managing transactions</a></li>
<li><a href="#persistence-operations">5.4. Operations on the persistence context</a></li>
<li><a href="#cascade">5.5. Cascading persistence operations</a></li>
<li><a href="#proxies-and-lazy-fetching">5.6. Proxies and lazy fetching</a></li>
<li><a href="#entity-graph">5.7. Entity graphs and eager fetching</a></li>
<li><a href="#flush">5.8. Flushing the session</a></li>
<li><a href="#queries">5.9. Queries</a></li>
<li><a href="#hql-queries">5.10. HQL queries</a></li>
<li><a href="#criteria-queries">5.11. Criteria queries</a></li>
<li><a href="#criteria-definition">5.12. A more comfortable way to write criteria queries</a></li>
<li><a href="#native-queries">5.13. Native SQL queries</a></li>
<li><a href="#pagination">5.14. Limits, pagination, and ordering</a></li>
<li><a href="#projection-lists">5.15. Representing projection lists</a></li>
<li><a href="#named-queries">5.16. Named queries</a></li>
<li><a href="#load-access">5.17. Controlling lookup by id</a></li>
<li><a href="#jdbc">5.18. Interacting directly with JDBC</a></li>
<li><a href="#advice">5.19. What to do when things go wrong</a></li>
</ul>
</li>
<li><a href="#generator">6. Compile-time tooling</a>
<ul class="sectlevel2">
<li><a href="#generated-named-queries">6.1. Named queries and the Metamodel Generator</a></li>
<li><a href="#generated-query-methods">6.2. Generated query methods</a></li>
<li><a href="#static-or-instance">6.3. Generating query methods as instance methods</a></li>
<li><a href="#generated-finder-methods">6.4. Generated finder methods</a></li>
<li><a href="#paging-and-ordering">6.5. Paging and ordering</a></li>
<li><a href="#return-types">6.6. Query and finder method return types</a></li>
<li><a href="#query-validator">6.7. An alternative approach</a></li>
</ul>
</li>
<li><a href="#tuning-and-performance">7. Tuning and performance</a>
<ul class="sectlevel2">
<li><a href="#connection-pool">7.1. Tuning the connection pool</a></li>
<li><a href="#statement-batching">7.2. Enabling statement batching</a></li>
<li><a href="#association-fetching">7.3. Association fetching</a></li>
<li><a href="#batch-subselect-fetch">7.4. Batch fetching and subselect fetching</a></li>
<li><a href="#join-fetch">7.5. Join fetching</a></li>
<li><a href="#second-level-cache">7.6. The second-level cache</a></li>
<li><a href="#enable-second-level-cache">7.7. Specifying which data is cached</a></li>
<li><a href="#natural-id-cache">7.8. Caching by natural id</a></li>
<li><a href="#caching-and-fetching">7.9. Caching and association fetching</a></li>
<li><a href="#second-level-cache-configuration">7.10. Configuring the second-level cache provider</a></li>
<li><a href="#query-cache">7.11. Caching query result sets</a></li>
<li><a href="#second-level-cache-management">7.12. Second-level cache management</a></li>
<li><a href="#session-cache-management">7.13. Session cache management</a></li>
<li><a href="#stateless-sessions">7.14. Stateless sessions</a></li>
<li><a href="#optimistic-and-pessimistic-locking">7.15. Optimistic and pessimistic locking</a></li>
<li><a href="#statistics">7.16. Collecting statistics</a></li>
<li><a href="#slow-queries">7.17. Tracking down slow queries</a></li>
<li><a href="#indexes">7.18. Adding indexes</a></li>
<li><a href="#denomalized-date">7.19. Dealing with denormalized data</a></li>
<li><a href="#hibernate-reactive">7.20. Reactive programming with Hibernate</a></li>
</ul>
</li>
<li><a href="#advanced">8. Advanced Topics</a>
<ul class="sectlevel2">
<li><a href="#filters">8.1. Filters</a></li>
<li><a href="#multitenancy">8.2. Multi-tenancy</a></li>
<li><a href="#custom-sql">8.3. Using custom-written SQL</a></li>
<li><a href="#database-generated-columns">8.4. Handling database-generated columns</a></li>
<li><a href="#user-defined-generators">8.5. User-defined generators</a></li>
<li><a href="#naming-strategies">8.6. Naming strategies</a></li>
<li><a href="#spatial">8.7. Spatial datatypes</a></li>
<li><a href="#ordered-sorted">8.8. Ordered and sorted collections and map keys</a></li>
<li><a href="#any">8.9. Any mappings</a></li>
<li><a href="#dynamic-insert-update">8.10. Selective column lists in inserts and updates</a></li>
<li><a href="#bytecode-enhancer">8.11. Using the bytecode enhancer</a></li>
<li><a href="#fetch-profiles">8.12. Named fetch profiles</a></li>
</ul>
</li>
<li><a href="#credits">9. Credits</a></li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="preface">Preface</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Hibernate 6 is a major redesign of the world&#8217;s most popular and feature-rich ORM solution.
The redesign has touched almost every subsystem of Hibernate, including the APIs, mapping annotations, and the query language.
This new Hibernate is more powerful, more robust, and more typesafe.</p>
</div>
<div class="paragraph">
<p>With so many improvements, it&#8217;s very difficult to summarize the significance of this work.
But the following general themes stand out.
Hibernate 6:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>finally takes advantage of the advances in relational databases over the past decade, updating the query language to support a raft of new constructs in modern dialects of SQL,</p>
</li>
<li>
<p>exhibits much more consistent behavior across different databases, greatly improving portability, and generates much higher-quality DDL from dialect-independent code,</p>
</li>
<li>
<p>improves error reporting by more scrupulous validation of queries <em>before</em> access to the database,</p>
</li>
<li>
<p>improves the type-safety of O/R mapping annotations, clarifies the separation of API, SPI, and internal implementation, and fixes some long-standing architectural flaws,</p>
</li>
<li>
<p>removes or deprecates legacy APIs, laying the foundation for future evolution, and</p>
</li>
<li>
<p>makes far better use of Javadoc, putting much more information at the fingertips of developers.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Hibernate 6 and Hibernate Reactive are now core components of Quarkus 3, the most exciting new environment for cloud-native development in Java, and Hibernate remains the persistence solution of choice for almost every major Java framework or server.</p>
</div>
<div class="paragraph">
<p>Unfortunately, the changes in Hibernate 6 have obsoleted much of the information about Hibernate that&#8217;s available in books, in blog posts, and on stackoverflow.</p>
</div>
<div class="paragraph">
<p>This guide is an up-to-date, high-level discussion of the current feature set and recommended usage.
It does not attempt to cover every feature and should be used in conjunction with other documentation:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Hibernate&#8217;s extensive <a href="https://docs.jboss.org/hibernate/orm/6.3/javadocs/">Javadoc</a>,</p>
</li>
<li>
<p>the <a href="https://docs.jboss.org/hibernate/orm/6.3/querylanguage/html_single/Hibernate_Query_Language.html">Guide to Hibernate Query Language</a>, and</p>
</li>
<li>
<p>the Hibernate <a href="https://docs.jboss.org/hibernate/orm/6.3/userguide/html_single/Hibernate_User_Guide.html">User Guide</a>.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The Hibernate User Guide includes detailed discussions of most aspects of Hibernate.
But with so much information to cover, readability is difficult to achieve, and so it&#8217;s most useful as a reference.
Where necessary, we&#8217;ll provide links to relevant sections of the User Guide.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="introduction">1. Introduction</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Hibernate is usually described as a library that makes it easy to map Java classes to relational database tables.
But this formulation does no justice to the central role played by the relational data itself.
So a better description might be:</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p>Hibernate makes <strong>relational data</strong> visible to a program written in Java, in a <strong>natural</strong> and <strong>typesafe</strong> form,</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>making it easy to write complex queries and work with their results,</p>
</li>
<li>
<p>letting the program easily synchronize changes made in memory with the database, respecting the ACID properties of transactions, and</p>
</li>
<li>
<p>allowing performance optimizations to be made after the basic persistence logic has already been written.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="paragraph">
<p>Here the relational data is the focus, along with the importance of typesafety.
The goal of <em>object/relational mapping</em> (ORM) is to eliminate fragile and untypesafe code, and make large programs easier to maintain in the long run.</p>
</div>
<div class="paragraph">
<p>ORM takes the pain out of persistence by relieving the developer of the need to hand-write tedious, repetitive, and fragile code for flattening graphs of objects to database tables and rebuilding graphs of objects from flat SQL query result sets.
Even better, ORM makes it much easier to tune performance later, after the basic persistence logic has already been written.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>A perennial question is: should I use ORM, or plain SQL?
The answer is usually: <em>use both</em>.
JPA and Hibernate were designed to work <em>in conjunction with</em> handwritten SQL.
You see, most programs with nontrivial data access logic will benefit from the use of ORM at least <em>somewhere</em>.
But if Hibernate is making things more difficult, for some particularly tricky piece of data access logic, the only sensible thing to do is to use something better suited to the problem!
Just because you&#8217;re using Hibernate for persistence doesn&#8217;t mean you have to use it for <em>everything</em>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Developers often ask about the relationship between Hibernate and JPA, so let&#8217;s take a short detour into some history.</p>
</div>
<div class="sect2">
<h3 id="hibernate-and-jpa">1.1. Hibernate and JPA</h3>
<div class="paragraph">
<p>Hibernate was the inspiration behind the <em>Java</em> (now <em>Jakarta</em>) <em>Persistence API</em>, or JPA, and includes a complete implementation of the latest revision of this specification.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">The early history of Hibernate and JPA</div>
<div class="paragraph">
<p>The Hibernate project began in 2001, when Gavin King&#8217;s frustration with Entity Beans in EJB 2 boiled over.
It quickly overtook other open source and commercial contenders to become the most popular persistence solution for Java, and the book <em>Hibernate in Action</em>, written with Christian Bauer, was an influential bestseller.</p>
</div>
<div class="paragraph">
<p>In 2004, Gavin and Christian joined a tiny startup called JBoss, and other early Hibernate contributors soon followed: Max Rydahl Andersen, Emmanuel Bernard, Steve Ebersole, and Sanne Grinovero.</p>
</div>
<div class="paragraph">
<p>Soon after, Gavin joined the EJB 3 expert group and convinced the group to deprecate Entity Beans in favor of a brand-new persistence API modelled after Hibernate.
Later, members of the TopLink team got involved, and the Java Persistence API evolved as a collaboration between—primarily—Sun, JBoss, Oracle, and Sybase, under the leadership of Linda Demichiel.</p>
</div>
<div class="paragraph">
<p>Over the intervening two decades, <em>many</em> talented people have contributed to the development of Hibernate.
We&#8217;re all especially grateful to Steve, who has led the project for many years, since Gavin stepped back to focus in other work.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>We can think of the API of Hibernate in terms of three basic elements:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>an implementation of the JPA-defined APIs, most importantly, of the interfaces <code>EntityManagerFactory</code> and <code>EntityManager</code>, and of the JPA-defined O/R mapping annotations,</p>
</li>
<li>
<p>a <em>native API</em> exposing the full set of available functionality, centered around the interfaces <a href="https://docs.jboss.org/hibernate/orm/6.3/javadocs/org/hibernate/SessionFactory.html"><code>SessionFactory</code></a>, which extends <code>EntityManagerFactory</code>, and <a href="https://docs.jboss.org/hibernate/orm/6.3/javadocs/org/hibernate/Session.html"><code>Session</code></a>, which extends <code>EntityManager</code>, and</p>
</li>
<li>
<p>a set of <a href="https://docs.jboss.org/hibernate/orm/6.3/javadocs/org/hibernate/annotations/package-summary.html"><em>mapping annotations</em></a> which augment the O/R mapping annotations defined by JPA, and which may be used with the JPA-defined interfaces, or with the native API.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Hibernate also offers a range of SPIs for frameworks and libraries which extend or integrate with Hibernate, but we&#8217;re not interested in any of that stuff here.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="images/api-overview.png" alt="API overview" width="700">
</div>
</div>
<div class="paragraph">
<p>As an application developer, you must decide whether to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>write your program in terms of <code>Session</code> and <code>SessionFactory</code>, or</p>
</li>
<li>
<p>maximize portability to other implementations of JPA by, wherever reasonable, writing code in terms of  <code>EntityManager</code> and <code>EntityManagerFactory</code>, falling back to the native APIs only where necessary.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Whichever path you take, you will use the JPA-defined mapping annotations most of the time, and the Hibernate-defined annotations for more advanced mapping problems.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>You might wonder if it&#8217;s possible to develop an application using <em>only</em> JPA-defined APIs, and, indeed, that&#8217;s possible in principle.
JPA is a great baseline that really nails the basics of the object/relational mapping problem.
But without the native APIs, and extended mapping annotations, you miss out on much of the power of Hibernate.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Since Hibernate existed before JPA, and since JPA was modelled on Hibernate, we unfortunately have some competition and duplication in naming between the standard and native APIs.
For example:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. Examples of competing APIs with similar naming</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Hibernate</th>
<th class="tableblock halign-left valign-top">JPA</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.hibernate.annotations.CascadeType</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>javax.persistence.CascadeType</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.hibernate.FlushMode</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>javax.persistence.FlushModeType</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.hibernate.annotations.FetchMode</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>javax.persistence.FetchType</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.hibernate.query.Query</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>javax.persistence.Query</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.hibernate.Cache</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>javax.persistence.Cache</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@org.hibernate.annotations.NamedQuery</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@javax.persistence.NamedQuery</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@org.hibernate.annotations.Cache</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@javax.persistence.Cacheable</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Typically, the Hibernate-native APIs offer something a little extra that&#8217;s missing in JPA, so this isn&#8217;t exactly a <em>flaw</em>.
But it&#8217;s something to watch out for.</p>
</div>
</div>
<div class="sect2">
<h3 id="java-code">1.2. Writing Java code with Hibernate</h3>
<div class="paragraph">
<p>If you&#8217;re completely new to Hibernate and JPA, you might already be wondering how the persistence-related code is structured.</p>
</div>
<div class="paragraph">
<p>Well, typically, our persistence-related code comes in two layers:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>a representation of our data model in Java, which takes the form of a set of annotated entity classes, and</p>
</li>
<li>
<p>a larger number of functions which interact with Hibernate&#8217;s APIs to perform the persistence operations associated with your various transactions.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The first part, the data or "domain" model, is usually easier to write, but doing a great and very clean job of it will strongly affect your success in the second part.</p>
</div>
<div class="paragraph">
<p>Most people implement the domain model as a set of what we used to call "Plain Old Java Objects", that is, as simple Java classes with no direct dependencies on technical infrastructure, nor on application logic which deals with request processing, transaction management, communications, or interaction with the database.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Take your time with this code, and try to produce a Java model that&#8217;s as close as reasonable to the relational data model. Avoid using exotic or advanced mapping features when they&#8217;re not really needed.
When in the slightest doubt, map a foreign key relationship using <code>@ManyToOne</code> with <code>@OneToMany(mappedBy=&#8230;&#8203;)</code> in preference to more complicated association mappings.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The second part of the code is much trickier to get right. This code must:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>manage transactions and sessions,</p>
</li>
<li>
<p>interact with the database via the Hibernate session,</p>
</li>
<li>
<p>fetch and prepare data needed by the UI, and</p>
</li>
<li>
<p>handle failures.</p>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Responsibility for transaction and session management, and for recovery from certain kinds of failure, is best handled in some sort of framework code.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We&#8217;re going to <a href="#organizing-persistence">come back soon</a> to the thorny question of how this persistence logic should be organized, and how it should fit into the rest of the system.</p>
</div>
</div>
<div class="sect2">
<h3 id="hello-hibernate">1.3. Hello, Hibernate</h3>
<div class="paragraph">
<p>Before we get deeper into the weeds, we&#8217;ll quickly present a basic example program that will help you get started if you don&#8217;t already have Hibernate integrated into your project.</p>
</div>
<div class="paragraph">
<p>We begin with a simple gradle build file:</p>
</div>
<div id="build-gradle" class="listingblock">
<div class="title"><code>build.gradle</code></div>
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="n">plugins</span> <span class="o">{</span>
    <span class="n">id</span> <span class="s1">'java'</span>
<span class="o">}</span>

<span class="n">group</span> <span class="o">=</span> <span class="s1">'org.example'</span>
<span class="n">version</span> <span class="o">=</span> <span class="s1">'1.0-SNAPSHOT'</span>

<span class="n">repositories</span> <span class="o">{</span>
    <span class="n">mavenCentral</span><span class="o">()</span>
<span class="o">}</span>

<span class="n">dependencies</span> <span class="o">{</span>
    <span class="c1">// the GOAT ORM</span>
    <span class="n">implementation</span> <span class="s1">'org.hibernate.orm:hibernate-core:6.3.0.Final'</span>

    <span class="c1">// Hibernate Validator</span>
    <span class="n">implementation</span> <span class="s1">'org.hibernate.validator:hibernate-validator:8.0.0.Final'</span>
    <span class="n">implementation</span> <span class="s1">'org.glassfish:jakarta.el:4.0.2'</span>

    <span class="c1">// Agroal connection pool</span>
    <span class="n">implementation</span> <span class="s1">'org.hibernate.orm:hibernate-agroal:6.3.0.Final'</span>
    <span class="n">implementation</span> <span class="s1">'io.agroal:agroal-pool:2.1'</span>

    <span class="c1">// logging via Log4j</span>
    <span class="n">implementation</span> <span class="s1">'org.apache.logging.log4j:log4j-core:2.20.0'</span>

    <span class="c1">// JPA Metamodel Generator</span>
    <span class="n">annotationProcessor</span> <span class="s1">'org.hibernate.orm:hibernate-jpamodelgen:6.3.0.Final'</span>

    <span class="c1">// Compile-time checking for HQL</span>
    <span class="c1">//implementation 'org.hibernate:query-validator:2.0-SNAPSHOT'</span>
    <span class="c1">//annotationProcessor 'org.hibernate:query-validator:2.0-SNAPSHOT'</span>

    <span class="c1">// H2 database</span>
    <span class="n">runtimeOnly</span> <span class="s1">'com.h2database:h2:2.1.214'</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Only the first of these dependencies is absolutely <em>required</em> to run Hibernate.</p>
</div>
<div class="paragraph">
<p>Next, we&#8217;ll add a logging configuration file for log4j:</p>
</div>
<div class="listingblock">
<div class="title"><code>log4j2.properties</code></div>
<div class="content">
<pre class="rouge highlight"><code data-lang="properties"><span class="py">rootLogger.level</span> <span class="p">=</span> <span class="s">info</span>
<span class="py">rootLogger.appenderRefs</span> <span class="p">=</span> <span class="s">console</span>
<span class="py">rootLogger.appenderRef.console.ref</span> <span class="p">=</span> <span class="s">console</span>

<span class="py">logger.hibernate.name</span> <span class="p">=</span> <span class="s">org.hibernate.SQL</span>
<span class="py">logger.hibernate.level</span> <span class="p">=</span> <span class="s">info</span>

<span class="py">appender.console.name</span> <span class="p">=</span> <span class="s">console</span>
<span class="py">appender.console.type</span> <span class="p">=</span> <span class="s">Console</span>
<span class="py">appender.console.layout.type</span> <span class="p">=</span> <span class="s">PatternLayout</span>
<span class="py">appender.console.layout.pattern</span> <span class="p">=</span> <span class="s">%highlight{[%p]} %m%n</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we need some Java code.
We begin with our <em>entity class</em>:</p>
</div>
<div id="book" class="listingblock">
<div class="title"><code>Book.java</code></div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kn">package</span> <span class="nn">org.hibernate.example</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">jakarta.persistence.Entity</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">jakarta.persistence.Id</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">jakarta.validation.constraints.NotNull</span><span class="o">;</span>

<span class="nd">@Entity</span>
<span class="kd">class</span> <span class="nc">Book</span> <span class="o">{</span>
    <span class="nd">@Id</span>
    <span class="nc">String</span> <span class="n">isbn</span><span class="o">;</span>

    <span class="nd">@NotNull</span>
    <span class="nc">String</span> <span class="n">title</span><span class="o">;</span>

    <span class="nc">Book</span><span class="o">()</span> <span class="o">{}</span>

    <span class="nc">Book</span><span class="o">(</span><span class="nc">String</span> <span class="n">isbn</span><span class="o">,</span> <span class="nc">String</span> <span class="n">title</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">isbn</span> <span class="o">=</span> <span class="n">isbn</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">title</span> <span class="o">=</span> <span class="n">title</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally, let&#8217;s see code which configures and instantiates Hibernate and asks it to persist and query the entity.
Don&#8217;t worry if this makes no sense at all right now.
It&#8217;s the job of this Introduction to make all this crystal clear.</p>
</div>
<div id="main-hibernate" class="listingblock">
<div class="title"><code>Main.java</code></div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kn">package</span> <span class="nn">org.hibernate.example</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.hibernate.cfg.Configuration</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">static</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Boolean</span><span class="o">.</span><span class="na">TRUE</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">System</span><span class="o">.</span><span class="na">out</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">org</span><span class="o">.</span><span class="na">hibernate</span><span class="o">.</span><span class="na">cfg</span><span class="o">.</span><span class="na">AvailableSettings</span><span class="o">.*;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Main</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">var</span> <span class="n">sessionFactory</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Configuration</span><span class="o">()</span>
                <span class="o">.</span><span class="na">addAnnotatedClass</span><span class="o">(</span><span class="nc">Book</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
                <span class="c1">// use H2 in-memory database</span>
                <span class="o">.</span><span class="na">setProperty</span><span class="o">(</span><span class="no">URL</span><span class="o">,</span> <span class="s">"jdbc:h2:mem:db1"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">setProperty</span><span class="o">(</span><span class="no">USER</span><span class="o">,</span> <span class="s">"sa"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">setProperty</span><span class="o">(</span><span class="no">PASS</span><span class="o">,</span> <span class="s">""</span><span class="o">)</span>
                <span class="c1">// use Agroal connection pool</span>
                <span class="o">.</span><span class="na">setProperty</span><span class="o">(</span><span class="s">"hibernate.agroal.maxSize"</span><span class="o">,</span> <span class="s">"20"</span><span class="o">)</span>
                <span class="c1">// display SQL in console</span>
                <span class="o">.</span><span class="na">setProperty</span><span class="o">(</span><span class="no">SHOW_SQL</span><span class="o">,</span> <span class="no">TRUE</span><span class="o">.</span><span class="na">toString</span><span class="o">())</span>
                <span class="o">.</span><span class="na">setProperty</span><span class="o">(</span><span class="no">FORMAT_SQL</span><span class="o">,</span> <span class="no">TRUE</span><span class="o">.</span><span class="na">toString</span><span class="o">())</span>
                <span class="o">.</span><span class="na">setProperty</span><span class="o">(</span><span class="no">HIGHLIGHT_SQL</span><span class="o">,</span> <span class="no">TRUE</span><span class="o">.</span><span class="na">toString</span><span class="o">())</span>
                <span class="o">.</span><span class="na">buildSessionFactory</span><span class="o">();</span>

        <span class="c1">// export the inferred database schema</span>
        <span class="n">sessionFactory</span><span class="o">.</span><span class="na">getSchemaManager</span><span class="o">().</span><span class="na">exportMappedObjects</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>

        <span class="c1">// persist an entity</span>
        <span class="n">sessionFactory</span><span class="o">.</span><span class="na">inTransaction</span><span class="o">(</span><span class="n">session</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="n">session</span><span class="o">.</span><span class="na">persist</span><span class="o">(</span><span class="k">new</span> <span class="nc">Book</span><span class="o">(</span><span class="s">"9781932394153"</span><span class="o">,</span> <span class="s">"Hibernate in Action"</span><span class="o">));</span>
        <span class="o">});</span>

        <span class="c1">// query data using HQL</span>
        <span class="n">sessionFactory</span><span class="o">.</span><span class="na">inSession</span><span class="o">(</span><span class="n">session</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="n">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">session</span><span class="o">.</span><span class="na">createSelectionQuery</span><span class="o">(</span><span class="s">"select isbn||': '||title from Book"</span><span class="o">).</span><span class="na">getSingleResult</span><span class="o">());</span>
        <span class="o">});</span>

        <span class="c1">// query data using criteria API</span>
        <span class="n">sessionFactory</span><span class="o">.</span><span class="na">inSession</span><span class="o">(</span><span class="n">session</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="kt">var</span> <span class="n">builder</span> <span class="o">=</span> <span class="n">sessionFactory</span><span class="o">.</span><span class="na">getCriteriaBuilder</span><span class="o">();</span>
            <span class="kt">var</span> <span class="n">query</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="nc">String</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
            <span class="kt">var</span> <span class="n">book</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="nc">Book</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
            <span class="n">query</span><span class="o">.</span><span class="na">select</span><span class="o">(</span><span class="n">builder</span><span class="o">.</span><span class="na">concat</span><span class="o">(</span><span class="n">builder</span><span class="o">.</span><span class="na">concat</span><span class="o">(</span><span class="n">book</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">Book_</span><span class="o">.</span><span class="na">isbn</span><span class="o">),</span> <span class="n">builder</span><span class="o">.</span><span class="na">literal</span><span class="o">(</span><span class="s">": "</span><span class="o">)),</span>
                    <span class="n">book</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">Book_</span><span class="o">.</span><span class="na">title</span><span class="o">)));</span>
            <span class="n">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">session</span><span class="o">.</span><span class="na">createSelectionQuery</span><span class="o">(</span><span class="n">query</span><span class="o">).</span><span class="na">getSingleResult</span><span class="o">());</span>
        <span class="o">});</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here we&#8217;ve used Hibernate&#8217;s native APIs.
We could have used JPA-standard APIs to achieve the same thing.</p>
</div>
</div>
<div class="sect2">
<h3 id="hello-jpa">1.4. Hello, JPA</h3>
<div class="paragraph">
<p>If we limit ourselves to the use of JPA-standard APIs, we need to use XML to configure Hibernate.</p>
</div>
<div class="listingblock">
<div class="title"><code>META-INF/persistence.xml</code></div>
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;persistence</span> <span class="na">xmlns=</span><span class="s">"https://jakarta.ee/xml/ns/persistence"</span>
             <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span>
             <span class="na">xsi:schemaLocation=</span><span class="s">"https://jakarta.ee/xml/ns/persistence https://jakarta.ee/xml/ns/persistence/persistence_3_0.xsd"</span>
             <span class="na">version=</span><span class="s">"3.0"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;persistence-unit</span> <span class="na">name=</span><span class="s">"example"</span><span class="nt">&gt;</span>

        <span class="nt">&lt;class&gt;</span>org.hibernate.example.Book<span class="nt">&lt;/class&gt;</span>

        <span class="nt">&lt;properties&gt;</span>

            <span class="c">&lt;!-- H2 in-memory database --&gt;</span>
            <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"jakarta.persistence.jdbc.url"</span>
                      <span class="na">value=</span><span class="s">"jdbc:h2:mem:db1"</span><span class="nt">/&gt;</span>

            <span class="c">&lt;!-- Credentials --&gt;</span>
            <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"jakarta.persistence.jdbc.user"</span>
                      <span class="na">value=</span><span class="s">"sa"</span><span class="nt">/&gt;</span>
            <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"jakarta.persistence.jdbc.password"</span>
                      <span class="na">value=</span><span class="s">""</span><span class="nt">/&gt;</span>

            <span class="c">&lt;!-- Agroal connection pool --&gt;</span>
            <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"hibernate.agroal.maxSize"</span>
                      <span class="na">value=</span><span class="s">"20"</span><span class="nt">/&gt;</span>

            <span class="c">&lt;!-- display SQL in console --&gt;</span>
            <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"hibernate.show_sql"</span> <span class="na">value=</span><span class="s">"true"</span><span class="nt">/&gt;</span>
            <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"hibernate.format_sql"</span> <span class="na">value=</span><span class="s">"true"</span><span class="nt">/&gt;</span>
            <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"hibernate.highlight_sql"</span> <span class="na">value=</span><span class="s">"true"</span><span class="nt">/&gt;</span>

        <span class="nt">&lt;/properties&gt;</span>

    <span class="nt">&lt;/persistence-unit&gt;</span>
<span class="nt">&lt;/persistence&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that our <code>build.gradle</code> and <code>log4j2.properties</code> files are unchanged.</p>
</div>
<div class="paragraph">
<p>Our entity class is also unchanged from what we had before.</p>
</div>
<div class="paragraph">
<p>Unfortunately, JPA doesn&#8217;t offer an <code>inSession()</code> method, so we&#8217;ll have to implement session and transaction management ourselves.
We can put that logic in our own <code>inSession()</code> function, so that we don&#8217;t have to repeat it for every transaction.
Again, you don&#8217;t need to understand any of this code right now.</p>
</div>
<div id="main-jpa" class="listingblock">
<div class="title"><code>Main.java</code> (JPA version)</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kn">package</span> <span class="nn">org.hibernate.example</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">jakarta.persistence.EntityManager</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">jakarta.persistence.EntityManagerFactory</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.function.Consumer</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">static</span> <span class="n">jakarta</span><span class="o">.</span><span class="na">persistence</span><span class="o">.</span><span class="na">Persistence</span><span class="o">.</span><span class="na">createEntityManagerFactory</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">System</span><span class="o">.</span><span class="na">out</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">org</span><span class="o">.</span><span class="na">hibernate</span><span class="o">.</span><span class="na">cfg</span><span class="o">.</span><span class="na">AvailableSettings</span><span class="o">.</span><span class="na">JAKARTA_HBM2DDL_DATABASE_ACTION</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">org</span><span class="o">.</span><span class="na">hibernate</span><span class="o">.</span><span class="na">tool</span><span class="o">.</span><span class="na">schema</span><span class="o">.</span><span class="na">Action</span><span class="o">.</span><span class="na">CREATE</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Main</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">var</span> <span class="n">factory</span> <span class="o">=</span> <span class="n">createEntityManagerFactory</span><span class="o">(</span><span class="s">"example"</span><span class="o">,</span>
                <span class="c1">// export the inferred database schema</span>
                <span class="nc">Map</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="no">JAKARTA_HBM2DDL_DATABASE_ACTION</span><span class="o">,</span> <span class="no">CREATE</span><span class="o">));</span>

        <span class="c1">// persist an entity</span>
        <span class="n">inSession</span><span class="o">(</span><span class="n">factory</span><span class="o">,</span> <span class="n">entityManager</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="n">entityManager</span><span class="o">.</span><span class="na">persist</span><span class="o">(</span><span class="k">new</span> <span class="nc">Book</span><span class="o">(</span><span class="s">"9781932394153"</span><span class="o">,</span> <span class="s">"Hibernate in Action"</span><span class="o">));</span>
        <span class="o">});</span>

        <span class="c1">// query data using HQL</span>
        <span class="n">inSession</span><span class="o">(</span><span class="n">factory</span><span class="o">,</span> <span class="n">entityManager</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="n">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">entityManager</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="s">"select isbn||': '||title from Book"</span><span class="o">).</span><span class="na">getSingleResult</span><span class="o">());</span>
        <span class="o">});</span>

        <span class="c1">// query data using criteria API</span>
        <span class="n">inSession</span><span class="o">(</span><span class="n">factory</span><span class="o">,</span> <span class="n">entityManager</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="kt">var</span> <span class="n">builder</span> <span class="o">=</span> <span class="n">factory</span><span class="o">.</span><span class="na">getCriteriaBuilder</span><span class="o">();</span>
            <span class="kt">var</span> <span class="n">query</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="nc">String</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
            <span class="kt">var</span> <span class="n">book</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="nc">Book</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
            <span class="n">query</span><span class="o">.</span><span class="na">select</span><span class="o">(</span><span class="n">builder</span><span class="o">.</span><span class="na">concat</span><span class="o">(</span><span class="n">builder</span><span class="o">.</span><span class="na">concat</span><span class="o">(</span><span class="n">book</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">Book_</span><span class="o">.</span><span class="na">isbn</span><span class="o">),</span> <span class="n">builder</span><span class="o">.</span><span class="na">literal</span><span class="o">(</span><span class="s">": "</span><span class="o">)),</span>
                    <span class="n">book</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">Book_</span><span class="o">.</span><span class="na">title</span><span class="o">)));</span>
            <span class="n">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">entityManager</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="n">query</span><span class="o">).</span><span class="na">getSingleResult</span><span class="o">());</span>
        <span class="o">});</span>
    <span class="o">}</span>

    <span class="c1">// do some work in a session, performing correct transaction management</span>
    <span class="kd">static</span> <span class="kt">void</span> <span class="nf">inSession</span><span class="o">(</span><span class="nc">EntityManagerFactory</span> <span class="n">factory</span><span class="o">,</span> <span class="nc">Consumer</span><span class="o">&lt;</span><span class="nc">EntityManager</span><span class="o">&gt;</span> <span class="n">work</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">var</span> <span class="n">entityManager</span> <span class="o">=</span> <span class="n">factory</span><span class="o">.</span><span class="na">createEntityManager</span><span class="o">();</span>
        <span class="kt">var</span> <span class="n">transaction</span> <span class="o">=</span> <span class="n">entityManager</span><span class="o">.</span><span class="na">getTransaction</span><span class="o">();</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">transaction</span><span class="o">.</span><span class="na">begin</span><span class="o">();</span>
            <span class="n">work</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="n">entityManager</span><span class="o">);</span>
            <span class="n">transaction</span><span class="o">.</span><span class="na">commit</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">transaction</span><span class="o">.</span><span class="na">isActive</span><span class="o">())</span> <span class="n">transaction</span><span class="o">.</span><span class="na">rollback</span><span class="o">();</span>
            <span class="k">throw</span> <span class="n">e</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">finally</span> <span class="o">{</span>
            <span class="n">entityManager</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In practice, we never access the database directly from a <code>main()</code> method.
So now let&#8217;s talk about how to organize persistence logic in a real system.
The rest of this chapter is not compulsory.
If you&#8217;re itching for more details about Hibernate itself, you&#8217;re quite welcome to skip straight to the <a href="#entities">next chapter</a>, and come back later.</p>
</div>
</div>
<div class="sect2">
<h3 id="organizing-persistence">1.5. Organizing persistence logic</h3>
<div class="paragraph">
<p>In a real program, persistence logic like the code shown above is usually interleaved with other sorts of code, including logic:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>implementing the rules of the business domain, or</p>
</li>
<li>
<p>for interacting with the user.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Therefore, many developers quickly—even <em>too quickly</em>, in our opinion—reach for ways to isolate the persistence logic into some sort of separate architectural layer.
We&#8217;re going to ask you to suppress this urge for now.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The <em>easiest</em> way to use Hibernate is to call the <code>Session</code> or <code>EntityManager</code> directly.
If you&#8217;re new to Hibernate, frameworks which wrap JPA are only going to make your life more difficult.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We prefer a <em>bottom-up</em> approach to organizing our code.
We like to start thinking about methods and functions, not about architectural layers and container-managed objects.
To illustrate the sort of approach to code organization that we advocate, let&#8217;s consider a service which queries the database using HQL or SQL.</p>
</div>
<div class="paragraph">
<p>We might start with something like this, a mix of UI and persistence logic:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Path</span><span class="o">(</span><span class="s">"/"</span><span class="o">)</span> <span class="nd">@Produces</span><span class="o">(</span><span class="s">"application/json"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">BookResource</span> <span class="o">{</span>
    <span class="nd">@GET</span> <span class="nd">@Path</span><span class="o">(</span><span class="s">"book/{isbn}"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">Book</span> <span class="nf">getBook</span><span class="o">(</span><span class="nc">String</span> <span class="n">isbn</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">var</span> <span class="n">book</span> <span class="o">=</span> <span class="n">sessionFactory</span><span class="o">.</span><span class="na">fromTransaction</span><span class="o">(</span><span class="n">session</span> <span class="o">-&gt;</span> <span class="n">session</span><span class="o">.</span><span class="na">find</span><span class="o">(</span><span class="nc">Book</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">isbn</span><span class="o">));</span>
        <span class="k">return</span> <span class="n">book</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="nc">Response</span><span class="o">.</span><span class="na">status</span><span class="o">(</span><span class="mi">404</span><span class="o">).</span><span class="na">build</span><span class="o">()</span> <span class="o">:</span> <span class="n">book</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Indeed, we might also <em>finish</em> with something like that—it&#8217;s quite hard to identify anything concretely wrong with the code above, and for such a simple case it seems really difficult to justify making this code more complicated by introducing additional objects.</p>
</div>
<div class="paragraph">
<p>One very nice aspect of this code, which we wish to draw your attention to, is that session and transaction management is handled by generic "framework" code, just as we already recommended above.
In this case, we&#8217;re using the <a href="https://docs.jboss.org/hibernate/orm/6.3/javadocs/org/hibernate/SessionFactory.html#fromTransaction(java.util.function.Function)"><code>fromTransaction()</code></a> method, which happens to come built in to Hibernate.
But you might prefer to use something else, for example:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>in a container environment like Jakarta EE or Quarkus, <em>container-managed transactions</em> and <em>container-managed persistence contexts</em>, or</p>
</li>
<li>
<p>something you write yourself.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The important thing is that calls like <code>createEntityManager()</code> and <code>getTransaction().begin()</code> don&#8217;t belong in regular program logic, because it&#8217;s tricky and tedious to get the error handling correct.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s now consider a slightly more complicated case.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Path</span><span class="o">(</span><span class="s">"/"</span><span class="o">)</span> <span class="nd">@Produces</span><span class="o">(</span><span class="s">"application/json"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">BookResource</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="no">RESULTS_PER_PAGE</span> <span class="o">=</span> <span class="mi">20</span><span class="o">;</span>

    <span class="nd">@GET</span> <span class="nd">@Path</span><span class="o">(</span><span class="s">"books/{titlePattern}/{page:\\d+}"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Book</span><span class="o">&gt;</span> <span class="nf">findBooks</span><span class="o">(</span><span class="nc">String</span> <span class="n">titlePattern</span><span class="o">,</span> <span class="kt">int</span> <span class="n">page</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">var</span> <span class="n">books</span> <span class="o">=</span> <span class="n">sessionFactory</span><span class="o">.</span><span class="na">fromTransaction</span><span class="o">(</span><span class="n">session</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">session</span><span class="o">.</span><span class="na">createSelectionQuery</span><span class="o">(</span><span class="s">"from Book where title like ?1 order by title"</span><span class="o">,</span> <span class="nc">Book</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">setParameter</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">titlePattern</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">setPage</span><span class="o">(</span><span class="nc">Page</span><span class="o">.</span><span class="na">page</span><span class="o">(</span><span class="no">RESULTS_PER_PAGE</span><span class="o">,</span> <span class="n">page</span><span class="o">))</span>
                    <span class="o">.</span><span class="na">getResultList</span><span class="o">();</span>
        <span class="o">});</span>
        <span class="k">return</span> <span class="n">books</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">()</span> <span class="o">?</span> <span class="nc">Response</span><span class="o">.</span><span class="na">status</span><span class="o">(</span><span class="mi">404</span><span class="o">).</span><span class="na">build</span><span class="o">()</span> <span class="o">:</span> <span class="n">books</span><span class="o">;</span>
    <span class="o">}</span>

<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This is fine, and we won&#8217;t complain if you prefer to leave the code exactly as it appears above.
But there&#8217;s one thing we could perhaps improve.
We love super-short methods with single responsibilities, and there looks to be an opportunity to introduce one here.
Let&#8217;s hit the code with our favorite thing, the Extract Method refactoring. We obtain:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">static</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Book</span><span class="o">&gt;</span> <span class="nf">findBooksByTitleWithPagination</span><span class="o">(</span><span class="nc">Session</span> <span class="n">session</span><span class="o">,</span>
                                                 <span class="nc">String</span> <span class="n">titlePattern</span><span class="o">,</span> <span class="nc">Page</span> <span class="n">page</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">session</span><span class="o">.</span><span class="na">createSelectionQuery</span><span class="o">(</span><span class="s">"from Book where title like ?1 order by title"</span><span class="o">,</span> <span class="nc">Book</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
            <span class="o">.</span><span class="na">setParameter</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">titlePattern</span><span class="o">)</span>
            <span class="o">.</span><span class="na">setPage</span><span class="o">(</span><span class="n">page</span><span class="o">)</span>
            <span class="o">.</span><span class="na">getResultList</span><span class="o">();</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This is an example of a <em>query method</em>, a function which accepts arguments to the parameters of a HQL or SQL query, and executes the query, returning its results to the caller.
And that&#8217;s all it does; it doesn&#8217;t orchestrate additional program logic, and it doesn&#8217;t perform transaction or session management.</p>
</div>
<div class="paragraph">
<p>It&#8217;s even better to specify the query string using the <code>@NamedQuery</code> annotation, so that Hibernate can validate the query it at startup time, that is, when the <code>SessionFactory</code> is created, instead of when the query is first executed.
Indeed, since we included the <a href="#metamodel-generator">Metamodel Generator</a> in our <a href="#build-gradle">Gradle build</a>, the query can even be validated at <em>compile time</em>.</p>
</div>
<div class="paragraph">
<p>We need a place to put the annotation, so lets move our query method to a new class:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@CheckHQL</span> <span class="c1">// validate named queries at compile time</span>
<span class="nd">@NamedQuery</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"findBooksByTitle"</span><span class="o">,</span>
            <span class="n">query</span><span class="o">=</span><span class="s">"from Book where title like :title order by title"</span><span class="o">)</span>
<span class="kd">class</span> <span class="nc">Queries</span> <span class="o">{</span>

    <span class="kd">static</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Book</span><span class="o">&gt;</span> <span class="nf">findBooksByTitleWithPagination</span><span class="o">(</span><span class="nc">Session</span> <span class="n">session</span><span class="o">,</span>
                                                     <span class="nc">String</span> <span class="n">titlePattern</span><span class="o">,</span> <span class="nc">Page</span> <span class="n">page</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">session</span><span class="o">.</span><span class="na">createNamedQuery</span><span class="o">(</span><span class="s">"findBooksByTitle"</span><span class="o">,</span> <span class="nc">Book</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
                <span class="o">.</span><span class="na">setParameter</span><span class="o">(</span><span class="s">"title"</span><span class="o">,</span> <span class="n">titlePattern</span><span class="o">)</span>
                <span class="o">.</span><span class="na">setPage</span><span class="o">(</span><span class="n">page</span><span class="o">)</span>
                <span class="o">.</span><span class="na">getResultList</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice that our query method doesn&#8217;t attempt to hide the <code>EntityManager</code> from its clients.
Indeed, the client code is responsible for providing the <code>EntityManager</code> or <code>Session</code> to the query method.
This is a quite distinctive feature of our whole approach.</p>
</div>
<div class="paragraph">
<p>The client code may:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>obtain an <code>EntityManager</code> or <code>Session</code> by calling <code>inTransaction()</code> or <code>fromTransaction()</code>, as we saw above, or,</p>
</li>
<li>
<p>in an environment with container-managed transactions, it might obtain it via dependency injection.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Whatever the case, the code which orchestrates a unit of work usually just calls the <code>Session</code> or <code>EntityManager</code> directly, passing it along to helper methods like our query method if necessary.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@GET</span>
<span class="nd">@Path</span><span class="o">(</span><span class="s">"books/{titlePattern}"</span><span class="o">)</span>
<span class="kd">public</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Book</span><span class="o">&gt;</span> <span class="nf">findBooks</span><span class="o">(</span><span class="nc">String</span> <span class="n">titlePattern</span><span class="o">)</span> <span class="o">{</span>
    <span class="kt">var</span> <span class="n">books</span> <span class="o">=</span> <span class="n">sessionFactory</span><span class="o">.</span><span class="na">fromTransaction</span><span class="o">(</span><span class="n">session</span> <span class="o">-&gt;</span>
            <span class="nc">Queries</span><span class="o">.</span><span class="na">findBooksByTitleWithPagination</span><span class="o">(</span><span class="n">session</span><span class="o">,</span> <span class="n">titlePattern</span><span class="o">,</span>
                    <span class="nc">Page</span><span class="o">.</span><span class="na">page</span><span class="o">(</span><span class="no">RESULTS_PER_PAGE</span><span class="o">,</span> <span class="n">page</span><span class="o">));</span>
    <span class="k">return</span> <span class="n">books</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">()</span> <span class="o">?</span> <span class="nc">Response</span><span class="o">.</span><span class="na">status</span><span class="o">(</span><span class="mi">404</span><span class="o">).</span><span class="na">build</span><span class="o">()</span> <span class="o">:</span> <span class="n">books</span><span class="o">;</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You might be thinking that our query method looks a bit boilerplatey.
That&#8217;s true, perhaps, but we&#8217;re much more concerned that it&#8217;s not very typesafe.
Indeed, for many years, the lack of compile-time checking for HQL queries and code which binds arguments to query parameters was our number one source of discomfort with Hibernate.</p>
</div>
<div class="paragraph">
<p>Fortunately, there&#8217;s now a solution to both problems: as an incubating feature of Hibernate 6.3, we now offer the possibility to have the Metamodel Generator fill in the implementation of such query methods for you.
This facility is the topic of <a href="#generator">a whole chapter of this introduction</a>, so for now we&#8217;ll just leave you with one simple example.</p>
</div>
<div class="paragraph">
<p>Suppose we simplify <code>Queries</code> to just the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">interface</span> <span class="nc">Queries</span> <span class="o">{</span>
    <span class="nd">@HQL</span><span class="o">(</span><span class="s">"where title like :title order by title"</span><span class="o">)</span>
    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Book</span><span class="o">&gt;</span> <span class="nf">findBooksByTitleWithPagination</span><span class="o">(</span><span class="nc">String</span> <span class="n">title</span><span class="o">,</span> <span class="nc">Page</span> <span class="n">page</span><span class="o">);</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Then the Metamodel Generator automatically produces an implementation of the method annotated <code>@HQL</code> in a class named <code>Queries_</code>.
We can call it just like we called our handwritten version:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@GET</span>
<span class="nd">@Path</span><span class="o">(</span><span class="s">"books/{titlePattern}"</span><span class="o">)</span>
<span class="kd">public</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Book</span><span class="o">&gt;</span> <span class="nf">findBooks</span><span class="o">(</span><span class="nc">String</span> <span class="n">titlePattern</span><span class="o">)</span> <span class="o">{</span>
    <span class="kt">var</span> <span class="n">books</span> <span class="o">=</span> <span class="n">sessionFactory</span><span class="o">.</span><span class="na">fromTransaction</span><span class="o">(</span><span class="n">session</span> <span class="o">-&gt;</span>
            <span class="n">Queries_</span><span class="o">.</span><span class="na">findBooksByTitleWithPagination</span><span class="o">(</span><span class="n">session</span><span class="o">,</span> <span class="n">titlePattern</span><span class="o">,</span>
                    <span class="nc">Page</span><span class="o">.</span><span class="na">page</span><span class="o">(</span><span class="no">RESULTS_PER_PAGE</span><span class="o">,</span> <span class="n">page</span><span class="o">));</span>
    <span class="k">return</span> <span class="n">books</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">()</span> <span class="o">?</span> <span class="nc">Response</span><span class="o">.</span><span class="na">status</span><span class="o">(</span><span class="mi">404</span><span class="o">).</span><span class="na">build</span><span class="o">()</span> <span class="o">:</span> <span class="n">books</span><span class="o">;</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In this case, the quantity of code eliminated is pretty trivial.
The real value is in improved type safety.
We now find out about errors in assignments of arguments to query parameters at compile time.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>At this point, we&#8217;re certain you&#8217;re full of doubts about this idea.
And quite rightly so.
We would love to answer your objections right here, but that will take us much too far off track.
So we ask you to file away these thoughts for now.
We promise to make it make sense when we <a href="#generator">properly address this topic later</a>.
And, after that, if you still don&#8217;t like this approach, please understand that it&#8217;s completely optional.
Nobody&#8217;s going to come around to your house to force it down your throat.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now that we have a rough picture of what our persistence logic might look like, it&#8217;s natural to ask how we should test our code.</p>
</div>
</div>
<div class="sect2">
<h3 id="testing">1.6. Testing persistence logic</h3>
<div class="paragraph">
<p>When we write tests for our persistence logic, we&#8217;re going to need:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>a database, with</p>
</li>
<li>
<p>an instance of the schema mapped by our persistent entities, and</p>
</li>
<li>
<p>a set of test data, in a well-defined state at the beginning of each test.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>It might seem obvious that we should test against the same database system that we&#8217;re going to use in production, and, indeed, we should certainly have at least <em>some</em> tests for this configuration.
But on the other hand, tests which perform I/O are much slower than tests which don&#8217;t, and most databases can&#8217;t be set up to run in-process.</p>
</div>
<div class="paragraph">
<p>So, since most persistence logic written using Hibernate 6 is <em>extremely</em> portable between databases, it often makes good sense to test against an in-memory Java database.
(<a href="http://www.h2database.com">H2</a> is the one we recommend.)</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="paragraph">
<p>We do need to be careful here if our persistence code uses native SQL, or if it uses concurrency-management features like pessimistic locks.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Whether we&#8217;re testing against our real database, or against an in-memory Java database, we&#8217;ll need to export the schema at the beginning of a test suite.
We <em>usually</em> do this when we create the Hibernate <code>SessionFactory</code> or JPA <code>EntityManager</code>, and so traditionally we&#8217;ve used a <a href="#automatic-schema-export">configuration property</a> for this.</p>
</div>
<div class="paragraph">
<p>The JPA-standard property is <code>jakarta.persistence.schema-generation.database.action</code>.
For example, if we&#8217;re using <code>Configuration</code> to configure Hibernate, we could write:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="n">configuration</span><span class="o">.</span><span class="na">setProperty</span><span class="o">(</span><span class="nc">AvailableSettings</span><span class="o">.</span><span class="na">JAKARTA_HBM2DDL_DATABASE_ACTION</span><span class="o">,</span>
                          <span class="nc">Action</span><span class="o">.</span><span class="na">SPEC_ACTION_DROP_AND_CREATE</span><span class="o">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Alternatively, in Hibernate 6, we may use the new <a href="https://docs.jboss.org/hibernate/orm/6.3/javadocs/org/hibernate/relational/SchemaManager.html"><code>SchemaManager</code></a> API to export the schema, just as we did <a href="#main-hibernate">above</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="n">sessionFactory</span><span class="o">.</span><span class="na">getSchemaManager</span><span class="o">().</span><span class="na">exportMappedObjects</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Since executing DDL statements is very slow on many databases, we don&#8217;t want to do this before every test.
Instead, to ensure that each test begins with the test data in a well-defined state, we need to do two things before each test:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>clean up any mess left behind by the previous test, and then</p>
</li>
<li>
<p>reinitialize the test data.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>We may truncate all the tables, leaving an empty database schema, using the <code>SchemaManager</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="n">sessionFactory</span><span class="o">.</span><span class="na">getSchemaManager</span><span class="o">().</span><span class="na">truncateMappedObjects</span><span class="o">();</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>After truncating tables, we might need to initialize our test data.
We may specify test data in a SQL script, for example:</p>
</div>
<div id="import.sql" class="listingblock">
<div class="title">/import.sql</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="sql"><span class="k">insert</span> <span class="k">into</span> <span class="n">Books</span> <span class="p">(</span><span class="n">isbn</span><span class="p">,</span> <span class="n">title</span><span class="p">)</span> <span class="k">values</span> <span class="p">(</span><span class="s1">'9781932394153'</span><span class="p">,</span> <span class="s1">'Hibernate in Action'</span><span class="p">)</span>
<span class="k">insert</span> <span class="k">into</span> <span class="n">Books</span> <span class="p">(</span><span class="n">isbn</span><span class="p">,</span> <span class="n">title</span><span class="p">)</span> <span class="k">values</span> <span class="p">(</span><span class="s1">'9781932394887'</span><span class="p">,</span> <span class="s1">'Java Persistence with Hibernate'</span><span class="p">)</span>
<span class="k">insert</span> <span class="k">into</span> <span class="n">Books</span> <span class="p">(</span><span class="n">isbn</span><span class="p">,</span> <span class="n">title</span><span class="p">)</span> <span class="k">values</span> <span class="p">(</span><span class="s1">'9781617290459'</span><span class="p">,</span> <span class="s1">'Java Persistence with Hibernate, Second Edition'</span><span class="p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If we name this file <code>import.sql</code>, and place it in the root classpath, that&#8217;s all we need to do.</p>
</div>
<div class="paragraph">
<p>Otherwise, we need to specify the file in the <a href="#automatic-schema-export">configuration property</a> <code>jakarta.persistence.sql-load-script-source</code>.
If we&#8217;re using <code>Configuration</code> to configure Hibernate, we could write:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="n">configuration</span><span class="o">.</span><span class="na">setProperty</span><span class="o">(</span><span class="nc">AvailableSettings</span><span class="o">.</span><span class="na">JAKARTA_HBM2DDL_LOAD_SCRIPT_SOURCE</span><span class="o">,</span>
                          <span class="s">"/org/example/test-data.sql"</span><span class="o">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The SQL script will be executed every time <code>exportMappedObjects()</code> or <code>truncateMappedObjects()</code> is called.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>There&#8217;s another sort of mess a test can leave behind: cached data in the <a href="#second-level-cache">second-level cache</a>.
We recommend <em>disabling</em> Hibernate&#8217;s second-level cache for most sorts of testing.
Alternatively, if the second-level cache is not disabled, then before each test we should call:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="n">sessionFactory</span><span class="o">.</span><span class="na">getCache</span><span class="o">().</span><span class="na">evictAllRegions</span><span class="o">();</span></code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now, suppose you&#8217;ve followed our advice, and written your entities and query methods to minimize dependencies on "infrastructure", that is, on libraries other than JPA and Hibernate, on frameworks,  on container-managed objects, and even on bits of your own system which are hard to instantiate from scratch.
Then testing persistence logic is now straightforward!</p>
</div>
<div class="paragraph">
<p>You&#8217;ll need to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>bootstrap Hibernate and create a <code>SessionFactory</code> or <code>EntityManagerFactory</code> and the beginning of your test suite (we&#8217;ve already seen how to do that), and</p>
</li>
<li>
<p>create a new <code>Session</code> or <code>EntityManager</code> inside each <code>@Test</code> method, using <code>inTransaction()</code>, for example.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Actually, some tests might require multiple sessions.
But be careful not to leak a session between different tests.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Another important test we&#8217;ll need is one which validates our <a href="#object-relational-mapping">O/R mapping annotations</a> against the actual database schema.
This is again the job of the schema management tooling, either:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="n">configuration</span><span class="o">.</span><span class="na">setProperty</span><span class="o">(</span><span class="nc">AvailableSettings</span><span class="o">.</span><span class="na">JAKARTA_HBM2DDL_DATABASE_ACTION</span><span class="o">,</span>
                          <span class="nc">Action</span><span class="o">.</span><span class="na">ACTION_VALIDATE</span><span class="o">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Or:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="n">sessionFactory</span><span class="o">.</span><span class="na">getSchemaManager</span><span class="o">().</span><span class="na">validateMappedObjects</span><span class="o">();</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This "test" is one which many people like to run even in production, when the system starts up.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="architecture">1.7. Architecture and the persistence layer</h3>
<div class="paragraph">
<p>Let&#8217;s now consider a different approach to code organization, one we treat with suspicion.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>In this section, we&#8217;re going to give you our <em>opinion</em>.
If you&#8217;re only interested in facts, or if you prefer not to read things that might undermine the opinion you currently hold, please feel free to skip straight to the <a href="#entities">next chapter</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Hibernate is an architecture-agnostic library, not a framework, and therefore integrates comfortably with a wide range of Java frameworks and containers.
Consistent with our place within the ecosystem, we&#8217;ve historically avoided giving out much advice on architecture.
This is a practice we&#8217;re now perhaps inclined to regret, since the resulting vacuum has come to be filled with advice from people advocating architectures, design patterns, and extra frameworks which we suspect make Hibernate a bit less pleasant to use than it should be.</p>
</div>
<div class="paragraph">
<p>In particular, frameworks which wrap JPA seem to add bloat while subtracting some of the fine-grained control over data access that Hibernate works so hard to provide.
These frameworks don&#8217;t expose the full feature set of Hibernate, and so the program is forced to work with a less powerful abstraction.</p>
</div>
<div class="paragraph">
<p>The stodgy, dogmatic, <em>conventional</em> wisdom, which we hesitate to challenge for simple fear of pricking ourselves on the erect hackles that inevitably accompany such dogma-baiting is:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Code which interacts with the database belongs in a separate <em>persistence layer</em>.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>We lack the courage—perhaps even the conviction—to tell you categorically to <em>not</em> follow this recommendation.
But we do ask you to consider the cost in boilerplate of any architectural layer, and whether the benefits this cost buys are really worth it in the context of your system.</p>
</div>
<div class="paragraph">
<p>To add a little background texture to this discussion, and at the risk of our Introduction degenerating into a rant at such an early stage, we&#8217;re going ask you to humor us while talk a little more about ancient history.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">An epic tale of DAOs and Repositories</div>
<div class="paragraph">
<p>Back in the dark days of Java EE 4, before the standardization of Hibernate, and subsequent ascendance of JPA in Java enterprise development, it was common to hand-code the messy JDBC interactions that Hibernate takes care of today.
In those terrible times, a pattern arose that we used to call <em>Data Access Objects</em> (DAOs).
A DAO gave you a place to put all that nasty JDBC code, leaving the important program logic cleaner.</p>
</div>
<div class="paragraph">
<p>When Hibernate arrived suddenly on the scene in 2001, developers loved it.
But Hibernate implemented no specification, and many wished to reduce or at least <em>localize</em> the dependence of their project logic on Hibernate.
An obvious solution was to keep the DAOs around, but to replace the JDBC code inside them with calls to the Hibernate <code>Session</code>.</p>
</div>
<div class="paragraph">
<p>We partly blame ourselves for what happened next.</p>
</div>
<div class="paragraph">
<p>Back in 2002 and 2003 this really seemed like a pretty reasonable thing to do.
In fact, we contributed to the popularity of this approach by recommending—or at least not discouraging—the use of DAOs in <em>Hibernate in Action</em>.
We hereby apologize for this mistake, and for taking much too long to recognize it.</p>
</div>
<div class="paragraph">
<p>Eventually, some folks came to believe that their DAOs shielded their program from depending in a hard way on ORM, allowing them to "swap out" Hibernate, and replace it with JDBC, or with something else.
In fact, this was never really true—there&#8217;s quite a deep difference between the programming model of JDBC, where every interaction with the database is explicit and synchronous, and the programming model of stateful sessions in Hibernate, where updates are implicit, and SQL statements are executed asynchronously.</p>
</div>
<div class="paragraph">
<p>But then the whole landscape for persistence in Java changed in April 2006, when the final draft of JPA 1.0 was approved.
Java now had a standard way to do ORM, with multiple high-quality implementations of the standard API.
This was the end of the line for the DAOs, right?</p>
</div>
<div class="paragraph">
<p>Well, no.
It wasn&#8217;t.
DAOs were rebranded "repositories", and continue to enjoy a sort-of zombie afterlife as a front-end to JPA.
But are they really pulling their weight, or are they just unnecessary extra complexity and bloat? An extra layer of indirection that makes stack traces harder to read and code harder to debug?</p>
</div>
<div class="paragraph">
<p>Our considered view is that they&#8217;re mostly just bloat.
The JPA <code>EntityManager</code> is a "repository", and it&#8217;s a standard repository with a well-defined specification written by people who spend all day thinking about persistence.
If these repository frameworks offered anything actually <em>useful</em>—and not obviously foot-shooty—over and above what <code>EntityManager</code> provides, we would have already added it to <code>EntityManager</code> decades ago.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>Ultimately, we&#8217;re not sure you need a separate persistence layer at all.
At least <em>consider</em> the possibility that it might be OK to call the <code>EntityManager</code> directly from your business logic.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="images/architecture.png" alt="API overview" width="1100">
</div>
</div>
<div class="paragraph">
<p>We can already hear you hissing at our heresy.
But before slamming shut the lid of your laptop and heading off to fetch garlic and a pitchfork, take a couple of hours to weigh what we&#8217;re proposing.</p>
</div>
<div class="paragraph">
<p>OK, so, look, if it makes you feel better, one way to view <code>EntityManager</code> is to think of it as a single <em>generic</em> "repository" that works for every entity in your system.
From this point of view, JPA <em>is</em> your persistence layer.
And there&#8217;s few good reasons to wrap this abstraction in a second abstraction that&#8217;s <em>less</em> generic.</p>
</div>
<div class="paragraph">
<p>Even where a distinct persistence layer <em>is</em> appropriate, DAO-style repositories aren&#8217;t the unambiguously most-correct way to factorize the equation:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>most nontrivial queries touch multiple entities, and so it&#8217;s often quite ambiguous which repository such a query belongs to,</p>
</li>
<li>
<p>most queries are extremely specific to a particular fragment of program logic, and aren&#8217;t reused in different places across the system, and</p>
</li>
<li>
<p>the various operations of a repository rarely interact or share common internal implementation details.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Indeed, repositories, by nature, exhibit very low <em>cohesion</em>.
A layer of repository objects might make sense if you have multiple implementations of each repository, but in practice almost nobody ever does.
That&#8217;s because they&#8217;re also extremely highly <em>coupled</em> to their clients, with a very large API surface.
And, on the contrary, a layer is only easily replaceable if it has a very <em>narrow</em> API.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Some people do indeed use mock repositories for testing, but we really struggle to see any value in this.
If we don&#8217;t want to run our tests against our real database, it&#8217;s usually very easy to "mock" the database itself by running tests against an in-memory Java database like H2.
This works even better in Hibernate 6 than in older versions of Hibernate, since HQL is now <em>much</em> more portable between platforms.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><em>Phew</em>, let&#8217;s move on.</p>
</div>
</div>
<div class="sect2">
<h3 id="overview">1.8. Overview</h3>
<div class="paragraph">
<p>It&#8217;s now time to begin our journey toward actually <em>understanding</em> the code we saw earlier.</p>
</div>
<div class="paragraph">
<p>This introduction will guide you through the basic tasks involved in developing a program that uses Hibernate for persistence:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>configuring and bootstrapping Hibernate, and obtaining an instance of <code>SessionFactory</code> or <code>EntityManagerFactory</code>,</p>
</li>
<li>
<p>writing a <em>domain model</em>, that is, a set of <em>entity classes</em> which represent the persistent types in your program, and which map to tables of your database,</p>
</li>
<li>
<p>customizing these mappings when the model maps to a pre-existing relational schema,</p>
</li>
<li>
<p>using the <code>Session</code> or <code>EntityManager</code> to perform operations which query the database and return entity instances, or which update the data held in the database,</p>
</li>
<li>
<p>using the Hibernate Metamodel Generator to improve compile-time type-safety,</p>
</li>
<li>
<p>writing complex queries using the Hibernate Query Language (HQL) or native SQL, and, finally</p>
</li>
<li>
<p>tuning performance of the data access logic.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Naturally, we&#8217;ll start at the top of this list, with the least-interesting topic: <em>configuration</em>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="configuration">2. Configuration and bootstrap</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We would love to make this section short.
Unfortunately, there&#8217;s several distinct ways to configure and bootstrap Hibernate, and we&#8217;re going to have to describe at least two of them in detail.</p>
</div>
<div class="paragraph">
<p>The four basic ways to obtain an instance of Hibernate are shown in the following table:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Using the standard JPA-defined XML, and the operation <code>Persistence.createEntityManagerFactory()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Usually chosen when portability between JPA implementations is important.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Using the <a href="https://docs.jboss.org/hibernate/orm/6.3/javadocs/org/hibernate/cfg/Configuration.html"><code>Configuration</code></a> class to construct a <code>SessionFactory</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">When portability between JPA implementations is not important, this option is quicker, adds some flexibility and saves a typecast.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Using the more complex APIs defined in <a href="https://docs.jboss.org/hibernate/orm/6.3/javadocs/org/hibernate/boot/package-summary.html"><code>org.hibernate.boot</code></a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Used primarily by framework integrators, this option is outside the scope of this document.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">By letting the container take care of the bootstrap process and of injecting the <code>SessionFactory</code> or <code>EntityManagerFactory</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Used in a container environment like WildFly or Quarkus.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Here we&#8217;ll focus on the first two options.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Hibernate in containers</div>
<div class="paragraph">
<p>Actually, the last option is extremely popular, since every major Java application server and microservice framework comes with built-in support for Hibernate.
Such container environments typically also feature facilities to automatically manage the lifecycle of an <code>EntityManager</code> or <code>Session</code> and its association with container-managed transactions.</p>
</div>
<div class="paragraph">
<p>To learn how to configure Hibernate in such a container environment, you&#8217;ll need to refer to the documentation of your chosen container.
For Quarkus, here&#8217;s the <a href="https://quarkus.io/guides/hibernate-orm">relevant documentation</a>.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>If you&#8217;re using Hibernate outside of a container environment,
you&#8217;ll need to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>include Hibernate ORM itself, along with the appropriate JDBC driver, as dependencies of your project, and</p>
</li>
<li>
<p>configure Hibernate with information about your database,
by specifying configuration properties.</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="required-dependencies">2.1. Including Hibernate in your project build</h3>
<div class="paragraph">
<p>First, add the following dependency to your project:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>org.hibernate.orm:hibernate-core:{version}</pre>
</div>
</div>
<div class="paragraph">
<p>Where <code>{version}</code> is the version of Hibernate you&#8217;re using.</p>
</div>
<div class="paragraph">
<p>You&#8217;ll also need to add a dependency for the JDBC
driver for your database.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 2. JDBC driver dependencies</caption>
<colgroup>
<col style="width: 50%;">
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Database</th>
<th class="tableblock halign-left valign-top">Driver dependency</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">PostgreSQL or CockroachDB</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.postgresql:postgresql:{version}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">MySQL or TiDB</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>com.mysql:mysql-connector-j:{version}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">MariaDB</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.mariadb.jdbc:mariadb-java-client:{version}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">DB2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>com.ibm.db2:jcc:{version}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">SQL Server</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>com.microsoft.sqlserver:mssql-jdbc:${version}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Oracle</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>com.oracle.database.jdbc:ojdbc11:${version}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">H2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>com.h2database:h2:{version}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">HSQLDB</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.hsqldb:hsqldb:{version}</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Where <code>{version}</code> is the latest version of the JDBC driver for your databse.</p>
</div>
</div>
<div class="sect2">
<h3 id="optional-dependencies">2.2. Optional dependencies</h3>
<div class="paragraph">
<p>Optionally, you might also add any of the following additional features:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 3. Optional dependencies</caption>
<colgroup>
<col style="width: 50%;">
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Optional feature</th>
<th class="tableblock halign-left valign-top">Dependencies</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">An <a href="http://www.slf4j.org/">SLF4J</a> logging implementation</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.apache.logging.log4j:log4j-core</code><br>
or <code>org.slf4j:slf4j-jdk14</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">A JDBC connection pool, for example, <a href="https://agroal.github.io">Agroal</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.hibernate.orm:hibernate-agroal</code><br>
and <code>io.agroal:agroal-pool</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">The <a href="https://hibernate.org/orm/tooling/">Hibernate Metamodel Generator</a>, especially if you&#8217;re using the JPA criteria query API</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.hibernate.orm:hibernate-jpamodelgen</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">The <a href="https://github.com/hibernate/query-validator/">Query Validator</a>, for compile-time checking of HQL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.hibernate:query-validator</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://hibernate.org/validator">Hibernate Validator</a>, an implementation of <a href="https://beanvalidation.org">Bean Validation</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.hibernate.validator:hibernate-validator</code><br>
and <code>org.glassfish:jakarta.el</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Local second-level cache support via JCache and <a href="https://www.ehcache.org">EHCache</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.hibernate.orm:hibernate-jcache</code><br>
and <code>org.ehcache:ehcache</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Local second-level cache support via JCache and <a href="https://github.com/ben-manes/caffeine/">Caffeine</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.hibernate.orm:hibernate-jcache</code><br>
and <code>com.github.ben-manes.caffeine:jcache</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Distributed second-level cache support via <a href="https://infinispan.org">Infinispan</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.infinispan:infinispan-hibernate-cache-v60</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">A JSON serialization library for working with JSON datatypes, for example, <a href="https://github.com/FasterXML/jackson">Jackson</a> or <a href="https://projects.eclipse.org/projects/ee4j.yasson">Yasson</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>com.fasterxml.jackson.core:jackson-databind</code><br>
or <code>org.eclipse:yasson</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#spatial">Hibernate Spatial</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.hibernate.orm:hibernate-spatial</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#envers">Envers</a>, for auditing historical data</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.hibernate.orm:hibernate-envers</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>You might also add the Hibernate <a href="https://docs.jboss.org/hibernate/orm/6.3/userguide/html_single/Hibernate_User_Guide.html#tooling-gradle">bytecode enhancer</a> to your
Gradle build if you want to use <a href="#bytecode-enhancer">field-level lazy fetching</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="configuration-jpa">2.3. Configuration using JPA XML</h3>
<div class="paragraph">
<p>Sticking to the JPA-standard approach, we would provide a file named <code>persistence.xml</code>, which we usually place in the <code>META-INF</code> directory of a <em>persistence archive</em>, that is, of the <code>.jar</code> file or directory which contains our entity classes.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;persistence</span> <span class="na">xmlns=</span><span class="s">"http://java.sun.com/xml/ns/persistence"</span>
             <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span>
             <span class="na">xsi:schemaLocation=</span><span class="s">"http://java.sun.com/xml/ns/persistence https://jakarta.ee/xml/ns/persistence/persistence_3_0.xsd"</span>
             <span class="na">version=</span><span class="s">"2.0"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;persistence-unit</span> <span class="na">name=</span><span class="s">"org.hibernate.example"</span><span class="nt">&gt;</span>

        <span class="nt">&lt;class&gt;</span>org.hibernate.example.Book<span class="nt">&lt;/class&gt;</span>
        <span class="nt">&lt;class&gt;</span>org.hibernate.example.Author<span class="nt">&lt;/class&gt;</span>

        <span class="nt">&lt;properties&gt;</span>
            <span class="c">&lt;!-- PostgreSQL --&gt;</span>
            <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"jakarta.persistence.jdbc.url"</span>
                      <span class="na">value=</span><span class="s">"jdbc:postgresql://localhost/example"</span><span class="nt">/&gt;</span>

            <span class="c">&lt;!-- Credentials --&gt;</span>
            <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"jakarta.persistence.jdbc.user"</span>
                      <span class="na">value=</span><span class="s">"gavin"</span><span class="nt">/&gt;</span>
            <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"jakarta.persistence.jdbc.password"</span>
                      <span class="na">value=</span><span class="s">"hibernate"</span><span class="nt">/&gt;</span>

            <span class="c">&lt;!-- Automatic schema export --&gt;</span>
            <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"jakarta.persistence.schema-generation.database.action"</span>
                      <span class="na">value=</span><span class="s">"drop-and-create"</span><span class="nt">/&gt;</span>

            <span class="c">&lt;!-- SQL statement logging --&gt;</span>
            <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"hibernate.show_sql"</span> <span class="na">value=</span><span class="s">"true"</span><span class="nt">/&gt;</span>
            <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"hibernate.format_sql"</span> <span class="na">value=</span><span class="s">"true"</span><span class="nt">/&gt;</span>
            <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"hibernate.highlight_sql"</span> <span class="na">value=</span><span class="s">"true"</span><span class="nt">/&gt;</span>

        <span class="nt">&lt;/properties&gt;</span>

    <span class="nt">&lt;/persistence-unit&gt;</span>

<span class="nt">&lt;/persistence&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>&lt;persistence-unit&gt;</code> element defines a named <em>persistence unit</em>, that is:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>a collection of associated entity types, along with</p>
</li>
<li>
<p>a set of default configuration settings, which may be augmented or overridden at runtime.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Each <code>&lt;class&gt;</code> element specifies the fully-qualified name of an entity class.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Scanning for entity classes</div>
<div class="paragraph">
<p>In some container environments, for example, in any EE container, the <code>&lt;class&gt;</code> elements are unnecessary, since the container will scan the archive for annotated classes, and automatically recognize any class annotated <code>@Entity</code>.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>Each <code>&lt;property&gt;</code> element specifies a <em>configuration property</em> and its value.
Note that:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the configuration properties in the <code>jakarta.persistence</code> namespace are standard properties defined by the JPA spec, and</p>
</li>
<li>
<p>properties in the <code>hibernate</code> namespace are specific to Hibernate.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>We may obtain an <code>EntityManagerFactory</code> by calling <code>Persistence.createEntityManagerFactory()</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nc">EntityManagerFactory</span> <span class="n">entityManagerFactory</span> <span class="o">=</span>
    <span class="nc">Persistence</span><span class="o">.</span><span class="na">createEntityManagerFactory</span><span class="o">(</span><span class="s">"org.hibernate.example"</span><span class="o">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If necessary, we may override configuration properties specified in <code>persistence.xml</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nc">EntityManagerFactory</span> <span class="n">entityManagerFactory</span> <span class="o">=</span>
    <span class="nc">Persistence</span><span class="o">.</span><span class="na">createEntityManagerFactory</span><span class="o">(</span><span class="s">"org.hibernate.example"</span><span class="o">,</span>
            <span class="nc">Map</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="nc">AvailableSettings</span><span class="o">.</span><span class="na">JAKARTA_JDBC_PASSWORD</span><span class="o">,</span> <span class="n">password</span><span class="o">));</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="configuration-api">2.4. Configuration using Hibernate API</h3>
<div class="paragraph">
<p>Alternatively, the venerable class <a href="https://docs.jboss.org/hibernate/orm/6.3/javadocs/org/hibernate/cfg/Configuration.html"><code>Configuration</code></a> allows an instance of Hibernate to be configured in Java code.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nc">SessionFactory</span> <span class="n">sessionFactory</span> <span class="o">=</span>
        <span class="k">new</span> <span class="nf">Configuration</span><span class="o">()</span>
            <span class="o">.</span><span class="na">addAnnotatedClass</span><span class="o">(</span><span class="nc">Book</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
            <span class="o">.</span><span class="na">addAnnotatedClass</span><span class="o">(</span><span class="nc">Author</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
            <span class="c1">// PostgreSQL</span>
            <span class="o">.</span><span class="na">setProperty</span><span class="o">(</span><span class="nc">AvailableSettings</span><span class="o">.</span><span class="na">JAKARTA_JDBC_URL</span><span class="o">,</span> <span class="s">"jdbc:postgresql://localhost/example"</span><span class="o">)</span>
            <span class="c1">// Credentials</span>
            <span class="o">.</span><span class="na">setProperty</span><span class="o">(</span><span class="nc">AvailableSettings</span><span class="o">.</span><span class="na">JAKARTA_JDBC_USER</span><span class="o">,</span> <span class="n">user</span><span class="o">)</span>
            <span class="o">.</span><span class="na">setProperty</span><span class="o">(</span><span class="nc">AvailableSettings</span><span class="o">.</span><span class="na">JAKARTA_JDBC_PASSWORD</span><span class="o">,</span> <span class="n">password</span><span class="o">)</span>
            <span class="c1">// Automatic schema export</span>
            <span class="o">.</span><span class="na">setProperty</span><span class="o">(</span><span class="nc">AvailableSettings</span><span class="o">.</span><span class="na">JAKARTA_HBM2DDL_DATABASE_ACTION</span><span class="o">,</span>
                         <span class="nc">Action</span><span class="o">.</span><span class="na">SPEC_ACTION_DROP_AND_CREATE</span><span class="o">)</span>
            <span class="c1">// SQL statement logging</span>
            <span class="o">.</span><span class="na">setProperty</span><span class="o">(</span><span class="nc">AvailableSettings</span><span class="o">.</span><span class="na">SHOW_SQL</span><span class="o">,</span> <span class="no">TRUE</span><span class="o">.</span><span class="na">toString</span><span class="o">())</span>
            <span class="o">.</span><span class="na">setProperty</span><span class="o">(</span><span class="nc">AvailableSettings</span><span class="o">.</span><span class="na">FORMAT_SQL</span><span class="o">,</span> <span class="no">TRUE</span><span class="o">.</span><span class="na">toString</span><span class="o">())</span>
            <span class="o">.</span><span class="na">setProperty</span><span class="o">(</span><span class="nc">AvailableSettings</span><span class="o">.</span><span class="na">HIGHLIGHT_SQL</span><span class="o">,</span> <span class="no">TRUE</span><span class="o">.</span><span class="na">toString</span><span class="o">())</span>
            <span class="c1">// Create a new SessionFactory</span>
            <span class="o">.</span><span class="na">buildSessionFactory</span><span class="o">();</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>Configuration</code> class has survived almost unchanged since the very earliest (pre-1.0) versions of Hibernate, and so it doesn&#8217;t look particularly modern.
On the other hand, it&#8217;s very easy to use, and exposes some options that <code>persistence.xml</code> doesn&#8217;t support.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Advanced configuration options</div>
<div class="paragraph">
<p>Actually, the <code>Configuration</code> class is just a very simple facade for the more modern, much more powerful—but more complex—API defined in the package <code>org.hibernate.boot</code>.
This API is useful if you have very advanced requirements, for example, if you&#8217;re writing a framework or implementing a container.
You&#8217;ll find more information in the <a href="https://docs.jboss.org/hibernate/orm/6.3/userguide/html_single/Hibernate_User_Guide.html#bootstrap-native">User Guide</a>, and in the <a href="https://docs.jboss.org/hibernate/orm/6.3/javadocs//org/hibernate/boot/package-summary.html">package-level documentation</a> of <code>org.hibernate.boot</code>.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="configuration-properties">2.5. Configuration using Hibernate properties file</h3>
<div class="paragraph">
<p>If we&#8217;re using the Hibernate <code>Configuration</code> API, but we don&#8217;t want to put certain configuration properties directly in the Java code, we can specify them in a file named <code>hibernate.properties</code>, and place the file in the root classpath.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="properties"><span class="c"># PostgreSQL
</span><span class="py">jakarta.persistence.jdbc.url</span><span class="p">=</span><span class="s">jdbc:postgresql://localhost/example</span>
<span class="c"># Credentials
</span><span class="py">jakarta.persistence.jdbc.user</span><span class="p">=</span><span class="s">hibernate</span>
<span class="py">jakarta.persistence.jdbc.password</span><span class="p">=</span><span class="s">zAh7mY$2MNshzAQ5</span>

<span class="c"># SQL statement logging
</span><span class="py">hibernate.show_sql</span><span class="p">=</span><span class="s">true</span>
<span class="py">hibernate.format_sql</span><span class="p">=</span><span class="s">true</span>
<span class="py">hibernate.highlight_sql</span><span class="p">=</span><span class="s">true</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="basic-configuration-settings">2.6. Basic configuration settings</h3>
<div class="paragraph">
<p>The class <a href="https://docs.jboss.org/hibernate/orm/6.3/javadocs/org/hibernate/cfg/AvailableSettings.html"><code>AvailableSettings</code></a> enumerates all the configuration properties understood by Hibernate.</p>
</div>
<div class="paragraph">
<p>Of course, we&#8217;re not going to cover every useful configuration setting in this chapter.
Instead, we&#8217;ll mention the ones you need to get started, and come back to some other important settings later, especially when we talk about performance tuning.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Hibernate has many—too many—switches and toggles.
Please don&#8217;t go crazy messing about with these settings; most of them are rarely needed, and many only exist to provide backward compatibility with older versions of Hibernate.
With rare exception, the default behavior of every one of these settings was carefully chosen to be <em>the behavior we recommend</em>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The properties you really do need to get started are these three:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 4. JDBC connection settings</caption>
<colgroup>
<col style="width: 35%;">
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Configuration property name</th>
<th class="tableblock halign-left valign-top">Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>jakarta.persistence.jdbc.url</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">JDBC URL of your database</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>jakarta.persistence.jdbc.user</code> and <code>jakarta.persistence.jdbc.password</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Your database credentials</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>In Hibernate 6, you don&#8217;t need to specify <code>hibernate.dialect</code>.
The correct Hibernate SQL <code>Dialect</code> will be determined for you automatically.
The only reason to specify this property is if you&#8217;re using a custom user-written <code>Dialect</code> class.</p>
</div>
<div class="paragraph">
<p>Similarly, neither <code>hibernate.connection.driver_class</code> nor <code>jakarta.persistence.jdbc.driver</code> is needed when working with one of the supported databases.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Pooling JDBC connections is an extremely important performance optimization.
You can set the size of Hibernate&#8217;s built-in connection pool using this property:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 5. Built-in connection pool size</caption>
<colgroup>
<col style="width: 35%;">
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Configuration property name</th>
<th class="tableblock halign-left valign-top">Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>hibernate.connection.pool_size</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The size of the built-in connection pool</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="paragraph">
<p>By default, Hibernate uses a simplistic built-in connection pool.
This pool is not meant for use in production, and later, when we discuss performance, we&#8217;ll see how to <a href="#connection-pool">select a more robust implementation</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Alternatively, in a container environment, you&#8217;ll need at least one of these properties:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 6. Transaction management settings</caption>
<colgroup>
<col style="width: 35%;">
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Configuration property name</th>
<th class="tableblock halign-left valign-top">Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>jakarta.persistence.transactionType</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(Optional, defaults to <code>JTA</code>)
                                           Determines if transaction management is via JTA or resource-local transactions.
                                           Specify <code>RESOURCE_LOCAL</code> if JTA should not be used.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>jakarta.persistence.jtaDataSource</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">JNDI name of a JTA datasource</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>jakarta.persistence.nonJtaDataSource</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">JNDI name of a non-JTA datasource</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>In this case, Hibernate obtains pooled JDBC database connections from a container-managed <code>DataSource</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="automatic-schema-export">2.7. Automatic schema export</h3>
<div class="paragraph">
<p>You can have Hibernate infer your database schema from the mapping
annotations you&#8217;ve specified in your Java code, and export the schema at
initialization time by specifying one or more of the following configuration
properties:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 7. Schema management settings</caption>
<colgroup>
<col style="width: 52%;">
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Configuration property name</th>
<th class="tableblock halign-left valign-top">Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>jakarta.persistence.schema-generation.database.action</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>If <code>drop-and-create</code>, first drop the schema and then export tables, sequences, and constraints</p>
</li>
<li>
<p>If <code>create</code>, export tables, sequences, and constraints, without attempting to drop them first</p>
</li>
<li>
<p>If <code>create-drop</code>, drop the schema and recreate it on <code>SessionFactory</code> startup
Additionally, drop the schema on <code>SessionFactory</code> shutdown</p>
</li>
<li>
<p>If <code>drop</code>, drop the schema on <code>SessionFactory</code> shutdown</p>
</li>
<li>
<p>If <code>validate</code>, validate the database schema without changing it</p>
</li>
<li>
<p>If <code>update</code>, only export what&#8217;s missing in the schema</p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>jakarta.persistence.create-database-schemas</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(Optional) If <code>true</code>, automatically create schemas and catalogs</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>jakarta.persistence.schema-generation.create-source</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(Optional) If <code>metadata-then-script</code> or <code>script-then-metadata</code>, execute an additional SQL script when exported tables and sequences</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>jakarta.persistence.schema-generation.create-script-source</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(Optional) The name of a SQL DDL script to be executed</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>jakarta.persistence.sql-load-script-source</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(Optional) The name of a SQL DML script to be executed</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>This feature is extremely useful for testing.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The easiest way to pre-initialize a database with test or "reference" data is to place a list of SQL <code>insert</code> statements in a file named, for example, <code>import.sql</code>, and specify the path to this file using the property <code>jakarta.persistence.sql-load-script-source</code>.
We&#8217;ve already seen an <a href="#import.sql">example</a> of this approach, which is cleaner than writing Java code to instantiate entity instances and calling <code>persist()</code> on each of them.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>As we mentioned <a href="#testing">earlier</a>, it can also be useful to control schema export programmatically.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The <a href="https://docs.jboss.org/hibernate/orm/6.3/javadocs/org/hibernate/relational/SchemaManager.html"><code>SchemaManager</code></a> API allows programmatic control over schema export:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="n">sessionFactory</span><span class="o">.</span><span class="na">getSchemaManager</span><span class="o">().</span><span class="na">exportMappedObjects</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>JPA has a more limited and less ergonomic API:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nc">Persistence</span><span class="o">.</span><span class="na">generateSchema</span><span class="o">(</span><span class="s">"org.hibernate.example"</span><span class="o">,</span>
                           <span class="nc">Map</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="no">JAKARTA_HBM2DDL_DATABASE_ACTION</span><span class="o">,</span> <span class="no">CREATE</span><span class="o">))</span></code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="logging-generated-sql">2.8. Logging the generated SQL</h3>
<div class="paragraph">
<p>To see the generated SQL as it&#8217;s sent to the database, you have two options.</p>
</div>
<div class="paragraph">
<p>One way is to set the property <code>hibernate.show_sql</code> to <code>true</code>, and Hibernate will log SQL direct to the console.
You can make the output much more readable by enabling formatting or highlighting.
These settings really help when troubleshooting the generated SQL statements.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 8. Settings for SQL logging to the console</caption>
<colgroup>
<col style="width: 35%;">
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Configuration property name</th>
<th class="tableblock halign-left valign-top">Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>hibernate.show_sql</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If <code>true</code>, log SQL directly to the console</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>hibernate.format_sql</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If <code>true</code>, log SQL in a multiline, indented format</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>hibernate.highlight_sql</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If <code>true</code>, log SQL with syntax highlighting via ANSI escape codes</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Alternatively, you can enable debug-level logging for the category <code>org.hibernate.SQL</code> using your preferred SLF4J logging implementation.</p>
</div>
<div class="paragraph">
<p>For example, if you&#8217;re using Log4J 2 (as above in <a href="#optional-dependencies">Optional dependencies</a>), add these lines to your <code>log4j2.properties</code> file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="properties"><span class="c"># SQL execution
</span><span class="py">logger.hibernate.name</span> <span class="p">=</span> <span class="s">org.hibernate.SQL</span>
<span class="py">logger.hibernate.level</span> <span class="p">=</span> <span class="s">debug</span>

<span class="c"># JDBC parameter binding
</span><span class="py">logger.jdbc-bind.name</span><span class="p">=</span><span class="s">org.hibernate.orm.jdbc.bind</span>
<span class="py">logger.jdbc-bind.level</span><span class="p">=</span><span class="s">trace</span>
<span class="c"># JDBC result set extraction
</span><span class="py">logger.jdbc-extract.name</span><span class="p">=</span><span class="s">org.hibernate.orm.jdbc.extract</span>
<span class="py">logger.jdbc-extract.level</span><span class="p">=</span><span class="s">trace</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>But with this approach we miss out on the pretty highlighting.</p>
</div>
</div>
<div class="sect2">
<h3 id="minimizing">2.9. Minimizing repetitive mapping information</h3>
<div class="paragraph">
<p>The following properties are very useful for minimizing the amount of information you&#8217;ll need to explicitly specify in <code>@Table</code> and <code>@Column</code> annotations, which we&#8217;ll discuss below in <a href="#object-relational-mapping">Object/relational mapping</a>:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 9. Settings for minimizing explicit mapping information</caption>
<colgroup>
<col style="width: 35%;">
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Configuration property name</th>
<th class="tableblock halign-left valign-top">Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>hibernate.default_schema</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A default schema name for entities which do not explicitly declare one</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>hibernate.default_catalog</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A default catalog name for entities which do not explicitly declare one</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>hibernate.physical_naming_strategy</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A <code>PhysicalNamingStrategy</code> implementing your database naming standards</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>hibernate.implicit_naming_strategy</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">An <code>ImplicitNamingStrategy</code> which specifies how "logical" names of relational objects should be inferred when no name is specified in annotations</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Writing your own <code>PhysicalNamingStrategy</code> and/or <code>ImplicitNamingStrategy</code> is an especially good way to reduce the clutter of annotations on your entity classes, and to implement your database naming conventions, and so we think you should do it for any nontrivial data model.
We&#8217;ll have more to say about them in <a href="#naming-strategies">Naming strategies</a>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="nationalized-chars">2.10. Nationalized character data in SQL Server</h3>
<div class="paragraph">
<p><em>By default,</em> SQL Server&#8217;s <code>char</code> and <code>varchar</code> types don&#8217;t accommodate Unicode data.
But a Java string may contain any Unicode character.
So, if you&#8217;re working with SQL Server, you might need to force Hibernate to use the <code>nchar</code> and <code>nvarchar</code> column types.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 10. Setting the use of nationalized character data</caption>
<colgroup>
<col style="width: 40%;">
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Configuration property name</th>
<th class="tableblock halign-left valign-top">Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>hibernate.use_nationalized_character_data</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Use <code>nchar</code> and <code>nvarchar</code> instead of <code>char</code> and <code>varchar</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>On the other hand, if only <em>some</em> columns store nationalized data, use the <code>@Nationalized</code> annotation to indicate fields of your entities which map these columns.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Alternatively, you can configure SQL Server to use the UTF-8 enabled collation <code>_UTF8</code>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="entities">3. Entities</h2>
<div class="sectionbody">
<div class="paragraph">
<p>An <em>entity</em> is a Java class which represents data in a relational database table.
We say that the entity <em>maps</em> or <em>maps to</em> the table.
Much less commonly, an entity might aggregate data from multiple tables, but we&#8217;ll get to that <a href="#entity-table-mappings">later</a>.</p>
</div>
<div class="paragraph">
<p>An entity has <em>attributes</em>—properties or fields—which map to columns of the table.
In particular, every entity must have an <em>identifier</em> or <em>id</em>, which maps to the primary key of the table.
The id allows us to uniquely associate a row of the table with an instance of the Java class, at least within a given <em>persistence context</em>.</p>
</div>
<div class="paragraph">
<p>We&#8217;ll explore the idea of a persistence context <a href="#persistence-contexts">later</a>. For now, think of it as a one-to-one mapping between ids and entity instances.</p>
</div>
<div class="paragraph">
<p>An instance of a Java class cannot outlive the virtual machine to which it belongs.
But we may think of an entity instance having a lifecycle which transcends a particular instantiation in memory.
By providing its id to Hibernate, we may re-materialize the instance in a new persistence context, as long as the associated row is present in the database.
Therefore, the operations <code>persist()</code> and <code>remove()</code> may be thought of as demarcating the beginning and end of the lifecycle of an entity, at least with respect to persistence.</p>
</div>
<div class="paragraph">
<p>Thus, an id represents the <em>persistent identity</em> of an entity, an identity that outlives a particular instantiation in memory.
And this is an important difference between entity class itself and the values of its attributes—the entity has a persistent identity, and a well-defined lifecycle with respect to persistence, whereas a <code>String</code> or <code>List</code> representing one of its attribute values doesn&#8217;t.</p>
</div>
<div class="paragraph">
<p>An entity usually has associations to other entities.
Typically, an association between two entities maps to a foreign key in one of the database tables.
A group of mutually associated entities is often called a <em>domain model</em>, though <em>data model</em> is also a perfectly good term.</p>
</div>
<div class="sect2">
<h3 id="entity-clases">3.1. Entity classes</h3>
<div class="paragraph">
<p>An entity must:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>be a non-<code>final</code> class,</p>
</li>
<li>
<p>with a non-<code>private</code> constructor with no parameters.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>On the other hand, the entity class may be either concrete or <code>abstract</code>, and it may have any number of additional constructors.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>An entity class may be a <code>static</code> inner class.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Every entity class must be annotated <code>@Entity</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Entity</span>
<span class="kd">class</span> <span class="nc">Book</span> <span class="o">{</span>
    <span class="nc">Book</span><span class="o">()</span> <span class="o">{}</span>
    <span class="o">...</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Alternatively, the class may be identified as an entity type by providing an XML-based mapping for the class.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Mapping entities using XML</div>
<div class="paragraph">
<p>When XML-based mappings are used, the <code>&lt;entity&gt;</code> element is used to declare an entity class:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;entity-mappings&gt;</span>
    <span class="nt">&lt;package&gt;</span>org.hibernate.example<span class="nt">&lt;/package&gt;</span>

    <span class="nt">&lt;entity</span> <span class="na">class=</span><span class="s">"Book"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;attributes&gt;</span> ... <span class="nt">&lt;/attributes&gt;</span>
    <span class="nt">&lt;/entity&gt;</span>

    ...
<span class="nt">&lt;/entity-mappings&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Since the <code>orm.xml</code> mapping file format defined by the JPA specification was modelled closely on the annotation-based mappings, it&#8217;s usually easy to go back and forth between the two options.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>We won&#8217;t have much more to say about XML-based mappings in this Introduction, since it&#8217;s not our preferred way to do things.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">"Dynamic" models</div>
<div class="paragraph">
<p>We love representing entities as classes because the classes give us a <em>type-safe</em> model of our data.
But Hibernate also has the ability to represent entities as detyped instances of <code>java.util.Map</code>.
There&#8217;s information in the <a href="https://docs.jboss.org/hibernate/orm/6.3/userguide/html_single/Hibernate_User_Guide.html#dynamic-model">User Guide</a>, if you&#8217;re curious.</p>
</div>
<div class="paragraph">
<p>This must sound like a weird feature for a project that places importance on type-safety.
Actually, it&#8217;s a useful capability for a very particular sort of generic code.
For example, <a href="https://hibernate.org/orm/envers/">Hibernate Envers</a> is a great auditing/versioning system for Hibernate entities.
Envers makes use of maps to represent its <em>versioned model</em> of the data.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="access-type">3.2. Access types</h3>
<div class="paragraph">
<p>Each entity class has a default <em>access type</em>, either:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>direct <em>field access</em>, or</p>
</li>
<li>
<p><em>property access</em>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Hibernate automatically determines the access type from the location of attribute-level annotations.
Concretely:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>if a field is annotated <code>@Id</code>, field access is used, or</p>
</li>
<li>
<p>if a getter method is annotated <code>@Id</code>, property access is used.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Back when Hibernate was just a baby, property access was quite popular in the Hibernate community.
Today, however, field access is <em>much</em> more common.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The default access type may be specified explicitly using the <code>@Access</code> annotation, but we strongly discourage this, since it&#8217;s ugly and never necessary.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Mapping annotations should be placed consistently:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>if <code>@Id</code> annotates a field, the other mapping annotations should also be applied to fields, or,</p>
</li>
<li>
<p>if <code>@Id</code> annotates a getter, the other mapping annotations should be applied to getters.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>It is in principle possible to mix field and property access using explicit <code>@Access</code> annotations at the attribute level.
We don&#8217;t recommend doing this.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>An entity class like <code>Book</code>, which does not extend any other entity class, is called a <em>root entity</em>.
Every root entity must declare an identifier attribute.</p>
</div>
</div>
<div class="sect2">
<h3 id="entity-inheritance">3.3. Entity class inheritance</h3>
<div class="paragraph">
<p>An entity class may <code>extend</code> another entity class.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Entity</span>
<span class="kd">class</span> <span class="nc">AudioBook</span> <span class="kd">extends</span> <span class="nc">Book</span> <span class="o">{</span>
    <span class="nc">AudioBook</span><span class="o">()</span> <span class="o">{}</span>
    <span class="o">...</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>A subclass entity inherits every persistent attribute of every entity it extends.</p>
</div>
<div class="paragraph">
<p>A root entity may also extend another class and inherit mapped attributes from the other class.
But in this case, the class which declares the mapped attributes must be annotated <code>@MappedSuperclass</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@MappedSuperclass</span>
<span class="kd">class</span> <span class="nc">Versioned</span> <span class="o">{</span>
    <span class="o">...</span>
<span class="o">}</span>

<span class="nd">@Entity</span>
<span class="kd">class</span> <span class="nc">Book</span> <span class="kd">extends</span> <span class="nc">Versioned</span> <span class="o">{</span>
    <span class="o">...</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>A root entity class must declare an attribute annotated <code>@Id</code>, or inherit one from a <code>@MappedSuperclass</code>.
A subclass entity always inherits the identifier attribute of the root entity.
It may not declare its own <code>@Id</code> attribute.</p>
</div>
</div>
<div class="sect2">
<h3 id="identifier-attributes">3.4. Identifier attributes</h3>
<div class="paragraph">
<p>An identifier attribute is usually a field:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Entity</span>
<span class="kd">class</span> <span class="nc">Book</span> <span class="o">{</span>
    <span class="nc">Book</span><span class="o">()</span> <span class="o">{}</span>

    <span class="nd">@Id</span>
    <span class="nc">Long</span> <span class="n">id</span><span class="o">;</span>

    <span class="o">...</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>But it may be a property:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Entity</span>
<span class="kd">class</span> <span class="nc">Book</span> <span class="o">{</span>
    <span class="nc">Book</span><span class="o">()</span> <span class="o">{}</span>

    <span class="kd">private</span> <span class="nc">Long</span> <span class="n">id</span><span class="o">;</span>

    <span class="nd">@Id</span>
    <span class="nc">Long</span> <span class="nf">getId</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="n">id</span><span class="o">;</span> <span class="o">}</span>
    <span class="kt">void</span> <span class="nf">setId</span><span class="o">(</span><span class="nc">Long</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span> <span class="k">this</span><span class="o">.</span><span class="na">id</span> <span class="o">=</span> <span class="n">id</span><span class="o">;</span> <span class="o">}</span>

    <span class="o">...</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>An identifier attribute must be annotated <code>@Id</code> or <code>@EmbeddedId</code>.</p>
</div>
<div class="paragraph">
<p>Identifier values may be:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>assigned by the application, that is, by your Java code, or</p>
</li>
<li>
<p>generated and assigned by Hibernate.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>We&#8217;ll discuss the second option first.</p>
</div>
</div>
<div class="sect2">
<h3 id="generated-identifiers">3.5. Generated identifiers</h3>
<div class="paragraph">
<p>An identifier is often system-generated, in which case it should be annotated <code>@GeneratedValue</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Id</span> <span class="nd">@GeneratedValue</span>
<span class="nc">Long</span> <span class="n">id</span><span class="o">;</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>System-generated identifiers, or <em>surrogate keys</em> make it easier to evolve or refactor the relational data model.
If you have the freedom to define the relational schema, we recommend the use of surrogate keys.
On the other hand, if, as is more common, you&#8217;re working with a pre-existing database schema, you might not have the option.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>JPA defines the following strategies for generating ids, which are enumerated by <code>GenerationType</code>:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 11. Standard id generation strategies</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 15%;">
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Strategy</th>
<th class="tableblock halign-left valign-top">Java type</th>
<th class="tableblock halign-left valign-top">Implementation</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>GenerationType.UUID</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>UUID</code> or <code>String</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A Java <code>UUID</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>GenerationType.IDENTITY</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Long</code> or <code>Integer</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">An identity or autoincrement column</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>GenerationType.SEQUENCE</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Long</code> or <code>Integer</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A database sequence</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>GenerationType.TABLE</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Long</code> or <code>Integer</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A database table</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>GenerationType.AUTO</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Long</code> or <code>Integer</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Selects <code>SEQUENCE</code>, <code>TABLE</code>, or <code>UUID</code> based on the identifier type and capabilities of the database</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>For example, this UUID is generated in Java code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Id</span> <span class="nd">@GeneratedValue</span> <span class="no">UUID</span> <span class="n">id</span><span class="o">;</span>  <span class="c1">// AUTO strategy selects UUID based on the field type</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This id maps to a SQL <code>identity</code>, <code>auto_increment</code>, or <code>bigserial</code> column:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Id</span> <span class="nd">@GeneratedValue</span><span class="o">(</span><span class="n">strategy</span><span class="o">=</span><span class="no">IDENTITY</span><span class="o">)</span> <span class="nc">Long</span> <span class="n">id</span><span class="o">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>@SequenceGenerator</code> and <code>@TableGenerator</code> annotations allow further control over <code>SEQUENCE</code> and <code>TABLE</code> generation respectively.</p>
</div>
<div class="paragraph">
<p>Consider this sequence generator:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@SequenceGenerator</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"bookSeq"</span><span class="o">,</span> <span class="n">sequenceName</span><span class="o">=</span><span class="s">"seq_book"</span><span class="o">,</span> <span class="n">initialValue</span> <span class="o">=</span> <span class="mi">5</span><span class="o">,</span> <span class="n">allocationSize</span><span class="o">=</span><span class="mi">10</span><span class="o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Values are generated using a database sequence defined as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sql"><span class="k">create</span> <span class="n">sequence</span> <span class="n">seq_book</span> <span class="k">start</span> <span class="k">with</span> <span class="mi">5</span> <span class="k">increment</span> <span class="k">by</span> <span class="mi">10</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice that Hibernate doesn&#8217;t have to go to the database every time a new identifier is needed.
Instead, a given process obtains a block of ids, of size <code>allocationSize</code>, and only needs to hit the database each time the block is exhausted.
Of course, the downside is that generated identifiers are not contiguous.</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you let Hibernate export your database schema, the sequence definition will have the right <code>start with</code> and <code>increment</code> values.
But if you&#8217;re working with a database schema managed outside Hibernate, make sure the <code>initialValue</code> and <code>allocationSize</code> members of <code>@SequenceGenerator</code> match the <code>start with</code> and <code>increment</code> specified in the DDL.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Any identifier attribute may now make use of the generator named <code>bookSeq</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Id</span>
<span class="nd">@GeneratedValue</span><span class="o">(</span><span class="n">strategy</span><span class="o">=</span><span class="no">SEQUENCE</span><span class="o">,</span> <span class="n">generator</span><span class="o">=</span><span class="s">"bookSeq"</span><span class="o">)</span>  <span class="c1">// reference to generator defined elsewhere</span>
<span class="nc">Long</span> <span class="n">id</span><span class="o">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Actually, it&#8217;s extremely common to place the <code>@SequenceGenerator</code> annotation on the <code>@Id</code> attribute that makes use of it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Id</span>
<span class="nd">@GeneratedValue</span><span class="o">(</span><span class="n">strategy</span><span class="o">=</span><span class="no">SEQUENCE</span><span class="o">,</span> <span class="n">generator</span><span class="o">=</span><span class="s">"bookSeq"</span><span class="o">)</span>  <span class="c1">// reference to generator defined below</span>
<span class="nd">@SequenceGenerator</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"bookSeq"</span><span class="o">,</span> <span class="n">sequenceName</span><span class="o">=</span><span class="s">"seq_book"</span><span class="o">,</span> <span class="n">initialValue</span> <span class="o">=</span> <span class="mi">5</span><span class="o">,</span> <span class="n">allocationSize</span><span class="o">=</span><span class="mi">10</span><span class="o">)</span>
<span class="nc">Long</span> <span class="n">id</span><span class="o">;</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>JPA id generators may be shared between entities.
A <code>@SequenceGenerator</code> or <code>@TableGenerator</code> must have a name, and may be shared between multiple id attributes.
This fits somewhat uncomfortably with the common practice of annotating the <code>@Id</code> attribute which makes use of the generator!</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>As you can see, JPA provides quite adequate support for the most common strategies for system-generated ids.
However, the annotations themselves are a bit more intrusive than they should be, and there&#8217;s no well-defined way to extend this framework to support custom strategies for id generation.
Nor may <code>@GeneratedValue</code> be used on a property not annotated <code>@Id</code>.
Since custom id generation is a rather common requirement, Hibernate provides a very carefully-designed framework for user-defined <code>Generator</code>s, which we&#8217;ll discuss in <a href="#user-defined-generators">User-defined generators</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="natural-identifiers">3.6. Natural keys as identifiers</h3>
<div class="paragraph">
<p>Not every identifier attribute maps to a (system-generated) surrogate key.
Primary keys which are meaningful to the user of the system are called <em>natural keys</em>.</p>
</div>
<div class="paragraph">
<p>When the primary key of a table is a natural key, we don&#8217;t annotate the identifier attribute <code>@GeneratedValue</code>, and it&#8217;s the responsibility of the application code to assign a value to the identifier attribute.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Entity</span>
<span class="kd">class</span> <span class="nc">Book</span> <span class="o">{</span>
    <span class="nd">@Id</span>
    <span class="nc">String</span> <span class="n">isbn</span><span class="o">;</span>

    <span class="o">...</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Of particular interest are natural keys which comprise more than one database column, and such natural keys are called <em>composite keys</em>.</p>
</div>
</div>
<div class="sect2">
<h3 id="composite-identifiers">3.7. Composite identifiers</h3>
<div class="paragraph">
<p>If your database uses composite keys, you&#8217;ll need more than one identifier attribute.
There are two ways to map composite keys in JPA:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>using an <code>@IdClass</code>, or</p>
</li>
<li>
<p>using an <code>@EmbeddedId</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Perhaps the most immediately-natural way to represent this in an entity class is with multiple fields annotated <code>@Id</code>, for example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Entity</span>
<span class="nd">@IdClass</span><span class="o">(</span><span class="nc">BookId</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="kd">class</span> <span class="nc">Book</span> <span class="o">{</span>
    <span class="nc">Book</span><span class="o">()</span> <span class="o">{}</span>

    <span class="nd">@Id</span>
    <span class="nc">String</span> <span class="n">isbn</span><span class="o">;</span>

    <span class="nd">@Id</span>
    <span class="kt">int</span> <span class="n">printing</span><span class="o">;</span>

    <span class="o">...</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>But this approach comes with a problem: what object can we use to identify a <code>Book</code> and pass to methods like <code>find()</code> which accept an identifier?</p>
</div>
<div class="paragraph">
<p>The solution is to write a separate class with fields that match the identifier attributes of the entity.
The <code>@IdClass</code> annotation of the <code>Book</code> entity identifies the id class to use for that entity:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">class</span> <span class="nc">BookId</span> <span class="o">{</span>

    <span class="nc">String</span> <span class="n">isbn</span><span class="o">;</span>
    <span class="kt">int</span> <span class="n">printing</span><span class="o">;</span>

    <span class="nc">BookId</span><span class="o">()</span> <span class="o">{}</span>

    <span class="nc">BookId</span><span class="o">(</span><span class="nc">String</span> <span class="n">isbn</span><span class="o">,</span> <span class="kt">int</span> <span class="n">printing</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">isbn</span> <span class="o">=</span> <span class="n">isbn</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">printing</span> <span class="o">=</span> <span class="n">printing</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">equals</span><span class="o">(</span><span class="nc">Object</span> <span class="n">other</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">other</span> <span class="k">instanceof</span> <span class="nc">BookId</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">BookId</span> <span class="n">bookId</span> <span class="o">=</span> <span class="o">(</span><span class="nc">BookId</span><span class="o">)</span> <span class="n">other</span><span class="o">;</span>
            <span class="k">return</span> <span class="n">bookId</span><span class="o">.</span><span class="na">isbn</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">isbn</span><span class="o">)</span>
                <span class="o">&amp;&amp;</span> <span class="n">bookId</span><span class="o">.</span><span class="na">printing</span> <span class="o">==</span> <span class="n">printing</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">else</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">hashCode</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">isbn</span><span class="o">.</span><span class="na">hashCode</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Every id class should override <code>equals()</code> and <code>hashCode()</code>.</p>
</div>
<div class="paragraph">
<p>This is not our preferred approach.
Instead, we recommend that the <code>BookId</code> class be declared as an <code>@Embeddable</code> type:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Embeddable</span>
<span class="kd">class</span> <span class="nc">BookId</span> <span class="o">{</span>

    <span class="nc">String</span> <span class="n">isbn</span><span class="o">;</span>

    <span class="kt">int</span> <span class="n">printing</span><span class="o">;</span>

    <span class="nc">BookId</span><span class="o">()</span> <span class="o">{}</span>

    <span class="nc">BookId</span><span class="o">(</span><span class="nc">String</span> <span class="n">isbn</span><span class="o">,</span> <span class="kt">int</span> <span class="n">printing</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">isbn</span> <span class="o">=</span> <span class="n">isbn</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">printing</span> <span class="o">=</span> <span class="n">printing</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="o">...</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We&#8217;ll learn more about <a href="#embeddable-objects">Embeddable objects</a> below.</p>
</div>
<div class="paragraph">
<p>Now the entity class may reuse this definition using <code>@EmbeddedId</code>, and the <code>@IdClass</code> annotation is no longer required:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Entity</span>
<span class="kd">class</span> <span class="nc">Book</span> <span class="o">{</span>
    <span class="nc">Book</span><span class="o">()</span> <span class="o">{}</span>

    <span class="nd">@EmbeddedId</span>
    <span class="nc">BookId</span> <span class="n">bookId</span><span class="o">;</span>

    <span class="o">...</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This second approach eliminates some duplicated code.</p>
</div>
<div class="paragraph">
<p>Either way, we may now use <code>BookId</code> to obtain instances of <code>Book</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nc">Book</span> <span class="n">book</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">find</span><span class="o">(</span><span class="nc">Book</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">new</span> <span class="nc">BookId</span><span class="o">(</span><span class="n">isbn</span><span class="o">,</span> <span class="n">printing</span><span class="o">));</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="version-attributes">3.8. Version attributes</h3>
<div class="paragraph">
<p>An entity may have an attribute which is used by Hibernate for optimistic lock checking.
A version attribute is usually of type <code>Integer</code>, <code>Short</code>, <code>Long</code>, <code>LocalDateTime</code>, <code>OffsetDateTime</code>, <code>ZonedDateTime</code>, or <code>Instant</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Version</span>
<span class="nc">LocalDateTime</span> <span class="n">lastUpdated</span><span class="o">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Version attributes are automatically assigned by Hibernate when an entity is made persistent, and automatically incremented or updated each time the entity is updated.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If an entity doesn&#8217;t have a version number, which often happens when mapping legacy data, we can still do optimistic locking.
The <a href="https://docs.jboss.org/hibernate/orm/6.3/javadocs/org/hibernate/annotations/OptimisticLocking.html"><code>@OptimisticLocking</code></a> annotation lets us specify that optimistic locks should be checked by validating the values of <code>ALL</code> fields, or only the <code>DIRTY</code> fields of the entity.
And the <a href="https://docs.jboss.org/hibernate/orm/6.3/javadocs/org/hibernate/annotations/OptimisticLock.html"><code>@OptimisticLock</code></a> annotation lets us selectively exclude certain fields from optimistic locking.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <code>@Id</code> and <code>@Version</code> attributes we&#8217;ve already seen are just specialized examples of <em>basic attributes</em>.</p>
</div>
</div>
<div class="sect2">
<h3 id="natural-id-attributes">3.9. Natural id attributes</h3>
<div class="paragraph">
<p>Even when an entity has a surrogate key, it should always be possible to write down a combination of fields which uniquely identifies an instance of the entity, from the point of view of the user of the system.
This combination of fields is its natural key.
Above, we <a href="#natural-identifiers">considered</a> the case where the natural key coincides with the primary key.
Here, the natural key is a second unique key of the entity, distinct from its surrogate primary key.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you can&#8217;t identify a natural key, it might be a sign that you need to think more carefully about some aspect of your data model.
If an entity doesn&#8217;t have a meaningful unique key, then it&#8217;s impossible to say what event or object it represents in the "real world" outside your program.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Since it&#8217;s <em>extremely</em> common to retrieve an entity based on its natural key, Hibernate has a way to mark the attributes of the entity which make up its natural key.
Each attribute must be annotated <a href="https://docs.jboss.org/hibernate/orm/6.3/javadocs/org/hibernate/annotations/NaturalId.html"><code>@NaturalId</code></a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Entity</span>
<span class="kd">class</span> <span class="nc">Book</span> <span class="o">{</span>
    <span class="nc">Book</span><span class="o">()</span> <span class="o">{}</span>

    <span class="nd">@Id</span> <span class="nd">@GeneratedValue</span>
    <span class="nc">Long</span> <span class="n">id</span><span class="o">;</span> <span class="c1">// the system-generated surrogate key</span>

    <span class="nd">@NaturalId</span>
    <span class="nc">String</span> <span class="n">isbn</span><span class="o">;</span> <span class="c1">// belongs to the natural key</span>

    <span class="nd">@NaturalId</span>
    <span class="kt">int</span> <span class="n">printing</span><span class="o">;</span> <span class="c1">// also belongs to the natural key</span>

    <span class="o">...</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Hibernate automatically generates a <code>UNIQUE</code> constraint on the columns mapped by the annotated fields.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Consider using the natural id attributes to implement <a href="#equals-and-hash"><code>equals()</code> and <code>hashCode()</code></a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The payoff for doing this extra work, as we will see <a href="#natural-id-cache">much later</a>, is that we can take advantage of optimized natural id lookups that make use of the second-level cache.</p>
</div>
<div class="paragraph">
<p>Note that even when you&#8217;ve identified a natural key, we still recommend the use of a generated surrogate key in foreign keys, since this makes your data model <em>much</em> easier to change.</p>
</div>
</div>
<div class="sect2">
<h3 id="basic-attributes">3.10. Basic attributes</h3>
<div class="paragraph">
<p>A <em>basic</em> attribute of an entity is a field or property which maps to a single column of the associated database table.
The JPA specification defines a quite limited set of basic types:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 12. JPA-standard basic attribute types</caption>
<colgroup>
<col style="width: 30%;">
<col style="width: 14%;">
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Classification</th>
<th class="tableblock halign-center valign-top">Package</th>
<th class="tableblock halign-left valign-top">Types</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Primitive types</p></td>
<td class="tableblock halign-center valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>boolean</code>, <code>int</code>, <code>double</code>, etc</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Primitive wrappers</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><code>java.lang</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Boolean</code>, <code>Integer</code>, <code>Double</code>, etc</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Strings</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><code>java.lang</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>String</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Arbitrary-precision numeric types</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><code>java.math</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>BigInteger</code>, <code>BigDecimal</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Date/time types</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><code>java.time</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>LocalDate</code>, <code>LocalTime</code>, <code>LocalDateTime</code>, <code>OffsetDateTime</code>, <code>Instant</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Deprecated date/time types 💀</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><code>java.util</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Date</code>, <code>Calendar</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Deprecated JDBC date/time types 💀</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><code>java.sql</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Date</code>, <code>Time</code>, <code>Timestamp</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Binary and character arrays</p></td>
<td class="tableblock halign-center valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>byte[]</code>, <code>char[]</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">UUIDs</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><code>java.util</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>UUID</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Enumerated types</p></td>
<td class="tableblock halign-center valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Any <code>enum</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Serializable types</p></td>
<td class="tableblock halign-center valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Any type which implements <code>java.io.Serializable</code></p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>We&#8217;re begging you to use types from the <code>java.time</code> package instead of anything which inherits <code>java.util.Date</code>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Serializing a Java object and storing its binary representation in the database is usually wrong.
As we&#8217;ll soon see in <a href="#embeddable-objects">Embeddable objects</a>, Hibernate has much better ways to handle complex Java objects.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Hibernate slightly extends this list with the following types:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 13. Additional basic attribute types in Hibernate</caption>
<colgroup>
<col style="width: 30%;">
<col style="width: 14%;">
<col style="width: 56%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Classification</th>
<th class="tableblock halign-center valign-top">Package</th>
<th class="tableblock halign-left valign-top">Types</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Additional date/time types</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><code>java.time</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Duration</code>, <code>ZoneId</code>, <code>ZoneOffset</code>, <code>Year</code>, and even <code>ZonedDateTime</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">JDBC LOB types</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><code>java.sql</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Blob</code>, <code>Clob</code>, <code>NClob</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Java class object</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><code>java.lang</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Class</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Miscellaneous types</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><code>java.util</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Currency</code>, <code>URL</code>, <code>TimeZone</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The <code>@Basic</code> annotation explicitly specifies that an attribute is basic, but it&#8217;s often not needed, since attributes are assumed basic by default.
On the other hand, if a non-primitively-typed attribute cannot be null, use of <code>@Basic(optional=false)</code> is highly recommended.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Basic</span><span class="o">(</span><span class="n">optional</span><span class="o">=</span><span class="kc">false</span><span class="o">)</span> <span class="nc">String</span> <span class="n">firstName</span><span class="o">;</span>
<span class="nd">@Basic</span><span class="o">(</span><span class="n">optional</span><span class="o">=</span><span class="kc">false</span><span class="o">)</span> <span class="nc">String</span> <span class="n">lastName</span><span class="o">;</span>
<span class="nc">String</span> <span class="n">middleName</span><span class="o">;</span> <span class="c1">// may be null</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that primitively-typed attributes are inferred <code>NOT NULL</code> by default.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">How to make a column <code>not null</code> in JPA</div>
<div class="paragraph">
<p>There are two standard ways to add a <code>NOT NULL</code> constraint to a mapped column in JPA:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>using <code>@Basic(optional=false)</code>, or</p>
</li>
<li>
<p>using <code>@Column(nullable=false)</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You might wonder what the difference is.</p>
</div>
<div class="paragraph">
<p>Well, it&#8217;s perhaps not obvious to a casual user of the JPA annotations, but they actually come in two "layers":</p>
</div>
<div class="ulist">
<ul>
<li>
<p>annotations like <code>@Entity</code>, <code>@Id</code>, and <code>@Basic</code> belong to the <em>logical</em> layer, the subject of the current chapter—they specify the semantics of your Java domain model, whereas</p>
</li>
<li>
<p>annotations like <code>@Table</code> and <code>@Column</code> belong to the <em>mapping</em> layer, the topic of the <a href="#object-relational-mapping">next chapter</a>—they specify how elements of the domain model map to objects in the relational database.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Information may be inferred from the logical layer down to the mapping layer, but is never inferred in the opposite direction.</p>
</div>
<div class="paragraph">
<p>Now, the <code>@Column</code> annotation, to whom we&#8217;ll be properly <a href="#regular-column-mappings">introduced</a> a bit later, belongs to the <em>mapping</em> layer, and so its <code>nullable</code> member only affects schema generation (resulting in a <code>not null</code> constraint in the generated DDL).
On the other hand, the <code>@Basic</code> annotation belongs to the logical layer, and so an attribute marked <code>optional=false</code> is checked by Hibernate before it even writes an entity to the database.
Note that:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>optional=false</code> implies <code>nullable=false</code>, but</p>
</li>
<li>
<p><code>nullable=false</code> <em>does not</em> imply <code>optional=false</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Therefore, we prefer <code>@Basic(optional=false)</code> to <code>@Column(nullable=false)</code>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>But wait!
An even better solution is to use the <code>@NotNull</code> annotation from Bean Validation.
Just add Hibernate Validator to your project build, as described in <a href="#optional-dependencies">Optional dependencies</a>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="enums">3.11. Enumerated types</h3>
<div class="paragraph">
<p>We included Java <code>enum</code>s on the list above.
An enumerated type is considered a sort of basic type, but since most databases don&#8217;t have a native <code>ENUM</code> type, JPA provides a special <code>@Enumerated</code> annotation to specify how the enumerated values should be represented in the database:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>by default, an enum is stored as an integer, the value of its <code>ordinal()</code> member, but</p>
</li>
<li>
<p>if the attribute is annotated <code>@Enumerated(STRING)</code>, it will be stored as a string, the value of its <code>name()</code> member.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="c1">//here, an ORDINAL encoding makes sense</span>
<span class="nd">@Enumerated</span>
<span class="nd">@Basic</span><span class="o">(</span><span class="n">optional</span><span class="o">=</span><span class="kc">false</span><span class="o">)</span>
<span class="nc">DayOfWeek</span> <span class="n">dayOfWeek</span><span class="o">;</span>

<span class="c1">//but usually, a STRING encoding is better</span>
<span class="nd">@Enumerated</span><span class="o">(</span><span class="nc">EnumType</span><span class="o">.</span><span class="na">STRING</span><span class="o">)</span>
<span class="nd">@Basic</span><span class="o">(</span><span class="n">optional</span><span class="o">=</span><span class="kc">false</span><span class="o">)</span>
<span class="nc">Status</span> <span class="n">status</span><span class="o">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In Hibernate 6, an <code>enum</code> annotated <code>@Enumerated(STRING)</code> is mapped to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>a <code>VARCHAR</code> column type with a <code>CHECK</code> constraint on most databases, or</p>
</li>
<li>
<p>an <code>ENUM</code> column type on MySQL.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Any other <code>enum</code> is mapped to a <code>TINYINT</code> column with a <code>CHECK</code> constraint.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>JPA picks the wrong default here.
In most cases, storing an integer encoding of the <code>enum</code> value makes the relational data harder to interpret.</p>
</div>
<div class="paragraph">
<p>Even considering <code>DayOfWeek</code>, the encoding to integers is ambiguous.
If you check <code>java.time.DayOfWeek</code>, you&#8217;ll notice that <code>SUNDAY</code> is encoded as <code>6</code>.
But in the country I was born, <code>SUNDAY</code> is the <em>first</em> day of the week!</p>
</div>
<div class="paragraph">
<p>So we prefer <code>@Enumerated(STRING)</code> for most <code>enum</code> attributes.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>An interesting special case is PostgreSQL.
Postgres supports <em>named</em> <code>ENUM</code> types, which must be declared using a DDL <code>CREATE TYPE</code> statement.
Sadly, these <code>ENUM</code> types aren&#8217;t well-integrated with the language nor well-supported by the Postgres JDBC driver, so Hibernate doesn&#8217;t use them by default.
But if you would like to use a named enumerated type on Postgres, just annotate your <code>enum</code> attribute like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@JdbcTypeCode</span><span class="o">(</span><span class="nc">SqlTypes</span><span class="o">.</span><span class="na">NAMED_ENUM</span><span class="o">)</span>
<span class="nd">@Basic</span><span class="o">(</span><span class="n">optional</span><span class="o">=</span><span class="kc">false</span><span class="o">)</span>
<span class="nc">Status</span> <span class="n">status</span><span class="o">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The limited set of pre-defined basic attribute types can be stretched a bit further by supplying a <em>converter</em>.</p>
</div>
</div>
<div class="sect2">
<h3 id="converters">3.12. Converters</h3>
<div class="paragraph">
<p>A JPA <code>AttributeConverter</code> is responsible for:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>converting a given Java type to one of the types listed above, and/or</p>
</li>
<li>
<p>perform any other sort of pre- and post-processing you might need to perform on a basic attribute value before writing and reading it to or from the database.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Converters substantially widen the set of attribute types that can be handled by JPA.</p>
</div>
<div class="paragraph">
<p>There are two ways to apply a converter:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the <code>@Convert</code> annotation applies an <code>AttributeConverter</code> to a particular entity attribute, or</p>
</li>
<li>
<p>the <code>@Converter</code> annotation (or, alternatively, the <code>@ConverterRegistration</code> annotation) registers an <code>AttributeConverter</code> for automatic application to all attributes of a given type.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For example, the following converter will be automatically applied to any attribute of type <code>BitSet</code>, and takes care of persisting the <code>BitSet</code> to a column of type <code>varbinary</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Converter</span><span class="o">(</span><span class="n">autoApply</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">EnumSetConverter</span> <span class="kd">implements</span> <span class="nc">AttributeConverter</span><span class="o">&lt;</span><span class="nc">EnumSet</span><span class="o">&lt;</span><span class="nc">DayOfWeek</span><span class="o">&gt;,</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">Integer</span> <span class="nf">convertToDatabaseColumn</span><span class="o">(</span><span class="nc">EnumSet</span><span class="o">&lt;</span><span class="nc">DayOfWeek</span><span class="o">&gt;</span> <span class="n">enumSet</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">encoded</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="kt">var</span> <span class="n">values</span> <span class="o">=</span> <span class="nc">DayOfWeek</span><span class="o">.</span><span class="na">values</span><span class="o">();</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">values</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">enumSet</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">values</span><span class="o">[</span><span class="n">i</span><span class="o">]))</span> <span class="o">{</span>
                <span class="n">encoded</span> <span class="o">|=</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">i</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">encoded</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">EnumSet</span><span class="o">&lt;</span><span class="nc">DayOfWeek</span><span class="o">&gt;</span> <span class="nf">convertToEntityAttribute</span><span class="o">(</span><span class="nc">Integer</span> <span class="n">encoded</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">var</span> <span class="n">set</span> <span class="o">=</span> <span class="nc">EnumSet</span><span class="o">.</span><span class="na">noneOf</span><span class="o">(</span><span class="nc">DayOfWeek</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="kt">var</span> <span class="n">values</span> <span class="o">=</span> <span class="nc">DayOfWeek</span><span class="o">.</span><span class="na">values</span><span class="o">();</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">values</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(((</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">i</span><span class="o">)</span> <span class="o">&amp;</span> <span class="n">encoded</span><span class="o">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">set</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">values</span><span class="o">[</span><span class="n">i</span><span class="o">]);</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">set</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>On the other hand, if we <em>don&#8217;t</em> set <code>autoapply=true</code>, then we must explicitly apply the converter using the <code>@Convert</code> annotation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Convert</span><span class="o">(</span><span class="n">converter</span> <span class="o">=</span> <span class="nc">BitSetConverter</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="nd">@Basic</span><span class="o">(</span><span class="n">optional</span> <span class="o">=</span> <span class="kc">false</span><span class="o">)</span>
<span class="nc">BitSet</span> <span class="n">bitset</span><span class="o">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>All this is nice, but it probably won&#8217;t surprise you that Hibernate goes beyond what is required by JPA.</p>
</div>
</div>
<div class="sect2">
<h3 id="compositional-basic-types">3.13. Compositional basic types</h3>
<div class="paragraph">
<p>Hibernate considers a "basic type" to be formed by the marriage of two objects:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>a <code>JavaType</code>, which models the semantics of a certain Java class, and</p>
</li>
<li>
<p>a <code>JdbcType</code>, representing a SQL type which is understood by JDBC.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>When mapping a basic attribute, we may explicitly specify a <code>JavaType</code>, a <code>JdbcType</code>, or both.</p>
</div>
<h4 id="_javatype" class="discrete">JavaType</h4>
<div class="paragraph">
<p>An instance of <code>org.hibernate.type.descriptor.java.JavaType</code> represents a particular Java class.
It&#8217;s able to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>compare instances of the class to determine if an attribute of that class type is dirty (modified),</p>
</li>
<li>
<p>produce a useful hash code for an instance of the class,</p>
</li>
<li>
<p>coerce values to other types, and, in particular,</p>
</li>
<li>
<p>convert an instance of the class to one of several other equivalent Java representations at the request of its partner <code>JdbcType</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For example, <code>IntegerJavaType</code> knows how to convert an <code>Integer</code> or <code>int</code> value to the types <code>Long</code>, <code>BigInteger</code>, and <code>String</code>, among others.</p>
</div>
<div class="paragraph">
<p>We may explicitly specify a Java type using the <code>@JavaType</code> annotation, but for the built-in <code>JavaType</code>s this is never necessary.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@JavaType</span><span class="o">(</span><span class="nc">LongJavaType</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>  <span class="c1">// not needed, this is the default JavaType for long</span>
<span class="kt">long</span> <span class="n">currentTimeMillis</span><span class="o">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>For a user-written <code>JavaType</code>, the annotation is more useful:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@JavaType</span><span class="o">(</span><span class="nc">BitSetJavaType</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="nc">BitSet</span> <span class="n">bitSet</span><span class="o">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Alternatively, the <code>@JavaTypeRegistration</code> annotation may be used to register <code>BitSetJavaType</code> as the default <code>JavaType</code> for <code>BitSet</code>.</p>
</div>
<h4 id="_jdbctype" class="discrete">JdbcType</h4>
<div class="paragraph">
<p>A <code>org.hibernate.type.descriptor.jdbc.JdbcType</code> is able to read and write a single Java type from and to JDBC.</p>
</div>
<div class="paragraph">
<p>For example, <code>VarcharJdbcType</code> takes care of:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>writing Java strings to JDBC <code>PreparedStatement</code>s by calling <code>setString()</code>, and</p>
</li>
<li>
<p>reading Java strings from JDBC <code>ResultSet</code>s using <code>getString()</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>By pairing <code>LongJavaType</code> with <code>VarcharJdbcType</code> in holy matrimony, we produce a basic type which maps <code>Long</code>s and primitive <code>longs</code>s to the SQL type <code>VARCHAR</code>.</p>
</div>
<div class="paragraph">
<p>We may explicitly specify a JDBC type using the <code>@JdbcType</code> annotation.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@JdbcType</span><span class="o">(</span><span class="nc">VarcharJdbcType</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="kt">long</span> <span class="n">currentTimeMillis</span><span class="o">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Alternatively, we may specify a JDBC type code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@JdbcTypeCode</span><span class="o">(</span><span class="nc">Types</span><span class="o">.</span><span class="na">VARCHAR</span><span class="o">)</span>
<span class="kt">long</span> <span class="n">currentTimeMillis</span><span class="o">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>@JdbcTypeRegistration</code> annotation may be used to register a user-written <code>JdbcType</code> as the default for a given SQL type code.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">JDBC types and JDBC type codes</div>
<div class="paragraph">
<p>The types defined by the JDBC specification are enumerated by the integer type codes in the class <code>java.sql.Types</code>.
Each JDBC type is an abstraction of a commonly-available type in SQL.
For example, <code>Types.VARCHAR</code> represents the SQL type <code>VARCHAR</code> (or <code>VARCHAR2</code> on Oracle).</p>
</div>
<div class="paragraph">
<p>Since Hibernate understand more SQL types than JDBC, there&#8217;s an extended list of integer type codes in the class <code>org.hibernate.type.SqlTypes</code>.
For example, <code>SqlTypes.GEOMETRY</code> represents the spatial data type <code>GEOMETRY</code>.</p>
</div>
</div>
</div>
<h4 id="_attributeconverter" class="discrete">AttributeConverter</h4>
<div class="paragraph">
<p>If a given <code>JavaType</code> doesn&#8217;t know how to convert its instances to the type required by its partner <code>JdbcType</code>, we must help it out by providing a JPA <code>AttributeConverter</code> to perform the conversion.</p>
</div>
<div class="paragraph">
<p>For example, to form a basic type using <code>LongJavaType</code> and <code>TimestampJdbcType</code>, we would provide an <code>AttributeConverter&lt;Long,Timestamp&gt;</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@JdbcType</span><span class="o">(</span><span class="nc">TimestampJdbcType</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="nd">@Convert</span><span class="o">(</span><span class="n">converter</span> <span class="o">=</span> <span class="nc">LongToTimestampConverter</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="kt">long</span> <span class="n">currentTimeMillis</span><span class="o">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s abandon our analogy right here, before we start calling this basic type a "throuple".</p>
</div>
</div>
<div class="sect2">
<h3 id="embeddable-objects">3.14. Embeddable objects</h3>
<div class="paragraph">
<p>An embeddable object is a Java class whose state maps to multiple columns of a table, but which doesn&#8217;t have its own persistent identity.
That is, it&#8217;s a class with mapped attributes, but no <code>@Id</code> attribute.</p>
</div>
<div class="paragraph">
<p>An embeddable object can only be made persistent by assigning it to the attribute of an entity.
Since the embeddable object does not have its own persistent identity, its lifecycle with respect to persistence is completely determined by the lifecycle of the entity to which it belongs.</p>
</div>
<div class="paragraph">
<p>An embeddable class must be annotated <code>@Embeddable</code> instead of <code>@Entity</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Embeddable</span>
<span class="kd">class</span> <span class="nc">Name</span> <span class="o">{</span>

    <span class="nd">@Basic</span><span class="o">(</span><span class="n">optional</span><span class="o">=</span><span class="kc">false</span><span class="o">)</span>
    <span class="nc">String</span> <span class="n">firstName</span><span class="o">;</span>

    <span class="nd">@Basic</span><span class="o">(</span><span class="n">optional</span><span class="o">=</span><span class="kc">false</span><span class="o">)</span>
    <span class="nc">String</span> <span class="n">lastName</span><span class="o">;</span>

    <span class="nc">String</span> <span class="n">middleName</span><span class="o">;</span>

    <span class="nc">Name</span><span class="o">()</span> <span class="o">{}</span>

    <span class="nc">Name</span><span class="o">(</span><span class="nc">String</span> <span class="n">firstName</span><span class="o">,</span> <span class="nc">String</span> <span class="n">middleName</span><span class="o">,</span> <span class="nc">String</span> <span class="n">lastName</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">firstName</span> <span class="o">=</span> <span class="n">firstName</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">middleName</span> <span class="o">=</span> <span class="n">middleName</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">lastName</span> <span class="o">=</span> <span class="n">lastName</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="o">...</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>An embeddable class must satisfy the same requirements that entity classes satisfy, with the exception that an embeddable class has no <code>@Id</code> attribute.
In particular, it must have a constructor with no parameters.</p>
</div>
<div class="paragraph">
<p>Alternatively, an embeddable type may be defined as a Java record type:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Embeddable</span>
<span class="n">record</span> <span class="nf">Name</span><span class="o">(</span><span class="nc">String</span> <span class="n">firstName</span><span class="o">,</span> <span class="nc">String</span> <span class="n">middleName</span><span class="o">,</span> <span class="nc">String</span> <span class="n">lastName</span><span class="o">)</span> <span class="o">{}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In this case, the requirement for a constructor with no parameters is relaxed.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Unfortunately, as of May 2023, Java <code>record</code> types still cannot be used as <code>@EmbeddedId</code>s.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We may now use our <code>Name</code> class (or record) as the type of an entity attribute:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Entity</span>
<span class="kd">class</span> <span class="nc">Author</span> <span class="o">{</span>
    <span class="nd">@Id</span> <span class="nd">@GeneratedValue</span>
    <span class="nc">Long</span> <span class="n">id</span><span class="o">;</span>

    <span class="nc">Name</span> <span class="n">name</span><span class="o">;</span>

    <span class="o">...</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Embeddable types can be nested.
That is, an <code>@Embeddable</code> class may have an attribute whose type is itself a different <code>@Embeddable</code> class.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>JPA provides an <code>@Embedded</code> annotation to identify an attribute of an entity that refers to an embeddable type.
This annotation is completely optional, and so we don&#8217;t usually use it.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>On the other hand a reference to an embeddable type is <em>never</em> polymorphic.
One <code>@Embeddable</code> class <code>F</code> may inherit a second <code>@Embeddable</code> class <code>E</code>, but an attribute of type <code>E</code> will always refer to an instance of that concrete class <code>E</code>, never to an instance of <code>F</code>.</p>
</div>
<div class="paragraph">
<p>Usually, embeddable types are stored in a "flattened" format.
Their attributes map columns of the table of their parent entity.
Later, in <a href="#mapping-embeddables">Mapping embeddable types to UDTs or to JSON</a>, we&#8217;ll see a couple of different options.</p>
</div>
<div class="paragraph">
<p>An attribute of embeddable type represents a relationship between a Java object with a persistent identity, and a Java object with no persistent identity.
We can think of it as a whole/part relationship.
The embeddable object belongs to the entity, and can&#8217;t be shared with other entity instances.
And it exits for only as long as its parent entity exists.</p>
</div>
<div class="paragraph">
<p>Next we&#8217;ll discuss a different kind of relationship: a relationship between Java objects which each have their own distinct persistent identity and persistence lifecycle.</p>
</div>
</div>
<div class="sect2">
<h3 id="associations">3.15. Associations</h3>
<div class="paragraph">
<p>An <em>association</em> is a relationship between entities.
We usually classify associations based on their <em>multiplicity</em>.
If <code>E</code> and <code>F</code> are both entity classes, then:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>a <em>one-to-one</em> association relates at most one unique instance <code>E</code> with at most one unique instance of <code>F</code>,</p>
</li>
<li>
<p>a <em>many-to-one</em> association relates zero or more instances of <code>E</code> with a unique instance of <code>F</code>, and</p>
</li>
<li>
<p>a <em>many-to-many</em> association relates zero or more instances of <code>E</code> with zero or more instance of <code>F</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>An association between entity classes may be either:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>unidirectional</em>, navigable from <code>E</code> to <code>F</code> but not from <code>F</code> to <code>E</code>, or</p>
</li>
<li>
<p><em>bidirectional</em>, and navigable in either direction.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In this example data model, we can see the sorts of associations which are possible:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="images/associations.png" alt="Example data model">
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>An astute observer of the diagram above might notice that the relationship we&#8217;ve presented as a unidirectional one-to-one association could reasonably be represented in Java using subtyping.
This is quite normal.
A one-to-one association is the usual way we implement subtyping in a fully-normalized relational model.
It&#8217;s related to the <code>JOINED</code> <a href="#mapping-inheritance">inheritance mapping</a> strategy.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>There are three annotations for mapping associations: <code>@ManyToOne</code>, <code>@OneToMany</code>, and <code>@ManyToMany</code>.
They share some common annotation members:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 14. Association-defining annotation members</caption>
<colgroup>
<col style="width: 13%;">
<col>
<col style="width: 35%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Member</th>
<th class="tableblock halign-left valign-top">Interpretation</th>
<th class="tableblock halign-left valign-top">Default value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>cascade</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Persistence operations which should <a href="#cascade">cascade</a> to the associated entity; a list of <code>CascadeType</code>s</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>fetch</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether the association is <a href="#entity-graph">eagerly</a> <a href="#association-fetching">fetched</a> or may be <a href="#proxies-and-lazy-fetching">proxied</a></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p><code>LAZY</code> for <code>@OneToMany</code> and <code>@ManyToMany</code></p>
</li>
<li>
<p><code>EAGER</code> for <code>@ManyToOne</code> 💀💀💀</p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>targetEntity</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The associated entity class</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Determined from the attribute type declaration</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>optional</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">For a <code>@ManyToOne</code> or <code>@OneToOne</code> association, whether the association can be <code>null</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>true</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>mappedBy</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">For a bidirectional association, an attribute of the associated entity which maps the association</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">By default, the association is assumed unidirectional</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>We&#8217;ll explain the effect of these members as we consider the various types of association mapping.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s begin with the most common association multiplicity.</p>
</div>
</div>
<div class="sect2">
<h3 id="many-to-one">3.16. Many-to-one</h3>
<div class="paragraph">
<p>A many-to-one association is the most basic sort of association we can imagine.
It maps completely naturally to a foreign key in the database.
Almost all the associations in your domain model are going to be of this form.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Later, we&#8217;ll see how to map a many-to-one association to an <a href="#join-table-mappings">association table</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <code>@ManyToOne</code> annotation marks the "to one" side of the association, so a unidirectional many-to-one association looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">class</span> <span class="nc">Book</span> <span class="o">{</span>
    <span class="nd">@Id</span> <span class="nd">@GeneratedValue</span>
    <span class="nc">Long</span> <span class="n">id</span><span class="o">;</span>

    <span class="nd">@ManyToOne</span><span class="o">(</span><span class="n">fetch</span><span class="o">=</span><span class="no">LAZY</span><span class="o">)</span>
    <span class="nc">Publisher</span> <span class="n">publisher</span><span class="o">;</span>

    <span class="o">...</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here, the <code>Book</code> table has a foreign key column holding the identifier of the associated <code>Publisher</code>.</p>
</div>
<div id="lazy-problem" class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>A very unfortunate misfeature of JPA is that <code>@ManyToOne</code> associations are fetched eagerly by default.
This is almost never what we want.
Almost all associations should be lazy.
The only scenario in which <code>fetch=EAGER</code> makes sense is if we think there&#8217;s always a <em>very</em> high probability that the <a href="#caching-and-fetching">associated object will be found in the second-level cache</a>.
Whenever this isn&#8217;t the case, remember to explicitly specify <code>fetch=LAZY</code>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Most of the time, we would like to be able to easily navigate our associations in both directions.
We do need a way to get the <code>Publisher</code> of a given <code>Book</code>, but we would also like to be able to obtain all the <code>Book</code>s belonging to a given publisher.</p>
</div>
<div class="paragraph">
<p>To make this association bidirectional, we need to add a collection-valued attribute to the <code>Publisher</code> class, and annotate it <code>@OneToMany</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Hibernate needs to <a href="#proxies-and-lazy-fetching">proxy</a> unfetched associations at runtime.
Therefore, the many-valued side must be declared using an interface type like <code>Set</code> or <code>List</code>, and never using a concrete type like <code>HashSet</code> or <code>ArrayList</code>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To indicate clearly that this is a bidirectional association, and to reuse any mapping information already specified in the <code>Book</code> entity, we must use the <code>mappedBy</code> annotation member to refer back to <code>Book.publisher</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Entity</span>
<span class="kd">class</span> <span class="nc">Publisher</span> <span class="o">{</span>
    <span class="nd">@Id</span> <span class="nd">@GeneratedValue</span>
    <span class="nc">Long</span> <span class="n">id</span><span class="o">;</span>

    <span class="nd">@OneToMany</span><span class="o">(</span><span class="n">mappedBy</span><span class="o">=</span><span class="s">"publisher"</span><span class="o">)</span>
    <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">Book</span><span class="o">&gt;</span> <span class="n">books</span><span class="o">;</span>

    <span class="o">...</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>Publisher.books</code> field is called the <em>unowned</em> side of the association.</p>
</div>
<div class="paragraph">
<p>Now, we passionately <em>hate</em> the stringly-typed <code>mappedBy</code> reference to the owning side of the association.
Thankfully, the <a href="#metamodel-generator">Metamodel Generator</a> gives us a way to make it a
bit more typesafe:</p>
</div>
<div id="mapped-by-metamodel" class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@OneToMany</span><span class="o">(</span><span class="n">mappedBy</span><span class="o">=</span><span class="n">Book_</span><span class="o">.</span><span class="na">PUBLISHER</span><span class="o">)</span>  <span class="c1">// get used to doing it this way!</span>
<span class="nc">Set</span><span class="o">&lt;</span><span class="nc">Book</span><span class="o">&gt;</span> <span class="n">books</span><span class="o">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We&#8217;re going to use this approach for the rest of the Introduction.</p>
</div>
<div class="paragraph">
<p>To modify a bidirectional association, we must change the <em>owning side</em>.</p>
</div>
<div id="bidirectional-problem" class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Changes made to the unowned side of an association are never synchronized to the database.
If we desire to change an association in the database, we must change it from the owning side.
Here, we must set <code>Book.publisher</code>.</p>
</div>
<div class="paragraph">
<p>In fact, it&#8217;s often necessary to change <em>both sides</em> of a bidirectional association.
For example, if the collection <code>Publisher.books</code> was stored in the second-level cache, we must also modify the collection, to ensure that the second-level cache remains synchronized with the database.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>That said, it&#8217;s <em>not</em> a hard requirement to update the unowned side, at least if you&#8217;re sure you know what you&#8217;re doing.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>In principle Hibernate <em>does</em> allow you to have a unidirectional one-to-many, that is, a <code>@OneToMany</code> with no matching <code>@ManyToOne</code> on the other side.
In practice, this mapping is unnatural, and just doesn&#8217;t work very well.
Avoid it.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Here we&#8217;ve used <code>Set</code> as the type of the collection, but Hibernate also allows the use of <code>List</code> or <code>Collection</code> here, with almost no difference in semantics.
In particular, the <code>List</code> may not contain duplicate elements, and its order will not be persistent.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@OneToMany</span><span class="o">(</span><span class="n">mappedBy</span><span class="o">=</span><span class="n">Book_</span><span class="o">.</span><span class="na">PUBLISHER</span><span class="o">)</span>
<span class="nc">Collection</span><span class="o">&lt;</span><span class="nc">Book</span><span class="o">&gt;</span> <span class="n">books</span><span class="o">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We&#8217;ll see how to map a collection with a persistent order <a href="#ordered-sorted">much later</a>.</p>
</div>
<div id="set-vs-list" class="sidebarblock">
<div class="content">
<div class="title"><code>Set</code>, <code>List</code>, or <code>Collection</code>?</div>
<div class="paragraph">
<p>A one-to-many association mapped to a foreign key can never contain duplicate elements, so <code>Set</code> seems like the most semantically correct Java collection type to use here, and so that&#8217;s the conventional practice in the Hibernate community.</p>
</div>
<div class="paragraph">
<p>The catch associated with using a set is that we must carefully ensure that <code>Book</code> has a high-quality implementation of <a href="#equals-and-hash"><code>equals()</code> and <code>hashCode()</code></a>.
Now, that&#8217;s not necessarily a bad thing, since a quality <code>equals()</code> is independently useful.</p>
</div>
<div class="paragraph">
<p>But what if we used <code>Collection</code> or <code>List</code> instead?
Then our code would be much less sensitive to how <code>equals()</code> and <code>hashCode()</code> were implemented.</p>
</div>
<div class="paragraph">
<p>In the past, we were perhaps too dogmatic in recommending the use of <code>Set</code>.
Now? I guess we&#8217;re happy to let you guys decide.
In hindsight, we could have done more to make clear that this was always a viable option.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="one-to-one-fk">3.17. One-to-one (first way)</h3>
<div class="paragraph">
<p>The simplest sort of one-to-one association is almost exactly like a <code>@ManyToOne</code> association, except that it maps to a foreign key column with a <code>UNIQUE</code> constraint.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Later, we&#8217;ll see how to map a one-to-one association to an <a href="#join-table-mappings">association table</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>A one-to-one association must be annotated <code>@OneToOne</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Entity</span>
<span class="kd">class</span> <span class="nc">Author</span> <span class="o">{</span>
    <span class="nd">@Id</span> <span class="nd">@GeneratedValue</span>
    <span class="nc">Long</span> <span class="n">id</span><span class="o">;</span>

    <span class="nd">@OneToOne</span><span class="o">(</span><span class="n">optional</span><span class="o">=</span><span class="kc">false</span><span class="o">,</span> <span class="n">fetch</span><span class="o">=</span><span class="no">LAZY</span><span class="o">)</span>
    <span class="nc">Person</span> <span class="n">author</span><span class="o">;</span>

    <span class="o">...</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here, the <code>Author</code> table has a foreign key column holding the identifier of the associated <code>Publisher</code>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>A one-to-one association often models a "type of" relationship.
In our example, an <code>Author</code> is a type of <code>Person</code>.
An alternative—and often more natural—way to represent "type of" relationships in Java is via <a href="#entity-inheritance">entity class inheritance</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We can make this association bidirectional by adding a reference back to the <code>Author</code> in the <code>Person</code> entity:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Entity</span>
<span class="kd">class</span> <span class="nc">Person</span> <span class="o">{</span>
    <span class="nd">@Id</span> <span class="nd">@GeneratedValue</span>
    <span class="nc">Long</span> <span class="n">id</span><span class="o">;</span>

    <span class="nd">@OneToOne</span><span class="o">(</span><span class="n">mappedBy</span> <span class="o">=</span> <span class="n">Author_</span><span class="o">.</span><span class="na">PERSON</span><span class="o">)</span>
    <span class="nc">Author</span> <span class="n">author</span><span class="o">;</span>

    <span class="o">...</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>Person.author</code> is the unowned side, because it&#8217;s the side marked <code>mappedBy</code>.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Lazy fetching for one-to-one associations</div>
<div class="paragraph">
<p>Notice that we did not declare the unowned end of the association <code>fetch=LAZY</code>.
That&#8217;s because:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>not every <code>Person</code> has an associated <code>Author</code>, and</p>
</li>
<li>
<p>the foreign key is held in the table mapped by <code>Author</code>, not in the table mapped by <code>Person</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Therefore, Hibernate can&#8217;t tell if the reference from <code>Person</code> to <code>Author</code> is <code>null</code> without fetching the associated <code>Author</code>.</p>
</div>
<div class="paragraph">
<p>On the other hand, if <em>every</em> <code>Person</code> was an <code>Author</code>, that is, if the association were non-<code>optional</code>, we would not have to consider the possibility of <code>null</code> references, and we would map it like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@OneToOne</span><span class="o">(</span><span class="n">optional</span><span class="o">=</span><span class="kc">false</span><span class="o">,</span> <span class="n">mappedBy</span> <span class="o">=</span> <span class="n">Author_</span><span class="o">.</span><span class="na">PERSON</span><span class="o">,</span> <span class="n">fetch</span><span class="o">=</span><span class="no">LAZY</span><span class="o">)</span>
<span class="nc">Author</span> <span class="n">author</span><span class="o">;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>This is not the only sort of one-to-one association.</p>
</div>
</div>
<div class="sect2">
<h3 id="one-to-one-pk">3.18. One-to-one (second way)</h3>
<div class="paragraph">
<p>An arguably more elegant way to represent such a relationship is to share a primary key between the two tables.</p>
</div>
<div class="paragraph">
<p>To use this approach, the <code>Author</code> class must be annotated like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Entity</span>
<span class="kd">class</span> <span class="nc">Author</span> <span class="o">{</span>
    <span class="nd">@Id</span>
    <span class="nc">Long</span> <span class="n">id</span><span class="o">;</span>

    <span class="nd">@OneToOne</span><span class="o">(</span><span class="n">optional</span><span class="o">=</span><span class="kc">false</span><span class="o">,</span> <span class="n">fetch</span><span class="o">=</span><span class="no">LAZY</span><span class="o">)</span>
    <span class="nd">@MapsId</span>
    <span class="nc">Person</span> <span class="n">author</span><span class="o">;</span>

    <span class="o">...</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice that, compared with the previous mapping:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the <code>@Id</code> attribute is no longer a <code>@GeneratedValue</code> and,</p>
</li>
<li>
<p>instead, the <code>author</code> association is annotated <code>@MapsId</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This lets Hibernate know that the association to <code>Person</code> is the source of primary key values for <code>Author</code>.</p>
</div>
<div class="paragraph">
<p>Here, there&#8217;s no extra foreign key column in the <code>Author</code> table, since the <code>id</code> column holds the identifier of <code>Person</code>.
That is, the primary key of the <code>Author</code> table does double duty as the foreign key referring to the <code>Person</code> table.</p>
</div>
<div class="paragraph">
<p>The <code>Person</code> class doesn&#8217;t change.
If the association is bidirectional, we annotate the unowned side <code>@OneToOne(mappedBy = Author_.PERSON)</code> just as before.</p>
</div>
</div>
<div class="sect2">
<h3 id="many-to-many">3.19. Many-to-many</h3>
<div class="paragraph">
<p>A unidirectional many-to-many association is represented as a collection-valued attribute.
It always maps to a separate <em>association table</em> in the database.</p>
</div>
<div class="paragraph">
<p>It tends to happen that a many-to-many association eventually turns out to be an entity in disguise.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Suppose we start with a nice clean many-to-many association between <code>Author</code> and <code>Book</code>.
Later on, it&#8217;s quite likely that we&#8217;ll discover some additional information which comes attached to the association, so that the association table needs some extra columns.</p>
</div>
<div class="paragraph">
<p>For example, imagine that we needed to report the percentage contribution of each author to a book.
That information naturally belongs to the association table.
We can&#8217;t easily store it as an attribute of <code>Book</code>, nor as an attribute of <code>Author</code>.</p>
</div>
<div class="paragraph">
<p>When this happens, we need to change our Java model, usually introducing a new entity class which maps the association table directly.
In our example, we might call this entity something like <code>BookAuthorship</code>, and it would have <code>@OneToMany</code> associations to both <code>Author</code> and <code>Book</code>, along with the <code>contribution</code> attribute.</p>
</div>
<div class="paragraph">
<p>We can evade the disruption occasioned by such "discoveries" by simply avoiding the use of <code>@ManyToMany</code> right from the start.
There&#8217;s little downside to representing every—or at least <em>almost</em> every—logical many-to-many association using an intermediate entity.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>A many-to-many association must be annotated <code>@ManyToMany</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Entity</span>
<span class="kd">class</span> <span class="nc">Book</span> <span class="o">{</span>
    <span class="nd">@Id</span> <span class="nd">@GeneratedValue</span>
    <span class="nc">Long</span> <span class="n">id</span><span class="o">;</span>

    <span class="nd">@ManyToMany</span>
    <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">Author</span><span class="o">&gt;</span> <span class="n">authors</span><span class="o">;</span>

    <span class="o">...</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If the association is bidirectional, we add a very similar-looking attribute to <code>Book</code>, but this time we must specify <code>mappedBy</code> to indicate that this is the unowned side of the association:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Entity</span>
<span class="kd">class</span> <span class="nc">Book</span> <span class="o">{</span>
    <span class="nd">@Id</span> <span class="nd">@GeneratedValue</span>
    <span class="nc">Long</span> <span class="n">id</span><span class="o">;</span>

    <span class="nd">@ManyToMany</span><span class="o">(</span><span class="n">mappedBy</span><span class="o">=</span><span class="n">Author_</span><span class="o">.</span><span class="na">BOOKS</span><span class="o">)</span>
    <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">Author</span><span class="o">&gt;</span> <span class="n">authors</span><span class="o">;</span>

    <span class="o">...</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Remember, if we wish to the modify the collection we must <a href="#bidirectional-problem">change the owning side</a>.</p>
</div>
<div class="paragraph">
<p>We&#8217;ve again used <code>Set</code>s to represent the association.
As before, we have the option to use <code>Collection</code> or <code>List</code>.
But in this case it <em>does</em> make a difference to the semantics of the association.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>A many-to-many association represented as a <code>Collection</code> or <code>List</code> may contain duplicate elements.
However, as before, the order of the elements is not persistent.
That is, the collection is a <em>bag</em>, not a set.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="collections">3.20. Collections of basic values and embeddable objects</h3>
<div class="paragraph">
<p>We&#8217;ve now seen the following kinds of entity attribute:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 37%;">
<col style="width: 15%;">
<col style="width: 15%;">
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Kind of entity attribute</th>
<th class="tableblock halign-center valign-top">Kind of reference</th>
<th class="tableblock halign-center valign-top">Multiplicity</th>
<th class="tableblock halign-left valign-top">Examples</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Single-valued attribute of basic type</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">Non-entity</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">At most one</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@Basic String name</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Single-valued attribute of embeddable type</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">Non-entity</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">At most one</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@Embedded Name name</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Single-valued association</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">Entity</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">At most one</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@ManyToOne Publisher publisher</code><br>
<code>@OneToOne Person person</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Many-valued association</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">Entity</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">Zero or more</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@OneToMany Set&lt;Book&gt; books</code><br>
<code>@ManyToMany Set&lt;Author&gt; authors</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Scanning this taxonomy, you might ask: does Hibernate have multivalued attributes of basic or embeddable type?</p>
</div>
<div class="paragraph">
<p>Well, actually, we&#8217;ve already seen that it does, at least in two special cases.
So first, lets <a href="#basic-attributes">recall</a> that JPA treats <code>byte[]</code> and <code>char[]</code> arrays as basic types.
Hibernate persists a <code>byte[]</code> or <code>char[]</code> array to a <code>VARBINARY</code> or <code>VARCHAR</code> column, respectively.</p>
</div>
<div class="paragraph">
<p>But in this section we&#8217;re really concerned with cases <em>other</em> than these two special cases.
So then, <em>apart from <code>byte[]</code> and <code>char[]</code></em>, does Hibernate have multivalued attributes of basic or embeddable type?</p>
</div>
<div class="paragraph">
<p>And the answer again is that <em>it does</em>. Indeed, there are two different ways to handle such a collection, by mapping it:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>to a column of SQL <code>ARRAY</code> type (assuming the database has an <code>ARRAY</code> type), or</p>
</li>
<li>
<p>to a separate table.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>So we may expand our taxonomy with:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 37%;">
<col style="width: 15%;">
<col style="width: 15%;">
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Kind of entity attribute</th>
<th class="tableblock halign-center valign-top">Kind of reference</th>
<th class="tableblock halign-center valign-top">Multiplicity</th>
<th class="tableblock halign-left valign-top">Examples</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>byte[]</code> and <code>char[]</code> arrays</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">Non-entity</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">Zero or more</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>byte[] image</code><br>
<code>char[] text</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Collection of basic-typed elements</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">Non-entity</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">Zero or more</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@Array String[] names</code><br>
<code>@ElementCollection Set&lt;String&gt; names</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Collection of embeddable elements</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">Non-entity</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">Zero or more</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@ElementCollection Set&lt;Name&gt; names</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>There&#8217;s actually two new kinds of mapping here: <code>@Array</code> mappings, and <code>@ElementCollection</code> mappings.</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="paragraph">
<p>These sorts of mappings are overused.</p>
</div>
<div class="paragraph">
<p>There <em>are</em> situations where we think it&#8217;s appropriate to use a collection of basic-typed values in our entity class.
But such situations are rare.
Almost every many-valued relationship should map to a foreign key association between separate tables.
And almost every table should be mapped by an entity class.</p>
</div>
<div class="paragraph">
<p>The features we&#8217;re about to meet in the next two subsections are used much more often by beginners than they&#8217;re used by experts.
So if you&#8217;re a beginner, you&#8217;ll save yourself same hassle by staying away from these features for now.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We&#8217;ll talk about <code>@Array</code> mappings first.</p>
</div>
</div>
<div class="sect2">
<h3 id="arrays">3.21. Collections mapped to SQL arrays</h3>
<div class="paragraph">
<p>Let&#8217;s consider a calendar event which repeats on certain days of the week.
We might represent this in our <code>Event</code> entity as an attribute of type <code>DayOfWeek[]</code> or <code>List&lt;DayOfWeek&gt;</code>.
Since the number of elements of this array or list is upper bounded by 7, this is a reasonable case for the use of an <code>ARRAY</code>-typed column.
It&#8217;s hard to see much value in storing this collection in a separate table.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Learning to not hate SQL arrays</div>
<div class="paragraph">
<p>For a long time, we thought arrays were a kind of weird and warty thing to add to the relational model, but recently we&#8217;ve come to realize that this view was overly closed-minded.
Indeed, we might choose to view SQL <code>ARRAY</code> types as a generalization of <code>VARCHAR</code> and <code>VARBINARY</code> to generic "element" types.
And from this point of view, SQL arrays look quite attractive, at least for certain problems.
If we&#8217;re comfortable mapping <code>byte[]</code> to <code>VARBINARY(255)</code>, why would we shy away from mapping <code>DayOfWeek[]</code> to <code>TINYINT ARRAY[7]</code>?</p>
</div>
</div>
</div>
<div class="paragraph">
<p>Unfortunately, JPA doesn&#8217;t define a standard way to map SQL arrays, but here&#8217;s how we can do it in Hibernate:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Entity</span>
<span class="kd">class</span> <span class="nc">Event</span> <span class="o">{</span>
    <span class="nd">@Id</span> <span class="nd">@GeneratedValue</span>
    <span class="nc">Long</span> <span class="n">id</span><span class="o">;</span>
    <span class="o">...</span>
    <span class="nd">@Array</span><span class="o">(</span><span class="n">length</span><span class="o">=</span><span class="mi">7</span><span class="o">)</span>
    <span class="nc">DayOfWeek</span><span class="o">[]</span> <span class="n">daysOfWeek</span><span class="o">;</span>  <span class="c1">// stored as a SQL ARRAY type</span>
    <span class="o">...</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>@Array</code> annotation is optional, but it&#8217;s important to limit the amount of storage space the database allocates to the <code>ARRAY</code> column.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Now for the gotcha: not every database has a SQL <code>ARRAY</code> type, and some that <em>do</em> have an <code>ARRAY</code> type don&#8217;t allow it to be used as a column type.</p>
</div>
<div class="paragraph">
<p>In particular, neither DB2 nor SQL Server have array-typed columns.
On these databases, Hibernate falls back to something much worse: it uses Java serialization to encode the array to a binary representation, and stores the binary stream in a <code>VARBINARY</code> column.
Quite clearly, this is terrible.
You can ask Hibernate to do something <em>slightly</em> less terrible by annotating the attribute <code>@JdbcTypeCode(SqlTypes.JSON)</code>, so that the array is serialized to JSON instead of binary format.
But at this point it&#8217;s better to just admit defeat and use an <code>@ElementCollection</code> instead.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Alternatively, we could store this array or list in a separate table.</p>
</div>
</div>
<div class="sect2">
<h3 id="element-collections">3.22. Collections mapped to a separate table</h3>
<div class="paragraph">
<p>JPA <em>does</em> define a standard way to map a collection to an auxiliary table: the <code>@ElementCollection</code> annotation.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Entity</span>
<span class="kd">class</span> <span class="nc">Event</span> <span class="o">{</span>
    <span class="nd">@Id</span> <span class="nd">@GeneratedValue</span>
    <span class="nc">Long</span> <span class="n">id</span><span class="o">;</span>
    <span class="o">...</span>
    <span class="nd">@ElementCollection</span>
    <span class="nc">DayOfWeek</span><span class="o">[]</span> <span class="n">daysOfWeek</span><span class="o">;</span>  <span class="c1">// stored in a dedicated table</span>
    <span class="o">...</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Actually, we shouldn&#8217;t use an array here, since array types can&#8217;t be <a href="#proxies-and-lazy-fetching">proxied</a>, and so the JPA specification doesn&#8217;t even say they&#8217;re supported.
Instead, we should use <code>Set</code>, <code>List</code>, or <code>Map</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Entity</span>
<span class="kd">class</span> <span class="nc">Event</span> <span class="o">{</span>
    <span class="nd">@Id</span> <span class="nd">@GeneratedValue</span>
    <span class="nc">Long</span> <span class="n">id</span><span class="o">;</span>
    <span class="o">...</span>
    <span class="nd">@ElementCollection</span>
    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">DayOfWeek</span><span class="o">&gt;</span> <span class="n">daysOfWeek</span><span class="o">;</span>  <span class="c1">// stored in a dedicated table</span>
    <span class="o">...</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here, each collection element is stored as a separate row of the auxiliary table.
By default, this table has the following definition:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sql"><span class="k">create</span> <span class="k">table</span> <span class="n">Event_daysOfWeek</span> <span class="p">(</span>
    <span class="n">Event_id</span> <span class="nb">bigint</span> <span class="k">not</span> <span class="k">null</span><span class="p">,</span>
    <span class="n">daysOfWeek</span> <span class="nb">tinyint</span> <span class="k">check</span> <span class="p">(</span><span class="n">daysOfWeek</span> <span class="k">between</span> <span class="mi">0</span> <span class="k">and</span> <span class="mi">6</span><span class="p">),</span>
    <span class="n">daysOfWeek_ORDER</span> <span class="nb">integer</span> <span class="k">not</span> <span class="k">null</span><span class="p">,</span>
    <span class="k">primary</span> <span class="k">key</span> <span class="p">(</span><span class="n">Event_id</span><span class="p">,</span> <span class="n">daysOfWeek_ORDER</span><span class="p">)</span>
<span class="p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Which is fine, but it&#8217;s still a mapping we prefer to avoid.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p><code>@ElementCollection</code> is one of our least-favorite features of JPA.
Even the name of the annotation is bad.</p>
</div>
<div class="paragraph">
<p>The code above results in a table with three columns:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>a foreign key of the <code>Event</code> table,</p>
</li>
<li>
<p>a <code>TINYINT</code> encoding the <code>enum</code>, and</p>
</li>
<li>
<p>an <code>INTEGER</code> encoding the ordering of elements in the array.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Instead of a surrogate primary key, it has a composite key comprising the foreign key of <code>Event</code> and the order column.</p>
</div>
<div class="paragraph">
<p>When—inevitably—we find that we need to add a fourth column to that table, our Java code must change completely.
Most likely, we&#8217;ll realize that we need to add a separate entity after all.
So this mapping isn&#8217;t very robust in the face of minor changes to our data model.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>There&#8217;s much more we could say about "element collections", but we won&#8217;t say it, because we don&#8217;t want to hand you the gun you&#8217;ll shoot your foot with.</p>
</div>
</div>
<div class="sect2">
<h3 id="entities-summary">3.23. Summary of annotations</h3>
<div class="paragraph">
<p>Let&#8217;s pause to remember the annotations we&#8217;ve met so far.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 15. Declaring entities and embeddable types</caption>
<colgroup>
<col style="width: 22%;">
<col>
<col style="width: 13%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Annotation</th>
<th class="tableblock halign-left valign-top">Purpose</th>
<th class="tableblock halign-center valign-top">JPA-standard</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@Entity</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Declare an entity class</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&#10004;</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@MappedSuperclass</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Declare a non-entity class with mapped attributes inherited by an entity</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&#10004;</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@Embeddable</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Declare an embeddable type</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&#10004;</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@IdClass</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Declare the identifier class for an entity with multiple <code>@Id</code> attributes</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&#10004;</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 16. Declaring basic and embedded attributes</caption>
<colgroup>
<col style="width: 22%;">
<col>
<col style="width: 10%;">
<col style="width: 13%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Annotation</th>
<th class="tableblock halign-left valign-top">Purpose</th>
<th class="tableblock halign-center valign-top"></th>
<th class="tableblock halign-center valign-top">JPA-standard</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@Id</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Declare a basic-typed identifier attribute</p></td>
<td class="tableblock halign-center valign-top"></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&#10004;</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@Version</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Declare a version attribute</p></td>
<td class="tableblock halign-center valign-top"></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&#10004;</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@Basic</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Declare a basic attribute</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">Default</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&#10004;</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@EmbeddedId</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Declare an embeddable-typed identifier attribute</p></td>
<td class="tableblock halign-center valign-top"></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&#10004;</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@Embedded</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Declare an embeddable-typed attribute</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">Inferred</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&#10004;</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@Enumerated</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Declare an <code>enum</code>-typed attribute and specify how it is encoded</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">Inferred</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&#10004;</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@Array</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Declare that an attribute maps to a SQL <code>ARRAY</code>, and specify the length</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">Inferred</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&#10006;</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@ElementCollection</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Declare that a collection is mapped to a dedicated table</p></td>
<td class="tableblock halign-center valign-top"></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&#10004;</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 17. Converters and compositional basic types</caption>
<colgroup>
<col style="width: 22%;">
<col>
<col style="width: 13%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Annotation</th>
<th class="tableblock halign-left valign-top">Purpose</th>
<th class="tableblock halign-center valign-top">JPA-standard</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@Converter</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Register an <code>AttributeConverter</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&#10004;</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@Convert</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Apply a converter to an attribute</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&#10004;</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@JavaType</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Explicitly specify an implementation of <code>JavaType</code> for a basic attribute</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&#10006;</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@JdbcType</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Explicitly specify an implementation of <code>JdbcType</code> for a basic attribute</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&#10006;</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@JdbcTypeCode</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Explicitly specify a JDBC type code used to determine the <code>JdbcType</code> for a basic attribute</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&#10006;</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@JavaTypeRegistration</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Register a <code>JavaType</code> for a given Java type</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&#10006;</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@JdbcTypeRegistration</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Register a <code>JdbcType</code> for a given JDBC type code</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&#10006;</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 18. System-generated identifiers</caption>
<colgroup>
<col style="width: 22%;">
<col>
<col style="width: 13%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Annotation</th>
<th class="tableblock halign-left valign-top">Purpose</th>
<th class="tableblock halign-center valign-top">JPA-standard</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@GeneratedValue</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specify that an identifier is system-generated</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&#10004;</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@SequenceGenerator</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Define an id generated backed by on a database sequence</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&#10004;</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@TableGenerator</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Define an id generated backed by a database table</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&#10004;</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@IdGeneratorType</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Declare an annotation that associates a custom <code>Generator</code> with each <code>@Id</code> attribute it annotates</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&#10006;</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@ValueGenerationType</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Declare an annotation that associates a custom <code>Generator</code> with each <code>@Basic</code> attribute it annotates</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&#10006;</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 19. Declaring entity associations</caption>
<colgroup>
<col style="width: 22%;">
<col>
<col style="width: 13%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Annotation</th>
<th class="tableblock halign-left valign-top">Purpose</th>
<th class="tableblock halign-center valign-top">JPA-standard</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@ManyToOne</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Declare the single-valued side of a many-to-one association (the owning side)</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&#10004;</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@OneToMany</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Declare the many-valued side of a many-to-one association (the unowned side)</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&#10004;</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@ManyToMany</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Declare either side of a one-to-one association</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&#10004;</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@OneToOne</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Declare either side of a one-to-one association</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&#10004;</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@MapsId</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Declare that the owning side of a <code>@OneToOne</code> association maps the primary key column</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&#10004;</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Phew!
That&#8217;s already a lot of annotations, and we have not even started with the annotations for O/R mapping!</p>
</div>
</div>
<div class="sect2">
<h3 id="equals-and-hash">3.24. <code>equals()</code> and <code>hashCode()</code></h3>
<div class="paragraph">
<p>Entity classes should override <code>equals()</code> and <code>hashCode()</code>, especially when associations are <a href="#set-vs-list">represented as sets</a>.</p>
</div>
<div class="paragraph">
<p>People new to Hibernate or JPA are often confused by exactly which fields should be included in the <code>hashCode()</code>.
And people with more experience often argue quite religiously that one or another approach is the only right way.
The truth is, there&#8217;s no unique right way to do it, but there are some constraints.
So please keep the following principles in mind:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>You should not include a mutable field in the hashcode, since that would require rehashing every collection containing the entity whenever the field is mutated.</p>
</li>
<li>
<p>It&#8217;s not completely wrong to include a generated identifier (surrogate key) in the hashcode, but since the identifier is not generated until the entity instance is made persistent, you must take great care to not add it to any hashed collection before the identifier is generated. We therefore advise against including any database-generated field in the hashcode.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>It&#8217;s OK to include any immutable, non-generated field in the hashcode.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
We therefore recommend identifying a <a href="#natural-id-attributes">natural key</a> for each entity, that is, a combination of fields that uniquely identifies an instance of the entity, from the perspective of the data model of the program. The natural key should correspond to a unique constraint on the database, and to the fields which are included in <code>equals()</code> and <code>hashCode()</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In this example, the <code>equals()</code> and <code>hashCode()</code> methods agree with the <code>@NaturalId</code> annotation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Entity</span>
<span class="kd">class</span> <span class="nc">Book</span> <span class="o">{</span>

    <span class="nd">@Id</span> <span class="nd">@GeneratedValue</span>
    <span class="nc">Long</span> <span class="n">id</span><span class="o">;</span>

    <span class="nd">@NaturalId</span>
    <span class="nd">@Basic</span><span class="o">(</span><span class="n">optional</span><span class="o">=</span><span class="kc">false</span><span class="o">)</span>
    <span class="nc">String</span> <span class="n">isbn</span><span class="o">;</span>

    <span class="o">...</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">equals</span><span class="o">(</span><span class="nc">Object</span> <span class="n">other</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">other</span> <span class="k">instanceof</span> <span class="nc">Book</span>
            <span class="o">&amp;&amp;</span> <span class="o">((</span><span class="nc">Book</span><span class="o">)</span> <span class="n">other</span><span class="o">).</span><span class="na">isbn</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">isbn</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">hashCode</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">isbn</span><span class="o">.</span><span class="na">hashCode</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>That said, an implementation of <code>equals()</code> and <code>hashCode()</code> based on the generated identifier of the entity can work <em>if you&#8217;re careful</em>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="object-relational-mapping">4. Object/relational mapping</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Given a domain model—that is, a collection of entity classes decorated with all the fancy annotations we <a href="#entities-summary">just met</a> in the previous chapter—Hibernate will happily go away and infer a complete relational schema, and even <a href="#automatic-schema-export">export it to your database</a> if you ask politely.</p>
</div>
<div class="paragraph">
<p>The resulting schema will be entirely sane and reasonable, though if you look closely, you&#8217;ll find some flaws.
For example, every <code>VARCHAR</code> column will have the same length, <code>VARCHAR(255)</code>.</p>
</div>
<div class="paragraph">
<p>But the process I just described—which we call <em>top down</em> mapping—simply doesn&#8217;t fit the most common scenario for the use of O/R mapping.
It&#8217;s only rarely that the Java classes precede the relational schema.
Usually, <em>we already have a relational schema</em>, and we&#8217;re constructing our domain model around the schema.
This is called <em>bottom up</em> mapping.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Developers often refer to a pre-existing relational database as "legacy" data.
This tends to conjure images of bad old "legacy apps" written in COBOL or something.
But legacy data is valuable, and learning to work with it is important.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Especially when mapping bottom up, we often need to customize the inferred object/relational mappings.
This is a somewhat tedious topic, and so we don&#8217;t want to spend too many words on it.
Instead, we&#8217;ll quickly skim the most important mapping annotations.</p>
</div>
<div id="case-convention" class="sidebarblock">
<div class="content">
<div class="title">Hibernate SQL case convention</div>
<div class="paragraph">
<p>Computers have had lowercase letters for rather a long time now.
Most developers learned long ago that text written in MixedCase, camelCase, or even snake_case is easier to read than text written in SHOUTYCASE.
This is just as true of SQL as it is of any other language.</p>
</div>
<div class="paragraph">
<p>Therefore, for over twenty years, the convention on the Hibernate project has been that:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>query language identifiers are written in <code>lowercase</code>,</p>
</li>
<li>
<p>table names are written in <code>MixedCase</code>, and</p>
</li>
<li>
<p>column names are written in <code>camelCase</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>That is to say, we simply adopted Java&#8217;s excellent conventions and applied them to SQL.</p>
</div>
<div class="paragraph">
<p>Now, there&#8217;s no way we can force you to follow this convention, even if we wished to.
Hell, you can easily write a <code>PhysicalNamingStrategy</code> which makes table and column names ALL UGLY AND SHOUTY LIKE THIS IF YOU PREFER.
But, <em>by default</em>, it&#8217;s the convention Hibernate follows, and it&#8217;s frankly a pretty reasonable one.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="mapping-inheritance">4.1. Mapping entity inheritance hierarchies</h3>
<div class="paragraph">
<p>In <a href="#entity-inheritance">Entity class inheritance</a> we saw that entity classes may exist within an inheritance hierarchy.
There&#8217;s three basic strategies for mapping an entity hierarchy to relational tables.
Let&#8217;s put them in a table, so we can more easily compare the points of difference between them.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 20. Entity inheritance mapping strategies</caption>
<colgroup>
<col style="width: 16.6666%;">
<col style="width: 16.6666%;">
<col style="width: 16.6666%;">
<col style="width: 16.6666%;">
<col style="width: 16.6666%;">
<col style="width: 16.667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Strategy</th>
<th class="tableblock halign-left valign-top">Mapping</th>
<th class="tableblock halign-left valign-top">Polymorphic queries</th>
<th class="tableblock halign-left valign-top">Constraints</th>
<th class="tableblock halign-left valign-top">Normalization</th>
<th class="tableblock halign-left valign-top">When to use it</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>SINGLE_TABLE</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Map every class in the hierarchy to the same table, and uses the value of a <em>discriminator column</em> to determine which concrete class each row represents.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">To retrieve instances of a given class, we only need to query the one table.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Attributes declared by subclasses map to columns without <code>NOT NULL</code> constraints. 💀</p>
<p class="tableblock">  Any association may have a <code>FOREIGN KEY</code> constraint. 🤓</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Subclass data is denormalized. 🧐</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Works well when subclasses declare few or no additional attributes.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>JOINED</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Map every class in the hierarchy to a separate table, but each table only maps the attributes declared by the class itself.</p>
<p class="tableblock">  Optionally, a discriminator column may be used.</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>To retrieve instances of a given class, we must <code>JOIN</code> the table mapped by the class with:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>all tables mapped by its superclasses and</p>
</li>
<li>
<p>all tables mapped by its subclasses.</p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Any attribute may map to a column with a <code>NOT NULL</code> constraint. 🤓</p>
<p class="tableblock">  Any association may have a <code>FOREIGN KEY</code> constraint. 🤓</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The tables are normalized. 🤓</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The best option when we care a lot about constraints and normalization.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>TABLE_PER_CLASS</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Map every concrete class in the hierarchy to a separate table, but denormalize all inherited attributes into the table.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">To retrieve instances of a given class, we must take a <code>UNION</code> over the table mapped by the class and the tables mapped by its subclasses.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Associations targeting a superclass cannot have a corresponding <code>FOREIGN KEY</code> constraint in the database. 💀💀</p>
<p class="tableblock">  Any attribute may map to a column with a <code>NOT NULL</code> constraint. 🤓</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Superclass data is denormalized. 🧐</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Not very popular.</p>
<p class="tableblock">  From a certain point of view, competes with <code>@MappedSuperclass</code>.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The three mapping strategies are enumerated by <code>InheritanceType</code>.
We specify an inheritance mapping strategy using the <code>@Inheritance</code> annotation.</p>
</div>
<div class="paragraph">
<p>For mappings with a <em>discriminator column</em>, we should:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>specify the discriminator column name and type by annotating the root entity <code>@DiscriminatorColumn</code>, and</p>
</li>
<li>
<p>specify the values of this discriminator by annotating each entity in the hierarchy <code>@DiscriminatorValue</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For single table inheritance we always need a discriminator:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Entity</span>
<span class="nd">@DiscriminatorColumn</span><span class="o">(</span><span class="n">discriminatorType</span><span class="o">=</span><span class="no">CHAR</span><span class="o">,</span> <span class="n">name</span><span class="o">=</span><span class="s">"kind"</span><span class="o">)</span>
<span class="nd">@DiscriminatorValue</span><span class="o">(</span><span class="sc">'P'</span><span class="o">)</span>
<span class="kd">class</span> <span class="nc">Person</span> <span class="o">{</span> <span class="o">...</span> <span class="o">}</span>

<span class="nd">@Entity</span>
<span class="nd">@DiscriminatorValue</span><span class="o">(</span><span class="sc">'A'</span><span class="o">)</span>
<span class="kd">class</span> <span class="nc">Author</span> <span class="o">{</span> <span class="o">...</span> <span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We don&#8217;t need to explicitly specify <code>@Inheritance(strategy=SINGLE_TABLE)</code>, since that&#8217;s the default.</p>
</div>
<div class="paragraph">
<p>For <code>JOINED</code> inheritance we don&#8217;t need a discriminator:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Entity</span>
<span class="nd">@Inheritance</span><span class="o">(</span><span class="n">strategy</span><span class="o">=</span><span class="no">JOINED</span><span class="o">)</span>
<span class="kd">class</span> <span class="nc">Person</span> <span class="o">{</span> <span class="o">...</span> <span class="o">}</span>

<span class="nd">@Entity</span>
<span class="kd">class</span> <span class="nc">Author</span> <span class="o">{</span> <span class="o">...</span> <span class="o">}</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>However, we can add a discriminator column if we like, and in that case the generated SQL for polymorphic queries will be slightly simpler.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Similarly, for <code>TABLE_PER_CLASS</code> inheritance we have:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Entity</span>
<span class="nd">@Inheritance</span><span class="o">(</span><span class="n">strategy</span><span class="o">=</span><span class="no">TABLE_PER_CLASS</span><span class="o">)</span>
<span class="kd">class</span> <span class="nc">Person</span> <span class="o">{</span> <span class="o">...</span> <span class="o">}</span>

<span class="nd">@Entity</span>
<span class="kd">class</span> <span class="nc">Author</span> <span class="o">{</span> <span class="o">...</span> <span class="o">}</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Hibernate doesn&#8217;t allow discriminator columns for <code>TABLE_PER_CLASS</code> inheritance mappings, since they would make no sense, and offer no advantage.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Notice that in this last case, a polymorphic association like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@ManyToOne</span> <span class="nc">Person</span> <span class="n">person</span><span class="o">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>is a bad idea, since it&#8217;s impossible to create a foreign key constraint that targets both mapped tables.</p>
</div>
</div>
<div class="sect2">
<h3 id="table-mappings">4.2. Mapping to tables</h3>
<div class="paragraph">
<p>The following annotations specify exactly how elements of the domain model map to tables of the relational model:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 21. Annotations for mapping tables</caption>
<colgroup>
<col style="width: 25%;">
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Annotation</th>
<th class="tableblock halign-left valign-top">Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@Table</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Map an entity class to its primary table</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@SecondaryTable</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Define a secondary table for an entity class</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@JoinTable</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Map a many-to-many or many-to-one association to its association table</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@CollectionTable</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Map an <code>@ElementCollection</code> to its table</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The first two annotations are used to map an entity to its <em>primary table</em> and, optionally, one or more <em>secondary tables</em>.</p>
</div>
</div>
<div class="sect2">
<h3 id="entity-table-mappings">4.3. Mapping entities to tables</h3>
<div class="paragraph">
<p>By default, an entity maps to a single table, which may be specified using <code>@Table</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Entity</span>
<span class="nd">@Table</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"People"</span><span class="o">)</span>
<span class="kd">class</span> <span class="nc">Person</span> <span class="o">{</span> <span class="o">...</span> <span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>However, the <code>@SecondaryTable</code> annotation allows us to spread its attributes across multiple <em>secondary tables</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Entity</span>
<span class="nd">@Table</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"Books"</span><span class="o">)</span>
<span class="nd">@SecondaryTable</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"Editions"</span><span class="o">)</span>
<span class="kd">class</span> <span class="nc">Book</span> <span class="o">{</span> <span class="o">...</span> <span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>@Table</code> annotation can do more than just specify a name:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 22. <code>@Table</code> annotation members</caption>
<colgroup>
<col style="width: 20%;">
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Annotation member</th>
<th class="tableblock halign-left valign-top">Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>name</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The name of the mapped table</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>schema</code> 💀</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The schema to which the table belongs</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>catalog</code> 💀</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The catalog to which the table belongs</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>uniqueConstraints</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">One or more <code>@UniqueConstraint</code> annotations declaring multi-column unique constraints</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>indexes</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">One or more <code>@Index</code> annotations each declaring an index</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>It only makes sense to explicitly specify the <code>schema</code> in annotations if the domain model is spread across multiple schemas.</p>
</div>
<div class="paragraph">
<p>Otherwise, it&#8217;s a bad idea to hardcode the schema (or catalog) in a <code>@Table</code> annotation.
Instead:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>set the configuration property <code>hibernate.default_schema</code> (or <code>hibernate.default_catalog</code>), or</p>
</li>
<li>
<p>simply specify the schema in the JDBC connection URL.</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <code>@SecondaryTable</code> annotation is even more interesting:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 23. <code>@SecondaryTable</code> annotation members</caption>
<colgroup>
<col style="width: 20%;">
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Annotation member</th>
<th class="tableblock halign-left valign-top">Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>name</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The name of the mapped table</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>schema</code> 💀</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The schema to which the table belongs</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>catalog</code> 💀</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The catalog to which the table belongs</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>uniqueConstraints</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">One or more <code>@UniqueConstraint</code> annotations declaring multi-column unique constraints</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>indexes</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">One or more <code>@Index</code> annotations each declaring an index</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>pkJoinColumns</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">One or more <code>@PrimaryKeyJoinColumn</code> annotations, specifying <a href="#primary-key-column-mappings">primary key column mappings</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>foreignKey</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">An <code>@ForeignKey</code> annotation specifying the name of the <code>FOREIGN KEY</code> constraint on the <code>@PrimaryKeyJoinColumn</code>s</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Using <code>@SecondaryTable</code> on a subclass in a <code>SINGLE_TABLE</code> entity inheritance hierarchy gives us a sort of mix of <code>SINGLE_TABLE</code> with <code>JOINED</code> inheritance.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="join-table-mappings">4.4. Mapping associations to tables</h3>
<div class="paragraph">
<p>The <code>@JoinTable</code> annotation specifies an <em>association table</em>, that is, a table holding foreign keys of both associated entities.
This annotation is usually used with <code>@ManyToMany</code> associations:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Entity</span>
<span class="kd">class</span> <span class="nc">Book</span> <span class="o">{</span>
    <span class="o">...</span>

    <span class="nd">@ManyToMany</span>
    <span class="nd">@JoinTable</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"BooksAuthors"</span><span class="o">)</span>
    <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">Author</span><span class="o">&gt;</span> <span class="n">authors</span><span class="o">;</span>

    <span class="o">...</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>But it&#8217;s even possible to use it to map a <code>@ManyToOne</code> or <code>@OneToOne</code> association to an association table.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Entity</span>
<span class="kd">class</span> <span class="nc">Book</span> <span class="o">{</span>
    <span class="o">...</span>

    <span class="nd">@ManyToOne</span><span class="o">(</span><span class="n">fetch</span><span class="o">=</span><span class="no">LAZY</span><span class="o">)</span>
    <span class="nd">@JoinTable</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"BookPublisher"</span><span class="o">)</span>
    <span class="nc">Publisher</span> <span class="n">publisher</span><span class="o">;</span>

    <span class="o">...</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here, there should be a <code>UNIQUE</code> constraint on one of the columns of the association table.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Entity</span>
<span class="kd">class</span> <span class="nc">Author</span> <span class="o">{</span>
    <span class="o">...</span>

    <span class="nd">@OneToOne</span><span class="o">(</span><span class="n">optional</span><span class="o">=</span><span class="kc">false</span><span class="o">,</span> <span class="n">fetch</span><span class="o">=</span><span class="no">LAZY</span><span class="o">)</span>
    <span class="nd">@JoinTable</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"AuthorPerson"</span><span class="o">)</span>
    <span class="nc">Person</span> <span class="n">author</span><span class="o">;</span>

    <span class="o">...</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here, there should be a <code>UNIQUE</code> constraint on <em>both</em> columns of the association table.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 24. <code>@JoinTable</code> annotation members</caption>
<colgroup>
<col style="width: 20%;">
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Annotation member</th>
<th class="tableblock halign-left valign-top">Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>name</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The name of the mapped association table</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>schema</code> 💀</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The schema to which the table belongs</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>catalog</code> 💀</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The catalog to which the table belongs</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>uniqueConstraints</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">One or more <code>@UniqueConstraint</code> annotations declaring multi-column unique constraints</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>indexes</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">One or more <code>@Index</code> annotations each declaring an index</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>joinColumns</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">One or more <code>@JoinColumn</code> annotations, specifying <a href="#join-column-mappings">foreign key column mappings</a> to the table of the owning side</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>inverseJoinColumns</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">One or more <code>@JoinColumn</code> annotations, specifying <a href="#join-column-mappings">foreign key column mappings</a> to the table of the unowned side</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>foreignKey</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">An <code>@ForeignKey</code> annotation specifying the name of the <code>FOREIGN KEY</code> constraint on the <code>joinColumns</code>s</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>inverseForeignKey</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">An <code>@ForeignKey</code> annotation specifying the name of the <code>FOREIGN KEY</code> constraint on the <code>inverseJoinColumns</code>s</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>To better understand these annotations, we must first discuss column mappings in general.</p>
</div>
</div>
<div class="sect2">
<h3 id="column-mappings">4.5. Mapping to columns</h3>
<div class="paragraph">
<p>These annotations specify how elements of the domain model map to columns of tables in the relational model:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 25. Annotations for mapping columns</caption>
<colgroup>
<col style="width: 25%;">
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Annotation</th>
<th class="tableblock halign-left valign-top">Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@Column</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Map an attribute to a column</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@JoinColumn</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Map an association to a foreign key column</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@PrimaryKeyJoinColumn</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Map the primary key used to join a secondary table with its primary, or a subclass table in <code>JOINED</code> inheritance with its root class table</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@OrderColumn</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies a column that should be used to maintain the order of a <code>List</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@MapKeyColumn</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specified a column that should be used to persist the keys of a <code>Map</code>.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>We use the <code>@Column</code> annotation to map basic attributes.</p>
</div>
</div>
<div class="sect2">
<h3 id="regular-column-mappings">4.6. Mapping basic attributes to columns</h3>
<div class="paragraph">
<p>The <code>@Column</code> annotation is not only useful for specifying the column name.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 26. <code>@Column</code> annotation members</caption>
<colgroup>
<col style="width: 20%;">
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Annotation member</th>
<th class="tableblock halign-left valign-top">Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>name</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The name of the mapped column</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>table</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The name of the table to which this column belongs</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>length</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The length of a <code>VARCHAR</code>, <code>CHAR</code>, or <code>VARBINARY</code> column type</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>precision</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The decimal digits of precision of a <code>FLOAT</code>, <code>DECIMAL</code>, <code>NUMERIC</code>, or <code>TIME</code>, or <code>TIMESTAMP</code> column type</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>scale</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The scale of a <code>DECIMAL</code> or <code>NUMERIC</code> column type, the digits of precision that occur to the right of the decimal point</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>unique</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether the column has a <code>UNIQUE</code> constraint</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>nullable</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether the column has a <code>NOT NULL</code> constraint</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>insertable</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether the column should appear in generated SQL <code>INSERT</code> statements</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>updatable</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether the column should appear in generated SQL <code>UPDATE</code> statements</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>columnDefinition</code> 💀</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A DDL fragment that should be used to declare the column</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>We no longer recommend the use of <code>columnDefinition</code> since it results in unportable DDL.
Hibernate has much better ways to customize the generated DDL using techniques that result in portable behavior across different databases.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Here we see four different ways to use the <code>@Column</code> annotation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Entity</span>
<span class="nd">@Table</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"Books"</span><span class="o">)</span>
<span class="nd">@SecondaryTable</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"Editions"</span><span class="o">)</span>
<span class="kd">class</span> <span class="nc">Book</span> <span class="o">{</span>
    <span class="nd">@Id</span> <span class="nd">@GeneratedValue</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"bookId"</span><span class="o">)</span> <span class="c1">// customize column name</span>
    <span class="nc">Long</span> <span class="n">id</span><span class="o">;</span>

    <span class="nd">@Column</span><span class="o">(</span><span class="n">length</span><span class="o">=</span><span class="mi">100</span><span class="o">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">false</span><span class="o">)</span> <span class="c1">// declare column as VARCHAR(100) NOT NULL</span>
    <span class="nc">String</span> <span class="n">title</span><span class="o">;</span>

    <span class="nd">@Column</span><span class="o">(</span><span class="n">length</span><span class="o">=</span><span class="mi">17</span><span class="o">,</span> <span class="n">unique</span><span class="o">=</span><span class="kc">true</span><span class="o">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">false</span><span class="o">)</span> <span class="c1">// declare column as VARCHAR(17) NOT NULL UNIQUE</span>
    <span class="nc">String</span> <span class="n">isbn</span><span class="o">;</span>

    <span class="nd">@Column</span><span class="o">(</span><span class="n">table</span><span class="o">=</span><span class="s">"Editions"</span><span class="o">,</span> <span class="n">updatable</span><span class="o">=</span><span class="kc">false</span><span class="o">)</span> <span class="c1">// column belongs to the secondary table, and is never updated</span>
    <span class="kt">int</span> <span class="n">edition</span><span class="o">;</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We don&#8217;t use <code>@Column</code> to map associations.</p>
</div>
</div>
<div class="sect2">
<h3 id="join-column-mappings">4.7. Mapping associations to foreign key columns</h3>
<div class="paragraph">
<p>The <code>@JoinColumn</code> annotation is used to customize a foreign key column.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 27. <code>@JoinColumn</code> annotation members</caption>
<colgroup>
<col style="width: 20%;">
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Annotation member</th>
<th class="tableblock halign-left valign-top">Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>name</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The name of the mapped foreign key column</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>table</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The name of the table to which this column belongs</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>referencedColumnName</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The name of the column to which the mapped foreign key column refers</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>unique</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether the column has a <code>UNIQUE</code> constraint</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>nullable</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether the column has a <code>NOT NULL</code> constraint</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>insertable</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether the column should appear in generated SQL <code>INSERT</code> statements</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>updatable</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether the column should appear in generated SQL <code>UPDATE</code> statements</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>columnDefinition</code> 💀</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A DDL fragment that should be used to declare the column</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>foreignKey</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A <code>@ForeignKey</code> annotation specifying the name of the <code>FOREIGN KEY</code> constraint</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>A foreign key column doesn&#8217;t necessarily have to refer to the primary key of the referenced table.
It&#8217;s quite acceptable for the foreign key to refer to any other unique key of the referenced entity, even to a unique key of a secondary table.</p>
</div>
<div class="paragraph">
<p>Here we see how to use <code>@JoinColumn</code> to define a <code>@ManyToOne</code> association mapping a foreign key column which refers to the <code>@NaturalId</code> of <code>Book</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Entity</span>
<span class="nd">@Table</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"Items"</span><span class="o">)</span>
<span class="kd">class</span> <span class="nc">Item</span> <span class="o">{</span>
    <span class="o">...</span>

    <span class="nd">@ManyToOne</span><span class="o">(</span><span class="n">optional</span><span class="o">=</span><span class="kc">false</span><span class="o">)</span>  <span class="c1">// implies nullable=false</span>
    <span class="nd">@JoinColumn</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"bookIsbn"</span><span class="o">,</span> <span class="n">referencedColumnName</span> <span class="o">=</span> <span class="s">"isbn"</span><span class="o">,</span>  <span class="c1">// a reference to a non-PK column</span>
                <span class="n">foreignKey</span> <span class="o">=</span> <span class="nd">@ForeignKey</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"ItemsToBooksBySsn"</span><span class="o">))</span> <span class="c1">// supply a name for the FK constraint</span>
    <span class="nc">Book</span> <span class="n">book</span><span class="o">;</span>

    <span class="o">...</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In case this is confusing:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>bookIsbn</code> is the name of the foreign key column in the <code>Items</code> table,</p>
</li>
<li>
<p>it refers to a unique key <code>isbn</code> in the <code>Books</code> table, and</p>
</li>
<li>
<p>it has a foreign key constraint named <code>ItemsToBooksBySsn</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Note that the <code>foreignKey</code> member is completely optional and only affects DDL generation.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you don&#8217;t supply an explicit name using <code>@ForeignKey</code>, Hibernate will generate a quite ugly name.
The reason for this is that the maximum length of foreign key names on some databases is extremely constrained, and we need to avoid collisions.
To be fair, this is perfectly fine if you&#8217;re only using the generated DDL for testing.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For composite foreign keys we might have multiple <code>@JoinColumn</code> annotations:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Entity</span>
<span class="nd">@Table</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"Items"</span><span class="o">)</span>
<span class="kd">class</span> <span class="nc">Item</span> <span class="o">{</span>
    <span class="o">...</span>

    <span class="nd">@ManyToOne</span><span class="o">(</span><span class="n">optional</span><span class="o">=</span><span class="kc">false</span><span class="o">)</span>
    <span class="nd">@JoinColumn</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"bookIsbn"</span><span class="o">,</span> <span class="n">referencedColumnName</span> <span class="o">=</span> <span class="s">"isbn"</span><span class="o">)</span>
    <span class="nd">@JoinColumn</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"bookPrinting"</span><span class="o">,</span> <span class="n">referencedColumnName</span> <span class="o">=</span> <span class="s">"printing"</span><span class="o">)</span>
    <span class="nc">Book</span> <span class="n">book</span><span class="o">;</span>

    <span class="o">...</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If we need to specify the <code>@ForeignKey</code>, this starts to get a bit messy:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Entity</span>
<span class="nd">@Table</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"Items"</span><span class="o">)</span>
<span class="kd">class</span> <span class="nc">Item</span> <span class="o">{</span>
    <span class="o">...</span>

    <span class="nd">@ManyToOne</span><span class="o">(</span><span class="n">optional</span><span class="o">=</span><span class="kc">false</span><span class="o">)</span>
    <span class="nd">@JoinColumns</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="o">{</span><span class="nd">@JoinColumn</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"bookIsbn"</span><span class="o">,</span> <span class="n">referencedColumnName</span> <span class="o">=</span> <span class="s">"isbn"</span><span class="o">),</span>
                          <span class="nd">@JoinColumn</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"bookPrinting"</span><span class="o">,</span> <span class="n">referencedColumnName</span> <span class="o">=</span> <span class="s">"printing"</span><span class="o">)},</span>
                 <span class="n">foreignKey</span> <span class="o">=</span> <span class="nd">@ForeignKey</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"ItemsToBooksBySsn"</span><span class="o">))</span>
    <span class="nc">Book</span> <span class="n">book</span><span class="o">;</span>

    <span class="o">...</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>For associations mapped to a <code>@JoinTable</code>, fetching the association requires two joins, and so we must declare the <code>@JoinColumn</code>s inside the <code>@JoinTable</code> annotation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Entity</span>
<span class="kd">class</span> <span class="nc">Book</span> <span class="o">{</span>
    <span class="nd">@Id</span> <span class="nd">@GeneratedValue</span>
    <span class="nc">Long</span> <span class="n">id</span><span class="o">;</span>

    <span class="nd">@ManyToMany</span>
    <span class="nd">@JoinTable</span><span class="o">(</span><span class="n">joinColumns</span><span class="o">=</span><span class="nd">@JoinColumn</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"bookId"</span><span class="o">),</span>
               <span class="n">inverseJoinColumns</span><span class="o">=</span><span class="nd">@joinColumn</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"authorId"</span><span class="o">),</span>
               <span class="n">foreignKey</span><span class="o">=</span><span class="nd">@ForeignKey</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"BooksToAuthors"</span><span class="o">))</span>
    <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">Author</span><span class="o">&gt;</span> <span class="n">authors</span><span class="o">;</span>

    <span class="o">...</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Again, the <code>foreignKey</code> member is optional.</p>
</div>
</div>
<div class="sect2">
<h3 id="primary-key-column-mappings">4.8. Mapping primary key joins between tables</h3>
<div class="paragraph">
<p>The <code>@PrimaryKeyJoinColumn</code> is a special-purpose annotation for mapping:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the primary key column of a <code>@SecondaryTable</code>—which is also a foreign key referencing the primary table, or</p>
</li>
<li>
<p>the primary key column of the primary table mapped by a subclass in a <code>JOINED</code> inheritance hierarchy—which is also a foreign key referencing the primary table mapped by the root entity.</p>
</li>
</ul>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 28. <code>@PrimaryKeyJoinColumn</code> annotation members</caption>
<colgroup>
<col style="width: 20%;">
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Annotation member</th>
<th class="tableblock halign-left valign-top">Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>name</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The name of the mapped foreign key column</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>referencedColumnName</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The name of the column to which the mapped foreign key column refers</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>columnDefinition</code> 💀</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A DDL fragment that should be used to declare the column</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>foreignKey</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A <code>@ForeignKey</code> annotation specifying the name of the <code>FOREIGN KEY</code> constraint</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>When mapping a subclass table primary key, we place the <code>@PrimaryKeyJoinColumn</code> annotation on the entity class:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Entity</span>
<span class="nd">@Table</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"People"</span><span class="o">)</span>
<span class="nd">@Inheritance</span><span class="o">(</span><span class="n">strategy</span><span class="o">=</span><span class="no">JOINED</span><span class="o">)</span>
<span class="kd">class</span> <span class="nc">Person</span> <span class="o">{</span> <span class="o">...</span> <span class="o">}</span>

<span class="nd">@Entity</span>
<span class="nd">@Table</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"Authors"</span><span class="o">)</span>
<span class="nd">@PrimaryKeyJoinColumn</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"personId"</span><span class="o">)</span> <span class="c1">// the primary key of the Authors table</span>
<span class="kd">class</span> <span class="nc">Author</span> <span class="o">{</span> <span class="o">...</span> <span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>But to map a secondary table primary key, the <code>@PrimaryKeyJoinColumn</code> annotation must occur inside the <code>@SecondaryTable</code> annotation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Entity</span>
<span class="nd">@Table</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"Books"</span><span class="o">)</span>
<span class="nd">@SecondaryTable</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"Editions"</span><span class="o">,</span>
                <span class="n">pkJoinColumns</span> <span class="o">=</span> <span class="nd">@PrimaryKeyJoinColumn</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"bookId"</span><span class="o">))</span> <span class="c1">// the primary key of the Editions table</span>
<span class="kd">class</span> <span class="nc">Book</span> <span class="o">{</span>
    <span class="nd">@Id</span> <span class="nd">@GeneratedValue</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"bookId"</span><span class="o">)</span> <span class="c1">// the name of the primary key of the Books table</span>
    <span class="nc">Long</span> <span class="n">id</span><span class="o">;</span>

    <span class="o">...</span>
<span class="o">}</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="column-lengths">4.9. Column lengths and adaptive column types</h3>
<div class="paragraph">
<p>Hibernate automatically adjusts the column type used in generated DDL based on the column length specified by the <code>@Column</code> annotation.
So we don&#8217;t usually need to explicitly specify that a column should be of type <code>TEXT</code> or <code>CLOB</code>—or worry about the parade of <code>TINYTEXT</code>, <code>MEDIUMTEXT</code>, <code>TEXT</code>, <code>LONGTEXT</code> types on MySQL—because Hibernate will automatically select one of those types if required to accommodate a string of the <code>length</code> we specify.</p>
</div>
<div class="paragraph">
<p>The constant values defined in the class <a href="https://docs.jboss.org/hibernate/orm/6.3/javadocs/org/hibernate/Length.html"><code>Length</code></a> are very helpful here:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 29. Predefined column lengths</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 12%;">
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Constant</th>
<th class="tableblock halign-left valign-top">Value</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>DEFAULT</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">255</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The default length of a <code>VARCHAR</code> or <code>VARBINARY</code> column when none is explicitly specified</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>LONG</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">32600</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The largest column length for a <code>VARCHAR</code> or <code>VARBINARY</code> that is allowed on every database Hibernate supports</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>LONG16</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">32767</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The maximum length that can be represented using 16 bits (but this length is too large for a <code>VARCHAR</code> or <code>VARBINARY</code> column on for some database)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>LONG32</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2147483647</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The maximum length for a Java string</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>We can use these constants in the <code>@Column</code> annotation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Column</span><span class="o">(</span><span class="n">length</span><span class="o">=</span><span class="no">LONG</span><span class="o">)</span>
<span class="nc">String</span> <span class="n">text</span><span class="o">;</span>

<span class="nd">@Column</span><span class="o">(</span><span class="n">length</span><span class="o">=</span><span class="no">LONG32</span><span class="o">)</span>
<span class="kt">byte</span><span class="o">[]</span> <span class="n">binaryData</span><span class="o">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This is usually all you need to do to make use of large object types in Hibernate.</p>
</div>
</div>
<div class="sect2">
<h3 id="lobs">4.10. LOBs</h3>
<div class="paragraph">
<p>JPA provides a <code>@Lob</code> annotation which specifies that a field should be persisted as a <code>BLOB</code> or <code>CLOB</code>.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Semantics of the <code>@Lob</code> annotation</div>
<div class="paragraph">
<p>What the spec actually says is that the field should be persisted</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>&#8230;&#8203;as a large object to a database-supported large object type.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>It&#8217;s quite unclear what this means, and the spec goes on to say that</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>&#8230;&#8203;the treatment of the <code>Lob</code> annotation is provider-dependent&#8230;&#8203;</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>which doesn&#8217;t help much.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>Hibernate interprets this annotation in what we think is the most reasonable way.
In Hibernate, an attribute annotated <code>@Lob</code> will be written to JDBC using the <code>setClob()</code> or <code>setBlob()</code> method of <code>PreparedStatement</code>, and will be read from JDBC using the <code>getClob()</code> or <code>getBlob()</code> method of <code>ResultSet</code>.</p>
</div>
<div class="paragraph">
<p>Now, the use of these JDBC methods is usually unnecessary!
JDBC drivers are perfectly capable of converting between <code>String</code> and <code>CLOB</code> or between <code>byte[]</code> and <code>BLOB</code>.
So unless you specifically need to use these JDBC LOB APIs, you <em>don&#8217;t</em> need the <code>@Lob</code> annotation.</p>
</div>
<div class="paragraph">
<p>Instead, as we just saw in <a href="#column-lengths">Column lengths and adaptive column types</a>, all you need is to specify a large enough column <code>length</code> to accommodate the data you plan to write to that column.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Unfortunately, the driver for PostgreSQL doesn&#8217;t allow <code>BYTEA</code> or <code>TEXT</code> columns to be read via the JDBC LOB APIs.</p>
</div>
<div class="paragraph">
<p>This limitation of the Postgres driver has resulted in a whole cottage industry of bloggers and stackoverflow question-answerers recommending convoluted ways to hack the Hibernate <code>Dialect</code> for Postgres to allow an attribute annotated <code>@Lob</code> to be written using <code>setString()</code> and read using <code>getString()</code>.</p>
</div>
<div class="paragraph">
<p>But simply removing the <code>@Lob</code> annotation has exactly the same effect.</p>
</div>
<div class="paragraph">
<p>Conclusion:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>on PostgreSQL, <code>@Lob</code> always means the <code>OID</code> type,</p>
</li>
<li>
<p><code>@Lob</code> should never be used to map columns of type <code>BYTEA</code> or <code>TEXT</code>, and</p>
</li>
<li>
<p>please don&#8217;t believe everything you read on stackoverflow.</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Finally, as an alternative, Hibernate lets you declare an attribute of type <code>java.sql.Blob</code> or <code>java.sql.Clob</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Entity</span>
<span class="kd">class</span> <span class="nc">Book</span> <span class="o">{</span>
    <span class="o">...</span>
    <span class="nc">Clob</span> <span class="n">text</span><span class="o">;</span>
    <span class="nc">Blob</span> <span class="n">coverArt</span><span class="o">;</span>
    <span class="o">....</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The advantage is that a <code>java.sql.Clob</code> or <code>java.sql.Blob</code> can in principle index up to 2<sup>63</sup> characters or bytes, much more data than you can fit in a Java <code>String</code> or <code>byte[]</code> array (or in your computer).</p>
</div>
<div class="paragraph">
<p>To assign a value to these fields, we&#8217;ll need to use a <a href="https://docs.jboss.org/hibernate/orm/6.3/javadocs/org/hibernate/LobHelper.html"><code>LobHelper</code></a>.
We can get one from the <code>Session</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nc">LobHelper</span> <span class="n">helper</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">getLobHelper</span><span class="o">();</span>
<span class="n">book</span><span class="o">.</span><span class="na">text</span> <span class="o">=</span> <span class="n">helper</span><span class="o">.</span><span class="na">createClob</span><span class="o">(</span><span class="n">text</span><span class="o">);</span>
<span class="n">book</span><span class="o">.</span><span class="na">coverArt</span> <span class="o">=</span> <span class="n">helper</span><span class="o">.</span><span class="na">createBlob</span><span class="o">(</span><span class="n">image</span><span class="o">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In principle, the <code>Blob</code> and <code>Clob</code> objects provide efficient ways to read or stream LOB data from the server.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nc">Book</span> <span class="n">book</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">find</span><span class="o">(</span><span class="nc">Book</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">bookId</span><span class="o">);</span>
<span class="nc">String</span> <span class="n">text</span> <span class="o">=</span> <span class="n">book</span><span class="o">.</span><span class="na">text</span><span class="o">.</span><span class="na">getSubString</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">textLength</span><span class="o">);</span>
<span class="nc">InputStream</span> <span class="n">bytes</span> <span class="o">=</span> <span class="n">book</span><span class="o">.</span><span class="na">images</span><span class="o">.</span><span class="na">getBinaryStream</span><span class="o">();</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Of course, the behavior here depends very much on the JDBC driver, and so we really can&#8217;t promise that this is a sensible thing to do on your database.</p>
</div>
</div>
<div class="sect2">
<h3 id="mapping-embeddables">4.11. Mapping embeddable types to UDTs or to JSON</h3>
<div class="paragraph">
<p>There&#8217;s a couple of alternative ways to represent an embeddable type on the database side.</p>
</div>
<h4 id="_embeddables_as_udts" class="discrete">Embeddables as UDTs</h4>
<div class="paragraph">
<p>First, a really nice option, at least in the case of Java record types, and for databases which support <em>user-defined types</em> (UDTs), is to define a UDT which represents the record type.
Hibernate 6 makes this really easy.
Just annotate the record type, or the attribute which holds a reference to it, with the new <code>@Struct</code> annotation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Embeddable</span>
<span class="nd">@Struct</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"PersonName"</span><span class="o">)</span>
<span class="n">record</span> <span class="nf">Name</span><span class="o">(</span><span class="nc">String</span> <span class="n">firstName</span><span class="o">,</span> <span class="nc">String</span> <span class="n">middleName</span><span class="o">,</span> <span class="nc">String</span> <span class="n">lastName</span><span class="o">)</span> <span class="o">{}</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Entity</span>
<span class="kd">class</span> <span class="nc">Person</span> <span class="o">{</span>
    <span class="o">...</span>
    <span class="nc">Name</span> <span class="n">name</span><span class="o">;</span>
    <span class="o">...</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This results in the following UDT:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sql"><span class="k">create</span> <span class="k">type</span> <span class="n">PersonName</span> <span class="k">as</span> <span class="p">(</span><span class="n">firstName</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">255</span><span class="p">),</span> <span class="n">middleName</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">255</span><span class="p">),</span> <span class="n">lastName</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">255</span><span class="p">))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And the <code>name</code> column of the <code>Author</code> table will have the type <code>PersonName</code>.</p>
</div>
<h4 id="_embeddables_to_json" class="discrete">Embeddables to JSON</h4>
<div class="paragraph">
<p>A second option that&#8217;s available is to map the embeddable type to a <code>JSON</code> (or <code>JSONB</code>) column.
Now, this isn&#8217;t something we would exactly <em>recommend</em> if you&#8217;re defining a data model from scratch, but it&#8217;s at least useful for mapping pre-existing tables with JSON-typed columns.
Since embeddable types are nestable, we can map some JSON formats this way, and even query JSON properties using HQL.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>At this time, JSON arrays are not supported!</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To map an attribute of embeddable type to JSON, we must annotate the attribute <code>@JdbcTypeCode(SqlTypes.JSON)</code>, instead of annotating the embeddable type.
But the embeddable type <code>Name</code> should still be annotated <code>@Embeddable</code> if we want to query its attributes using HQL.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Embeddable</span>
<span class="n">record</span> <span class="nf">Name</span><span class="o">(</span><span class="nc">String</span> <span class="n">firstName</span><span class="o">,</span> <span class="nc">String</span> <span class="n">middleName</span><span class="o">,</span> <span class="nc">String</span> <span class="n">lastName</span><span class="o">)</span> <span class="o">{}</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Entity</span>
<span class="kd">class</span> <span class="nc">Person</span> <span class="o">{</span>
    <span class="o">...</span>
    <span class="nd">@JdbcTypeCode</span><span class="o">(</span><span class="nc">SqlTypes</span><span class="o">.</span><span class="na">JSON</span><span class="o">)</span>
    <span class="nc">Name</span> <span class="n">name</span><span class="o">;</span>
    <span class="o">...</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We also need to add Jackson or an implementation of JSONB—for example, Yasson—to our runtime classpath.
To use Jackson we could add this line to our Gradle build:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="n">runtimeOnly</span> <span class="s1">'com.fasterxml.jackson.core:jackson-databind:{jacksonVersion}'</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now the <code>name</code> column of the <code>Author</code> table will have the type <code>jsonb</code>, and Hibernate will automatically use Jackson to serialize a <code>Name</code> to and from JSON format.</p>
</div>
</div>
<div class="sect2">
<h3 id="miscellaneous-mappings">4.12. Summary of SQL column type mappings</h3>
<div class="paragraph">
<p>So, as we&#8217;ve seen, there are quite a few annotations that affect the mapping of Java types to SQL column types in DDL.
Here we summarize the ones we&#8217;ve just seen in the second half of this chapter, along with some we already mentioned in earlier chapters.</p>
</div>
<table class="tableblock frame-all grid-all fit-content stretch">
<caption class="title">Table 30. Annotations for mapping SQL column types</caption>
<colgroup>
<col>
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Annotation</th>
<th class="tableblock halign-left valign-top">Interpretation</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@Enumerated</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specify how an <code>enum</code> type should be persisted</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@Nationalized</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Use a nationalized character type: <code>NCHAR</code>, <code>NVARCHAR</code>, or <code>NCLOB</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@Lob</code> 💀</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Use JDBC LOB APIs to read and write the annotated attribute</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@Array</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Map a collection to a SQL <code>ARRAY</code> type of the specified length</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@Struct</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Map an embeddable to a SQL UDT with the given name</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@TimeZoneStorage</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specify how the time zone information should be persisted</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@JdbcType</code> or <code>@JdbcTypeCode</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Use an implementation of <code>JdbcType</code> to map an arbitrary SQL type</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>In addition, there are some configuration properties which have a <em>global</em> affect on how basic types map to SQL column types:</p>
</div>
<table class="tableblock frame-all grid-all fit-content stretch">
<caption class="title">Table 31. Type mapping settings</caption>
<colgroup>
<col>
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Configuration property name</th>
<th class="tableblock halign-left valign-top">Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>hibernate.use_nationalized_character_data</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Enable use of nationalized character types by default</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>hibernate.type.preferred_boolean_jdbc_type</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specify the default SQL column type for mapping <code>boolean</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>hibernate.type.preferred_uuid_jdbc_type</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specify the default SQL column type for mapping <code>UUID</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>hibernate.type.preferred_duration_jdbc_type</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specify the default SQL column type for mapping <code>Duration</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>hibernate.type.preferred_instant_jdbc_type</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specify the default SQL column type for mapping <code>Instant</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>hibernate.timezone.default_storage</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specify the default strategy for storing time zone information</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>These are <em>global</em> settings and thus quite clumsy.
We recommend against messing with any of these settings unless you have a really good reason for it.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>There&#8217;s one more topic we would like to cover in this chapter.</p>
</div>
</div>
<div class="sect2">
<h3 id="mapping-formulas">4.13. Mapping to formulas</h3>
<div class="paragraph">
<p>Hibernate lets us map an attribute of an entity to a SQL formula involving columns of the mapped table.
Thus, the attribute is a sort of "derived" value.</p>
</div>
<table class="tableblock frame-all grid-all fit-content stretch">
<caption class="title">Table 32. Annotations for mapping formulas</caption>
<colgroup>
<col>
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Annotation</th>
<th class="tableblock halign-left valign-top">Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@Formula</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Map an attribute to a SQL formula</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@JoinFormula</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Map an association to a SQL formula</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@DiscriminatorFormula</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Use a SQL formula as the discriminator in <a href="#mapping-inheritance">single table inheritance</a>.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Entity</span>
<span class="kd">class</span> <span class="nc">Order</span> <span class="o">{</span>
    <span class="o">...</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"sub_total"</span><span class="o">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">2</span><span class="o">,</span> <span class="n">precision</span><span class="o">=</span><span class="mi">8</span><span class="o">)</span>
    <span class="nc">BigDecimal</span> <span class="n">subTotal</span><span class="o">;</span>

    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"tax"</span><span class="o">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">4</span><span class="o">,</span> <span class="n">precision</span><span class="o">=</span><span class="mi">4</span><span class="o">)</span>
    <span class="nc">BigDecimal</span> <span class="n">taxRate</span><span class="o">;</span>

    <span class="nd">@Formula</span><span class="o">(</span><span class="s">"sub_total * (1.0 + tax)"</span><span class="o">)</span>
    <span class="nc">BigDecimal</span> <span class="n">totalWithTax</span><span class="o">;</span>
    <span class="o">...</span>
<span class="o">}</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="derived-identity">4.14. Derived Identity</h3>
<div class="paragraph">
<p>An entity has a <em>derived identity</em> if it inherits part of its primary key from an associated "parent" entity.
We&#8217;ve already met a kind of degenerate case of <em>derived identity</em> when we talked about <a href="#one-to-one-pk">one-to-one associations with a shared primary key</a>.</p>
</div>
<div class="paragraph">
<p>But a <code>@ManyToOne</code> association may also form part of a derived identity.
That is to say, there could be a foreign key column or columns included as part of the composite primary key.
There&#8217;s three different ways to represent this situation on the Java side of things:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>using <code>@IdClass</code> without <code>@MapsId</code>,</p>
</li>
<li>
<p>using <code>@IdClass</code> with <code>@MapsId</code>, or</p>
</li>
<li>
<p>using <code>@EmbeddedId</code> with <code>@MapsId</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Let&#8217;s suppose we have a <code>Parent</code> entity class defined as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Entity</span>
<span class="kd">class</span> <span class="nc">Parent</span> <span class="o">{</span>
    <span class="nd">@Id</span>
    <span class="nc">Long</span> <span class="n">parentId</span><span class="o">;</span>

    <span class="o">...</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>parentId</code> field holds the primary key of the <code>Parent</code> table, which will also form part of the composite primary key of every <code>Child</code> belonging to the <code>Parent</code>.</p>
</div>
<h4 id="_first_way" class="discrete">First way</h4>
<div class="paragraph">
<p>In the first, slightly simpler approach, we define an <code>@IdClass</code> to represent the primary key of <code>Child</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">class</span> <span class="nc">DerivedId</span> <span class="o">{</span>
    <span class="nc">Long</span> <span class="n">parent</span><span class="o">;</span>
    <span class="nc">String</span> <span class="n">childId</span><span class="o">;</span>

    <span class="c1">// constructors, equals, hashcode, etc</span>
    <span class="o">...</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And a <code>Child</code> entity class with a <code>@ManyToOne</code> association annotated <code>@Id</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Entity</span>
<span class="nd">@IdClass</span><span class="o">(</span><span class="nc">DerivedId</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="kd">class</span> <span class="nc">Child</span> <span class="o">{</span>
    <span class="nd">@Id</span>
    <span class="nc">String</span> <span class="n">childId</span><span class="o">;</span>

    <span class="nd">@Id</span> <span class="nd">@ManyToOne</span>
    <span class="nd">@JoinColumn</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"parentId"</span><span class="o">)</span>
    <span class="nc">Parent</span> <span class="n">parent</span><span class="o">;</span>

    <span class="o">...</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Then the primary key of the <code>Child</code> table comprises the columns <code>(childId,parentId)</code>.</p>
</div>
<h4 id="_second_way" class="discrete">Second way</h4>
<div class="paragraph">
<p>This is fine, but sometimes it&#8217;s nice to have a field for each element of the primary key.
We may use the <code>@MapsId</code> annotation we met <a href="#one-to-one-pk">earlier</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Entity</span>
<span class="nd">@IdClass</span><span class="o">(</span><span class="nc">DerivedId</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="kd">class</span> <span class="nc">Child</span> <span class="o">{</span>
    <span class="nd">@Id</span>
    <span class="nc">Long</span> <span class="n">parentId</span><span class="o">;</span>
    <span class="nd">@Id</span>
    <span class="nc">String</span> <span class="n">childId</span><span class="o">;</span>

    <span class="nd">@ManyToOne</span>
    <span class="nd">@MapsId</span><span class="o">(</span><span class="n">Child_</span><span class="o">.</span><span class="na">PARENT_ID</span><span class="o">)</span> <span class="c1">// typesafe reference to Child.parentId</span>
    <span class="nd">@JoinColumn</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"parentId"</span><span class="o">)</span>
    <span class="nc">Parent</span> <span class="n">parent</span><span class="o">;</span>

    <span class="o">...</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We&#8217;re using the approach we saw <a href="#mapped-by-metamodel">previously</a> to refer to the <code>parentId</code> property of <code>Child</code> in a typesafe way.</p>
</div>
<div class="paragraph">
<p>Note that we must place column mapping information on the association annotated <code>@MapsId</code>, not on the <code>@Id</code> field.</p>
</div>
<div class="paragraph">
<p>We must slightly modify our <code>@IdClass</code> so that field names align:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">class</span> <span class="nc">DerivedId</span> <span class="o">{</span>
    <span class="nc">Long</span> <span class="n">parentId</span><span class="o">;</span>
    <span class="nc">String</span> <span class="n">childId</span><span class="o">;</span>

    <span class="c1">// constructors, equals, hashcode, etc</span>
    <span class="o">...</span>
<span class="o">}</span></code></pre>
</div>
</div>
<h4 id="_third_way" class="discrete">Third way</h4>
<div class="paragraph">
<p>The third alternative is to redefine our <code>@IdClass</code> as an <code>@Embeddable</code>.
We don&#8217;t actually need to change the <code>DerivedId</code> class, but we do need to add the annotation.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Embeddable</span>
<span class="kd">class</span> <span class="nc">DerivedId</span> <span class="o">{</span>
    <span class="nc">Long</span> <span class="n">parentId</span><span class="o">;</span>
    <span class="nc">String</span> <span class="n">childId</span><span class="o">;</span>

    <span class="c1">// constructors, equals, hashcode, etc</span>
    <span class="o">...</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Then we may use <code>@EmbeddedId</code> in <code>Child</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Entity</span>
<span class="kd">class</span> <span class="nc">Child</span> <span class="o">{</span>
    <span class="nd">@EmbeddedId</span>
    <span class="nc">DerivedId</span> <span class="n">id</span><span class="o">;</span>

    <span class="nd">@ManyToOne</span>
    <span class="nd">@MapsId</span><span class="o">(</span><span class="n">DerivedId_</span><span class="o">.</span><span class="na">PARENT_ID</span><span class="o">)</span> <span class="c1">// typesafe reference to DerivedId.parentId</span>
    <span class="nd">@JoinColumn</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"parentId"</span><span class="o">)</span>
    <span class="nc">Parent</span> <span class="n">parent</span><span class="o">;</span>

    <span class="o">...</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <a href="#composite-identifiers">choice</a> between <code>@IdClass</code> and <code>@EmbeddedId</code> boils down to taste.
The <code>@EmbeddedId</code> is perhaps a little DRYer.</p>
</div>
</div>
<div class="sect2">
<h3 id="constraints">4.15. Adding constraints</h3>
<div class="paragraph">
<p>Database constraints are important.
Even if you&#8217;re sure that your program has no bugs 🧐, it&#8217;s probably not the only program with access to the database.
Constraints help ensure that different programs (and human administrators) play nicely with each other.</p>
</div>
<div class="paragraph">
<p>Hibernate adds certain constraints to generated DDL automatically: primary key constraints, foreign key constraints, and some unique constraints.
But it&#8217;s common to need to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>add additional unique constraints,</p>
</li>
<li>
<p>add check constraints, or</p>
</li>
<li>
<p>customize the name of a foreign key constraint.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>We&#8217;ve <a href="#join-column-mappings">already seen</a> how to use <code>@ForeignKey</code> to specify the name of a foreign key constraint.</p>
</div>
<div class="paragraph">
<p>There&#8217;s two ways to add a unique constraint to a table:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>using <code>@Column(unique=true)</code> to indicate a single-column unique key, or</p>
</li>
<li>
<p>using the <code>@UniqueConstraint</code> annotation to define a uniqueness constraint on a combination of columns.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Entity</span>
<span class="nd">@Table</span><span class="o">(</span><span class="n">uniqueConstraints</span><span class="o">=</span><span class="nd">@UniqueConstraint</span><span class="o">(</span><span class="n">columnNames</span><span class="o">={</span><span class="s">"title"</span><span class="o">,</span> <span class="s">"year"</span><span class="o">,</span> <span class="s">"publisher_id"</span><span class="o">}))</span>
<span class="kd">class</span> <span class="nc">Book</span> <span class="o">{</span> <span class="o">...</span> <span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This annotation looks a bit ugly perhaps, but it&#8217;s actually useful even as documentation.</p>
</div>
<div class="paragraph">
<p>The <code>@Check</code> annotation adds a check constraint to the table.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Entity</span>
<span class="nd">@Check</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"ValidISBN"</span><span class="o">,</span> <span class="n">constraints</span><span class="o">=</span><span class="s">"length(isbn)=13"</span><span class="o">)</span>
<span class="kd">class</span> <span class="nc">Book</span> <span class="o">{</span> <span class="o">...</span> <span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>@Check</code> annotation is commonly used at the field level:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Id</span> <span class="nd">@Check</span><span class="o">(</span><span class="n">constraints</span><span class="o">=</span><span class="s">"length(isbn)=13"</span><span class="o">)</span>
<span class="nc">String</span> <span class="n">isbn</span><span class="o">;</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="interacting">5. Interacting with the database</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To interact with the database, that is, to execute queries, or to insert, update, or delete data, we need an instance of one of the following objects:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>a JPA <code>EntityManager</code>,</p>
</li>
<li>
<p>a Hibernate <code>Session</code>, or</p>
</li>
<li>
<p>a Hibernate <code>StatelessSession</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The <code>Session</code> interface extends <code>EntityManager</code>, and so the only difference between the two interfaces is that <code>Session</code> offers a few more operations.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Actually, in Hibernate, every <code>EntityManager</code> is a <code>Session</code>, and you can narrow it like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nc">Session</span> <span class="n">session</span> <span class="o">=</span> <span class="n">entityManager</span><span class="o">.</span><span class="na">unwrap</span><span class="o">(</span><span class="nc">Session</span><span class="o">.</span><span class="na">class</span><span class="o">);</span></code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>An instance of <code>Session</code> (or of <code>EntityManager</code>) is a <em>stateful session</em>.
It mediates the interaction between your program and the database via a operations on a <em>persistence context</em>.</p>
</div>
<div class="paragraph">
<p>In this chapter, we&#8217;re not going to talk much about <code>StatelessSession</code>.
We&#8217;ll come back to <a href="#stateless-sessions">this very useful API</a> when we talk about performance.
What you need to know for now is that a stateless session doesn&#8217;t have a persistence context.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Still, we should let you know that some people prefer to use <code>StatelessSession</code> everywhere.
It&#8217;s a simpler programming model, and lets the developer interact with the database more <em>directly</em>.</p>
</div>
<div class="paragraph">
<p>Stateful sessions certainly have their advantages, but they&#8217;re more difficult to reason about, and when something goes wrong, the error messages can be more difficult to understand.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="persistence-contexts">5.1. Persistence Contexts</h3>
<div class="paragraph">
<p>A persistence context is a sort of cache; we sometimes call it the "first-level cache", to distinguish it from the <a href="#second-level-cache">second-level cache</a>.
For every entity instance read from the database within the scope of a persistence context, and for every new entity made persistent within the scope of the persistence context, the context holds a unique mapping from the identifier of the entity instance to the instance itself.</p>
</div>
<div class="paragraph">
<p>Thus, an entity instance may be in one of three states with respect to a given persistence context:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><em>transient</em> — never persistent, and not associated with the persistence context,</p>
</li>
<li>
<p><em>persistent</em> — currently associated with the persistence context, or</p>
</li>
<li>
<p><em>detached</em> — previously persistent in another session, but not currently associated with <em>this</em> persistence context.</p>
</li>
</ol>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="images/entity-lifecyle.png" alt="Entity lifecycle" width="800">
</div>
</div>
<div class="paragraph">
<p>At any given moment, an instance may be associated with at most one persistence context.</p>
</div>
<div class="paragraph">
<p>The lifetime of a persistence context usually corresponds to the lifetime of a transaction, though it&#8217;s possible to have a persistence context that spans several database-level transactions that form a single logical unit of work.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>A persistence context—that is, a <code>Session</code> or <code>EntityManager</code>—absolutely positively <strong>must not be shared between multiple threads or between concurrent transactions.</strong></p>
</div>
<div class="paragraph">
<p>If you accidentally leak a session across threads, you will suffer.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Container-managed persistence contexts</div>
<div class="paragraph">
<p>In a container environment, the lifecycle of a persistence context scoped to the transaction will usually be managed for you.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>There are several reasons we like persistence contexts.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>They help avoid <em>data aliasing</em>: if we modify an entity in one section of code, then other code executing within the same persistence context will see our modification.</p>
</li>
<li>
<p>They enable <em>automatic dirty checking</em>: after modifying an entity, we don&#8217;t need to perform any explicit operation to ask Hibernate to propagate that change back to the database.
Instead, the change will be automatically synchronized with the database when the session is <a href="#flush">flushed</a>.</p>
</li>
<li>
<p>They can improve performance by avoiding a trip to the database when a given entity instance is requested repeatedly in a given unit of work.</p>
</li>
<li>
<p>They make it possible to <em>transparently batch</em> together multiple database operations.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>A persistence context also allows us to detect circularities when performing operations on graphs of entities.
(Even in a stateless session, we need some sort of temporary cache of the entity instances we&#8217;ve visited while executing a query.)</p>
</div>
<div class="paragraph">
<p>On the other hand, stateful sessions come with some very important restrictions, since:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>persistence contexts aren&#8217;t threadsafe, and can&#8217;t be shared across threads, and</p>
</li>
<li>
<p>a persistence context can&#8217;t be reused across unrelated transactions, since that would break the isolation and atomicity of the transactions.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Furthermore, a persistence context holds a hard references to all its entities, preventing them from being garbage collected.
Thus, the session must be discarded once a unit of work is complete.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you don&#8217;t completely understand the previous passage, go back and re-read it until you do.
A great deal of human suffering has resulted from users mismanaging the lifecycle of the Hibernate <code>Session</code> or JPA <code>EntityManager</code>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We&#8217;ll conclude by noting that whether a persistence context helps or harms the performance of a given unit of work depends greatly on the nature of the unit of work.
For this reason Hibernate provides both stateful and stateless sessions.</p>
</div>
</div>
<div class="sect2">
<h3 id="creating-session">5.2. Creating a session</h3>
<div class="paragraph">
<p>Sticking with standard JPA-defined APIs, we saw how to obtain an <code>EntityManagerFactory</code> in <a href="#configuration-jpa">Configuration using JPA XML</a>.
It&#8217;s quite unsurprising that we may use this object to create an <code>EntityManager</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nc">EntityManager</span> <span class="n">entityManager</span> <span class="o">=</span> <span class="n">entityManagerFactory</span><span class="o">.</span><span class="na">createEntityManager</span><span class="o">();</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>When we&#8217;re finished with the <code>EntityManager</code>, we should explicitly clean it up:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="n">entityManager</span><span class="o">.</span><span class="na">close</span><span class="o">();</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>On the other hand, if we&#8217;re starting from a <code>SessionFactory</code>, as described in <a href="#configuration-api">Configuration using Hibernate API</a>, we may use:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nc">Session</span> <span class="n">session</span> <span class="o">=</span> <span class="n">sessionFactory</span><span class="o">.</span><span class="na">openSession</span><span class="o">();</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>But we still need to clean up:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="n">session</span><span class="o">.</span><span class="na">close</span><span class="o">();</span></code></pre>
</div>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Injecting the <code>EntityManager</code></div>
<div class="paragraph">
<p>If you&#8217;re writing code for some sort of container environment, you&#8217;ll probably obtain the <code>EntityManager</code> by some sort of dependency injection.
For example, in Java (or Jakarta) EE you would write:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@PersistenceContext</span> <span class="nc">EntityManager</span> <span class="n">entityManager</span><span class="o">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In Quarkus, injection is handled by CDI:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Inject</span> <span class="nc">EntityManager</span> <span class="n">entityManager</span><span class="o">;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Outside a container environment, we&#8217;ll also have to write code to manage database transactions.</p>
</div>
</div>
<div class="sect2">
<h3 id="managing-transactions">5.3. Managing transactions</h3>
<div class="paragraph">
<p>Using JPA-standard APIs, the <code>EntityTransaction</code> interface allows us to control database transactions.
The idiom we recommend is the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nc">EntityManager</span> <span class="n">entityManager</span> <span class="o">=</span> <span class="n">entityManagerFactory</span><span class="o">.</span><span class="na">createEntityManager</span><span class="o">();</span>
<span class="nc">EntityTransaction</span> <span class="n">tx</span> <span class="o">=</span> <span class="n">entityManager</span><span class="o">.</span><span class="na">getTransaction</span><span class="o">();</span>
<span class="k">try</span> <span class="o">{</span>
    <span class="n">tx</span><span class="o">.</span><span class="na">begin</span><span class="o">();</span>
    <span class="c1">//do some work</span>
    <span class="o">...</span>
    <span class="n">tx</span><span class="o">.</span><span class="na">commit</span><span class="o">();</span>
<span class="o">}</span>
<span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">tx</span><span class="o">.</span><span class="na">isActive</span><span class="o">())</span> <span class="n">tx</span><span class="o">.</span><span class="na">rollback</span><span class="o">();</span>
    <span class="k">throw</span> <span class="n">e</span><span class="o">;</span>
<span class="o">}</span>
<span class="k">finally</span> <span class="o">{</span>
    <span class="n">entityManager</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Using Hibernate&#8217;s native APIs we might write something really similar,
but since this sort of code is extremely tedious, we have a much nicer option:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="n">sessionFactory</span><span class="o">.</span><span class="na">inTransaction</span><span class="o">(</span><span class="n">session</span> <span class="o">-&gt;</span> <span class="o">{</span>
    <span class="c1">//do the work</span>
    <span class="o">...</span>
<span class="o">});</span></code></pre>
</div>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Container-managed transactions</div>
<div class="paragraph">
<p>In a container environment, the container itself is usually responsible for managing transactions.
In Java EE or Quarkus, you&#8217;ll probably indicate the boundaries of the transaction using the <code>@Transactional</code> annotation.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="persistence-operations">5.4. Operations on the persistence context</h3>
<div class="paragraph">
<p>Of course, the main reason we need an <code>EntityManager</code> is to do stuff to the database.
The following important operations let us interact with the persistence context and schedule modifications to the data:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 33. Methods for modifying data and managing the persistence context</caption>
<colgroup>
<col style="width: 30%;">
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Method name and parameters</th>
<th class="tableblock halign-left valign-top">Effect</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>persist(Object)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Make a transient object persistent and schedule a SQL <code>insert</code> statement for later execution</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>remove(Object)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Make a persistent object transient and schedule a SQL <code>delete</code> statement for later execution</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>merge(Object)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Copy the state of a given detached object to a corresponding managed persistent instance and return
the persistent object</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>detach(Object)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Disassociate a persistent object from a session without
affecting the database</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>clear()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Empty the persistence context and detach all its entities</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>flush()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Detect changes made to persistent objects association with the session and synchronize the database state with the state of the session by executing SQL <code>insert</code>, <code>update</code>, and <code>delete</code> statements</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Notice that <code>persist()</code> and <code>remove()</code> have no immediate effect on the database, and instead simply schedule a command for later execution.
Also notice that there&#8217;s no <code>update()</code> operation for a stateful session.
Modifications are automatically detected when the session is <a href="#flush">flushed</a>.</p>
</div>
<div class="paragraph">
<p>On the other hand, except for <code>getReference()</code>, the following operations all result in immediate access to the database:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 34. Methods for reading and locking data</caption>
<colgroup>
<col style="width: 30%;">
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Method name and parameters</th>
<th class="tableblock halign-left valign-top">Effect</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>find(Class,Object)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Obtain a persistent object given its type and its id</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>find(Class,Object,LockModeType)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Obtain a persistent object given its type and its id, requesting the given <a href="#optimistic-and-pessimistic-locking">optimistic or pessimistic lock mode</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>getReference(Class,id)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Obtain a reference to a persistent object given its type and its id, without actually loading its state from the database</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>getReference(Object)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Obtain a reference to a persistent object with the same identity as the given detached instance, without actually loading its state from the database</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>refresh(Object)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Refresh the persistent state of an object using a new SQL <code>select</code> to retrieve its current state from the database</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>refresh(Object,LockModeType)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Refresh the persistent state of an object using a new SQL <code>select</code> to retrieve its current state from the database, requesting the given <a href="#optimistic-and-pessimistic-locking">optimistic or pessimistic lock mode</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>lock(Object, LockModeType)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Obtain an <a href="#optimistic-and-pessimistic-locking">optimistic or pessimistic lock</a> on a persistent object</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Any of these operations might throw an exception.
Now, if an exception occurs while interacting with the database, there&#8217;s no good way to resynchronize the state of the current persistence context with the state held in database tables.</p>
</div>
<div class="paragraph">
<p>Therefore, a session is considered to be unusable after any of its methods throws an exception.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The persistence context is fragile.
If you receive an exception from Hibernate, you should immediately close and discard the current session. Open a new session if you need to, but throw the bad one away first.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Each of the operations we&#8217;ve seen so far affects a single entity instance passed as an argument.
But there&#8217;s a way to set things up so that an operation will propagate to associated entities.</p>
</div>
</div>
<div class="sect2">
<h3 id="cascade">5.5. Cascading persistence operations</h3>
<div class="paragraph">
<p>It&#8217;s quite often the case that the lifecycle of a <em>child</em> entity is completely dependent on the lifecycle of some <em>parent</em>.
This is especially common for many-to-one and one-to-one associations, though it&#8217;s very rare for many-to-many associations.</p>
</div>
<div class="paragraph">
<p>For example, it&#8217;s quite common to make an <code>Order</code> and all its <code>Item</code>s persistent in the same transaction, or to delete a <code>Project</code> and its <code>Files</code>s at once.
This sort of relationship is sometimes called a <em>whole/part</em>-type relationship.</p>
</div>
<div class="paragraph">
<p><em>Cascading</em> is a convenience which allows us to propagate one of the operations listed in <a href="#persistence-operations">Operations on the persistence context</a> from a parent to its children.
To set up cascading, we specify the <code>cascade</code> member of one of the association mapping annotations, usually <code>@OneToMany</code> or <code>@OneToOne</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Entity</span>
<span class="kd">class</span> <span class="nc">Order</span> <span class="o">{</span>
    <span class="o">...</span>
    <span class="nd">@OneToMany</span><span class="o">(</span><span class="n">mappedby</span><span class="o">=</span><span class="n">Item_</span><span class="o">.</span><span class="na">ORDER</span><span class="o">,</span>
               <span class="c1">// cascade persist(), remove(), and refresh() from Order to Item</span>
               <span class="n">cascade</span><span class="o">={</span><span class="no">PERSIST</span><span class="o">,</span><span class="no">REMOVE</span><span class="o">,</span><span class="no">REFRESH</span><span class="o">},</span>
               <span class="c1">// also remove() orphaned Items</span>
               <span class="n">orphanRemoval</span><span class="o">=</span><span class="kc">true</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">Item</span><span class="o">&gt;</span> <span class="n">items</span><span class="o">;</span>
    <span class="o">...</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Orphan removal</em> indicates that an <code>Item</code> should be automatically deleted if it is removed from the set of items belonging to its parent <code>Order</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="proxies-and-lazy-fetching">5.6. Proxies and lazy fetching</h3>
<div class="paragraph">
<p>Our data model is a set of interconnected entities, and in Java our whole dataset would be represented as an enormous interconnected graph of objects.
It&#8217;s possible that this graph is disconnected, but more likely it&#8217;s connected, or composed of a relatively small number of connected subgraphs.</p>
</div>
<div class="paragraph">
<p>Therefore, when we retrieve on object belonging to this graph from the database and instantiate it in memory, we simply can&#8217;t recursively retrieve and instantiate all its associated entities.
Quite aside from the waste of memory on the VM side, this process would involve a huge number of round trips to the database server, or a massive multidimensional cartesian product of tables, or both.
Instead, we&#8217;re forced to cut the graph somewhere.</p>
</div>
<div class="paragraph">
<p>Hibernate solves this problem using <em>proxies</em> and <em>lazy fetching</em>.
A proxy is an object that masquerades as a real entity or collection, but doesn&#8217;t actually hold any state, because that state has not yet been fetched from the database.
When you call a method of the proxy, Hibernate will detect the call and fetch the state from the database before allowing the invocation to proceed to the real entity object or collection.</p>
</div>
<div class="paragraph">
<p>Now for the gotchas:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Hibernate will only do this for an entity which is currently associated with a persistence context.
Once the session ends, and the persistence context is cleaned up, the proxy is no longer fetchable, and instead its methods throw the hated <code>LazyInitializationException</code>.</p>
</li>
<li>
<p>A round trip to the database to fetch the state of a single entity instance is just about <em>the least efficient</em> way to access data.
It almost inevitably leads to the infamous <em>N+1 selects</em> problem we&#8217;ll discuss later when we talk about how to <a href="#association-fetching">optimize association fetching</a>.</p>
</li>
</ol>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>We&#8217;re getting a bit ahead of ourselves here, but let&#8217;s quickly mention the general strategy we recommend to navigate past these gotchas:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>All associations should be set <code>fetch=LAZY</code> to avoid fetching extra data when it&#8217;s not needed.
As we mentioned <a href="#lazy-problem">earlier</a>, this setting is not the default for <code>@ManyToOne</code> associations, and must be specified explicitly.</p>
</li>
<li>
<p>But strive to avoid writing code which triggers lazy fetching.
Instead, fetch all the data you&#8217;ll need upfront at the beginning of a unit of work, using one of the techniques described in <a href="#association-fetching">Association fetching</a>, usually, using <em>join fetch</em> in HQL or an <code>EntityGraph</code>.</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>It&#8217;s important to know that some operations which may be performed with an unfetched proxy <em>don&#8217;t</em> require fetching its state from the database.
First, we&#8217;re always allowed to obtain its identifier:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kt">var</span> <span class="n">pubId</span> <span class="o">=</span> <span class="n">entityManager</span><span class="o">.</span><span class="na">find</span><span class="o">(</span><span class="nc">Book</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">bookId</span><span class="o">).</span><span class="na">getPublisher</span><span class="o">().</span><span class="na">getId</span><span class="o">();</span> <span class="c1">// does not fetch publisher</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Second, we may create an association to a proxy:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="n">book</span><span class="o">.</span><span class="na">setPublisher</span><span class="o">(</span><span class="n">entityManager</span><span class="o">.</span><span class="na">getReference</span><span class="o">(</span><span class="nc">Publisher</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">pubId</span><span class="o">));</span> <span class="c1">// does not fetch publisher</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Sometimes it&#8217;s useful to test whether a proxy or collection has been fetched from the database.
JPA lets us do this using the <code>PersistenceUnitUtil</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kt">boolean</span> <span class="n">authorsFetched</span> <span class="o">=</span> <span class="n">entityManagerFactory</span><span class="o">.</span><span class="na">getPersistenceUnitUtil</span><span class="o">().</span><span class="na">isLoaded</span><span class="o">(</span><span class="n">book</span><span class="o">.</span><span class="na">getAuthors</span><span class="o">());</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Hibernate has a slightly easier way to do it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kt">boolean</span> <span class="n">authorsFetched</span> <span class="o">=</span> <span class="nc">Hibernate</span><span class="o">.</span><span class="na">isInitialized</span><span class="o">(</span><span class="n">book</span><span class="o">.</span><span class="na">getAuthors</span><span class="o">());</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>But the static methods of the <a href="https://docs.jboss.org/hibernate/orm/6.3/javadocs/org/hibernate/Hibernate.html"><code>Hibernate</code></a> class let us do a lot more, and it&#8217;s worth getting a bit familiar them.</p>
</div>
<div class="paragraph">
<p>Of particular interest are the operations which let us work with unfetched collections without fetching their state from the database.
For example, consider this code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nc">Book</span> <span class="n">book</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">find</span><span class="o">(</span><span class="nc">Book</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">bookId</span><span class="o">);</span>  <span class="c1">// fetch just the Book, leaving authors unfetched</span>
<span class="nc">Author</span> <span class="n">authorRef</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">getReference</span><span class="o">(</span><span class="nc">Author</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">authorId</span><span class="o">);</span>  <span class="c1">// obtain an unfetched proxy</span>
<span class="kt">boolean</span> <span class="n">isByAuthor</span> <span class="o">=</span> <span class="nc">Hibernate</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">book</span><span class="o">.</span><span class="na">getAuthors</span><span class="o">(),</span> <span class="n">authorRef</span><span class="o">);</span> <span class="c1">// no fetching</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This code fragment leaves both the set <code>book.authors</code> and the proxy <code>authorRef</code> unfetched.</p>
</div>
<div class="paragraph">
<p>Finally, <code>Hibernate.initialize()</code> is a convenience method that force-fetches a proxy or collection:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nc">Book</span> <span class="n">book</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">find</span><span class="o">(</span><span class="nc">Book</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">bookId</span><span class="o">);</span>  <span class="c1">// fetch just the Book, leaving authors unfetched</span>
<span class="nc">Hibernate</span><span class="o">.</span><span class="na">initialize</span><span class="o">(</span><span class="n">book</span><span class="o">.</span><span class="na">getAuthors</span><span class="o">());</span>  <span class="c1">// fetch the Authors</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>But of course, this code is very inefficient, requiring two trips to the database to obtain data that could in principle be retrieved with just one query.</p>
</div>
<div class="paragraph">
<p>It&#8217;s clear from the discussion above that we need a way to request that an association be <em>eagerly</em> fetched using a database <code>join</code>, thus protecting ourselves from the infamous N+1 selects.
One way to do this is by passing an <code>EntityGraph</code> to <code>find()</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="entity-graph">5.7. Entity graphs and eager fetching</h3>
<div class="paragraph">
<p>When an association is mapped <code>fetch=LAZY</code>, it won&#8217;t, by default, be fetched when we call the <code>find()</code> method.
We may request that an association be fetched eagerly (immediately) by passing an <code>EntityGraph</code> to <code>find()</code>.</p>
</div>
<div class="paragraph">
<p>The JPA-standard API for this is a bit unwieldy:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kt">var</span> <span class="n">graph</span> <span class="o">=</span> <span class="n">entityManager</span><span class="o">.</span><span class="na">createEntityGraph</span><span class="o">(</span><span class="nc">Book</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="n">graph</span><span class="o">.</span><span class="na">addSubgraph</span><span class="o">(</span><span class="n">Book_</span><span class="o">.</span><span class="na">publisher</span><span class="o">);</span>
<span class="nc">Book</span> <span class="n">book</span> <span class="o">=</span> <span class="n">entityManager</span><span class="o">.</span><span class="na">find</span><span class="o">(</span><span class="nc">Book</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">bookId</span><span class="o">,</span> <span class="nc">Map</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="nc">SpecHints</span><span class="o">.</span><span class="na">HINT_SPEC_FETCH_GRAPH</span><span class="o">,</span> <span class="n">graph</span><span class="o">));</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This is untypesafe and unnecessarily verbose.
Hibernate has a better way:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kt">var</span> <span class="n">graph</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">createEntityGraph</span><span class="o">(</span><span class="nc">Book</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="n">graph</span><span class="o">.</span><span class="na">addSubgraph</span><span class="o">(</span><span class="n">Book_</span><span class="o">.</span><span class="na">publisher</span><span class="o">);</span>
<span class="nc">Book</span> <span class="n">book</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">byId</span><span class="o">(</span><span class="nc">Book</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">withFetchGraph</span><span class="o">(</span><span class="n">graph</span><span class="o">).</span><span class="na">load</span><span class="o">(</span><span class="n">bookId</span><span class="o">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This code adds a <code>left outer join</code> to our SQL query, fetching the associated <code>Publisher</code> along with the <code>Book</code>.</p>
</div>
<div class="paragraph">
<p>We may even attach additional nodes to our <code>EntityGraph</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kt">var</span> <span class="n">graph</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">createEntityGraph</span><span class="o">(</span><span class="nc">Book</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="n">graph</span><span class="o">.</span><span class="na">addSubgraph</span><span class="o">(</span><span class="n">Book_</span><span class="o">.</span><span class="na">publisher</span><span class="o">);</span>
<span class="n">graph</span><span class="o">.</span><span class="na">addPluralSubgraph</span><span class="o">(</span><span class="n">Book_</span><span class="o">.</span><span class="na">authors</span><span class="o">).</span><span class="na">addSubgraph</span><span class="o">(</span><span class="n">Author_</span><span class="o">.</span><span class="na">person</span><span class="o">);</span>
<span class="nc">Book</span> <span class="n">book</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">byId</span><span class="o">(</span><span class="nc">Book</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">withFetchGraph</span><span class="o">(</span><span class="n">graph</span><span class="o">).</span><span class="na">load</span><span class="o">(</span><span class="n">bookId</span><span class="o">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This results in a SQL query with <em>four</em> <code>left outer join</code>s.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>In the code examples above, The classes <code>Book_</code> and <code>Author_</code> are generated by the <a href="#metamodel-generator">JPA Metamodel Generator</a> we saw earlier.
They let us refer to attributes of our model in a completely type-safe way.
We&#8217;ll use them again, below, when we talk about <a href="#criteria-queries">Criteria queries</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>JPA specifies that any given <code>EntityGraph</code> may be interpreted in two different ways.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A <em>fetch graph</em> specifies exactly the associations that should be eagerly loaded.
Any association not belonging to the entity graph is proxied and loaded lazily only if required.</p>
</li>
<li>
<p>A <em>load graph</em> specifies that the associations in the entity graph are to be fetched in addition to the associations mapped <code>fetch=EAGER</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You&#8217;re right, the names make no sense.
But don&#8217;t worry, if you take our advice, and map your associations <code>fetch=LAZY</code>, there&#8217;s no difference between a "fetch" graph and a "load" graph, so the names don&#8217;t matter.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>JPA even specifies a way to define named entity graphs using annotations.
But the annotation-based API is so verbose that it&#8217;s just not worth using.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="flush">5.8. Flushing the session</h3>
<div class="paragraph">
<p>From time to time, a <em>flush</em> operation is triggered, and the session synchronizes dirty state held in memory—that is, modifications to the state of entities associated with the persistence context—with persistent state held in the database. Of course, it does this by executing SQL <code>INSERT</code>, <code>UPDATE</code>, and <code>DELETE</code> statements.</p>
</div>
<div class="paragraph">
<p>By default, a flush is triggered:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>when the current transaction commits, for example, when <code>Transaction.commit()</code> is called,</p>
</li>
<li>
<p>before execution of a query whose result would be affected by the synchronization of dirty state held in memory, or</p>
</li>
<li>
<p>when the program directly calls <code>flush()</code>.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Notice that SQL statements are not usually executed synchronously by methods of the <code>Session</code> interface like <code>persist()</code> and <code>remove()</code>. If synchronous execution of SQL is desired, the <code>StatelessSession</code> allows this.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This behavior can be controlled by explicitly setting the flush mode.
For example, to disable flushes that occur before query execution, call:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="n">entityManager</span><span class="o">.</span><span class="na">setFlushMode</span><span class="o">(</span><span class="nc">FlushModeType</span><span class="o">.</span><span class="na">COMMIT</span><span class="o">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Hibernate allows greater control over the flush mode than JPA:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="n">session</span><span class="o">.</span><span class="na">setHibernateFlushMode</span><span class="o">(</span><span class="nc">FlushMode</span><span class="o">.</span><span class="na">MANUAL</span><span class="o">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Since flushing is a somewhat expensive operation (the session must dirty-check every entity in the persistence context), setting the flush mode to <code>COMMIT</code> can occasionally be a useful optimization.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 35. Flush modes</caption>
<colgroup>
<col style="width: 15%;">
<col style="width: 15%;">
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Hibernate <code>FlushMode</code></th>
<th class="tableblock halign-left valign-top">JPA <code>FlushModeType</code></th>
<th class="tableblock halign-left valign-top">Interpretation</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>MANUAL</code></p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Never flush automatically</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>COMMIT</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>COMMIT</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Flush before transaction commit</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>AUTO</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>AUTO</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Flush before transaction commit, and before execution of a query whose results might be affected by modifications held in memory</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ALWAYS</code></p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Flush before transaction commit, and before execution of every query</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>A second way to reduce the cost of flushing is to load entities in <em>read-only</em> mode:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>Session.setDefaultReadOnly(false)</code> specifies that all entities loaded by a given session should be loaded in read-only mode by default,</p>
</li>
<li>
<p><code>SelectionQuery.setReadOnly(false)</code> specifies that every entity returned by a given query should be loaded in read-only mode, and</p>
</li>
<li>
<p><code>Session.setReadOnly(Object, false)</code> specifies that a given entity already loaded by the session should be switched to read-only mode.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>It&#8217;s not necessary to dirty-check an entity instance in read-only mode.</p>
</div>
</div>
<div class="sect2">
<h3 id="queries">5.9. Queries</h3>
<div class="paragraph">
<p>Hibernate features three complementary ways to write queries:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the <em>Hibernate Query Language</em>, an extremely powerful superset of JPQL, which abstracts most of the features of modern dialects of SQL,</p>
</li>
<li>
<p>the JPA <em>criteria query</em> API, along with extensions, allowing almost any HQL query to be constructed programmatically via a typesafe API, and, of course</p>
</li>
<li>
<p>for when all else fails, <em>native SQL</em> queries.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="hql-queries">5.10. HQL queries</h3>
<div class="paragraph">
<p>A full discussion of the query language would require almost as much text as the rest of this Introduction.
Fortunately, HQL is already described in exhaustive (and exhausting) detail in <a href="https://docs.jboss.org/hibernate/orm/6.3/querylanguage/html_single/Hibernate_Query_Language.html"><em>A Guide to Hibernate Query Language</em></a>.
It doesn&#8217;t make sense to repeat that information here.</p>
</div>
<div class="paragraph">
<p>Here we want to see how to execute a query via the <code>Session</code> or <code>EntityManager</code> API.
The method we call depends on what kind of query it is:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>selection queries</em> return a result list, but do not modify the data, but</p>
</li>
<li>
<p><em>mutation queries</em> modify data, and return the number of modified rows.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Selection queries usually start with the keyword <code>select</code> or <code>from</code>, whereas mutation queries begin with the keyword <code>insert</code>, <code>update</code>, or <code>delete</code>.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 36. Executing HQL</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 36%;">
<col style="width: 32%;">
<col style="width: 22%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Kind</th>
<th class="tableblock halign-left valign-top"><code>Session</code> method</th>
<th class="tableblock halign-left valign-top"><code>EntityManager</code> method</th>
<th class="tableblock halign-left valign-top"><code>Query</code> execution method</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Selection</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>createSelectionQuery(String,Class)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>createQuery(String,Class)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>getResultList()</code>, <code>getSingleResult()</code>, or <code>getSingleResultOrNull()</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Mutation</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>createMutationQuery(String)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>createQuery(String)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>executeUpdate()</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>So for the <code>Session</code> API we would write:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nc">List</span><span class="o">&lt;</span><span class="nc">Book</span><span class="o">&gt;</span> <span class="n">matchingBooks</span> <span class="o">=</span>
        <span class="n">session</span><span class="o">.</span><span class="na">createSelectionQuery</span><span class="o">(</span><span class="s">"from Book where title like :titleSearchPattern"</span><span class="o">,</span> <span class="nc">Book</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
            <span class="o">.</span><span class="na">setParameter</span><span class="o">(</span><span class="s">"titleSearchPattern"</span><span class="o">,</span> <span class="n">titleSearchPattern</span><span class="o">)</span>
            <span class="o">.</span><span class="na">getResultList</span><span class="o">();</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Or, if we&#8217;re sticking to the JPA-standard APIs:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nc">List</span><span class="o">&lt;</span><span class="nc">Book</span><span class="o">&gt;</span> <span class="n">matchingBooks</span> <span class="o">=</span>
        <span class="n">entityManager</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="s">"select b from Book b where b.title like :titleSearchPattern"</span><span class="o">,</span> <span class="nc">Book</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
            <span class="o">.</span><span class="na">setParameter</span><span class="o">(</span><span class="s">"titleSearchPattern"</span><span class="o">,</span> <span class="n">titleSearchPattern</span><span class="o">)</span>
            <span class="o">.</span><span class="na">getResultList</span><span class="o">();</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The only difference between <code>createSelectionQuery()</code> and <code>createQuery()</code> is that <code>createSelectionQuery()</code> throws an exception if passed an <code>insert</code>, <code>delete</code>, or <code>update</code>.</p>
</div>
<div class="paragraph">
<p>In the query above, <code>:titleSearchPattern</code> is called a <em>named parameter</em>.
We may also identify parameters by a number.
These are called <em>ordinal parameters</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nc">List</span><span class="o">&lt;</span><span class="nc">Book</span><span class="o">&gt;</span> <span class="n">matchingBooks</span> <span class="o">=</span>
        <span class="n">session</span><span class="o">.</span><span class="na">createSelectionQuery</span><span class="o">(</span><span class="s">"from Book where title like ?1"</span><span class="o">,</span> <span class="nc">Book</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
            <span class="o">.</span><span class="na">setParameter</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">titleSearchPattern</span><span class="o">)</span>
            <span class="o">.</span><span class="na">getResultList</span><span class="o">();</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>When a query has multiple parameters, named parameters tend to be easier to read, even if slightly more verbose.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p><em>Never</em> concatenate user input with HQL and pass the concatenated string to <code>createSelectionQuery()</code>.
This would open up the possibility for an attacker to execute arbitrary code on your database server.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If we&#8217;re expecting a query to return a single result, we can use <code>getSingleResult()</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nc">Book</span> <span class="n">book</span> <span class="o">=</span>
        <span class="n">session</span><span class="o">.</span><span class="na">createSelectionQuery</span><span class="o">(</span><span class="s">"from Book where isbn = ?1"</span><span class="o">,</span> <span class="nc">Book</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
            <span class="o">.</span><span class="na">setParameter</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">isbn</span><span class="o">)</span>
            <span class="o">.</span><span class="na">getSingleResult</span><span class="o">();</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Or, if we&#8217;re expecting it to return at most one result, we can use <code>getSingleResultOrNull()</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nc">Book</span> <span class="n">bookOrNull</span> <span class="o">=</span>
        <span class="n">session</span><span class="o">.</span><span class="na">createSelectionQuery</span><span class="o">(</span><span class="s">"from Book where isbn = ?1"</span><span class="o">,</span> <span class="nc">Book</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
            <span class="o">.</span><span class="na">setParameter</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">isbn</span><span class="o">)</span>
            <span class="o">.</span><span class="na">getSingleResultOrNull</span><span class="o">();</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The difference, of course, is that <code>getSingleResult()</code> throws an exception if there&#8217;s no matching row in the database, whereas <code>getSingleResultOrNull()</code> just returns <code>null</code>.</p>
</div>
<div class="paragraph">
<p>By default, Hibernate dirty checks entities in the persistence context before executing a query, in order to determine if the session should be flushed.
If there are many entities association with the persistence context, then this can be an expensive operation.</p>
</div>
<div class="paragraph">
<p>To disable this behavior, set the flush mode to <code>COMMIT</code> or <code>MANUAL</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nc">Book</span> <span class="n">bookOrNull</span> <span class="o">=</span>
        <span class="n">session</span><span class="o">.</span><span class="na">createSelectionQuery</span><span class="o">(</span><span class="s">"from Book where isbn = ?1"</span><span class="o">,</span> <span class="nc">Book</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
            <span class="o">.</span><span class="na">setParameter</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">isbn</span><span class="o">)</span>
            <span class="o">.</span><span class="na">setHibernateFlushMode</span><span class="o">(</span><span class="no">MANUAL</span><span class="o">)</span>
            <span class="o">.</span><span class="na">getSingleResult</span><span class="o">();</span></code></pre>
</div>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Setting the flush mode to <code>COMMIT</code> or <code>MANUAL</code> might cause the query to return stale results.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Occasionally we need to build a query at runtime, from a set of optional conditions.
For this, JPA offers an API which allows programmatic construction of a query.</p>
</div>
</div>
<div class="sect2">
<h3 id="criteria-queries">5.11. Criteria queries</h3>
<div class="paragraph">
<p>Imagine we&#8217;re implementing some sort of search screen, where the user of our system is offered several different ways to constrain the query result set.
For example, we might let them search for books by title and/or the author name.
Of course, we could construct a HQL query by string concatenation, but this is a bit fragile, so it&#8217;s quite nice to have an alternative.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">HQL is implemented in terms of criteria objects</div>
<div class="paragraph">
<p>Actually, in Hibernate 6, every HQL query is compiled to a criteria query before being translated to SQL.
This ensures that the semantics of HQL and criteria queries are identical.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>First we need an object for building criteria queries.
Using the JPA-standard APIs, this would be a <code>CriteriaBuilder</code>, and we get it from the <code>EntityManagerFactory</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nc">CriteriaBuilder</span> <span class="n">builder</span> <span class="o">=</span> <span class="n">entityManagerFactory</span><span class="o">.</span><span class="na">getCriteriaBuilder</span><span class="o">();</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>But if we have a <code>SessionFactory</code>, we get something much better, a <a href="https://docs.jboss.org/hibernate/orm/6.3/javadocs/org/hibernate/query/criteria/HibernateCriteriaBuilder.html"><code>HibernateCriteriaBuilder</code></a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nc">HibernateCriteriaBuilder</span> <span class="n">builder</span> <span class="o">=</span> <span class="n">sessionFactory</span><span class="o">.</span><span class="na">getCriteriaBuilder</span><span class="o">();</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>HibernateCriteriaBuilder</code> extends <code>CriteriaBuilder</code> and adds many operations that JPQL doesn&#8217;t have.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you&#8217;re using <code>EntityManagerFactory</code>, don&#8217;t despair, you have two perfectly good ways to obtain the <code>HibernateCriteriaBuilder</code> associated with that factory.
Either:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nc">HibernateCriteriaBuilder</span> <span class="n">builder</span> <span class="o">=</span>
        <span class="n">entityManagerFactory</span><span class="o">.</span><span class="na">unwrap</span><span class="o">(</span><span class="nc">SessionFactory</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">getCriteriaBuilder</span><span class="o">();</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Or simply:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nc">HibernateCriteriaBuilder</span> <span class="n">builder</span> <span class="o">=</span>
        <span class="o">(</span><span class="nc">HibernateCriteriaBuilder</span><span class="o">)</span> <span class="n">entityManagerFactory</span><span class="o">.</span><span class="na">getCriteriaBuilder</span><span class="o">();</span></code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We&#8217;re ready to create a criteria query.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nc">CriteriaQuery</span><span class="o">&lt;</span><span class="nc">Book</span><span class="o">&gt;</span> <span class="n">query</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="nc">Book</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="nc">Root</span><span class="o">&lt;</span><span class="nc">Book</span><span class="o">&gt;</span> <span class="n">book</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="nc">Book</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="nc">Predicate</span> <span class="n">where</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">conjunction</span><span class="o">();</span>
<span class="k">if</span> <span class="o">(</span><span class="n">titlePattern</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">where</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">and</span><span class="o">(</span><span class="n">where</span><span class="o">,</span> <span class="n">builder</span><span class="o">.</span><span class="na">like</span><span class="o">(</span><span class="n">book</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">Book_</span><span class="o">.</span><span class="na">title</span><span class="o">),</span> <span class="n">titlePattern</span><span class="o">));</span>
<span class="o">}</span>
<span class="k">if</span> <span class="o">(</span><span class="n">namePattern</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Join</span><span class="o">&lt;</span><span class="nc">Book</span><span class="o">,</span><span class="nc">Author</span><span class="o">&gt;</span> <span class="n">author</span> <span class="o">=</span> <span class="n">book</span><span class="o">.</span><span class="na">join</span><span class="o">(</span><span class="n">Book_</span><span class="o">.</span><span class="na">author</span><span class="o">);</span>
    <span class="n">where</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">and</span><span class="o">(</span><span class="n">where</span><span class="o">,</span> <span class="n">builder</span><span class="o">.</span><span class="na">like</span><span class="o">(</span><span class="n">author</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">Author_</span><span class="o">.</span><span class="na">name</span><span class="o">),</span> <span class="n">namePattern</span><span class="o">));</span>
<span class="o">}</span>
<span class="n">query</span><span class="o">.</span><span class="na">select</span><span class="o">(</span><span class="n">book</span><span class="o">).</span><span class="na">where</span><span class="o">(</span><span class="n">where</span><span class="o">)</span>
    <span class="o">.</span><span class="na">orderBy</span><span class="o">(</span><span class="n">builder</span><span class="o">.</span><span class="na">asc</span><span class="o">(</span><span class="n">book</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">Book_</span><span class="o">.</span><span class="na">title</span><span class="o">)));</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here, as before, the classes <code>Book_</code> and <code>Author_</code> are generated by Hibernate&#8217;s <a href="#metamodel-generator">JPA Metamodel Generator</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Notice that we didn&#8217;t bother treating <code>titlePattern</code> and <code>namePattern</code> as parameters.
That&#8217;s safe because, by default, Hibernate automatically and transparently treats strings passed to the <code>CriteriaBuilder</code> as JDBC parameters.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Execution of a criteria query works almost exactly like execution of HQL.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 37. Executing criteria queries</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 36%;">
<col style="width: 32%;">
<col style="width: 22%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Kind</th>
<th class="tableblock halign-left valign-top"><code>Session</code> method</th>
<th class="tableblock halign-left valign-top"><code>EntityManager</code> method</th>
<th class="tableblock halign-left valign-top"><code>Query</code> execution method</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Selection</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>createSelectionQuery(CriteriaQuery)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>createQuery(CriteriaQuery)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>getResultList()</code>, <code>getSingleResult()</code>, or <code>getSingleResultOrNull()</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Mutation</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>createMutationQuery(CriteriaUpdate)</code> or <code>createQuery(CriteriaDelete)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>createQuery(CriteriaUpdate)</code> or <code>createQuery(CriteriaDelte)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>executeUpdate()</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nc">List</span><span class="o">&lt;</span><span class="nc">Book</span><span class="o">&gt;</span> <span class="n">matchingBooks</span> <span class="o">=</span>
        <span class="n">session</span><span class="o">.</span><span class="na">createSelectionQuery</span><span class="o">(</span><span class="n">query</span><span class="o">)</span>
            <span class="o">.</span><span class="na">getResultList</span><span class="o">();</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Update, insert, and delete queries work similarly:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nc">CriteriaDelete</span><span class="o">&lt;</span><span class="nc">Book</span><span class="o">&gt;</span> <span class="n">delete</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">createCriteriaDelete</span><span class="o">(</span><span class="nc">Book</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="nc">Root</span><span class="o">&lt;</span><span class="nc">Book</span><span class="o">&gt;</span> <span class="n">book</span> <span class="o">=</span> <span class="n">delete</span><span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="nc">Book</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="n">delete</span><span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="n">builder</span><span class="o">.</span><span class="na">lt</span><span class="o">(</span><span class="n">builder</span><span class="o">.</span><span class="na">year</span><span class="o">(</span><span class="n">book</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">Book_</span><span class="o">.</span><span class="na">publicationDate</span><span class="o">)),</span> <span class="mi">2000</span><span class="o">));</span>
<span class="n">session</span><span class="o">.</span><span class="na">createMutationQuery</span><span class="o">(</span><span class="n">delete</span><span class="o">).</span><span class="na">executeUpdate</span><span class="o">();</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>It&#8217;s even possible to transform a HQL query string to a criteria query, and modify the query programmatically before execution:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nc">HibernateCriteriaBuilder</span> <span class="n">builder</span> <span class="o">=</span> <span class="n">sessionFactory</span><span class="o">.</span><span class="na">getCriteriaBuilder</span><span class="o">();</span>
<span class="kt">var</span> <span class="n">query</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="s">"from Book where year(publicationDate) &gt; 2000"</span><span class="o">,</span> <span class="nc">Book</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="kt">var</span> <span class="n">root</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Root</span><span class="o">&lt;</span><span class="nc">Book</span><span class="o">&gt;)</span> <span class="n">query</span><span class="o">.</span><span class="na">getRootList</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
<span class="n">query</span><span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="n">builder</span><span class="o">.</span><span class="na">like</span><span class="o">(</span><span class="n">root</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">Book_</span><span class="o">.</span><span class="na">title</span><span class="o">),</span> <span class="n">builder</span><span class="o">.</span><span class="na">literal</span><span class="o">(</span><span class="s">"Hibernate%"</span><span class="o">)));</span>
<span class="n">query</span><span class="o">.</span><span class="na">orderBy</span><span class="o">(</span><span class="n">builder</span><span class="o">.</span><span class="na">asc</span><span class="o">(</span><span class="n">root</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">Book_</span><span class="o">.</span><span class="na">title</span><span class="o">)),</span> <span class="n">builder</span><span class="o">.</span><span class="na">desc</span><span class="o">(</span><span class="n">root</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">Book_</span><span class="o">.</span><span class="na">isbn</span><span class="o">)));</span>
<span class="nc">List</span><span class="o">&lt;</span><span class="nc">Book</span><span class="o">&gt;</span> <span class="n">matchingBooks</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">createSelectionQuery</span><span class="o">(</span><span class="n">query</span><span class="o">).</span><span class="na">getResultList</span><span class="o">();</span></code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Do you find some of the code above a bit too verbose?
We do.</p>
</div>
</div>
<div class="sect2">
<h3 id="criteria-definition">5.12. A more comfortable way to write criteria queries</h3>
<div class="paragraph">
<p>Actually, what makes the JPA criteria API less ergonomic than it should be is the need to call all operations of the <code>CriteriaBuilder</code> as instance methods, instead of having them as <code>static</code> functions.
The reason it works this way is that each JPA provider has its own implementation of <code>CriteriaBuilder</code>.</p>
</div>
<div class="paragraph">
<p>Hibernate 6.3 introduces the helper class <a href="https://docs.jboss.org/hibernate/orm/6.3/javadocs/org/hibernate/query/criteria/CriteriaDefinition.html"><code>CriteriaDefinition</code></a> to reduce the verbosity of criteria queries.
Our example looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nc">CriteriaQuery</span><span class="o">&lt;</span><span class="nc">Book</span><span class="o">&gt;</span> <span class="n">query</span> <span class="o">=</span>
        <span class="k">new</span> <span class="nf">CriteriaDefinition</span><span class="o">(</span><span class="n">entityManagerFactory</span><span class="o">,</span> <span class="nc">Book</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">{{</span>
            <span class="n">select</span><span class="o">(</span><span class="n">book</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">titlePattern</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">restrict</span><span class="o">(</span><span class="n">like</span><span class="o">(</span><span class="n">book</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">Book_</span><span class="o">.</span><span class="na">title</span><span class="o">),</span> <span class="n">titlePattern</span><span class="o">));</span>
            <span class="o">}</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">namePattern</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="kt">var</span> <span class="n">author</span> <span class="o">=</span> <span class="n">book</span><span class="o">.</span><span class="na">join</span><span class="o">(</span><span class="n">Book_</span><span class="o">.</span><span class="na">author</span><span class="o">);</span>
                <span class="n">restrict</span><span class="o">(</span><span class="n">like</span><span class="o">(</span><span class="n">author</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">Author_</span><span class="o">.</span><span class="na">name</span><span class="o">),</span> <span class="n">namePattern</span><span class="o">));</span>
            <span class="o">}</span>
            <span class="n">orderBy</span><span class="o">(</span><span class="n">asc</span><span class="o">(</span><span class="n">book</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">Book_</span><span class="o">.</span><span class="na">title</span><span class="o">)));</span>
        <span class="o">}};</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>When all else fails, and sometimes even before that, we&#8217;re left with the option of writing a query in SQL.</p>
</div>
</div>
<div class="sect2">
<h3 id="native-queries">5.13. Native SQL queries</h3>
<div class="paragraph">
<p>HQL is a powerful language which helps reduce the verbosity of SQL, and significantly increases portability of queries between databases.
But ultimately, the true value of ORM is not in avoiding SQL, but in alleviating the pain involved in dealing with SQL result sets once we get them back to our Java program.
As we said <a href="#introduction">right up front</a>, Hibernate&#8217;s generated SQL is meant to be used in conjunction with handwritten SQL, and native SQL queries are one of the facilities we provide to make that easy.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 38. Executing SQL</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 36%;">
<col style="width: 32%;">
<col style="width: 22%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Kind</th>
<th class="tableblock halign-left valign-top"><code>Session</code> method</th>
<th class="tableblock halign-left valign-top"><code>EntityManager</code> method</th>
<th class="tableblock halign-left valign-top"><code>Query</code> execution method</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Selection</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>createNativeQuery(String,Class)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>createNativeQuery(String,Class)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>getResultList()</code>, <code>getSingleResult()</code>, or <code>getSingleResultOrNull()</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Mutation</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>createNativeMutationQuery(String)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>createNativeQuery(String)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>executeUpdate()</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Stored procedure</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>createStoredProcedureCall(String)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>createStoredProcedureQuery(String)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>execute()</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>For the most simple cases, Hibernate can infer the shape of the result set:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nc">Book</span> <span class="n">book</span> <span class="o">=</span>
        <span class="n">session</span><span class="o">.</span><span class="na">createNativeQuery</span><span class="o">(</span><span class="s">"select * from Books where isbn = ?1"</span><span class="o">,</span> <span class="nc">Book</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
            <span class="o">.</span><span class="na">getSingleResult</span><span class="o">();</span>

<span class="nc">String</span> <span class="n">title</span> <span class="o">=</span>
        <span class="n">session</span><span class="o">.</span><span class="na">createNativeQuery</span><span class="o">(</span><span class="s">"select title from Books where isbn = ?1"</span><span class="o">,</span> <span class="nc">String</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
            <span class="o">.</span><span class="na">getSingleResult</span><span class="o">();</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>However, in general, there isn&#8217;t enough information in the JDBC <code>ResultSetMetaData</code> to infer the mapping of columns to entity objects.
So for more complicated cases, you&#8217;ll need to use the <code>@SqlResultSetMapping</code> annotation to define a named mapping, and pass the name to <code>createNativeQuery()</code>. This gets fairly messy, so we don&#8217;t want to hurt your eyes by showing you an example of it.</p>
</div>
<div class="paragraph">
<p>By default, Hibernate doesn&#8217;t flush the session before execution of a native query.
That&#8217;s because the session is unaware of which modifications held in memory would affect the results of the query.</p>
</div>
<div class="paragraph">
<p>So if there are any unflushed changes to <code>Book</code>s, this query might return stale data:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nc">List</span><span class="o">&lt;</span><span class="nc">Book</span><span class="o">&gt;</span> <span class="n">books</span> <span class="o">=</span>
        <span class="n">session</span><span class="o">.</span><span class="na">createNativeQuery</span><span class="o">(</span><span class="s">"select * from Books"</span><span class="o">)</span>
            <span class="o">.</span><span class="na">getResultList</span><span class="o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>There&#8217;s two ways to ensure the persistence context is flushed before this query is executed.</p>
</div>
<div class="paragraph">
<p>Either, we could simply force a flush by calling <code>flush()</code> or by setting the flush mode to <code>ALWAYS</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nc">List</span><span class="o">&lt;</span><span class="nc">Book</span><span class="o">&gt;</span> <span class="n">books</span> <span class="o">=</span>
        <span class="n">session</span><span class="o">.</span><span class="na">createNativeQuery</span><span class="o">(</span><span class="s">"select * from Books"</span><span class="o">)</span>
            <span class="o">.</span><span class="na">setHibernateFlushMode</span><span class="o">(</span><span class="no">ALWAYS</span><span class="o">)</span>
            <span class="o">.</span><span class="na">getResultList</span><span class="o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Or, alternatively, we could tell Hibernate which modified state affects the results of the query:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nc">List</span><span class="o">&lt;</span><span class="nc">Book</span><span class="o">&gt;</span> <span class="n">books</span> <span class="o">=</span>
        <span class="n">session</span><span class="o">.</span><span class="na">createNativeQuery</span><span class="o">(</span><span class="s">"select * from Books"</span><span class="o">)</span>
            <span class="o">.</span><span class="na">addSynchronizedEntityClass</span><span class="o">(</span><span class="nc">Book</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
            <span class="o">.</span><span class="na">getResultList</span><span class="o">()</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>You can call stored procedures using <code>createStoredProcedureQuery()</code> or <code>createStoredProcedureCall()</code>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="pagination">5.14. Limits, pagination, and ordering</h3>
<div class="paragraph">
<p>If a query might return more results than we can handle at one time, we may specify:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>a <em>limit</em> on the maximum number of rows returned, and,</p>
</li>
<li>
<p>optionally, an <em>offset</em>, the first row of an ordered result set to return.</p>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The offset is used to paginate query results.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>There&#8217;s two ways to add a limit or offset to a HQL or native SQL query:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>using the syntax of the query language itself, for example, <code>offset 10 rows fetch next 20 rows only</code>, or</p>
</li>
<li>
<p>using the methods <code>setFirstResult()</code> and <code>setMaxResults()</code> of the <code>SelectionQuery</code> interface.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If the limit or offset is parameterized, the second option is simpler.
For example, this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nc">List</span><span class="o">&lt;</span><span class="nc">Book</span><span class="o">&gt;</span> <span class="n">books</span> <span class="o">=</span>
        <span class="n">session</span><span class="o">.</span><span class="na">createSelectionQuery</span><span class="o">(</span><span class="s">"from Book where title like ?1 order by title"</span><span class="o">)</span>
            <span class="o">.</span><span class="na">setParameter</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">titlePattern</span><span class="o">)</span>
            <span class="o">.</span><span class="na">setMaxResults</span><span class="o">(</span><span class="no">MAX_RESULTS</span><span class="o">)</span>
            <span class="o">.</span><span class="na">getResultList</span><span class="o">();</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>is simpler than:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nc">List</span><span class="o">&lt;</span><span class="nc">Book</span><span class="o">&gt;</span> <span class="n">books</span> <span class="o">=</span>
        <span class="n">session</span><span class="o">.</span><span class="na">createSelectionQuery</span><span class="o">(</span><span class="s">"from Book where title like ?1 order by title fetch first ?2 rows only"</span><span class="o">)</span>
            <span class="o">.</span><span class="na">setParameter</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">titlePattern</span><span class="o">)</span>
            <span class="o">.</span><span class="na">setParameter</span><span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="no">MAX_RESULTS</span><span class="o">)</span>
            <span class="o">.</span><span class="na">getResultList</span><span class="o">();</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Hibernate&#8217;s <code>SelectionQuery</code> has a slightly different way to paginate the query results:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nc">List</span><span class="o">&lt;</span><span class="nc">Book</span><span class="o">&gt;</span> <span class="n">books</span> <span class="o">=</span>
        <span class="n">session</span><span class="o">.</span><span class="na">createSelectionQuery</span><span class="o">(</span><span class="s">"from Book where title like ?1 order by title"</span><span class="o">)</span>
            <span class="o">.</span><span class="na">setParameter</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">titlePattern</span><span class="o">)</span>
            <span class="o">.</span><span class="na">setPage</span><span class="o">(</span><span class="nc">Page</span><span class="o">.</span><span class="na">first</span><span class="o">(</span><span class="no">MAX_RESULTS</span><span class="o">))</span>
            <span class="o">.</span><span class="na">getResultList</span><span class="o">();</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>A closely-related issue is ordering.
It&#8217;s quite common for pagination to be combined with the need to order query results by a field that&#8217;s determined at runtime.
So, as an alternative to the HQL <code>order by</code> clause, <code>SelectionQuery</code> offers the ability to specify that the query results should be ordered by one or more fields of the entity type returned by the query:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nc">List</span><span class="o">&lt;</span><span class="nc">Book</span><span class="o">&gt;</span> <span class="n">books</span> <span class="o">=</span>
        <span class="n">session</span><span class="o">.</span><span class="na">createSelectionQuery</span><span class="o">(</span><span class="s">"from Book where title like ?1"</span><span class="o">)</span>
            <span class="o">.</span><span class="na">setParameter</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">titlePattern</span><span class="o">)</span>
            <span class="o">.</span><span class="na">setOrder</span><span class="o">(</span><span class="nc">List</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="nc">Order</span><span class="o">.</span><span class="na">asc</span><span class="o">(</span><span class="nc">Book</span><span class="o">.</span><span class="na">_title</span><span class="o">),</span> <span class="nc">Order</span><span class="o">.</span><span class="na">asc</span><span class="o">(</span><span class="nc">Book</span><span class="o">.</span><span class="na">_isbn</span><span class="o">)))</span>
            <span class="o">.</span><span class="na">setMaxResults</span><span class="o">(</span><span class="no">MAX_RESULTS</span><span class="o">)</span>
            <span class="o">.</span><span class="na">getResultList</span><span class="o">();</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Unfortunately, there&#8217;s no way to do this using JPA&#8217;s <code>TypedQuery</code> interface.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 39. Methods for query limits, pagination, and ordering</caption>
<colgroup>
<col style="width: 30%;">
<col>
<col style="width: 15%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Method name</th>
<th class="tableblock halign-left valign-top">Purpose</th>
<th class="tableblock halign-center valign-top">JPA-standard</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>setMaxResults()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set a limit on the number of results returned by a query</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&#10004;</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>setFirstResult()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set an offset on the results returned by a query</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&#10004;</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>setPage()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set the limit and offset by specifying a <code>Page</code> object</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&#10006;</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>setOrder()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specify how the query results should be ordered</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&#10006;</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="projection-lists">5.15. Representing projection lists</h3>
<div class="paragraph">
<p>A <em>projection list</em> is the list of things that a query returns, that is, the list of expressions in the <code>select</code> clause.
Since Java has no tuple types, representing query projection lists in Java has always been a problem for JPA and Hibernate.
Traditionally, we&#8217;ve just used <code>Object[]</code> most of the time:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kt">var</span> <span class="n">results</span> <span class="o">=</span>
        <span class="n">session</span><span class="o">.</span><span class="na">createSelectionQuery</span><span class="o">(</span><span class="s">"select isbn, title from Book"</span><span class="o">,</span> <span class="nc">Object</span><span class="o">[].</span><span class="na">class</span><span class="o">)</span>
            <span class="o">.</span><span class="na">getResultList</span><span class="o">();</span>

<span class="k">for</span> <span class="o">(</span><span class="kt">var</span> <span class="n">result</span> <span class="o">:</span> <span class="n">results</span><span class="o">)</span> <span class="o">{</span>
    <span class="kt">var</span> <span class="n">isbn</span> <span class="o">=</span> <span class="o">(</span><span class="nc">String</span><span class="o">)</span> <span class="n">result</span><span class="o">[</span><span class="mi">0</span><span class="o">];</span>
    <span class="kt">var</span> <span class="n">title</span> <span class="o">=</span> <span class="o">(</span><span class="nc">String</span><span class="o">)</span> <span class="n">result</span><span class="o">[</span><span class="mi">1</span><span class="o">];</span>
    <span class="o">...</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This is really a bit ugly.
Java&#8217;s <code>record</code> types now offer an interesting alternative:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="n">record</span> <span class="nf">IsbnTitle</span><span class="o">(</span><span class="nc">String</span> <span class="n">isbn</span><span class="o">,</span> <span class="nc">String</span> <span class="n">title</span><span class="o">)</span> <span class="o">{}</span>

<span class="kt">var</span> <span class="n">results</span> <span class="o">=</span>
        <span class="n">session</span><span class="o">.</span><span class="na">createSelectionQuery</span><span class="o">(</span><span class="s">"select isbn, title from Book"</span><span class="o">,</span> <span class="nc">IsbnTitle</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
            <span class="o">.</span><span class="na">getResultList</span><span class="o">();</span>

<span class="k">for</span> <span class="o">(</span><span class="kt">var</span> <span class="n">result</span> <span class="o">:</span> <span class="n">results</span><span class="o">)</span> <span class="o">{</span>
    <span class="kt">var</span> <span class="n">isbn</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="na">isbn</span><span class="o">();</span>
    <span class="kt">var</span> <span class="n">title</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="na">title</span><span class="o">();</span>
    <span class="o">...</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice that we&#8217;re able to declare the <code>record</code> right before the line which executes the query.</p>
</div>
<div class="paragraph">
<p>Now, this is only <em>superficially</em> more typesafe, since the query itself is not checked statically, and so we can&#8217;t say it&#8217;s objectively better.
But perhaps you find it more aesthetically pleasing.
And if we&#8217;re going to be passing query results around the system, the use of a <code>record</code> type is <em>much</em> better.</p>
</div>
<div class="paragraph">
<p>The criteria query API offers a much more satisfying solution to the problem.
Consider the following code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kt">var</span> <span class="n">builder</span> <span class="o">=</span> <span class="n">sessionFactory</span><span class="o">.</span><span class="na">getCriteriaBuilder</span><span class="o">();</span>
<span class="kt">var</span> <span class="n">query</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">createTupleQuery</span><span class="o">();</span>
<span class="kt">var</span> <span class="n">book</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="nc">Book</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="kt">var</span> <span class="n">bookTitle</span> <span class="o">=</span> <span class="n">book</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">Book_</span><span class="o">.</span><span class="na">title</span><span class="o">);</span>
<span class="kt">var</span> <span class="n">bookIsbn</span> <span class="o">=</span> <span class="n">book</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">Book_</span><span class="o">.</span><span class="na">isbn</span><span class="o">);</span>
<span class="kt">var</span> <span class="n">bookPrice</span> <span class="o">=</span> <span class="n">book</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">Book_</span><span class="o">.</span><span class="na">price</span><span class="o">);</span>
<span class="n">query</span><span class="o">.</span><span class="na">select</span><span class="o">(</span><span class="n">builder</span><span class="o">.</span><span class="na">tuple</span><span class="o">(</span><span class="n">bookTitle</span><span class="o">,</span> <span class="n">bookIsbn</span><span class="o">,</span> <span class="n">bookPrice</span><span class="o">));</span>
<span class="kt">var</span> <span class="n">resultList</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">createSelectionQuery</span><span class="o">(</span><span class="n">query</span><span class="o">).</span><span class="na">getResultList</span><span class="o">();</span>
<span class="k">for</span> <span class="o">(</span><span class="kt">var</span> <span class="nl">result:</span> <span class="n">resultList</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">String</span> <span class="n">title</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">bookTitle</span><span class="o">);</span>
    <span class="nc">String</span> <span class="n">isbn</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">bookIsbn</span><span class="o">);</span>
    <span class="nc">BigDecimal</span> <span class="n">price</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">bookPrice</span><span class="o">);</span>
    <span class="o">...</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This code is manifestly completely typesafe, and much better than we can hope to do with HQL.</p>
</div>
</div>
<div class="sect2">
<h3 id="named-queries">5.16. Named queries</h3>
<div class="paragraph">
<p>The <code>@NamedQuery</code> annotation lets us define a HQL query that is compiled and checked as part of the bootstrap process.
This means we find out about errors in our queries earlier, instead of waiting until the query is actually executed.
We can place the <code>@NamedQuery</code> annotation on any class, even on an entity class.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@NamedQuery</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"10BooksByTitle"</span><span class="o">,</span>
            <span class="n">query</span><span class="o">=</span><span class="s">"from Book where title like :titlePattern order by title fetch first 10 rows only"</span><span class="o">)</span>
<span class="kd">class</span> <span class="nc">BookQueries</span> <span class="o">{}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We have to make sure that the class with the <code>@NamedQuery</code> annotation will be scanned by Hibernate, either:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>by adding <code>&lt;class&gt;org.hibernate.example.BookQueries&lt;/class&gt;</code> to <code>persistence.xml</code>, or</p>
</li>
<li>
<p>by calling <code>configuration.addClass(BookQueries.class)</code>.</p>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Unfortunately, JPA&#8217;s <code>@NamedQuery</code> annotation can&#8217;t be placed on a package descriptor.
Therefore, Hibernate provides a very similar annotation, <code>@org.hibernate.annotations.NamedQuery</code> which <em>can</em> be specified at the package level.
If we declare a named query at the package level, we must call:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="n">configuration</span><span class="o">.</span><span class="na">addPackage</span><span class="o">(</span><span class="s">"org.hibernate.example"</span><span class="o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>so that Hibernate knows where to find it.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <code>@NamedNativeQuery</code> annotation lets us do the same for native SQL queries.
There&#8217;s much less advantage to using <code>@NamedNativeQuery</code>, because there is very little that Hibernate can do to validate the correctness of a query written in the native SQL dialect of your database.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 40. Executing named queries</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 36%;">
<col style="width: 32%;">
<col style="width: 22%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Kind</th>
<th class="tableblock halign-left valign-top"><code>Session</code> method</th>
<th class="tableblock halign-left valign-top"><code>EntityManager</code> method</th>
<th class="tableblock halign-left valign-top"><code>Query</code> execution method</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Selection</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>createNamedSelectionQuery(String,Class)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>createNamedQuery(String,Class)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>getResultList()</code>, <code>getSingleResult()</code>, or <code>getSingleResultOrNull()</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Mutation</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>createNamedMutationQuery(String)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>createNamedQuery(String)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>executeUpdate()</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>We execute our named query like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nc">List</span><span class="o">&lt;</span><span class="nc">Book</span><span class="o">&gt;</span> <span class="n">books</span> <span class="o">=</span>
        <span class="n">entityManager</span><span class="o">.</span><span class="na">createNamedQuery</span><span class="o">(</span><span class="n">BookQueries_</span><span class="o">.</span><span class="na">QUERY_10_BOOKS_BY_TITLE</span><span class="o">)</span>
            <span class="o">.</span><span class="na">setParameter</span><span class="o">(</span><span class="s">"titlePattern"</span><span class="o">,</span> <span class="n">titlePattern</span><span class="o">)</span>
            <span class="o">.</span><span class="na">getResultList</span><span class="o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here, <code>BookQueries_.QUERY_10_BOOKS_BY_TITLE</code> is a constant with value <code>"10BooksByTitle"</code>, generated by the Metamodel Generator.</p>
</div>
<div class="paragraph">
<p>Note that the code which executes the named query is not aware of whether the query was written in HQL or in native SQL, making it slightly easier to change and optimize the query later.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>It&#8217;s nice to have our queries checked at startup time.
It&#8217;s even better to have them checked at compile time.
In <a href="#organizing-persistence">Organizing persistence logic</a>, we mentioned that the Metamodel Generator can do that for us, with the help of the <code>@CheckHQL</code> annotation, and we presented that as a reason to use <code>@NamedQuery</code>.</p>
</div>
<div class="paragraph">
<p>But actually, Hibernate has a separate <a href="#query-validator">Query Validator</a> capable of performing compile-time validation of HQL query strings that occur as arguments to <code>createQuery()</code> and friends.
If we use the Query Validator, there&#8217;s not much advantage to the use of named queries.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="load-access">5.17. Controlling lookup by id</h3>
<div class="paragraph">
<p>We can do almost anything via HQL, criteria, or native SQL queries.
But when we already know the identifier of the entity we need, a query can feel like overkill.
And queries don&#8217;t make efficient use of the <a href="#second-level-cache">second level cache</a>.</p>
</div>
<div class="paragraph">
<p>We met the <a href="#persistence-operations"><code>find()</code></a> method earlier.
It&#8217;s the most basic way to perform a <em>lookup</em> by id.
But as we also <a href="#entity-graph">already saw</a>, it can&#8217;t quite do everything.
Therefore, Hibernate has some APIs that streamline certain more complicated lookups:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 41. Operations for lookup by id</caption>
<colgroup>
<col style="width: 30%;">
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Method name</th>
<th class="tableblock halign-left valign-top">Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>byId()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Lets us specify association fetching via an <code>EntityGraph</code>, as we saw; also lets us specify some additional options, including how the lookup <a href="#second-level-cache-management">interacts with the second level cache</a>, and whether the entity should be loaded in read-only mode</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>byMultipleIds()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Lets us load a <em>batch</em> of ids at the same time</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Batch loading is very useful when we need to retrieve multiple instances of the same entity class by id:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kt">var</span> <span class="n">graph</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">createEntityGraph</span><span class="o">(</span><span class="nc">Book</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="n">graph</span><span class="o">.</span><span class="na">addSubgraph</span><span class="o">(</span><span class="n">Book_</span><span class="o">.</span><span class="na">publisher</span><span class="o">);</span>

<span class="nc">List</span><span class="o">&lt;</span><span class="nc">Book</span><span class="o">&gt;</span> <span class="n">books</span> <span class="o">=</span>
        <span class="n">session</span><span class="o">.</span><span class="na">byMultipleIds</span><span class="o">(</span><span class="nc">Book</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
            <span class="o">.</span><span class="na">withFetchGraph</span><span class="o">(</span><span class="n">graph</span><span class="o">)</span>  <span class="c1">// control association fetching</span>
            <span class="o">.</span><span class="na">withBatchSize</span><span class="o">(</span><span class="mi">20</span><span class="o">)</span>      <span class="c1">// specify an explicit batch size</span>
            <span class="o">.</span><span class="na">with</span><span class="o">(</span><span class="nc">CacheMode</span><span class="o">.</span><span class="na">GET</span><span class="o">)</span>    <span class="c1">// control interaction with the cache</span>
            <span class="o">.</span><span class="na">multiLoad</span><span class="o">(</span><span class="n">bookIds</span><span class="o">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The given list of <code>bookIds</code> will be broken into batches, and each batch will be fetched from the database in a single <code>select</code>.
If we don&#8217;t specify the batch size explicitly, a batch size will be chosen automatically.</p>
</div>
<div class="paragraph">
<p>We also have some operations for working with lookups by <a href="#natural-identifiers">natural id</a>:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 30%;">
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Method name</th>
<th class="tableblock halign-left valign-top">Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>bySimpleNaturalId()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">For an entity with just one attribute is annotated <code>@NaturalId</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>byNaturalId()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">For an entity with multiple attributes are annotated <code>@NaturalId</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>byMultipleNaturalId()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Lets us load a <em>batch</em> of natural ids at the same time</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Here&#8217;s how we can retrieve an entity by its composite natural id:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nc">Book</span> <span class="n">book</span> <span class="o">=</span>
        <span class="n">session</span><span class="o">.</span><span class="na">byNaturalId</span><span class="o">(</span><span class="nc">Book</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
            <span class="o">.</span><span class="na">using</span><span class="o">(</span><span class="n">Book_</span><span class="o">.</span><span class="na">isbn</span><span class="o">,</span> <span class="n">isbn</span><span class="o">)</span>
            <span class="o">.</span><span class="na">using</span><span class="o">(</span><span class="n">Book_</span><span class="o">.</span><span class="na">printing</span><span class="o">,</span> <span class="n">printing</span><span class="o">)</span>
            <span class="o">.</span><span class="na">load</span><span class="o">();</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice that this code fragment is completely typesafe, again thanks to the <a href="#metamodel-generator">Metamodel Generator</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="jdbc">5.18. Interacting directly with JDBC</h3>
<div class="paragraph">
<p>From time to time we run into the need to write some code that calls JDBC directly.
Unfortunately, JPA offers no good way to do this, but the Hibernate <code>Session</code> does.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="n">session</span><span class="o">.</span><span class="na">doWork</span><span class="o">(</span><span class="n">connection</span> <span class="o">-&gt;</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">(</span><span class="kt">var</span> <span class="n">callable</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="na">prepareCall</span><span class="o">(</span><span class="s">"{call myproc(?)}"</span><span class="o">))</span> <span class="o">{</span>
        <span class="n">callable</span><span class="o">.</span><span class="na">setLong</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">argument</span><span class="o">);</span>
        <span class="n">callable</span><span class="o">.</span><span class="na">execute</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">});</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>Connection</code> passed to the work is the same connection being used by the session, and so any work performed using that connection occurs in the same transaction context.</p>
</div>
<div class="paragraph">
<p>If the work returns a value, use <code>doReturningWork()</code> instead of <code>doWork()</code>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>In a container environment where transactions and database connections are managed by the container, this might not be the easiest way to obtain the JDBC connection.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="advice">5.19. What to do when things go wrong</h3>
<div class="paragraph">
<p>Object/relational mapping has been called the "Vietnam of computer science".
The person who made this analogy is American, and so one supposes that he meant to imply some kind of unwinnable war.
This is quite ironic, since at the very moment he made this comment, Hibernate was already on the brink of winning the war.</p>
</div>
<div class="paragraph">
<p>Today, Vietnam is a peaceful country with exploding per-capita GDP, and ORM is a solved problem.
That said, Hibernate is complex, and ORM still presents many pitfalls for the inexperienced, even occasionally for the experienced.
Sometimes things go wrong.</p>
</div>
<div class="paragraph">
<p>In this section we&#8217;ll quickly sketch some general strategies for avoiding "quagmires".</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Understand SQL and the relational model.
Know the capabilities of your RDBMS.
Work closely with the DBA if you&#8217;re lucky enough to have one.
Hibernate is not about "transparent persistence" for Java objects.
It&#8217;s about making two excellent technologies work smoothly together.</p>
</li>
<li>
<p><a href="#logging-generated-sql">Log the SQL</a> executed by Hibernate.
You cannot know that your persistence logic is correct until you&#8217;ve actually inspected the SQL that&#8217;s being executed.
Even when everything seems to be "working", there might be a lurking <a href="#association-fetching">N+1 selects monster</a>.</p>
</li>
<li>
<p>Be careful when <a href="#bidirectional-problem">modifying bidirectional associations</a>.
In principle, you should update <em>both ends</em> of the association.
But Hibernate doesn&#8217;t strictly enforce that, since there are some situations where such a rule would be too heavy-handed.
Whatever the case, it&#8217;s up to you to maintain consistency across your model.</p>
</li>
<li>
<p>Never <a href="#persistence-contexts">leak a persistence context</a> across threads or concurrent transactions.
Have a strategy or framework to guarantee this never happens.</p>
</li>
<li>
<p>When running queries that return large result sets, take care to consider the size of the <a href="#session-cache-management">session cache</a>.
Consider using a <a href="#stateless-sessions">stateless session</a>.</p>
</li>
<li>
<p>Think carefully about the semantics of the <a href="#second-level-cache">second-level cache</a>, and how the caching policies impact transaction isolation.</p>
</li>
<li>
<p>Avoid fancy bells and whistles you don&#8217;t need.
Hibernate is incredibly feature-rich, and that&#8217;s a good thing, because it serves the needs of a huge number of users, many of whom have one or two very specialized needs.
But nobody has <em>all</em> those specialized needs.
In all probability, you have none of them.
Write your domain model in the simplest way that&#8217;s reasonable, using the simplest mapping strategies that make sense.</p>
</li>
<li>
<p>When something isn&#8217;t behaving as you expect, <em>simplify</em>.
Isolate the problem.
Find the absolute minimum test case which reproduces the behavior, <em>before</em> asking for help online.
Most of the time, the mere act of isolating the problem will suggest an obvious solution.</p>
</li>
<li>
<p>Avoid frameworks and libraries that "wrap" JPA.
If there&#8217;s any one criticism of Hibernate and ORM that sometimes <em>does</em> ring true, it&#8217;s that it takes you too far from direct control over JDBC.
An additional layer just takes you even further.</p>
</li>
<li>
<p>Avoid copy/pasting code from random bloggers or stackoverflow reply guys.
Many of the suggestions you&#8217;ll find online just aren&#8217;t the simplest solution, and many aren&#8217;t correct for Hibernate 6.
Instead, <em>understand</em> what you&#8217;re doing; study the Javadoc of the APIs you&#8217;re using; read the JPA specification; follow the advice we give in this document; go direct to the Hibernate team on Zulip.
(Sure, we can be a bit cantankerous at times, but we <em>do</em> always want you to be successful.)</p>
</li>
<li>
<p>Always consider other options.
You don&#8217;t have to use Hibernate for <em>everything</em>.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="generator">6. Compile-time tooling</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The Metamodel Generator is a standard part of JPA.
We&#8217;ve actually already seen its handiwork in the code examples <a href="#main-jpa">earlier</a>: it&#8217;s the author of the class <code>Book_</code>, which contains the static metamodel of the <a href="#book">entity class</a> <code>Book</code>.</p>
</div>
<div id="metamodel-generator" class="sidebarblock">
<div class="content">
<div class="title">The Metamodel Generator</div>
<div class="paragraph">
<p>Hibernate&#8217;s <a href="https://hibernate.org/orm/tooling/">Metamodel Generator</a> is an annotation processor that produces what JPA calls a <em>static metamodel</em>.
That is, it produces a typed model of the persistent classes in our program, giving us a type-safe way to refer to their attributes in Java code.
In particular, it lets us specify <a href="#entity-graph">entity graphs</a> and <a href="#criteria-queries">criteria queries</a> in a completely type-safe way.</p>
</div>
<div class="paragraph">
<p>The history behind this thing is quite interesting.
Back when Java&#8217;s annotation processing API was brand spankin' new, the static metamodel for JPA was proposed by Gavin King for inclusion in JPA 2.0, as a way to achieve type safety in the nascent criteria query API.
It&#8217;s fair to say that, back in 2010, this API was not a runaway success.
Tools did not, at the time, feature robust support for annotation processors.
And all the explicit generic types made user code quite verbose and difficult to read.
(The need for an explicit reference to a <code>CriteriaBuilder</code> instance also contributed verbosity to the criteria API.)
For years, Gavin counted this as one of his more embarrassing missteps.</p>
</div>
<div class="paragraph">
<p>But time has been kind to the static metamodel.
In 2023, all Java compilers, build tools, and IDEs have robust support for annotation processing, and Java&#8217;s local type inference (the <code>var</code> keyword) eliminates the verbose generic types.
JPA&#8217;s <code>CriteriaBuilder</code> and <code>EntityGraph</code> APIs are still not quite perfect, but the imperfections aren&#8217;t related to static type safety or annotation processing.
The static metamodel itself is undeniably useful and elegant.</p>
</div>
<div class="paragraph">
<p>And so now, in Hibernate 6.3, we&#8217;re finally ready to go new places with the Metamodel Generator.
And it turns out that there&#8217;s quite a lot of unlocked potential there.</p>
</div>
<div class="paragraph">
<p>Now, you still don&#8217;t have to use the Metamodel Generator with Hibernate—the APIs we just mentioned still also accept plain strings—but we find that it works well with Gradle and integrates smoothly with our IDE, and the advantage in type-safety is compelling.</p>
</div>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>We&#8217;ve already seen how to set up the annotation processor in the <a href="#hello-hibernate">Gradle build</a> we saw earlier.
For more details on how to integrate the Metamodel Generator, check out the <a href="https://docs.jboss.org/hibernate/orm/6.3/userguide/html_single/Hibernate_User_Guide.html#tooling-modelgen">Static Metamodel Generator</a> section in the User Guide.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Here&#8217;s an example of the sort of code that&#8217;s generated for an entity class, as mandated by the JPA specification:</p>
</div>
<div class="listingblock">
<div class="title">Generated Code</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@StaticMetamodel</span><span class="o">(</span><span class="nc">Book</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">Book_</span> <span class="o">{</span>

    <span class="cm">/**
     * @see org.example.Book#isbn
     **/</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">volatile</span> <span class="nc">SingularAttribute</span><span class="o">&lt;</span><span class="nc">Book</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="n">isbn</span><span class="o">;</span>

    <span class="cm">/**
     * @see org.example.Book#text
     **/</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">volatile</span> <span class="nc">SingularAttribute</span><span class="o">&lt;</span><span class="nc">Book</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="n">text</span><span class="o">;</span>

    <span class="cm">/**
     * @see org.example.Book#title
     **/</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">volatile</span> <span class="nc">SingularAttribute</span><span class="o">&lt;</span><span class="nc">Book</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="n">title</span><span class="o">;</span>

    <span class="cm">/**
     * @see org.example.Book#type
     **/</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">volatile</span> <span class="nc">SingularAttribute</span><span class="o">&lt;</span><span class="nc">Book</span><span class="o">,</span> <span class="nc">Type</span><span class="o">&gt;</span> <span class="n">type</span><span class="o">;</span>

    <span class="cm">/**
     * @see org.example.Book#publicationDate
     **/</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">volatile</span> <span class="nc">SingularAttribute</span><span class="o">&lt;</span><span class="nc">Book</span><span class="o">,</span> <span class="nc">LocalDate</span><span class="o">&gt;</span> <span class="n">publicationDate</span><span class="o">;</span>

    <span class="cm">/**
     * @see org.example.Book#publisher
     **/</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">volatile</span> <span class="nc">SingularAttribute</span><span class="o">&lt;</span><span class="nc">Book</span><span class="o">,</span> <span class="nc">Publisher</span><span class="o">&gt;</span> <span class="n">publisher</span><span class="o">;</span>

    <span class="cm">/**
     * @see org.example.Book#authors
     **/</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">volatile</span> <span class="nc">SetAttribute</span><span class="o">&lt;</span><span class="nc">Book</span><span class="o">,</span> <span class="nc">Author</span><span class="o">&gt;</span> <span class="n">authors</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">ISBN</span> <span class="o">=</span> <span class="s">"isbn"</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">TEXT</span> <span class="o">=</span> <span class="s">"text"</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">TITLE</span> <span class="o">=</span> <span class="s">"title"</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">TYPE</span> <span class="o">=</span> <span class="s">"type"</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">PUBLICATION_DATE</span> <span class="o">=</span> <span class="s">"publicationDate"</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">PUBLISHER</span> <span class="o">=</span> <span class="s">"publisher"</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">AUTHORS</span> <span class="o">=</span> <span class="s">"authors"</span><span class="o">;</span>

<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>For each attribute of the entity, the <code>Book_</code> class has:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>a <code>String</code>-valued constant like <code>TITLE</code> , and</p>
</li>
<li>
<p>a typesafe reference like <code>title</code> to a metamodel object of type <code>Attribute</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>We&#8217;ve already been using metamodel references like <code>Book_.authors</code> and <code>Book.AUTHORS</code> in the previous chapters.
So now let&#8217;s see what else the Metamodel Generator can do for us.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The Metamodel Generator provides <em>statically-typed</em> access to elements of the JPA <code>Metamodel</code>. But the <code>Metamodel</code> is also accessible in a "reflective" way, via the <code>EntityManagerFactory</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nc">EntityType</span><span class="o">&lt;</span><span class="nc">Book</span><span class="o">&gt;</span> <span class="n">book</span> <span class="o">=</span> <span class="n">entityManagerFactory</span><span class="o">.</span><span class="na">getMetamodel</span><span class="o">().</span><span class="na">entity</span><span class="o">(</span><span class="nc">Book</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="nc">SingularAttribute</span><span class="o">&lt;</span><span class="nc">Book</span><span class="o">,</span><span class="nc">Long</span><span class="o">&gt;</span> <span class="n">id</span> <span class="o">=</span> <span class="n">book</span><span class="o">.</span><span class="na">getDeclaredId</span><span class="o">(</span><span class="nc">Long</span><span class="o">.</span><span class="na">class</span><span class="o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This is very useful for writing generic code in frameworks or libraries.
For example, you could use it to create your own criteria query API.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Automatic generation of <em>finder methods</em> and <em>query methods</em> is a new feature of Hibernate&#8217;s implementation of the Metamodel Generator, and an extension to the functionality defined by the JPA specification.
In this chapter, we&#8217;re going to explore these features.</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The functionality described in the rest of this chapter depends on the use of the annotations described in <a href="#entities">Entities</a>.
The Metamodel Generator is not currently able to generate finder methods and query methods for entities declared completely in XML, and it&#8217;s not able to validate HQL which queries such entities.
(On the other hand, the <a href="#object-relational-mapping">O/R mappings</a> may be specified in XML, since they&#8217;re not needed by the Metamodel Generator.)</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We&#8217;re going to meet three different kinds of generated method:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>a <em>named query method</em> has its signature and implementation generated directly from a <code>@NamedQuery</code> annotation,</p>
</li>
<li>
<p>a <em>query method</em> has a signature that&#8217;s explicitly declared, and a generated implementation which executes a HQL or SQL query specified via a <code>@HQL</code> or <code>@SQL</code> annotation, and</p>
</li>
<li>
<p>a <em>finder method</em> annotated <code>@Find</code> has a signature that&#8217;s explicitly declared, and a generated implementation inferred from the parameter list.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To whet our appetites, let&#8217;s see how this works for a <code>@NamedQuery</code>.</p>
</div>
<div class="sect2">
<h3 id="generated-named-queries">6.1. Named queries and the Metamodel Generator</h3>
<div class="paragraph">
<p>The very simplest way to generate a query method is to put a <code>@NamedQuery</code> annotation anywhere we like, with a <code>name</code> beginning with the magical character <code>#</code>.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s just stick it on the <code>Book</code> class:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@CheckHQL</span> <span class="c1">// validate the query at compile time</span>
<span class="nd">@NamedQuery</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"#findByTitleAndType"</span><span class="o">,</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s">"select book from Book book where book.title like :titlen and book.type = :type"</span><span class="o">)</span>
<span class="nd">@Entity</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Book</span> <span class="o">{</span> <span class="o">...</span> <span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now the Metamodel Generator adds the following method declaration to the metamodel class <code>Book_</code>.</p>
</div>
<div class="listingblock">
<div class="title">Generated Code</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="cm">/**
 * Execute named query {@value #QUERY_FIND_BY_TITLE_AND_TYPE} defined by annotation of {@link Book}.
 **/</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Book</span><span class="o">&gt;</span> <span class="nf">findByTitleAndType</span><span class="o">(</span><span class="nd">@Nonnull</span> <span class="nc">EntityManager</span> <span class="n">entityManager</span><span class="o">,</span> <span class="nc">String</span> <span class="n">title</span><span class="o">,</span> <span class="nc">Type</span> <span class="n">type</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">entityManager</span><span class="o">.</span><span class="na">createNamedQuery</span><span class="o">(</span><span class="no">QUERY_FIND_BY_TITLE_AND_TYPE</span><span class="o">)</span>
            <span class="o">.</span><span class="na">setParameter</span><span class="o">(</span><span class="s">"titlePattern"</span><span class="o">,</span> <span class="n">title</span><span class="o">)</span>
            <span class="o">.</span><span class="na">setParameter</span><span class="o">(</span><span class="s">"type"</span><span class="o">,</span> <span class="n">type</span><span class="o">)</span>
            <span class="o">.</span><span class="na">getResultList</span><span class="o">();</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We can easily call this method from wherever we like, as long as we have access to an <code>EntityManager</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nc">List</span><span class="o">&lt;</span><span class="nc">Book</span><span class="o">&gt;</span> <span class="n">books</span> <span class="o">=</span>
        <span class="n">Book_</span><span class="o">.</span><span class="na">findByTitleAndType</span><span class="o">(</span><span class="n">entityManager</span><span class="o">,</span> <span class="n">titlePattern</span><span class="o">,</span> <span class="nc">Type</span><span class="o">.</span><span class="na">BOOK</span><span class="o">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, this is quite nice, but it&#8217;s a bit inflexible in various ways, and so this probably <em>isn&#8217;t</em> the best way to generate a query method.</p>
</div>
</div>
<div class="sect2">
<h3 id="generated-query-methods">6.2. Generated query methods</h3>
<div class="paragraph">
<p>The principal problem with generating the query method straight from the <code>@NamedQuery</code> annotation is that it doesn&#8217;t let us explicitly specify the return type or parameter list.
In the case we just saw, the Metamodel Generator does a reasonable job of inferring the query return type and parameter types, but we&#8217;re often going to need a bit more control.</p>
</div>
<div class="paragraph">
<p>The solution is to write down the signature of the query method <em>explicitly</em>, as an abstract method in Java.
We&#8217;ll need a place to put this method, and since our <code>Book</code> entity isn&#8217;t an abstract class, we&#8217;ll just introduce a new interface for this purpose:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">interface</span> <span class="nc">Queries</span> <span class="o">{</span>
    <span class="nd">@HQL</span><span class="o">(</span><span class="s">"where title like :title and type = :type"</span><span class="o">)</span>
    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Book</span><span class="o">&gt;</span> <span class="nf">findBooksByTitleAndType</span><span class="o">(</span><span class="nc">String</span> <span class="n">title</span><span class="o">,</span> <span class="nc">String</span> <span class="n">type</span><span class="o">);</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Instead of <code>@NamedQuery</code>, which is a type-level annotation, we specify the HQL query using the new <code>@HQL</code> annotation, which we place directly on the query method.
This results in the following generated code in the <code>Queries_</code> class:</p>
</div>
<div class="listingblock">
<div class="title">Generated Code</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@StaticMetamodel</span><span class="o">(</span><span class="nc">Queries</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">Queries_</span> <span class="o">{</span>

    <span class="cm">/**
     * Execute the query {@value #FIND_BOOKS_BY_TITLE_AND_TYPE_String_Type}.
     *
     * @see org.example.Queries#findBooksByTitleAndType(String,Type)
     **/</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Book</span><span class="o">&gt;</span> <span class="nf">findBooksByTitleAndType</span><span class="o">(</span><span class="nd">@Nonnull</span> <span class="nc">EntityManager</span> <span class="n">entityManager</span><span class="o">,</span> <span class="nc">String</span> <span class="n">title</span><span class="o">,</span> <span class="nc">Type</span> <span class="n">type</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">entityManager</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="n">FIND_BOOKS_BY_TITLE_AND_TYPE_String_Type</span><span class="o">,</span> <span class="nc">Book</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
                <span class="o">.</span><span class="na">setParameter</span><span class="o">(</span><span class="s">"title"</span><span class="o">,</span> <span class="n">title</span><span class="o">)</span>
                <span class="o">.</span><span class="na">setParameter</span><span class="o">(</span><span class="s">"type"</span><span class="o">,</span> <span class="n">type</span><span class="o">)</span>
                <span class="o">.</span><span class="na">getResultList</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">FIND_BOOKS_BY_TITLE_AND_TYPE_String_Type</span> <span class="o">=</span>
            <span class="s">"where title like :title and type = :type"</span><span class="o">;</span>

<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice that the signature differs just slightly from the one we wrote down in the <code>Queries</code> interface: the Metamodel Generator has prepended a parameter accepting <code>EntityManager</code> to the parameter list.</p>
</div>
<div class="paragraph">
<p>If we want to explicitly specify the name and type of this parameter, we may declare it explicitly:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">interface</span> <span class="nc">Queries</span> <span class="o">{</span>
    <span class="nd">@HQL</span><span class="o">(</span><span class="s">"where title like :title and type = :type"</span><span class="o">)</span>
    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Book</span><span class="o">&gt;</span> <span class="nf">findBooksByTitleAndType</span><span class="o">(</span><span class="nc">StatelessSession</span> <span class="n">session</span><span class="o">,</span> <span class="nc">String</span> <span class="n">title</span><span class="o">,</span> <span class="nc">String</span> <span class="n">type</span><span class="o">);</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The Metamodel Generator defaults to using <code>EntityManager</code> as the session type, but other types are allowed:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>Session</code>,</p>
</li>
<li>
<p><code>StatelessSession</code>, or</p>
</li>
<li>
<p><code>Mutiny.Session</code> from Hibernate Reactive.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The real value of all this is in the checks which can now be done at compile time.
The Metamodel Generator verifies that the parameters of our abstract method declaration match the parameters of the HQL query, for example:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>for a named parameter <code>:alice</code>, there must be a method parameter named <code>alice</code> with exactly the same type, or</p>
</li>
<li>
<p>for an ordinal parameter <code>?2</code>, the second method parameter must have exactly the same type.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The query must also be syntactically legal and semantically well-typed, that is, the entities, attributes, and functions referenced in the query must actually exist and have compatible types.
The Metamodel Generator determines this by inspecting the annotations of the entity classes at compile time.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The <code>@CheckHQL</code> annotation which instructs Hibernate to validate named queries is <em>not</em> necessary for query methods annotated <code>@HQL</code>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <code>@HQL</code> annotation has a friend named <code>@SQL</code> which lets us specify a query written in native SQL instead of in HQL.
In this case there&#8217;s a lot less the Metamodel Generator can do to check that the query is legal and well-typed.</p>
</div>
<div class="paragraph">
<p>We imagine you&#8217;re wondering whether a <code>static</code> method is really the right thing to use here.</p>
</div>
</div>
<div class="sect2">
<h3 id="static-or-instance">6.3. Generating query methods as instance methods</h3>
<div class="paragraph">
<p>One thing not to like about what we&#8217;ve just seen is that we can&#8217;t transparently replace a generated <code>static</code> function of the <code>Queries_</code> class with an improved handwritten implementation without impacting clients.
Now, if our query is only called in one place, which is quite common, this isn&#8217;t going to be a big issue, and so we&#8217;re inclined to think the <code>static</code> function is fine.</p>
</div>
<div class="paragraph">
<p>But if this function is called from many places, it&#8217;s probably better to promote it to an instance method of some class or interface.
Fortunately, this is straightforward.</p>
</div>
<div class="paragraph">
<p>All we need to do is add an abstract getter method for the session object to our <code>Queries</code> interface.
(And remove the session from the method parameter list.)
We may call this method anything we like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">interface</span> <span class="nc">Queries</span> <span class="o">{</span>
    <span class="nc">EntityManager</span> <span class="nf">entityManager</span><span class="o">();</span>

    <span class="nd">@HQL</span><span class="o">(</span><span class="s">"where title like :title and type = :type"</span><span class="o">)</span>
    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Book</span><span class="o">&gt;</span> <span class="nf">findBooksByTitleAndType</span><span class="o">(</span><span class="nc">String</span> <span class="n">title</span><span class="o">,</span> <span class="nc">String</span> <span class="n">type</span><span class="o">);</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here we&#8217;ve used <code>EntityManager</code> as the session type, but other types are allowed, as we saw above.</p>
</div>
<div class="paragraph">
<p>Now the Metamodel Generator does something a bit different:</p>
</div>
<div class="listingblock">
<div class="title">Generated Code</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@StaticMetamodel</span><span class="o">(</span><span class="nc">Queries</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Queries_</span> <span class="kd">implements</span> <span class="nc">Queries</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="nd">@Nonnull</span> <span class="nc">EntityManager</span> <span class="n">entityManager</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">Queries_</span><span class="o">(</span><span class="nd">@Nonnull</span> <span class="nc">EntityManager</span> <span class="n">entityManager</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">entityManager</span> <span class="o">=</span> <span class="n">entityManager</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nd">@Nonnull</span> <span class="nc">EntityManager</span> <span class="nf">entityManager</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">entityManager</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
     * Execute the query {@value #FIND_BOOKS_BY_TITLE_AND_TYPE_String_Type}.
     *
     * @see org.example.Queries#findBooksByTitleAndType(String,Type)
     **/</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Book</span><span class="o">&gt;</span> <span class="nf">findBooksByTitleAndType</span><span class="o">(</span><span class="nc">String</span> <span class="n">title</span><span class="o">,</span> <span class="nc">Type</span> <span class="n">type</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">entityManager</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="n">FIND_BOOKS_BY_TITLE_AND_TYPE_String_Type</span><span class="o">,</span> <span class="nc">Book</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
                <span class="o">.</span><span class="na">setParameter</span><span class="o">(</span><span class="s">"title"</span><span class="o">,</span> <span class="n">title</span><span class="o">)</span>
                <span class="o">.</span><span class="na">setParameter</span><span class="o">(</span><span class="s">"type"</span><span class="o">,</span> <span class="n">type</span><span class="o">)</span>
                <span class="o">.</span><span class="na">getResultList</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">FIND_BOOKS_BY_TITLE_AND_TYPE_String_Type</span> <span class="o">=</span>
            <span class="s">"where title like :title and type = :type"</span><span class="o">;</span>

<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The generated class <code>Queries_</code> now implements the <code>Queries</code> interface, and the generated query method implements our abstract method directly.</p>
</div>
<div class="paragraph">
<p>Of course, the protocol for calling the query method has to change:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nc">Queries</span> <span class="n">queries</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Queries_</span><span class="o">(</span><span class="n">entityManager</span><span class="o">);</span>
<span class="nc">List</span><span class="o">&lt;</span><span class="nc">Book</span><span class="o">&gt;</span> <span class="n">books</span> <span class="o">=</span> <span class="n">queries</span><span class="o">.</span><span class="na">findByTitleAndType</span><span class="o">(</span><span class="n">titlePattern</span><span class="o">,</span> <span class="nc">Type</span><span class="o">.</span><span class="na">BOOK</span><span class="o">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If we ever need to swap out the generated query method with one we write by hand, without impacting clients, all we need to do is replace the abstract method with a <code>default</code> method of the <code>Queries</code> interface.
For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">interface</span> <span class="nc">Queries</span> <span class="o">{</span>
    <span class="nc">EntityManager</span> <span class="nf">entityManager</span><span class="o">();</span>

    <span class="c1">// handwritten method replacing previous generated implementation</span>
    <span class="k">default</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Book</span><span class="o">&gt;</span> <span class="nf">findBooksByTitleAndType</span><span class="o">(</span><span class="nc">String</span> <span class="n">title</span><span class="o">,</span> <span class="nc">String</span> <span class="n">type</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">entityManager</span><span class="o">()</span>
                <span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="s">"where title like :title and type = :type"</span><span class="o">,</span> <span class="nc">Book</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">setParameter</span><span class="o">(</span><span class="s">"title"</span><span class="o">,</span> <span class="n">title</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">setParameter</span><span class="o">(</span><span class="s">"type"</span><span class="o">,</span> <span class="n">type</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">setFlushMode</span><span class="o">(</span><span class="no">COMMIT</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">setMaxResults</span><span class="o">(</span><span class="mi">100</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">getResultList</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>What if we would like to inject a <code>Queries</code> object instead of calling its constructor directly?</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>As you <a href="#architecture">recall</a>, we don&#8217;t think these things really need to be container-managed objects.
But if you <em>want</em> them to be—if you&#8217;re allergic to calling constructors, for some reason—then:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>placing <code>jakarta.inject</code> on the build path will cause an <code>@Inject</code> annotation to be added to the constructor of <code>Queries_</code>, and</p>
</li>
<li>
<p>placing <code>jakarta.enterprise.context</code> on the build path will cause a <code>@Dependent</code> annotation to be added to the <code>Queries_</code> class.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Thus, the generated implementation of <code>Queries</code> will be a perfectly functional CDI bean with no extra work to be done.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Is the <code>Queries</code> interface starting to look a lot like a DAO-style repository object?
Well, perhaps.
You can certainly <em>decide to use</em> this facility to create a <code>BookRepository</code> if that&#8217;s what you prefer.
But unlike a repository, our <code>Queries</code> interface:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>doesn&#8217;t attempt to hide the <code>EntityManager</code> from its clients,</p>
</li>
<li>
<p>doesn&#8217;t implement or extend any framework-provided interface or abstract class, at least not unless you want to create such a framework yourself, and</p>
</li>
<li>
<p>isn&#8217;t restricted to service a particular entity class.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>We can have as many or as few interfaces with query methods as we like.
There&#8217;s no one-one-correspondence between these interfaces and entity types.
This approach is so flexible that we don&#8217;t even really know what to call these "interfaces with query methods".</p>
</div>
</div>
<div class="sect2">
<h3 id="generated-finder-methods">6.4. Generated finder methods</h3>
<div class="paragraph">
<p>At this point, one usually begins to question whether it&#8217;s even necessary to write a query at all.
Would it be possible to just infer the query from the method signature?</p>
</div>
<div class="paragraph">
<p>In some simple cases it&#8217;s indeed possible, and this is the purpose of <em>finder methods</em>.
A finder method is a method annotated <code>@Find</code>.
For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Find</span>
<span class="nc">Book</span> <span class="nf">getBook</span><span class="o">(</span><span class="nc">String</span> <span class="n">isbn</span><span class="o">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>A finder method may have multiple parameters:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Find</span>
<span class="nc">List</span><span class="o">&lt;</span><span class="nc">Book</span><span class="o">&gt;</span> <span class="nf">getBooksByTitle</span><span class="o">(</span><span class="nc">String</span> <span class="n">title</span><span class="o">,</span> <span class="nc">Type</span> <span class="n">type</span><span class="o">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The name of the finder method is arbitrary and carries no semantics.
But:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the return type determines the entity class to be queried, and</p>
</li>
<li>
<p>the parameters of the method must match the fields of the entity class <em>exactly</em>, by both name and type.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Considering our first example, <code>Book</code> has a persistent field <code>String isbn</code>, so this finder method is legal.
If there were no field named <code>isbn</code> in <code>Book</code>, or if it had a different type, this method declaration would be rejected with a meaningful error at compile time.
Similarly, the second example is legal, since <code>Book</code> has fields <code>String title</code> and <code>Type type</code>.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>You might notice that our solution to this problem is very different from the approach taken by others.
In DAO-style repository frameworks, you&#8217;re asked to encode the semantics of the finder method into the <em>name of the method</em>.
This idea came to Java from Ruby, and we think it doesn&#8217;t belong here.
It&#8217;s completely unnatural in Java, and by almost any measure other than <em>counting characters</em> it&#8217;s objectively worse than just writing the query in a string literal.
At least string literals accommodate whitespace and punctuation characters.
Oh and, you know, it&#8217;s pretty useful to be able to rename a finder method <em>without changing its semantics</em>. 🙄</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The code generated for this finder method depends on what kind of fields match the method parameters:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 45%;">
<col>
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@Id</code> field</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Uses <code>EntityManager.find()</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">All <code>@NaturalId</code> fields</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Uses <code>Session.byNaturalId()</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Other persistent fields, or a mix of field types</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Uses a criteria query</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The generated code also depends on what kind of session we have, since the capabilities of stateless sessions, and of reactive sessions, differ slightly from the capabilities of regular stateful sessions.</p>
</div>
<div class="paragraph">
<p>With <code>EntityManager</code> as the session type, we obtain:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="cm">/**
 * Find {@link Book} by {@link Book#isbn isbn}.
 *
 * @see org.example.Dao#getBook(String)
 **/</span>
<span class="nd">@Override</span>
<span class="kd">public</span> <span class="nc">Book</span> <span class="nf">getBook</span><span class="o">(</span><span class="nd">@Nonnull</span> <span class="nc">String</span> <span class="n">isbn</span><span class="o">)</span> <span class="o">{</span>
	<span class="k">return</span> <span class="n">entityManager</span><span class="o">.</span><span class="na">find</span><span class="o">(</span><span class="nc">Book</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">isbn</span><span class="o">);</span>
<span class="o">}</span>

<span class="cm">/**
 * Find {@link Book} by {@link Book#title title} and {@link Book#type type}.
 *
 * @see org.example.Dao#getBooksByTitle(String,Type)
 **/</span>
<span class="nd">@Override</span>
<span class="kd">public</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Book</span><span class="o">&gt;</span> <span class="nf">getBooksByTitle</span><span class="o">(</span><span class="nc">String</span> <span class="n">title</span><span class="o">,</span> <span class="nc">Type</span> <span class="n">type</span><span class="o">)</span> <span class="o">{</span>
	<span class="kt">var</span> <span class="n">builder</span> <span class="o">=</span> <span class="n">entityManager</span><span class="o">.</span><span class="na">getEntityManagerFactory</span><span class="o">().</span><span class="na">getCriteriaBuilder</span><span class="o">();</span>
	<span class="kt">var</span> <span class="n">query</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="nc">Book</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
	<span class="kt">var</span> <span class="n">entity</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="nc">Book</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
	<span class="n">query</span><span class="o">.</span><span class="na">where</span><span class="o">(</span>
			<span class="n">title</span><span class="o">==</span><span class="kc">null</span>
				<span class="o">?</span> <span class="n">entity</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">Book_</span><span class="o">.</span><span class="na">title</span><span class="o">).</span><span class="na">isNull</span><span class="o">()</span>
				<span class="o">:</span> <span class="n">builder</span><span class="o">.</span><span class="na">equal</span><span class="o">(</span><span class="n">entity</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">Book_</span><span class="o">.</span><span class="na">title</span><span class="o">),</span> <span class="n">title</span><span class="o">),</span>
			<span class="n">type</span><span class="o">==</span><span class="kc">null</span>
				<span class="o">?</span> <span class="n">entity</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">Book_</span><span class="o">.</span><span class="na">type</span><span class="o">).</span><span class="na">isNull</span><span class="o">()</span>
				<span class="o">:</span> <span class="n">builder</span><span class="o">.</span><span class="na">equal</span><span class="o">(</span><span class="n">entity</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">Book_</span><span class="o">.</span><span class="na">type</span><span class="o">),</span> <span class="n">type</span><span class="o">)</span>
	<span class="o">);</span>
	<span class="k">return</span> <span class="n">entityManager</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="n">query</span><span class="o">).</span><span class="na">getResultList</span><span class="o">();</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>It&#8217;s even possible to match a parameter of a finder method against a property of an associated entity or embeddable.
The natural syntax would be a parameter declaration like <code>String publisher.name</code>, but because that&#8217;s not legal Java, we can write it as <code>String publisher$name</code>, taking advantage of a legal Java identifier character that nobody ever uses for anything else:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Find</span>
<span class="nc">List</span><span class="o">&lt;</span><span class="nc">Book</span><span class="o">&gt;</span> <span class="nf">getBooksByPublisherName</span><span class="o">(</span><span class="nc">String</span> <span class="n">publisher$name</span><span class="o">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>A finder method may specify <a href="#fetch-profiles">fetch profiles</a>, for example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Find</span><span class="o">(</span><span class="n">namedFetchProfiles</span><span class="o">=</span><span class="n">Book_</span><span class="o">.</span><span class="na">FETCH_WITH_AUTHORS</span><span class="o">)</span>
<span class="nc">Book</span> <span class="nf">getBookWithAuthors</span><span class="o">(</span><span class="nc">String</span> <span class="n">isbn</span><span class="o">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This lets us declare which associations of <code>Book</code> should be pre-fetched by annotating the <code>Book</code> class.</p>
</div>
</div>
<div class="sect2">
<h3 id="paging-and-ordering">6.5. Paging and ordering</h3>
<div class="paragraph">
<p>Optionally, a query method may have additional "magic" parameters which do not map to query parameters:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 19%;">
<col>
<col style="width: 32%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Parameter type</th>
<th class="tableblock halign-left valign-top">Purpose</th>
<th class="tableblock halign-left valign-top">Example argument</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Page</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies a page of query results</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Page.first(20)</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Order&lt;? super E&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies an entity attribute to order by, if <code>E</code> is the entity type returned by the query</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Order.asc(Book_.title)</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>List&lt;Order? super E&gt;</code><br>
(or varargs)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies entity attributes to order by, if <code>E</code> is the entity type returned by the query</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>List.of(Order.asc(Book_.title), Order.asc(Book_.isbn))</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Order&lt;Object[]&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies a column to order by, if the query returns a projection list</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Order.asc(1)</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>List&lt;Object[]&gt;</code><br>
(or varargs)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies columns to order by, if the query returns a projection list</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>List.of(Order.asc(1), Order.desc(2))</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Thus, if we redefine our earlier query method as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">interface</span> <span class="nc">Queries</span> <span class="o">{</span>
    <span class="nd">@HQL</span><span class="o">(</span><span class="s">"from Book where title like :title and type = :type"</span><span class="o">)</span>
    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Book</span><span class="o">&gt;</span> <span class="nf">findBooksByTitleAndType</span><span class="o">(</span><span class="nc">String</span> <span class="n">title</span><span class="o">,</span> <span class="nc">Page</span> <span class="n">page</span><span class="o">,</span> <span class="nc">Order</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="nc">Book</span><span class="o">&gt;...</span> <span class="n">order</span><span class="o">);</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Then we can call it like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nc">List</span><span class="o">&lt;</span><span class="nc">Book</span><span class="o">&gt;</span> <span class="n">books</span> <span class="o">=</span>
        <span class="n">Queries_</span><span class="o">.</span><span class="na">findBooksByTitleAndType</span><span class="o">(</span><span class="n">entityManager</span><span class="o">,</span> <span class="n">titlePattern</span><span class="o">,</span> <span class="nc">Type</span><span class="o">.</span><span class="na">BOOK</span><span class="o">,</span>
                <span class="nc">Page</span><span class="o">.</span><span class="na">page</span><span class="o">(</span><span class="no">RESULTS_PER_PAGE</span><span class="o">,</span> <span class="n">page</span><span class="o">),</span> <span class="nc">Order</span><span class="o">.</span><span class="na">asc</span><span class="o">(</span><span class="n">Book_</span><span class="o">.</span><span class="na">isbn</span><span class="o">));</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="return-types">6.6. Query and finder method return types</h3>
<div class="paragraph">
<p>A query method doesn&#8217;t need to return <code>List</code>.
It might return a single <code>Book</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@HQL</span><span class="o">(</span><span class="s">"where isbn = :isbn"</span><span class="o">)</span>
<span class="nc">Book</span> <span class="nf">findBookByIsbn</span><span class="o">(</span><span class="nc">String</span> <span class="n">isbn</span><span class="o">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>For a query with a projection list, <code>Object[]</code> or <code>List&lt;Object[]&gt;</code> is permitted:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@HQL</span><span class="o">(</span><span class="s">"select isbn, title from Book where isbn = :isbn"</span><span class="o">)</span>
<span class="nc">Object</span><span class="o">[]</span> <span class="nf">findBookAttributesByIsbn</span><span class="o">(</span><span class="nc">String</span> <span class="n">isbn</span><span class="o">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>But when there&#8217;s just one item in the <code>select</code> list, the type of that item should be used:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@HQL</span><span class="o">(</span><span class="s">"select title from Book where isbn = :isbn"</span><span class="o">)</span>
<span class="nc">String</span> <span class="nf">getBookTitleByIsbn</span><span class="o">(</span><span class="nc">String</span> <span class="n">isbn</span><span class="o">);</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@HQL</span><span class="o">(</span><span class="s">"select local datetime"</span><span class="o">)</span>
<span class="nc">LocalDateTime</span> <span class="nf">getServerDateTime</span><span class="o">();</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>A query which returns a selection list may have a query method which repackages the result as a record, as we saw in <a href="#projection-lists">Representing projection lists</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="n">record</span> <span class="nf">IsbnTitle</span><span class="o">(</span><span class="nc">String</span> <span class="n">isbn</span><span class="o">,</span> <span class="nc">String</span> <span class="n">title</span><span class="o">)</span> <span class="o">{}</span>

<span class="nd">@HQL</span><span class="o">(</span><span class="s">"select isbn, title from Book"</span><span class="o">)</span>
<span class="nc">List</span><span class="o">&lt;</span><span class="nc">IsbnTitle</span><span class="o">&gt;</span> <span class="nf">listIsbnAndTitleForEachBook</span><span class="o">(</span><span class="nc">Page</span> <span class="n">page</span><span class="o">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>A query method might even return <code>TypedQuery</code> or <code>SelectionQuery</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@HQL</span><span class="o">(</span><span class="s">"where title like :title"</span><span class="o">)</span>
<span class="nc">SelectionQuery</span><span class="o">&lt;</span><span class="nc">Book</span><span class="o">&gt;</span> <span class="nf">findBooksByTitle</span><span class="o">(</span><span class="nc">String</span> <span class="n">title</span><span class="o">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This is extremely useful at times, since it allows the client to further manipulate the query:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nc">List</span><span class="o">&lt;</span><span class="nc">Book</span><span class="o">&gt;</span> <span class="n">books</span> <span class="o">=</span>
        <span class="n">Queries_</span><span class="o">.</span><span class="na">findBooksByTitle</span><span class="o">(</span><span class="n">entityManager</span><span class="o">,</span> <span class="n">titlePattern</span><span class="o">)</span>
            <span class="o">.</span><span class="na">setOrder</span><span class="o">(</span><span class="nc">Order</span><span class="o">.</span><span class="na">asc</span><span class="o">(</span><span class="n">Book_</span><span class="o">.</span><span class="na">title</span><span class="o">))</span>                   <span class="c1">// order the results</span>
            <span class="o">.</span><span class="na">setPage</span><span class="o">(</span><span class="nc">Page</span><span class="o">.</span><span class="na">page</span><span class="o">(</span><span class="no">RESULTS_PER_PAGE</span><span class="o">,</span> <span class="n">page</span><span class="o">))</span>         <span class="c1">// return the given page of results</span>
            <span class="o">.</span><span class="na">setFlushMode</span><span class="o">(</span><span class="nc">FlushModeType</span><span class="o">.</span><span class="na">COMMIT</span><span class="o">)</span>                 <span class="c1">// don't flush session before query execution</span>
            <span class="o">.</span><span class="na">setReadOnly</span><span class="o">(</span><span class="kc">true</span><span class="o">)</span>                                  <span class="c1">// load the entities in read-only mode</span>
            <span class="o">.</span><span class="na">setCacheStoreMode</span><span class="o">(</span><span class="nc">CacheStoreMode</span><span class="o">.</span><span class="na">BYPASS</span><span class="o">)</span>           <span class="c1">// don't cache the results</span>
            <span class="o">.</span><span class="na">setComment</span><span class="o">(</span><span class="s">"Hello world!"</span><span class="o">)</span>                         <span class="c1">// add a comment to the generated SQL</span>
            <span class="o">.</span><span class="na">getResultList</span><span class="o">();</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>An <code>insert</code>, <code>update</code>, or <code>delete</code> query must return <code>int</code> or <code>void</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@HQL</span><span class="o">(</span><span class="s">"delete from Book"</span><span class="o">)</span>
<span class="kt">int</span> <span class="nf">deleteAllBooks</span><span class="o">();</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@HQL</span><span class="o">(</span><span class="s">"update Book set discontinued = true where isbn = :isbn"</span><span class="o">)</span>
<span class="kt">void</span> <span class="nf">discontinueBook</span><span class="o">(</span><span class="nc">String</span> <span class="n">isbn</span><span class="o">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>On the other hand, finder methods are currently much more limited.
A finder method must return an entity type like <code>Book</code>, or a list of the entity type, <code>List&lt;Book&gt;</code>, for example.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>As you might expect, for a reactive session, all query methods and finder methods must return <code>Uni</code>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="query-validator">6.7. An alternative approach</h3>
<div class="paragraph">
<p>What if you just don&#8217;t like the ideas we&#8217;ve presented in this chapter, preferring to call the <code>Session</code> or <code>EntityManager</code> directly, but you still want compile-time validation for HQL?
Or what if you <em>do</em> like the ideas, but you&#8217;re working on a huge existing codebase full of code you don&#8217;t want to change?</p>
</div>
<div class="paragraph">
<p>Well, there&#8217;s a solution for you, too.
The <a href="https://github.com/hibernate/query-validator/">Query Validator</a> is a separate annotation processor that&#8217;s capable of type-checking HQL strings, not only in annotations, but even when they occur as arguments to <code>createQuery()</code>, <code>createSelectionQuery()</code>, or <code>createMutationQuery()</code>. It&#8217;s even able to check calls to <code>setParameter()</code>, with some restrictions.</p>
</div>
<div class="paragraph">
<p>The Query Validator works in <code>javac</code>, Gradle, Maven, and the Eclipse Java Compiler.</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Unlike the Metamodel Generator, which is a completely bog-standard Java annotation processor based on only standard Java APIs, the Query Validator makes use of internal compiler APIs in <code>javac</code> and <code>ecj</code>. This means it can&#8217;t be guaranteed to work in every Java compiler. The current release is known to work in JDK 11 and above, though JDK 15 or above is preferred.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="tuning-and-performance">7. Tuning and performance</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Once you have a program up and running using Hibernate to access
the database, it&#8217;s inevitable that you&#8217;ll find places where performance is
disappointing or unacceptable.</p>
</div>
<div class="paragraph">
<p>Fortunately, most performance problems are relatively easy to solve with
the tools that Hibernate makes available to you, as long as you keep a
couple of simple principles in mind.</p>
</div>
<div class="paragraph">
<p>First and most important: the reason you&#8217;re using Hibernate is
that it makes things easier. If, for a certain problem, it&#8217;s making
things <em>harder</em>, stop using it. Solve this problem with a different tool
instead.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Just because you&#8217;re using Hibernate in your program doesn&#8217;t mean
you have to use it <em>everywhere</em>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Second: there are two main potential sources of performance bottlenecks in
a program that uses Hibernate:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>too many round trips to the database, and</p>
</li>
<li>
<p>memory consumption associated with the first-level (session) cache.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>So performance tuning primarily involves reducing the number of accesses
to the database, and/or controlling the size of the session cache.</p>
</div>
<div class="paragraph">
<p>But before we get to those more advanced topics, we should start by tuning
the connection pool.</p>
</div>
<div class="sect2">
<h3 id="connection-pool">7.1. Tuning the connection pool</h3>
<div class="paragraph">
<p>The connection pool built in to Hibernate is suitable for testing, but isn&#8217;t intended for use in production.
Instead, Hibernate supports a range of different connection pools, including our favorite, Agroal.</p>
</div>
<div class="paragraph">
<p>To select and configure Agroal, you&#8217;ll need to set some extra configuration properties, in addition to the settings we already saw in <a href="#basic-configuration-settings">Basic configuration settings</a>.
Properties with the prefix <code>hibernate.agroal</code> are passed through to Agroal:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="properties"><span class="c"># configure Agroal connection pool
</span><span class="err">hibernate.agroal.maxSize</span> <span class="err">20</span>
<span class="err">hibernate.agroal.minSize</span> <span class="err">10</span>
<span class="err">hibernate.agroal.acquisitionTimeout</span> <span class="err">PT1s</span>
<span class="err">hibernate.agroal.reapTimeout</span> <span class="err">PT10s</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As long as you set at least one property with the prefix <code>hibernate.agroal</code>, the <code>AgroalConnectionProvider</code> will be selected automatically.
There&#8217;s many to choose from:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 42. Settings for configuring Agroal</caption>
<colgroup>
<col style="width: 37%;">
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Configuration property name</th>
<th class="tableblock halign-left valign-top">Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>hibernate.agroal.maxSize</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The maximum number of connections present on the pool</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>hibernate.agroal.minSize</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The minimum number of connections present on the pool</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>hibernate.agroal.initialSize</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The number of connections added to the pool when it is started</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>hibernate.agroal.maxLifetime</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The maximum amount of time a connection can live, after which it is removed from the pool</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>hibernate.agroal.acquisitionTimeout</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The maximum amount of time a thread can wait for a connection, after which an exception is thrown instead</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>hibernate.agroal.reapTimeout</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The duration for eviction of idle connections</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>hibernate.agroal.leakTimeout</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The duration of time a connection can be held without causing a leak to be reported</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>hibernate.agroal.idleValidationTimeout</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A foreground validation is executed if a connection has been idle on the pool for longer than this duration</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>hibernate.agroal.validationTimeout</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The interval between background validation checks</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>hibernate.agroal.initialSql</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A SQL command to be executed when a connection is created</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The following settings are common to all connection pools supported by Hibernate:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 43. Common settings for connection pools</caption>
<colgroup>
<col style="width: 37%;">
<col>
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>hibernate.connection.autocommit</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The default autocommit mode</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>hibernate.connection.isolation</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The default transaction isolation level</p></td>
</tr>
</tbody>
</table>
<div class="sidebarblock">
<div class="content">
<div class="title">Container-managed datasources</div>
<div class="paragraph">
<p>In a container environment, you usually don&#8217;t need to configure a connection pool through Hibernate.
Instead, you&#8217;ll use a container-managed datasource, as we saw in <a href="#basic-configuration-settings">Basic configuration settings</a>.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="statement-batching">7.2. Enabling statement batching</h3>
<div class="paragraph">
<p>An easy way to improve performance of some transactions, with almost no work at all, is to turn on automatic DML statement batching.
Batching only helps in cases where a program executes many inserts, updates, or deletes against the same table in a single transaction.</p>
</div>
<div class="paragraph">
<p>All we need to do is set a single property:</p>
</div>
<table class="tableblock frame-all grid-all fit-content stretch">
<caption class="title">Table 44. Enabling JDBC batching</caption>
<colgroup>
<col>
<col>
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Configuration property name</th>
<th class="tableblock halign-left valign-top">Purpose</th>
<th class="tableblock halign-left valign-top">Alternative</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>hibernate.jdbc.batch_size</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Maximum batch size for SQL statement batching</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>setJdbcBatchSize()</code></p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Even better than DML statement batching is the use of HQL <code>update</code> or <code>delete</code> queries, or even native SQL that calls a stored procedure!</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="association-fetching">7.3. Association fetching</h3>
<div class="paragraph">
<p>Achieving high performance in ORM means minimizing the number of round trips to the database. This goal should be uppermost in your mind whenever you&#8217;re writing data access code with Hibernate. The most fundamental rule of thumb in ORM is:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>explicitly specify all the data you&#8217;re going to need right at the start of a session/transaction, and fetch it immediately in one or two queries,</p>
</li>
<li>
<p>and only then start navigating associations between persistent entities.</p>
</li>
</ul>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="images/fetching.png" alt="Fetching process" width="700">
</div>
</div>
<div class="paragraph">
<p>Without question, the most common cause of poorly-performing data access code in Java programs is the problem of <em>N+1 selects</em>.
Here, a list of <em>N</em> rows is retrieved from the database in an initial query, and then associated instances of a related entity are fetched using <em>N</em> subsequent queries.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This isn&#8217;t a bug or limitation of Hibernate; this problem even affects typical handwritten JDBC code behind DAOs.
Only you, the developer, can solve this problem, because only you know ahead of time what data you&#8217;re going to need in a given unit of work.
But that&#8217;s OK.
Hibernate gives you all the tools you need.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In this section we&#8217;re going to discuss different ways to avoid such "chatty" interaction with the database.</p>
</div>
<div class="paragraph">
<p>Hibernate provides several strategies for efficiently fetching associations and avoiding <em>N+1</em> selects:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>outer join fetching</em>—where an association is fetched using a <code>left outer join</code>,</p>
</li>
<li>
<p><em>batch fetching</em>—where an association is fetched using a subsequent <code>select</code> with a batch of primary keys, and</p>
</li>
<li>
<p><em>subselect fetching</em>—where an association is fetched using a subsequent <code>select</code> with keys re-queried in a subselect.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Of these, you should almost always use outer join fetching.
But let&#8217;s consider the alternatives first.</p>
</div>
</div>
<div class="sect2">
<h3 id="batch-subselect-fetch">7.4. Batch fetching and subselect fetching</h3>
<div class="paragraph">
<p>Consider the following code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nc">List</span><span class="o">&lt;</span><span class="nc">Book</span><span class="o">&gt;</span> <span class="n">books</span> <span class="o">=</span>
        <span class="n">session</span><span class="o">.</span><span class="na">createSelectionQuery</span><span class="o">(</span><span class="s">"from Book order by isbn"</span><span class="o">,</span> <span class="nc">Book</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
            <span class="o">.</span><span class="na">getResultList</span><span class="o">();</span>
<span class="n">books</span><span class="o">.</span><span class="na">forEach</span><span class="o">(</span><span class="n">book</span> <span class="o">-&gt;</span> <span class="n">book</span><span class="o">.</span><span class="na">getAuthors</span><span class="o">().</span><span class="na">forEach</span><span class="o">(</span><span class="n">author</span> <span class="o">-&gt;</span> <span class="n">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">book</span><span class="o">.</span><span class="na">title</span> <span class="o">+</span> <span class="s">" by "</span> <span class="o">+</span> <span class="n">author</span><span class="o">.</span><span class="na">name</span><span class="o">)));</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This code is <em>very</em> inefficient, resulting, by default, in the execution of <em>N+1</em> <code>select</code> statements, where <em>n</em> is the number of <code>Book</code>s.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s see how we can improve on that.</p>
</div>
<h5 id="_sql_for_batch_fetching" class="discrete">SQL for batch fetching</h5>
<div class="paragraph">
<p>With batch fetching enabled, Hibernate might execute the following SQL on PostgreSQL:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sql"><span class="cm">/* initial query for Books */</span>
<span class="k">select</span> <span class="n">b1_0</span><span class="p">.</span><span class="n">isbn</span><span class="p">,</span><span class="n">b1_0</span><span class="p">.</span><span class="n">price</span><span class="p">,</span><span class="n">b1_0</span><span class="p">.</span><span class="n">published</span><span class="p">,</span><span class="n">b1_0</span><span class="p">.</span><span class="n">publisher_id</span><span class="p">,</span><span class="n">b1_0</span><span class="p">.</span><span class="n">title</span>
<span class="k">from</span> <span class="n">Book</span> <span class="n">b1_0</span>
<span class="k">order</span> <span class="k">by</span> <span class="n">b1_0</span><span class="p">.</span><span class="n">isbn</span>

<span class="cm">/* first batch of associated Authors */</span>
<span class="k">select</span> <span class="n">a1_0</span><span class="p">.</span><span class="n">books_isbn</span><span class="p">,</span><span class="n">a1_1</span><span class="p">.</span><span class="n">id</span><span class="p">,</span><span class="n">a1_1</span><span class="p">.</span><span class="n">bio</span><span class="p">,</span><span class="n">a1_1</span><span class="p">.</span><span class="n">name</span>
<span class="k">from</span> <span class="n">Book_Author</span> <span class="n">a1_0</span>
    <span class="k">join</span> <span class="n">Author</span> <span class="n">a1_1</span> <span class="k">on</span> <span class="n">a1_1</span><span class="p">.</span><span class="n">id</span><span class="o">=</span><span class="n">a1_0</span><span class="p">.</span><span class="n">authors_id</span>
<span class="k">where</span> <span class="n">a1_0</span><span class="p">.</span><span class="n">books_isbn</span> <span class="o">=</span> <span class="k">any</span> <span class="p">(</span><span class="o">?</span><span class="p">)</span>

<span class="cm">/* second batch of associated Authors */</span>
<span class="k">select</span> <span class="n">a1_0</span><span class="p">.</span><span class="n">books_isbn</span><span class="p">,</span><span class="n">a1_1</span><span class="p">.</span><span class="n">id</span><span class="p">,</span><span class="n">a1_1</span><span class="p">.</span><span class="n">bio</span><span class="p">,</span><span class="n">a1_1</span><span class="p">.</span><span class="n">name</span>
<span class="k">from</span> <span class="n">Book_Author</span> <span class="n">a1_0</span>
    <span class="k">join</span> <span class="n">Author</span> <span class="n">a1_1</span> <span class="k">on</span> <span class="n">a1_1</span><span class="p">.</span><span class="n">id</span><span class="o">=</span><span class="n">a1_0</span><span class="p">.</span><span class="n">authors_id</span>
<span class="k">where</span> <span class="n">a1_0</span><span class="p">.</span><span class="n">books_isbn</span> <span class="o">=</span> <span class="k">any</span> <span class="p">(</span><span class="o">?</span><span class="p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The first <code>select</code> statement queries and retrieves <code>Book</code>s.
The second and third queries fetch the associated <code>Author</code>s in batches.
The number of batches required depends on the configured <em>batch size</em>.
Here, two batches were required, so two SQL statements were executed.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The SQL for batch fetching looks slightly different depending on the database.
Here, on PostgreSQL, Hibernate passes a batch of primary key values as a SQL <code>ARRAY</code>.</p>
</div>
</td>
</tr>
</table>
</div>
<h5 id="_sql_for_subselect_fetching" class="discrete">SQL for subselect fetching</h5>
<div class="paragraph">
<p>On the other hand, with subselect fetching, Hibernate would execute this SQL:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sql"><span class="cm">/* initial query for Books */</span>
<span class="k">select</span> <span class="n">b1_0</span><span class="p">.</span><span class="n">isbn</span><span class="p">,</span><span class="n">b1_0</span><span class="p">.</span><span class="n">price</span><span class="p">,</span><span class="n">b1_0</span><span class="p">.</span><span class="n">published</span><span class="p">,</span><span class="n">b1_0</span><span class="p">.</span><span class="n">publisher_id</span><span class="p">,</span><span class="n">b1_0</span><span class="p">.</span><span class="n">title</span>
<span class="k">from</span> <span class="n">Book</span> <span class="n">b1_0</span>
<span class="k">order</span> <span class="k">by</span> <span class="n">b1_0</span><span class="p">.</span><span class="n">isbn</span>

<span class="cm">/* fetch all associated Authors */</span>
<span class="k">select</span> <span class="n">a1_0</span><span class="p">.</span><span class="n">books_isbn</span><span class="p">,</span><span class="n">a1_1</span><span class="p">.</span><span class="n">id</span><span class="p">,</span><span class="n">a1_1</span><span class="p">.</span><span class="n">bio</span><span class="p">,</span><span class="n">a1_1</span><span class="p">.</span><span class="n">name</span>
<span class="k">from</span> <span class="n">Book_Author</span> <span class="n">a1_0</span>
    <span class="k">join</span> <span class="n">Author</span> <span class="n">a1_1</span> <span class="k">on</span> <span class="n">a1_1</span><span class="p">.</span><span class="n">id</span><span class="o">=</span><span class="n">a1_0</span><span class="p">.</span><span class="n">authors_id</span>
<span class="k">where</span> <span class="n">a1_0</span><span class="p">.</span><span class="n">books_isbn</span> <span class="k">in</span> <span class="p">(</span><span class="k">select</span> <span class="n">b1_0</span><span class="p">.</span><span class="n">isbn</span> <span class="k">from</span> <span class="n">Book</span> <span class="n">b1_0</span><span class="p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice that the first query is re-executed in a subselect in the second query.
The execution of the subselect is likely to be relatively inexpensive, since the data should already be cached by the database.
Clever, huh?</p>
</div>
<h5 id="_enabling_the_use_of_batch_or_subselect_fetching" class="discrete">Enabling the use of batch or subselect fetching</h5>
<div class="paragraph">
<p>Both batch fetching and subselect fetching are disabled by default, but we may enable one or the other globally using properties.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 45. Configuration settings to enable batch and subselect fetching</caption>
<colgroup>
<col style="width: 32%;">
<col>
<col style="width: 28%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Configuration property name</th>
<th class="tableblock halign-left valign-top">Property value</th>
<th class="tableblock halign-left valign-top">Alternatives</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>hibernate.default_batch_fetch_size</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A sensible batch size <code>&gt;1</code> to enable batch fetching</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@BatchSize()</code>, <code>setFetchBatchSize()</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>hibernate.use_subselect_fetch</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>true</code> to enable subselect fetching</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@Fetch(SUBSELECT)</code>, <code>setSubselectFetchingEnabled()</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Alternatively, we can enable one or the other in a given session:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="n">session</span><span class="o">.</span><span class="na">setFetchBatchSize</span><span class="o">(</span><span class="mi">5</span><span class="o">);</span>
<span class="n">session</span><span class="o">.</span><span class="na">setSubselectFetchingEnabled</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>We may request subselect fetching more selectively by annotating a collection or many-valued association with the <code>@Fetch</code> annotation.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@ManyToMany</span> <span class="nd">@Fetch</span><span class="o">(</span><span class="no">SUBSELECT</span><span class="o">)</span>
<span class="nc">Set</span><span class="o">&lt;</span><span class="nc">Author</span><span class="o">&gt;</span> <span class="n">authors</span><span class="o">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that <code>@Fetch(SUBSELECT)</code> has the same effect as <code>@Fetch(SELECT)</code>, except after execution of a HQL or criteria query.
But after query execution, <code>@Fetch(SUBSELECT)</code> is able to much more efficiently fetch associations.</p>
</div>
<div class="paragraph">
<p>Later, we&#8217;ll see how we can use <a href="#fetch-profiles">fetch profiles</a> to do this even more selectively.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>That&#8217;s all there is to it.
Too easy, right?</p>
</div>
<div class="paragraph">
<p>Sadly, that&#8217;s not the end of the story.
While batch fetching might <em>mitigate</em> problems involving N+1 selects, it won&#8217;t solve them.
The truly correct solution is to fetch associations using joins.
Batch fetching (or subselect fetching) can only be the <em>best</em> solution in rare cases where outer join fetching would result in a cartesian product and a huge result set.</p>
</div>
<div class="paragraph">
<p>But batch fetching and subselect fetching have one important characteristic in common: they can be performed <em>lazily</em>.
This is, in principle, pretty convenient.
When we query data, and then navigate an object graph, lazy fetching saves us the effort of planning ahead.
It turns out that this is a convenience we&#8217;re going to have to surrender.</p>
</div>
</div>
<div class="sect2">
<h3 id="join-fetch">7.5. Join fetching</h3>
<div class="paragraph">
<p>Outer join fetching is usually the best way to fetch associations, and it&#8217;s what we use most of the time.
Unfortunately, by its very nature, join fetching simply can&#8217;t be lazy.
So to make use of join fetching, we must plan ahead.
Our general advice is:</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Avoid the use of lazy fetching, which is often the source of N+1 selects.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now, we&#8217;re not saying that associations should be mapped for eager fetching by default!
That would be a terrible idea, resulting in simple session operations that fetch almost the entire database.
Therefore:</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Most associations should be mapped for lazy fetching by default.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>It sounds as if this tip is in contradiction to the previous one, but it&#8217;s not.
It&#8217;s saying that you must explicitly specify eager fetching for associations precisely when and where they are needed.</p>
</div>
<div class="paragraph">
<p>If we need eager join fetching in some particular transaction, we have four different ways to specify that.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 40%;">
<col>
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Passing a JPA <code>EntityGraph</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">We&#8217;ve already seen this in <a href="#entity-graph">Entity graphs and eager fetching</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifying a named <em>fetch profile</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">We&#8217;ll discuss this approach later in <a href="#fetch-profiles">Named fetch profiles</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Using <code>left join fetch</code> in HQL/JPQL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">See <a href="https://docs.jboss.org/hibernate/orm/6.3/querylanguage/html_single/Hibernate_Query_Language.html"><em>A Guide to Hibernate Query Language</em></a> for details</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Using <code>From.fetch()</code> in a criteria query</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Same semantics as <code>join fetch</code> in HQL</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Typically, a query is the most convenient option.
Here&#8217;s how we can ask for join fetching in HQL:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nc">List</span><span class="o">&lt;</span><span class="nc">Book</span><span class="o">&gt;</span> <span class="n">booksWithJoinFetchedAuthors</span> <span class="o">=</span>
        <span class="n">session</span><span class="o">.</span><span class="na">createSelectionQuery</span><span class="o">(</span><span class="s">"from Book join fetch authors order by isbn"</span><span class="o">)</span>
            <span class="o">.</span><span class="na">getResultList</span><span class="o">();</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And this is the same query, written using the criteria API:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kt">var</span> <span class="n">builder</span> <span class="o">=</span> <span class="n">sessionFactory</span><span class="o">.</span><span class="na">getCriteriaBuilder</span><span class="o">();</span>
<span class="kt">var</span> <span class="n">query</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="nc">Book</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="kt">var</span> <span class="n">book</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="nc">Book</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="n">book</span><span class="o">.</span><span class="na">fetch</span><span class="o">(</span><span class="n">Book_</span><span class="o">.</span><span class="na">authors</span><span class="o">);</span>
<span class="n">query</span><span class="o">.</span><span class="na">select</span><span class="o">(</span><span class="n">book</span><span class="o">);</span>
<span class="n">query</span><span class="o">.</span><span class="na">orderBy</span><span class="o">(</span><span class="n">builder</span><span class="o">.</span><span class="na">asc</span><span class="o">(</span><span class="n">book</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">Book_</span><span class="o">.</span><span class="na">isbn</span><span class="o">)));</span>
<span class="nc">List</span><span class="o">&lt;</span><span class="nc">Book</span><span class="o">&gt;</span> <span class="n">booksWithJoinFetchedAuthors</span> <span class="o">=</span>
        <span class="n">session</span><span class="o">.</span><span class="na">createSelectionQuery</span><span class="o">(</span><span class="n">query</span><span class="o">).</span><span class="na">getResultList</span><span class="o">();</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Either way, a single SQL <code>select</code> statement is executed:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sql"><span class="k">select</span> <span class="n">b1_0</span><span class="p">.</span><span class="n">isbn</span><span class="p">,</span><span class="n">a1_0</span><span class="p">.</span><span class="n">books_isbn</span><span class="p">,</span><span class="n">a1_1</span><span class="p">.</span><span class="n">id</span><span class="p">,</span><span class="n">a1_1</span><span class="p">.</span><span class="n">bio</span><span class="p">,</span><span class="n">a1_1</span><span class="p">.</span><span class="n">name</span><span class="p">,</span><span class="n">b1_0</span><span class="p">.</span><span class="n">price</span><span class="p">,</span><span class="n">b1_0</span><span class="p">.</span><span class="n">published</span><span class="p">,</span><span class="n">b1_0</span><span class="p">.</span><span class="n">publisher_id</span><span class="p">,</span><span class="n">b1_0</span><span class="p">.</span><span class="n">title</span>
<span class="k">from</span> <span class="n">Book</span> <span class="n">b1_0</span>
    <span class="k">join</span> <span class="p">(</span><span class="n">Book_Author</span> <span class="n">a1_0</span> <span class="k">join</span> <span class="n">Author</span> <span class="n">a1_1</span> <span class="k">on</span> <span class="n">a1_1</span><span class="p">.</span><span class="n">id</span><span class="o">=</span><span class="n">a1_0</span><span class="p">.</span><span class="n">authors_id</span><span class="p">)</span>
        <span class="k">on</span> <span class="n">b1_0</span><span class="p">.</span><span class="n">isbn</span><span class="o">=</span><span class="n">a1_0</span><span class="p">.</span><span class="n">books_isbn</span>
<span class="k">order</span> <span class="k">by</span> <span class="n">b1_0</span><span class="p">.</span><span class="n">isbn</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Much better!</p>
</div>
<div class="paragraph">
<p>Join fetching, despite its non-lazy nature, is clearly more efficient than either batch or subselect fetching, and this is the source of our recommendation to avoid the use of lazy fetching.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>There&#8217;s one interesting case where join fetching becomes inefficient: when we fetch two many-valued associations <em>in parallel</em>.
Imagine we wanted to fetch both <code>Author.books</code> and <code>Author.royaltyStatements</code> in some unit of work.
Joining both collections in a single query would result in a cartesian product of tables, and a large SQL result set.
Subselect fetching comes to the rescue here, allowing us to fetch <code>books</code> using a join, and <code>royaltyStatements</code> using a single subsequent <code>select</code>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Of course, an alternative way to avoid many round trips to the database is to cache the data we need in the Java client.
If we&#8217;re expecting to find the associated data in a local cache, we probably don&#8217;t need join fetching at all.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>But what if we can&#8217;t be <em>certain</em> that all associated data will be in the cache?
In that case, we might be able to reduce the cost of cache misses by enabling batch fetching.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="second-level-cache">7.6. The second-level cache</h3>
<div class="paragraph">
<p>A classic way to reduce the number of accesses to the database is to use a second-level cache, allowing  data cached in memory to be shared between sessions.</p>
</div>
<div class="paragraph">
<p>By nature, a second-level cache tends to undermine the ACID properties of transaction processing in a relational database.
We <em>don&#8217;t</em> use a distributed transaction with two-phase commit to ensure that changes to the cache and database happen atomically.
So a second-level cache is often by far the easiest way to improve the performance of a system, but only at the cost of making it much more difficult to reason about concurrency.
And so the cache is a potential source of bugs which are difficult to isolate and reproduce.</p>
</div>
<div class="paragraph">
<p>Therefore, by default, an entity is not eligible for storage in the second-level cache.
We must explicitly mark each entity that will  be stored in the second-level cache with the <code>@Cache</code> annotation from <code>org.hibernate.annotations</code>.</p>
</div>
<div class="paragraph">
<p>But that&#8217;s still not enough.
Hibernate does not itself contain an implementation of a second-level cache, so it&#8217;s necessary to configure an external <em>cache provider</em>.</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Caching is disabled by default.
To minimize the risk of data loss, we force you to stop and think before any entity goes into the cache.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Hibernate segments the second-level cache into named <em>regions</em>, one for each:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>mapped entity hierarchy or</p>
</li>
<li>
<p>collection role.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For example, there might be separate cache regions for <code>Author</code>, <code>Book</code>, <code>Author.books</code>, and <code>Book.authors</code>.</p>
</div>
<div class="paragraph">
<p>Each region is permitted its own policies for expiry, persistence, and replication. These policies must be configured externally to Hibernate.</p>
</div>
<div class="paragraph">
<p>The appropriate policies depend on the kind of data an entity represents. For example, a program might have different caching policies for "reference" data, for transactional data, and for data used for analytics. Ordinarily, the implementation of those policies is the responsibility of the underlying cache implementation.</p>
</div>
</div>
<div class="sect2">
<h3 id="enable-second-level-cache">7.7. Specifying which data is cached</h3>
<div class="paragraph">
<p>By default, no data is eligible for storage in the second-level cache.</p>
</div>
<div class="paragraph">
<p>An entity hierarchy or collection role may be assigned a region using the <code>@Cache</code> annotation.
If no region name is explicitly specified, the region name is just the name of the entity class or collection role.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Entity</span>
<span class="nd">@Cache</span><span class="o">(</span><span class="n">usage</span><span class="o">=</span><span class="no">NONSTRICT_READ_WRITE</span><span class="o">,</span> <span class="n">region</span><span class="o">=</span><span class="s">"Publishers"</span><span class="o">)</span>
<span class="kd">class</span> <span class="nc">Publisher</span> <span class="o">{</span>
    <span class="o">...</span>

    <span class="nd">@Cache</span><span class="o">(</span><span class="n">usage</span><span class="o">=</span><span class="no">READ_WRITE</span><span class="o">,</span> <span class="n">region</span><span class="o">=</span><span class="s">"PublishedBooks"</span><span class="o">)</span>
    <span class="nd">@OneToMany</span><span class="o">(</span><span class="n">mappedBy</span><span class="o">=</span><span class="n">Book_</span><span class="o">.</span><span class="na">PUBLISHER</span><span class="o">)</span>
    <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">Book</span><span class="o">&gt;</span> <span class="n">books</span><span class="o">;</span>

    <span class="o">...</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The cache defined by a <code>@Cache</code> annotation is automatically utilized by Hibernate to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>retrieve an entity by id when <code>find()</code> is called, or</p>
</li>
<li>
<p>to resolve an association by id.</p>
</li>
</ul>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The <code>@Cache</code> annotation must be specified on the <em>root class</em> of an entity inheritance hierarchy.
It&#8217;s an error to place it on a subclass entity.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <code>@Cache</code> annotation always specifies a <a href="https://docs.jboss.org/hibernate/orm/6.3/javadocs/org/hibernate/annotations/CacheConcurrencyStrategy.html"><code>CacheConcurrencyStrategy</code></a>, a policy governing access to the second-level cache by concurrent transactions.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 46. Cache concurrency</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 30%;">
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Concurrency policy</th>
<th class="tableblock halign-left valign-top">Interpretation</th>
<th class="tableblock halign-left valign-top">Explanation</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>READ_ONLY</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>Immutable data</p>
</li>
<li>
<p>Read-only access</p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Indicates that the cached object is immutable, and is never updated. If an entity with this cache concurrency is updated, an exception is thrown.</p>
<p class="tableblock">This is the simplest, safest, and best-performing cache concurrency strategy. It&#8217;s particularly suitable for so-called "reference" data.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>NONSTRICT_READ_WRITE</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>Concurrent updates are extremely improbable</p>
</li>
<li>
<p>Read/write access with no locking</p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Indicates that the cached object is sometimes updated, but that it&#8217;s extremely unlikely that two transactions will attempt to update the same item of data at the same time.</p>
<p class="tableblock">This strategy does not use locks. When an item is updated, the cache is invalidated both before and after completion of the updating transaction. But without locking, it&#8217;s impossible to completely rule out the possibility of a second transaction storing or retrieving stale data in or from the cache during the completion process of the first transaction.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>READ_WRITE</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>Concurrent updates are possible but not common</p>
</li>
<li>
<p>Read/write access using soft locks</p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Indicates a non-vanishing likelihood that two concurrent transactions attempt to update the same item of data simultaneously.</p>
</div>
<div class="paragraph">
<p>This strategy uses "soft" locks to prevent concurrent transactions from retrieving or storing a stale item from or in the cache during the transaction completion process. A soft lock is simply a marker entry placed in the cache while the updating transaction completes.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A second transaction may not read the item from the cache while the soft lock is present, and instead simply proceeds to read the item directly from the database, exactly as if a regular cache miss had occurred.</p>
</li>
<li>
<p>Similarly, the soft lock also prevents this second transaction from storing a stale item to the cache when it returns from its round trip to the database with something that might not quite be the latest version.</p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>TRANSACTIONAL</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>Concurrent updates are frequent</p>
</li>
<li>
<p>Transactional access</p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Indicates that concurrent writes are common, and the only way to maintain synchronization between the second-level cache and the database is via the use of a fully transactional cache provider. In this case, the cache and the database must cooperate via JTA or the XA protocol, and Hibernate itself takes on little responsibility for maintaining the integrity of the cache.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Which policies make sense may also depend on the underlying second-level cache implementation.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>JPA has a similar annotation, named <code>@Cacheable</code>.
Unfortunately, it&#8217;s almost useless to us, since:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>it provides no way to specify any information about the nature of the cached entity and how its cache should be managed, and</p>
</li>
<li>
<p>it may not be used to annotate associations, and so we can&#8217;t even use it to mark collection roles as eligible for storage in the second-level cache.</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="natural-id-cache">7.8. Caching by natural id</h3>
<div class="paragraph">
<p>If our entity has a <a href="#natural-id-attributes">natural id</a>, we can enable an additional cache, which holds cross-references from natural id to primary id, by annotating the entity <code>@NaturalIdCache</code>.
By default, the natural id cache is stored in a dedicated region of the second-level cache, separate from the cached entity data.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Entity</span>
<span class="nd">@Cache</span><span class="o">(</span><span class="n">usage</span><span class="o">=</span><span class="no">READ_WRITE</span><span class="o">,</span> <span class="n">region</span><span class="o">=</span><span class="s">"Book"</span><span class="o">)</span>
<span class="nd">@NaturalIdCache</span><span class="o">(</span><span class="n">region</span><span class="o">=</span><span class="s">"BookIsbn"</span><span class="o">)</span>
<span class="kd">class</span> <span class="nc">Book</span> <span class="o">{</span>
    <span class="o">...</span>
    <span class="nd">@NaturalId</span>
    <span class="nc">String</span> <span class="n">isbn</span><span class="o">;</span>

    <span class="nd">@NaturalId</span>
    <span class="kt">int</span> <span class="n">printing</span><span class="o">;</span>
    <span class="o">...</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This cache is utilized when the entity is retrieved using one of the operations of <code>Session</code> which performs <a href="#load-access">lookup by natural id</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Since the natural id cache doesn&#8217;t contain the actual state of the entity, it doesn&#8217;t make sense to annotate an entity <code>@NaturalIdCache</code> unless it&#8217;s already eligible for storage in the second-level cache, that is, unless it&#8217;s also annotated <code>@Cache</code>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>It&#8217;s worth noticing that, unlike the primary identifier of an entity, a natural id might be mutable.</p>
</div>
<div class="paragraph">
<p>We must now consider a subtlety that often arises when we have to deal with so-called "reference data", that is, data which fits easily in memory, and doesn&#8217;t change much.</p>
</div>
</div>
<div class="sect2">
<h3 id="caching-and-fetching">7.9. Caching and association fetching</h3>
<div class="paragraph">
<p>Let&#8217;s consider again our <code>Publisher</code> class:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Cache</span><span class="o">(</span><span class="n">usage</span><span class="o">=</span><span class="no">NONSTRICT_READ_WRITE</span><span class="o">,</span> <span class="n">region</span><span class="o">=</span><span class="s">"Publishers"</span><span class="o">)</span>
<span class="nd">@Entity</span>
<span class="kd">class</span> <span class="nc">Publisher</span> <span class="o">{</span> <span class="o">...</span> <span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Data about publishers doesn&#8217;t change very often, and there aren&#8217;t so many of them.
Suppose we&#8217;ve set everything up so that the publishers are almost <em>always</em> available in the second-level cache.</p>
</div>
<div class="paragraph">
<p>Then in this case we need to think carefully about associations of type <code>Publisher</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@ManyToOne</span>
<span class="nc">Publisher</span> <span class="n">publisher</span><span class="o">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>There&#8217;s no need for this association to be lazily fetched, since we&#8217;re expecting it to be available in memory, so we won&#8217;t set it <code>fetch=LAZY</code>.
But on the other hand, if we leave it marked for eager fetching then, by default, Hibernate will often fetch it using a join.
This places completely unnecessary load on the database.</p>
</div>
<div class="paragraph">
<p>The solution is the <code>@Fetch</code> annotation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@ManyToOne</span> <span class="nd">@Fetch</span><span class="o">(</span><span class="no">SELECT</span><span class="o">)</span>
<span class="nc">Publisher</span> <span class="n">publisher</span><span class="o">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>By annotating the association <code>@Fetch(SELECT)</code>, we suppress join fetching, giving Hibernate a chance to find the associated <code>Publisher</code> in the cache.</p>
</div>
<div class="paragraph">
<p>Therefore, we arrive at this rule of thumb:</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Many-to-one associations to "reference data", or to any other data that will almost always be available in the cache, should be mapped <code>EAGER</code>,<code>SELECT</code>.</p>
</div>
<div class="paragraph">
<p>Other associations, as we&#8217;ve <a href="#lazy-problem">already made clear</a>, should be <code>LAZY</code>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Once we&#8217;ve marked an entity or collection as eligible for storage in the second-level cache, we still need to set up an actual cache.</p>
</div>
</div>
<div class="sect2">
<h3 id="second-level-cache-configuration">7.10. Configuring the second-level cache provider</h3>
<div class="paragraph">
<p>Configuring a second-level cache provider is a rather involved topic, and quite outside the scope of this document.
But in case it helps, we often test Hibernate with the following configuration, which uses EHCache as the cache implementation, as above in <a href="#optional-dependencies">Optional dependencies</a>:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 47. EHCache configuration</caption>
<colgroup>
<col style="width: 35%;">
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Configuration property name</th>
<th class="tableblock halign-left valign-top">Property value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>hibernate.cache.region.factory_class</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>jcache</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>hibernate.javax.cache.uri</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>/ehcache.xml</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>If you&#8217;re using EHCache, you&#8217;ll also need to include an <code>ehcache.xml</code> file
that explicitly configures the behavior of each cache region belonging to
your entities and collections.
You&#8217;ll find more information about configuring EHCache <a href="https://www.ehcache.org/documentation/">here</a>.</p>
</div>
<div class="paragraph">
<p>We may use any other implementation of JCache, such as <a href="https://github.com/ben-manes/caffeine/">Caffeine</a>.
JCache automatically selects whichever implementation it finds on the classpath.
If there are multiple implementations on the classpath, we must disambiguate using:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 48. Disambiguating the JCache implementation</caption>
<colgroup>
<col style="width: 35%;">
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Configuration property name</th>
<th class="tableblock halign-left valign-top">Property value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>hibernate.javax.cache.provider</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The implementation of <code>javax.cache.spiCachingProvider</code>, for example:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col>
<col style="width: 20%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.ehcache.jsr107.EhcacheCachingProvider</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">for EHCache</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>com.github.benmanes.caffeine.jcache.spi.CaffeineCachingProvider</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">for Caffeine</p></td>
</tr>
</tbody>
</table></div></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Alternatively, to use Infinispan as the cache implementation, the following settings are required:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 49. Infinispan provider configuration</caption>
<colgroup>
<col style="width: 35%;">
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Configuration property name</th>
<th class="tableblock halign-left valign-top">Property value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>hibernate.cache.region.factory_class</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>infinispan</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>hibernate.cache.infinispan.cfg</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Path to infinispan configuration file, for example:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col>
<col style="width: 35%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org/infinispan/hibernate/cache/commons/builder/infinispan-configs.xml</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">for a distributed cache</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org/infinispan/hibernate/cache/commons/builder/infinispan-configs-local.xml</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">to test with local cache</p></td>
</tr>
</tbody>
</table></div></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Infinispan is usually used when distributed caching is required.
There&#8217;s more about using Infinispan with Hibernate <a href="https://infinispan.org/docs/stable/titles/hibernate/hibernate.html">here</a>.</p>
</div>
<div class="paragraph">
<p>Finally, there&#8217;s a way to globally disable the second-level cache:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 50. Setting to disable caching</caption>
<colgroup>
<col style="width: 35%;">
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Configuration property name</th>
<th class="tableblock halign-left valign-top">Property value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>hibernate.cache.use_second_level_cache</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>true</code> to enable caching, or <code>false</code> to disable it</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>When <code>hibernate.cache.region.factory_class</code> is set, this property defaults to <code>true</code>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This setting lets us easily disable the second-level cache completely when troubleshooting or profiling performance.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can find much more information about the second-level cache in the <a href="https://docs.jboss.org/hibernate/orm/6.3/userguide/html_single/Hibernate_User_Guide.html#caching">User Guide</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="query-cache">7.11. Caching query result sets</h3>
<div class="paragraph">
<p>The caches we&#8217;ve described above are only used to optimize lookups by id or by natural id.
Hibernate also has a way to cache the result sets of queries, though this is only rarely an efficient thing to do.</p>
</div>
<div class="paragraph">
<p>The query cache must be enabled explicitly:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 51. Setting to enable the query cache</caption>
<colgroup>
<col style="width: 35%;">
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Configuration property name</th>
<th class="tableblock halign-left valign-top">Property value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>hibernate.cache.use_query_cache</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>true</code> to enable the query cache</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>To cache the results of a query, call <code>SelectionQuery.setCacheable(true)</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="n">session</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="s">"from Product where discontinued = false"</span><span class="o">)</span>
    <span class="o">.</span><span class="na">setCacheable</span><span class="o">(</span><span class="kc">true</span><span class="o">)</span>
    <span class="o">.</span><span class="na">getResultList</span><span class="o">();</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>By default, the query result set is stored in a cache region named <code>default-query-results-region</code>.
Since different queries should have different caching policies, it&#8217;s common to explicitly specify a region name:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="n">session</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="s">"from Product where discontinued = false"</span><span class="o">)</span>
    <span class="o">.</span><span class="na">setCacheable</span><span class="o">(</span><span class="kc">true</span><span class="o">)</span>
    <span class="o">.</span><span class="na">setCacheRegion</span><span class="o">(</span><span class="s">"ProductCatalog"</span><span class="o">)</span>
    <span class="o">.</span><span class="na">getResultList</span><span class="o">();</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>A result set is cached together with a <em>logical timestamp</em>.
By "logical", we mean that it doesn&#8217;t actually increase linearly with time, and in particular it&#8217;s not the system time.</p>
</div>
<div class="paragraph">
<p>When a <code>Product</code> is updated, Hibernate <em>does not</em> go through the query cache and invalidate every cached result set that&#8217;s affected by the change.
Instead, there&#8217;s a special region of the cache which holds a logical timestamp of the most-recent update to each table.
This is called the <em>update timestamps cache</em>, and it&#8217;s kept in the region <code>default-update-timestamps-region</code>.</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="paragraph">
<p>It&#8217;s <em>your responsibility</em> to ensure that this cache region is configured with appropriate policies.
In particular, update timestamps should never expire or be evicted.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>When a query result set is read from the cache, Hibernate compares its timestamp with the timestamp of each of the tables that affect the results of the query, and <em>only</em> returns the result set if the result set isn&#8217;t stale.
If the result set <em>is</em> stale, Hibernate goes ahead and re-executes the query against the database and updates the cached result set.</p>
</div>
<div class="paragraph">
<p>As is generally the case with any second-level cache, the query cache can break the ACID properties of transactions.</p>
</div>
</div>
<div class="sect2">
<h3 id="second-level-cache-management">7.12. Second-level cache management</h3>
<div class="paragraph">
<p>For the most part, the second-level cache is transparent.
Program logic which interacts with the Hibernate session is unaware of the cache, and is not impacted by changes to caching policies.</p>
</div>
<div class="paragraph">
<p>At worst, interaction with the cache may be controlled by specifying of an explicit <code>CacheMode</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="n">session</span><span class="o">.</span><span class="na">setCacheMode</span><span class="o">(</span><span class="nc">CacheMode</span><span class="o">.</span><span class="na">IGNORE</span><span class="o">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Or, using JPA-standard APIs:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="n">entityManager</span><span class="o">.</span><span class="na">setCacheRetrieveMode</span><span class="o">(</span><span class="nc">CacheRetrieveMode</span><span class="o">.</span><span class="na">BYPASS</span><span class="o">);</span>
<span class="n">entityManager</span><span class="o">.</span><span class="na">setCacheStoreMode</span><span class="o">(</span><span class="nc">CacheStoreMode</span><span class="o">.</span><span class="na">BYPASS</span><span class="o">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The JPA-defined cache modes come in two flavors: <code>CacheRetrieveMode</code> and <code>CacheStoreMode</code>.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 52. JPA-defined cache retrieval modes</caption>
<colgroup>
<col style="width: 30%;">
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Mode</th>
<th class="tableblock halign-left valign-top">Interpretation</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>CacheRetrieveMode.USE</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Read data from the cache if available</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>CacheRetrieveMode.BYPASS</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Don&#8217;t read data from the cache; go direct to the database</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>We might select <code>CacheRetrieveMode.BYPASS</code> if we&#8217;re concerned about the possibility of reading stale data from the cache.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 53. JPA-defined cache storage modes</caption>
<colgroup>
<col style="width: 30%;">
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Mode</th>
<th class="tableblock halign-left valign-top">Interpretation</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>CacheStoreMode.USE</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Write data to the cache when read from the database or when modified; do not update already-cached items when reading</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>CacheStoreMode.REFRESH</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Write data to the cache when read from the database or when modified; always update cached items when reading</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>CacheStoreMode.BYPASS</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Don&#8217;t write data to the cache</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>We should select <code>CacheStoreMode.BYPASS</code> if we&#8217;re querying data that doesn&#8217;t need to be cached.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>It&#8217;s a good idea to set the <code>CacheStoreMode</code> to <code>BYPASS</code> just before running a query which returns a large result set full of data that we don&#8217;t expect to need again soon.
This saves work, and prevents the newly-read data from pushing out the previously cached data.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In JPA we would use this idiom:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="n">entityManager</span><span class="o">.</span><span class="na">setCacheStoreMode</span><span class="o">(</span><span class="nc">CacheStoreMode</span><span class="o">.</span><span class="na">BYPASS</span><span class="o">);</span>
<span class="nc">List</span><span class="o">&lt;</span><span class="nc">Publisher</span><span class="o">&gt;</span> <span class="n">allpubs</span> <span class="o">=</span>
        <span class="n">entityManager</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="s">"from Publisher"</span><span class="o">,</span> <span class="nc">Publisher</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
            <span class="o">.</span><span class="na">getResultList</span><span class="o">();</span>
<span class="n">entityManager</span><span class="o">.</span><span class="na">setCacheStoreMode</span><span class="o">(</span><span class="nc">CacheStoreMode</span><span class="o">.</span><span class="na">USE</span><span class="o">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>But Hibernate has a better way:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nc">List</span><span class="o">&lt;</span><span class="nc">Publisher</span><span class="o">&gt;</span> <span class="n">allpubs</span> <span class="o">=</span>
        <span class="n">session</span><span class="o">.</span><span class="na">createSelectionQuery</span><span class="o">(</span><span class="s">"from Publisher"</span><span class="o">,</span> <span class="nc">Publisher</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
            <span class="o">.</span><span class="na">setCacheStoreMode</span><span class="o">(</span><span class="nc">CacheStoreMode</span><span class="o">.</span><span class="na">BYPASS</span><span class="o">)</span>
            <span class="o">.</span><span class="na">getResultList</span><span class="o">();</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>A Hibernate <code>CacheMode</code> packages a <code>CacheRetrieveMode</code> with a <code>CacheStoreMode</code>.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 54. Hibernate cache modes and JPA equivalents</caption>
<colgroup>
<col style="width: 30%;">
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Hibernate <code>CacheMode</code></th>
<th class="tableblock halign-left valign-top">Equivalent JPA modes</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>NORMAL</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>CacheRetrieveMode.USE</code>, <code>CacheStoreMode.USE</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>IGNORE</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>CacheRetrieveMode.BYPASS</code>, <code>CacheStoreMode.BYPASS</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>GET</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>CacheRetrieveMode.USE</code>, <code>CacheStoreMode.BYPASS</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>PUT</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>CacheRetrieveMode.BYPASS</code>, <code>CacheStoreMode.USE</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>REFRESH</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>CacheRetrieveMode.REFRESH</code>, <code>CacheStoreMode.BYPASS</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>There&#8217;s no particular reason to prefer Hibernate&#8217;s <code>CacheMode</code> over the JPA equivalents.
This enumeration only exists because Hibernate had cache modes long before they were added to JPA.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>For "reference" data, that is, for data which is expected to always be found in the second-level cache, it&#8217;s a good idea to <em>prime</em> the cache at startup.
There&#8217;s a really easy way to do this: just execute a query immediately after obtaining the
<code>EntityManager</code> or <code>SessionFactory</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nc">SessionFactory</span> <span class="n">sessionFactory</span> <span class="o">=</span>
        <span class="n">setupHibernate</span><span class="o">(</span><span class="k">new</span> <span class="nc">Configuration</span><span class="o">())</span>
            <span class="o">.</span><span class="na">buildSessionFactory</span><span class="o">();</span>
<span class="c1">// prime the second-level cache</span>
<span class="n">sessionFactory</span><span class="o">.</span><span class="na">inSession</span><span class="o">(</span><span class="n">session</span> <span class="o">-&gt;</span> <span class="o">{</span>
    <span class="n">session</span><span class="o">.</span><span class="na">createSelectionQuery</span><span class="o">(</span><span class="s">"from Country"</span><span class="o">))</span>
        <span class="o">.</span><span class="na">setReadOnly</span><span class="o">(</span><span class="kc">true</span><span class="o">)</span>
        <span class="o">.</span><span class="na">getResultList</span><span class="o">();</span>
    <span class="n">session</span><span class="o">.</span><span class="na">createSelectionQuery</span><span class="o">(</span><span class="s">"from Product where discontinued = false"</span><span class="o">))</span>
        <span class="o">.</span><span class="na">setReadOnly</span><span class="o">(</span><span class="kc">true</span><span class="o">)</span>
        <span class="o">.</span><span class="na">getResultList</span><span class="o">();</span>
<span class="o">});</span></code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Very occasionally, it&#8217;s necessary or advantageous to control the cache explicitly, for example, to evict some data that we know to be stale.
The <code>Cache</code> interface allows programmatic eviction of cached items.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="n">sessionFactory</span><span class="o">.</span><span class="na">getCache</span><span class="o">().</span><span class="na">evictEntityData</span><span class="o">(</span><span class="nc">Book</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">bookId</span><span class="o">);</span></code></pre>
</div>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Second-level cache management via the <code>Cache</code> interface is not transaction-aware.
None of the operations of <code>Cache</code> respect any isolation or transactional semantics associated with the underlying caches. In particular, eviction via the methods of this interface causes an immediate "hard" removal outside any current transaction and/or locking scheme.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Ordinarily, however, Hibernate automatically evicts or updates cached data after modifications, and, in addition, cached data which is unused will eventually be expired according to the configured policies.</p>
</div>
<div class="paragraph">
<p>This is quite different to what happens with the first-level cache.</p>
</div>
</div>
<div class="sect2">
<h3 id="session-cache-management">7.13. Session cache management</h3>
<div class="paragraph">
<p>Entity instances aren&#8217;t automatically evicted from the session cache when they&#8217;re no longer needed.
Instead, they stay pinned in memory until the session they belong to is discarded by your program.</p>
</div>
<div class="paragraph">
<p>The methods <code>detach()</code> and <code>clear()</code> allow you to remove entities from the session cache, making them available for garbage collection.
Since most sessions are rather short-lived, you won&#8217;t need these operations very often.
And if you find yourself thinking you <em>do</em> need them in a certain situation, you should strongly consider an alternative solution: a <em>stateless session</em>.</p>
</div>
</div>
<div class="sect2">
<h3 id="stateless-sessions">7.14. Stateless sessions</h3>
<div class="paragraph">
<p>An arguably-underappreciated feature of Hibernate is the <a href="https://docs.jboss.org/hibernate/orm/6.3/javadocs/org/hibernate/StatelessSession.html"><code>StatelessSession</code></a> interface, which provides a command-oriented, more bare-metal approach to interacting with the database.</p>
</div>
<div class="paragraph">
<p>You may obtain a stateless session from the <code>SessionFactory</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="JAVA">StatelessSession ss = getSessionFactory().openStatelessSession();</code></pre>
</div>
</div>
<div class="paragraph">
<p>A stateless session:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>doesn&#8217;t have a first-level cache (persistence context), nor does it interact with any second-level caches, and</p>
</li>
<li>
<p>doesn&#8217;t implement transactional write-behind or automatic dirty checking, so all operations are executed immediately when they&#8217;re explicitly called.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For a stateless session, we&#8217;re always working with detached objects.
Thus, the programming model is a bit different:</p>
</div>
<table class="tableblock frame-all grid-all fit-content stretch">
<caption class="title">Table 55. Important methods of the <code>StatelessSession</code></caption>
<colgroup>
<col>
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Method name and parameters</th>
<th class="tableblock halign-left valign-top">Effect</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>get(Class, Object)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Obtain a detached object, given its type and its id, by executing a <code>select</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>fetch(Object)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Fetch an association of a detached object</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>refresh(Object)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Refresh the state of a detached object by executing
a <code>select</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>insert(Object)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Immediately <code>insert</code> the state of the given transient object into the database</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>update(Object)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Immediately <code>update</code> the state of the given detached object in the database</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>delete(Object)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Immediately <code>delete</code> the state of the given detached object from the database</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>upsert(Object)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Immediately <code>insert</code> or <code>update</code> the state of the given detached object using a SQL <code>merge into</code> statement</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
There&#8217;s no <code>flush()</code> operation, and so <code>update()</code> is always explicit.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In certain circumstances, this makes stateless sessions easier to work with, but with the caveat that a stateless session is much more vulnerable to data aliasing effects, since it&#8217;s easy to get two non-identical Java objects which both represent the same row of a database table.</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If we use <code>fetch()</code> in a stateless session, we can very easily obtain two objects representing the same database row!</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In particular, the absence of a persistence context means that we can safely perform bulk-processing tasks without allocating huge quantities of memory.
Use of a <code>StatelessSession</code> alleviates the need to call:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>clear()</code> or <code>detach()</code> to perform first-level cache management, and</p>
</li>
<li>
<p><code>setCacheMode()</code> to bypass interaction with the second-level cache.</p>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Stateless sessions can be useful, but for bulk operations on huge datasets, Hibernate can&#8217;t possibly compete with stored procedures!</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>When using a stateless session, you should be aware of the following additional limitations:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>persistence operations never cascade to associated instances,</p>
</li>
<li>
<p>changes to <code>@ManyToMany</code> associations and <code>@ElementCollection</code>s cannot be made persistent, and</p>
</li>
<li>
<p>operations performed via a stateless session bypass callbacks.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="optimistic-and-pessimistic-locking">7.15. Optimistic and pessimistic locking</h3>
<div class="paragraph">
<p>Finally, an aspect of behavior under load that we didn&#8217;t mention above is row-level data contention.
When many transactions try to read and update the same data, the program might become unresponsive with lock escalation, deadlocks, and lock acquisition timeout errors.</p>
</div>
<div class="paragraph">
<p>There&#8217;s two basic approaches to data concurrency in Hibernate:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>optimistic locking using <code>@Version</code> columns, and</p>
</li>
<li>
<p>database-level pessimistic locking using the SQL <code>for update</code> syntax (or equivalent).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In the Hibernate community it&#8217;s <em>much</em> more common to use optimistic locking, and Hibernate makes that incredibly easy.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Where possible, in a multiuser system, avoid holding a pessimistic lock across a user interaction.
Indeed, the usual practice is to avoid having transactions that span user interactions. For multiuser systems, optimistic locking is king.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>That said, there <em>is</em> also a place for pessimistic locks, which can sometimes reduce the probability of transaction rollbacks.</p>
</div>
<div class="paragraph">
<p>Therefore, the <code>find()</code>, <code>lock()</code>, and <code>refresh()</code> methods of the reactive session accept an optional <code>LockMode</code>.
We can also specify a <code>LockMode</code> for a query.
The lock mode can be used to request a pessimistic lock, or to customize the behavior of optimistic locking:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 56. Optimistic and pessimistic lock modes</caption>
<colgroup>
<col style="width: 26%;">
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"><code>LockMode</code> type</th>
<th class="tableblock halign-left valign-top">Meaning</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>READ</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">An optimistic lock obtained implicitly whenever
an entity is read from the database using <code>select</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>OPTIMISTIC</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">An optimistic lock obtained when an entity is
read from the database, and verified using a
<code>select</code> to check the version when the
transaction completes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>OPTIMISTIC_FORCE_INCREMENT</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">An optimistic lock obtained when an entity is
read from the database, and enforced using an
<code>update</code> to increment the version when the
transaction completes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>WRITE</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A pessimistic lock obtained implicitly whenever
an entity is written to the database using
<code>update</code> or <code>insert</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>PESSIMISTIC_READ</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A pessimistic <code>for share</code> lock</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>PESSIMISTIC_WRITE</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A pessimistic <code>for update</code> lock</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>PESSIMISTIC_FORCE_INCREMENT</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A pessimistic lock enforced using an immediate
<code>update</code> to increment the version</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="statistics">7.16. Collecting statistics</h3>
<div class="paragraph">
<p>We may ask Hibernate to collect statistics about its activity by setting this configuration property:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 35%;">
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Configuration property name</th>
<th class="tableblock halign-left valign-top">Property value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>hibernate.generate_statistics</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>true</code> to enable collection of statistics</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The statistics are exposed by the <a href="https://docs.jboss.org/hibernate/orm/6.3/javadocs/org/hibernate/stat/Statistics.html"><code>Statistics</code></a> object:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kt">long</span> <span class="n">failedVersionChecks</span> <span class="o">=</span>
        <span class="n">sessionFactory</span><span class="o">.</span><span class="na">getStatistics</span><span class="o">()</span>
            <span class="o">.</span><span class="na">getOptimisticFailureCount</span><span class="o">();</span>

<span class="kt">long</span> <span class="n">publisherCacheMissCount</span> <span class="o">=</span>
        <span class="n">sessionFactory</span><span class="o">.</span><span class="na">getStatistics</span><span class="o">()</span>
            <span class="o">.</span><span class="na">getEntityStatistics</span><span class="o">(</span><span class="nc">Publisher</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getName</span><span class="o">())</span>
                <span class="o">.</span><span class="na">getCacheMissCount</span><span class="o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Hibernate&#8217;s statistics enable observability.
Both <a href="https://quarkus.io/guides/micrometer">Micrometer</a> and <a href="https://quarkus.io/guides/microprofile-metrics">SmallRye Metrics</a> are capable of exposing these metrics.</p>
</div>
</div>
<div class="sect2">
<h3 id="slow-queries">7.17. Tracking down slow queries</h3>
<div class="paragraph">
<p>When a poorly-performing SQL query is discovered in production, it can sometimes be hard to track down exactly where in the Java code the query originates.
Hibernate offers two configuration properties that can make it easier to identify a slow query and find its source.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 57. Settings for tracking slow queries</caption>
<colgroup>
<col style="width: 25%;">
<col>
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Configuration property name</th>
<th class="tableblock halign-left valign-top">Purpose</th>
<th class="tableblock halign-left valign-top">Property value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>hibernate.log_slow_query</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Log slow queries at the <code>INFO</code> level</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The minimum execution time, in milliseconds, which characterizes a "slow" query</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>hibernate.use_sql_comments</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Prepend comments to the executed SQL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>true</code> or <code>false</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>When <code>hibernate.use_sql_comments</code> is enabled, the text of the HQL query is prepended as a comment to the generated SQL, which usually makes it easy to find the HQL in the Java code.</p>
</div>
<div class="paragraph">
<p>The comment text may be customized:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>by calling <code>Query.setComment(comment)</code> or <code>Query.setHint(AvailableHints.HINT_COMMENT,comment)</code>, or</p>
</li>
<li>
<p>via the <code>@NamedQuery</code> annotation.</p>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Once you&#8217;ve identified a slow query, one of the best ways to make it faster is to <em>actually go and talk to someone who is an expert at making queries go fast</em>.
These people are called "database administrators", and if you&#8217;re reading this document you probably aren&#8217;t one.
Database administrators know lots of stuff that Java developers don&#8217;t.
So if you&#8217;re lucky enough to have a DBA about, you don&#8217;t need to Dunning-Kruger your way out of a slow query.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>An expertly-defined index might be all you need to fix a slow query.</p>
</div>
</div>
<div class="sect2">
<h3 id="indexes">7.18. Adding indexes</h3>
<div class="paragraph">
<p>The <code>@Index</code> annotation may be used to add an index to a table:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Entity</span>
<span class="nd">@Table</span><span class="o">(</span><span class="n">indexes</span><span class="o">=</span><span class="nd">@Index</span><span class="o">(</span><span class="n">columnList</span><span class="o">=</span><span class="s">"title, year, publisher_id"</span><span class="o">))</span>
<span class="kd">class</span> <span class="nc">Book</span> <span class="o">{</span> <span class="o">...</span> <span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>It&#8217;s even possible to specify an ordering for an indexed column, or that the index should be case-insensitive:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Entity</span>
<span class="nd">@Table</span><span class="o">(</span><span class="n">indexes</span><span class="o">=</span><span class="nd">@Index</span><span class="o">(</span><span class="n">columnList</span><span class="o">=</span><span class="s">"(lower(title)), year desc, publisher_id"</span><span class="o">))</span>
<span class="kd">class</span> <span class="nc">Book</span> <span class="o">{</span> <span class="o">...</span> <span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This lets us create a customized index for a particular query.</p>
</div>
<div class="paragraph">
<p>Note that SQL expressions like <code>lower(title)</code> must be enclosed in parentheses in the <code>columnList</code> of the index definition.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>It&#8217;s not clear that information about indexes belongs in annotations of Java code.
Indexes are usually maintained and modified by a database administrator, ideally by an expert in tuning the performance of one particular RDBMS.
So it might be better to keep the definition of indexes in a SQL DDL script that your DBA can easily read and modify.
<a href="#automatic-schema-export">Remember</a>, we can ask Hibernate to execute a DDL script using the property <code>javax.persistence.schema-generation.create-script-source</code>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="denomalized-date">7.19. Dealing with denormalized data</h3>
<div class="paragraph">
<p>A typical relational database table in a well-normalized schema has a relatively small number of columns, and so there&#8217;s little to be gained by selectively querying columns and populating only certain fields of an entity class.</p>
</div>
<div class="paragraph">
<p>But occasionally, we hear from someone asking how to map a table with a hundred columns or more!
This situation can arise when:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>data is intentionally denormalized for performance,</p>
</li>
<li>
<p>the results of a complicated analytic query are exposed via a view, or</p>
</li>
<li>
<p>someone has done something crazy and wrong.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Let&#8217;s suppose that we&#8217;re <em>not</em> dealing with the last possibility.
Then we would like to be able to query the monster table without returning all of its columns.
At first glance, Hibernate doesn&#8217;t offer a perfect bottled solution to this problem.
This first impression is misleading.
Actually, Hibernate features more than one way to deal with this situation, and the real problem is deciding between the ways.
We could:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>map multiple entity classes to the same table or view, being careful about "overlaps" where a mutable column is mapped to more than one of the entities,</p>
</li>
<li>
<p>use <a href="#hql-queries">HQL</a> or <a href="#native-queries">native SQL</a> queries returning <a href="#projection-lists">results into record types</a> instead of retrieving entity instances, or</p>
</li>
<li>
<p>use the <a href="#bytecode-enhancer">bytecode enhancer</a> and <a href="https://docs.jboss.org/hibernate/orm/6.3/javadocs/org/hibernate/annotations/LazyGroup.html"><code>@LazyGroup</code></a> for attribute-level lazy fetching.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Some other ORM solutions push the third option as the recommended way to handle huge tables, but this has never been the preference of the Hibernate team or Hibernate community.
It&#8217;s much more typesafe to use one of the first two options.</p>
</div>
</div>
<div class="sect2">
<h3 id="hibernate-reactive">7.20. Reactive programming with Hibernate</h3>
<div class="paragraph">
<p>Finally, many systems which require high scalability now make use of reactive programming and reactive streams.
<a href="https://hibernate.org/reactive/">Hibernate Reactive</a> brings O/R mapping to the world of reactive programming.
You can learn much more about Hibernate Reactive from its <a href="https://hibernate.org/reactive/documentation/2.0/reference/html_single/">Reference Documentation</a>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Hibernate Reactive may be used alongside vanilla Hibernate in the same program, and can reuse the same entity classes.
This means you can use the reactive programming model exactly where you need it—perhaps only in one or two places in your system.
You don&#8217;t need to rewrite your whole program using reactive streams.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="advanced">8. Advanced Topics</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In the last chapter of this Introduction, we turn to some topics that don&#8217;t really belong in an introduction.
Here we consider some problems, and solutions, that you&#8217;re probably not going to run into immediately if you&#8217;re new to Hibernate.
But we do want you to know <em>about</em> them, so that when the time comes, you&#8217;ll know what tool to reach for.</p>
</div>
<div class="sect2">
<h3 id="filters">8.1. Filters</h3>
<div class="paragraph">
<p><em>Filters</em> are one of the nicest and under-usedest features of Hibernate, and we&#8217;re quite proud of them.
A filter is a named, globally-defined, parameterized restriction on the data that is visible in a given session.</p>
</div>
<div class="paragraph">
<p>Examples of well-defined filters might include:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>a filter that restricts the data visible to a given user according to row-level permissions,</p>
</li>
<li>
<p>a filter which hides data which has been soft-deleted,</p>
</li>
<li>
<p>in a versioned database, a filter that displays versions which were current at a given instant in the past, or</p>
</li>
<li>
<p>a filter that restricts to data associated with a certain geographical region.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>A filter must be declared somewhere.
A package descriptor is as good a place as any for a <a href="https://docs.jboss.org/hibernate/orm/6.3/javadocs/org/hibernate/annotations/FilterDef.html"><code>@FilterDef</code></a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@FilterDef</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"ByRegion"</span><span class="o">,</span>
           <span class="n">parameters</span> <span class="o">=</span> <span class="nd">@ParamDef</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"region"</span><span class="o">,</span> <span class="n">type</span> <span class="o">=</span> <span class="nc">String</span><span class="o">.</span><span class="na">class</span><span class="o">))</span>
<span class="kn">package</span> <span class="nn">org.hibernate.example</span><span class="o">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This filter has one parameter.
Fancier filters might in principle have multiple parameters, though we admit this must be quite rare.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you add annotations to a package descriptor, and you&#8217;re using <code>Configuration</code> to configure Hibernate, make sure you call <code>Configuration.addPackage()</code> to let Hibernate know that the package descriptor is annotated.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><em>Typically</em>, but not necessarily, a <code>@FilterDef</code> specifies a default restriction:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@FilterDef</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"ByRegion"</span><span class="o">,</span>
           <span class="n">parameters</span> <span class="o">=</span> <span class="nd">@ParamDef</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"region"</span><span class="o">,</span> <span class="n">type</span> <span class="o">=</span> <span class="nc">String</span><span class="o">.</span><span class="na">class</span><span class="o">),</span>
           <span class="n">defaultCondition</span> <span class="o">=</span> <span class="s">"region = :region"</span><span class="o">)</span>
<span class="kn">package</span> <span class="nn">org.hibernate.example</span><span class="o">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The restriction must contain a reference to the parameter of the filter, specified using the usual syntax for named parameters.</p>
</div>
<div class="paragraph">
<p>Any entity or collection which is affected by a filter must be annotated <a href="https://docs.jboss.org/hibernate/orm/6.3/javadocs/org/hibernate/annotations/Filter.html"><code>@Filter</code></a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Entity</span>
<span class="nd">@Filter</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="n">example_</span><span class="o">.</span><span class="na">BY_REGION</span><span class="o">)</span>
<span class="kd">class</span> <span class="nc">User</span> <span class="o">{</span>

    <span class="nd">@Id</span> <span class="nc">String</span> <span class="n">username</span><span class="o">;</span>

    <span class="nc">String</span> <span class="n">region</span><span class="o">;</span>

    <span class="o">...</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here, as usual, <code>example_.BY_REGION</code> is generated by the Metamodel Generator, and is just a constant with the value <code>"ByRegion"</code>.</p>
</div>
<div class="paragraph">
<p>If the <code>@Filter</code> annotation does not explicitly specify a restriction, the default restriction given by the <code>@FilterDef</code> will be applied to the entity.
But an entity is free to override the default condition.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Entity</span>
<span class="nd">@Filter</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="n">example_</span><span class="o">.</span><span class="na">FILTER_BY_REGION</span><span class="o">,</span> <span class="n">condition</span> <span class="o">=</span> <span class="s">"name = :region"</span><span class="o">)</span>
<span class="kd">class</span> <span class="nc">Region</span> <span class="o">{</span>

    <span class="nd">@Id</span> <span class="nc">String</span> <span class="n">name</span><span class="o">;</span>

    <span class="o">...</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that the restriction specified by the <code>condition</code> or <code>defaultCondition</code> is a native SQL expression.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 58. Annotations for defining filters</caption>
<colgroup>
<col style="width: 25%;">
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Annotation</th>
<th class="tableblock halign-left valign-top">Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@FilterDef</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Defines a filter and declares its name (exactly one per filter)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@Filter</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies how a filter applies to a given entity or collection (many per filter)</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>By default, a new session comes with every filter disabled.
A filter may be explicitly enabled in a given session by calling <code>enableFilter()</code> and assigning arguments to the parameters of the filter.
You should do this right at the <em>start</em> of the session.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="n">sessionFactory</span><span class="o">.</span><span class="na">inTransaction</span><span class="o">(</span><span class="n">session</span> <span class="o">-&gt;</span> <span class="o">{</span>
    <span class="n">session</span><span class="o">.</span><span class="na">enableFilter</span><span class="o">(</span><span class="n">example_</span><span class="o">.</span><span class="na">FILTER_BY_REGION</span><span class="o">)</span>
        <span class="o">.</span><span class="na">setParameter</span><span class="o">(</span><span class="s">"region"</span><span class="o">,</span> <span class="s">"es"</span><span class="o">)</span>
        <span class="o">.</span><span class="na">validate</span><span class="o">();</span>

    <span class="o">...</span>
<span class="o">});</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, any queries executed within the session will have the filter restriction applied.
Collections annotated <code>@Filter</code> will also have their members correctly filtered.</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="paragraph">
<p>On the other hand, filters are not applied to <code>@ManyToOne</code> associations, nor to <code>find()</code>.
This is completely by design and is not in any way a bug.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>More than one filter may be enabled in a given session.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>When we only need to filter rows by a static condition with no parameters, we don&#8217;t need a filter, since <code>@SQLRestriction</code> provides a much simpler way to do that.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We&#8217;ve mentioned that a filter can be used to implement versioning, and to provide <em>historical</em> views of the data.
Being such a general-purpose construct, filters provide a lot of flexibility here.
But if you&#8217;re after a more focused/opinionated solution to this problem, you should definitely check out <a href="https://hibernate.org/orm/envers/">Envers</a>.</p>
</div>
<div id="envers" class="sidebarblock">
<div class="content">
<div class="title">Using Envers for auditing historical data</div>
<div class="paragraph">
<p>Envers is an add-on to Hibernate ORM which keeps a historical record of each versioned entity in a separate <em>audit table</em>, and allows past revisions of the data to be viewed and queried.
A full introduction to Envers would require a whole chapter, so we&#8217;ll just give you a quick taste here.</p>
</div>
<div class="paragraph">
<p>First, we must mark an entity as versioned, using the <code>@Audited</code> annotation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Audited</span> <span class="nd">@Entity</span>
<span class="nd">@Table</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"CurrentDocument"</span><span class="o">)</span>
<span class="nd">@AuditTable</span><span class="o">(</span><span class="s">"DocumentRevision"</span><span class="o">)</span>
<span class="kd">class</span> <span class="nc">Document</span> <span class="o">{</span> <span class="o">...</span> <span class="o">}</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The <code>@AuditTable</code> annotation is optional, and it&#8217;s better to set either <code>org.hibernate.envers.audit_table_prefix</code> or <code>org.hibernate.envers.audit_table_suffix</code> and let the audit table name be inferred.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <code>AuditReader</code> interface exposes operations for retrieving and querying historical revisions.
It&#8217;s really easy to get hold of one of these:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nc">AuditReader</span> <span class="n">reader</span> <span class="o">=</span> <span class="nc">AuditReaderFactory</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">entityManager</span><span class="o">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Envers tracks revisions of the data via a global <em>revision number</em>.
We may easily find the revision number which was current at a given instant:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nc">Number</span> <span class="n">revision</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="na">getRevisionNumberForDate</span><span class="o">(</span><span class="n">datetime</span><span class="o">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We can use the revision number to ask for the version of our entity associated with the given revision number:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nc">Document</span> <span class="n">doc</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="na">find</span><span class="o">(</span><span class="nc">Document</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">id</span><span class="o">,</span> <span class="n">revision</span><span class="o">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Alternatively, we can directly ask for the version which was current at a given instant:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nc">Document</span> <span class="n">doc</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="na">find</span><span class="o">(</span><span class="nc">Document</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">id</span><span class="o">,</span> <span class="n">datetime</span><span class="o">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We can even execute queries to obtain lists of entities current at the given revision number:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nc">List</span> <span class="n">documents</span> <span class="o">=</span>
        <span class="n">reader</span><span class="o">.</span><span class="na">createQuery</span><span class="o">()</span>
            <span class="o">.</span><span class="na">forEntitiesAtRevision</span><span class="o">(</span><span class="nc">Document</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">revision</span><span class="o">)</span>
            <span class="o">.</span><span class="na">getResultList</span><span class="o">();</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>For much more information, see <a href="https://docs.jboss.org/hibernate/orm/6.3/userguide/html_single/Hibernate_User_Guide.html#envers">the User Guide</a>.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>Another closely-related problem is multi-tenancy.</p>
</div>
</div>
<div class="sect2">
<h3 id="multitenancy">8.2. Multi-tenancy</h3>
<div class="paragraph">
<p>A <em>multi-tenant</em> database is one where the data is segregated by <em>tenant</em>.
We don&#8217;t need to actually define what a "tenant" really represents here; all we care about at this level of abstraction is that each tenant may be distinguished by a unique identifier.
And that there&#8217;s a well-defined <em>current tenant</em> in each session.</p>
</div>
<div class="paragraph">
<p>We may specify the current tenant when we open a session:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kt">var</span> <span class="n">session</span> <span class="o">=</span>
        <span class="n">sessionFactory</span><span class="o">.</span><span class="na">withOptions</span><span class="o">()</span>
            <span class="o">.</span><span class="na">tenantIdentifier</span><span class="o">(</span><span class="n">tenantId</span><span class="o">)</span>
            <span class="o">.</span><span class="na">openSession</span><span class="o">();</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Or, when using JPA-standard APIs:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kt">var</span> <span class="n">entityManager</span> <span class="o">=</span>
        <span class="n">entityManagerFactory</span><span class="o">.</span><span class="na">createEntityManager</span><span class="o">(</span><span class="nc">Map</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="nc">HibernateHints</span><span class="o">.</span><span class="na">HINT_TENANT_ID</span><span class="o">,</span> <span class="n">tenantId</span><span class="o">));</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>However, since we often don&#8217;t have this level of control over creation of the session, it&#8217;s more common to supply an implementation of <a href="https://docs.jboss.org/hibernate/orm/6.3/javadocs/org/hibernate/context/spi/CurrentTenantIdentifierResolver.html"><code>CurrentTenantIdentifierResolver</code></a> to Hibernate.</p>
</div>
<div class="paragraph">
<p>There are three common ways to implement multi-tenancy:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>each tenant has its own database,</p>
</li>
<li>
<p>each tenant has its own schema, or</p>
</li>
<li>
<p>tenants share tables in a single schema, and rows are tagged with the tenant id.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>From the point of view of Hibernate, there&#8217;s little difference between the first two options.
Hibernate will need to obtain a JDBC connection with permissions on the database and schema owned by the current tenant.</p>
</div>
<div class="paragraph">
<p>Therefore, we must implement a <a href="https://docs.jboss.org/hibernate/orm/6.3/javadocs/org/hibernate/engine/jdbc/connections/spi/MultiTenantConnectionProvider.html"><code>MultiTenantConnectionProvider</code></a> which takes on this responsibility:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>from time to time, Hibernate will ask for a connection, passing the id of the current tenant, and then we must create an appropriate connection or obtain one from a pool, and return it to Hibernate, and</p>
</li>
<li>
<p>later, Hibernate will release the connection and ask us to destroy it or return it to the appropriate pool.</p>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Check out <a href="https://docs.jboss.org/hibernate/orm/6.3/javadocs/org/hibernate/engine/jdbc/connections/spi/DataSourceBasedMultiTenantConnectionProviderImpl.html"><code>DataSourceBasedMultiTenantConnectionProviderImpl</code></a> for inspiration.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The third option is quite different.
In this case we don&#8217;t need a <code>MultiTenantConnectionProvider</code>, but we will need a dedicated column holding the tenant id mapped by each of our entities.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Entity</span>
<span class="kd">class</span> <span class="nc">Account</span> <span class="o">{</span>
    <span class="nd">@Id</span> <span class="nc">String</span> <span class="n">id</span><span class="o">;</span>
    <span class="nd">@TenantId</span> <span class="nc">String</span> <span class="n">tenantId</span><span class="o">;</span>

    <span class="o">...</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <a href="https://docs.jboss.org/hibernate/orm/6.3/javadocs/org/hibernate/annotations/TenantId.html"><code>@TenantId</code></a> annotation is used to indicate an attribute of an entity which holds the tenant id.
Within a given session, our data is automatically filtered so that only rows tagged with the tenant id of the current tenant are visible in that session.</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Native SQL queries are <em>not</em> automatically filtered by tenant id; you&#8217;ll have to do that part yourself.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To make use of multi-tenancy, we&#8217;ll usually need to set at least one of these configuration properties:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 59. Multi-tenancy configuration</caption>
<colgroup>
<col style="width: 36%;">
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Configuration property name</th>
<th class="tableblock halign-left valign-top">Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>hibernate.tenant_identifier_resolver</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies the <code>CurrentTenantIdentifierResolver</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>hibernate.multi_tenant_connection_provider</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies the <code>MultiTenantConnectionProvider</code></p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="custom-sql">8.3. Using custom-written SQL</h3>
<div class="paragraph">
<p>We&#8217;ve already discussed how to run <a href="#native-queries">queries written in SQL</a>, but occasionally that&#8217;s not enough.
Sometimes—but much less often than you might expect—we would like to customize the SQL used by Hibernate to perform basic CRUD operations for an entity or collection.</p>
</div>
<div class="paragraph">
<p>For this we can use <code>@SQLInsert</code> and friends:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Entity</span>
<span class="nd">@SQLInsert</span><span class="o">(</span><span class="n">sql</span> <span class="o">=</span> <span class="s">"insert into person (name, id, valid) values (?, ?, true)"</span><span class="o">,</span> <span class="n">check</span> <span class="o">=</span> <span class="no">COUNT</span><span class="o">)</span>
<span class="nd">@SQLUpdate</span><span class="o">(</span><span class="n">sql</span> <span class="o">=</span> <span class="s">"update person set name = ? where id = ?"</span><span class="o">)</span>
<span class="nd">@SQLDelete</span><span class="o">(</span><span class="n">sql</span> <span class="o">=</span> <span class="s">"update person set valid = false where id = ?"</span><span class="o">)</span>
<span class="nd">@SQLSelect</span><span class="o">(</span><span class="n">sql</span> <span class="o">=</span> <span class="s">"select id, name from person where id = ? and valid = true"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Person</span> <span class="o">{</span> <span class="o">...</span> <span class="o">}</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If the custom SQL should be executed via a <code>CallableStatement</code>, just specify <code>callable=true</code>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Any SQL statement specified by one of these annotations must have exactly the number of JDBC parameters that Hibernate expects, that is, one for each column mapped by the entity, in the exact order Hibernate expects. In particular, the primary key columns must come last.</p>
</div>
<div class="paragraph">
<p>However, the <code>@Column</code> annotation does lend some flexibility here:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>if a column should not be written as part of the custom <code>insert</code> statement, and has no corresponding JDBC parameter in the custom SQL, map it <code>@Column(insertable=false)</code>, or</p>
</li>
<li>
<p>if a column should not be written as part of the custom <code>update</code> statement, and has no corresponding JDBC parameter in the custom SQL, map it <code>@Column(updatable=false)</code>.</p>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you need custom SQL, but are targeting multiple dialects of SQL, you can use the annotations defined in <code>DialectOverrides</code>.
For example, this annotation lets us override the custom <code>insert</code> statement just for PostgreSQL:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@DialectOverride</span><span class="o">.</span><span class="na">SQLInsert</span><span class="o">(</span><span class="n">dialect</span> <span class="o">=</span> <span class="nc">PostgreSQLDialect</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
    <span class="n">override</span> <span class="o">=</span> <span class="nd">@SQLInsert</span><span class="o">(</span><span class="n">sql</span><span class="o">=</span><span class="s">"insert into person (name,id) values (?,gen_random_uuid())"</span><span class="o">))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>It&#8217;s even possible to override the custom SQL for specific <em>versions</em> of a database.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Sometimes a custom <code>insert</code> or <code>update</code> statement assigns a value to a mapped column which is calculated when the statement is executed on the database.
For example, the value might be obtained by calling a SQL function:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@SQLInsert</span><span class="o">(</span><span class="n">sql</span> <span class="o">=</span> <span class="s">"insert into person (name, id) values (?, gen_random_uuid())"</span><span class="o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>But the entity instance which represents the row being inserted or updated won&#8217;t be automatically populated with that value.
And so our persistence context loses synchronization with the database.
In situations like this, we may use the <code>@Generated</code> annotation to tell Hibernate to reread the state of the entity after each <code>insert</code> or <code>update</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="database-generated-columns">8.4. Handling database-generated columns</h3>
<div class="paragraph">
<p>Sometimes, a column value is assigned or mutated by events that happen in the database, and aren&#8217;t visible to Hibernate.
For example:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>a table might have a column value populated by a trigger,</p>
</li>
<li>
<p>a mapped column might have a default value defined in DDL, or</p>
</li>
<li>
<p>a custom SQL <code>insert</code> or <code>update</code> statement might assign a value to a mapped column, as we saw in the previous subsection.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>One way to deal with this situation is to explicitly call <code>refresh()</code> at appropriate moments, forcing the session to reread the state of the entity.
But this is annoying.</p>
</div>
<div class="paragraph">
<p>The <a href="https://docs.jboss.org/hibernate/orm/6.3/javadocs/org/hibernate/annotations/Generated.html"><code>@Generated</code></a> annotation relieves us of the burden of explicitly calling <code>refresh()</code>.
It specifies that the value of the annotated entity attribute is generated by the database, and that the generated value should be automatically retrieved using a SQL <code>returning</code> clause, or separate <code>select</code> after it is generated.</p>
</div>
<div class="paragraph">
<p>A useful example is the following mapping:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Entity</span>
<span class="kd">class</span> <span class="nc">Entity</span> <span class="o">{</span>
    <span class="nd">@Generated</span> <span class="nd">@Id</span>
    <span class="nd">@ColumnDefault</span><span class="o">(</span><span class="s">"gen_random_uuid()"</span><span class="o">)</span>
    <span class="no">UUID</span> <span class="n">id</span><span class="o">;</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The generated DDL is:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sql"><span class="k">create</span> <span class="k">table</span> <span class="n">Entity</span> <span class="p">(</span>
    <span class="n">id</span> <span class="n">uuid</span> <span class="k">default</span> <span class="n">gen_random_uuid</span><span class="p">()</span> <span class="k">not</span> <span class="k">null</span><span class="p">,</span>
    <span class="k">primary</span> <span class="k">key</span> <span class="p">(</span><span class="n">uuid</span><span class="p">)</span>
<span class="p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>So here the value of <code>id</code> is defined by the column default clause, by calling the PostgreSQL function <code>gen_random_uuid()</code>.</p>
</div>
<div class="paragraph">
<p>When a column value is generated during updates, use <code>@Generated(event=UPDATE)</code>.
When a value is generated by both inserts <em>and</em> updates, use <code>@Generated(event={INSERT,UPDATE})</code>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>For columns which should be generated using a SQL <code>generated always as</code> clause, prefer the <a href="https://docs.jboss.org/hibernate/orm/6.3/javadocs/org/hibernate/annotations/GeneratedColumn.html"><code>@GeneratedColumn</code></a> annotation, so that Hibernate automatically generates the correct DDL.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Actually, the <code>@Generated</code> and <code>@GeneratedColumn</code> annotations are defined in terms of a more generic and user-extensible framework for handling attribute values generated in Java, or by the database.
So let&#8217;s drop down a layer, and see how that works.</p>
</div>
</div>
<div class="sect2">
<h3 id="user-defined-generators">8.5. User-defined generators</h3>
<div class="paragraph">
<p>JPA doesn&#8217;t define a standard way to extend the set of id generation strategies, but Hibernate does:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the <a href="https://docs.jboss.org/hibernate/orm/6.3/javadocs/org/hibernate/generator/Generator.html"><code>Generator</code></a> hierarchy of interfaces in the package <code>org.hibernate.generator</code> lets you define new generators, and</p>
</li>
<li>
<p>the <a href="https://docs.jboss.org/hibernate/orm/6.3/javadocs/org/hibernate/annotations/IdGeneratorType.html"><code>@IdGeneratorType</code></a> meta-annotation from the package <code>org.hibernate.annotations</code> lets you write an annotation which associates a <code>Generator</code> type with identifier attributes.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Furthermore, the <a href="https://docs.jboss.org/hibernate/orm/6.3/javadocs/org/hibernate/annotations/ValueGenerationType.html"><code>@ValueGenerationType</code></a> meta-annotation lets you write an annotation which associates a <code>Generator</code> type with a non-<code>@Id</code> attribute.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>These APIs are new in Hibernate 6, and supersede the classic <code>IdentifierGenerator</code> interface and <code>@GenericGenerator</code> annotation from older versions of Hibernate.
However, the older APIs are still available and custom <code>IdentifierGenerator</code>s written for older versions of Hibernate continue to work in Hibernate 6.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Hibernate has a range of built-in generators which are defined in terms of this new framework.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 60. Built-in generators</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 25%;">
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Annotation</th>
<th class="tableblock halign-left valign-top">Implementation</th>
<th class="tableblock halign-left valign-top">Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@Generated</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>GeneratedGeneration</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Generically handles database-generated values</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@GeneratedColumn</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>GeneratedAlwaysGeneration</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Handles values generated using <code>generated always</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@CurrentTimestamp</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>CurrentTimestampGeneration</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Generic support for database or in-memory generation of creation or update timestamps</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@CreationTimestamp</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>CurrentTimestampGeneration</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A timestamp generated when an entity is first made persistent</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@UpdateTimestamp</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>CurrentTimestampGeneration</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A timestamp generated when an entity is made persistent, and regenerated every time the entity is modified</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@UuidGenerator</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>UuidGenerator</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A more flexible generator for RFC 4122 UUIDs</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Furthermore, support for JPA&#8217;s standard id generation strategies is also defined in terms of this framework.</p>
</div>
<div class="paragraph">
<p>As an example, let&#8217;s look at how <code>@UuidGenerator</code> is defined:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@IdGeneratorType</span><span class="o">(</span><span class="n">org</span><span class="o">.</span><span class="na">hibernate</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">uuid</span><span class="o">.</span><span class="na">UuidGenerator</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="nd">@ValueGenerationType</span><span class="o">(</span><span class="n">generatedBy</span> <span class="o">=</span> <span class="n">org</span><span class="o">.</span><span class="na">hibernate</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">uuid</span><span class="o">.</span><span class="na">UuidGenerator</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="nd">@Retention</span><span class="o">(</span><span class="no">RUNTIME</span><span class="o">)</span>
<span class="nd">@Target</span><span class="o">({</span> <span class="no">FIELD</span><span class="o">,</span> <span class="no">METHOD</span> <span class="o">})</span>
<span class="kd">public</span> <span class="nd">@interface</span> <span class="nc">UuidGenerator</span> <span class="o">{</span> <span class="o">...</span> <span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>@UuidGenerator</code> is meta-annotated both <code>@IdGeneratorType</code> and <code>@ValueGenerationType</code> because it may be used to generate both ids and values of regular attributes.
Either way, this <code>Generator</code> class does the hard work:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">UuidGenerator</span>
        <span class="c1">// this generator produced values before SQL is executed</span>
        <span class="kd">implements</span> <span class="nc">BeforeExecutionGenerator</span> <span class="o">{</span>

    <span class="c1">// constructors accept an instance of the @UuidGenerator</span>
    <span class="c1">// annotation, allowing the generator to be "configured"</span>

    <span class="c1">// called to create an id generator</span>
    <span class="kd">public</span> <span class="nf">UuidGenerator</span><span class="o">(</span>
            <span class="n">org</span><span class="o">.</span><span class="na">hibernate</span><span class="o">.</span><span class="na">annotations</span><span class="o">.</span><span class="na">UuidGenerator</span> <span class="n">config</span><span class="o">,</span>
            <span class="nc">Member</span> <span class="n">idMember</span><span class="o">,</span>
            <span class="nc">CustomIdGeneratorCreationContext</span> <span class="n">creationContext</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">(</span><span class="n">config</span><span class="o">,</span> <span class="n">idMember</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">// called to create a generator for a regular attribute</span>
    <span class="kd">public</span> <span class="nf">UuidGenerator</span><span class="o">(</span>
            <span class="n">org</span><span class="o">.</span><span class="na">hibernate</span><span class="o">.</span><span class="na">annotations</span><span class="o">.</span><span class="na">UuidGenerator</span> <span class="n">config</span><span class="o">,</span>
            <span class="nc">Member</span> <span class="n">member</span><span class="o">,</span>
            <span class="nc">GeneratorCreationContext</span> <span class="n">creationContext</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">(</span><span class="n">config</span><span class="o">,</span> <span class="n">idMember</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="o">...</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">EnumSet</span><span class="o">&lt;</span><span class="nc">EventType</span><span class="o">&gt;</span> <span class="nf">getEventTypes</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">// UUIDs are only assigned on insert, and never regenerated</span>
        <span class="k">return</span> <span class="no">INSERT_ONLY</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">Object</span> <span class="nf">generate</span><span class="o">(</span><span class="nc">SharedSessionContractImplementor</span> <span class="n">session</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">owner</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">currentValue</span><span class="o">,</span> <span class="nc">EventType</span> <span class="n">eventType</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// actually generate a UUID and transform it to the required type</span>
        <span class="k">return</span> <span class="n">valueTransformer</span><span class="o">.</span><span class="na">transform</span><span class="o">(</span> <span class="n">generator</span><span class="o">.</span><span class="na">generateUuid</span><span class="o">(</span> <span class="n">session</span> <span class="o">)</span> <span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You can find out more about custom generators from the Javadoc for <code>@IdGeneratorType</code> and for <code>org.hibernate.generator</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="naming-strategies">8.6. Naming strategies</h3>
<div class="paragraph">
<p>When working with a pre-existing relational schema, it&#8217;s usual to find that the column and table naming conventions used in the schema don&#8217;t match Java&#8217;s naming conventions.</p>
</div>
<div class="paragraph">
<p>Of course, the <code>@Table</code> and <code>@Column</code> annotations let us explicitly specify a mapped table or column name.
But we would prefer to avoid scattering these annotations across our whole domain model.</p>
</div>
<div class="paragraph">
<p>Therefore, Hibernate lets us define a mapping between Java naming conventions, and the naming conventions of the relational schema.
Such a mapping is called a <em>naming strategy</em>.</p>
</div>
<div class="paragraph">
<p>First, we need to understand how Hibernate assigns and processes names.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>Logical naming</em> is the process of applying naming rules to determine the <em>logical names</em> of objects which were not explicitly assigned names in the O/R mapping.
That is, when there&#8217;s no <code>@Table</code> or <code>@Column</code> annotation.</p>
</li>
<li>
<p><em>Physical naming</em> is the process of applying additional rules to transform a logical name into an actual "physical" name that will be used in the database.
For example, the rules might include things like using standardized abbreviations, or trimming the length of identifiers.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Thus, there&#8217;s two flavors of naming strategy, with slightly different responsibilities.
Hibernate comes with default implementations of these interfaces:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Flavor</th>
<th class="tableblock halign-left valign-top">Default implementation</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">An <a href="https://docs.jboss.org/hibernate/orm/6.3/javadocs/org/hibernate/boot/model/naming/ImplicitNamingStrategy.html"><code>ImplicitNamingStrategy</code></a> is responsible for assigning a logical name when none is specified by an annotation</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A default strategy which implements the rules defined by JPA</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">A <a href="https://docs.jboss.org/hibernate/orm/6.3/javadocs/org/hibernate/boot/model/naming/PhysicalNamingStrategy.html"><code>PhysicalNamingStrategy</code></a> is responsible for transforming a logical name and producing the name used in the database</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A trivial implementation which does no processing</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>We happen to not much like the naming rules defined by JPA, which specify that mixed case and camel case identifiers should be concatenated using underscores.
We bet you could easily come up with a much better <code>ImplicitNamingStrategy</code> than that!
(Hint: it should always produce legit mixed case identifiers.)</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>A popular <code>PhysicalNamingStrategy</code> produces snake case identifiers.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Custom naming strategies may be enabled using the configuration properties we already mentioned without much explanation back in <a href="#minimizing">Minimizing repetitive mapping information</a>.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 61. Naming strategy configuration</caption>
<colgroup>
<col style="width: 35%;">
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Configuration property name</th>
<th class="tableblock halign-left valign-top">Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>hibernate.implicit_naming_strategy</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies the <code>ImplicitNamingStrategy</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>hibernate.physical_naming_strategy</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies the <code>PhysicalNamingStrategy</code></p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="spatial">8.7. Spatial datatypes</h3>
<div class="paragraph">
<p>Hibernate Spatial augments the <a href="#basic-attributes">built-in basic types</a> with a set of Java mappings for <a href="https://www.ogc.org">OGC</a> spatial types.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/GeoLatte/geolatte-geom">Geolatte-geom</a> defines a set of Java types implementing the OGC spatial types, and codecs for translating to and from database-native spatial datatypes.</p>
</li>
<li>
<p>Hibernate Spatial itself supplies integration with Hibernate.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To use Hibernate Spatial, we must add it as a dependency, as described in <a href="#optional-dependencies">Optional dependencies</a>.</p>
</div>
<div class="paragraph">
<p>Then we may immediately use Geolatte-geom and JTS types in our entities.
No special annotations are needed:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kn">import</span> <span class="nn">org.locationtech.jts.geom.Point</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">jakarta.persistence.*</span><span class="o">;</span>

<span class="nd">@Entity</span>
<span class="kd">class</span> <span class="nc">Event</span> <span class="o">{</span>
    <span class="nc">Event</span><span class="o">()</span> <span class="o">{}</span>

    <span class="nc">Event</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">,</span> <span class="nc">Point</span> <span class="n">location</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">location</span> <span class="o">=</span> <span class="n">location</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Id</span> <span class="nd">@GeneratedValue</span>
    <span class="nc">Long</span> <span class="n">id</span><span class="o">;</span>

    <span class="nc">String</span> <span class="n">name</span><span class="o">;</span>

    <span class="nc">Point</span> <span class="n">location</span><span class="o">;</span>

<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The generated DDL uses <code>geometry</code> as the type of the column mapped by <code>location</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sql"><span class="k">create</span> <span class="k">table</span> <span class="n">Event</span> <span class="p">(</span>
    <span class="n">id</span> <span class="nb">bigint</span> <span class="k">not</span> <span class="k">null</span><span class="p">,</span>
    <span class="k">location</span> <span class="n">geometry</span><span class="p">,</span>
    <span class="n">name</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">255</span><span class="p">),</span>
    <span class="k">primary</span> <span class="k">key</span> <span class="p">(</span><span class="n">id</span><span class="p">)</span>
<span class="p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Hibernate Spatial lets us work with spatial types just as we would with any of the built-in basic attribute types.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kt">var</span> <span class="n">geometryFactory</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">GeometryFactory</span><span class="o">();</span>
<span class="o">...</span>

<span class="nc">Point</span> <span class="n">point</span> <span class="o">=</span> <span class="n">geometryFactory</span><span class="o">.</span><span class="na">createPoint</span><span class="o">(</span><span class="k">new</span> <span class="nc">Coordinate</span><span class="o">(</span><span class="mi">10</span><span class="o">,</span> <span class="mi">5</span><span class="o">));</span>
<span class="n">session</span><span class="o">.</span><span class="na">persist</span><span class="o">(</span><span class="k">new</span> <span class="nc">Event</span><span class="o">(</span><span class="s">"Hibernate ORM presentation"</span><span class="o">,</span> <span class="n">point</span><span class="o">));</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>But what makes this powerful is that we may write some very fancy queries involving functions of spatial types:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nc">Polygon</span> <span class="n">triangle</span> <span class="o">=</span>
        <span class="n">geometryFactory</span><span class="o">.</span><span class="na">createPolygon</span><span class="o">(</span>
                <span class="k">new</span> <span class="nc">Coordinate</span><span class="o">[]</span> <span class="o">{</span>
                        <span class="k">new</span> <span class="nf">Coordinate</span><span class="o">(</span><span class="mi">9</span><span class="o">,</span> <span class="mi">4</span><span class="o">),</span>
                        <span class="k">new</span> <span class="nf">Coordinate</span><span class="o">(</span><span class="mi">11</span><span class="o">,</span> <span class="mi">4</span><span class="o">),</span>
                        <span class="k">new</span> <span class="nf">Coordinate</span><span class="o">(</span><span class="mi">11</span><span class="o">,</span> <span class="mi">20</span><span class="o">),</span>
                        <span class="k">new</span> <span class="nf">Coordinate</span><span class="o">(</span><span class="mi">9</span><span class="o">,</span> <span class="mi">4</span><span class="o">)</span>
                <span class="o">}</span>
        <span class="o">);</span>
<span class="nc">Point</span> <span class="n">event</span> <span class="o">=</span>
        <span class="n">session</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="s">"select location from Event where within(location, :zone) = true"</span><span class="o">,</span> <span class="nc">Point</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
                <span class="o">.</span><span class="na">setParameter</span><span class="o">(</span><span class="s">"zone"</span><span class="o">,</span> <span class="n">triangle</span><span class="o">)</span>
                <span class="o">.</span><span class="na">getSingleResult</span><span class="o">();</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here, <code>within()</code> is one of the functions for testing spatial relations defined by the OpenGIS specification.
Other such functions include <code>touches()</code>, <code>intersects()</code>, <code>distance()</code>, <code>boundary()</code>, etc.
Not every spatial relation function is supported on every database.
A matrix of support for spatial relation functions may be found in the <a href="https://docs.jboss.org/hibernate/orm/6.3/userguide/html_single/Hibernate_User_Guide.html#spatial-configuration-dialect-features">User Guide</a>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you want to play with spatial functions on H2, run the following code first:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="n">sessionFactory</span><span class="o">.</span><span class="na">inTransaction</span><span class="o">(</span><span class="n">session</span> <span class="o">-&gt;</span> <span class="o">{</span>
    <span class="n">session</span><span class="o">.</span><span class="na">doWork</span><span class="o">(</span><span class="n">connection</span> <span class="o">-&gt;</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">(</span><span class="kt">var</span> <span class="n">statement</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="na">createStatement</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">statement</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="s">"create alias if not exists h2gis_spatial for \"org.h2gis.functions.factory.H2GISFunctions.load\""</span><span class="o">);</span>
            <span class="n">statement</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="s">"call h2gis_spatial()"</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">});</span>
<span class="o">}</span> <span class="o">);</span></code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="ordered-sorted">8.8. Ordered and sorted collections and map keys</h3>
<div class="paragraph">
<p>Java lists and maps don&#8217;t map very naturally to foreign key relationships between tables, and so we tend to avoid using them to represent associations between our entity classes.
But if you feel like you <em>really</em> need a collection with a fancier structure than <code>Set</code>, Hibernate does have options.</p>
</div>
<div class="paragraph">
<p>The first three options let us map the index of a <code>List</code> or key of a <code>Map</code> to a column, and are usually used with a <code>@ElementCollection</code>, or on the owning side of an association:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 62. Annotations for mapping lists and maps</caption>
<colgroup>
<col style="width: 22%;">
<col>
<col style="width: 13%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Annotation</th>
<th class="tableblock halign-left valign-top">Purpose</th>
<th class="tableblock halign-center valign-top">JPA-standard</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@OrderColumn</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies the column used to maintain the order of a list</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&#10004;</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@ListIndexBase</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The column value for the first element of the list (zero by default)</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&#10006;</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@MapKeyColumn</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies the column used to persist the keys of a map
(used when the key is of basic type)</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&#10004;</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@MapKeyJoinColumn</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies the column used to persist the keys of a map
(used when the key is an entity)</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&#10004;</p></td>
</tr>
</tbody>
</table>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@ManyToMany</span>
<span class="nd">@OrderColumn</span> <span class="c1">// order of list is persistent</span>
<span class="nc">List</span><span class="o">&lt;</span><span class="nc">Author</span><span class="o">&gt;</span> <span class="n">authors</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@ElementCollection</span>
<span class="nd">@OrderColumn</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"tag_order"</span><span class="o">)</span> <span class="nd">@ListIndexBase</span><span class="o">(</span><span class="mi">1</span><span class="o">)</span> <span class="c1">// order column and base value</span>
<span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">tags</span><span class="o">;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@ElementCollection</span>
<span class="nd">@CollectionTable</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"author_bios"</span><span class="o">,</span>                 <span class="c1">// table name</span>
        <span class="n">joinColumns</span> <span class="o">=</span> <span class="nd">@JoinColumn</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"book_isbn"</span><span class="o">))</span> <span class="c1">// column holding foreign key of owner</span>
<span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"bio"</span><span class="o">)</span>                                    <span class="c1">// column holding map values</span>
<span class="nd">@MapKeyJoinColumn</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"author_ssn"</span><span class="o">)</span>                   <span class="c1">// column holding map keys</span>
<span class="nc">Map</span><span class="o">&lt;</span><span class="nc">Author</span><span class="o">,</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">biographies</span><span class="o">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>For a <code>Map</code> representing an unowned <code>@OneToMany</code> association, the column must also be mapped on the owning side, usually by an attribute of the target entity.
In this case we usually use a different annotation:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 63. Annotation for mapping an entity attribute to a map key</caption>
<colgroup>
<col style="width: 22%;">
<col>
<col style="width: 13%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Annotation</th>
<th class="tableblock halign-left valign-top">Purpose</th>
<th class="tableblock halign-center valign-top">JPA-standard</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@MapKey</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies an attribute of the target entity which acts as the key of the map</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&#10004;</p></td>
</tr>
</tbody>
</table>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@OneToMany</span><span class="o">(</span><span class="n">mappedBy</span> <span class="o">=</span> <span class="n">Book_</span><span class="o">.</span><span class="na">PUBLISHER</span><span class="o">)</span>
<span class="nd">@MapKey</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="n">Book_</span><span class="o">.</span><span class="na">TITLE</span><span class="o">)</span> <span class="c1">// the key of the map is the title of the book</span>
<span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span><span class="nc">Book</span><span class="o">&gt;</span> <span class="n">booksByTitle</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, let&#8217;s introduce a little distinction:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>an <em>ordered collection</em> is one with an ordering maintained in the database, and</p>
</li>
<li>
<p>a <em>sorted collection</em> is one which is sorted in Java code.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>These annotations allow us to specify how the elements of a collection should be ordered as they are read from the database:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 64. Annotations for ordered collections</caption>
<colgroup>
<col style="width: 22%;">
<col>
<col style="width: 13%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Annotation</th>
<th class="tableblock halign-left valign-top">Purpose</th>
<th class="tableblock halign-center valign-top">JPA-standard</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@OrderBy</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies a fragment of JPQL used to order the collection</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&#10004;</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@SQLOrder</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies a fragment of SQL used to order the collection</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&#10006;</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>On the other hand, the following annotations specify how a collection should be sorted in memory, and are used for collections of type <code>SortedSet</code> or <code>SortedMap</code>:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 65. Annotations for sorted collections</caption>
<colgroup>
<col style="width: 22%;">
<col>
<col style="width: 13%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Annotation</th>
<th class="tableblock halign-left valign-top">Purpose</th>
<th class="tableblock halign-center valign-top">JPA-standard</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@SortNatural</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies that the elements of a collection are <code>Comparable</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&#10006;</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@SortComparator</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies a <code>Comparator</code> used to sort the collection</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&#10006;</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Under the covers, Hibernate uses a <code>TreeSet</code> or <code>TreeMap</code> to maintain the collection in sorted order.</p>
</div>
</div>
<div class="sect2">
<h3 id="any">8.9. Any mappings</h3>
<div class="paragraph">
<p>An <code>@Any</code> mapping is a sort of polymorphic many-to-one association where the target entity types are not related by the usual entity inheritance.
The target type is distinguished using a discriminator value stored on the <em>referring</em> side of the relationship.</p>
</div>
<div class="paragraph">
<p>This is quite different to <a href="#entity-inheritance">discriminated inheritance</a> where the discriminator is held in the tables mapped by the referenced entity hierarchy.</p>
</div>
<div class="paragraph">
<p>For example, consider an <code>Order</code> entity containing <code>Payment</code> information, where a <code>Payment</code> might be a <code>CashPayment</code> or a <code>CreditCardPayment</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">interface</span> <span class="nc">Payment</span> <span class="o">{</span> <span class="o">...</span> <span class="o">}</span>

<span class="nd">@Entity</span>
<span class="kd">class</span> <span class="nc">CashPayment</span> <span class="o">{</span> <span class="o">...</span> <span class="o">}</span>

<span class="nd">@Entity</span>
<span class="kd">class</span> <span class="nc">CreditCardPayment</span> <span class="o">{</span> <span class="o">...</span> <span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In this example, <code>Payment</code> is not be declared as an entity type, and is not annotated <code>@Entity</code>. It might even be an interface, or at most just a mapped superclass, of <code>CashPayment</code> and <code>CreditCardPayment</code>. So in terms of the object/relational mappings, <code>CashPayment</code> and <code>CreditCardPayment</code> would not be considered to participate in the same entity inheritance hierarchy.</p>
</div>
<div class="paragraph">
<p>On the other hand, <code>CashPayment</code> and <code>CreditCardPayment</code> do have the same identifier type.
This is important.</p>
</div>
<div class="paragraph">
<p>An <code>@Any</code> mapping would store the discriminator value identifying the concrete type of <code>Payment</code> along with the state of the associated <code>Order</code>, instead of storing it in the table mapped by <code>Payment</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Entity</span>
<span class="kd">class</span> <span class="nc">Order</span> <span class="o">{</span>
    <span class="o">...</span>

    <span class="nd">@Any</span>
    <span class="nd">@AnyKeyJavaClass</span><span class="o">(</span><span class="no">UUID</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>   <span class="c1">//the foreign key type</span>
    <span class="nd">@JoinColumn</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"payment_id"</span><span class="o">)</span> <span class="c1">// the foreign key column</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"payment_type"</span><span class="o">)</span>   <span class="c1">// the discriminator column</span>
    <span class="c1">// map from discriminator values to target entity types</span>
    <span class="nd">@AnyDiscriminatorValue</span><span class="o">(</span><span class="n">discriminator</span><span class="o">=</span><span class="s">"CASH"</span><span class="o">,</span> <span class="n">entity</span><span class="o">=</span><span class="nc">CashPayment</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
    <span class="nd">@AnyDiscriminatorValue</span><span class="o">(</span><span class="n">discriminator</span><span class="o">=</span><span class="s">"CREDIT"</span><span class="o">,</span> <span class="n">entity</span><span class="o">=</span><span class="nc">CreditCardPayment</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
    <span class="nc">Payment</span> <span class="n">payment</span><span class="o">;</span>

    <span class="o">...</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>It&#8217;s reasonable to think of the "foreign key" in an <code>@Any</code> mapping as a composite value made up of the foreign key and discriminator taken together. Note, however, that this composite foreign key is only conceptual and cannot be declared as a physical constraint on the relational database table.</p>
</div>
<div class="paragraph">
<p>There are a number of annotations which are useful to express this sort of complicated and unnatural mapping:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 66. Annotations for <code>@Any</code> mappings</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Annotations</th>
<th class="tableblock halign-left valign-top">Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@Any</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Declares that an attribute is a discriminated polymorphic association mapping</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@AnyDiscriminator</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specify the Java type of the discriminator</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@JdbcType</code> or <code>@JdbcTypeCode</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specify the JDBC type of the discriminator</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@AnyDiscriminatorValue</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies how discriminator values map to entity types</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@Column</code> or <code>@Formula</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specify the column or formula in which the discriminator value is stored</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@AnyKeyJavaType</code> or <code>@AnyKeyJavaClass</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specify the Java type of the foreign key (that is, of the ids of the target entities)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@AnyKeyJdbcType</code> or <code>@AnyKeyJdbcTypeCode</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specify the JDBC type of the foreign key</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@JoinColumn</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies the foreign key column</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Of course, <code>@Any</code> mappings are disfavored, except in extremely special cases, since it&#8217;s much more difficult to enforce referential integrity at the database level.</p>
</div>
<div class="paragraph">
<p>There&#8217;s also currently some limitations around querying <code>@Any</code> associations in HQL.
This is allowed:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">from</span> <span class="k">Order</span> <span class="n">ord</span>
    <span class="k">join</span> <span class="n">CashPayment</span> <span class="n">cash</span>
        <span class="k">on</span> <span class="n">id</span><span class="p">(</span><span class="n">ord</span><span class="p">.</span><span class="n">payment</span><span class="p">)</span> <span class="o">=</span> <span class="n">cash</span><span class="p">.</span><span class="n">id</span></code></pre>
</div>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Polymorphic association joins for <code>@Any</code> mappings are not currently implemented.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="dynamic-insert-update">8.10. Selective column lists in inserts and updates</h3>
<div class="paragraph">
<p>By default, Hibernate generates <code>insert</code> and <code>update</code> statements for each entity during boostrap, and reuses the same <code>insert</code> statement every time an instance of the entity is made persistent, and the same <code>update</code> statement every time an instance of the entity is modified.</p>
</div>
<div class="paragraph">
<p>This means that:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>if an attribute is <code>null</code> when the entity is made persistent, its mapped column is redundantly included in the SQL <code>insert</code>, and</p>
</li>
<li>
<p>worse, if a certain attribute is unmodified when other attributes are changed, the column mapped by that attribute is redundantly included in the SQL <code>update</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Most of the time, this just isn&#8217;t an issue worth worrying about.
The cost of interacting with the database is <em>usually</em> dominated by the cost of a round trip, not by the number of columns in the <code>insert</code> or <code>update</code>.
But in cases where it does become important, there are two ways to be more selective about which columns are included in the SQL.</p>
</div>
<div class="paragraph">
<p>The JPA-standard way is to indicate statically which columns are eligible for inclusion via the <code>@Column</code> annotation.
For example, if an entity is always created with an immutable <code>creationDate</code>, and with no <code>completionDate</code>, then we would write:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Column</span><span class="o">(</span><span class="n">updatable</span><span class="o">=</span><span class="kc">false</span><span class="o">)</span> <span class="nc">LocalDate</span> <span class="n">creationDate</span><span class="o">;</span>
<span class="nd">@Column</span><span class="o">(</span><span class="n">insertable</span><span class="o">=</span><span class="kc">false</span><span class="o">)</span> <span class="nc">LocalDate</span> <span class="n">completionDate</span><span class="o">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This approach works quite well in many cases, but often breaks down for entities with more than a handful of updatable columns.</p>
</div>
<div class="paragraph">
<p>An alternative solution is to ask Hibernate to generate SQL dynamically each time an <code>insert</code> or <code>update</code> is executed.
We do this by annotating the entity class.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 67. Annotations for dynamic SQL generation</caption>
<colgroup>
<col style="width: 25%;">
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Annotation</th>
<th class="tableblock halign-left valign-top">Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://docs.jboss.org/hibernate/orm/6.3/javadocs/org/hibernate/annotations/DynamicInsert.html"><code>@DynamicInsert</code></a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies that an <code>insert</code> statement should be generated each time an entity is made persistent</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://docs.jboss.org/hibernate/orm/6.3/javadocs/org/hibernate/annotations/DynamicUpdate.html"><code>@DynamicUpdate</code></a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies that an <code>update</code> statement should be generated each time an entity is modified</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>It&#8217;s important to realize that, while <code>@DynamicInsert</code> has no impact on semantics, the more useful <code>@DynamicUpdate</code> annotation <em>does</em> have a subtle side effect.</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The wrinkle is that if an entity has no version property, <code>@DynamicUpdate</code> opens the possibility of two optimistic transactions concurrently reading and selectively updating a given instance of the entity.
In principle, this might lead to a row with inconsistent column values after both optimistic transactions commit successfully.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Of course, this consideration doesn&#8217;t arise for entities with a <code>@Version</code> attribute.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>But there&#8217;s a solution!
Well-designed relational schemas should have <em>constraints</em> to ensure data integrity.
That&#8217;s true no matter what measures we take to preserve integrity in our program logic.
We may ask Hibernate to add a <a href="#constraints"><code>check</code> constraint</a> to our table using the <code>@Check</code> annotation.
Check constraints and foreign key constraints can help ensure that a row never contains inconsistent column values.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="bytecode-enhancer">8.11. Using the bytecode enhancer</h3>
<div class="paragraph">
<p>Hibernate&#8217;s <a href="https://docs.jboss.org/hibernate/orm/6.3/userguide/html_single/Hibernate_User_Guide.html#BytecodeEnhancement">bytecode enhancer</a> enables the following features:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>attribute-level lazy fetching</em> for basic attributes annotated <code>@Basic(fetch=LAZY)</code> and for lazy non-polymorphic associations,</p>
</li>
<li>
<p><em>interception-based</em>—instead of the usual <em>snapshot-based</em>—detection of modifications.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To use the bytecode enhancer, we must add the Hibernate plugin to our gradle build:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="n">plugins</span> <span class="o">{</span>
    <span class="n">id</span> <span class="s2">"org.hibernate.orm"</span> <span class="n">version</span> <span class="s2">"6.3.0.Final"</span>
<span class="o">}</span>

<span class="n">hibernate</span> <span class="o">{</span> <span class="n">enhancement</span> <span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Consider this field:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Entity</span>
<span class="kd">class</span> <span class="nc">Book</span> <span class="o">{</span>
    <span class="o">...</span>

    <span class="nd">@Basic</span><span class="o">(</span><span class="n">optional</span> <span class="o">=</span> <span class="kc">false</span><span class="o">,</span> <span class="n">fetch</span> <span class="o">=</span> <span class="no">LAZY</span><span class="o">)</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="n">length</span> <span class="o">=</span> <span class="no">LONG32</span><span class="o">)</span>
    <span class="nc">String</span> <span class="n">fullText</span><span class="o">;</span>

    <span class="o">...</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>fullText</code> field maps to a <code>clob</code> or <code>text</code> column, depending on the SQL dialect.
Since it&#8217;s expensive to retrieve the full book-length text, we&#8217;ve mapped the field <code>fetch=LAZY</code>, telling Hibernate not to read the field until it&#8217;s actually used.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>Without</em> the bytecode enhancer, this instruction is ignored, and the field is always fetched immediately, as part of the initial <code>select</code> that retrieves the <code>Book</code> entity.</p>
</li>
<li>
<p><em>With</em> bytecode enhancement, Hibernate is able to detect access to the field, and lazy fetching is possible.</p>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>By default, Hibernate fetches all lazy fields of a given entity at once, in a single <code>select</code>, when any one of them is accessed.
Using the <a href="https://docs.jboss.org/hibernate/orm/6.3/javadocs/org/hibernate/annotations/LazyGroup.html"><code>@LazyGroup</code></a> annotation, it&#8217;s possible to assign fields to distinct "fetch groups", so that different lazy fields may be fetched independently.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Similarly, interception lets us implement lazy fetching for non-polymorphic associations without the need for a separate proxy object.
However, if an association is polymorphic, that is, if the target entity type has subclasses, then a proxy is still required.</p>
</div>
<div class="paragraph">
<p>Interception-based change detection is a nice performance optimization with a slight cost in terms of correctness.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>Without</em> the bytecode enhancer, Hibernate keeps a snapshot of the state of each entity after reading from or writing to the database.
When the session flushes, the snapshot state is compared to the current state of the entity to determine if the entity has been modified.
Maintaining these snapshots does have an impact on performance.</p>
</li>
<li>
<p><em>With</em> bytecode enhancement, we may avoid this cost by intercepting writes to the field and recording these modifications as they happen.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This optimization isn&#8217;t <em>completely</em> transparent, however.</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Interception-based change detection is less accurate than snapshot-based dirty checking.
For example, consider this attribute:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kt">byte</span><span class="o">[]</span> <span class="n">image</span><span class="o">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Interception is able to detect writes to the <code>image</code> field, that is, replacement of the whole array.
It&#8217;s not able to detect modifications made directly to the <em>elements</em> of the array, and so such modifications may be lost.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="fetch-profiles">8.12. Named fetch profiles</h3>
<div class="paragraph">
<p>We&#8217;ve already seen two different ways to override the default <a href="#association-fetching">fetching strategy</a> for an association:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#entity-graph">JPA entity graphs</a>, and</p>
</li>
<li>
<p>the <code>join fetch</code> clause in <a href="#hql-queries">HQL</a>, or, equivalently, the method <code>From.fetch()</code> in the criteria query API.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>A third way is to define a named fetch profile.
First, we must declare the profile, by annotating a class or package:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@FetchProfile</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"EagerBook"</span><span class="o">)</span>
<span class="nd">@Entity</span>
<span class="kd">class</span> <span class="nc">Book</span> <span class="o">{</span> <span class="o">...</span> <span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that even though we&#8217;ve placed this annotation on the <code>Book</code> entity, a fetch profile—unlike an entity graph—isn&#8217;t "rooted" at any particular entity.</p>
</div>
<div class="paragraph">
<p>We may specify association fetching strategies using the <code>fetchOverrides</code> member of the <code>@FetchProfile</code> annotation, but frankly it looks so messy that we&#8217;re embarrassed to show it to you here.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Similarly, a JPA <a href="#entity-graph">entity graph</a> may be defined using <code>@NamedEntityGraph</code>.
But the format of this annotation is <em>even worse</em> than <code>@FetchProfile(fetchOverrides=&#8230;&#8203;)</code>, so we can&#8217;t recommend it. 💀</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>A better way is to annotate an association with the fetch profiles it should be fetched in:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@FetchProfile</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"EagerBook"</span><span class="o">)</span>
<span class="nd">@Entity</span>
<span class="kd">class</span> <span class="nc">Book</span> <span class="o">{</span>
    <span class="o">...</span>

    <span class="nd">@ManyToOne</span><span class="o">(</span><span class="n">fetch</span> <span class="o">=</span> <span class="no">LAZY</span><span class="o">)</span>
    <span class="nd">@FetchProfileOverride</span><span class="o">(</span><span class="n">profile</span> <span class="o">=</span> <span class="n">Book_</span><span class="o">.</span><span class="na">PROFILE_EAGER_BOOK</span><span class="o">,</span> <span class="n">mode</span> <span class="o">=</span> <span class="no">JOIN</span><span class="o">)</span>
    <span class="nc">Publisher</span> <span class="n">publisher</span><span class="o">;</span>

    <span class="nd">@ManyToMany</span>
    <span class="nd">@FetchProfileOverride</span><span class="o">(</span><span class="n">profile</span> <span class="o">=</span> <span class="n">Book_</span><span class="o">.</span><span class="na">PROFILE_EAGER_BOOK</span><span class="o">,</span> <span class="n">mode</span> <span class="o">=</span> <span class="no">JOIN</span><span class="o">)</span>
    <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">Author</span><span class="o">&gt;</span> <span class="n">authors</span><span class="o">;</span>

    <span class="o">...</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Entity</span>
<span class="kd">class</span> <span class="nc">Author</span> <span class="o">{</span>
    <span class="o">...</span>

    <span class="nd">@OneToOne</span>
    <span class="nd">@FetchProfileOverride</span><span class="o">(</span><span class="n">profile</span> <span class="o">=</span> <span class="n">Book_</span><span class="o">.</span><span class="na">PROFILE_EAGER_BOOK</span><span class="o">,</span> <span class="n">mode</span> <span class="o">=</span> <span class="no">JOIN</span><span class="o">)</span>
    <span class="nc">Person</span> <span class="n">person</span><span class="o">;</span>

    <span class="o">...</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here, once again, <code>Book_.PROFILE_EAGER_BOOK</code> is generated by the Metamodel Generator, and is just a constant with the value <code>"EagerBook"</code>.</p>
</div>
<div class="paragraph">
<p>For collections, we may even request subselect fetching:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@FetchProfile</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"EagerBook"</span><span class="o">)</span>
<span class="nd">@FetchProfile</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"BookWithAuthorsBySubselect"</span><span class="o">)</span>
<span class="nd">@Entity</span>
<span class="kd">class</span> <span class="nc">Book</span> <span class="o">{</span>
    <span class="o">...</span>

    <span class="nd">@OneToOne</span>
    <span class="nd">@FetchProfileOverride</span><span class="o">(</span><span class="n">profile</span> <span class="o">=</span> <span class="n">Book_</span><span class="o">.</span><span class="na">PROFILE_EAGER_BOOK</span><span class="o">,</span> <span class="n">mode</span> <span class="o">=</span> <span class="no">JOIN</span><span class="o">)</span>
    <span class="nc">Person</span> <span class="n">person</span><span class="o">;</span>

    <span class="nd">@ManyToMany</span>
    <span class="nd">@FetchProfileOverride</span><span class="o">(</span><span class="n">profile</span> <span class="o">=</span> <span class="n">Book_</span><span class="o">.</span><span class="na">PROFILE_EAGER_BOOK</span><span class="o">,</span> <span class="n">mode</span> <span class="o">=</span> <span class="no">JOIN</span><span class="o">)</span>
    <span class="nd">@FetchProfileOverride</span><span class="o">(</span><span class="n">profile</span> <span class="o">=</span> <span class="n">Book_</span><span class="o">.</span><span class="na">BOOK_WITH_AUTHORS_BY_SUBSELECT</span><span class="o">,</span>
                          <span class="n">mode</span> <span class="o">=</span> <span class="no">SUBSELECT</span><span class="o">)</span>
    <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">Author</span><span class="o">&gt;</span> <span class="n">authors</span><span class="o">;</span>

    <span class="o">...</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We may define as many different fetch profiles as we like.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 68. Annotations for defining fetch profiles</caption>
<colgroup>
<col style="width: 25%;">
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Annotation</th>
<th class="tableblock halign-left valign-top">Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@FetchProfile</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Declares a named fetch profile, optionally including a list of <code>@FetchOverride</code>s</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@FetchProfile.FetchOverride</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Declares a fetch strategy override as part of the <code>@FetchProfile</code> declaration</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@FetchProfileOverride</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies the fetch strategy for the annotated association, in a given fetch profile</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>A fetch profile must be explicitly enabled for a given session:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="n">session</span><span class="o">.</span><span class="na">enableFetchProfile</span><span class="o">(</span><span class="n">Book_</span><span class="o">.</span><span class="na">PROFILE_EAGER_BOOK</span><span class="o">);</span>
<span class="nc">Book</span> <span class="n">eagerBook</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">find</span><span class="o">(</span><span class="nc">Book</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">bookId</span><span class="o">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>So why or when might we prefer named fetch profiles to entity graphs?
Well, it&#8217;s really hard to say.
It&#8217;s nice that this feature <em>exists</em>, and if you love it, that&#8217;s great.
But Hibernate offers alternatives that we think are more compelling most of the time.</p>
</div>
<div class="paragraph">
<p>The one and only advantage unique to fetch profiles is that they let us very selectively request subselect fetching.
We can&#8217;t do that with entity graphs, and we can&#8217;t do it with HQL.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>There&#8217;s a special built-in fetch profile named <code>org.hibernate.defaultProfile</code> which is defined as the profile with <code>@FetchProfileOverride(mode=JOIN)</code> applied to every eager <code>@ManyToOne</code> or <code>@OneToOne</code> association.
If you enable this profile:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="n">session</span><span class="o">.</span><span class="na">enableFetchProfile</span><span class="o">(</span><span class="s">"org.hibernate.defaultProfile"</span><span class="o">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Then <code>outer join</code>s for such associations will <em>automatically</em> be added to every HQL or criteria query.
This is nice if you can&#8217;t be bothered typing out those <code>join fetch</code>es explicitly.
And in principle it even helps partially mitigate the <a href="#lazy-problem">problem</a> of JPA having specified the wrong default for the <code>fetch</code> member of <code>@ManyToOne</code>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="credits">9. Credits</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The full list of contributors to Hibernate ORM can be found on the
<a href="https://github.com/hibernate/hibernate-orm/graphs/contributors">GitHub repository</a>.</p>
</div>
<div class="paragraph">
<p>The following contributors were involved in this documentation:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Gavin King</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Version 6.3.2.Final<br>
Last updated 2023-11-23 14:49:43 UTC
</div>
</div>
<link rel="stylesheet" href="./rouge-github.css">
</body>
</html>