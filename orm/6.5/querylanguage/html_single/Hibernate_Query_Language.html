<!DOCTYPE html>
<html lang="">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.18">
<title>A Guide to Hibernate Query Language</title>
<link rel="stylesheet" href="./css/hibernate.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="stylesheet" href="./rouge-github.css">
</head>
<body class="book">
<div id="header">
<h1>A Guide to Hibernate Query Language</h1>
<div class="details">
<span id="revnumber">version 6.5.3.Final</span>
</div>
<div id="toc" class="toc">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#preface">Preface</a></li>
<li><a href="#basic-concepts">1. Basic concepts</a>
<ul class="sectlevel2">
<li><a href="#and-sqk">1.1. HQL and SQL</a></li>
<li><a href="#_lexical_structure">1.2. Lexical structure</a>
<ul class="sectlevel3">
<li><a href="#case-sensitivity">1.2.1. Identifiers and case sensitivity</a></li>
<li><a href="#comments">1.2.2. Comments</a></li>
<li><a href="#parameters">1.2.3. Parameters</a></li>
<li><a href="#_literals">1.2.4. Literals</a></li>
</ul>
</li>
<li><a href="#syntax">1.3. Syntax</a></li>
<li><a href="#type-system">1.4. Type system</a>
<ul class="sectlevel3">
<li><a href="#null-values-and-ternary-logic">1.4.1. Null values and ternary logic</a></li>
</ul>
</li>
<li><a href="#statement-types">1.5. Statement types</a>
<ul class="sectlevel3">
<li><a href="#update">1.5.1. Update statements</a></li>
<li><a href="#delete">1.5.2. Delete statements</a></li>
<li><a href="#insert">1.5.3. Insert statements</a></li>
<li><a href="#select">1.5.4. Select statements</a></li>
</ul>
</li>
<li><a href="#returning-to-java">1.6. Representing result sets in Java</a>
<ul class="sectlevel3">
<li><a href="#query-result-types-single">1.6.1. Queries with a single projected item</a></li>
<li><a href="#query-result-types-multiple">1.6.2. Queries with multiple projected items</a></li>
<li><a href="#select-new">1.6.3. Instantiation</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#expressions">2. Expressions</a>
<ul class="sectlevel2">
<li><a href="#literals">2.1. Literals</a>
<ul class="sectlevel3">
<li><a href="#boolean-literals">2.1.1. Boolean literals</a></li>
<li><a href="#string-literals">2.1.2. String literals</a></li>
<li><a href="#numeric-literals">2.1.3. Numeric literals</a></li>
<li><a href="#datetime-literals">2.1.4. Date and time literals</a></li>
<li><a href="#duration-literals">2.1.5. Duration literals</a></li>
<li><a href="#binary-literals">2.1.6. Binary string literals</a></li>
<li><a href="#enum-literals">2.1.7. Enum literals</a></li>
<li><a href="#java-constants">2.1.8. Java constants</a></li>
<li><a href="#entity-name-literals">2.1.9. Literal entity names</a></li>
</ul>
</li>
<li><a href="#path-expressions">2.2. Identification variables and path expressions</a></li>
<li><a href="#_operator_expressions">2.3. Operator expressions</a>
<ul class="sectlevel3">
<li><a href="#concatenation">2.3.1. String concatenation</a></li>
<li><a href="#numeric-arithmetic">2.3.2. Numeric arithmetic</a></li>
<li><a href="#Datetime-arithmetic">2.3.3. Datetime arithmetic</a></li>
</ul>
</li>
<li><a href="#case-expressions">2.4. Case expressions</a></li>
<li><a href="#tuple-instantiation">2.5. Tuples</a></li>
<li><a href="#exp-functions">2.6. Functions</a>
<ul class="sectlevel3">
<li><a href="#functions-typecasts">2.6.1. Types and typecasts</a></li>
<li><a href="#functions-null">2.6.2. Functions for working with null values</a></li>
<li><a href="#functions-datetime">2.6.3. Functions for working with dates and times</a></li>
<li><a href="#string-functions">2.6.4. Functions for working with strings</a></li>
<li><a href="#functions-numeric">2.6.5. Numeric functions</a></li>
<li><a href="#functions-collections">2.6.6. Functions for dealing with collections</a></li>
<li><a href="#functions-model">2.6.7. Functions for working with ids and versions</a></li>
<li><a href="#embedding-sql">2.6.8. Embedding SQL expressions</a></li>
</ul>
</li>
<li><a href="#conditional-expressions">2.7. Predicates</a>
<ul class="sectlevel3">
<li><a href="#relational-comparisons">2.7.1. Comparison operators</a></li>
<li><a href="#between-predicate">2.7.2. The <code>between</code> predicate</a></li>
<li><a href="#null-predicate">2.7.3. Operators for dealing with null</a></li>
<li><a href="#boolean-predicate">2.7.4. Operators for dealing with boolean values</a></li>
<li><a href="#collection-operators">2.7.5. Collection predicates</a></li>
<li><a href="#like-predicate">2.7.6. String pattern matching</a></li>
<li><a href="#in-predicate">2.7.7. The <code>in</code> predicate</a></li>
<li><a href="#relational-comparisons-subqueries">2.7.8. Comparison operators and subqueries</a></li>
<li><a href="#exists-predicate">2.7.9. The <code>exists</code> predicate</a></li>
<li><a href="#logical-operators">2.7.10. Logical operators</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#root-entities-and-joins">3. Root entities and joins</a>
<ul class="sectlevel2">
<li><a href="#from-clause">3.1. Declaring root entities</a>
<ul class="sectlevel3">
<li><a href="#identification-variables">3.1.1. Identification variables</a></li>
<li><a href="#root-reference">3.1.2. Root entity references</a></li>
<li><a href="#polymorphism">3.1.3. Polymorphism</a></li>
<li><a href="#derived-root">3.1.4. Derived roots</a></li>
<li><a href="#from-cte">3.1.5. Common table expressions in <code>from</code> clause</a></li>
</ul>
</li>
<li><a href="#join">3.2. Declaring joined entities</a>
<ul class="sectlevel3">
<li><a href="#root-join">3.2.1. Explicit root joins</a></li>
<li><a href="#explicit-join">3.2.2. Explicit association joins</a></li>
<li><a href="#explicit-join-conditions">3.2.3. Explicit association joins with join conditions</a></li>
<li><a href="#explicit-fetch-join">3.2.4. Association fetching</a></li>
<li><a href="#join-treat">3.2.5. Joins with typecasts</a></li>
<li><a href="#join-derived">3.2.6. Subqueries in joins</a></li>
<li><a href="#implicit-join">3.2.7. Implicit association joins (path expressions)</a></li>
<li><a href="#collection-valued-associations">3.2.8. Joining collections and many-valued associations</a></li>
<li><a href="#implicit-collection-join">3.2.9. Implicit joins involving collections</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#selection-projection-aggregation">4. Selection, projection, and aggregation</a>
<ul class="sectlevel2">
<li><a href="#where-clause">4.1. Restriction</a></li>
<li><a href="#aggregation">4.2. Aggregation</a>
<ul class="sectlevel3">
<li><a href="#group-by">4.2.1. Aggregation and grouping</a></li>
<li><a href="#group-by-rollup-cube">4.2.2. Totals and subtotals</a></li>
<li><a href="#having">4.2.3. Aggregation and restriction</a></li>
</ul>
</li>
<li><a href="#select-clause">4.3. Projection</a>
<ul class="sectlevel3">
<li><a href="#distinct">4.3.1. Duplicate removal</a></li>
<li><a href="#aggregate-functions">4.3.2. Aggregate functions</a></li>
<li><a href="#aggregate-functions-collections">4.3.3. Aggregate functions and collections</a></li>
<li><a href="#aggregate-functions-filter">4.3.4. Aggregate functions with restriction</a></li>
<li><a href="#aggregate-functions-orderedset">4.3.5. Ordered set aggregate functions</a></li>
<li><a href="#aggregate-functions-window">4.3.6. Window functions</a></li>
</ul>
</li>
<li><a href="#set-operators">4.4. Operations on result sets</a></li>
<li><a href="#order-by">4.5. Sorting</a>
<ul class="sectlevel3">
<li><a href="#limit-offset">4.5.1. Limits and offsets</a></li>
</ul>
</li>
<li><a href="#with-cte">4.6. Common table expressions</a>
<ul class="sectlevel3">
<li><a href="#materialization-hints">4.6.1. Materialization hints</a></li>
<li><a href="#recursive-queries">4.6.2. Recursive queries</a></li>
<li><a href="#_cycle_detection">4.6.3. Cycle detection</a></li>
<li><a href="#_ordering_depth_first_or_breadth_first">4.6.4. Ordering depth-first or breadth-first</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#credits">5. Credits</a></li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="preface">Preface</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Hibernate 6 is a major redesign of the world&#8217;s most popular and feature-rich ORM solution.
The redesign has touched almost every subsystem of Hibernate, including the APIs, mapping annotations, and, above all else, the query language.</p>
</div>
<div class="paragraph">
<p>This is the second time Hibernate Query Language has been completely reimplemented from scratch, but the first time in more than fifteen years.
In this new incarnation, HQL is far more powerful, and the HQL compiler much more robust.</p>
</div>
<div class="paragraph">
<p>At long last, HQL has a feature set to match that of modern dialects of SQL, and is able to take full advantage of the power of modern SQL databases.</p>
</div>
<div class="paragraph">
<p>This document is a reference guide to the full feature set of the language, and is the only up-to-date source for those who wish to learn how to write HQL effectively in Hibernate 6.</p>
</div>
<div class="paragraph">
<p>If you are unfamiliar with Hibernate, be sure to first read  <a href="https://docs.jboss.org/hibernate/orm/6.5/introduction/html_single/Hibernate_Introduction.html">Introduction to Hibernate</a> or check out the <a href="https://docs.jboss.org/hibernate/orm/6.5/quickstart/html_single/">Quick Start</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="basic-concepts">1. Basic concepts</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This document describes Hibernate Query Language (HQL), which is, I suppose we could say, a "dialect" of the Java (now Jakarta) Persistence Query Language (JPQL).</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Or is it the other way around?</p>
</div>
<div class="paragraph">
<p>JPQL was inspired by early versions of HQL, and is a proper subset of modern HQL.
Here we focus on describing the complete, more powerful HQL language as it exists today.</p>
</div>
<div class="paragraph">
<p>If strict JPA compliance is what you&#8217;re looking for, use the setting <code>hibernate.jpa.compliance.query=true</code>.
With this configuration, any attempt to use HQL features beyond the JPQL subset will result in an exception.</p>
</div>
<div class="paragraph">
<p>We don&#8217;t recommend the use of this setting.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The truth is that HQL today has capabilities that go far beyond what is possible in plain JPQL.
We&#8217;re not going to fuss too much about not limiting ourselves to the standard here.
Faced with a choice between writing database-specific native SQL, or database-independent HQL, we know what our preference is.</p>
</div>
<div class="sect2">
<h3 id="and-sqk">1.1. HQL and SQL</h3>
<div class="paragraph">
<p>Throughout this document, we&#8217;ll assume you know SQL and the relational model, at least at a basic level.
HQL and JPQL are loosely based on SQL and are easy to learn for anyone familiar with SQL.</p>
</div>
<div class="paragraph">
<p>For example, if you understand this SQL query:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sql"><span class="k">select</span> <span class="n">book</span><span class="p">.</span><span class="n">title</span><span class="p">,</span> <span class="n">pub</span><span class="p">.</span><span class="n">name</span>            <span class="cm">/* projection */</span>
<span class="k">from</span> <span class="n">Book</span> <span class="k">as</span> <span class="n">book</span>                      <span class="cm">/* root table */</span>
    <span class="k">join</span> <span class="n">Publisher</span> <span class="k">as</span> <span class="n">pub</span>              <span class="cm">/* table join */</span>
        <span class="k">on</span> <span class="n">book</span><span class="p">.</span><span class="n">publisherId</span> <span class="o">=</span> <span class="n">pub</span><span class="p">.</span><span class="n">id</span>   <span class="cm">/* join condition */</span>
<span class="k">where</span> <span class="n">book</span><span class="p">.</span><span class="n">title</span> <span class="k">like</span> <span class="s1">'Hibernate%'</span>     <span class="cm">/* restriction (selection) */</span>
<span class="k">order</span> <span class="k">by</span> <span class="n">book</span><span class="p">.</span><span class="n">title</span>                    <span class="cm">/* sorting */</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Then we bet you can already make sense of this HQL:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sql"><span class="k">select</span> <span class="n">book</span><span class="p">.</span><span class="n">title</span><span class="p">,</span> <span class="n">pub</span><span class="p">.</span><span class="n">name</span>            <span class="cm">/* projection */</span>
<span class="k">from</span> <span class="n">Book</span> <span class="k">as</span> <span class="n">book</span>                      <span class="cm">/* root entity */</span>
    <span class="k">join</span> <span class="n">book</span><span class="p">.</span><span class="n">publisher</span> <span class="k">as</span> <span class="n">pub</span>         <span class="cm">/* association join */</span>
<span class="k">where</span> <span class="n">book</span><span class="p">.</span><span class="n">title</span> <span class="k">like</span> <span class="s1">'Hibernate%'</span>     <span class="cm">/* restriction (selection) */</span>
<span class="k">order</span> <span class="k">by</span> <span class="n">book</span><span class="p">.</span><span class="n">title</span>                    <span class="cm">/* sorting */</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You might notice that even for this very simple example, the HQL version is slightly shorter.
This is typical.
Actually, HQL queries are usually much more compact than the SQL they compile to.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>But there&#8217;s one huge difference: in HQL, <code>Book</code> refers to an entity class written in Java, and <code>book.title</code> to a field of that class.
We&#8217;re not permitted to directly reference database tables and columns in HQL or JPQL.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In this chapter, we&#8217;ll demonstrate how similar HQL is to SQL by giving a quick overview of the basic statement types.
You&#8217;ll be bored to discover they&#8217;re exactly the ones you expect: <code>select</code>, <code>insert</code>, <code>update</code>, and <code>delete</code>.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This is a reference guide.
We&#8217;re not going to explain basic concepts like ternary logic, joins, aggregation, selection, or projection, because that information is freely available elsewhere, and anyway we couldn&#8217;t possibly do these topics justice here.
If you don&#8217;t have a firm grasp of these ideas, it&#8217;s time to pick up a book about SQL or about the relational model.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>But first we need to mention something that&#8217;s a bit different to SQL.
HQL has a slightly complicated way of dealing with case sensitively.</p>
</div>
</div>
<div class="sect2">
<h3 id="_lexical_structure">1.2. Lexical structure</h3>
<div class="paragraph">
<p>Lexically, JPQL is quite similar to SQL, so in this section we&#8217;ll limit ourselves to mentioning those places where it differs.</p>
</div>
<div class="sect3">
<h4 id="case-sensitivity">1.2.1. Identifiers and case sensitivity</h4>
<div class="paragraph">
<p>An identifier is a name used to refer to an entity, an attribute of a Java class, an <a href="#identification-variables">identification variable</a>, or a function.</p>
</div>
<div class="paragraph">
<p>For example, <code>Book</code>, <code>title</code>, <code>author</code>, and <code>upper</code> are all identifiers, but they refer to different kinds of things.
In HQL and JPQL, the case sensitivity of an identifier depends on the kind of thing the identifier refers to.</p>
</div>
<div class="paragraph">
<p>The rules for case sensitivity are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>keywords and function names are case-insensitive, but</p>
</li>
<li>
<p>identification variable names, Java class names, and the names of attributes of Java classes, are case-sensitive.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>We apologize for this inconsistency.
In hindsight, it might have been better to define the whole language as case-sensitive.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Incidentally, it&#8217;s standard practice to use lowercase keywords in HQL.</p>
</div>
<div class="paragraph">
<p>The use of uppercase keywords indicates an endearing but unhealthy attachment to the culture of the 1970&#8217;s.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Just to reiterate these rules:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 45%;">
<col>
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>select</code>, <code>SeLeCT</code>, <code>sELEct</code>, and <code>SELECT</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">All the same, <code>select</code> is a keyword</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>upper(name)</code> and <code>UPPER(name)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Same, <code>upper</code> is a function name</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>from BackPack</code> and <code>from Backpack</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Different, refer to different Java classes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>person.nickName</code> and <code>person.nickname</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Different, since the path expression element <code>nickName</code> refers to an attribute of an entity defined in Java</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>person.nickName</code>, <code>Person.nickName</code>, and <code>PERSON.nickName</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">All different, since the first element of a path expression is an <a href="#identification-variables">identification variable</a></p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The JPQL specification defines identification variables as case-<em>insensitive</em>.
And so in strict JPA-compliant mode, Hibernate treats <code>person.nickName</code>, <code>Person.nickName</code>, and <code>PERSON.nickName</code> as the <em>same</em>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>A <em>quoted identifier</em> is written in backticks. Quoting lets you use a keyword as an identifier.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">select</span> <span class="n">thing</span><span class="p">.</span><span class="nb">interval</span><span class="p">.</span><span class="nv">`from`</span> <span class="k">from</span> <span class="n">Thing</span> <span class="n">thing</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Actually, in most contexts, HQL keywords are "soft", and don&#8217;t need to be quoted.
The parser is usually able to distinguish if the reserved word is being used as a keyword or as an identifier.</p>
</div>
</div>
<div class="sect3">
<h4 id="comments">1.2.2. Comments</h4>
<div class="paragraph">
<p>Comments in HQL look like multiline comments in Java.
They&#8217;re delimited by <code>/*</code> and <code>*/</code>.</p>
</div>
<div class="paragraph">
<p>Neither SQL-style <code>--</code> nor Java-style <code>//</code> line-ending comments are allowed.</p>
</div>
<div class="paragraph">
<p>It&#8217;s quite rare to see comments in HQL, but perhaps it will be more common now that Java has text blocks.</p>
</div>
</div>
<div class="sect3">
<h4 id="parameters">1.2.3. Parameters</h4>
<div class="paragraph">
<p>Parameters come in two flavors in JPQL, and HQL supports a third flavor for historical reasons:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 35%;">
<col style="width: 25%;">
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Parameter type</th>
<th class="tableblock halign-left valign-top">Examples</th>
<th class="tableblock halign-left valign-top">Usage from Java</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Named parameters</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>:name</code>, <code>:title</code>, <code>:id</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>query.setParameter("name", name)</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Ordinal parameters</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>?1</code>, <code>?2</code>, <code>?3</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>query.setParameter(1, name)</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">JDBC-style parameters ðŸ’€</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>?</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>query.setParameter(1, name)</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>JDBC-style parameters of form <code>?</code> are like ordinal parameters where the index is inferred from the position in the text of the query.
JDBC-style parameters are deprecated.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>It&#8217;s <em>extremely</em> important to use parameters to pass user input to the database.
Constructing a query by concatenating HQL fragments with user input is extremely dangerous, opening the door to the possibility of executing arbitrary code on the database server.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_literals">1.2.4. Literals</h4>
<div class="paragraph">
<p>Some of the syntax for literal values also departs from the standard syntax in ANSI SQL, especially in the area of date/time literals, but we&#8217;ll discuss all that later, in <a href="#literals">Literals</a>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="syntax">1.3. Syntax</h3>
<div class="paragraph">
<p>We&#8217;ll describe the syntax of the language as we go along, sometimes displaying fragments of the grammar in an ANTLR-like BNF form.
(Occasionally we&#8217;ll simplify these snippets for readability, so please don&#8217;t take them as canonical.)</p>
</div>
<div class="paragraph">
<p>The full canonical grammar for HQL can be found in <a href="https://github.com/hibernate/hibernate-orm/blob/main/hibernate-core/src/main/antlr/org/hibernate/grammars/hql/HqlParser.g4">the github project</a>.</p>
</div>
<div class="paragraph">
<p>The grammar for JPQL may be found in chapter 4 of the JPA specification.</p>
</div>
</div>
<div class="sect2">
<h3 id="type-system">1.4. Type system</h3>
<div class="paragraph">
<p>JPA doesn&#8217;t have a well-specified type system, but, reading between the lines a bit, the following types may be discerned:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>entity types,</p>
</li>
<li>
<p>numeric values,</p>
</li>
<li>
<p>strings,</p>
</li>
<li>
<p>dates/times,</p>
</li>
<li>
<p>booleans, and</p>
</li>
<li>
<p>enumerated types.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Such a coarse-grained type system is in some sense an insufficient constraint on implementors of the specification, or, viewed from a different perspective, it leaves us quite a lot of flexibility.</p>
</div>
<div class="paragraph">
<p>The way HQL interprets this type system is to assign a Java type to every expression in the language.
Thus, numeric expressions have types like <code>Long</code>, <code>Float</code>, or <code>BigInteger</code>, date/time expressions have types like <code>LocalDate</code>, <code>LocalDateTime</code>, or <code>Instant</code>, and boolean expressions are always of type <code>Boolean</code>.</p>
</div>
<div class="paragraph">
<p>Going further, an expression like <code>local datetime - document.created</code> is assigned the Java type <code>java.time.Duration</code>, a type which doesn&#8217;t appear anywhere in the JPA specification.</p>
</div>
<div class="paragraph">
<p>Since the language must be executed on SQL databases, every type accommodates null values.</p>
</div>
<div class="sect3">
<h4 id="null-values-and-ternary-logic">1.4.1. Null values and ternary logic</h4>
<div class="paragraph">
<p>The SQL <code>null</code> behaves quite differently to a null value in Java.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>In Java, an expression like <code>number + 1</code> produces in an exception if <code>number</code> is null.</p>
</li>
<li>
<p>But in SQL, and therefore also in HQL and JPQL, such an expression evaluates to <code>null</code>.</p>
</li>
</ul>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>It&#8217;s almost always the case that an operation applied to a null value yields another null value.
This rule applies to function application, to operators like <code>*</code> and <code>||</code>, to comparison operators like <code>&lt;</code> and <code>=</code>, and even to logical operations like <code>and</code> and <code>not</code>.</p>
</div>
<div class="paragraph">
<p>The exceptions to this rule are the <code>is null</code> operator and the functions <code>coalesce()</code> and <code>ifnull()</code> which are specifically designed for <a href="#functions-null">dealing with null values</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This rule is the source of the famous (and controversial) <em>ternary logic</em> of SQL.
A logical expression like <code>firstName='Gavin' and team='Hibernate'</code> isn&#8217;t restricted to the values <code>true</code> and <code>false</code>.
It may also be <code>null</code>.</p>
</div>
<div class="paragraph">
<p>This can, in principle, lead to some quite unintuitive results: we can&#8217;t use the law of the excluded middle to reason about logical expressions in SQL!
But in practice, we&#8217;ve never once run into a case where this caused us problems.</p>
</div>
<div class="paragraph">
<p>As you probably know, when a logical predicate occurs as a <a href="#where-clause">restriction</a>, rows for which the predicate evaluates to <code>null</code> are <em>excluded</em> from the result set.
That is, in this context at least, a logical null is interpreted as "effectively false".</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="statement-types">1.5. Statement types</h3>
<div class="paragraph">
<p>HQL features four different kinds of statement:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>select</code> queries,</p>
</li>
<li>
<p><code>update</code> statements,</p>
</li>
<li>
<p><code>delete</code> statements, and</p>
</li>
<li>
<p><code>insert &#8230;&#8203; values</code> and <code>insert &#8230;&#8203; select</code> statements.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Collectively, <code>insert</code>, <code>update</code>, and <code>delete</code> statements are sometimes called <em>mutation queries</em>.
We need to be a little bit careful when executing mutation queries via a stateful session.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The effect of an <code>update</code> or <code>delete</code> statement is not reflected in the persistence context, nor in the state of entity objects held in memory at the time the statement is executed.</p>
</div>
<div class="paragraph">
<p>It&#8217;s the responsibility of the client program to maintain synchronization of state held in memory with the database after execution of an <code>update</code> or <code>delete</code> statement.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Let&#8217;s consider each type of mutation query in turn, beginning with the most useful type.</p>
</div>
<div class="sect3">
<h4 id="update">1.5.1. Update statements</h4>
<div class="paragraph">
<p>The <a href="https://en.wikipedia.org/wiki/Backus%E2%80%93Naur_Form">BNF</a> for an <code>update</code> statement is quite straightforward:</p>
</div>
<div id="update-bnf-example" class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="antlrv4">updateStatement
    : "UPDATE" "VERSIONED"? targetEntity setClause whereClause?

targetEntity
	: entityName variable?

setClause
	: "SET" assignment ("," assignment)*

assignment
    : simplePath "=" expression</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>set</code> clause has a list of assignments to attributes of the given entity.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div id="update-example" class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">update</span> <span class="n">Person</span> <span class="k">set</span> <span class="n">nickName</span> <span class="o">=</span> <span class="s1">'Nacho'</span> <span class="k">where</span> <span class="n">name</span> <span class="o">=</span> <span class="s1">'Ignacio'</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Update statements are polymorphic, and affect mapped subclasses of the given entity class.
Therefore, a single HQL <code>update</code> statement might result in multiple SQL update statements executed against the database.</p>
</div>
<div class="paragraph">
<p>An <code>update</code> statement must be executed using <code>Query.executeUpdate()</code>.</p>
</div>
<div id="update-examples" class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="c1">// JPA API</span>
<span class="kt">int</span> <span class="n">updatedEntities</span> <span class="o">=</span> <span class="n">entityManager</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span>
        <span class="s">"update Person p set p.name = :newName where p.name = :oldName"</span><span class="o">)</span>
            <span class="o">.</span><span class="na">setParameter</span><span class="o">(</span><span class="s">"oldName"</span><span class="o">,</span> <span class="n">oldName</span><span class="o">)</span>
            <span class="o">.</span><span class="na">setParameter</span><span class="o">(</span><span class="s">"newName"</span><span class="o">,</span> <span class="n">newName</span><span class="o">)</span>
            <span class="o">.</span><span class="na">executeUpdate</span><span class="o">();</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="c1">// Hibernate native API</span>
<span class="kt">int</span> <span class="n">updatedEntities</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">createMutationQuery</span><span class="o">(</span>
        <span class="s">"update Person set name = :newName where name = :oldName"</span><span class="o">)</span>
            <span class="o">.</span><span class="na">setParameter</span><span class="o">(</span><span class="s">"oldName"</span><span class="o">,</span> <span class="n">oldName</span><span class="o">)</span>
            <span class="o">.</span><span class="na">setParameter</span><span class="o">(</span><span class="s">"newName"</span><span class="o">,</span> <span class="n">newName</span><span class="o">)</span>
            <span class="o">.</span><span class="na">executeUpdate</span><span class="o">();</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The integer value returned by <code>executeUpdate()</code> indicates the number of entity instances affected by the operation.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>In a <code>JOINED</code> inheritance hierarchy, multiple rows are required to store a single entity instance.
In this case, the update count returned by Hibernate might not be exactly the same as the number of rows affected in the database.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>An <code>update</code> statement, by default, does not affect the column mapped by the <code>@Version</code> attribute of the affected entities.</p>
</div>
<div class="paragraph">
<p>Adding the keyword <code>versioned</code>â€”writing <code>update versioned</code>â€”specifies that Hibernate should increment the version number or update the last modification timestamp.</p>
</div>
<div id="update-versioned-example" class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">update</span> <span class="n">versioned</span> <span class="n">Book</span> <span class="k">set</span> <span class="n">title</span> <span class="o">=</span> <span class="p">:</span><span class="n">newTitle</span> <span class="k">where</span> <span class="n">ssn</span> <span class="o">=</span> <span class="p">:</span><span class="n">ssn</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>An <code>update</code> statement may not directly <code>join</code> other entities, but it may:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>have an <a href="#implicit-join">implicit join</a>, or</p>
</li>
<li>
<p>have subqueries in its <code>set</code> clause, or in its <code>where</code> clause, and the subqueries may contain joins.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="delete">1.5.2. Delete statements</h4>
<div class="paragraph">
<p>The BNF for a <code>delete</code> statement is even simpler:</p>
</div>
<div id="delete-bnf-example" class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="antlrv4">deleteStatement
    : "DELETE" "FROM"? targetEntity whereClause?</code></pre>
</div>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">delete</span> <span class="n">Author</span> <span class="n">author</span> <span class="k">where</span> <span class="k">is</span> <span class="n">empty</span> <span class="n">author</span><span class="p">.</span><span class="n">books</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As in SQL, the presence or absence of the <code>from</code> keyword has absolutely no effect on the semantics of the <code>delete</code> statement.</p>
</div>
<div class="paragraph">
<p>Just like update statements, delete statements are polymorphic, and affect mapped subclasses of the given entity class.
Therefore, a single HQL <code>delete</code> statement might result in multiple SQL delete statements executed against the database.</p>
</div>
<div class="paragraph">
<p>A <code>delete</code> statement is executed by calling <code>Query.executeUpdate()</code>.</p>
</div>
<div class="paragraph">
<p>The integer value returned by <code>executeUpdate()</code> indicates the number of entity instances affected by the operation.</p>
</div>
<div class="paragraph">
<p>A <code>delete</code> statement may not directly <code>join</code> other entities, but it may:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>have an <a href="#implicit-join">implicit join</a>, or</p>
</li>
<li>
<p>have subqueries in its <code>where</code> clause, and the subqueries may contain joins.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="insert">1.5.3. Insert statements</h4>
<div class="paragraph">
<p>There are two kinds of <code>insert</code> statement:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>insert &#8230;&#8203; values</code>, where the attribute values to insert are given directly as tuples, and</p>
</li>
<li>
<p><code>insert &#8230;&#8203; select</code>, where the inserted attribute values are sourced from a subquery.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The first form inserts a single row in the database, or multiple rows if you provide multiple tuples in the <code>values</code> clause.
The second form may insert many new rows, or none at all.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The first sort of <code>insert</code> statement is not as useful.
It&#8217;s usually better to just use <code>persist()</code>.</p>
</div>
<div class="paragraph">
<p>But you might consider using it to set up test data.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p><code>insert</code> statements are not part of JPQL.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The BNF for an <code>insert</code> statement is:</p>
</div>
<div id="insert-bnf-example" class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="antlrv4">insertStatement
    : "INSERT" "INTO"? targetEntity targetFields
      (queryExpression | valuesList)
      conflictClause?

targetEntity
	: entityName variable?

targetFields
	: "(" simplePath ("," simplePath)* ")"

valuesList
	: "VALUES" values ("," values)*

values
	: "(" expression ("," expression)* ")"</code></pre>
</div>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div id="insert-example" class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">insert</span> <span class="n">Person</span> <span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
    <span class="k">values</span> <span class="p">(</span><span class="mi">100</span><span class="n">L</span><span class="p">,</span> <span class="s1">'Jane Doe'</span><span class="p">),</span> <span class="p">(</span><span class="mi">200</span><span class="n">L</span><span class="p">,</span> <span class="s1">'John Roe'</span><span class="p">)</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">insert</span> <span class="k">into</span> <span class="n">Author</span> <span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bio</span><span class="p">)</span>
    <span class="k">select</span> <span class="n">id</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">name</span> <span class="o">||</span> <span class="s1">' is a newcomer for '</span> <span class="o">||</span> <span class="n">str</span><span class="p">(</span><span class="k">year</span><span class="p">(</span><span class="k">local</span> <span class="nb">date</span><span class="p">))</span>
    <span class="k">from</span> <span class="n">Person</span>
    <span class="k">where</span> <span class="n">id</span> <span class="o">=</span> <span class="p">:</span><span class="n">pid</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As in SQL, the presence or absence of the <code>into</code> keyword has no effect on the semantics of the <code>insert</code> statement.</p>
</div>
<div class="paragraph">
<p>From these examples we might notice that <code>insert</code> statements are in one respect a bit different to <code>update</code> and <code>delete</code> statements.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>An <code>insert</code> statement is inherently <em>not</em> polymorphic!
Its list of target fields is of fixed length, whereas each subclass of an entity class might declare additional fields.
If the entity is involved in a mapped inheritance hierarchy, only attributes declared directly by the named entity and its superclasses may occur in the list of target fields.
Attributes declared by subclasses may not occur.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <code>queryExpression</code> in an <code>insert &#8230;&#8203; select</code> statement may be any valid <code>select</code> query, with the caveat that the types of the values in the <code>select</code> list must match the types of the target fields.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This is checked during query compilation rather than allowing the type check to delegate to the database.
This may cause problems when two Java types map to the same database type.
For example, an attribute of type <code>LocalDateTime</code> and an attribute or type <code>Timestamp</code> both map to the SQL type <code>timestamp</code>, but are not considered assignable by the query compiler.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>There are two ways to assign a value to the <code>@Id</code> attribute:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>explicitly specify the id attribute in the list of target fields, and its value in the values assigned to the target fields, or</p>
</li>
<li>
<p>omit it, in which case a generated value is used.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Of course, the second option is only available for entities with database-level id generation (sequences or identity/autoincrement columns).
It&#8217;s not available for entities whose id generator is implemented in Java, nor for entities whose id is assigned by the application.</p>
</div>
<div class="paragraph">
<p>The same two options are available for a <code>@Version</code> attribute.
When no version is explicitly specified, the version for a new entity instance is used.</p>
</div>
<div class="paragraph">
<p>The <code>on conflict</code> clause lets us specify what action should be taken when the database already contains the record we&#8217;re attempting to insert.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="antlrv4">conflictClause
	: ON CONFLICT conflictTarget? "DO" conflictAction

conflictTarget
	: ON CONSTRAINT identifier
	| "(" simplePath ("," simplePath)* ")"

conflictAction
	: "NOTHING"
	| "UPDATE" setClause whereClause?</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that the <code>on constraint</code> variant accepting the name of a unique constraint only works on certain databases, or when just a single row is being inserted.</p>
</div>
<div id="onconflict-example" class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">insert</span> <span class="n">Person</span> <span class="p">(</span><span class="n">ssn</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">phone</span><span class="p">)</span>
    <span class="k">values</span> <span class="p">(</span><span class="s1">'116-76-1234'</span><span class="p">,</span> <span class="s1">'Jane Doe'</span><span class="p">,</span> <span class="s1">'404 888 4319'</span><span class="p">)</span>
    <span class="k">on</span> <span class="n">conflict</span> <span class="p">(</span><span class="n">ssn</span><span class="p">)</span> <span class="n">do</span> <span class="k">update</span>
        <span class="k">set</span> <span class="n">phone</span> <span class="o">=</span> <span class="n">excluded</span><span class="p">.</span><span class="n">phone</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Like <code>update</code> and <code>delete</code> statements, an <code>insert</code> statement must be executed by calling <code>Query.executeUpdate()</code>.</p>
</div>
<div class="paragraph">
<p>Now it&#8217;s time to look at something <em>much</em> more complicated.</p>
</div>
</div>
<div class="sect3">
<h4 id="select">1.5.4. Select statements</h4>
<div class="paragraph">
<p>Select statements retrieve and analyse data.
This is what we&#8217;re really here for.</p>
</div>
<div class="paragraph">
<p>The full BNF for a <code>select</code> query is quite complicated, but there&#8217;s no need to understand it now.
We&#8217;re displaying it here for future reference.</p>
</div>
<div id="select-bnf-example" class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="antlrv4">selectStatement
	: queryExpression

queryExpression
	: withClause? orderedQuery (setOperator orderedQuery)*

orderedQuery
	: (query | "(" queryExpression ")") queryOrder?

query
	: selectClause fromClause? whereClause? (groupByClause havingClause?)?
	| fromClause whereClause? (groupByClause havingClause?)? selectClause?
	| whereClause

queryOrder
	: orderByClause limitClause? offsetClause? fetchClause?

fromClause
	: "FROM" entityWithJoins ("," entityWithJoins)*

entityWithJoins
	: fromRoot (join | crossJoin | jpaCollectionJoin)*

fromRoot
	: entityName variable?
	| "LATERAL"? "(" subquery ")" variable?

join
	: joinType "JOIN" "FETCH"? joinTarget joinRestriction?

joinTarget
	: path variable?
	| "LATERAL"? "(" subquery ")" variable?

withClause
	: "WITH" cte ("," cte)*
	;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Most of the complexity here arises from the interplay of set operators (<code>union</code>, <code>intersect</code>, and <code>except</code>) with sorting.</p>
</div>
<div class="paragraph">
<p>We&#8217;ll describe the various clauses of a query later, in <a href="#root-entities-and-joins">Root entities and joins</a> and in <a href="#selection-projection-aggregation">Selection, projection, and aggregation</a>, but for now, to summarize, a query might have these bits:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 22%;">
<col style="width: 22%;">
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Clause</th>
<th class="tableblock halign-left valign-top">Jargon</th>
<th class="tableblock halign-left valign-top">Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>with</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Common table expressions</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Declares <a href="#with-cte">named subqueries</a> to be used in the following query</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>from</code> and <code>join</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Roots and joins</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#from-clause">Specifies</a> the entities involved in the query, and how they&#8217;re <a href="#join">related</a> to each other</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>where</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Selection/restriction</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies a <a href="#where-clause">restriction</a> on the data returned by the query</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>group by</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Aggregation/grouping</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Controls <a href="#group-by">aggregation</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>having</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Selection/restriction</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies a <a href="#having">restriction</a> to apply <em>after</em> aggregation</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>select</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Projection</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies a <a href="#select-clause">projection</a> (the things to return from the query)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>union</code>, <code>intersect</code>, <code>except</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set algebra</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">These are <a href="#set-operators">set operators</a> applied to the results of multiple subqueries</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>order by</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Ordering</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies how the results should be <a href="#order-by">sorted</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>limit</code>, <code>offset</code>, <code>fetch</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Limits</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Allows for <a href="#limit-offset">limiting or paginating</a> the results</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Every one of these clauses is optional!</p>
</div>
<div class="paragraph">
<p>For example, the simplest query in HQL has no <code>select</code> clause at all:</p>
</div>
<div id="select-simplest-example" class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">from</span> <span class="n">Book</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>But we don&#8217;t necessarily <em>recommend</em> leaving off the <code>select</code> list.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>HQL doesn&#8217;t require a <code>select</code> clause, but JPQL <em>does</em>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Naturally, the previous query may be written with a <code>select</code> clause:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">select</span> <span class="n">book</span> <span class="k">from</span> <span class="n">Book</span> <span class="n">book</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>But when there&#8217;s no explicit <code>select</code> clause, the select list is implied by the result type of the query:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="c1">// result type Book, only the Book selected</span>
<span class="nc">List</span><span class="o">&lt;</span><span class="nc">Book</span><span class="o">&gt;</span> <span class="n">books</span> <span class="o">=</span>
        <span class="n">session</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="s">"from Book join authors"</span><span class="o">,</span> <span class="nc">Book</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
            <span class="o">.</span><span class="na">getResultList</span><span class="o">();</span>
<span class="k">for</span> <span class="o">(</span><span class="nc">Book</span> <span class="nl">book:</span> <span class="n">books</span><span class="o">)</span> <span class="o">{</span>
    <span class="o">...</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="c1">// result type Object[], both Book and Author selected</span>
<span class="nc">List</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">[]&gt;</span> <span class="n">booksWithAuthors</span> <span class="o">=</span>
       <span class="n">session</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="s">"from Book join authors"</span><span class="o">,</span> <span class="nc">Book</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="nc">Object</span><span class="o">[].</span><span class="na">class</span><span class="o">)</span>
            <span class="o">.</span><span class="na">getResultList</span><span class="o">();</span>
<span class="k">for</span> <span class="o">(</span><span class="kt">var</span> <span class="nl">bookWithAuthor:</span> <span class="n">booksWithAuthors</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Book</span> <span class="n">book</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Book</span><span class="o">)</span> <span class="n">bookWithAuthor</span><span class="o">[</span><span class="mi">0</span><span class="o">];</span>
    <span class="nc">Author</span> <span class="n">author</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Author</span><span class="o">)</span> <span class="n">bookWithAuthor</span><span class="o">[</span><span class="mi">1</span><span class="o">];</span>
    <span class="o">...</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>For complicated queries, it&#8217;s probably best to explicitly specify a <code>select</code> list.</p>
</div>
<div class="paragraph">
<p>An alternative "simplest" query has <em>only</em> a <code>select</code> list:</p>
</div>
<div id="select-simplest-example-alt" class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">select</span> <span class="k">local</span> <span class="k">datetime</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This results in a SQL <code>from dual</code> query (or equivalent).</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Looking carefully at the BNF given above, you might notice that the <code>select</code> list may occur either at the beginning of a query, or near the end, right before <code>order by</code>.</p>
</div>
<div class="paragraph">
<p>Of course, standard SQL, and JPQL, require that the <code>select</code> list comes at the beginning.
But it&#8217;s more natural to put it last:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">from</span> <span class="n">Book</span> <span class="n">book</span> <span class="k">select</span> <span class="n">book</span><span class="p">.</span><span class="n">title</span><span class="p">,</span> <span class="n">book</span><span class="p">.</span><span class="n">isbn</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This form of the query is more readable, because the alias is declared <em>before</em> it&#8217;s used, just as God and nature intended.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Naturally, queries are always polymorphic.
Indeed, a fairly innocent-looking HQL query can easily translate to a SQL statement with many joins and unions.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>We need to be a <em>bit</em> careful about that, but actually it&#8217;s usually a good thing.
HQL makes it very easy to fetch all the data we need in a single trip to the database, and that&#8217;s absolutely key to achieving high performance in data access code.
Typically, it&#8217;s much worse to fetch exactly the data we need, but in many round trips to the database server, than it is to fetch just a bit more data than what we&#8217;re going to need, all a single SQL query.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>When there&#8217;s no explicit <code>select</code> clause, a further abbreviation is sometimes possible.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>When the result type of a <code>select</code> query is an entity type, and we specify the type explicitly by passing the entity class to <code>createQuery()</code> or <code>createSelectionQuery()</code>, we&#8217;re sometimes allowed to omit the <code>from</code> clause, for example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="c1">// explicit result type Book, so 'from Book' is inferred</span>
<span class="nc">List</span><span class="o">&lt;</span><span class="nc">Book</span><span class="o">&gt;</span> <span class="n">books</span> <span class="o">=</span>
        <span class="n">session</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="s">"where title like :title"</span><span class="o">,</span> <span class="nc">Book</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
            <span class="o">.</span><span class="na">setParameter</span><span class="o">(</span><span class="s">"title"</span><span class="o">,</span> <span class="n">title</span><span class="o">)</span>
            <span class="o">.</span><span class="na">getResultList</span><span class="o">();</span></code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="returning-to-java">1.6. Representing result sets in Java</h3>
<div class="paragraph">
<p>One of the most uncomfortable aspects of working with data in Java is that there&#8217;s no good way to represent a table.
Languages designed for working with dataâ€”R is an excellent exampleâ€”always feature some sort of built-in table or "data frame" type.
Of course, Java&#8217;s type system gets in the way here.
This problem is much easier to solve in a dynamically-typed language.
The fundamental problem for Java is that it doesn&#8217;t have tuple types.</p>
</div>
<div class="paragraph">
<p>Queries in Hibernate return tables.
Sure, often a column holds whole entity objects, but we&#8217;re not restricted to returning a single entity, and we often write queries that return multiple entities in each result, or which return things which aren&#8217;t entities.</p>
</div>
<div class="paragraph">
<p>So we&#8217;re faced with the problem if representing such result sets, and, we&#8217;re sad to say, there&#8217;s no fully general and completely satisfying solution.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s begin with the easy case.</p>
</div>
<div class="sect3">
<h4 id="query-result-types-single">1.6.1. Queries with a single projected item</h4>
<div class="paragraph">
<p>If there&#8217;s just one projected item in the <code>select</code> list, then, no sweat, that&#8217;s the type of each query result.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">results</span> <span class="o">=</span>
        <span class="n">entityManager</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="s">"select title from Book"</span><span class="o">,</span> <span class="nc">String</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
            <span class="o">.</span><span class="na">getResultList</span><span class="o">();</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>There&#8217;s really no need to fuss about with trying to represent a "tuple of length 1".
We&#8217;re not even sure what to call those.</p>
</div>
<div class="paragraph">
<p>Problems arise as soon as we have multiple items in the <code>select</code> list of a query.</p>
</div>
</div>
<div class="sect3">
<h4 id="query-result-types-multiple">1.6.2. Queries with multiple projected items</h4>
<div class="paragraph">
<p>When there are multiple expressions in the select list then, by default, and in compliance with JPA, each query result is packaged as an array of type <code>Object[]</code>.</p>
</div>
<div id="select-clause-projection-example" class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nc">List</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">[]&gt;</span> <span class="n">results</span> <span class="o">=</span>
        <span class="n">entityManager</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="s">"select title, left(book.text, 200) from Book"</span><span class="o">,</span>
                                  <span class="nc">Object</span><span class="o">[].</span><span class="na">class</span><span class="o">)</span>
            <span class="o">.</span><span class="na">getResultList</span><span class="o">();</span>
<span class="k">for</span> <span class="o">(</span><span class="kt">var</span> <span class="n">result</span> <span class="o">:</span> <span class="n">results</span><span class="o">)</span> <span class="o">{</span>
	<span class="nc">String</span> <span class="n">title</span> <span class="o">=</span> <span class="o">(</span><span class="nc">String</span><span class="o">)</span> <span class="n">result</span><span class="o">[</span><span class="mi">0</span><span class="o">];</span>
	<span class="nc">String</span> <span class="n">preamble</span> <span class="o">=</span> <span class="o">(</span><span class="nc">String</span><span class="o">)</span> <span class="n">result</span><span class="o">[</span><span class="mi">1</span><span class="o">];</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This is bearable, but let&#8217;s explore some other options.</p>
</div>
<div class="paragraph">
<p>JPA lets us specify that we want each query result packaged as an instance of <code>jakarta.persistence.Tuple</code>.
All we have to do is pass the class <code>Tuple</code> to <code>createQuery()</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nc">List</span><span class="o">&lt;</span><span class="nc">Tuple</span><span class="o">&gt;</span> <span class="n">tuples</span> <span class="o">=</span>
        <span class="n">entityManager</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="s">"select title as title, left(book.text, 200) as preamble from Book"</span><span class="o">,</span>
                                  <span class="nc">Tuple</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
            <span class="o">.</span><span class="na">getResultList</span><span class="o">();</span>
<span class="k">for</span> <span class="o">(</span><span class="nc">Tuple</span> <span class="n">tuple</span> <span class="o">:</span> <span class="n">tuples</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">String</span> <span class="n">title</span> <span class="o">=</span> <span class="n">tuple</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"title"</span><span class="o">,</span> <span class="nc">String</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="nc">String</span> <span class="n">preamble</span> <span class="o">=</span> <span class="n">tuple</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"preamble"</span><span class="o">,</span> <span class="nc">String</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The names of the <code>Tuple</code> elements are determined by the aliases given to the projected items in the select list.
If no aliases are specified, the elements may be accessed by their position in the list, where the first item is assigned the position zero.</p>
</div>
<div class="paragraph">
<p>As an extension to JPA, and in a similar vein, Hibernate lets us pass <code>Map</code> or <code>List</code>, and have each result packaged as a map or list:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kt">var</span> <span class="n">results</span> <span class="o">=</span>
        <span class="n">entityManager</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="s">"select title as title, left(book.text, 200) as preamble from Book"</span><span class="o">,</span>
                                  <span class="nc">Map</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
            <span class="o">.</span><span class="na">getResultList</span><span class="o">();</span>
<span class="k">for</span> <span class="o">(</span><span class="kt">var</span> <span class="n">map</span> <span class="o">:</span> <span class="n">results</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">String</span> <span class="n">title</span> <span class="o">=</span> <span class="o">(</span><span class="nc">String</span><span class="o">)</span> <span class="n">map</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"title"</span><span class="o">);</span>
    <span class="nc">String</span> <span class="n">preamble</span> <span class="o">=</span> <span class="o">(</span><span class="nc">String</span><span class="o">)</span> <span class="n">map</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"preamble"</span><span class="o">);</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kt">var</span> <span class="n">results</span> <span class="o">=</span>
        <span class="n">entityManager</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="s">"select title, left(book.text, 200) from Book"</span><span class="o">,</span>
                                  <span class="nc">List</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
            <span class="o">.</span><span class="na">getResultList</span><span class="o">();</span>
<span class="k">for</span> <span class="o">(</span><span class="kt">var</span> <span class="n">list</span> <span class="o">:</span> <span class="n">results</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">String</span> <span class="n">title</span> <span class="o">=</span> <span class="o">(</span><span class="nc">String</span><span class="o">)</span> <span class="n">list</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
    <span class="nc">String</span> <span class="n">preamble</span> <span class="o">=</span> <span class="o">(</span><span class="nc">String</span><span class="o">)</span> <span class="n">list</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Unfortunately, not one of the types <code>Object[]</code>, <code>List</code>, <code>Map</code>, nor <code>Tuple</code> lets us access an individual item in a result tuple without a type cast.
Sure <code>Tuple</code> does the type cast for us when we pass a class object to <code>get()</code>, but it&#8217;s logically identical.
Fortunately there&#8217;s one more option, as we&#8217;re about to see.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Actually, <code>Tuple</code> really exists to service the criteria query API, and in that context it <em>does</em> enable truly typesafe access to query results.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Hibernate 6 lets us pass an arbitrary class type with an appropriate constructor to <code>createQuery()</code> and will use it to package the query results.
This works extremely nicely with <code>record</code> types.</p>
</div>
<div id="select-clause-implicit-instantiation-example" class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="n">record</span> <span class="nf">BookSummary</span><span class="o">(</span><span class="nc">String</span> <span class="n">title</span><span class="o">,</span> <span class="nc">String</span> <span class="n">summary</span><span class="o">)</span> <span class="o">{}</span>

<span class="nc">List</span><span class="o">&lt;</span><span class="nc">BookSummary</span><span class="o">&gt;</span> <span class="n">results</span> <span class="o">=</span>
        <span class="n">entityManager</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="s">"select title, left(book.text, 200) from Book"</span><span class="o">,</span>
                                  <span class="nc">BookSummary</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
            <span class="o">.</span><span class="na">getResultList</span><span class="o">();</span>
<span class="k">for</span> <span class="o">(</span><span class="kt">var</span> <span class="n">result</span> <span class="o">:</span> <span class="n">results</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">String</span> <span class="n">title</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="na">title</span><span class="o">();</span>
    <span class="nc">String</span> <span class="n">preamble</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="na">summary</span><span class="o">();</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>It&#8217;s important that the constructor of <code>BookSummary</code> has parameters which exactly match the items in the <code>select</code> list.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This class does not need to be mapped or annotated in any way.</p>
</div>
<div class="paragraph">
<p>Even if the class <em>is</em> an entity class, the resulting instances are <em>not</em> managed entities and are <em>not</em> associated with the session.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We must caution that this still isn&#8217;t typesafe.
In fact, we&#8217;ve just pushed the typecasts down into the call to <code>createQuery()</code>.
But at least we don&#8217;t have to write them explicitly.</p>
</div>
</div>
<div class="sect3">
<h4 id="select-new">1.6.3. Instantiation</h4>
<div class="paragraph">
<p>In JPQL, and in older versions of Hibernate, this functionality required more ceremony.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col>
<col>
<col style="width: 15%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Result type</th>
<th class="tableblock halign-left valign-top">Legacy syntax</th>
<th class="tableblock halign-left valign-top">Streamlined syntax</th>
<th class="tableblock halign-center valign-top">JPA standard</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Map</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>select new map(x, y)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>select x, y</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">âœ–/âœ–</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>List</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>select new list(x, y)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>select x, y</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">âœ–/âœ–</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Arbitrary class <code>Record</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>select new Record(x, y)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>select x, y</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">âœ”/âœ–</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>For example, the JPA-standard <code>select new</code> construct packages the query results into a user-written Java class instead of an array.</p>
</div>
<div id="select-clause-dynamic-instantiation-example" class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="n">record</span> <span class="nf">BookSummary</span><span class="o">(</span><span class="nc">String</span> <span class="n">title</span><span class="o">,</span> <span class="nc">String</span> <span class="n">summary</span><span class="o">)</span> <span class="o">{}</span>

<span class="nc">List</span><span class="o">&lt;</span><span class="nc">BookSummary</span><span class="o">&gt;</span> <span class="n">results</span> <span class="o">=</span>
        <span class="n">entityManager</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="s">"select new BookSummary(title, left(book.text, 200)) from Book"</span><span class="o">,</span>
                                  <span class="nc">BookSummary</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
            <span class="o">.</span><span class="na">getResultList</span><span class="o">();</span>
<span class="k">for</span> <span class="o">(</span><span class="kt">var</span> <span class="n">result</span> <span class="o">:</span> <span class="n">results</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">String</span> <span class="n">title</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="na">title</span><span class="o">();</span>
    <span class="nc">String</span> <span class="n">preamble</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="na">summary</span><span class="o">();</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Simplifying slightly, the BNF for a projected item is:</p>
</div>
<div id="select-item-bnf" class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="antlrv4">selection
    : (expression | instantiation) alias?

instantiation
    : "NEW" instantiationTarget "(" selection ("," selection)* ")"

alias
    : "AS"? identifier</code></pre>
</div>
</div>
<div class="paragraph">
<p>Where the list of <code>selection</code>s in an <code>instantiation</code> is essentially a nested projection list.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="expressions">2. Expressions</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We now switch gears, and begin describing the language from the bottom up.
The very bottom of a programming language is its syntax for literal values.</p>
</div>
<div class="sect2">
<h3 id="literals">2.1. Literals</h3>
<div class="paragraph">
<p>The most important literal value in this language is <code>null</code>. It&#8217;s assignable to any other type.</p>
</div>
<div class="sect3">
<h4 id="boolean-literals">2.1.1. Boolean literals</h4>
<div class="paragraph">
<p>The boolean literal values are the (case-insensitive) keywords <code>true</code> and <code>false</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="string-literals">2.1.2. String literals</h4>
<div class="paragraph">
<p>String literals are enclosed in single quotes.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">select</span> <span class="s1">'hello world'</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To escape a single quote within a string literal, use a doubled single quote: <code>''</code>.</p>
</div>
<div id="string-literals-example" class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">from</span> <span class="n">Book</span> <span class="k">where</span> <span class="n">title</span> <span class="k">like</span> <span class="s1">'Ender</span><span class="se">''</span><span class="s1">s'</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Alternatively, Java-style double-quoted strings are also allowed, with the usual Java character escape syntax.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">select</span> <span class="s2">"hello</span><span class="se">\t</span><span class="s2">world"</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This option is not much used.</p>
</div>
</div>
<div class="sect3">
<h4 id="numeric-literals">2.1.3. Numeric literals</h4>
<div class="paragraph">
<p>Numeric literals come in several different forms:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Kind</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Example</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Integer literals</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Long</code>, <code>Integer</code>, <code>BigInteger</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>1</code>, <code>3_000_000L</code>, <code>2BI</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Decimal literals</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Double</code>, <code>Float</code>, <code>BigDecimal</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>1.0</code>, <code>123.456F</code>, <code>3.14159265BD</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Hexadecimal literals</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Long</code>, <code>Integer</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0X1A2B</code>, <code>0x1a2b</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Scientific notation</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Double</code>, <code>Float</code>, <code>BigDecimal</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>1e-6</code>, <code>6.674E-11F</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>For example:</p>
</div>
<div id="numeric-literals-example" class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">from</span> <span class="n">Book</span> <span class="k">where</span> <span class="n">price</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">.</span><span class="mi">0</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">select</span> <span class="n">author</span><span class="p">,</span> <span class="k">count</span><span class="p">(</span><span class="n">book</span><span class="p">)</span>
<span class="k">from</span> <span class="n">Author</span> <span class="k">as</span> <span class="n">author</span>
    <span class="k">join</span> <span class="n">author</span><span class="p">.</span><span class="n">books</span> <span class="k">as</span> <span class="n">book</span>
<span class="k">group</span> <span class="k">by</span> <span class="n">author</span>
<span class="k">having</span> <span class="k">count</span><span class="p">(</span><span class="n">book</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The type of a numeric literal may be specified using a Java-style postfix:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Postfix</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Java type</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>L</code> or <code>l</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">long integer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>long</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>D</code> or <code>d</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">double precision</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>double</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>F</code> or <code>f</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">single precision</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>float</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>BI</code> or <code>bi</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">large integer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>BigInteger</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>BD</code> or <code>bd</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">exact decimal</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>BigDecimal</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>It&#8217;s not usually necessary to specify the precision explicitly.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>In a literal with an exponent, the <code>E</code> is case-insensitive.
Similarly, the Java-style postfix is case-insensitive.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="datetime-literals">2.1.4. Date and time literals</h4>
<div class="paragraph">
<p>According to the JPQL specification, date and time literals may be specified using the JDBC escape syntax.
Since this syntax is rather unpleasant to look at, HQL provides not one, but two alternatives.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Date/time type</th>
<th class="tableblock halign-left valign-top">Recommended Java type</th>
<th class="tableblock halign-left valign-top">JDBC escape syntax ðŸ’€</th>
<th class="tableblock halign-left valign-top">Braced literal syntax</th>
<th class="tableblock halign-left valign-top">Explicitly typed literal syntax</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Date</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>LocalDate</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{d 'yyyy-mm-dd'}</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{yyyy-mm-dd}</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>date yyyy-mm-dd</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Time</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>LocalTime</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{t 'hh:mm'}</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{hh:mm}</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>time hh:mm</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Time with seconds</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>LocalTime</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{t 'hh:mm:ss'}</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{hh:mm:ss}</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>time hh:mm:ss</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Datetime</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>LocalDateTime</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{ts 'yyyy-mm-ddThh:mm:ss'}</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{yyyy-mm-dd hh:mm:ss}</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>datetime yyyy-mm-dd hh:mm:ss</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Datetime with milliseconds</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>LocalDateTime</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{ts 'yyyy-mm-ddThh:mm:ss.millis'}</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{yyyy-mm-dd hh:mm:ss.millis}</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>datetime yyyy-mm-dd hh:mm:ss.millis</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Datetime with an offset</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>OffsetDateTime</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{ts 'yyyy-mm-ddThh:mm:ss+hh:mm'}</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{yyyy-mm-dd hh:mm:ss +hh:mm}</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>datetime yyyy-mm-dd hh:mm:ss +hh:mm</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Datetime with a time zone</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>OffsetDateTime</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{ts 'yyyy-mm-ddThh:mm:ss GMT'}</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{yyyy-mm-dd hh:mm:ss GMT}</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>datetime yyyy-mm-dd hh:mm:ss GMT</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Literals referring to the current date and time are also provided.
Again there is some flexibility.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Date/time type</th>
<th class="tableblock halign-left valign-top">Java type</th>
<th class="tableblock halign-left valign-top">Underscored syntax</th>
<th class="tableblock halign-left valign-top">Spaced syntax</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Date</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.time.LocalDate</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>local_date</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>local date</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Time</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.time.LocalTime</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>local_time</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>local time</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Datetime</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.time.LocalDateTime</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>local_datetime</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>local datetime</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Offset datetime</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.time.OffsetDateTime</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>offset_datetime</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>offset datetime</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Instant</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.time.Instant</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>instant</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>instant</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Date</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.sql.Date</code> ðŸ’€</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>current_date</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>current date</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Time</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.sql.Time</code> ðŸ’€</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>current_time</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>current time</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Datetime</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.sql.Timestamp</code> ðŸ’€</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>current_timestamp</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>current timestamp</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Of these, only <code>local date</code>, <code>local time</code>, <code>local datetime</code>, <code>current_date</code>, <code>current_time</code>, and <code>current_timestamp</code> are defined by the JPQL specification.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The use of date and time types from the <code>java.sql</code> package is strongly discouraged!
Always use <code>java.time</code> types in new code.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="duration-literals">2.1.5. Duration literals</h4>
<div class="paragraph">
<p>There are two sorts of duration in HQL:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>year-day durations</em>, that is, the length of an interval between two dates, and</p>
</li>
<li>
<p><em>week-nanosecond durations</em>, that is, the length of an interval between two datetimes.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For conceptual reasons, the two kinds of duration cannot be cleanly composed.</p>
</div>
<div class="paragraph">
<p>Literal duration expressions are of form <code>n unit</code>, for example <code>1 day</code> or <code>10 year</code> or <code>100 nanosecond</code>.</p>
</div>
<div class="paragraph">
<p>The unit may be: <code>day</code>, <code>month</code>, <code>quarter</code>, <code>year</code>, <code>second</code>, <code>minute</code>, <code>hour</code>, or <code>nanosecond</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>A HQL duration is considered to map to a Java <code>java.time.Duration</code>, but semantically they&#8217;re perhaps more similar to an ANSI SQL <code>INTERVAL</code> type.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="binary-literals">2.1.6. Binary string literals</h4>
<div class="paragraph">
<p>HQL also provides a choice of formats for binary strings:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the braced syntax <code>{0xDE, 0xAD, 0xBE, 0xEF}</code>, a list of Java-style hexadecimal byte literals, or</p>
</li>
<li>
<p>the quoted syntax <code>X&#8217;DEADBEEF'</code> or <code>x&#8217;deadbeef'</code>, similar to SQL.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="enum-literals">2.1.7. Enum literals</h4>
<div class="paragraph">
<p>Literal values of a Java enumerated type may be written without needing to specify the enum class name:</p>
</div>
<div id="enum-example" class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">from</span> <span class="n">Book</span> <span class="k">where</span> <span class="n">status</span> <span class="o">&lt;&gt;</span> <span class="n">OUT_OF_PRINT</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">from</span> <span class="n">Book</span> <span class="k">where</span> <span class="n">type</span> <span class="k">in</span> <span class="p">(</span><span class="n">BOOK</span><span class="p">,</span> <span class="n">MAGAZINE</span><span class="p">)</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">update</span> <span class="n">Book</span> <span class="k">set</span> <span class="n">status</span> <span class="o">=</span> <span class="n">OUT_OF_PRINT</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In the examples above, the enum class is inferred from the type of the expression on the left of the comparison, assignment operator, or
<code>in</code> predicate.</p>
</div>
<div id="enum-case-example" class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">from</span> <span class="n">Book</span>
<span class="k">order</span> <span class="k">by</span>
    <span class="k">case</span> <span class="n">type</span>
    <span class="k">when</span> <span class="n">BOOK</span> <span class="k">then</span> <span class="mi">1</span>
    <span class="k">when</span> <span class="n">MAGAZINE</span> <span class="k">then</span> <span class="mi">2</span>
    <span class="k">when</span> <span class="n">JOURNAL</span> <span class="k">then</span> <span class="mi">3</span>
    <span class="k">else</span> <span class="mi">4</span>
    <span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In this example the enum class is inferred from the type of the <code>case</code> expression.</p>
</div>
</div>
<div class="sect3">
<h4 id="java-constants">2.1.8. Java constants</h4>
<div class="paragraph">
<p>HQL allows any Java <code>static</code> constant to be used in HQL, but it must be referenced by its fully-qualified name:</p>
</div>
<div id="java-constant-example" class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">select</span> <span class="n">java</span><span class="p">.</span><span class="n">lang</span><span class="p">.</span><span class="n">Math</span><span class="p">.</span><span class="k">PI</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="entity-name-literals">2.1.9. Literal entity names</h4>
<div class="paragraph">
<p>Entity names may also occur as a literal value. They do not need to be qualified.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">from</span> <span class="n">Payment</span> <span class="k">as</span> <span class="n">payment</span>
<span class="k">where</span> <span class="n">type</span><span class="p">(</span><span class="n">payment</span><span class="p">)</span> <span class="o">=</span> <span class="n">CreditCardPayment</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>See <a href="#functions-typecasts">Types and typecasts</a>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="path-expressions">2.2. Identification variables and path expressions</h3>
<div class="paragraph">
<p>A path expression is either:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>a reference to an <a href="#identification-variables">identification variable</a>, or</p>
</li>
<li>
<p>a <em>compound path</em>, beginning with a reference to an identification variable, and followed by a period-separated list of references to entity attributes.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>As an extension to the JPA spec, HQL, just like SQL, allows a compound path expression where the identification variable at the beginning of the path is missing.
That is, instead of <code>var.foo.bar</code>, it&#8217;s legal to write just <code>foo.bar</code>.
But this is only allowed when the identification variable may be unambiguously inferred from the first element, <code>foo</code> of the compound path.
The query must have exactly one identification variable <code>var</code> for which the path <code>var.foo</code> refers to an entity attribute.
Note that we will continue to call these paths "compound", even if they only have one element.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This streamlines the query rather nicely when there&#8217;s just one root entity and no joins.
But when the query has multiple identification variables it makes the query much harder to understand.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If an element of a compound path refers to an association, the path expression produces an <a href="#implicit-join">implicit join</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">select</span> <span class="n">book</span><span class="p">.</span><span class="n">publisher</span><span class="p">.</span><span class="n">name</span> <span class="k">from</span> <span class="n">Book</span> <span class="n">book</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>An element of a compound path referring to a many-to-one or on-to-one association may have the <a href="#function-treat">treat</a> function applied to it.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">select</span> <span class="n">treat</span><span class="p">(</span><span class="k">order</span><span class="p">.</span><span class="n">payment</span> <span class="k">as</span> <span class="n">CreditCardPayment</span><span class="p">).</span><span class="n">creditCardNumber</span> <span class="k">from</span> <span class="k">Order</span> <span class="k">order</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If an element of a compound path refers to a collection or many-valued association, it must have one of <a href="#collection-functions">these special functions</a> applied to it.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">select</span> <span class="n">element</span><span class="p">(</span><span class="n">book</span><span class="p">.</span><span class="n">authors</span><span class="p">).</span><span class="n">name</span> <span class="k">from</span> <span class="n">Book</span> <span class="n">book</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>No other function may be applied to a non-terminal element of a path expression.</p>
</div>
<div class="paragraph">
<p>Alternatively, if the element of the compound path refers to a list or map, it may have the indexing operator applied to it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">select</span> <span class="n">book</span><span class="p">.</span><span class="n">editions</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nb">date</span> <span class="k">from</span> <span class="n">Book</span> <span class="n">book</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>No other operator may be applied to a non-terminal element of a path expression.</p>
</div>
</div>
<div class="sect2">
<h3 id="_operator_expressions">2.3. Operator expressions</h3>
<div class="paragraph">
<p>HQL has operators for working with strings, numeric values, and date/time types.</p>
</div>
<div class="paragraph">
<p>The operator precedence is given by this table, from highest to lowest precedence:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 40%;">
<col style="width: 20%;">
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Precedence class</th>
<th class="tableblock halign-center valign-top">Type</th>
<th class="tableblock halign-left valign-top">Operators</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Grouping and tuple instantiation</p></td>
<td class="tableblock halign-center valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>( &#8230;&#8203; )</code> and <code>(x, y, z)</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Case lists</p></td>
<td class="tableblock halign-center valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>case &#8230;&#8203; end</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Member reference</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">Binary infix</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>a.b</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Function application</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">Postfix</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>f(x,y)</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Indexing</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">Postfix</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>a[i]</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Unary numeric</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">Unary prefix</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>+</code>, <code>-</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Duration conversions</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">Unary postfix</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>by day</code> and friends</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Binary multiplicative</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">Binary infix</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>*</code>, <code>/</code>, <code>%</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Binary additive</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">Binary infix</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>+</code>, <code>-</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Concatenation</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">Binary infix</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>||</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nullness, emptiness, truth</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">Unary postfix</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>is null</code>, <code>is empty</code>, <code>is true</code>, <code>is false</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Containment</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">Binary infix</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>in</code>, <code>not in</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Between</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">Ternary infix</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>between</code>, <code>not between</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Pattern matching</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">Binary infix</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>like</code>, <code>ilike</code>, <code>not like</code>, <code>not ilike</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Comparison operators</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">Binary infix</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>=</code>, <code>&lt;&gt;</code>, <code>&lt;</code>, <code>&gt;</code>, <code>&lt;=</code>, <code>&gt;=</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nullsafe comparison</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">Binary infix</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>is distinct from</code>, <code>is not distinct from</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Existence</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">Unary prefix</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>exists</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Membership</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">Binary infix</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>member of</code>, <code>not member of</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Logical negation</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">Unary prefix</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>not</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Logical conjunction</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">Binary infix</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>and</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Logical disjunction</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">Binary infix</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>or</code></p></td>
</tr>
</tbody>
</table>
<div class="sect3">
<h4 id="concatenation">2.3.1. String concatenation</h4>
<div class="paragraph">
<p>HQL defines two ways to concatenate strings:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the SQL-style concatenation operator, <code>||</code>, and</p>
</li>
<li>
<p>the JPQL-standard <code>concat()</code> function.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>See <a href="#string-functions">below</a> for details of the <code>concat()</code> function.</p>
</div>
<div id="concatenation-example" class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">select</span> <span class="n">book</span><span class="p">.</span><span class="n">title</span> <span class="o">||</span> <span class="s1">' by '</span> <span class="o">||</span> <span class="n">listagg</span><span class="p">(</span><span class="n">author</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">' &amp; '</span><span class="p">)</span>
<span class="k">from</span> <span class="n">Book</span> <span class="k">as</span> <span class="n">book</span>
    <span class="k">join</span> <span class="n">book</span><span class="p">.</span><span class="n">authors</span> <span class="k">as</span> <span class="n">author</span>
<span class="k">group</span> <span class="k">by</span> <span class="n">book</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Many more operations on strings are defined below, in <a href="#exp-functions">Functions</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="numeric-arithmetic">2.3.2. Numeric arithmetic</h4>
<div class="paragraph">
<p>The basic SQL arithmetic operators, <code>+</code>,<code>-</code>,<code>*</code>, and <code>/</code> are joined by the remainder operator <code>%</code>.</p>
</div>
<div id="numeric-arithmetic-example" class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">select</span> <span class="p">(</span><span class="mi">1</span><span class="p">.</span><span class="mi">0</span> <span class="o">+</span> <span class="p">:</span><span class="n">taxRate</span><span class="p">)</span> <span class="o">*</span> <span class="k">sum</span><span class="p">(</span><span class="n">item</span><span class="p">.</span><span class="n">book</span><span class="p">.</span><span class="n">price</span> <span class="o">*</span> <span class="n">item</span><span class="p">.</span><span class="n">quantity</span><span class="p">)</span>
<span class="k">from</span> <span class="k">Order</span> <span class="k">as</span> <span class="n">ord</span>
    <span class="k">join</span> <span class="n">ord</span><span class="p">.</span><span class="k">items</span> <span class="k">as</span> <span class="n">item</span>
<span class="k">where</span> <span class="n">ord</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="p">:</span><span class="n">oid</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>When both operands of a binary numeric operator have the same type, the result type of the whole expression is the same as the operands.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>By default, the semantics of integer division depend on the database:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>On most databases, division of an integer by an integer evaluates to an integer, just like in Java.
Thus, <code>3/2</code> evaluates to <code>1</code>.</p>
</li>
<li>
<p>But on some databases, including Oracle, MySQL, and MariaDB, integer division may result in a non-integral value.
So <code>3/2</code> evaluates to <code>1.5</code> on these databases.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This default behavior may be changed using configuration property <code>hibernate.query.hql.portable_integer_division</code>.
Setting this property to <code>true</code> instructs Hibernate to produce SQL that emulates Java-style integer division (that is, <code>3/2 = 1</code>) on platforms where that is not the native semantics.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>When the operands are of different type, one of the operands is implicitly converted to <em>wider</em> type, with wideness given, in decreasing order, by the list below:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>Double</code> (widest)</p>
</li>
<li>
<p><code>Float</code></p>
</li>
<li>
<p><code>BigDecimal</code></p>
</li>
<li>
<p><code>BigInteger</code></p>
</li>
<li>
<p><code>Long</code></p>
</li>
<li>
<p><code>Integer</code></p>
</li>
<li>
<p><code>Short</code></p>
</li>
<li>
<p><code>Byte</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Many more numeric operations are defined below, in <a href="#exp-functions">Functions</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="Datetime-arithmetic">2.3.3. Datetime arithmetic</h4>
<div class="paragraph">
<p>Arithmetic involving dates, datetimes, and durations is quite subtle.
Among the issues to consider are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>There&#8217;s two kinds of duration: year-day, and week-nanosecond durations.
The first is a difference between dates; the second is a difference between datetimes.</p>
</li>
<li>
<p>We can subtract dates and datetimes, but we can&#8217;t add them.</p>
</li>
<li>
<p>A Java-style duration has much too much precision, and so in order to use it for anything useful, we must somehow truncate it to something coarser-grained.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Here we list the basic operations.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 10%;">
<col style="width: 38%;">
<col>
<col style="width: 18%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Operator</th>
<th class="tableblock halign-left valign-top">Expression type</th>
<th class="tableblock halign-left valign-top">Example</th>
<th class="tableblock halign-left valign-top">Resulting type</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>-</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Difference between two dates</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>your.birthday - local date</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">year-day duration</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>-</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Difference between two datetimes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>local datetime - record.lastUpdated</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">week-nanosecond duration</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>-</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Difference of a date and a year-day duration</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>local date - 1 day</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">date</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>-</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Difference of a datetime and a week-nanosecond duration</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>record.lastUpdated - 1 minute</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">datetime</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>-</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Difference between two durations</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>1 week - 1 day</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">duration</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>+</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sum of a date and a year-day duration</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>local date + 1 week</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">date</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>+</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sum of a datetime and a week-nanosecond duration</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>record.lastUpdated + 1 second</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">datetime</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>+</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sum of two durations</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>1 day + 4 hour</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">duration</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>*</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Product of an integer and a duration</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>billing.cycles * 30 day</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">duration</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>by unit</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Convert a duration to an integer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>(1 year) by day</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">integer</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The <code>by unit</code> operator converts a duration to an integer, for example: <code>(local date - your.birthday) by day</code> evaluates to the number of days you still have to wait.</p>
</div>
<div class="paragraph">
<p>The function <code>extract(unit from &#8230;&#8203;)</code> extracts a field from a date, time, or datetime type, for example, <code>extract(year from your.birthday)</code> produces the year in which you were born, and throws away important information about your birthday.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Please carefully note the difference between these two operations: <code>by</code> and <code>extract()</code> both evaluate to an integer, but they have very different uses.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Additional datetime operations, including the useful <code>format()</code> function, are defined below, in <a href="#exp-functions">Functions</a>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="case-expressions">2.4. Case expressions</h3>
<div class="paragraph">
<p>Just like in standard SQL, there are two forms of case expression:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the <em>simple</em> case expression, and</p>
</li>
<li>
<p>the so-called <em>searched</em> case expression.</p>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Case expressions are verbose.
It&#8217;s often simpler to use the <code>coalesce()</code>, <code>nullif()</code>, or <code>ifnull()</code> functions,
as described below in <a href="#functions-null">Functions for working with null values</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<h5 id="simple-case-expressions" class="discrete">Simple case expressions</h5>
<div class="paragraph">
<p>The syntax of the simple form is defined by:</p>
</div>
<div id="simple-case-expressions-bnf" class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="antlrv4">"CASE" expression ("WHEN" expression "THEN" expression)+ ("ELSE" expression)? "END"</code></pre>
</div>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div id="simple-case-expressions-example" class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">select</span>
    <span class="k">case</span> <span class="n">author</span><span class="p">.</span><span class="n">nomDePlume</span>
        <span class="k">when</span> <span class="s1">''</span> <span class="k">then</span> <span class="n">person</span><span class="p">.</span><span class="n">name</span>
        <span class="k">else</span> <span class="n">author</span><span class="p">.</span><span class="n">nomDePlume</span> <span class="k">end</span>
<span class="k">from</span> <span class="n">Author</span> <span class="k">as</span> <span class="n">author</span>
    <span class="k">join</span> <span class="n">author</span><span class="p">.</span><span class="n">person</span> <span class="k">as</span> <span class="n">person</span></code></pre>
</div>
</div>
<h5 id="searched-case-expressions" class="discrete">Searched case expressions</h5>
<div class="paragraph">
<p>The searched form has the following syntax:</p>
</div>
<div id="searched-case-expressions-bnf" class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="antlrv4">"CASE" ("WHEN" predicate "THEN" expression)+ ("ELSE" expression)? "END"</code></pre>
</div>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div id="searched-case-expressions-example" class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">select</span>
    <span class="k">case</span>
        <span class="k">when</span> <span class="n">author</span><span class="p">.</span><span class="n">nomDePlume</span> <span class="k">is</span> <span class="k">null</span> <span class="k">then</span> <span class="n">person</span><span class="p">.</span><span class="n">name</span>
        <span class="k">else</span> <span class="n">author</span><span class="p">.</span><span class="n">nomDePlume</span> <span class="k">end</span>
<span class="k">from</span> <span class="n">Author</span> <span class="k">as</span> <span class="n">author</span>
    <span class="k">join</span> <span class="n">author</span><span class="p">.</span><span class="n">person</span> <span class="k">as</span> <span class="n">person</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>A <code>case</code> expression may contain complex expression, including operator expressions.</p>
</div>
</div>
<div class="sect2">
<h3 id="tuple-instantiation">2.5. Tuples</h3>
<div class="paragraph">
<p>A <em>tuple instantiation</em> is an expression like <code>(1, 'hello')</code>, and may be used to "vectorize" comparison expressions.</p>
</div>
<div id="tuple-comparison" class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">from</span> <span class="n">Person</span> <span class="k">where</span> <span class="p">(</span><span class="n">firstName</span><span class="p">,</span> <span class="n">lastName</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="s1">'Ludwig'</span><span class="p">,</span> <span class="s1">'Boltzmann'</span><span class="p">)</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">from</span> <span class="n">Event</span> <span class="k">where</span> <span class="p">(</span><span class="k">year</span><span class="p">,</span> <span class="k">day</span><span class="p">)</span> <span class="o">&gt;</span> <span class="p">(</span><span class="k">year</span><span class="p">(</span><span class="k">local</span> <span class="nb">date</span><span class="p">),</span> <span class="k">day</span><span class="p">(</span><span class="k">local</span> <span class="nb">date</span><span class="p">))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This syntax may be used even when the underlying SQL dialect does <em>not</em> support so-called "row value" constructors.</p>
</div>
<div class="paragraph">
<p>A tuple value may be compared to an embedded field:</p>
</div>
<div id="tuple-embeddable" class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">from</span> <span class="n">Person</span>
<span class="k">where</span> <span class="n">address</span> <span class="o">=</span> <span class="p">(</span><span class="s1">'1600 Pennsylvania Avenue, NW'</span><span class="p">,</span> <span class="s1">'Washington'</span><span class="p">,</span> <span class="s1">'DC'</span><span class="p">,</span> <span class="mi">20500</span><span class="p">,</span> <span class="s1">'USA'</span><span class="p">)</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="exp-functions">2.6. Functions</h3>
<div class="paragraph">
<p>Both HQL and JPQL define some standard functions and make them portable between databases.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>A program that wishes to remain portable between Jakarta Persistence providers should in principle limit itself to the use of the functions which are blessed by the specification.
Unfortunately, there&#8217;s not so many of them.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In some cases, the syntax of these functions looks a bit funny at first, for example, <code>cast(number as String)</code>, or <code>extract(year from date)</code>, or even <code>trim(leading '.' from string)</code>.
This syntax is inspired by standard ANSI SQL, and we promise you&#8217;ll get used to it.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>HQL abstracts away from the actual database-native SQL functions, letting you write queries which are portable between databases.</p>
</div>
<div class="paragraph">
<p>For some functions, and always depending on the database, a HQL function invocation translates to a quite complicated SQL expression!</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In addition, there are several ways to use a database function that&#8217;s not known to Hibernate.</p>
</div>
<div class="sect3">
<h4 id="functions-typecasts">2.6.1. Types and typecasts</h4>
<div class="paragraph">
<p>The following special functions make it possible to discover or narrow expression types:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 15%;">
<col>
<col>
<col style="width: 15%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Special function</th>
<th class="tableblock halign-left valign-top">Purpose</th>
<th class="tableblock halign-left valign-top">Signature</th>
<th class="tableblock halign-center valign-top">JPA standard</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>type()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The (concrete) entity name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>type(e)</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">âœ”</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>treat()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Narrow an entity type</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>treat(e as Entity)</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">âœ”</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>cast()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Narrow a basic type</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>cast(x as Type)</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">âœ–</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>str()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cast to a string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>str(x)</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">âœ–</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Let&#8217;s see what these functions do.</p>
</div>
<h5 id="function-type" class="discrete">Evaluating an entity type</h5>
<div class="paragraph">
<p>The function <code>type()</code>, applied to an identification variable, evaluates to the entity name of the referenced entity.
This is mainly useful when dealing with entity inheritance hierarchies.</p>
</div>
<div id="entity-type-exp-example" class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">select</span> <span class="n">payment</span>
<span class="k">from</span> <span class="n">Payment</span> <span class="k">as</span> <span class="n">payment</span>
<span class="k">where</span> <span class="n">type</span><span class="p">(</span><span class="n">payment</span><span class="p">)</span> <span class="o">=</span> <span class="n">CreditCardPayment</span></code></pre>
</div>
</div>
<h5 id="function-treat" class="discrete">Narrowing an entity type</h5>
<div class="paragraph">
<p>The function <code>treat()</code> may be used to narrow the type of an identification variable.
This is useful when dealing with entity inheritance hierarchies.</p>
</div>
<div id="treat-example" class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">select</span> <span class="n">payment</span>
<span class="k">from</span> <span class="n">Payment</span> <span class="k">as</span> <span class="n">payment</span>
<span class="k">where</span> <span class="k">length</span><span class="p">(</span><span class="n">treat</span><span class="p">(</span><span class="n">payment</span> <span class="k">as</span> <span class="n">CreditCardPayment</span><span class="p">).</span><span class="n">cardNumber</span><span class="p">)</span>
        <span class="k">between</span> <span class="mi">16</span> <span class="k">and</span> <span class="mi">20</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The type of the expression <code>treat(p as CreditCardPayment)</code> is the narrowed type, <code>CreditCardPayment</code>, instead of the declared type <code>Payment</code> of <code>p</code>.
This allows the attribute <code>cardNumber</code> declared by the subtype <code>CreditCardPayment</code> to be referenced.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The first argument is usually an identification variable.</p>
</li>
<li>
<p>The second argument is the target type given as an unqualified entity name.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The <code>treat()</code> function may even occur in a <a href="#join-treat">join</a>.</p>
</div>
<h5 id="function-cast" class="discrete">General typecasts</h5>
<div class="paragraph">
<p>The function <code>cast()</code> has a similar syntax, but is used to narrow basic types.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Its first argument is usually an attribute of an entity, or a more complex expression involving entity attributes.</p>
</li>
<li>
<p>Its second argument is the target type given as an unqualified Java class name:
<code>String</code>, <code>Long</code>, <code>Integer</code>, <code>Double</code>, <code>Float</code>, <code>Character</code>, <code>Byte</code>, <code>BigInteger</code>, <code>BigDecimal</code>, <code>LocalDate</code>, <code>LocalTime</code>, <code>LocalDateTime</code>, etc.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">select</span> <span class="k">cast</span><span class="p">(</span><span class="n">id</span> <span class="k">as</span> <span class="nb">String</span><span class="p">)</span> <span class="k">from</span> <span class="k">Order</span></code></pre>
</div>
</div>
<h5 id="function-str" class="discrete">Casting to string</h5>
<div class="paragraph">
<p>The function <code>str(x)</code> is a synonym for <code>cast(x as String)</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">select</span> <span class="n">str</span><span class="p">(</span><span class="n">id</span><span class="p">)</span> <span class="k">from</span> <span class="k">Order</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="functions-null">2.6.2. Functions for working with null values</h4>
<div class="paragraph">
<p>The following functions make it easy to deal with null values:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 15%;">
<col>
<col>
<col style="width: 15%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Function</th>
<th class="tableblock halign-left valign-top">Purpose</th>
<th class="tableblock halign-left valign-top">Signature</th>
<th class="tableblock halign-center valign-top">JPA standard</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>coalesce()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">First non-null argument</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>coalesce(x, y, z)</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">âœ”</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ifnull()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Second argument if first is null</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ifnull(x,y)</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">âœ–</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>nullif()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>null</code> if arguments are equal</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>nullif(x,y)</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">âœ”</p></td>
</tr>
</tbody>
</table>
<h5 id="_handling_null_values" class="discrete">Handling null values</h5>
<div class="paragraph">
<p>The <code>coalesce()</code> function is a sort of abbreviated <code>case</code> expression that returns the first non-null operand.</p>
</div>
<div id="coalesce-example" class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">select</span> <span class="k">coalesce</span><span class="p">(</span><span class="n">author</span><span class="p">.</span><span class="n">nomDePlume</span><span class="p">,</span> <span class="n">person</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>
<span class="k">from</span> <span class="n">Author</span> <span class="k">as</span> <span class="n">author</span>
    <span class="k">join</span> <span class="n">author</span><span class="p">.</span><span class="n">person</span> <span class="k">as</span> <span class="n">person</span></code></pre>
</div>
</div>
<h5 id="_handling_null_values_2" class="discrete">Handling null values</h5>
<div class="paragraph">
<p>HQL allows <code>ifnull()</code> as a synonym for <code>coalesce()</code> in the case of exactly two arguments.</p>
</div>
<div id="ifnull-example" class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">select</span> <span class="n">ifnull</span><span class="p">(</span><span class="n">author</span><span class="p">.</span><span class="n">nomDePlume</span><span class="p">,</span> <span class="n">person</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>
<span class="k">from</span> <span class="n">Author</span> <span class="k">as</span> <span class="n">author</span>
    <span class="k">join</span> <span class="n">author</span><span class="p">.</span><span class="n">person</span> <span class="k">as</span> <span class="n">person</span></code></pre>
</div>
</div>
<h5 id="_producing_null_values" class="discrete">Producing null values</h5>
<div class="paragraph">
<p>On the other hand, <code>nullif()</code> evaluates to null if its operands are equal, or to its first argument otherwise.</p>
</div>
<div id="nullif-example" class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">select</span> <span class="n">ifnull</span><span class="p">(</span><span class="k">nullif</span><span class="p">(</span><span class="n">author</span><span class="p">.</span><span class="n">nomDePlume</span><span class="p">,</span> <span class="n">person</span><span class="p">.</span><span class="n">name</span><span class="p">),</span> <span class="s1">'Real name'</span><span class="p">)</span>
<span class="k">from</span> <span class="n">Author</span> <span class="k">as</span> <span class="n">author</span>
    <span class="k">join</span> <span class="n">author</span><span class="p">.</span><span class="n">person</span> <span class="k">as</span> <span class="n">person</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="functions-datetime">2.6.3. Functions for working with dates and times</h4>
<div class="paragraph">
<p>There are some very important functions for working with dates and times.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 15%;">
<col>
<col>
<col style="width: 15%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Special function</th>
<th class="tableblock halign-left valign-top">Purpose</th>
<th class="tableblock halign-left valign-top">Signature</th>
<th class="tableblock halign-center valign-top">JPA standard</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>extract()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Extract a datetime field</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>extract(field from x)</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">âœ”</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>format()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Format a datetime as a string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>format(datetime as pattern)</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">âœ–</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>trunc()</code> or <code>truncate()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Datetime truncation</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>truncate(datetime, field)</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">âœ–</p></td>
</tr>
</tbody>
</table>
<h5 id="function-extract" class="discrete">Extracting date and time fields</h5>
<div class="paragraph">
<p>The special function <code>extract()</code> obtains a single field of a date, time, or datetime.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Its first argument is an expression that evaluates to a date, time, or datetime.</p>
</li>
<li>
<p>Its second argument is a date/time <em>field type</em>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Field types include: <code>day</code>, <code>month</code>, <code>year</code>, <code>second</code>, <code>minute</code>, <code>hour</code>, <code>day of week</code>, <code>day of month</code>, <code>week of year</code>, <code>date</code>, <code>time</code>, <code>epoch</code> and more.
For a full list of field types, see the Javadoc for <a href="https://docs.jboss.org/hibernate/orm/6.5/javadocs/org/hibernate/query/TemporalUnit.html"><code>TemporalUnit</code></a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">from</span> <span class="k">Order</span> <span class="k">where</span> <span class="k">extract</span><span class="p">(</span><span class="nb">date</span> <span class="k">from</span> <span class="n">created</span><span class="p">)</span> <span class="o">=</span> <span class="k">local</span> <span class="nb">date</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">select</span> <span class="k">extract</span><span class="p">(</span><span class="k">year</span> <span class="k">from</span> <span class="n">created</span><span class="p">),</span> <span class="k">extract</span><span class="p">(</span><span class="k">month</span> <span class="k">from</span> <span class="n">created</span><span class="p">)</span> <span class="k">from</span> <span class="k">Order</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The following functions are abbreviations for <code>extract()</code>:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 15%;">
<col>
<col style="width: 15%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Function</th>
<th class="tableblock halign-left valign-top">Long form using <code>extract()</code></th>
<th class="tableblock halign-center valign-top">JPA standard</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>year(x)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>extract(year from x)</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">âœ–</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>month(x)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>extract(month from x)</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">âœ–</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>day(x)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>extract(day from x)</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">âœ–</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>hour(x)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>extract(year from x)</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">âœ–</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>minute(x)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>extract(year from x)</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">âœ–</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>second(x)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>extract(year from x)</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">âœ–</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
These abbreviations aren&#8217;t part of the JPQL standard, but on the other hand they&#8217;re a lot less verbose.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">select</span> <span class="k">year</span><span class="p">(</span><span class="n">created</span><span class="p">),</span> <span class="k">month</span><span class="p">(</span><span class="n">created</span><span class="p">)</span> <span class="k">from</span> <span class="k">Order</span></code></pre>
</div>
</div>
<h5 id="function-format" class="discrete">Formatting dates and times</h5>
<div class="paragraph">
<p>The <code>format()</code> function formats a date, time, or datetime according to a pattern.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Its first argument is an expression that evaluates to a date, time, or datetime.</p>
</li>
<li>
<p>Its second argument is a formatting pattern, given as a string.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The pattern must be written in a subset of the pattern language defined by Java&#8217;s <code>java.time.format.DateTimeFormatter</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">select</span> <span class="k">format</span><span class="p">(</span><span class="k">local</span> <span class="k">datetime</span> <span class="k">as</span> <span class="s1">'yyyy-MM-dd HH:mm:ss'</span><span class="p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>For a full list of <code>format()</code> pattern elements, see the Javadoc for <a href="https://docs.jboss.org/hibernate/orm/6.5/javadocs/org/hibernate/dialect/Dialect.html#appendDatetimeFormat"><code>Dialect.appendDatetimeFormat</code></a>.</p>
</div>
<h5 id="function-trunc-datetime" class="discrete">Truncating a date or time type</h5>
<div class="paragraph">
<p>The <code>truncate()</code> function truncates the precision of a date, time, or datetime to the temporal unit specified by field type.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Its first argument is an expression that evaluates to a date, time, or datetime.</p>
</li>
<li>
<p>Its second argument is a date/time field type, specifying the precision of the truncated value.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Supported temporal units are: <code>year</code>, <code>month</code>, <code>day</code>, <code>hour</code>, <code>minute</code> or <code>second</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">select</span> <span class="k">trunc</span><span class="p">(</span><span class="k">local</span> <span class="k">datetime</span><span class="p">,</span> <span class="k">hour</span><span class="p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Truncating a date, time or datetime value means obtaining a value of the same type in which all temporal units smaller than <code>field</code> have been pruned.
For hours, minutes and second this means setting them to <code>00</code>. For months and days, this means setting them to <code>01</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="string-functions">2.6.4. Functions for working with strings</h4>
<div class="paragraph">
<p>Naturally, there are a good number of functions for working with strings.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 15%;">
<col style="width: 30%;">
<col>
<col style="width: 15%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Function</th>
<th class="tableblock halign-left valign-top">Purpose</th>
<th class="tableblock halign-left valign-top">Syntax</th>
<th class="tableblock halign-center valign-top">JPA standard / ANSI SQL Standard</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>upper()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The string, with lowercase characters converted to uppercase</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>upper(str)</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">âœ” / âœ”</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>lower()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The string, with uppercase characters converted to lowercase</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>lower(str)</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">âœ” / âœ”</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>length()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The length of the string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>length(str)</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">âœ” / âœ–</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>concat()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Concatenate strings</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>concat(x, y, z)</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">âœ” / âœ–</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>locate()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Location of string within a string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>locate(patt, str)</code>,<br>
<code>locate(patt, str, start)</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">âœ” / âœ–</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>position()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Similar to <code>locate()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>position(patt in str)</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">âœ– / âœ”</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>substring()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Substring of a string (JPQL-style)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>substring(str, start)</code>,<br>
<code>substring(str, start, len)</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">âœ” / âœ–</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>substring()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Substring of a string (ANSI SQL-style)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>substring(str from start)</code>,<br>
<code>substring(str from start for len)</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">âœ– / âœ”</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>trim()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Trim characters from string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>trim(str)</code>,<br>
<code>trim(leading from str)</code>,<br>
<code>trim(trailing from str)</code>, or<br>
<code>trim(leading char from str)</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">âœ” / âœ”</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>overlay()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">For replacing a substring</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>overlay(str placing rep from start)</code>,<br>
<code>overlay(str placing rep from start for len)</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">âœ– / âœ”</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>pad()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Pads a string with whitespace, or with a specified character</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>pad(str with len)</code>,<br>
<code>pad(str with len leading)</code>,<br>
<code>pad(str with len trailing)</code>, or<br>
<code>pad(str with len leading char)</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">âœ– / âœ–</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>left()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The leftmost characters of a string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>left(str, len)</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">âœ– / âœ–</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>right()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The rightmost characters of a string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>right(str, len)</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">âœ– / âœ–</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>replace()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Replace every occurrence of a pattern in a string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>replace(str, patt, rep)</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">âœ– / âœ–</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>repeat()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Concatenate a string with itself multiple times</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>repeat(str, times)</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">âœ– / âœ–</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>collate()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Select a collation</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>collate(p.name as collation)</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">âœ– / âœ–</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Let&#8217;s take a closer look at just some of these.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Contrary to Java, positions of characters within strings are indexed from 1 instead of 0!</p>
</div>
</td>
</tr>
</table>
</div>
<h5 id="_concatenating_strings" class="discrete">Concatenating strings</h5>
<div class="paragraph">
<p>The JPQL-standard and ANSI SQL-standard <code>concat()</code> function accepts a variable number of arguments, and produces a string by concatenating them.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">select</span> <span class="k">concat</span><span class="p">(</span><span class="n">book</span><span class="p">.</span><span class="n">title</span><span class="p">,</span> <span class="s1">' by '</span><span class="p">,</span> <span class="n">listagg</span><span class="p">(</span><span class="n">author</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">' &amp; '</span><span class="p">))</span>
<span class="k">from</span> <span class="n">Book</span> <span class="k">as</span> <span class="n">book</span>
    <span class="k">join</span> <span class="n">book</span><span class="p">.</span><span class="n">authors</span> <span class="k">as</span> <span class="n">author</span>
<span class="k">group</span> <span class="k">by</span> <span class="n">book</span></code></pre>
</div>
</div>
<h5 id="_finding_substrings" class="discrete">Finding substrings</h5>
<div class="paragraph">
<p>The JPQL function <code>locate()</code> determines the position of a substring within another string.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The first argument is the pattern to search for within the second string.</p>
</li>
<li>
<p>The second argument is the string to search in.</p>
</li>
<li>
<p>The optional third argument is used to specify a position at which to start the search.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">select</span> <span class="k">locate</span><span class="p">(</span><span class="s1">'Hibernate'</span><span class="p">,</span> <span class="n">title</span><span class="p">)</span> <span class="k">from</span> <span class="n">Book</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>position()</code> function has a similar purpose, but follows the ANSI SQL syntax.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">select</span> <span class="n">position</span><span class="p">(</span><span class="s1">'Hibernate'</span> <span class="k">in</span> <span class="n">title</span><span class="p">)</span> <span class="k">from</span> <span class="n">Book</span></code></pre>
</div>
</div>
<h5 id="_slicing_strings" class="discrete">Slicing strings</h5>
<div class="paragraph">
<p>Unsurprisingly, <code>substring()</code> returns a substring of the given string.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The second argument specifies the position of the first character of the substring.</p>
</li>
<li>
<p>The optional third argument specifies the maximum length of the substring.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">select</span> <span class="k">substring</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">position</span><span class="p">(</span><span class="s1">' for Dummies'</span> <span class="k">in</span> <span class="n">title</span><span class="p">))</span> <span class="k">from</span> <span class="n">Book</span>         <span class="cm">/* JPQL-style */</span>

<span class="k">select</span> <span class="k">substring</span><span class="p">(</span><span class="n">title</span> <span class="k">from</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">position</span><span class="p">(</span><span class="s1">' for Dummies'</span> <span class="k">in</span> <span class="n">title</span><span class="p">))</span> <span class="k">from</span> <span class="n">Book</span>  <span class="cm">/* ANSI SQL-style */</span></code></pre>
</div>
</div>
<h5 id="_trimming_strings" class="discrete">Trimming strings</h5>
<div class="paragraph">
<p>The <code>trim()</code> function follows the syntax and semantics of ANSI SQL.
It may be used to trim <code>leading</code> characters, <code>trailing</code> characters, or both.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">select</span> <span class="k">trim</span><span class="p">(</span><span class="n">title</span><span class="p">)</span> <span class="k">from</span> <span class="n">Book</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">select</span> <span class="k">trim</span><span class="p">(</span><span class="n">trailing</span> <span class="s1">' '</span> <span class="k">from</span> <span class="n">text</span><span class="p">)</span> <span class="k">from</span> <span class="n">Book</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Its BNF is funky:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="antlrv4">"TRIM" "(" (("LEADING" | "TRAILING" | "BOTH")? trimCharacter? "FROM")? expression ")" ;</code></pre>
</div>
</div>
<h5 id="_padding_strings" class="discrete">Padding strings</h5>
<div class="paragraph">
<p>The <code>pad()</code> function has a syntax inspired by <code>trim()</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">select</span> <span class="k">concat</span><span class="p">(</span><span class="n">pad</span><span class="p">(</span><span class="n">b</span><span class="p">.</span><span class="n">title</span> <span class="k">with</span> <span class="mi">40</span> <span class="n">trailing</span> <span class="s1">'.'</span><span class="p">),</span>
              <span class="n">pad</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">firstName</span> <span class="k">with</span> <span class="mi">10</span> <span class="n">leading</span><span class="p">),</span>
              <span class="n">pad</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">lastName</span> <span class="k">with</span> <span class="mi">10</span> <span class="n">leading</span><span class="p">))</span>
<span class="k">from</span> <span class="n">Book</span> <span class="k">as</span> <span class="n">b</span>
    <span class="k">join</span> <span class="n">b</span><span class="p">.</span><span class="n">authors</span> <span class="k">as</span> <span class="n">a</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Its BNF is given by:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="antlrv4">"PAD" "(" expression "WITH" expression ("LEADING" | "TRAILING") padCharacter? ")"</code></pre>
</div>
</div>
<h5 id="_collations" class="discrete">Collations</h5>
<div class="paragraph">
<p>The <code>collate()</code> function selects a collation to be used for its string-valued argument.
Collations are useful for <a href="#relational-comparisons">binary comparisons</a> with <code>&lt;</code> or <code>&gt;</code>, and in the <a href="#order-by">order by clause</a>.</p>
</div>
<div class="paragraph">
<p>For example, <code>collate(p.name as ucs_basic)</code> specifies the SQL standard collation <code>ucs_basic</code>.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Collations aren&#8217;t very portable between databases.
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Some PostgreSQL collation names must be quoted with backticks, for example, <code>collate(name as `zh_TW.UTF-8`)</code>.
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The <code>@Collate</code> annotation may be used to specify the collation of a column, which is usually more convenient than using the <code>collate()</code> function.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="functions-numeric">2.6.5. Numeric functions</h4>
<div class="paragraph">
<p>Of course, we also have a number of functions for working with numeric values.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 15%;">
<col>
<col>
<col style="width: 15%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Function</th>
<th class="tableblock halign-left valign-top">Purpose</th>
<th class="tableblock halign-left valign-top">Signature</th>
<th class="tableblock halign-center valign-top">JPA standard</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>abs()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The magnitude of a number</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>abs(x)</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">âœ”</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>sign()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The sign of a number</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>sign(x)</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">âœ”</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>mod()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Remainder of integer division</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>mod(n,d)</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">âœ”</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>sqrt()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Square root of a number</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>sqrt(x)</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">âœ”</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>exp()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Exponential function</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>exp(x)</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">âœ”</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>power()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Exponentiation</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>power(x,y)</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">âœ”</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ln()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Natural logarithm</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ln(x)</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">âœ”</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>round()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Numeric rounding</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>round(number)</code>,<br>
<code>round(number, places)</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">âœ”</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>trunc()</code> or <code>truncate()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Numeric truncation</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>truncate(number)</code>,<br>
<code>truncate(number, places)</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">âœ–</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>floor()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Floor function</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>floor(x)</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">âœ”</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ceiling()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Ceiling function</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ceiling(x)</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">âœ”</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>log10()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Base-10 logarithm</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>log10(x)</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">âœ–</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>log()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Arbitrary-base logarithm</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>log(b,x)</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">âœ–</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>pi</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">&#960;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>pi</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">âœ–</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>sin()</code>, <code>cos()</code>, <code>tan()</code>, <code>asin()</code>, <code>acos()</code>, <code>atan()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Basic trigonometric functions</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>sin(theta)</code>, <code>cos(theta)</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">âœ–</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>atan2()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Two-argument arctangent (range <code>(-&#960;,&#960;]</code>)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>atan2(y, x)</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">âœ–</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>sinh()</code>, <code>cosh()</code>, <code>tanh()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Hyperbolic functions</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>sinh(x)</code>, <code>cosh(x)</code>, <code>tanh(x)</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">âœ–</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>degrees()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Convert radians to degrees</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>degrees(x)</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">âœ–</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>radians()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Convert degrees to radians</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>radians(x)</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">âœ–</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>least()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Return the smallest of the given arguments</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>least(x, y, z)</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">âœ–</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>greatest()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Return the largest of the given arguments</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>greatest(x, y, z)</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">âœ–</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>bitand()</code>, <code>bitor()</code>, <code>bitxor()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Bitwise functions</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>bitand(x,y)</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">âœ–</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>We haven&#8217;t included <a href="#aggregate-functions">aggregate functions</a>, <a href="#aggregate-functions-orderedset">ordered set aggregate functions</a>, or <a href="#aggregate-functions-window">window functions</a> in this list, because their purpose is more specialized, and because they come with extra special syntax.</p>
</div>
</div>
<div class="sect3">
<h4 id="functions-collections">2.6.6. Functions for dealing with collections</h4>
<div class="paragraph">
<p>The functions described in this section are especially useful when dealing with <code>@ElementCollection</code> mappings, or with collection mappings involving an <code>@OrderColumn</code> or <code>@MapKeyColumn</code>.</p>
</div>
<div class="paragraph">
<p>The following functions accept either:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>an identification variable that refers to a <a href="#collection-valued-associations">joined collection or many-valued association</a>, or</p>
</li>
<li>
<p>a <a href="#path-expressions">compound path</a> that refers to a collection or many-valued association of an entity.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>In case 2, application of the function produces an <a href="#implicit-collection-join">implicit join</a>.</p>
</div>
<table id="collection-functions" class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 15%;">
<col style="width: 20%;">
<col>
<col style="width: 15%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Function</th>
<th class="tableblock halign-left valign-top">Applies to</th>
<th class="tableblock halign-left valign-top">Purpose</th>
<th class="tableblock halign-center valign-top">JPA standard</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>size()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Any collection</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The size of a collection</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">âœ”</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>element()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Any collection</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The element of a set or list</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">âœ–</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>index()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Lists</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The index of a list element</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">âœ”</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>key()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Maps</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The key of a map entry</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">âœ”</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>value()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Maps</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The value of a map entry</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">âœ”</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>entry()</code> ðŸ’€</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Maps</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The whole entry in a map</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">âœ”</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The next group of functions always accept a compound path referring to a collection or many-valued association of an entity.
They&#8217;re interpreted as referring to the collection as a whole.</p>
</div>
<table id="collective-collection-functions" class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 15%;">
<col style="width: 20%;">
<col>
<col style="width: 15%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Function</th>
<th class="tableblock halign-left valign-top">Applies to</th>
<th class="tableblock halign-left valign-top">Purpose</th>
<th class="tableblock halign-center valign-top">JPA standard</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>elements()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Any collection</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The elements of a set or list, collectively</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">âœ–</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>indices()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Lists</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The indexes of a list, collectively</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">âœ–</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>keys()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Maps</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The keys of a map, collectively</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">âœ–</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>values()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Maps</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The values of a map, collectively</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">âœ–</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Application of one of these function produces an implicit subquery or implicit join.</p>
</div>
<div class="paragraph">
<p>This query has an implicit join:</p>
</div>
<div id="elements-join-example" class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">select</span> <span class="n">title</span><span class="p">,</span> <span class="n">element</span><span class="p">(</span><span class="n">tags</span><span class="p">)</span> <span class="k">from</span> <span class="n">Book</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This query has an implicit subquery:</p>
</div>
<div id="elements-subquery-example" class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">select</span> <span class="n">title</span> <span class="k">from</span> <span class="n">Book</span> <span class="k">where</span> <span class="s1">'hibernate'</span> <span class="k">in</span> <span class="n">elements</span><span class="p">(</span><span class="n">tags</span><span class="p">)</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
It never makes sense to apply the functions <code>elements()</code>, <code>indices()</code>, <code>keys()</code>, or <code>values()</code> to an identification variable or single-valued path expression.
These functions must be applied to a reference to a many-valued path expression.
</td>
</tr>
</table>
</div>
<h5 id="_collection_sizes" class="discrete">Collection sizes</h5>
<div class="paragraph">
<p>The <code>size()</code> function returns the number of elements of a collection or to-many association.</p>
</div>
<div id="size-example" class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">select</span> <span class="n">name</span><span class="p">,</span> <span class="k">size</span><span class="p">(</span><span class="n">books</span><span class="p">)</span> <span class="k">from</span> <span class="n">Author</span></code></pre>
</div>
</div>
<h5 id="set-functions" class="discrete">Set or list elements</h5>
<div class="paragraph">
<p>The <code>element()</code> function returns a reference to an element of a joined set or list.
For an identification variable (case 1 above), this function is optional.
For a compound path (case 2), it&#8217;s required.</p>
</div>
<h5 id="list-functions" class="discrete">List indexes</h5>
<div class="paragraph">
<p>The <code>index()</code> function returns a reference to the index of a joined list.</p>
</div>
<div class="paragraph">
<p>In this example, <code>element()</code> is optional, but <code>index()</code> is required:</p>
</div>
<div id="index-example" class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">select</span> <span class="n">id</span><span class="p">(</span><span class="n">book</span><span class="p">),</span> <span class="k">index</span><span class="p">(</span><span class="n">ed</span><span class="p">),</span> <span class="n">element</span><span class="p">(</span><span class="n">ed</span><span class="p">)</span>
<span class="k">from</span> <span class="n">Book</span> <span class="n">book</span> <span class="k">as</span> <span class="n">book</span>
    <span class="k">join</span> <span class="n">book</span><span class="p">.</span><span class="n">editions</span> <span class="k">as</span> <span class="n">ed</span></code></pre>
</div>
</div>
<h5 id="map-functions" class="discrete">Map keys and values</h5>
<div class="paragraph">
<p>The <code>key()</code> function returns a reference to a key of a joined map.
The <code>value()</code> function returns a reference to its value.</p>
</div>
<div id="key-value-example" class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">select</span> <span class="k">key</span><span class="p">(</span><span class="n">entry</span><span class="p">),</span> <span class="n">value</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>
<span class="k">from</span> <span class="n">Thing</span> <span class="k">as</span> <span class="n">thing</span>
    <span class="k">join</span> <span class="n">thing</span><span class="p">.</span><span class="n">entries</span> <span class="k">as</span> <span class="n">entry</span></code></pre>
</div>
</div>
<div class="sect4">
<h5 id="elements-indices">Quantification over collections</h5>
<div class="paragraph">
<p>The functions <code>elements()</code>, <code>indices()</code>, <code>keys()</code>, and <code>values()</code> are used to quantify over collections.
We may use them with:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>an <a href="#in-predicate"><code>in</code></a> or <a href="#exists-predicate"><code>exists</code></a> predicate,</p>
</li>
<li>
<p>a <a href="#relational-comparisons-subqueries">relational comparison</a>, or</p>
</li>
<li>
<p>an <a href="#aggregate-functions-collections">aggregate function</a>.</p>
</li>
</ul>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 35%;">
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Shortcut</th>
<th class="tableblock halign-left valign-top">Equivalent subquery</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>exists elements(book.editions)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>exists (select ed from book.editions as ed)</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>2 in indices(book.editions)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>2 in (select index(ed) from book.editions as ed)</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>10 &gt; all(elements(book.printings))</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>10 &gt; all(select pr from book.printings as pr)</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>max(elements(book.printings))</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>(select max(pr) from book.printings as pr)</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">select</span> <span class="n">title</span> <span class="k">from</span> <span class="n">Book</span> <span class="k">where</span> <span class="s1">'hibernate'</span> <span class="k">in</span> <span class="n">elements</span><span class="p">(</span><span class="n">tags</span><span class="p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Don&#8217;t confuse the <code>elements()</code> function with <code>element()</code>, the <code>indices()</code> function with <code>index()</code>, the <code>keys()</code> function with <code>key()</code>, or the <code>values()</code> function with <code>value()</code>.
The functions named in singular deal with elements of "flattened" collections.
If not already joined, they add an implicit join to the query.
The functions with plural naming do <em>not</em> flatten a collection by joining it.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The following queries are different:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">select</span> <span class="n">title</span><span class="p">,</span> <span class="k">max</span><span class="p">(</span><span class="k">index</span><span class="p">(</span><span class="n">revisions</span><span class="p">))</span> <span class="k">from</span> <span class="n">Book</span>  <span class="cm">/* implicit join */</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">select</span> <span class="n">title</span><span class="p">,</span> <span class="k">max</span><span class="p">(</span><span class="n">indices</span><span class="p">(</span><span class="n">revisions</span><span class="p">))</span> <span class="k">from</span> <span class="n">Book</span>  <span class="cm">/* implicit subquery */</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The first query produces a single row, with <code>max()</code> taken over all books.
The second query produces a row per book, with <code>max()</code> taken over the collection elements belonging to the given book.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="functions-model">2.6.7. Functions for working with ids and versions</h4>
<div class="paragraph">
<p>Finally, the following functions evaluate the id, version, or natural id of an entity, or the foreign key of a to-one association:</p>
</div>
<table id="model-functions" class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 12%;">
<col>
<col style="width: 15%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Function</th>
<th class="tableblock halign-left valign-top">Purpose</th>
<th class="tableblock halign-center valign-top">JPA standard</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>id()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The value of the entity <code>@Id</code> attribute.</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">âœ–</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>version()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The value of the entity <code>@Version</code> attribute.</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">âœ–</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>naturalid()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The value of the entity <code>@NaturalId</code> attribute.</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">âœ–</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>fk()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The value of the foreign key column mapped by a <code>@ManyToOne</code> (or logical <code>@OneToOne</code>) association.
Useful with associations annotated <code>@NotFound</code>.</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">âœ–</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="embedding-sql">2.6.8. Embedding SQL expressions</h4>
<div class="paragraph">
<p>The following special functions let us embed a call to a native SQL function, refer directly to a column, or evaluate an expression written in native SQL.</p>
</div>
<table id="sql-embedding-functions" class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 12%;">
<col>
<col style="width: 35%;">
<col style="width: 15%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Function</th>
<th class="tableblock halign-left valign-top">Purpose</th>
<th class="tableblock halign-left valign-top">Signature</th>
<th class="tableblock halign-center valign-top">JPA standard</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>function()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Call a SQL function</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>function('fun', arg1, arg2)</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">âœ”</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>function()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Call a SQL function</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>function(fun, arg1, arg2)</code>,<br>
<code>function(fun as Type, arg1, arg2)</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">âœ–</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>column()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A column value</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>column(entity.column)</code>,<br>
<code>column(entity.column as Type)</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">âœ–</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>sql()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Evaluate a SQL expression</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>sql('text', arg1, arg2)</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">âœ–</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Before using one of these functions, ask yourself if it might be better to just write the whole query in native SQL.
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="column-references">Direct column references</h5>
<div class="paragraph">
<p>The <code>column()</code> function lets us refer to an unmapped column of a table.
The column name must be qualified by an identification variable or path expression.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">select</span> <span class="k">column</span><span class="p">(</span><span class="k">log</span><span class="p">.</span><span class="n">ctid</span> <span class="k">as</span> <span class="nb">String</span><span class="p">)</span>
<span class="k">from</span> <span class="k">Log</span> <span class="k">log</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Of course, the table itself must be mapped by an entity class.</p>
</div>
</div>
<div class="sect4">
<h5 id="user-defined-functions">Native and user-defined functions</h5>
<div class="paragraph">
<p>The functions we&#8217;ve described above are the functions abstracted by HQL and made portable across databases.
But, of course, HQL can&#8217;t abstract every function in your database.</p>
</div>
<div class="paragraph">
<p>There are several ways to call native or user-defined SQL functions.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A native or user-defined function may be called using JPQL&#8217;s <code>function</code> syntax, for example, <code>function('sinh', phi)</code>, or HQL&#8217;s extension to that syntax, for example <code>function(sinh as Double, phi)</code>.
(This is the easiest way, but not the best way.)</p>
</li>
<li>
<p>A user-written <code>FunctionContributor</code> may register user-defined functions.</p>
</li>
<li>
<p>A custom <code>Dialect</code> may register additional native functions by overriding <code>initializeFunctionRegistry()</code>.</p>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Registering a function isn&#8217;t hard, but is beyond the scope of this guide.</p>
</div>
<div class="paragraph">
<p>(It&#8217;s even possible to use the APIs Hibernate provides to make your own <em>portable</em> functions!)</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Fortunately, every built-in <code>Dialect</code> already registers many native functions for the database it supports.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Try setting the log category <code>org.hibernate.HQL_FUNCTIONS</code> to debug.
Then at startup Hibernate will log a list of type signatures of all registered functions.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="function-sql">Embedding native SQL in HQL</h5>
<div class="paragraph">
<p>The special function <code>sql()</code> allows the use of native SQL fragments inside an HQL query.</p>
</div>
<div class="paragraph">
<p>The signature of this function is <code>sql(pattern[, argN]*)</code>, where <code>pattern</code> must be a string literal but the remaining arguments may be of any type.
The pattern literal is unquoted and embedded in the generated SQL.
Occurrences of <code>?</code> in the pattern are replaced with the remaining arguments of the function.</p>
</div>
<div class="paragraph">
<p>We may use this, for example, to perform a native PostgreSQL typecast:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">from</span> <span class="n">Computer</span> <span class="n">c</span> <span class="k">where</span> <span class="n">c</span><span class="p">.</span><span class="n">ipAddress</span> <span class="o">=</span> <span class="n">sql</span><span class="p">(</span><span class="s1">'?::inet'</span><span class="p">,</span> <span class="s1">'127.0.0.1'</span><span class="p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This results in SQL logically equivalent to:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sql"><span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">Computer</span> <span class="k">c</span> <span class="k">where</span> <span class="k">c</span><span class="p">.</span><span class="n">ipAddress</span> <span class="o">=</span> <span class="s1">'127.0.0.1'</span><span class="p">::</span><span class="n">inet</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Or we can use a native SQL operator:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">from</span> <span class="n">Human</span> <span class="n">h</span> <span class="k">order</span> <span class="k">by</span> <span class="n">sql</span><span class="p">(</span><span class="s1">'(? &lt;-&gt; ?)'</span><span class="p">,</span> <span class="n">h</span><span class="p">.</span><span class="n">workLocation</span><span class="p">,</span> <span class="n">h</span><span class="p">.</span><span class="n">homeLocation</span><span class="p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And this time the SQL is logically equivalent to:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sql"><span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">Human</span> <span class="n">h</span> <span class="k">where</span> <span class="p">(</span><span class="n">h</span><span class="p">.</span><span class="n">workLocation</span> <span class="o">&lt;-&gt;</span> <span class="n">h</span><span class="p">.</span><span class="n">homeLocation</span><span class="p">)</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="conditional-expressions">2.7. Predicates</h3>
<div class="paragraph">
<p>A predicate is an operator which, when applied to some argument, evaluates to <code>true</code> or <code>false</code>.
In the world of SQL-style ternary logic, we must expand this definition to encompass the possibility that the predicate evaluates to <code>null</code>.
Typically, a predicate evaluates to <code>null</code> when one of its arguments is <code>null</code>.</p>
</div>
<div class="paragraph">
<p>Predicates occur in the <code>where</code> clause, the <code>having</code> clause and in searched case expressions.</p>
</div>
<div class="sect3">
<h4 id="relational-comparisons">2.7.1. Comparison operators</h4>
<div class="paragraph">
<p>The binary comparison operators are borrowed from SQL: <code>=</code>, <code>&gt;</code>, <code>&gt;=</code>, <code>&lt;</code>, <code>&lt;=</code>, <code>&lt;&gt;</code>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
If you prefer, HQL treats <code>!=</code> as a synonym for <code>&lt;&gt;</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The operands should be of the same type.</p>
</div>
<div id="relational-comparisons-example" class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">from</span> <span class="n">Book</span> <span class="k">where</span> <span class="n">price</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">.</span><span class="mi">0</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">from</span> <span class="n">Author</span> <span class="k">as</span> <span class="n">author</span> <span class="k">where</span> <span class="n">author</span><span class="p">.</span><span class="n">nomDePlume</span> <span class="o">&lt;&gt;</span> <span class="n">author</span><span class="p">.</span><span class="n">person</span><span class="p">.</span><span class="n">name</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">select</span> <span class="n">id</span><span class="p">,</span> <span class="n">total</span>
<span class="k">from</span> <span class="p">(</span>
    <span class="k">select</span> <span class="n">ord</span><span class="p">.</span><span class="n">id</span> <span class="k">as</span> <span class="n">id</span><span class="p">,</span> <span class="k">sum</span><span class="p">(</span><span class="n">item</span><span class="p">.</span><span class="n">book</span><span class="p">.</span><span class="n">price</span> <span class="o">*</span> <span class="n">item</span><span class="p">.</span><span class="n">quantity</span><span class="p">)</span> <span class="k">as</span> <span class="n">total</span>
    <span class="k">from</span> <span class="k">Order</span> <span class="k">as</span> <span class="n">ord</span>
        <span class="k">join</span> <span class="n">Item</span> <span class="k">as</span> <span class="n">item</span>
    <span class="k">group</span> <span class="k">by</span> <span class="n">ord</span>
<span class="p">)</span>
<span class="k">where</span> <span class="n">total</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">.</span><span class="mi">0</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="between-predicate">2.7.2. The <code>between</code> predicate</h4>
<div class="paragraph">
<p>The ternary <code>between</code> operator, and its negation, <code>not between</code>, determine if a value falls within a range.</p>
</div>
<div class="paragraph">
<p>Of course, all three operands must be of compatible type.</p>
</div>
<div id="between-predicate-example" class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">from</span> <span class="n">Book</span> <span class="k">where</span> <span class="n">price</span> <span class="k">between</span> <span class="mi">1</span><span class="p">.</span><span class="mi">0</span> <span class="k">and</span> <span class="mi">100</span><span class="p">.</span><span class="mi">0</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="null-predicate">2.7.3. Operators for dealing with null</h4>
<div class="paragraph">
<p>The following operators make it easier to deal with null values.
These predicates never evaluate to <code>null</code>.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 15%;">
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Operator</th>
<th class="tableblock halign-left valign-top">Negation</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Semantics</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>is null</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>is not null</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Unary postfix</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>true</code> if the value to the left is null, or false if it is not null</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>is distinct from</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>is not distinct from</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Binary</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>true</code> if the value on the left is equal to the value on the right, or if both values are null, and false otherwise</p></td>
</tr>
</tbody>
</table>
<div id="null-predicate-example" class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">from</span> <span class="n">Author</span> <span class="k">where</span> <span class="n">nomDePlume</span> <span class="k">is</span> <span class="k">not</span> <span class="k">null</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="boolean-predicate">2.7.4. Operators for dealing with boolean values</h4>
<div class="paragraph">
<p>These operators perform comparisons on values of type <code>boolean</code>.
These predicates never evaluate to <code>null</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The values <code>true</code> and <code>false</code> of the <code>boolean</code> basic type are different to the logical <code>true</code> or <code>false</code> produced by a predicate.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For <em>logical</em> operations on <a href="#conditional-expressions">predicates</a>, see <a href="#logical-operators">Logical operators</a> below.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 15%;">
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Operator</th>
<th class="tableblock halign-left valign-top">Negation</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Semantics</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>is true</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>is not true</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Unary postfix</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>true</code> if the value to the left is <code>true</code>, or <code>false</code> otherwise</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>is false</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>is not false</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Binary</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>true</code> if the value to the left is <code>false</code>, or <code>false</code> otherwise</p></td>
</tr>
</tbody>
</table>
<div id="boolean-predicate-example" class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">from</span> <span class="n">Book</span> <span class="k">where</span> <span class="n">discontinued</span> <span class="k">is</span> <span class="k">not</span> <span class="k">true</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="collection-operators">2.7.5. Collection predicates</h4>
<div class="paragraph">
<p>The following operators apply to collection-valued attributes and to-many associations.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 15%;">
<col style="width: 15%;">
<col style="width: 20%;">
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Operator</th>
<th class="tableblock halign-left valign-top">Negation</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Semantics</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>is empty</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>is not empty</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Unary postfix</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>true</code> if the collection or association on the left has no elements</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>member of</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>not member of</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Binary</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>true</code> if the value on the left is a member of the collection or association on the right</p></td>
</tr>
</tbody>
</table>
<div id="empty-collection-predicate-example" class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">from</span> <span class="n">Author</span> <span class="k">where</span> <span class="n">books</span> <span class="k">is</span> <span class="n">empty</span></code></pre>
</div>
</div>
<div id="member-of-collection-predicate-example" class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">select</span> <span class="n">author</span><span class="p">,</span> <span class="n">book</span>
<span class="k">from</span> <span class="n">Author</span> <span class="k">as</span> <span class="n">author</span><span class="p">,</span> <span class="n">Book</span> <span class="k">as</span> <span class="n">book</span>
<span class="k">where</span> <span class="n">author</span> <span class="n">member</span> <span class="k">of</span> <span class="n">book</span><span class="p">.</span><span class="n">authors</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="like-predicate">2.7.6. String pattern matching</h4>
<div class="paragraph">
<p>The <code>like</code> operator performs pattern matching on strings.
Its friend <code>ilike</code> performs case-insensitive matching.</p>
</div>
<div class="paragraph">
<p>Their syntax is defined by:</p>
</div>
<div id="like-predicate-bnf" class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="antlrv4">expression "NOT"? ("LIKE" | "ILIKE") expression ("ESCAPE" character)?</code></pre>
</div>
</div>
<div class="paragraph">
<p>The expression on the right is a pattern, where:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>_</code> matches any single character,</p>
</li>
<li>
<p><code>%</code> matches any number of characters, and</p>
</li>
<li>
<p>if an escape character is specified, it may be used to escape either of these wildcards.</p>
</li>
</ul>
</div>
<div id="like-predicate-example" class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">from</span> <span class="n">Book</span> <span class="k">where</span> <span class="n">title</span> <span class="k">not</span> <span class="k">like</span> <span class="s1">'% for Dummies'</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The optional <code>escape</code> character allows a pattern to include a literal <code>_</code> or <code>%</code> character.</p>
</div>
<div class="paragraph">
<p>As you can guess, <code>not like</code> and <code>not ilike</code> are the enemies of <code>like</code> and <code>ilike</code>, and evaluate to the exact opposite boolean values.</p>
</div>
</div>
<div class="sect3">
<h4 id="in-predicate">2.7.7. The <code>in</code> predicate</h4>
<div class="paragraph">
<p>The <code>in</code> predicates evaluates to true if the value to its left is in &#8230;&#8203; well, whatever it finds to its right.</p>
</div>
<div class="paragraph">
<p>Its syntax is unexpectedly complicated:</p>
</div>
<div id="in-predicate-bnf" class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="antlrv4">expression "NOT"? "IN" inList

inList
	: collectionQuantifier "(" simplePath ")"
	| "(" (expression ("," expression)*)? ")"
	| "(" subquery ")"
	| parameter</code></pre>
</div>
</div>
<div class="paragraph">
<p>This less-than-lovely fragment of the HQL ANTLR grammar tells us that the thing to the right might be:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>a list of values enclosed in parentheses,</p>
</li>
<li>
<p>a subquery,</p>
</li>
<li>
<p>one of the collection-handling functions defined <a href="#elements-indices">above</a>, or</p>
</li>
<li>
<p>a query parameter,</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The type of the expression on the left, and the types of all the values on the right must be compatible.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>JPQL limits the legal types to string, numeric, date/time, and enum types, and in JPQL the left expression must be either:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>a <em>state field</em>, which means a basic attribute, excluding associations and embedded attributes, or</p>
</li>
<li>
<p>an <a href="#functions-typecasts"><em>entity type expression</em></a>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>HQL is far more permissive. HQL itself does not restrict the type in any way, though the database itself might.
Even embedded attributes are allowed, although that feature depends on the level of support for tuple or "row value" constructors in the underlying database.</p>
</div>
</td>
</tr>
</table>
</div>
<div id="in-predicate-example" class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">from</span> <span class="n">Payment</span> <span class="k">as</span> <span class="n">payment</span>
<span class="k">where</span> <span class="n">type</span><span class="p">(</span><span class="n">payment</span><span class="p">)</span> <span class="k">in</span> <span class="p">(</span><span class="n">CreditCardPayment</span><span class="p">,</span> <span class="n">WireTransferPayment</span><span class="p">)</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">from</span> <span class="n">Author</span> <span class="k">as</span> <span class="n">author</span>
<span class="k">where</span> <span class="n">author</span><span class="p">.</span><span class="n">person</span><span class="p">.</span><span class="n">name</span> <span class="k">in</span> <span class="p">(</span><span class="k">select</span> <span class="n">name</span> <span class="k">from</span> <span class="n">OldAuthorData</span><span class="p">)</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">from</span> <span class="n">Book</span> <span class="k">as</span> <span class="n">book</span>
<span class="k">where</span> <span class="p">:</span><span class="n">edition</span> <span class="k">in</span> <span class="n">elements</span><span class="p">(</span><span class="n">book</span><span class="p">.</span><span class="n">editions</span><span class="p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>It&#8217;s quite common to have a parameterized list of values.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Here&#8217;s a very useful idiom:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nc">List</span><span class="o">&lt;</span><span class="nc">Book</span><span class="o">&gt;</span> <span class="n">books</span> <span class="o">=</span>
        <span class="n">session</span><span class="o">.</span><span class="na">createSelectionQuery</span><span class="o">(</span><span class="s">"from Book where isbn in :isbns"</span><span class="o">,</span> <span class="nc">Book</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
            <span class="o">.</span><span class="na">setParameterList</span><span class="o">(</span><span class="s">"isbns"</span><span class="o">,</span> <span class="n">listOfIsbns</span><span class="o">)</span>
            <span class="o">.</span><span class="na">getResultList</span><span class="o">();</span></code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We may even "vectorize" an <code>in</code> predicate, using a tuple constructor and a subquery with multiple selection items:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">from</span> <span class="n">Author</span> <span class="k">as</span> <span class="n">author</span>
<span class="k">where</span> <span class="p">(</span><span class="n">author</span><span class="p">.</span><span class="n">person</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">author</span><span class="p">.</span><span class="n">person</span><span class="p">.</span><span class="n">birthdate</span><span class="p">)</span>
    <span class="k">in</span> <span class="p">(</span><span class="k">select</span> <span class="n">name</span><span class="p">,</span> <span class="n">birthdate</span> <span class="k">from</span> <span class="n">OldAuthorData</span><span class="p">)</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="relational-comparisons-subqueries">2.7.8. Comparison operators and subqueries</h4>
<div class="paragraph">
<p>The binary comparisons we met <a href="#relational-comparisons">above</a> may involve a quantifier, either:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>a quantified subquery, or</p>
</li>
<li>
<p>a quantifier applied to one of the functions defined <a href="#elements-indices">above</a>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The quantifiers are unary prefix operators: <code>all</code>, <code>every</code>, <code>any</code>, and <code>some</code>.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 10%;">
<col style="width: 10%;">
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Subquery operator</th>
<th class="tableblock halign-left valign-top">Synonym</th>
<th class="tableblock halign-left valign-top">Semantics</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>every</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>all</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Evaluates to true of the comparison is true for <em>every</em> value in the result set of the subquery</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>any</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>some</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Evaluates to true of the comparison is true for <em>at least one</em> value in the result set of the subquery</p></td>
</tr>
</tbody>
</table>
<div id="all-subquery-comparison-qualifier-example" class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">from</span> <span class="n">Publisher</span> <span class="n">pub</span> <span class="k">where</span> <span class="mi">100</span><span class="p">.</span><span class="mi">0</span> <span class="o">&lt;</span> <span class="k">all</span><span class="p">(</span><span class="k">select</span> <span class="n">price</span> <span class="k">from</span> <span class="n">pub</span><span class="p">.</span><span class="n">books</span><span class="p">)</span></code></pre>
</div>
</div>
<div id="collection-expressions-all-some-example" class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">from</span> <span class="n">Publisher</span> <span class="n">pub</span> <span class="k">where</span> <span class="p">:</span><span class="n">title</span> <span class="o">=</span> <span class="n">some</span><span class="p">(</span><span class="k">select</span> <span class="n">title</span> <span class="k">from</span> <span class="n">pub</span><span class="p">.</span><span class="n">books</span><span class="p">)</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="exists-predicate">2.7.9. The <code>exists</code> predicate</h4>
<div class="paragraph">
<p>The unary prefix <code>exists</code> operator evaluates to true if the thing to its right is nonempty.</p>
</div>
<div class="paragraph">
<p>The thing to its right might be:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>a subquery, or</p>
</li>
<li>
<p>one of the functions defined <a href="#elements-indices">above</a>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>As you can surely guess, <code>not exists</code> evaluates to true if the thing to the right <em>is</em> empty.</p>
</div>
<div id="collection-expressions-exists-example" class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">from</span> <span class="n">Author</span> <span class="k">where</span> <span class="k">exists</span> <span class="n">elements</span><span class="p">(</span><span class="n">books</span><span class="p">)</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">from</span> <span class="n">Author</span> <span class="k">as</span> <span class="n">author</span>
<span class="k">where</span> <span class="k">exists</span> <span class="p">(</span>
    <span class="k">from</span> <span class="k">Order</span> <span class="k">join</span> <span class="k">items</span>
    <span class="k">where</span> <span class="n">book</span> <span class="k">in</span> <span class="n">elements</span><span class="p">(</span><span class="n">author</span><span class="p">.</span><span class="n">books</span><span class="p">)</span>
<span class="p">)</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="logical-operators">2.7.10. Logical operators</h4>
<div class="paragraph">
<p>The logical operators are binary infix <code>and</code> and <code>or</code>, and unary prefix <code>not</code>.</p>
</div>
<div class="paragraph">
<p>Just like SQL, logical expressions are based on ternary logic.
A logical operator evaluates to null if it has a null operand.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="root-entities-and-joins">3. Root entities and joins</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The <code>from</code> clause, and its subordinate <code>join</code> clauses sit right at the heart of most queries.</p>
</div>
<div class="sect2">
<h3 id="from-clause">3.1. Declaring root entities</h3>
<div class="paragraph">
<p>The <code>from</code> clause is responsible for declaring the entities available in the rest of the query, and assigning them aliases, or, in the language of the JPQL specification, <em>identification variables</em>.</p>
</div>
<div class="sect3">
<h4 id="identification-variables">3.1.1. Identification variables</h4>
<div class="paragraph">
<p>An identification variable is just a name we can use to refer to an entity and its attributes from expressions in the query.
It may be any legal Java identifier.
According to the JPQL specification, identification variables must be treated as case-insensitive language elements.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The identification variable is actually optional, but for queries involving more than one entity it&#8217;s almost always a good idea to declare one.</p>
</div>
<div class="paragraph">
<p>This <em>works</em>, but it isn&#8217;t particularly good form:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">from</span> <span class="n">Publisher</span> <span class="k">join</span> <span class="n">books</span> <span class="k">join</span> <span class="n">authors</span> <span class="k">join</span> <span class="n">person</span> <span class="k">where</span> <span class="n">ssn</span> <span class="o">=</span> <span class="p">:</span><span class="n">ssn</span></code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Identification variables may be declared with the <code>as</code> keyword, but this is optional.</p>
</div>
</div>
<div class="sect3">
<h4 id="root-reference">3.1.2. Root entity references</h4>
<div class="paragraph">
<p>A root entity reference, or what the JPQL specification calls a <em>range variable declaration</em>, is a direct reference to a mapped <code>@Entity</code> type by its entity name.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Remember, the <em>entity name</em> is the value of the <code>name</code> member of the <code>@Entity</code> annotation, or the unqualified Java class name by default.</p>
</div>
</td>
</tr>
</table>
</div>
<div id="root-reference-jpql-example" class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">select</span> <span class="n">book</span> <span class="k">from</span> <span class="n">Book</span> <span class="k">as</span> <span class="n">book</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In this example, <code>Book</code> is the entity name, and <code>book</code> is the identification variable.
The <code>as</code> keyword is optional.</p>
</div>
<div class="paragraph">
<p>Alternatively, a fully-qualified Java class name may be specified.
Then Hibernate will query every entity which inherits the named type.</p>
</div>
<div id="root-reference-jpql-fqn-example" class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">select</span> <span class="n">doc</span> <span class="k">from</span> <span class="n">org</span><span class="p">.</span><span class="n">hibernate</span><span class="p">.</span><span class="n">example</span><span class="p">.</span><span class="n">AbstractDocument</span> <span class="k">as</span> <span class="n">doc</span> <span class="k">where</span> <span class="n">doc</span><span class="p">.</span><span class="n">text</span> <span class="k">like</span> <span class="p">:</span><span class="n">pattern</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Of course, there may be multiple root entities.</p>
</div>
<div id="multiple-root-reference-jpql-example" class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">select</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span>
<span class="k">from</span> <span class="n">Author</span> <span class="n">a</span><span class="p">,</span> <span class="n">Author</span> <span class="n">b</span><span class="p">,</span> <span class="n">Book</span> <span class="n">book</span>
<span class="k">where</span> <span class="n">a</span> <span class="k">in</span> <span class="n">elements</span><span class="p">(</span><span class="n">book</span><span class="p">.</span><span class="n">authors</span><span class="p">)</span>
  <span class="k">and</span> <span class="n">b</span> <span class="k">in</span> <span class="n">elements</span><span class="p">(</span><span class="n">book</span><span class="p">.</span><span class="n">authors</span><span class="p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This query may even be written using the syntax <code>cross join</code> in place of the commas:</p>
</div>
<div id="cross-join-jpql-example" class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">select</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span>
<span class="k">from</span> <span class="n">Book</span> <span class="n">book</span>
    <span class="k">cross</span> <span class="k">join</span> <span class="n">Author</span> <span class="n">a</span>
    <span class="k">cross</span> <span class="k">join</span> <span class="n">Author</span> <span class="n">b</span>
<span class="k">where</span> <span class="n">a</span> <span class="k">in</span> <span class="n">elements</span><span class="p">(</span><span class="n">book</span><span class="p">.</span><span class="n">authors</span><span class="p">)</span>
  <span class="k">and</span> <span class="n">b</span> <span class="k">in</span> <span class="n">elements</span><span class="p">(</span><span class="n">book</span><span class="p">.</span><span class="n">authors</span><span class="p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Of course, it&#8217;s possible to write old-fashioned pre-ANSI-era joins:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">select</span> <span class="n">book</span><span class="p">.</span><span class="n">title</span><span class="p">,</span> <span class="n">publisher</span><span class="p">.</span><span class="n">name</span>
<span class="k">from</span> <span class="n">Book</span> <span class="n">book</span><span class="p">,</span> <span class="n">Publisher</span> <span class="n">publisher</span>
<span class="k">where</span> <span class="n">book</span><span class="p">.</span><span class="n">publisher</span> <span class="o">=</span> <span class="n">publisher</span>
  <span class="k">and</span> <span class="n">book</span><span class="p">.</span><span class="n">title</span> <span class="k">like</span> <span class="p">:</span><span class="n">titlePattern</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>But we never write HQL this way.</p>
</div>
</div>
<div class="sect3">
<h4 id="polymorphism">3.1.3. Polymorphism</h4>
<div class="paragraph">
<p>HQL and JPQL queries are inherently polymorphic.
Consider:</p>
</div>
<div id="polymorphism-example" class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">select</span> <span class="n">payment</span> <span class="k">from</span> <span class="n">Payment</span> <span class="k">as</span> <span class="n">payment</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This query names the <code>Payment</code> entity explicitly.
But the <code>CreditCardPayment</code> and <code>WireTransferPayment</code> entities inherit <code>Payment</code>, and so <code>payment</code> ranges over all three types.
Instances of all these entities are returned by the query.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The query <code>from java.lang.Object</code> is completely legal. (But not very useful!)</p>
</div>
<div class="paragraph">
<p>It returns every object of every mapped entity type.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="derived-root">3.1.4. Derived roots</h4>
<div class="paragraph">
<p>A <em>derived root</em> is an uncorrelated subquery which occurs in the <code>from</code> clause.</p>
</div>
<div id="derived-root-example" class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">select</span> <span class="n">id</span><span class="p">,</span> <span class="n">total</span>
<span class="k">from</span> <span class="p">(</span>
    <span class="k">select</span> <span class="n">ord</span><span class="p">.</span><span class="n">id</span> <span class="k">as</span> <span class="n">id</span><span class="p">,</span> <span class="k">sum</span><span class="p">(</span><span class="n">item</span><span class="p">.</span><span class="n">book</span><span class="p">.</span><span class="n">price</span> <span class="o">*</span> <span class="n">item</span><span class="p">.</span><span class="n">quantity</span><span class="p">)</span> <span class="k">as</span> <span class="n">total</span>
    <span class="k">from</span> <span class="k">Order</span> <span class="k">as</span> <span class="n">ord</span>
        <span class="k">join</span> <span class="n">Item</span> <span class="k">as</span> <span class="n">item</span>
    <span class="k">group</span> <span class="k">by</span> <span class="n">ord</span>
<span class="p">)</span>
<span class="k">where</span> <span class="n">total</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">.</span><span class="mi">0</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The derived root may declare an identification variable.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">select</span> <span class="n">stuff</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">stuff</span><span class="p">.</span><span class="n">total</span>
<span class="k">from</span> <span class="p">(</span>
    <span class="k">select</span> <span class="n">ord</span><span class="p">.</span><span class="n">id</span> <span class="k">as</span> <span class="n">id</span><span class="p">,</span> <span class="k">sum</span><span class="p">(</span><span class="n">item</span><span class="p">.</span><span class="n">book</span><span class="p">.</span><span class="n">price</span> <span class="o">*</span> <span class="n">item</span><span class="p">.</span><span class="n">quantity</span><span class="p">)</span> <span class="k">as</span> <span class="n">total</span>
    <span class="k">from</span> <span class="k">Order</span> <span class="k">as</span> <span class="n">ord</span>
        <span class="k">join</span> <span class="n">Item</span> <span class="k">as</span> <span class="n">item</span>
    <span class="k">group</span> <span class="k">by</span> <span class="n">ord</span>
<span class="p">)</span> <span class="k">as</span> <span class="n">stuff</span>
<span class="k">where</span> <span class="n">total</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">.</span><span class="mi">0</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This feature can be used to break a more complicated query into smaller pieces.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>We emphasize that a derived root must be an <em>uncorrelated</em> subquery.
It may not refer to other roots declared in the same <code>from</code> clause.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>A subquery may also occur in a <a href="#join-derived">join</a>, in which case it may be a correlated subquery.</p>
</div>
</div>
<div class="sect3">
<h4 id="from-cte">3.1.5. Common table expressions in <code>from</code> clause</h4>
<div class="paragraph">
<p>A <em>common table expression (CTE)</em> is like a derived root with a name.
We&#8217;ll discuss CTEs <a href="#with-cte">later</a>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="join">3.2. Declaring joined entities</h3>
<div class="paragraph">
<p>Joins allow us to navigate from one entity to another, via its associations, or via explicit join conditions.
There are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>explicit joins</em>, declared within the <code>from</code> clause using the keyword <code>join</code>, and</p>
</li>
<li>
<p><em>implicit joins</em>, which don&#8217;t need to be declared in the <code>from</code> clause.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>An explicit join may be either:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>an <em>inner join</em>, written as <code>join</code> or <code>inner join</code>,</p>
</li>
<li>
<p>a <em>left outer join</em>, written as <code>left join</code> or <code>left outer join</code>,</p>
</li>
<li>
<p>a <em>right outer join</em>, written as <code>right join</code> or <code>right outer join</code>, or</p>
</li>
<li>
<p>a <em>full outer join</em>, written as <code>full join</code> or <code>full outer join</code>.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="root-join">3.2.1. Explicit root joins</h4>
<div class="paragraph">
<p>An explicit root join works just like an ANSI-style join in SQL.</p>
</div>
<div id="explicit-root-join-example" class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">select</span> <span class="n">book</span><span class="p">.</span><span class="n">title</span><span class="p">,</span> <span class="n">publisher</span><span class="p">.</span><span class="n">name</span>
<span class="k">from</span> <span class="n">Book</span> <span class="n">book</span>
    <span class="k">join</span> <span class="n">Publisher</span> <span class="n">publisher</span>
        <span class="k">on</span> <span class="n">book</span><span class="p">.</span><span class="n">publisher</span> <span class="o">=</span> <span class="n">publisher</span>
<span class="k">where</span> <span class="n">book</span><span class="p">.</span><span class="n">title</span> <span class="k">like</span> <span class="p">:</span><span class="n">titlePattern</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The join condition is written out explicitly in the <code>on</code> clause.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This looks nice and familiar, but it&#8217;s <em>not</em> the most common sort of join in HQL or JPQL.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="explicit-join">3.2.2. Explicit association joins</h4>
<div class="paragraph">
<p>Every explicit association join specifies an entity attribute to be joined.
The specified attribute:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>is usually a <code>@OneToMany</code>, <code>@ManyToMany</code>, <code>@OneToOne</code>, or <code>@ManyToOne</code> association, but</p>
</li>
<li>
<p>it could be an <code>@ElementCollection</code>, and</p>
</li>
<li>
<p>it might even be an attribute of embeddable type.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In the case of an association or collection, the generated SQL will have a join of the same type.
(For a many-to-many association it will have <em>two</em> joins.)
In the case of an embedded attribute, the join is purely logical and does not result in a join in the generated SQL.</p>
</div>
<div class="paragraph">
<p>An explicit join may assign an identification variable to the joined entity.</p>
</div>
<div id="explicit-inner-join-example" class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">from</span> <span class="n">Book</span> <span class="k">as</span> <span class="n">book</span>
    <span class="k">join</span> <span class="n">book</span><span class="p">.</span><span class="n">publisher</span> <span class="k">as</span> <span class="n">publisher</span>
    <span class="k">join</span> <span class="n">book</span><span class="p">.</span><span class="n">authors</span> <span class="k">as</span> <span class="n">author</span>
<span class="k">where</span> <span class="n">book</span><span class="p">.</span><span class="n">title</span> <span class="k">like</span> <span class="p">:</span><span class="n">titlePattern</span>
<span class="k">select</span> <span class="n">book</span><span class="p">.</span><span class="n">title</span><span class="p">,</span> <span class="n">author</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">publisher</span><span class="p">.</span><span class="n">name</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>For an outer join, we must write our query to accommodate the possibility that the joined association is missing.</p>
</div>
<div id="explicit-outer-join-example" class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">from</span> <span class="n">Book</span> <span class="k">as</span> <span class="n">book</span>
    <span class="k">left</span> <span class="k">join</span> <span class="n">book</span><span class="p">.</span><span class="n">publisher</span> <span class="k">as</span> <span class="n">publisher</span>
    <span class="k">join</span> <span class="n">book</span><span class="p">.</span><span class="n">authors</span> <span class="k">as</span> <span class="n">author</span>
<span class="k">where</span> <span class="n">book</span><span class="p">.</span><span class="n">title</span> <span class="k">like</span> <span class="p">:</span><span class="n">titlePattern</span>
<span class="k">select</span> <span class="n">book</span><span class="p">.</span><span class="n">title</span><span class="p">,</span> <span class="n">author</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">ifnull</span><span class="p">(</span><span class="n">publisher</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">'-'</span><span class="p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>For further information about collection-valued association references, see <a href="#collection-valued-associations">Joining collections and many-valued associations</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="explicit-join-conditions">3.2.3. Explicit association joins with join conditions</h4>
<div class="paragraph">
<p>The <code>with</code> or <code>on</code> clause allows explicit qualification of the join conditions.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The specified join conditions are <em>added</em> to the join conditions specified by the foreign key association.
That&#8217;s why, historically, HQL uses the keword <code>with</code> here:
"with" emphasizes that the new condition doesn&#8217;t <em>replace</em> the original join conditions.</p>
</div>
<div class="paragraph">
<p>The <code>with</code> keyword is specific to Hibernate. JPQL uses <code>on</code>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Join conditions occurring in the <code>with</code> or <code>on</code> clause are added to the <code>on</code> clause in the generated SQL.</p>
</div>
<div id="explicit-join-with-example" class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">from</span> <span class="n">Book</span> <span class="k">as</span> <span class="n">book</span>
    <span class="k">left</span> <span class="k">join</span> <span class="n">book</span><span class="p">.</span><span class="n">publisher</span> <span class="k">as</span> <span class="n">publisher</span>
        <span class="k">with</span> <span class="n">publisher</span><span class="p">.</span><span class="n">closureDate</span> <span class="k">is</span> <span class="k">not</span> <span class="k">null</span>
    <span class="k">left</span> <span class="k">join</span> <span class="n">book</span><span class="p">.</span><span class="n">authors</span> <span class="k">as</span> <span class="n">author</span>
        <span class="k">with</span> <span class="n">author</span><span class="p">.</span><span class="n">type</span> <span class="o">&lt;&gt;</span> <span class="n">COLLABORATION</span>
<span class="k">where</span> <span class="n">book</span><span class="p">.</span><span class="n">title</span> <span class="k">like</span> <span class="p">:</span><span class="n">titlePattern</span>
<span class="k">select</span> <span class="n">book</span><span class="p">.</span><span class="n">title</span><span class="p">,</span> <span class="n">author</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">publisher</span><span class="p">.</span><span class="n">name</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="explicit-fetch-join">3.2.4. Association fetching</h4>
<div class="paragraph">
<p>A <em>fetch join</em>  overrides the laziness of a given association, specifying that the association should be fetched with a SQL join.
The join may be an inner or outer join.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A <code>join fetch</code>, or, more explicitly, <code>inner join fetch</code>, only returns base entities with an associated entity.</p>
</li>
<li>
<p>A <code>left join fetch</code>, orâ€”for lovers of verbosityâ€”<code>left outer join fetch</code>, returns all the base entities, including those which have no associated joined entity.</p>
</li>
</ul>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This is one of the most important features of Hibernate.
To achieve acceptable performance with HQL, you&#8217;ll need to use <code>join fetch</code> quite often.
Without it, you&#8217;ll quickly run into the dreaded "n+1 selects" problem.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For example, if <code>Person</code> has a one-to-many association named <code>phones</code>, the use of <code>join fetch</code> in the following query specifies that the collection elements should be fetched in the same SQL query:</p>
</div>
<div id="explicit-fetch-join-example" class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">select</span> <span class="n">book</span>
<span class="k">from</span> <span class="n">Book</span> <span class="k">as</span> <span class="n">book</span>
    <span class="k">left</span> <span class="k">join</span> <span class="k">fetch</span> <span class="n">book</span><span class="p">.</span><span class="n">publisher</span>
    <span class="k">join</span> <span class="k">fetch</span> <span class="n">book</span><span class="p">.</span><span class="n">authors</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In this example, we used a left outer join for <code>book.publisher</code> because we also wanted to obtain books with no publisher, but a regular inner join for <code>book.authors</code> because every book has at least one author.</p>
</div>
<div class="paragraph">
<p>A query may have more than one fetch join, but be aware that:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>it&#8217;s perfectly safe to fetch several to-one associations in series or parallel in a single query, and</p>
</li>
<li>
<p>a single series of <em>nested</em> fetch joins is also fine, but</p>
</li>
<li>
<p>fetching multiple collections or to-many associations in <em>parallel</em> results in a Cartesian product at the database level, and might exhibit very poor performance.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>HQL doesn&#8217;t disallow it, but it&#8217;s usually a bad idea to apply a restriction to a <code>join fetch</code>ed entity, since the elements of the fetched collection would be incomplete.
Indeed, it&#8217;s best to avoid even assigning an identification variable to a fetched joined entity except for the purpose of specifying a nested fetch join.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Fetch joins should usually be avoided in limited or paged queries.
This includes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>queries executed with limits specified via the <code>setFirstResult()</code> and <code>setMaxResults()</code> methods of <code>Query</code>, or</p>
</li>
<li>
<p>queries with a limit or offset declared in HQL, described below in <a href="#limit-offset">Limits and offsets</a>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Nor should they be used with the <code>scroll()</code> and <code>stream()</code> methods of the <code>Query</code> interface.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Fetch joins are disallowed in subqueries, where they would make no sense.</p>
</div>
</div>
<div class="sect3">
<h4 id="join-treat">3.2.5. Joins with typecasts</h4>
<div class="paragraph">
<p>An explicit join may narrow the type of the joined entity using <code>treat()</code>.</p>
</div>
<div id="join-treat-example" class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">from</span> <span class="k">Order</span> <span class="k">as</span> <span class="n">ord</span>
    <span class="k">join</span> <span class="n">treat</span><span class="p">(</span><span class="n">ord</span><span class="p">.</span><span class="n">payments</span> <span class="k">as</span> <span class="n">CreditCardPayment</span><span class="p">)</span> <span class="k">as</span> <span class="n">creditCardPayment</span>
<span class="k">where</span> <span class="k">length</span><span class="p">(</span><span class="n">creditCardPayment</span><span class="p">.</span><span class="n">cardNumber</span><span class="p">)</span> <span class="k">between</span> <span class="mi">16</span> <span class="k">and</span> <span class="mi">20</span>
<span class="k">select</span> <span class="n">ord</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">creditCardPayment</span><span class="p">.</span><span class="n">cardNumber</span><span class="p">,</span> <span class="n">creditCardPayment</span><span class="p">.</span><span class="n">amount</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here, the identification variable <code>ccp</code> declared to the right of <code>treat()</code> has the narrowed type <code>CreditCardPayment</code>, instead of the declared type <code>Payment</code>.
This allows the attribute <code>cardNumber</code> declared by the subtype <code>CreditCardPayment</code> to be referenced in the rest of the query.</p>
</div>
<div class="paragraph">
<p>See <a href="#functions-typecasts">Types and typecasts</a> for more information about <code>treat()</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="join-derived">3.2.6. Subqueries in joins</h4>
<div class="paragraph">
<p>A <code>join</code> clause may contain a subquery, either:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>an uncorrelated subquery, which is almost the same as a <a href="#derived-root">derived root</a>, except that it may have an <code>on</code> restriction, or</p>
</li>
<li>
<p>a <em>lateral join</em>, which is a correlated subquery, and may refer to other roots declared earlier in the same <code>from</code> clause.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The <code>lateral</code> keyword just distinguishes the two cases.</p>
</div>
<div id="derived-join-example" class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">from</span> <span class="n">Phone</span> <span class="k">as</span> <span class="n">phone</span>
    <span class="k">left</span> <span class="k">join</span> <span class="p">(</span>
        <span class="k">select</span> <span class="n">call</span><span class="p">.</span><span class="n">duration</span> <span class="k">as</span> <span class="n">duration</span><span class="p">,</span> <span class="n">call</span><span class="p">.</span><span class="n">phone</span><span class="p">.</span><span class="n">id</span> <span class="k">as</span> <span class="n">cid</span>
        <span class="k">from</span> <span class="n">Call</span> <span class="k">as</span> <span class="n">call</span>
        <span class="k">order</span> <span class="k">by</span> <span class="n">call</span><span class="p">.</span><span class="n">duration</span> <span class="k">desc</span>
        <span class="k">limit</span> <span class="mi">1</span>
    <span class="p">)</span> <span class="k">as</span> <span class="n">longest</span> <span class="k">on</span> <span class="n">cid</span> <span class="o">=</span> <span class="n">phone</span><span class="p">.</span><span class="n">id</span>
<span class="k">where</span> <span class="n">phone</span><span class="p">.</span><span class="n">number</span> <span class="o">=</span> <span class="p">:</span><span class="n">phoneNumber</span>
<span class="k">select</span> <span class="n">longest</span><span class="p">.</span><span class="n">duration</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This query may also be expressed using a <code>lateral</code> join:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">from</span> <span class="n">Phone</span> <span class="k">as</span> <span class="n">phone</span>
    <span class="k">left</span> <span class="k">join</span> <span class="k">lateral</span> <span class="p">(</span>
       <span class="k">select</span> <span class="n">call</span><span class="p">.</span><span class="n">duration</span> <span class="k">as</span> <span class="n">duration</span>
       <span class="k">from</span> <span class="n">phone</span><span class="p">.</span><span class="n">calls</span> <span class="k">as</span> <span class="n">call</span>
       <span class="k">order</span> <span class="k">by</span> <span class="n">call</span><span class="p">.</span><span class="n">duration</span> <span class="k">desc</span>
       <span class="k">limit</span> <span class="mi">1</span>
    <span class="p">)</span> <span class="k">as</span> <span class="n">longest</span>
<span class="k">where</span> <span class="n">phone</span><span class="p">.</span><span class="n">number</span> <span class="o">=</span> <span class="p">:</span><span class="n">phoneNumber</span>
<span class="k">select</span> <span class="n">longest</span><span class="p">.</span><span class="n">duration</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>A lateral join may be an inner or left outer join, but not a right join, nor a full join.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Traditional SQL doesn&#8217;t allow correlated subqueries in the <code>from</code> clause.
A lateral join is essentially just that, but with a different syntax to what you might expect.</p>
</div>
<div class="paragraph">
<p>On some databases, <code>join lateral</code> is written <code>cross apply</code>.
And on Postgres it&#8217;s plain <code>lateral</code>, without <code>join</code>.</p>
</div>
<div class="paragraph">
<p>It&#8217;s almost as if they&#8217;re <em>deliberately trying</em> to confuse us.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Lateral joins are particularly useful for computing top-N elements of multiple groups.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Most databases support some flavor of <code>join lateral</code>, and Hibernate emulates the feature for databases which don&#8217;t.
But emulation is neither very efficient, nor does it support all possible query shapes, so it&#8217;s important to test on your target database.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="implicit-join">3.2.7. Implicit association joins (path expressions)</h4>
<div class="paragraph">
<p>It&#8217;s not necessary to explicitly <code>join</code> every entity that occurs in a query.
Instead, entity associations may be <em>navigated</em>, just like in Java:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>if an attribute is of embedded type, or is a to-one association, it may be further navigated, but</p>
</li>
<li>
<p>if an attribute is of basic type, it is considered terminal, and may not be further navigated, and</p>
</li>
<li>
<p>if an attribute is collection-valued, or is a to-many association, it may be navigated, but only with the help of <code>value()</code>, <code>element()</code>, or <code>key()</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>It&#8217;s clear that:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A path expression like <code>author.name</code> with only two elements just refers to state held directly by an entity with an alias <code>author</code> defined in <code>from</code> or <code>join</code>.</p>
</li>
<li>
<p>But a longer path expression, for example, <code>author.person.name</code>, might refer to state held by an associated entity.
(Alternatively, it might refer to state held by an embedded class.)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In the second case, Hibernate with automatically add a join to the generated SQL if necessary.</p>
</div>
<div id="implicit-join-example" class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">from</span> <span class="n">Book</span> <span class="k">as</span> <span class="n">book</span>
<span class="k">where</span> <span class="n">book</span><span class="p">.</span><span class="n">publisher</span><span class="p">.</span><span class="n">name</span> <span class="k">like</span> <span class="p">:</span><span class="n">pubName</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As in this example, implicit joins usually appear outside the <code>from</code> clause of the HQL query.
However, they always affect the <code>from</code> clause of the SQL query.</p>
</div>
<div class="paragraph">
<p>The example above is equivalent to:</p>
</div>
<div id="implicit-join-alt" class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">select</span> <span class="n">book</span>
<span class="k">from</span> <span class="n">Book</span> <span class="k">as</span> <span class="n">book</span>
    <span class="k">join</span> <span class="n">book</span><span class="p">.</span><span class="n">publisher</span> <span class="k">as</span> <span class="n">pub</span>
<span class="k">where</span> <span class="n">pub</span><span class="p">.</span><span class="n">name</span> <span class="k">like</span> <span class="p">:</span><span class="n">pubName</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Implicit joins are always treated as inner joins.</p>
</li>
<li>
<p>Multiple occurrences of the same implicit join always refer to the same SQL join.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This query:</p>
</div>
<div id="implicit-join-alias-example" class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">select</span> <span class="n">book</span>
<span class="k">from</span> <span class="n">Book</span> <span class="k">as</span> <span class="n">book</span>
<span class="k">where</span> <span class="n">book</span><span class="p">.</span><span class="n">publisher</span><span class="p">.</span><span class="n">name</span> <span class="k">like</span> <span class="p">:</span><span class="n">pubName</span>
  <span class="k">and</span> <span class="n">book</span><span class="p">.</span><span class="n">publisher</span><span class="p">.</span><span class="n">closureDate</span> <span class="k">is</span> <span class="k">null</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>results in just one SQL join, and is just a different way to write:</p>
</div>
<div id="implicit-join-alias-alt" class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">select</span> <span class="n">book</span>
<span class="k">from</span> <span class="n">Book</span> <span class="k">as</span> <span class="n">book</span>
    <span class="k">join</span> <span class="n">book</span><span class="p">.</span><span class="n">publisher</span> <span class="k">as</span> <span class="n">pub</span>
<span class="k">where</span> <span class="n">pub</span><span class="p">.</span><span class="n">name</span> <span class="k">like</span> <span class="p">:</span><span class="n">pubName</span>
  <span class="k">and</span> <span class="n">pub</span><span class="p">.</span><span class="n">closureDate</span> <span class="k">is</span> <span class="k">null</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="collection-valued-associations">3.2.8. Joining collections and many-valued associations</h4>
<div class="paragraph">
<p>When a join involves a collection or many-valued association, the declared identification variable refers to the <em>elements</em> of the collection, that is:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>to the elements of a <code>Set</code>,</p>
</li>
<li>
<p>to the elements of a <code>List</code>, not to their indices in the list, or</p>
</li>
<li>
<p>to the values of a <code>Map</code>, not to their keys.</p>
</li>
</ul>
</div>
<div id="collection-valued-associations-example" class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">select</span> <span class="n">publisher</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">author</span><span class="p">.</span><span class="n">name</span>
<span class="k">from</span> <span class="n">Publisher</span> <span class="k">as</span> <span class="n">publisher</span>
    <span class="k">join</span> <span class="n">publisher</span><span class="p">.</span><span class="n">books</span> <span class="k">as</span> <span class="n">book</span>
    <span class="k">join</span> <span class="n">book</span><span class="p">.</span><span class="n">authors</span> <span class="n">author</span>
<span class="k">where</span> <span class="n">author</span><span class="p">.</span><span class="n">name</span> <span class="k">like</span> <span class="p">:</span><span class="n">namePattern</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In this example, the identification variable <code>author</code> is of type <code>Author</code>, the element type of the list <code>Book.authors</code>.
But if we need to refer to the index of an <code>Author</code> in the list, we need some extra syntax.</p>
</div>
<div class="paragraph">
<p>You might recall that we mentioned <a href="#list-functions">List indexes</a> and <a href="#map-functions">Map keys and values</a> a bit earlier.
These functions may be applied to the identification variable declared in a collection join or many-valued association join.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 12%;">
<col style="width: 20%;">
<col>
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Function</th>
<th class="tableblock halign-left valign-top">Applies to</th>
<th class="tableblock halign-left valign-top">Interpretation</th>
<th class="tableblock halign-left valign-top">Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>value()</code> or <code>element()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Any collection</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The collection element or map entry value</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Often optional.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>index()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Any <code>List</code> with an index column</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The index of the element in the list</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">For backward compatibility, it&#8217;s also an alternative to <code>key()</code>, when applied to a map.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>key()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Any <code>Map</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The key of the entry in the list</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If the key is of entity type, it may be further navigated.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>entry()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Any <code>Map</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The map entry, that is, the <code>Map.Entry</code> of key and value.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Only legal as a terminal path, and only allowed in the <code>select</code> clause.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>In particular, <code>index()</code> and <code>key()</code> obtain a reference to a list index or map key.</p>
</div>
<div id="collection-qualification-example" class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">select</span> <span class="n">book</span><span class="p">.</span><span class="n">title</span><span class="p">,</span> <span class="n">author</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="k">index</span><span class="p">(</span><span class="n">author</span><span class="p">)</span>
<span class="k">from</span> <span class="n">Book</span> <span class="k">as</span> <span class="n">book</span>
    <span class="k">join</span> <span class="n">book</span><span class="p">.</span><span class="n">authors</span> <span class="k">as</span> <span class="n">author</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">select</span> <span class="n">publisher</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">leadAuthor</span><span class="p">.</span><span class="n">name</span>
<span class="k">from</span> <span class="n">Publisher</span> <span class="k">as</span> <span class="n">publisher</span>
    <span class="k">join</span> <span class="n">publisher</span><span class="p">.</span><span class="n">books</span> <span class="k">as</span> <span class="n">book</span>
    <span class="k">join</span> <span class="n">book</span><span class="p">.</span><span class="n">authors</span> <span class="n">leadAuthor</span>
<span class="k">where</span> <span class="n">leadAuthor</span><span class="p">.</span><span class="n">name</span> <span class="k">like</span> <span class="p">:</span><span class="n">namePattern</span>
  <span class="k">and</span> <span class="k">index</span><span class="p">(</span><span class="n">leadAuthor</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="implicit-collection-join">3.2.9. Implicit joins involving collections</h4>
<div class="paragraph">
<p>A path expression like <code>book.authors.name</code> is not considered legal.
We can&#8217;t just navigate a many-valued association with this syntax.</p>
</div>
<div class="paragraph">
<p>Instead, the functions <code>element()</code>, <code>index()</code>, <code>key()</code>, and <code>value()</code> may be applied to a path expression to express an implicit join.
So we must write <code>element(book.authors).name</code> or <code>index(book.authors)</code>.</p>
</div>
<div id="collection-implicit-join-example" class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">select</span> <span class="n">book</span><span class="p">.</span><span class="n">title</span><span class="p">,</span> <span class="n">element</span><span class="p">(</span><span class="n">book</span><span class="p">.</span><span class="n">authors</span><span class="p">).</span><span class="n">name</span><span class="p">,</span> <span class="k">index</span><span class="p">(</span><span class="n">book</span><span class="p">.</span><span class="n">authors</span><span class="p">)</span>
<span class="k">from</span> <span class="n">Book</span> <span class="n">book</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>An element of an indexed collection (an array, list, or map) may even be identified using the index operator:</p>
</div>
<div id="collection-index-operator-example" class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">select</span> <span class="n">publisher</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">book</span><span class="p">.</span><span class="n">authors</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">name</span>
<span class="k">from</span> <span class="n">Publisher</span> <span class="k">as</span> <span class="n">publisher</span>
    <span class="k">join</span> <span class="n">publisher</span><span class="p">.</span><span class="n">books</span> <span class="k">as</span> <span class="n">book</span>
<span class="k">where</span> <span class="n">book</span><span class="p">.</span><span class="n">authors</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">name</span> <span class="k">like</span> <span class="p">:</span><span class="n">namePattern</span></code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="selection-projection-aggregation">4. Selection, projection, and aggregation</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Joining is one kind of <em>relational operation</em>.
It&#8217;s an operation that produces relations (tables) from other relations.
Such operations, taken together, form the <em>relational algebra</em>.</p>
</div>
<div class="paragraph">
<p>We must now understand the rest of this family: restriction a.k.a. selection, projection, aggregation, union/intersection, and, finally, ordering and limiting, operations which are not strictly part of the calculus of relations, but which usually come along for the ride because they&#8217;re very <em>useful</em>.</p>
</div>
<div class="paragraph">
<p>We&#8217;ll start with the operation that&#8217;s easiest to understand.</p>
</div>
<div class="sect2">
<h3 id="where-clause">4.1. Restriction</h3>
<div class="paragraph">
<p>The <code>where</code> clause restricts the results returned by a <code>select</code> query or limits the scope of an <code>update</code> or <code>delete</code> query.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This operation is usually called <em>selection</em>, but since that term is often confused with the <code>select</code> keyword, and since both projection and selection involve "selecting" things, here we&#8217;ll use the less-ambiguous term <em>restriction</em>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>A restriction is nothing more than a single logical expression, a topic we exhausted above in <a href="#conditional-expressions">Predicates</a>.
Therefore, we&#8217;ll move quickly onto the next, and more interesting, operation.</p>
</div>
</div>
<div class="sect2">
<h3 id="aggregation">4.2. Aggregation</h3>
<div class="paragraph">
<p>An aggregate query is one with <a href="#aggregate-functions">aggregate functions</a> in its projection list.
It collapses multiple rows into a single row.
Aggregate queries are used for summarizing and analysing data.</p>
</div>
<div class="paragraph">
<p>An aggregate query might have a <code>group by</code> clause.
The <code>group by</code> clause divides the result set into groups, so that a query with aggregate functions in the select list returns not a single result for the whole query, but one result for each group.
If an aggregate query <em>doesn&#8217;t</em> have a <code>group by</code> clause, it always produces a single row of results.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
In short, <em>grouping</em> controls the effect of <em>aggregation</em>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>A query with aggregation may also have a <code>having</code> clause, a restriction applied to the groups.</p>
</div>
<div class="sect3">
<h4 id="group-by">4.2.1. Aggregation and grouping</h4>
<div class="paragraph">
<p>The <code>group by</code> clause looks quite similar to the <code>select</code> clauseâ€”it has a list of grouped items, but:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>if there&#8217;s just one item, then the query will have a single result for each unique value of that item, or</p>
</li>
<li>
<p>if there are multiple items, the query will have a result for each unique <em>combination</em> or their values.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The BNF for a grouped item is just:</p>
</div>
<div id="group-by-item-bnf" class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="antlrv4">identifier | INTEGER_LITERAL | expression</code></pre>
</div>
</div>
<div class="paragraph">
<p>Consider the following queries:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">select</span> <span class="n">book</span><span class="p">.</span><span class="n">isbn</span><span class="p">,</span>
    <span class="k">sum</span><span class="p">(</span><span class="n">quantity</span><span class="p">)</span> <span class="k">as</span> <span class="n">totalSold</span><span class="p">,</span>
    <span class="k">sum</span><span class="p">(</span><span class="n">quantity</span> <span class="o">*</span> <span class="n">book</span><span class="p">.</span><span class="n">price</span><span class="p">)</span> <span class="k">as</span> <span class="n">totalBilled</span>
<span class="k">from</span> <span class="n">Item</span>
<span class="k">where</span> <span class="n">book</span><span class="p">.</span><span class="n">isbn</span> <span class="o">=</span> <span class="p">:</span><span class="n">isbn</span></code></pre>
</div>
</div>
<div id="group-by-example" class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">select</span> <span class="n">book</span><span class="p">.</span><span class="n">isbn</span><span class="p">,</span>
    <span class="k">year</span><span class="p">(</span><span class="k">order</span><span class="p">.</span><span class="k">dateTime</span><span class="p">)</span> <span class="k">as</span> <span class="k">year</span><span class="p">,</span>
    <span class="k">sum</span><span class="p">(</span><span class="n">quantity</span><span class="p">)</span> <span class="k">as</span> <span class="n">yearlyTotalSold</span><span class="p">,</span>
    <span class="k">sum</span><span class="p">(</span><span class="n">quantity</span> <span class="o">*</span> <span class="n">book</span><span class="p">.</span><span class="n">price</span><span class="p">)</span> <span class="k">as</span> <span class="n">yearlyTotalBilled</span>
<span class="k">from</span> <span class="n">Item</span>
<span class="k">where</span> <span class="n">book</span><span class="p">.</span><span class="n">isbn</span> <span class="o">=</span> <span class="p">:</span><span class="n">isbn</span>
<span class="k">group</span> <span class="k">by</span> <span class="k">year</span><span class="p">(</span><span class="k">order</span><span class="p">.</span><span class="k">dateTime</span><span class="p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The first query calculates complete totals over all orders in years.
The second calculates totals for each year, after grouping the orders by year.</p>
</div>
</div>
<div class="sect3">
<h4 id="group-by-rollup-cube">4.2.2. Totals and subtotals</h4>
<div class="paragraph">
<p>The special functions <code>rollup()</code> and <code>cube()</code> may be used in the <code>group by</code> clause, when supported by the database.
The semantics are identical to SQL.</p>
</div>
<div class="paragraph">
<p>These functions are especially useful for reporting.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A <code>group by</code> clause with <code>rollup()</code> is used to produce subtotals and grand totals.</p>
</li>
<li>
<p>A <code>group by</code> clause with <code>cube()</code> allows totals for every combination of columns.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="having">4.2.3. Aggregation and restriction</h4>
<div class="paragraph">
<p>In a grouped query, the <code>where</code> clause applies to the non-aggregated values (it determines which rows will make it into the aggregation).
The <code>having</code> clause also restricts results, but it operates on the aggregated values.</p>
</div>
<div class="paragraph">
<p>In an <a href="#group-by-example">example above</a>, we calculated totals for every year for which data was available.
But our dataset might extend far back into the past, perhaps even as far back as those terrible dark ages before Hibernate 2.0.
So let&#8217;s restrict our result set to data from our own more civilized times:</p>
</div>
<div id="group-by-having-example" class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">select</span> <span class="n">book</span><span class="p">.</span><span class="n">isbn</span><span class="p">,</span>
    <span class="k">year</span><span class="p">(</span><span class="k">order</span><span class="p">.</span><span class="k">dateTime</span><span class="p">)</span> <span class="k">as</span> <span class="k">year</span><span class="p">,</span>
    <span class="k">sum</span><span class="p">(</span><span class="n">quantity</span><span class="p">)</span> <span class="k">as</span> <span class="n">yearlyTotalSold</span><span class="p">,</span>
    <span class="k">sum</span><span class="p">(</span><span class="n">quantity</span> <span class="o">*</span> <span class="n">book</span><span class="p">.</span><span class="n">price</span><span class="p">)</span> <span class="k">as</span> <span class="n">yearlyTotalBilled</span>
<span class="k">from</span> <span class="n">Item</span>
<span class="k">where</span> <span class="n">book</span><span class="p">.</span><span class="n">isbn</span> <span class="o">=</span> <span class="p">:</span><span class="n">isbn</span>
<span class="k">group</span> <span class="k">by</span> <span class="k">year</span><span class="p">(</span><span class="k">order</span><span class="p">.</span><span class="k">dateTime</span><span class="p">)</span>
<span class="k">having</span> <span class="k">year</span><span class="p">(</span><span class="k">order</span><span class="p">.</span><span class="k">dateTime</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2003</span>
   <span class="k">and</span> <span class="k">sum</span><span class="p">(</span><span class="n">quantity</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>having</code> clause follows the same rules as the <code>where</code> clause and is also just a logical predicate.
The <code>having</code> restriction is applied after grouping and aggregation has already been performed, whereas the <code>where</code> clause is applied before the data is grouped or aggregated.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="select-clause">4.3. Projection</h3>
<div class="paragraph">
<p>The <code>select</code> list identifies which objects and values to return as the query results.
This operation is called <em>projection</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="antlrv4">selectClause
    : "SELECT" "DISTINCT"? selection (","" selection)*</code></pre>
</div>
</div>
<div class="paragraph">
<p>Any of the expression types discussed in <a href="#expressions">Expressions</a> may occur in the projection list, unless otherwise noted.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If a query has no explicit <code>select</code> list, then, as we saw <a href="#select-simplest-example">much earlier</a>, the projection is inferred from the entities and joins occurring in the <code>from</code> clause, together with the result type specified by the call to <code>createQuery()</code>.
But it&#8217;s better to specify the projection explicitly, except in the simplest cases.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="distinct">4.3.1. Duplicate removal</h4>
<div class="paragraph">
<p>The <code>distinct</code> keyword helps remove duplicate results from the query result list.
It&#8217;s only effect is to add <code>distinct</code> to the generated SQL.</p>
</div>
<div id="distinct-projection-query-example" class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">select</span> <span class="k">distinct</span> <span class="n">lastName</span> <span class="k">from</span> <span class="n">Person</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">select</span> <span class="k">distinct</span> <span class="n">author</span>
<span class="k">from</span> <span class="n">Publisher</span> <span class="k">as</span> <span class="n">pub</span>
    <span class="k">join</span> <span class="n">pub</span><span class="p">.</span><span class="n">books</span> <span class="k">as</span> <span class="n">book</span>
    <span class="k">join</span> <span class="n">book</span><span class="p">.</span><span class="n">authors</span> <span class="k">as</span> <span class="n">author</span>
<span class="k">where</span> <span class="n">pub</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="p">:</span><span class="n">pid</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>As of Hibernate 6, duplicate results arising from the use of <code>join fetch</code> are automatically removed by Hibernate in memory, <em>after</em> reading the database results and materializing entity instances as Java objects.
It&#8217;s no longer necessary to remove duplicate results explicitly, and, in particular, <code>distinct</code> should not be used for this purpose.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="aggregate-functions">4.3.2. Aggregate functions</h4>
<div class="paragraph">
<p>It&#8217;s common to have aggregate functions like <code>count()</code>, <code>sum()</code>, and <code>max()</code> in a select list.
Aggregate functions are special functions that reduce the size of the result set.</p>
</div>
<div class="paragraph">
<p>The standard aggregate functions defined in both ANSI SQL and JPQL are these ones:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 30%;">
<col>
<col>
<col style="width: 15%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Aggregate function</th>
<th class="tableblock halign-left valign-top">Argument type</th>
<th class="tableblock halign-left valign-top">Result type</th>
<th class="tableblock halign-center valign-top">JPA standard / ANSI SQL standard</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>count()</code>, including <code>count(distinct)</code>, <code>count(all)</code>, and <code>count(*)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Any</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Long</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">âœ”/âœ”</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>avg()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Any numeric type</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Double</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">âœ”/âœ”</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>min()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Any numeric type, or string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Same as the argument type</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">âœ”/âœ”</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>max()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Any numeric type, or string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Same as the argument type</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">âœ”/âœ”</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>sum()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Any numeric type</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">See table below</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">âœ”/âœ”</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>var_pop()</code>, <code>var_samp()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Any numeric type</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Double</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">âœ–/âœ”</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>stddev_pop()</code>, <code>stddev_samp()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Any numeric type</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Double</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">âœ–/âœ”</p></td>
</tr>
</tbody>
</table>
<div id="aggregate-functions-example" class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">select</span> <span class="k">count</span><span class="p">(</span><span class="k">distinct</span> <span class="n">item</span><span class="p">.</span><span class="n">book</span><span class="p">)</span>
<span class="k">from</span> <span class="n">Item</span> <span class="k">as</span> <span class="n">item</span>
<span class="k">where</span> <span class="k">year</span><span class="p">(</span><span class="n">item</span><span class="p">.</span><span class="k">order</span><span class="p">.</span><span class="k">dateTime</span><span class="p">)</span> <span class="o">=</span> <span class="p">:</span><span class="k">year</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">select</span> <span class="k">sum</span><span class="p">(</span><span class="n">item</span><span class="p">.</span><span class="n">quantity</span><span class="p">)</span> <span class="k">as</span> <span class="n">totalSales</span>
<span class="k">from</span> <span class="n">Item</span> <span class="k">as</span> <span class="n">item</span>
<span class="k">where</span> <span class="n">item</span><span class="p">.</span><span class="n">book</span><span class="p">.</span><span class="n">isbn</span> <span class="o">=</span> <span class="p">:</span><span class="n">isbn</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">select</span>
    <span class="k">year</span><span class="p">(</span><span class="n">item</span><span class="p">.</span><span class="k">order</span><span class="p">.</span><span class="k">dateTime</span><span class="p">)</span> <span class="k">as</span> <span class="k">year</span><span class="p">,</span>
    <span class="k">sum</span><span class="p">(</span><span class="n">item</span><span class="p">.</span><span class="n">quantity</span><span class="p">)</span> <span class="k">as</span> <span class="n">yearlyTotal</span>
<span class="k">from</span> <span class="n">Item</span> <span class="k">as</span> <span class="n">item</span>
<span class="k">where</span> <span class="n">item</span><span class="p">.</span><span class="n">book</span><span class="p">.</span><span class="n">isbn</span> <span class="o">=</span> <span class="p">:</span><span class="n">isbn</span>
<span class="k">group</span> <span class="k">by</span> <span class="k">year</span><span class="p">(</span><span class="n">item</span><span class="p">.</span><span class="k">order</span><span class="p">.</span><span class="k">dateTime</span><span class="p">)</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">select</span>
    <span class="k">month</span><span class="p">(</span><span class="n">item</span><span class="p">.</span><span class="k">order</span><span class="p">.</span><span class="k">dateTime</span><span class="p">)</span> <span class="k">as</span> <span class="k">month</span><span class="p">,</span>
    <span class="k">avg</span><span class="p">(</span><span class="n">item</span><span class="p">.</span><span class="n">quantity</span><span class="p">)</span> <span class="k">as</span> <span class="n">monthlyAverage</span>
<span class="k">from</span> <span class="n">Item</span> <span class="k">as</span> <span class="n">item</span>
<span class="k">where</span> <span class="n">item</span><span class="p">.</span><span class="n">book</span><span class="p">.</span><span class="n">isbn</span> <span class="o">=</span> <span class="p">:</span><span class="n">isbn</span>
<span class="k">group</span> <span class="k">by</span> <span class="k">month</span><span class="p">(</span><span class="n">item</span><span class="p">.</span><span class="k">order</span><span class="p">.</span><span class="k">dateTime</span><span class="p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In the case of <code>sum()</code>, the rules for assigning a result type are:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Argument type</th>
<th class="tableblock halign-left valign-top">Result type</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Any integral numeric type except <code>BigInteger</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Long</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Any floating point numeric type</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Double</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>BigInteger</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>BigInteger</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>BigDecimal</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>BigDecimal</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>HQL defines two additional aggregate functions which accept a logical predicate as an argument.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 30%;">
<col>
<col>
<col style="width: 15%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Aggregate function</th>
<th class="tableblock halign-left valign-top">Argument type</th>
<th class="tableblock halign-left valign-top">Result type</th>
<th class="tableblock halign-center valign-top">JPA standard</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>any()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Logical predicate</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Boolean</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">âœ–</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>every()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Logical predicate</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Boolean</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">âœ–</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>We may write, for example, <code>every(p.amount &lt; 1000.0)</code>.</p>
</div>
<div class="paragraph">
<p>Below, we&#8217;ll meet the <a href="#aggregate-functions-orderedset">ordered set aggregate functions</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Aggregate functions usually appear in the <code>select</code> clause, but control over aggregation is the responsibility of the <code>group by</code> clause, as described <a href="#group-by">below</a>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="aggregate-functions-collections">4.3.3. Aggregate functions and collections</h4>
<div class="paragraph">
<p>The <code>elements()</code> and <code>indices()</code> functions we met <a href="#elements-indices">earlier</a> let us apply aggregate functions to a collection:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 18%;">
<col style="width: 15%;">
<col>
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">New syntax</th>
<th class="tableblock halign-left valign-top">Legacy HQL function ðŸ’€</th>
<th class="tableblock halign-left valign-top">Applies to</th>
<th class="tableblock halign-left valign-top">Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>max(elements(x))</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>maxelement(x)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Any collection with sortable elements</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The maximum element or map value</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>min(elements(x))</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>minelement(x)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Any collection with sortable elements</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The minimum element or map value</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>sum(elements(x))</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">â€”</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Any collection with numeric elements</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The sum of the elements or map values</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>avg(elements(x))</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">â€”</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Any collection with numeric elements</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The average of the elements or map values</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>max(indices(x))</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>maxindex(x)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Indexed collections (lists and maps)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The maximum list index or map key</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>min(indices(x))</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>minindex(x)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Indexed collections (lists and maps)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The minimum list index or map key</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>sum(indices(x))</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">â€”</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Indexed collections (lists and maps)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The sum of the list indexes or map keys</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>avg(indices(x))</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">â€”</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Indexed collections (lists and maps)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The average of the list indexes or map keys</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>These operations are mostly useful when working with <code>@ElementCollection</code>s.</p>
</div>
<div id="collection-expressions-example" class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">select</span> <span class="n">title</span><span class="p">,</span> <span class="k">max</span><span class="p">(</span><span class="n">indices</span><span class="p">(</span><span class="n">authors</span><span class="p">))</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="k">max</span><span class="p">(</span><span class="n">elements</span><span class="p">(</span><span class="n">editions</span><span class="p">))</span> <span class="k">from</span> <span class="n">Book</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="aggregate-functions-filter">4.3.4. Aggregate functions with restriction</h4>
<div class="paragraph">
<p>All aggregate functions support the inclusion of a <em>filter clause</em>, a sort of mini-<code>where</code> applying a restriction to just one item of the select list:</p>
</div>
<div id="aggregate-functions-filter-example" class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">select</span>
    <span class="k">year</span><span class="p">(</span><span class="n">item</span><span class="p">.</span><span class="k">order</span><span class="p">.</span><span class="k">dateTime</span><span class="p">)</span> <span class="k">as</span> <span class="k">year</span><span class="p">,</span>
    <span class="k">sum</span><span class="p">(</span><span class="n">item</span><span class="p">.</span><span class="n">quantity</span><span class="p">)</span> <span class="n">filter</span> <span class="p">(</span><span class="k">where</span> <span class="k">not</span> <span class="n">item</span><span class="p">.</span><span class="k">order</span><span class="p">.</span><span class="n">fulfilled</span><span class="p">)</span> <span class="k">as</span> <span class="n">unfulfilled</span><span class="p">,</span>
    <span class="k">sum</span><span class="p">(</span><span class="n">item</span><span class="p">.</span><span class="n">quantity</span><span class="p">)</span> <span class="n">filter</span> <span class="p">(</span><span class="k">where</span> <span class="n">item</span><span class="p">.</span><span class="k">order</span><span class="p">.</span><span class="n">fulfilled</span><span class="p">)</span> <span class="k">as</span> <span class="n">fulfilled</span><span class="p">,</span>
    <span class="k">sum</span><span class="p">(</span><span class="n">item</span><span class="p">.</span><span class="n">quantity</span> <span class="o">*</span> <span class="n">item</span><span class="p">.</span><span class="n">book</span><span class="p">.</span><span class="n">price</span><span class="p">)</span> <span class="n">filter</span> <span class="p">(</span><span class="k">where</span> <span class="n">item</span><span class="p">.</span><span class="k">order</span><span class="p">.</span><span class="n">paid</span><span class="p">)</span>
<span class="k">from</span> <span class="n">Item</span> <span class="k">as</span> <span class="n">item</span>
<span class="k">where</span> <span class="n">item</span><span class="p">.</span><span class="n">book</span><span class="p">.</span><span class="n">isbn</span> <span class="o">=</span> <span class="p">:</span><span class="n">isbn</span>
<span class="k">group</span> <span class="k">by</span> <span class="k">year</span><span class="p">(</span><span class="n">item</span><span class="p">.</span><span class="k">order</span><span class="p">.</span><span class="k">dateTime</span><span class="p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The BNF for the <code>filter</code> clause is simple:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="antlrv4">filterClause
	: "FILTER" "(" "WHERE" predicate ")"</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="aggregate-functions-orderedset">4.3.5. Ordered set aggregate functions</h4>
<div class="paragraph">
<p>An <em>ordered set aggregate function</em> is a special aggregate function which has:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>not only an optional filter clause, as above, but also</p>
</li>
<li>
<p>a <code>within group</code> clause containing a mini-<code>order by</code> specification.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The BNF for <code>within group</code> is straightforward:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="antlrv4">withinGroupClause
	: "WITHIN" "GROUP" "(" "ORDER" "BY" sortSpecification ("," sortSpecification)* ")"</code></pre>
</div>
</div>
<div class="paragraph">
<p>There are two main types of ordered set aggregate function:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>an <em>inverse distribution function</em> calculates a value that characterizes the distribution of values within the group, for example, <code>percentile_cont(0.5)</code> is the median, and <code>percentile_cont(0.25)</code> is the lower quartile.</p>
</li>
<li>
<p>a <em>hypothetical set function</em> determines the position of a "hypothetical" value within the ordered set of values.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The following ordered set aggregate functions are available on many platforms:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 30%;">
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Functions</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Inverse distribution functions</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>mode()</code>, <code>percentile_cont()</code>, <code>percentile_disc()</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Hypothetical set functions</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>rank()</code>, <code>dense_rank()</code>, <code>percent_rank()</code>, <code>cume_dist()</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Other</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>listagg()</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>This query calculates the median price of a book:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">select</span> <span class="n">percentile_cont</span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">within</span> <span class="k">group</span> <span class="p">(</span><span class="k">order</span> <span class="k">by</span> <span class="n">price</span><span class="p">)</span>
<span class="k">from</span> <span class="n">Book</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This query finds the percentage of books with prices less than 10 dollars:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">select</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">percent_rank</span><span class="p">(</span><span class="mi">10</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">within</span> <span class="k">group</span> <span class="p">(</span><span class="k">order</span> <span class="k">by</span> <span class="n">price</span><span class="p">)</span>
<span class="k">from</span> <span class="n">Book</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Actually, the most widely-supported ordered set aggregate function is one which builds a string by concatenating the values within a group.
This function has different names on different databases, but HQL abstracts these differences, andâ€”following ANSI SQLâ€”calls it <code>listagg()</code>.</p>
</div>
<div id="aggregate-functions-within-group-example" class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">select</span> <span class="n">listagg</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="s1">', '</span><span class="p">)</span>
    <span class="n">within</span> <span class="k">group</span> <span class="p">(</span><span class="k">order</span> <span class="k">by</span> <span class="n">isbn</span><span class="p">)</span>
<span class="k">from</span> <span class="n">Book</span>
<span class="k">group</span> <span class="k">by</span> <span class="n">element</span><span class="p">(</span><span class="n">authors</span><span class="p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This very useful function produces a string by concatenation of the aggregated values of its argument.</p>
</div>
</div>
<div class="sect3">
<h4 id="aggregate-functions-window">4.3.6. Window functions</h4>
<div class="paragraph">
<p>A <em>window function</em> is one which also has an <code>over</code> clause, for example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">select</span>
    <span class="n">item</span><span class="p">.</span><span class="k">order</span><span class="p">.</span><span class="k">dateTime</span><span class="p">,</span>
    <span class="k">sum</span><span class="p">(</span><span class="n">item</span><span class="p">.</span><span class="n">quantity</span><span class="p">)</span>
        <span class="k">over</span> <span class="p">(</span><span class="k">order</span> <span class="k">by</span> <span class="n">item</span><span class="p">.</span><span class="k">order</span><span class="p">.</span><span class="k">dateTime</span><span class="p">)</span>
        <span class="k">as</span> <span class="n">runningTotal</span>
<span class="k">from</span> <span class="n">Item</span> <span class="n">item</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This query returns a running total of sales over time.
That is, the <code>sum()</code> is taken over a window comprising the current row of the result set, together with all previous rows.</p>
</div>
<div class="paragraph">
<p>A window function application may optionally specify any of the following clauses:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 23%;">
<col style="width: 18%;">
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Optional clause</th>
<th class="tableblock halign-left valign-top">Keyword</th>
<th class="tableblock halign-left valign-top">Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Partitioning</em> of the result set</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>partition by</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Very similar to <code>group by</code>, but doesn&#8217;t collapse each partition to a single row</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Ordering</em> of the partition</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>order by</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies the order of rows within a partition</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Windowing</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>range</code>, <code>rows</code>, or <code>groups</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Defines the bounds of a window frame within a partition</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Restriction</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>filter</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">As aggregate functions, window functions may optionally specify a filter</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>For example, we may partition the running total by book:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">select</span>
    <span class="n">item</span><span class="p">.</span><span class="n">book</span><span class="p">.</span><span class="n">isbn</span><span class="p">,</span>
    <span class="n">item</span><span class="p">.</span><span class="k">order</span><span class="p">.</span><span class="k">dateTime</span><span class="p">,</span>
    <span class="k">sum</span><span class="p">(</span><span class="n">item</span><span class="p">.</span><span class="n">quantity</span><span class="p">)</span>
        <span class="k">over</span> <span class="p">(</span><span class="k">partition</span> <span class="k">by</span> <span class="n">item</span><span class="p">.</span><span class="n">book</span>
              <span class="k">order</span> <span class="k">by</span> <span class="n">item</span><span class="p">.</span><span class="k">order</span><span class="p">.</span><span class="k">dateTime</span><span class="p">)</span>
        <span class="k">as</span> <span class="n">runningTotal</span>
<span class="k">from</span> <span class="n">Item</span> <span class="n">item</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Every partition runs in isolation, that is, rows can&#8217;t leak across partitions.</p>
</div>
<div class="paragraph">
<p>The full syntax for window function application is amazingly involved, as shown by this BNF:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="antlrv4">overClause
	: "OVER" "(" partitionClause? orderByClause? frameClause? ")"

partitionClause
	: "PARTITION" "BY" expression ("," expression)*

frameClause
	: ("RANGE"|"ROWS"|"GROUPS") frameStart frameExclusion?
	| ("RANGE"|"ROWS"|"GROUPS") "BETWEEN" frameStart "AND" frameEnd frameExclusion?

frameStart
	: "CURRENT" "ROW"
	| "UNBOUNDED" "PRECEDING"
	| expression "PRECEDING"
	| expression "FOLLOWING"

frameEnd
	: "CURRENT" "ROW"
	| "UNBOUNDED" "FOLLOWING"
	| expression "PRECEDING"
	| expression "FOLLOWING"

frameExclusion
	: "EXCLUDE" "CURRENT" "ROW"
	| "EXCLUDE" "GROUP"
	| "EXCLUDE" "TIES"
	| "EXCLUDE" "NO" "OTHERS"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Window functions are similar to aggregate functions in the sense that they compute some value based on a "frame" comprising multiple rows.
But unlike aggregate functions, window functions don&#8217;t flatten rows within a window frame.</p>
</div>
<h5 id="_window_frames" class="discrete">Window frames</h5>
<div class="paragraph">
<p>The <em>window frame</em> is the set of rows within a given partition that is passed to the window function.
There&#8217;s a different window frame for each row of the result set.
In our example, the window frame comprised all the preceding rows within the partition, that is, all the rows with the same <code>item.book</code> and with an earlier <code>item.order.dateTime</code>.</p>
</div>
<div class="paragraph">
<p>The boundary of the window frame is controlled via the windowing clause, which may specify one of the following modes:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 8%;">
<col style="width: 40%;">
<col style="width: 20%;">
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Mode</th>
<th class="tableblock halign-left valign-top">Definition</th>
<th class="tableblock halign-left valign-top">Example</th>
<th class="tableblock halign-left valign-top">Interpretation</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>rows</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Frame bounds defined by a given number of rows</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>rows 5 preceding</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The previous 5 rows in the partition</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>groups</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Frame bounds defined by a given number of <em>peer groups</em>, rows belonging to the same peer group if they are assigned the same position by <code>order by</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>groups 5 preceding</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The rows in the previous 5 peer groups in the partition</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>range</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Frame bounds defined by a maximum difference in <em>value</em> of the expression used to <code>order by</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>range between 1.0 preceding and 1.0 following</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The rows whose <code>order by</code> expression differs by a maximum absolute value of <code>1.0</code> from the current row</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The frame exclusion clause allows excluding rows around the current row:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Option</th>
<th class="tableblock halign-left valign-top">Interpretation</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>exclude current row</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Excludes the current row</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>exclude group</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Excludes rows of the peer group of the current row</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>exclude ties</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Excludes rows of the peer group of the current row except the current row</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>exclude no others</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The default, does not exclude anything</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>By default, the window frame is defined as <code>rows between unbounded preceding and current row exclude no others</code>, meaning every row up to and including the current row.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The modes <code>range</code> and <code>groups</code>, along with frame exclusion modes, are not available on every database.</p>
</div>
</td>
</tr>
</table>
</div>
<h5 id="_widely_supported_window_functions" class="discrete">Widely supported window functions</h5>
<div class="paragraph">
<p>The following window functions are available on all major platforms:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 15%;">
<col>
<col style="width: 30%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Window function</th>
<th class="tableblock halign-left valign-top">Purpose</th>
<th class="tableblock halign-left valign-top">Signature</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>row_number()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The position of the current row within its frame</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>row_number()</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>lead()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The value of a subsequent row in the frame</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>lead(x)</code>, <code>lead(x, i, x)</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>lag()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The value of a previous row in the frame</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>lag(x)</code>, <code>lag(x, i, x)</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>first_value()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The value of a first row in the frame</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>first_value(x)</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>last_value()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The value of a last row in the frame</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>last_value(x)</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>nth_value()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The value of the `n`th row in the frame</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>nth_value(x, n)</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>In principle every aggregate or ordered set aggregate function might also be used as a window function, just by specifying <code>over</code>, but not every function is supported on every database.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Window functions and ordered set aggregate functions aren&#8217;t available on every database.
Even where they are available, support for particular features varies widely between databases.
Therefore, we won&#8217;t waste time going into further detail here.
For more information about the syntax and semantics of these functions, consult the documentation for your dialect of SQL.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="set-operators">4.4. Operations on result sets</h3>
<div class="paragraph">
<p>These operators apply not to expressions, but to entire result sets:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>union</code> and <code>union all</code>,</p>
</li>
<li>
<p><code>intersect</code> and <code>intersect all</code>, and</p>
</li>
<li>
<p><code>except</code> and <code>except all</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Just like in SQL, <code>all</code> suppresses the elimination of duplicate results.</p>
</div>
<div id="union-example" class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">select</span> <span class="n">nomDePlume</span> <span class="k">from</span> <span class="n">Author</span> <span class="k">where</span> <span class="n">nomDePlume</span> <span class="k">is</span> <span class="k">not</span> <span class="k">null</span>
<span class="k">union</span>
<span class="k">select</span> <span class="n">name</span> <span class="k">from</span> <span class="n">Person</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="order-by">4.5. Sorting</h3>
<div class="paragraph">
<p>By default, the results of the query are returned in an arbitrary order.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Imposing an order on a set is called <em>sorting</em>.</p>
</div>
<div class="paragraph">
<p>A relation (a database table) is a set, and therefore certain particularly dogmatic purists have argued that sorting has no place in the algebra of relations.
We think this is more than a bit silly: practical data analysis almost always involves sorting, which is a perfectly well-defined operation.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <code>order by</code> clause specifies a list of projected items used to sort the results.
Each sorted item may be:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>an attribute of an entity or embeddable class,</p>
</li>
<li>
<p>a more complex <a href="#expressions">expression</a>,</p>
</li>
<li>
<p>the alias of a projected item declared in the select list, or</p>
</li>
<li>
<p>a literal integer indicating the ordinal position of a projected item in the select list.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Of course, in principle, only certain types may be sorted: numeric types, string, and date and time types.
But HQL is very permissive here and will allow an expression of almost any type to occur in a sort list.
Even the identification variable of an entity with a sortable identifier type may occur as a sorted item.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The JPQL specification requires that every sorted item in the <code>order by</code> clause also occur in the <code>select</code> clause.
HQL does not enforce this restriction, but applications desiring database portability should be aware that some databases <em>do</em>.</p>
</div>
<div class="paragraph">
<p>Therefore, you might wish to avoid the use of complex expressions in the sort list.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The BNF for a sorted item is:</p>
</div>
<div id="order-by-item-bnf" class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="antlrv4">sortExpression sortDirection? nullsPrecedence?

sortExpression
    : identifier | INTEGER_LITERAL | expression

sortDirection
    : "ASC" | "DESC"

nullsPrecedence
    : "NULLS" ("FIRST" | "LAST")</code></pre>
</div>
</div>
<div class="paragraph">
<p>Each sorted item listed in the <code>order by</code> clause may explicitly specify a direction, either:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>asc</code> for ascending order, or</p>
</li>
<li>
<p><code>desc</code> for descending order.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If no direction is explicitly specified, the results are returned in ascending order.</p>
</div>
<div class="paragraph">
<p>Of course, there&#8217;s an ambiguity with respect to null values.
Therefore, the sorting of null values may be explicitly specified:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Precedence</th>
<th class="tableblock halign-left valign-top">Interpretation</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>nulls first</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Puts null values at the beginning of the result set</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>nulls last</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Puts them at the end</p></td>
</tr>
</tbody>
</table>
<div id="order-by-example" class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">select</span> <span class="n">title</span><span class="p">,</span> <span class="n">publisher</span><span class="p">.</span><span class="n">name</span>
<span class="k">from</span> <span class="n">Book</span>
<span class="k">order</span> <span class="k">by</span> <span class="n">title</span><span class="p">,</span> <span class="n">publisher</span><span class="p">.</span><span class="n">name</span> <span class="k">nulls</span> <span class="k">last</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">select</span> <span class="n">book</span><span class="p">.</span><span class="n">isbn</span><span class="p">,</span>
    <span class="k">year</span><span class="p">(</span><span class="k">order</span><span class="p">.</span><span class="k">dateTime</span><span class="p">)</span> <span class="k">as</span> <span class="k">year</span><span class="p">,</span>
    <span class="k">sum</span><span class="p">(</span><span class="n">quantity</span><span class="p">)</span> <span class="k">as</span> <span class="n">yearlyTotalSold</span><span class="p">,</span>
    <span class="k">sum</span><span class="p">(</span><span class="n">quantity</span> <span class="o">*</span> <span class="n">book</span><span class="p">.</span><span class="n">price</span><span class="p">)</span> <span class="k">as</span> <span class="n">yearlyTotalBilled</span>
<span class="k">from</span> <span class="n">Item</span>
<span class="k">where</span> <span class="n">book</span><span class="p">.</span><span class="n">isbn</span> <span class="o">=</span> <span class="p">:</span><span class="n">isbn</span>
<span class="k">group</span> <span class="k">by</span> <span class="k">year</span><span class="p">(</span><span class="k">order</span><span class="p">.</span><span class="k">dateTime</span><span class="p">)</span>
<span class="k">having</span> <span class="k">year</span><span class="p">(</span><span class="k">order</span><span class="p">.</span><span class="k">dateTime</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2000</span>
   <span class="k">and</span> <span class="k">sum</span><span class="p">(</span><span class="n">quantity</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
<span class="k">order</span> <span class="k">by</span> <span class="n">yearlyTotalSold</span> <span class="k">desc</span><span class="p">,</span> <span class="k">year</span> <span class="k">desc</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Queries with an ordered result list may have limits or pagination.</p>
</div>
<div class="sect3">
<h4 id="limit-offset">4.5.1. Limits and offsets</h4>
<div class="paragraph">
<p>It&#8217;s often useful to place a hard upper limit on the number of results that may be returned by a query.
The <code>limit</code> and <code>offset</code> clauses are an alternative to the use of <code>setMaxResults()</code> and <code>setFirstResult()</code> respectively,
and may similarly be used for pagination.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If the <code>limit</code> or <code>offset</code> is parameterized, it&#8217;s much easier to use <code>setMaxResults()</code> or <code>setFirstResult()</code>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The SQL <code>fetch</code> syntax is supported as an alternative:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 45%;">
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Short form</th>
<th class="tableblock halign-left valign-top">Verbose form</th>
<th class="tableblock halign-left valign-top">Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>limit 10</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>fetch first 10 rows only</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Limit result set</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>limit 10 offset 20</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>offset 20 rows fetch next 10 rows only</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Paginate result set</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The BNF gets a bit complicated:</p>
</div>
<div id="limit-offset-bnf" class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="antlrv4">limitClause
    : "LIMIT" parameterOrIntegerLiteral

offsetClause
    : "OFFSET" parameterOrIntegerLiteral ("ROW" | "ROWS")?

fetchClause
    : "FETCH" ("FIRST" | "NEXT")
      (parameterOrIntegerLiteral | parameterOrNumberLiteral "%")
      ("ROW" | "ROWS")
      ("ONLY" | "WITH" "TIES")</code></pre>
</div>
</div>
<div class="paragraph">
<p>These two queries are identical:</p>
</div>
<div id="limit-example" class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">select</span> <span class="n">title</span> <span class="k">from</span> <span class="n">Book</span>
<span class="k">order</span> <span class="k">by</span> <span class="n">title</span><span class="p">,</span> <span class="n">published</span> <span class="k">desc</span>
<span class="k">limit</span> <span class="mi">50</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">select</span> <span class="n">title</span> <span class="k">from</span> <span class="n">Book</span>
<span class="k">order</span> <span class="k">by</span> <span class="n">title</span><span class="p">,</span> <span class="n">published</span> <span class="k">desc</span>
<span class="k">fetch</span> <span class="k">first</span> <span class="mi">50</span> <span class="k">rows</span> <span class="k">only</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>These are well-defined limits: the number of results returned by the database will be limited to 50, as promised.
But not every query is quite so well-behaved.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p><em>Limiting</em> certainly <em>isn&#8217;t</em> a well-defined relational operation, and must be used with care.</p>
</div>
<div class="paragraph">
<p>In particular, limits don&#8217;t play well with <a href="#explicit-fetch-join">fetch joins</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This next query is accepted by HQL, and no more than 50 results are returned by <code>getResultList()</code>, just as expected:</p>
</div>
<div id="bad-limit-example" class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">select</span> <span class="n">title</span> <span class="k">from</span> <span class="n">Book</span>
    <span class="k">join</span> <span class="k">fetch</span> <span class="n">authors</span>
<span class="k">order</span> <span class="k">by</span> <span class="n">title</span><span class="p">,</span> <span class="n">published</span> <span class="k">desc</span>
<span class="k">limit</span> <span class="mi">50</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>However, if you log the SQL executed by Hibernate, you&#8217;ll notice something wrong:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sql"><span class="k">select</span>
    <span class="n">b1_0</span><span class="p">.</span><span class="n">isbn</span><span class="p">,</span>
    <span class="n">a1_0</span><span class="p">.</span><span class="n">books_isbn</span><span class="p">,</span>
    <span class="n">a1_0</span><span class="p">.</span><span class="n">authors_ORDER</span><span class="p">,</span>
    <span class="n">a1_1</span><span class="p">.</span><span class="n">id</span><span class="p">,</span>
    <span class="n">a1_1</span><span class="p">.</span><span class="n">bio</span><span class="p">,</span>
    <span class="n">a1_1</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
    <span class="n">a1_1</span><span class="p">.</span><span class="n">person_id</span><span class="p">,</span>
    <span class="n">b1_0</span><span class="p">.</span><span class="n">price</span><span class="p">,</span>
    <span class="n">b1_0</span><span class="p">.</span><span class="n">published</span><span class="p">,</span>
    <span class="n">b1_0</span><span class="p">.</span><span class="n">publisher_id</span><span class="p">,</span>
    <span class="n">b1_0</span><span class="p">.</span><span class="n">title</span>
<span class="k">from</span>
    <span class="n">Book</span> <span class="n">b1_0</span>
<span class="k">join</span>
    <span class="p">(</span><span class="n">Book_Author</span> <span class="n">a1_0</span>
        <span class="k">join</span>
            <span class="n">Author</span> <span class="n">a1_1</span>
                <span class="k">on</span> <span class="n">a1_1</span><span class="p">.</span><span class="n">id</span><span class="o">=</span><span class="n">a1_0</span><span class="p">.</span><span class="n">authors_id</span><span class="p">)</span>
        <span class="k">on</span> <span class="n">b1_0</span><span class="p">.</span><span class="n">isbn</span><span class="o">=</span><span class="n">a1_0</span><span class="p">.</span><span class="n">books_isbn</span>
<span class="k">order</span> <span class="k">by</span>
    <span class="n">b1_0</span><span class="p">.</span><span class="n">title</span><span class="p">,</span>
    <span class="n">b1_0</span><span class="p">.</span><span class="n">published</span> <span class="k">desc</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>What happened to the <code>limit</code> clause?</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>When limits or pagination are combined with a fetch join, Hibernate must retrieve all matching results from the database and <em>apply the limit in memory</em>!</p>
</div>
<div class="paragraph">
<p>This <em>almost certainly</em> isn&#8217;t the behavior you were hoping for, and in general will exhibit <em>terrible</em> performance characteristics.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="with-cte">4.6. Common table expressions</h3>
<div class="paragraph">
<p>A <em>common table expression</em> or CTE may be thought of as a sort of named subquery.
Any query with an uncorrelated subquery can in principle be rewritten so that the subquery occurs in the <code>with</code> clause.</p>
</div>
<div class="paragraph">
<p>But CTEs have capabilities that subqueries don&#8217;t have.
The <code>with</code> clause lets us:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>specify materialization hints, and</p>
</li>
<li>
<p>write recursive queries.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>On databases which don&#8217;t support CTEs natively, Hibernate attempts to rewrite any HQL query with CTEs as a SQL query with subqueries.
This is impossible for recursive queries, unfortunately.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s take a quick look at the BNF:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="antlrv4">withClause
	: "WITH" cte ("," cte)*

cte
	: identifier AS ("NOT"? "MATERIALIZED")? "(" queryExpression ")"
      searchClause? cycleClause?</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>with</code> clause comes right at the start of a query.
It may declare multiple CTEs with different names.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">with</span>
    <span class="n">paid</span> <span class="k">as</span> <span class="p">(</span>
        <span class="k">select</span> <span class="n">ord</span><span class="p">.</span><span class="n">id</span> <span class="k">as</span> <span class="n">oid</span><span class="p">,</span> <span class="k">sum</span><span class="p">(</span><span class="n">payment</span><span class="p">.</span><span class="n">amount</span><span class="p">)</span> <span class="k">as</span> <span class="n">amountPaid</span>
        <span class="k">from</span> <span class="k">Order</span> <span class="k">as</span> <span class="n">ord</span>
            <span class="k">left</span> <span class="k">join</span> <span class="n">ord</span><span class="p">.</span><span class="n">payments</span> <span class="k">as</span> <span class="n">payment</span>
        <span class="k">group</span> <span class="k">by</span> <span class="n">ord</span>
        <span class="k">having</span> <span class="k">local</span> <span class="k">datetime</span> <span class="o">-</span> <span class="n">ord</span><span class="p">.</span><span class="k">dateTime</span> <span class="o">&lt;</span> <span class="mi">365</span> <span class="k">day</span>
    <span class="p">),</span>
    <span class="n">owed</span> <span class="k">as</span> <span class="p">(</span>
        <span class="k">select</span> <span class="n">ord</span><span class="p">.</span><span class="n">id</span> <span class="k">as</span> <span class="n">oid</span><span class="p">,</span> <span class="k">sum</span><span class="p">(</span><span class="n">item</span><span class="p">.</span><span class="n">quantity</span><span class="o">*</span><span class="n">item</span><span class="p">.</span><span class="n">book</span><span class="p">.</span><span class="n">price</span><span class="p">)</span> <span class="k">as</span> <span class="n">amountOwed</span>
        <span class="k">from</span> <span class="k">Order</span> <span class="k">as</span> <span class="n">ord</span>
            <span class="k">left</span> <span class="k">join</span> <span class="n">ord</span><span class="p">.</span><span class="k">items</span> <span class="k">as</span> <span class="n">item</span>
        <span class="k">group</span> <span class="k">by</span> <span class="n">ord</span>
        <span class="k">having</span> <span class="k">local</span> <span class="k">datetime</span> <span class="o">-</span> <span class="n">ord</span><span class="p">.</span><span class="k">dateTime</span> <span class="o">&lt;</span> <span class="mi">365</span> <span class="k">day</span>
    <span class="p">)</span>
<span class="k">select</span> <span class="n">id</span><span class="p">,</span> <span class="n">paid</span><span class="p">.</span><span class="n">amountPaid</span><span class="p">,</span> <span class="n">owed</span><span class="p">.</span><span class="n">amountOwed</span>
<span class="k">from</span> <span class="k">Order</span>
<span class="k">where</span> <span class="n">paid</span><span class="p">.</span><span class="n">amountPaid</span> <span class="o">&lt;</span> <span class="n">owed</span><span class="p">.</span><span class="n">amountOwed</span>
  <span class="k">and</span> <span class="n">paid</span><span class="p">.</span><span class="n">oid</span> <span class="o">=</span> <span class="n">id</span> <span class="k">and</span> <span class="n">owed</span><span class="p">.</span><span class="n">oid</span> <span class="o">=</span> <span class="n">id</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice that if we rewrote this query using subqueries, it would look quite a lot clumsier.</p>
</div>
<div class="sect3">
<h4 id="materialization-hints">4.6.1. Materialization hints</h4>
<div class="paragraph">
<p>The <code>materialized</code> keyword is a hint to the database that the subquery should be separately executed and its results stored in a temporary table.</p>
</div>
<div class="paragraph">
<p>On the other hand, its nemesis, <code>not materialized</code>, is a hint that the subquery should be inlined at each use site, with each usage optimized independently.</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The precise impact of materialization hints is quite platform-dependant.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Our example query from above hardly changes.
We just add <code>materialized</code> to the CTE declarations.</p>
</div>
<div id="cte-materialized-example" class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">with</span>
    <span class="n">paid</span> <span class="k">as</span> <span class="k">materialized</span> <span class="p">(</span>
        <span class="k">select</span> <span class="n">ord</span><span class="p">.</span><span class="n">id</span> <span class="k">as</span> <span class="n">oid</span><span class="p">,</span> <span class="k">sum</span><span class="p">(</span><span class="n">payment</span><span class="p">.</span><span class="n">amount</span><span class="p">)</span> <span class="k">as</span> <span class="n">amountPaid</span>
        <span class="k">from</span> <span class="k">Order</span> <span class="k">as</span> <span class="n">ord</span>
            <span class="k">left</span> <span class="k">join</span> <span class="n">ord</span><span class="p">.</span><span class="n">payments</span> <span class="k">as</span> <span class="n">payment</span>
        <span class="k">group</span> <span class="k">by</span> <span class="n">ord</span>
        <span class="k">having</span> <span class="k">local</span> <span class="k">datetime</span> <span class="o">-</span> <span class="n">ord</span><span class="p">.</span><span class="k">dateTime</span> <span class="o">&lt;</span> <span class="mi">365</span> <span class="k">day</span>
    <span class="p">),</span>
    <span class="n">owed</span> <span class="k">as</span> <span class="k">materialized</span> <span class="p">(</span>
        <span class="k">select</span> <span class="n">ord</span><span class="p">.</span><span class="n">id</span> <span class="k">as</span> <span class="n">oid</span><span class="p">,</span> <span class="k">sum</span><span class="p">(</span><span class="n">item</span><span class="p">.</span><span class="n">quantity</span><span class="o">*</span><span class="n">item</span><span class="p">.</span><span class="n">book</span><span class="p">.</span><span class="n">price</span><span class="p">)</span> <span class="k">as</span> <span class="n">amountOwed</span>
        <span class="k">from</span> <span class="k">Order</span> <span class="k">as</span> <span class="n">ord</span>
            <span class="k">left</span> <span class="k">join</span> <span class="n">ord</span><span class="p">.</span><span class="k">items</span> <span class="k">as</span> <span class="n">item</span>
        <span class="k">group</span> <span class="k">by</span> <span class="n">ord</span>
        <span class="k">having</span> <span class="k">local</span> <span class="k">datetime</span> <span class="o">-</span> <span class="n">ord</span><span class="p">.</span><span class="k">dateTime</span> <span class="o">&lt;</span> <span class="mi">365</span> <span class="k">day</span>
    <span class="p">)</span>
<span class="k">select</span> <span class="n">id</span><span class="p">,</span> <span class="n">paid</span><span class="p">.</span><span class="n">amountPaid</span><span class="p">,</span> <span class="n">owed</span><span class="p">.</span><span class="n">amountOwed</span>
<span class="k">from</span> <span class="k">Order</span>
<span class="k">where</span> <span class="n">paid</span><span class="p">.</span><span class="n">amountPaid</span> <span class="o">&lt;</span> <span class="n">owed</span><span class="p">.</span><span class="n">amountOwed</span>
  <span class="k">and</span> <span class="n">paid</span><span class="p">.</span><span class="n">oid</span> <span class="o">=</span> <span class="n">id</span> <span class="k">and</span> <span class="n">owed</span><span class="p">.</span><span class="n">oid</span> <span class="o">=</span> <span class="n">id</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="recursive-queries">4.6.2. Recursive queries</h4>
<div class="paragraph">
<p>A <em>recursive query</em> is one where the CTE is defined self-referentially.
Recursive queries follow a very particular pattern.
The CTE is defined as a union of:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>a base subquery returning an initial set of rows where the recursion begins,</p>
</li>
<li>
<p>a recursively-executed subquery which returns additional rows by joining against the CTE itself.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Let&#8217;s demonstrate this with an example.</p>
</div>
<div class="paragraph">
<p>First we&#8217;ll need some sort of tree-like entity:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Entity</span>
<span class="kd">class</span> <span class="nc">Node</span> <span class="o">{</span>
	<span class="nd">@Id</span> <span class="nc">Long</span> <span class="n">id</span><span class="o">;</span>
	<span class="nc">String</span> <span class="n">text</span><span class="o">;</span>
	<span class="nd">@ManyToOne</span> <span class="nc">Node</span> <span class="n">parent</span><span class="o">;</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We may obtain a tree of <code>Node</code>s with the following recursive query:</p>
</div>
<div id="cte-recursive-example" class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">with</span> <span class="n">Tree</span> <span class="k">as</span> <span class="p">(</span>
    <span class="cm">/* base query */</span>
    <span class="k">select</span> <span class="n">root</span><span class="p">.</span><span class="n">id</span> <span class="k">as</span> <span class="n">id</span><span class="p">,</span> <span class="n">root</span><span class="p">.</span><span class="n">text</span> <span class="k">as</span> <span class="n">text</span><span class="p">,</span> <span class="mi">0</span> <span class="k">as</span> <span class="k">level</span>
        <span class="k">from</span> <span class="n">Node</span> <span class="n">root</span>
        <span class="k">where</span> <span class="n">root</span><span class="p">.</span><span class="n">parent</span> <span class="k">is</span> <span class="k">null</span>
    <span class="k">union</span> <span class="k">all</span>
    <span class="cm">/* recursion */</span>
    <span class="k">select</span> <span class="n">child</span><span class="p">.</span><span class="n">id</span> <span class="k">as</span> <span class="n">id</span><span class="p">,</span> <span class="n">child</span><span class="p">.</span><span class="n">text</span> <span class="k">as</span> <span class="n">text</span><span class="p">,</span> <span class="k">level</span><span class="o">+</span><span class="mi">1</span> <span class="k">as</span> <span class="k">level</span>
        <span class="k">from</span> <span class="n">Tree</span> <span class="n">parent</span>
        <span class="k">join</span> <span class="n">Node</span> <span class="n">child</span> <span class="k">on</span> <span class="n">child</span><span class="p">.</span><span class="n">parent</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">parent</span><span class="p">.</span><span class="n">id</span>
<span class="p">)</span>
<span class="k">select</span> <span class="n">text</span><span class="p">,</span> <span class="k">level</span>
<span class="k">from</span> <span class="n">Tree</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>When querying a tree-like of data structure, the base subquery usually returns the root node or nodes.
The recursively-executed subquery returns the children of the current set of nodes.
It&#8217;s executed repeatedly with the results of the previous execution.
Recursion terminates when the recursively-executed subquery returns no new nodes.</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Hibernate cannot emulate recursive queries on databases which don&#8217;t support them natively.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now, if a graph contains cycles, that is, if it isn&#8217;t a tree, the recursion might never terminate.</p>
</div>
</div>
<div class="sect3">
<h4 id="_cycle_detection">4.6.3. Cycle detection</h4>
<div class="paragraph">
<p>The <code>cycle</code> clause enables cycle detection, and aborts the recursion if a node is encountered twice.</p>
</div>
<div id="cte-cycle-example" class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">with</span> <span class="n">Tree</span> <span class="k">as</span> <span class="p">(</span>
    <span class="cm">/* base query */</span>
    <span class="k">select</span> <span class="n">root</span><span class="p">.</span><span class="n">id</span> <span class="k">as</span> <span class="n">id</span><span class="p">,</span> <span class="n">root</span><span class="p">.</span><span class="n">text</span> <span class="k">as</span> <span class="n">text</span><span class="p">,</span> <span class="mi">0</span> <span class="k">as</span> <span class="k">level</span>
        <span class="k">from</span> <span class="n">Node</span> <span class="n">root</span>
        <span class="k">where</span> <span class="n">root</span><span class="p">.</span><span class="n">parent</span> <span class="k">is</span> <span class="k">null</span>
    <span class="k">union</span> <span class="k">all</span>
    <span class="cm">/* recursion */</span>
    <span class="k">select</span> <span class="n">child</span><span class="p">.</span><span class="n">id</span> <span class="k">as</span> <span class="n">id</span><span class="p">,</span> <span class="n">child</span><span class="p">.</span><span class="n">text</span> <span class="k">as</span> <span class="n">text</span><span class="p">,</span> <span class="k">level</span><span class="o">+</span><span class="mi">1</span> <span class="k">as</span> <span class="k">level</span>
        <span class="k">from</span> <span class="n">Tree</span> <span class="n">parent</span>
        <span class="k">join</span> <span class="n">Node</span> <span class="n">child</span> <span class="k">on</span> <span class="n">child</span><span class="p">.</span><span class="n">parent</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">parent</span><span class="p">.</span><span class="n">id</span>
<span class="p">)</span> <span class="n">cycle</span> <span class="n">id</span> <span class="k">set</span> <span class="k">abort</span> <span class="k">to</span> <span class="s1">'aborted!'</span> <span class="n">default</span> <span class="s1">''</span>  <span class="cm">/* cycle detection */</span>
<span class="k">select</span> <span class="n">text</span><span class="p">,</span> <span class="k">level</span><span class="p">,</span> <span class="k">abort</span>
<span class="k">from</span> <span class="n">Tree</span>
<span class="k">order</span> <span class="k">by</span> <span class="k">level</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the <code>id</code> column is used to detect cycles, and</p>
</li>
<li>
<p>the <code>abort</code> column is set to the string value <code>'aborted!'</code> if a cycle is detected.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Hibernate emulates the <code>cycle</code> clause on databases which don&#8217;t support it natively.</p>
</div>
<div class="paragraph">
<p>The BNF for <code>cycle</code> is:</p>
</div>
<div id="cte-recursive-cycle-bnf-example" class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="antlrv4">cycleClause
    : "CYCLE" identifier ("," identifier)*
      "SET" identifier ("TO" literal "DEFAULT" literal)?
      ("USING" identifier)?</code></pre>
</div>
</div>
<div class="paragraph">
<p>The column optionally specified by <code>using</code> holds the path to the current row.</p>
</div>
</div>
<div class="sect3">
<h4 id="_ordering_depth_first_or_breadth_first">4.6.4. Ordering depth-first or breadth-first</h4>
<div class="paragraph">
<p>The <code>search</code> clause allows us to control whether we would like the results of our query returned in an order that emulates a depth-first recursive search, or a breadth-first recursive search.</p>
</div>
<div class="paragraph">
<p>In our query above, we explicitly coded a <code>level</code> column that holds the recursion depth, and ordered our result set according to this depth.
With the <code>search</code> clause, that bookkeeping is already taken care of for us.</p>
</div>
<div class="paragraph">
<p>For depth-first search, we have:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">with</span> <span class="n">Tree</span> <span class="k">as</span> <span class="p">(</span>
    <span class="cm">/* base query */</span>
    <span class="k">select</span> <span class="n">root</span><span class="p">.</span><span class="n">id</span> <span class="k">as</span> <span class="n">id</span><span class="p">,</span> <span class="n">root</span><span class="p">.</span><span class="n">text</span> <span class="k">as</span> <span class="n">text</span>
        <span class="k">from</span> <span class="n">Node</span> <span class="n">root</span>
        <span class="k">where</span> <span class="n">root</span><span class="p">.</span><span class="n">parent</span> <span class="k">is</span> <span class="k">null</span>
    <span class="k">union</span> <span class="k">all</span>
    <span class="cm">/* recursion */</span>
    <span class="k">select</span> <span class="n">child</span><span class="p">.</span><span class="n">id</span> <span class="k">as</span> <span class="n">id</span><span class="p">,</span> <span class="n">child</span><span class="p">.</span><span class="n">text</span> <span class="k">as</span> <span class="n">text</span>
        <span class="k">from</span> <span class="n">Tree</span> <span class="n">parent</span>
        <span class="k">join</span> <span class="n">Node</span> <span class="n">child</span> <span class="k">on</span> <span class="n">child</span><span class="p">.</span><span class="n">parent</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">parent</span><span class="p">.</span><span class="n">id</span>
<span class="p">)</span> <span class="n">search</span> <span class="n">depth</span> <span class="k">first</span> <span class="k">by</span> <span class="n">id</span> <span class="k">set</span> <span class="k">level</span>  <span class="cm">/* depth-first search */</span>
<span class="k">from</span> <span class="n">Tree</span>
<span class="k">select</span> <span class="n">text</span>
<span class="k">order</span> <span class="k">by</span> <span class="k">level</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And for breadth-first search, we only need to change a single keyword:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hql"><span class="k">with</span> <span class="n">Tree</span> <span class="k">as</span> <span class="p">(</span>
    <span class="cm">/* base query */</span>
    <span class="k">select</span> <span class="n">root</span><span class="p">.</span><span class="n">id</span> <span class="k">as</span> <span class="n">id</span><span class="p">,</span> <span class="n">root</span><span class="p">.</span><span class="n">text</span> <span class="k">as</span> <span class="n">text</span>
        <span class="k">from</span> <span class="n">Node</span> <span class="n">root</span>
        <span class="k">where</span> <span class="n">root</span><span class="p">.</span><span class="n">parent</span> <span class="k">is</span> <span class="k">null</span>
    <span class="k">union</span> <span class="k">all</span>
    <span class="cm">/* recursion */</span>
    <span class="k">select</span> <span class="n">child</span><span class="p">.</span><span class="n">id</span> <span class="k">as</span> <span class="n">id</span><span class="p">,</span> <span class="n">child</span><span class="p">.</span><span class="n">text</span> <span class="k">as</span> <span class="n">text</span>
        <span class="k">from</span> <span class="n">Tree</span> <span class="n">parent</span>
        <span class="k">join</span> <span class="n">Node</span> <span class="n">child</span> <span class="k">on</span> <span class="n">child</span><span class="p">.</span><span class="n">parent</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">parent</span><span class="p">.</span><span class="n">id</span>
<span class="p">)</span> <span class="n">search</span> <span class="n">breadth</span> <span class="k">first</span> <span class="k">by</span> <span class="n">id</span> <span class="k">set</span> <span class="k">level</span>  <span class="cm">/* breadth-first search */</span>
<span class="k">from</span> <span class="n">Tree</span>
<span class="k">select</span> <span class="n">text</span>
<span class="k">order</span> <span class="k">by</span> <span class="k">level</span> <span class="k">desc</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Hibernate emulates the <code>search</code> clause on databases which don&#8217;t support it natively.</p>
</div>
<div class="paragraph">
<p>The BNF for <code>search</code> is:</p>
</div>
<div id="cte-recursive-search-bnf-example" class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="antlrv4">searchClause
    : "SEARCH" ("BREADTH"|"DEPTH") "FIRST"
      "BY" searchSpecifications
      "SET" identifier

searchSpecifications
    : searchSpecification ("," searchSpecification)*

searchSpecification
    : identifier sortDirection? nullsPrecedence?</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="credits">5. Credits</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The full list of contributors to Hibernate ORM can be found on the
<a href="https://github.com/hibernate/hibernate-orm/graphs/contributors">GitHub repository</a>.</p>
</div>
<div class="paragraph">
<p>The following contributors were involved in this documentation:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Gavin King</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Version 6.5.3.Final<br>
Last updated 2024-09-18 16:30:52 UTC
</div>
</div>
</body>
</html>